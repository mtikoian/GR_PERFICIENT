/*

(Re)create Indexes

	1. dbo.OriginatingRegion.IX_Name_SubName
	2. dbo.OriginatingRegion.IX_SubName
	3. dbo.AllocationRegion.IX_Name_SubName
	4. dbo.ActivityType.IX_Unique
	5. dbo.GlAccount.IX_Code
	6. dbo.GlAccountCategory.IX_Composite
	7. dbo.GlAccountCategory.IX_GlAccountCategoryKey_MinorCategoryName
	8. dbo.GlAccountCategory.IX_MinorName
	9. dbo.ExchangeRate.IX_Unique
	10. dbo.ProfitabilityReforecast.IX_ProfitabilityReforecast_ReferenceCode
	11. dbo.ProfitabilityBudget.IX_ProfitabilityBudget_ReferenceCode
	12. dbo.ExchangeRate.IX_DestinationCurrencyKey
	13. dbo.ExchangeRate.IX_SourceCurrencyKey_CalendarKey_DestinationCurrencyKey_ReforecastKey
	14. dbo.ExchangeRate.IX_SourceToDestination

Redeploy index stored procedures

	1. dbo.stp_D_ProfitabilityBudgetIndex
	2. dbo.stp_D_ProfitabilityReforecastIndex
	3. dbo.stp_I_ProfitabilityReforecastIndex
	4. dbo.stp_I_ProfitabilityBudgetIndex

-- Rebuild all indexes

Recreate Report Stored Procedures

	1. dbo.stp_R_BudgetOwner
	2. dbo.stp_R_BudgetOriginator
	3. dbo.stp_R_ExpenseCzarTotalComparison
	4. dbo.stp_R_ExpenseCzarTotalComparisonDetail
	5. dbo.stp_R_ExpenseCzar
	6. dbo.stp_R_BudgetJobCodeDetail
	7. dbo.stp_R_ProfitabilityV2
	8. dbo.stp_R_ProfitabilityDetailvV2
	
Recreate import stored procedures (They reference elements in the warehouse that are only added as part of the GrReporting change scripts)

*/


-- |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||--
--																(Re)create Indexes
-- |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||--

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 1. GrReportingStaging.dbo.OriginatingRegion.IX_Name_SubName ----------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[OriginatingRegion]') AND name = N'IX_Name_SubName')
BEGIN
	DROP INDEX [IX_Name_SubName] ON [dbo].[OriginatingRegion] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.OriginatingRegion.IX_Name_SubName" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.OriginatingRegion.IX_Name_SubName" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE UNIQUE NONCLUSTERED INDEX [IX_Name_SubName] ON [dbo].[OriginatingRegion] 
(
	[RegionName] ASC,
	[SubRegionName] ASC,
	[SnapshotId] ASC
)
INCLUDE ( [OriginatingRegionKey],
[RegionCode],
[SubRegionCode]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

PRINT ('Index "" created.')


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 2. GrReportingStaging.dbo.OriginatingRegion.IX_SubName ----------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[OriginatingRegion]') AND name = N'IX_SubName')
BEGIN
	DROP INDEX [IX_SubName] ON [dbo].[OriginatingRegion] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.OriginatingRegion.IX_SubName" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.OriginatingRegion.IX_SubName" as it does not exist.')
END

USE [GrReporting]
GO

CREATE NONCLUSTERED INDEX [IX_SubName] ON [dbo].[OriginatingRegion] 
(
	[SubRegionName] ASC,
	[SnapshotId] ASC
)
INCLUDE ( [OriginatingRegionKey]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 3. GrReportingStaging.dbo.AllocationRegion.IX_Name_SubName ------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[AllocationRegion]') AND name = N'IX_Name_SubName')
BEGIN
	DROP INDEX [IX_Name_SubName] ON [dbo].[AllocationRegion] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.AllocationRegion.IX_Name_SubName" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.AllocationRegion.IX_Name_SubName" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE UNIQUE NONCLUSTERED INDEX [IX_Name_SubName] ON [dbo].[AllocationRegion] 
(
	[RegionName] ASC,
	[SubRegionName] ASC,
	[SnapshotId] ASC
)
INCLUDE ( [AllocationRegionKey],
[RegionCode],
[SubRegionCode]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 4. GrReportingStaging.dbo.ActivityType.IX_Unique ----------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ActivityType]') AND name = N'IX_Unique')
BEGIN
	DROP INDEX [IX_Unique] ON [dbo].[ActivityType] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.ActivityType.IX_Unique" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.ActivityType.IX_Unique" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE UNIQUE NONCLUSTERED INDEX [IX_Unique] ON [dbo].[ActivityType] 
(
	[ActivityTypeKey] ASC,
	[ActivityTypeCode] ASC,
	[SnapshotId] ASC
)
INCLUDE ( [ActivityTypeName]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 5. GrReportingStaging.dbo.GlAccount.IX_Code ---------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[GlAccount]') AND name = N'IX_Code')
BEGIN
	DROP INDEX [IX_Code] ON [dbo].[GlAccount] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.GlAccount.IX_Code" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.GlAccount.IX_Code" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE NONCLUSTERED INDEX [IX_Code] ON [dbo].[GlAccount] 
(
	[Code] ASC,
	[SnapshotId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 6. GrReportingStaging.dbo.GlAccountCategory.IX_Composite --------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[GlAccountCategory]') AND name = N'IX_Composite')
BEGIN
	DROP INDEX [IX_Composite] ON [dbo].[GlAccountCategory] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.GlAccountCategory.IX_Composite" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.GlAccountCategory.IX_Composite" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE UNIQUE NONCLUSTERED INDEX [IX_Composite] ON [dbo].[GlAccountCategory] 
(
	[MinorCategoryName] ASC,
	[GlAccountCategoryKey] ASC,
	[AccountSubTypeName] ASC,
	[FeeOrExpense] ASC,
	[MajorCategoryName] ASC,
	[SnapshotId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 7. GrReportingStaging.dbo.GlAccountCategory.IX_GlAccountCategoryKey_MinorCategoryName ---------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[GlAccountCategory]') AND name = N'IX_GlAccountCategoryKey_MinorCategoryName')
BEGIN
	DROP INDEX [IX_GlAccountCategoryKey_MinorCategoryName] ON [dbo].[GlAccountCategory] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.GlAccountCategory.IX_GlAccountCategoryKey_MinorCategoryName" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.GlAccountCategory.IX_GlAccountCategoryKey_MinorCategoryName" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE UNIQUE NONCLUSTERED INDEX [IX_GlAccountCategoryKey_MinorCategoryName] ON [dbo].[GlAccountCategory] 
(
	[GlAccountCategoryKey] ASC,
	[MinorCategoryName] ASC,
	[SnapshotId] ASC
)
INCLUDE ( [MajorCategoryName],
[FeeOrExpense],
[AccountSubTypeName]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 8. GrReportingStaging.dbo.GlAccountCategory.IX_MinorName -------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[GlAccountCategory]') AND name = N'IX_MinorName')
BEGIN
	DROP INDEX [IX_MinorName] ON [dbo].[GlAccountCategory] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.GlAccountCategory.IX_MinorName" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.GlAccountCategory.IX_MinorName" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE NONCLUSTERED INDEX [IX_MinorName] ON [dbo].[GlAccountCategory] 
(
	[MinorCategoryName] ASC,
	[SnapshotId] ASC
)
INCLUDE ( [GlAccountCategoryKey]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 9. GrReportingStaging.dbo.ExchangeRate.IX_Clustered -----------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ExchangeRate]') AND name = N'IX_Clustered')
BEGIN
	DROP INDEX [IX_Clustered] ON [dbo].[ExchangeRate] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.ExchangeRate.IX_Clustered" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.ExchangeRate.IX_Clustered" as it does not exist.')
END
GO

USE [GrReporting]
GO

CREATE CLUSTERED INDEX [IX_Clustered] ON [dbo].[ExchangeRate] 
(
	[SourceCurrencyKey] ASC,
	[CalendarKey] ASC,
	[ReforecastKey] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 10. GrReportingStaging.dbo.ProfitabilityReforecast.IX_ProfitabilityReforecast_ReferenceCode --------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ExchangeRate]') AND name = N'IX_DestinationCurrencyKey')
BEGIN
	DROP INDEX [IX_DestinationCurrencyKey] ON [dbo].[ExchangeRate] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.ExchangeRate.IX_DestinationCurrencyKey" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.ExchangeRate.IX_DestinationCurrencyKey" as it does not exist.')
END
GO

USE [GrReporting]
GO


IF EXISTS (SELECT name FROM sysindexes WHERE name = 'IX_ProfitabilityReforecast_ReferenceCode')
BEGIN
    -- no we dont want this so drop it this is duplicate to IX_ReferenceCode thats been there ages.
    DROP INDEX [IX_ProfitabilityReforecast_ReferenceCode] ON [dbo].[ProfitabilityReforecast] WITH ( ONLINE = OFF )
    PRINT '[IX_ProfitabilityReforecast_ReferenceCode]: DROPPED IT WASNT SUPPOSED TO BE THERE'
END

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 11. GrReportingStaging.dbo.ProfitabilityBudget.IX_ProfitabilityBudget_ReferenceCode ----------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ExchangeRate]') AND name = N'IX_SourceCurrencyKey_CalendarKey_DestinationCurrencyKey')
BEGIN
	DROP INDEX [IX_SourceCurrencyKey_CalendarKey_DestinationCurrencyKey] ON [dbo].[ExchangeRate] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.ExchangeRate.IX_SourceCurrencyKey_CalendarKey_DestinationCurrencyKey" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.ExchangeRate.IX_SourceCurrencyKey_CalendarKey_DestinationCurrencyKey" as it does not exist.')
END
GO

USE [GrReporting]
GO

IF NOT EXISTS (SELECT name FROM sysindexes WHERE name = 'IX_ProfitabilityBudget_ReferenceCode')
BEGIN
    -- no we dont want this so drop it this is duplicate to IX_ReferenceCode thats been there ages.
    DROP INDEX [IX_ProfitabilityBudget_ReferenceCode] ON [dbo].[ProfitabilityBudget] WITH ( ONLINE = OFF )
    PRINT 'IX_ProfitabilityBudget_ReferenceCode: DROPPED IT WASNT SUPPOSED TO BE THERE'
  END

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 12. GrReportingStaging.dbo.ExchangeRate.IX_DestinationCurrencyKey -----------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ExchangeRate]') AND name = N'IX_SourceToDestination')
BEGIN
	DROP INDEX [IX_SourceToDestination] ON [dbo].[ExchangeRate] WITH ( ONLINE = OFF )
	
	PRINT ('Index "dbo.ExchangeRate.IX_SourceToDestination" dropped.')
END
ELSE
BEGIN
	PRINT ('Cannot drop index "dbo.ExchangeRate.IX_SourceToDestination" as it does not exist.')
END
GO

USE [GrReporting]
GO

	CREATE NONCLUSTERED INDEX [IX_DestinationCurrencyKey] ON [dbo].[ExchangeRate] 
	(
		[DestinationCurrencyKey] ASC,
		[CalendarKey] ASC,
		[SourceCurrencyKey] ASC,
		[ReforecastKey] ASC
	)
	INCLUDE ( [Rate]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 13. GrReportingStaging.dbo.ExchangeRate.IX_SourceCurrencyKey_CalendarKey_DestinationCurrencyKey_ReforecastKey --------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

	CREATE NONCLUSTERED INDEX [IX_SourceCurrencyKey_CalendarKey_DestinationCurrencyKey_ReforecastKey] ON [dbo].[ExchangeRate] 
	(
		[SourceCurrencyKey] ASC,
		[CalendarKey] ASC,
		[DestinationCurrencyKey] ASC,
		[ReforecastKey] ASC
	)
	INCLUDE ( [Rate]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

GO

-------------------------------------------------------------------------------------------------------------------------------------------------
-- 14. GrReportingStaging.dbo.ExchangeRate.IX_SourceToDestination -------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

	CREATE UNIQUE NONCLUSTERED INDEX [IX_SourceToDestination] ON [dbo].[ExchangeRate] 
	(
		[SourceCurrencyKey] ASC,
		[DestinationCurrencyKey] ASC,
		[CalendarKey] ASC,
		[ReforecastKey] ASC
	)
	INCLUDE ( [Rate]) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


GO








------------------------------------------------------------------------------------------------------------------------------

USE [GrReporting]
GO

DECLARE @TableName varchar(255) 

DECLARE TableCursor CURSOR FOR 
SELECT table_name FROM information_schema.tables 
WHERE table_type = 'base table' 

OPEN TableCursor 

FETCH NEXT FROM TableCursor INTO @TableName 

WHILE @@FETCH_STATUS = 0 
BEGIN 
	PRINT ('Starting index rebuild for ' + @TableName)
	DBCC DBREINDEX(@TableName,' ',90) 
	PRINT ('	Finished index rebuild for ' + @TableName)
	
	FETCH NEXT FROM TableCursor INTO @TableName 
END 

CLOSE TableCursor 


























--||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||--
--																Report Stored Procedures
--||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||--



USE [GrReporting]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ProfitabilityV2]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ProfitabilityV2]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_ProfitabilityV2]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_BudgetJobCodeDetail]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_BudgetJobCodeDetail]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_BudgetJobCodeDetail]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_BudgetOriginator]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_BudgetOriginator]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_BudgetOriginator]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_BudgetOwner]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_BudgetOwner]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_BudgetOwner]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzar]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzar]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_ExpenseCzar]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzarTotalComparison]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzarTotalComparison]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_ExpenseCzarTotalComparison]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzarTotalComparisonDetail]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzarTotalComparisonDetail]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_ExpenseCzarTotalComparisonDetail]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ProfitabilityDetailV2]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ProfitabilityDetailV2]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_ProfitabilityDetailV2]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzarDetail]    Script Date: 05/05/2011 10:41:30 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzarDetail]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_R_ExpenseCzarDetail]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzarDetail]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzarDetail]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'


CREATE PROCEDURE [dbo].[stp_R_ExpenseCzarDetail]
	@ReportExpensePeriod INT = NULL,
	@DestinationCurrency VARCHAR(3) = NULL,
	@HierarchyName VARCHAR(50) = NULL,
	@IsGross bit = 1,
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL

AS
/*
	DECLARE @ReportExpensePeriod   INT,
	@AccountCategoryList   VARCHAR(8000),
	@DestinationCurrency   VARCHAR(3),
	@HierarchyName         VARCHAR(50),
	@FunctionalDepartmentList VARCHAR(8000),
	@AllocationRegionList VARCHAR(8000),
	@EntityList VARCHAR(8000)
	
	
	SET @ReportExpensePeriod = 201011
	SET @AccountCategoryList = ''IT Costs & Telecommunications''
	SET @DestinationCurrency =''USD''
	SET @HierarchyName = ''Global''
	SET @FunctionalDepartmentList = ''Information Technologies''
	SET @AllocationRegionList = NULL
	SET @EntityList = NULL
	
EXEC stp_R_ExpenseCzarDetail
		@ReportExpensePeriod = 201011,
		@AccountCategoryList = ''IT Costs & Telecommunications|Legal & Professional Fees|Marketing'',
		@DestinationCurrency = ''USD'',
		@HierarchyName = ''Global'',
		@FunctionalDepartmentList = ''Information Technology'',
		@AllocationRegionList = null,
		@EntityList = NULL,
		@MinorAccountCategoryList = ''Architects & Engineering|Legal - Immigration'',
		@ActivityTypeList = ''Corporate Overhead|Corporate''
	
*/
DECLARE

	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_HierarchyName VARCHAR(50) = @HierarchyName,
	@_IsGross bit = @IsGross,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList
--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + REPLACE(STR(MONTH(GETDATE()),2 ),'' '',''0'')AS INT)

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@HierarchyName IS NULL
	SET @HierarchyName = ''Global''

	DECLARE @CalendarYear AS INT
	SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)				

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
	CREATE TABLE	#EntityFilterTable	(PropertyFundKey Int NOT NULL)
	CREATE TABLE	#FunctionalDepartmentFilterTable	(FunctionalDepartmentKey Int NOT NULL)
	CREATE TABLE	#ActivityTypeFilterTable(ActivityTypeKey Int NOT NULL)
	CREATE TABLE	#AllocationRegionFilterTable	(AllocationRegionKey Int NOT NULL)
	CREATE TABLE	#AllocationSubRegionFilterTable	(AllocationRegionKey Int NOT NULL)
	CREATE TABLE	#MajorAccountCategoryFilterTable(GlAccountCategoryKey Int NOT NULL)	
	CREATE TABLE	#MinorAccountCategoryFilterTable(GlAccountCategoryKey Int NOT NULL)	
	CREATE TABLE	#OriginatingRegionFilterTable	(OriginatingRegionKey Int NOT NULL)
	CREATE TABLE	#OriginatingSubRegionFilterTable	(OriginatingRegionKey Int NOT NULL)	
		
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable	(PropertyFundKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable	(FunctionalDepartmentKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable(ActivityTypeKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable	(AllocationRegionKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable	(AllocationRegionKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable(GlAccountCategoryKey)	
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable(GlAccountCategoryKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable	(OriginatingRegionKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable	(OriginatingRegionKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END		
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------

IF 	OBJECT_ID(''tempdb..#ExpenseCzarTotalComparisonDetail'') IS NOT NULL
    DROP TABLE #ExpenseCzarTotalComparisonDetail

CREATE TABLE #ExpenseCzarTotalComparisonDetail
(
	GlAccountCategoryKey	Int,
    FunctionalDepartmentKey	Int,
    AllocationRegionKey		Int,
    PropertyFundKey			Int,
	SourceName				VarChar(50),
	MtdGrossBudget           MONEY,
	MtdGrossActual           MONEY,
	MtdNetBudget			 MONEY,
	MtdNetActual			 MONEY,
	YtdGrossBudget           MONEY,
	YtdGrossActual           MONEY,
	YtdNetBudget			 MONEY,
	YtdNetActual			 MONEY,
	AnualGrossBudget		 MONEY,
	AnualEstGrossActual      MONEY,
	AnualNetBudget			 MONEY,
	AnualEstNetActual		 MONEY
)

CREATE TABLE #Gac (GlAccountCategoryKey Int NOT NULL)

DECLARE @cmdString Varchar(8000)


SET @cmdString = (Select ''
	Select GlAccountCategoryKey
	From GlAccountCategory gac
	Where 1 = 1
	AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
	AND gac.HierarchyName = '''''' + @HierarchyName + ''''''
	'')

print @cmdString
Insert Into #Gac
EXEC (@cmdString)

SET @cmdString = (Select ''
	
	INSERT INTO #ExpenseCzarTotalComparisonDetail
	SELECT 
		pagacb.GlAccountCategoryKey,
	    pa.FunctionalDepartmentKey,
	    pa.AllocationRegionKey,
	    pa.PropertyFundKey,
	    s.SourceName,
		NULL as MtdGrossBudget,
		SUM(
			(
				er.Rate *
				CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN
					pa.LocalActual
				ELSE
					0
				END
			)
		) as MtdGrossActual,
		NULL as MtdNetBudget,
		SUM(
			(
				er.Rate *
				CASE WHEN (r.ReimbursableCode = ''''NO'''' AND c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
					pa.LocalActual
				ELSE 
					0
				END
			)
		) as MtdNetActual,
		NULL as YtdGrossBudget,
		SUM(
			(
				er.Rate *
				CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN
					pa.LocalActual
				ELSE
					0
				END
			)
			
		) as YtdGrossActual,
		NULL as YtdNetBudget,
		SUM(
			(
				er.Rate *
				CASE WHEN (r.ReimbursableCode = ''''NO'''' AND c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
					pa.LocalActual
				ELSE 
					0
				END
			)
		) as YtdNetActual,
		NULL as AnualGrossBudget,
		SUM(
				er.Rate *
				CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
					pa.LocalActual
				ELSE 
					0
				END
		) as AnualEstGrossActual,
		NULL as AnualNetBudget,
		SUM(
			(
				er.Rate *
				CASE WHEN (r.ReimbursableCode = ''''NO'''' AND c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
					pa.LocalActual
				ELSE 
					0
				END
			)
		) as AnualEstNetActual
	FROM
		ProfitabilityActual pa
		INNER JOIN (
				Select pagacb.* From dbo.ProfitabilityActualGlAccountCategoryBridge pagacb
					INNER JOIN #Gac gac on gac.GlAccountCategoryKey = pagacb.GlAccountCategoryKey
				UNION ALL
				Select pagacb.* From dbo.ProfitabilityActualGlAccountCategoryBridgeVirtual(''+STR(@CalendarYear,10,0)+'',''+STR(@ReportExpensePeriod,10,0)+'',''''''+ @HierarchyName + '''''') pagacb
					INNER JOIN #Gac gac on gac.GlAccountCategoryKey = pagacb.GlAccountCategoryKey
				) pagacb ON  
		pa.ProfitabilityActualKey = pagacb.ProfitabilityActualKey'' +	

    + CASE WHEN @MajorAccountCategoryList IS NOT NULL OR @MinorAccountCategoryList IS NOT NULL THEN '' INNER JOIN GlAccountCategory gac ON  gac.GlAccountCategoryKey = pagacb.GlAccountCategoryKey '' ELSE '''' END +
    + CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey'' ELSE '''' END + ''

	    INNER JOIN ExchangeRate er ON  er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
	    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
	    INNER JOIN Calendar c ON  c.CalendarKey = pa.CalendarKey
	    INNER JOIN Source s ON s.SourceKey = pa.SourceKey
	    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pa.ReimbursableKey
			
WHERE  1 = 1
	AND c.CalendarPeriod >= '' + LEFT(LTRIM(STR(@ReportExpensePeriod,10,0)),4)+''01'' + ''
	AND c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationRegionFilterTable t1)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationSubRegionFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''
	Group By
		pagacb.GlAccountCategoryKey,
	    pa.FunctionalDepartmentKey,
	    pa.AllocationRegionKey,
	    pa.PropertyFundKey,
	    s.SourceName
'')
print @cmdString
EXEC (@cmdString)


SET @cmdString = (Select ''	

	INSERT INTO #ExpenseCzarTotalComparisonDetail
	SELECT 
		pbgacb.GlAccountCategoryKey,
	    pb.FunctionalDepartmentKey,
	    pb.AllocationRegionKey,
	    pb.PropertyFundKey,
	    s.SourceName,
		SUM(
			(
				er.Rate *
				CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN
					pb.LocalBudget
				ELSE
					0
				END
			)
		) as MtdGrossBudget,
		NULL as MtdGrossActual,
		SUM(
			(
				er.Rate *
				CASE WHEN (r.ReimbursableCode = ''''NO'''' AND c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
					pb.LocalBudget
				ELSE 
					0
				END
			)
		) as MtdNetBudget,
		NULL as MtdNetActual,
		SUM(
			(
				er.Rate *
				CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN
					pb.LocalBudget
				ELSE
					0
				END
			)
		) as YtdGrossBudget,
		NULL as YtdGrossActual,
		SUM(
			(
				er.Rate *
				CASE WHEN (r.ReimbursableCode = ''''NO'''' AND c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
					pb.LocalBudget
				ELSE 
					0
				END
			)
		) as YtdNetBudget,
		NULL as YtdNetActual,
		SUM(
			(
				er.Rate * pb.LocalBudget
			)
		) as AnualGrossBudget,
		SUM(
			(
				er.Rate *
				CASE WHEN (c.CalendarPeriod > ''+STR(@ReportExpensePeriod,10,0)+'') THEN
					pb.LocalBudget
				ELSE
					0
				END
			)
		) as AnualEstGrossActual,
		SUM(
			(
				er.Rate *
				CASE WHEN (r.ReimbursableCode = ''''NO'''') THEN 
					pb.LocalBudget
				ELSE 
					0
				END
			)
		) as AnualNetBudget,
		SUM(
			(
				er.Rate *
				CASE WHEN (r.ReimbursableCode = ''''NO'''' AND c.CalendarPeriod > ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
					pb.LocalBudget
				ELSE 
					0
				END
			)
		) as AnualEstNetActual
		
	FROM
		ProfitabilityBudget pb
		INNER JOIN (
				Select pbgacb.* From dbo.ProfitabilityBudgetGlAccountCategoryBridge pbgacb
					INNER JOIN #Gac gac on gac.GlAccountCategoryKey = pbgacb.GlAccountCategoryKey
				UNION ALL
				Select pbgacbv.* From dbo.ProfitabilityBudgetGlAccountCategoryBridgeVirtual(''+STR(@CalendarYear,10,0)+'',''+STR(@ReportExpensePeriod,10,0)+'',''''''+ @HierarchyName + '''''') pbgacbv
					INNER JOIN #Gac gac on gac.GlAccountCategoryKey = pbgacbv.GlAccountCategoryKey
				) pbgacb ON  
		pb.ProfitabilityBudgetKey = pbgacb.ProfitabilityBudgetKey'' +	

    + CASE WHEN @MajorAccountCategoryList IS NOT NULL OR @MinorAccountCategoryList IS NOT NULL THEN '' INNER JOIN GlAccountCategory gac ON  gac.GlAccountCategoryKey = pbgacb.GlAccountCategoryKey '' ELSE '''' END +
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pb.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey'' ELSE '''' END + ''
		
	    INNER JOIN ExchangeRate er ON  er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey
	    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
	    INNER JOIN Calendar c ON  c.CalendarKey = pb.CalendarKey
	    INNER JOIN Source s ON s.SourceKey = pb.SourceKey
	    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pb.ReimbursableKey
WHERE  1 = 1 
	AND c.CalendarPeriod >= '' + LEFT(LTRIM(STR(@ReportExpensePeriod,10,0)),4)+''01'' + ''
	AND c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
	Group By
		pbgacb.GlAccountCategoryKey,
	    pb.FunctionalDepartmentKey,
	    pb.AllocationRegionKey,
	    pb.PropertyFundKey,
	    s.SourceName
	    '')

print @cmdString
EXEC (@cmdString)

CREATE CLUSTERED INDEX IX ON #ExpenseCzarTotalComparisonDetail(PropertyFundKey,AllocationRegionKey,FunctionalDepartmentKey,GlAccountCategoryKey)

	SELECT 

		gac.ExpenseType,
		gac.MajorName MajorExpenseCategory,
	    gac.MinorName MinorExpenseCategory,
	    fd.FunctionalDepartmentName FunctionalDepartment,
	    fd.FunctionalDepartmentName FunctionalDepartmentFilter,
	    ar.SubRegionName AllocationSubRegion,
	    ar.SubRegionName AllocationSubRegionFilter,
	    pf.PropertyFundName Entity,
	    res.SourceName SourceName,
    
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossBudget,0) ELSE ISNULL(MtdNetBudget,0) END) AS MTDOriginalBudget,
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossActual,0) ELSE ISNULL(MtdNetActual,0) END) AS MTDActual,
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossBudget,0) - ISNULL(MtdGrossActual,0) ELSE ISNULL(MtdNetBudget,0) - ISNULL(MtdNetActual,0) END) AS MTDVariance,
		
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossBudget,0) ELSE ISNULL(YtdNetBudget,0) END) AS YTDOriginalBudget,
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossActual,0) ELSE ISNULL(YtdNetActual,0) END) AS YTDActual,
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossBudget,0) - ISNULL(YtdGrossActual,0) ELSE ISNULL(YtdNetBudget,0) - ISNULL(YtdNetActual,0) END) AS YTDVariance,
		
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnualGrossBudget,0) ELSE ISNULL(AnualNetBudget,0) END) AS AnualBudget,
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnualEstGrossActual,0) ELSE ISNULL(AnualEstNetActual,0) END) AS AnualEstimatedActual,
		SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnualGrossBudget,0) - ISNULL(AnualEstGrossActual,0) ELSE ISNULL(AnualNetBudget,0) - ISNULL(AnualEstNetActual,0) END) AS AnualEstimatedVariance

	FROM
		#ExpenseCzarTotalComparisonDetail res
				INNER JOIN PropertyFund pf ON pf.PropertyFundKey = res.PropertyFundKey
				INNER JOIN AllocationRegion ar ON ar.AllocationRegionKey = res.AllocationRegionKey
				INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentKey = res.FunctionalDepartmentKey
				INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = res.GlAccountCategoryKey 
		
	GROUP BY
		gac.ExpenseType,
		gac.MajorName,
	    gac.MinorName,
	    fd.FunctionalDepartmentName,
	    ar.SubRegionName,
	    pf.PropertyFundName,
	    res.SourceName
	
	IF 	OBJECT_ID(''tempdb..#ExpenseCzarTotalComparisonDetail'') IS NOT NULL
	    DROP TABLE #ExpenseCzarTotalComparisonDetail



' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ProfitabilityDetailV2]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ProfitabilityDetailV2]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'


CREATE PROCEDURE [dbo].[stp_R_ProfitabilityDetailV2]
	@ReportExpensePeriod INT = NULL,
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = NULL,

	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@DisplayOverheadBy Varchar(12),
	
	--Customized Filter Logic Specific to this Report
	@IncludeFeeAdjustments TinyInt = NULL,
	@OverheadOriginatingSubRegionList TEXT = NULL 
	
	
AS

IF ISNULL(@DisplayOverheadBy,'''') NOT IN (''Allocated'',''Unallocated'')
	BEGIN
	RAISERROR (''@DisplayOverheadBy have invalid value (Must be one of:Allocated,Unallocated)'',18,1)
	RETURN
	END
	
DECLARE

	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_TranslationTypeName VARCHAR(50) = @TranslationTypeName,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList,
	@_OverheadOriginatingSubRegionList VARCHAR(8000) = @OverheadOriginatingSubRegionList	
			
--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + REPLACE(STR(MONTH(GETDATE()),2 ),'' '',''0'')AS INT)

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@TranslationTypeName IS NULL
	SET @TranslationTypeName = ''Global''

--------------------------------------------------------------------------

-- Determine the ReforecastKey of the reforecast that is currently active (i.e.: 2011 Q1, 2011 Q2, 2012 Q0 etc)
DECLARE @ActiveReforecastKey INT = (SELECT ReforecastKey FROM dbo.GetCurrentReforecastRecord())

IF (@ActiveReforecastKey IS NULL) -- Safeguard against NULL ReforecastKey returned from previous statement
BEGIN
	SET @ActiveReforecastKey = (SELECT MAX(ReforecastKey) FROM dbo.ExchangeRate)
	PRINT (''Near disaster: @ActiveReforecastKey is NULL, so reverting to the largest/most recent ReforecastKey in dbo.ExchangeRate: '' + @ActiveReforecastKey)
END

--------------------------------------------------------------------------

DECLARE @CalendarYear AS INT
SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)				

DECLARE @ReforecastQuaterName VARCHAR(10)
SET @ReforecastQuaterName = (SELECT TOP 1
								ReforecastQuarterName 
							 FROM
								dbo.Reforecast 
							 WHERE
								ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
								ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
							 ORDER BY ReforecastEffectivePeriod DESC)

DECLARE @ReforecastEffectivePeriodQ1 INT
SET @ReforecastEffectivePeriodQ1 = (SELECT TOP 1 ReforecastEffectivePeriod 
									FROM dbo.Reforecast 
									WHERE ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										  ReforecastQuarterName = ''Q1''
									ORDER BY ReforecastEffectivePeriod)								

DECLARE @ReforecastEffectivePeriodQ2 INT
SET @ReforecastEffectivePeriodQ2 = (SELECT TOP 1 ReforecastEffectivePeriod 
									FROM dbo.Reforecast 
									WHERE ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										  ReforecastQuarterName = ''Q2''
									ORDER BY ReforecastEffectivePeriod)								

DECLARE @ReforecastEffectivePeriodQ3 INT
SET @ReforecastEffectivePeriodQ3 = (SELECT TOP 1 ReforecastEffectivePeriod 
									FROM dbo.Reforecast 
									WHERE ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										  ReforecastQuarterName = ''Q3''
									ORDER BY ReforecastEffectivePeriod)								

--------------------------------------------------------------------------
/*	Determine Report Exchange Rates	*/
--------------------------------------------------------------------------

SELECT
	SourceCurrencyKey,
	DestinationCurrencyKey,
	CalendarKey,
	Rate
INTO
	#ExchangeRate
FROM
	dbo.ExchangeRate
WHERE
	ReforecastKey = @ActiveReforecastKey -- We will use the exchange rate set that is active for the current reforecast.

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
	CREATE TABLE	#EntityFilterTable	(PropertyFundKey Int NOT NULL)
	CREATE TABLE	#FunctionalDepartmentFilterTable	(FunctionalDepartmentKey Int NOT NULL)
	CREATE TABLE	#ActivityTypeFilterTable(ActivityTypeKey Int NOT NULL)
	CREATE TABLE	#AllocationRegionFilterTable	(AllocationRegionKey Int NOT NULL)
	CREATE TABLE	#AllocationSubRegionFilterTable	(AllocationRegionKey Int NOT NULL)
	CREATE TABLE	#MajorAccountCategoryFilterTable(GlAccountCategoryKey Int NOT NULL)	
	CREATE TABLE	#MinorAccountCategoryFilterTable(GlAccountCategoryKey Int NOT NULL)	
	CREATE TABLE	#OriginatingRegionFilterTable	(OriginatingRegionKey Int NOT NULL)
	CREATE TABLE	#OriginatingSubRegionFilterTable	(OriginatingRegionKey Int NOT NULL)	
	CREATE TABLE	#OverheadOriginatingSubRegionFilterTable	(OriginatingRegionKey Int NOT NULL)	
		
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable	(PropertyFundKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable	(FunctionalDepartmentKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable(ActivityTypeKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable	(AllocationRegionKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable	(AllocationRegionKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable(GlAccountCategoryKey)	
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable(GlAccountCategoryKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable	(OriginatingRegionKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable	(OriginatingRegionKey)
	CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OverheadOriginatingSubRegionFilterTable	(OriginatingRegionKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END
	
IF (@OverheadOriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OverheadOriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OverheadOriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END	
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------

IF 	OBJECT_ID(''tempdb..#ProfitabilityReport'') IS NOT NULL
    DROP TABLE #ProfitabilityReport

CREATE TABLE #ProfitabilityReport
(	
	GlAccountCategoryKey		Int,
    ActivityTypeKey				Int,
    PropertyFundKey				Int,
    AllocationRegionKey			Int,
    OriginatingRegionKey		Int,
    SourceKey					Int,
    GlAccountKey				Int,
	ReimbursableKey				Int,
	FeeAdjustmentKey			Int,
	FunctionalDepartmentKey		Int,
	OverheadKey					Int,
	CalendarPeriod				Varchar(6) DEFAULT(''''),
	
	EntryDate					VARCHAR(10),
	[User]						NVARCHAR(20),
	[Description]				NVARCHAR(60),
	AdditionalDescription		NVARCHAR(4000),
	PropertyFundCode			Varchar(6) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	OriginatingRegionCode		Varchar(15) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	FunctionalDepartmentCode	Varchar(15) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller

	--Month to date	
	MtdActual				MONEY,
	MtdBudget				MONEY,
	MtdReforecastQ1		MONEY,
	MtdReforecastQ2		MONEY,
	MtdReforecastQ3		MONEY,
	
	--Year to date
	YtdActual				MONEY,	
	YtdBudget				MONEY, 
	YtdReforecastQ1		MONEY, 
	YtdReforecastQ2		MONEY, 
	YtdReforecastQ3		MONEY, 

	--Annual	
	AnnualBudget			MONEY,
	AnnualReforecastQ1		MONEY,
	AnnualReforecastQ2		MONEY,
	AnnualReforecastQ3		MONEY
)

DECLARE @cmdString Varchar(8000)
DECLARE @cmdString2 Varchar(8000)




--Get actual information
SET @cmdString = (Select ''

INSERT INTO #ProfitabilityReport
SELECT 	
	pa.GlobalGlAccountCategoryKey,
    pa.ActivityTypeKey,
    pa.PropertyFundKey,
    pa.AllocationRegionKey,
    pa.OriginatingRegionKey,
    pa.SourceKey,
    pa.GlAccountKey,
	pa.ReimbursableKey,
	(Select FeeAdjustmentKey From FeeAdjustment Where FeeAdjustmentCode = ''''NORMAL'''') FeeAdjustmentKey,
	pa.FunctionalDepartmentKey,
	pa.OverheadKey,
	c.CalendarPeriod,
	
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101) as EntryDate,
    ISNULL(pa.[User], '''''''') [User],
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END as Description,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END as AdditionalDescription,
    ISNULL(pa.PropertyFundCode, '''''''') PropertyFundCode,
    ISNULL(pa.OriginatingRegionCode, '''''''') OriginatingRegionCode,
	ISNULL(pa.FunctionalDepartmentCode, '''''''') FunctionalDepartmentCode,
	
    -- Expenses must be displayed as negative an Income is saved in MRI as negative
	SUM(
		er.Rate * -1 *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdActual,
	NULL as MtdBudget,
	NULL as MtdReforecastQ1,
	NULL as MtdReforecastQ2,
	NULL as MtdReforecastQ3,
	
	SUM(
		er.Rate * -1 *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdActual,
	NULL as YtdBudget,
	NULL as YtdReforecastQ1,
	NULL as YtdReforecastQ2,
	NULL as YtdReforecastQ3,
	
	NULL as AnnualBudget,
	NULL as AnnualReforecastQ1,
	NULL as AnnualReforecastQ2,
	NULL as AnnualReforecastQ3
FROM
	ProfitabilityActual pa

	INNER JOIN Overhead oh ON oh.OverheadKey = pa.OverheadKey

	INNER JOIN GlAccount ga on ga.GlAccountKey = pa.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pa.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pa.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pa.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pa.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pa.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pa.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pa.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pa.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
		
    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
    INNER JOIN Currency dc ON  dc.CurrencyKey = er.DestinationCurrencyKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pa.ReimbursableKey
    INNER JOIN Calendar c ON  c.CalendarKey = pa.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pa.SourceKey

    INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey
    INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey
    INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey
    INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey
    INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey
'')

SET @cmdString2 = (Select ''
WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @DisplayOverheadBy = ''Unallocated'' THEN 
			''
		AND (
				(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''UNALLOC'''')
				'' +
				CASE WHEN @OverheadOriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OverheadOriginatingSubRegionFilterTable t1) '' END +
				''
				)
			OR	(
				gac.AccountSubTypeName		<> ''''Overhead''''
				''+
				+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
				+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END +
				''
				)
			)
			''

		ELSE --ALLOC
			''
		AND (
				(
					gac.AccountSubTypeName	<> ''''Overhead''''
				)
			OR	(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''ALLOC'''')
				)
			)
			''
		+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
		+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END

		END +
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''
Group By
	pa.GlobalGlAccountCategoryKey,
    pa.ActivityTypeKey,
    pa.PropertyFundKey,
    pa.AllocationRegionKey,
    pa.OriginatingRegionKey,
    pa.SourceKey,
    pa.GlAccountKey,
	pa.ReimbursableKey,
	pa.FunctionalDepartmentKey,
	pa.OverheadKey,
	c.CalendarPeriod,
	
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101),
    ISNULL(pa.[User], ''''''''),
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END,
    ISNULL(pa.PropertyFundCode, ''''''''),
    ISNULL(pa.OriginatingRegionCode, ''''''''),
	ISNULL(pa.FunctionalDepartmentCode, '''''''')
	
'')
print @cmdString
print @cmdString2
IF LEN(@cmdString) > 7990
	RAISERROR (''Dynamic SQL to large'',16,1)
IF LEN(@cmdString2) > 7990
	RAISERROR (''Dynamic SQL to large'',16,1)

	
EXEC (@cmdString+@cmdString2)



--Get budget information
SET @cmdString = (Select ''

INSERT INTO #ProfitabilityReport
SELECT 
	pb.GlobalGlAccountCategoryKey,
    pb.ActivityTypeKey,
    pb.PropertyFundKey,
    pb.AllocationRegionKey,
    pb.OriginatingRegionKey,
    pb.SourceKey,
    pb.GlAccountKey,
	pb.ReimbursableKey,
	pb.FeeAdjustmentKey,
	pb.FunctionalDepartmentKey,
	pb.OverheadKey,
	'''''''' as CalendarPeriod,
	
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
	'''''''' as FunctionalDepartmentCode,
	
    --Expenses must be displayed as negative
    NULL as MtdActual,
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as MtdBudget,
	NULL as MtdReforecastQ1,
	NULL as MtdReforecastQ2,
	NULL as MtdReforecastQ3,
	
	NULL as YtdActual,	
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) * 
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as YtdBudget, 
	NULL as YtdReforecastQ1, 
	NULL as YtdReforecastQ2, 
	NULL as YtdReforecastQ3, 
	
	SUM(er.Rate * pb.LocalBudget * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
									1
								  ELSE
									-1 
								  END)) as AnnualBudget,
	NULL as AnnualReforecastQ1,
	NULL as AnnualReforecastQ2,
	NULL as AnnualReforecastQ3
	
FROM
	ProfitabilityBudget pb --WITH (INDEX=IX_Clustered)

	INNER JOIN Overhead oh ON oh.OverheadKey = pb.OverheadKey
	
	INNER JOIN GlAccount ga on ga.GlAccountKey = pb.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pb.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pb.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pb.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pb.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pb.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pb.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pb.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pb.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			
    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey
    INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pb.CalendarKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pb.ReimbursableKey
    INNER JOIN Source s ON s.SourceKey = pb.SourceKey

    INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey
    INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey
    INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey
    INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey
    INNER JOIN ActivityType a ON a.ActivityTypeKey = pb.ActivityTypeKey
    INNER JOIN FeeAdjustment Fa ON Fa.FeeAdjustmentKey = pb.FeeAdjustmentKey

WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */''
	
+ CASE WHEN @DisplayOverheadBy = ''Unallocated'' THEN 
			''
		AND (
				(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''UNALLOC'''')
				'' +
				CASE WHEN @OverheadOriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OverheadOriginatingSubRegionFilterTable t1) '' END +
				''
				)
			OR	(
				gac.AccountSubTypeName		<> ''''Overhead''''
				''+
				+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
				+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END +
				''
				)
			)
			''

		ELSE --ALLOC
			''
		AND (
				(
					gac.AccountSubTypeName	<> ''''Overhead''''
				)
			OR	(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''ALLOC'''')
				)
			)
			''
		+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
		+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END

		END +
	
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
+ CASE WHEN @IncludeFeeAdjustments = 1 THEN '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''',''''FEEADJUST'''')'' ELSE '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''')'' END +
''
Group By
	pb.GlobalGlAccountCategoryKey,
    pb.ActivityTypeKey,
    pb.PropertyFundKey,
    pb.AllocationRegionKey,
    pb.OriginatingRegionKey,
    pb.SourceKey,
    pb.GlAccountKey,
	pb.ReimbursableKey,
	pb.FeeAdjustmentKey,
	pb.FunctionalDepartmentKey,
	pb.OverheadKey

'')
print @cmdString
IF LEN(@cmdString) > 7990
	RAISERROR (''Dynamic SQL to large'',16,1)
	
EXEC (@cmdString)



--Get reforecast information
--Q1
SET @cmdString = (Select ''

INSERT INTO #ProfitabilityReport
SELECT 
	pr.GlobalGlAccountCategoryKey,
    pr.ActivityTypeKey,
    pr.PropertyFundKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.SourceKey,
    pr.GlAccountKey,
	pr.ReimbursableKey,
	pr.FeeAdjustmentKey,
	pr.FunctionalDepartmentKey,
	pr.OverheadKey,
	'''''''' as CalendarPeriod,
	
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    
    --Expenses must be displayed as negative
	NULL as MtdActual,
	NULL as MtdBudget,
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdReforecastQ1,
	NULL as MtdReforecastQ2,
	NULL as MtdReforecastQ3,
	
	NULL as YtdActual,	
	NULL as YtdBudget, 
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdReforecastQ1, 
	NULL as YtdReforecastQ2, 
	NULL as YtdReforecastQ3, 
	
	NULL as AnnualBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
     SUM(er.Rate * pr.LocalReforecast * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
										  1
									    ELSE
										 -1 
									    END)) as AnnualReforecastQ1,								    
	 
     NULL as AnnualReforecastQ2,								    
     NULL as AnnualReforecastQ3

FROM
	ProfitabilityReforecast pr --WITH (INDEX=IX_Clustered)

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
	
	INNER JOIN GlAccount ga on ga.GlAccountKey = pr.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			
    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey

    INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey
    INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey
    INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey
    INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey
    INNER JOIN ActivityType a ON a.ActivityTypeKey = pr.ActivityTypeKey
    INNER JOIN FeeAdjustment Fa ON Fa.FeeAdjustmentKey = pr.FeeAdjustmentKey

WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ1,10,0) + ''
''
+ CASE WHEN @DisplayOverheadBy = ''Unallocated'' THEN 
			''
		AND (
				(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''UNALLOC'''')
				'' +
				CASE WHEN @OverheadOriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OverheadOriginatingSubRegionFilterTable t1) '' END +
				''
				)
			OR	(
				gac.AccountSubTypeName		<> ''''Overhead''''
				''+
				+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
				+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END +
				''
				)
			)
			''

		ELSE --ALLOC
			''
		AND (
				(
					gac.AccountSubTypeName	<> ''''Overhead''''
				)
			OR	(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''ALLOC'''')
				)
			)
			''
		+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
		+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END

		END +
		
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
+ CASE WHEN @IncludeFeeAdjustments = 1 THEN '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''',''''FEEADJUST'''')'' ELSE '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''')'' END +
''
Group By
	pr.GlobalGlAccountCategoryKey,
    pr.ActivityTypeKey,
    pr.PropertyFundKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.SourceKey,
    pr.GlAccountKey,
	pr.ReimbursableKey,
	pr.FeeAdjustmentKey,
	pr.FunctionalDepartmentKey,
	pr.OverheadKey

'')
print @cmdString
IF LEN(@cmdString) > 7990
	RAISERROR (''Dynamic SQL to large'',16,1)

EXEC (@cmdString)


--Q2



--Get reforecast information
SET @cmdString = (Select ''

INSERT INTO #ProfitabilityReport
SELECT 
	pr.GlobalGlAccountCategoryKey,
    pr.ActivityTypeKey,
    pr.PropertyFundKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.SourceKey,
    pr.GlAccountKey,
	pr.ReimbursableKey,
	pr.FeeAdjustmentKey,
	pr.FunctionalDepartmentKey,
	pr.OverheadKey,
	'''''''' as CalendarPeriod,
	
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    
    --Expenses must be displayed as negative
	NULL as MtdActual,
	NULL as MtdBudget,
	NULL as MtdReforecastQ1,
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdReforecastQ2,
	NULL as MtdReforecastQ3,
	
	NULL as YtdActual,	
	NULL as YtdBudget, 
	NULL as YtdReforecastQ1, 
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdReforecastQ2, 
	NULL as YtdReforecastQ3, 
	
	NULL as AnnualBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
     NULL as AnnualReforecastQ1,								    
	 
     SUM(er.Rate * pr.LocalReforecast * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
										  1
									    ELSE
										 -1 
									    END)) as AnnualReforecastQ2,								    
	 
     NULL as AnnualReforecastQ3

FROM
	ProfitabilityReforecast pr --WITH (INDEX=IX_Clustered)

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
	
	INNER JOIN GlAccount ga on ga.GlAccountKey = pr.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			
    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey

    INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey
    INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey
    INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey
    INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey
    INNER JOIN ActivityType a ON a.ActivityTypeKey = pr.ActivityTypeKey
    INNER JOIN FeeAdjustment Fa ON Fa.FeeAdjustmentKey = pr.FeeAdjustmentKey

WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ2,10,0) + ''
''
+ CASE WHEN @DisplayOverheadBy = ''Unallocated'' THEN 
			''
		AND (
				(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''UNALLOC'''')
				'' +
				CASE WHEN @OverheadOriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OverheadOriginatingSubRegionFilterTable t1) '' END +
				''
				)
			OR	(
				gac.AccountSubTypeName		<> ''''Overhead''''
				''+
				+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
				+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END +
				''
				)
			)
			''

		ELSE --ALLOC
			''
		AND (
				(
					gac.AccountSubTypeName	<> ''''Overhead''''
				)
			OR	(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''ALLOC'''')
				)
			)
			''
		+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
		+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END

		END +
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
+ CASE WHEN @IncludeFeeAdjustments = 1 THEN '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''',''''FEEADJUST'''')'' ELSE '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''')'' END +
''
Group By
	pr.GlobalGlAccountCategoryKey,
    pr.ActivityTypeKey,
    pr.PropertyFundKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.SourceKey,
    pr.GlAccountKey,
	pr.ReimbursableKey,
	pr.FeeAdjustmentKey,
	pr.FunctionalDepartmentKey,
	pr.OverheadKey
'')
print @cmdString
IF LEN(@cmdString) > 7990
	RAISERROR (''Dynamic SQL to large'',16,1)

EXEC (@cmdString)

--Q3



--Get reforecast information
SET @cmdString = (Select ''

INSERT INTO #ProfitabilityReport
SELECT 
	pr.GlobalGlAccountCategoryKey,
    pr.ActivityTypeKey,
    pr.PropertyFundKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.SourceKey,
    pr.GlAccountKey,
	pr.ReimbursableKey,
	pr.FeeAdjustmentKey,
	pr.FunctionalDepartmentKey,
	pr.OverheadKey,
	'''''''' as CalendarPeriod,
	
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    
    --Expenses must be displayed as negative
	NULL as MtdActual,
	NULL as MtdBudget,
	NULL as MtdReforecastQ1,
	NULL as MtdReforecastQ2,
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdReforecastQ3,
	
	NULL as YtdActual,	
	NULL as YtdBudget, 
	NULL as YtdReforecastQ1, 
	NULL as YtdReforecastQ2, 
	SUM(
		er.Rate * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
					1
				   ELSE
					-1 
				   END) * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdReforecastQ3, 
	
	NULL as AnnualBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
     NULL as AnnualReforecastQ1,								    
	 NULL as AnnualReforecastQ2,								    
	 
     SUM(er.Rate * pr.LocalReforecast * (CASE WHEN gac.FeeOrExpense = ''''INCOME'''' THEN
										  1
									    ELSE
										 -1 
									    END)) as AnnualReforecastQ3

FROM
	ProfitabilityReforecast pr --WITH (INDEX=IX_Clustered)

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
	
	INNER JOIN GlAccount ga on ga.GlAccountKey = pr.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			
    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey

    INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey
    INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey
    INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey
    INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey
    INNER JOIN ActivityType a ON a.ActivityTypeKey = pr.ActivityTypeKey
    INNER JOIN FeeAdjustment Fa ON Fa.FeeAdjustmentKey = pr.FeeAdjustmentKey

WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ3,10,0) + ''
''
+ CASE WHEN @DisplayOverheadBy = ''Unallocated'' THEN 
			''
		AND (
				(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''UNALLOC'''')
				'' +
				CASE WHEN @OverheadOriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OverheadOriginatingSubRegionFilterTable t1) '' END +
				''
				)
			OR	(
				gac.AccountSubTypeName		<> ''''Overhead''''
				''+
				+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
				+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END +
				''
				)
			)
			''

		ELSE --ALLOC
			''
		AND (
				(
					gac.AccountSubTypeName	<> ''''Overhead''''
				)
			OR	(
					gac.AccountSubTypeName	= ''''Overhead''''
				and	Oh.OverHeadCode			IN (''''UNKNOWN'''',''''ALLOC'''')
				)
			)
			''
		+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable) '' END +
		+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable) '' END

		END +
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
+ CASE WHEN @IncludeFeeAdjustments = 1 THEN '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''',''''FEEADJUST'''')'' ELSE '' AND Fa.FeeAdjustmentCode IN (''''NORMAL'''')'' END +

''
Group By
	pr.GlobalGlAccountCategoryKey,
    pr.ActivityTypeKey,
    pr.PropertyFundKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.SourceKey,
    pr.GlAccountKey,
	pr.ReimbursableKey,
	pr.FeeAdjustmentKey,
	pr.FunctionalDepartmentKey,
	pr.OverheadKey
'')
print @cmdString
IF LEN(@cmdString) > 7990
	RAISERROR (''Dynamic SQL to large'',16,1)
	
EXEC (@cmdString)


SELECT 
	gac.AccountSubTypeName AS ExpenseType, 
	gac.FeeOrExpense AS FeeOrExpense,
	CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN ''Salaries/Bonus/Taxes/Benefits'' ELSE gac.MajorCategoryName END MajorExpenseCategoryName,
    --gac.MajorCategoryName AS MajorExpenseCategoryName,
    gac.MinorCategoryName AS MinorExpenseCategoryName,
	a.BusinessLineName AS BusinessLine,
    a.ActivityTypeName AS ActivityType,
	pf.PropertyFundName AS ReportingEntityName,
	ar.SubRegionName AS AllocationSubRegionName,
    orr.SubRegionName AS OriginatingSubRegionName,
	CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN '''' ELSE ga.Code END GlobalGlAccountCode,
    CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN '''' ELSE ga.Name END GlobalGlAccountName,    
	r.ReimbursableName,
	fa.FeeAdjustmentCode,
	s.SourceName,
	gac.GlAccountCategoryKey,
	
	res.CalendarPeriod AS ActualsExpensePeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
	res.PropertyFundCode,
	res.FunctionalDepartmentCode,
    res.OriginatingRegionCode,

	--Gross
	--Month to date    
	SUM(ISNULL(res.MtdActual,0)) AS MtdActual,
	SUM(ISNULL(res.MtdBudget,0)) AS MtdOriginalBudget,
	
	SUM(ISNULL(res.MtdReforecastQ1,0))AS MtdReforecastQ1,
	SUM(ISNULL(res.MtdReforecastQ2,0))AS MtdReforecastQ2,
	SUM(ISNULL(res.MtdReforecastQ3,0))AS MtdReforecastQ3,

	/* Enhanced case statement: IMS 58120 */

	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(MtdBudget,0)) - SUM(ISNULL(MtdActual,0)) ELSE SUM(ISNULL(res.MtdActual,0)) - SUM(ISNULL(MtdBudget,0)) END AS MtdVarianceQ0,
	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(res.MtdReforecastQ1,0)) - SUM(ISNULL(MtdActual,0)) ELSE SUM(ISNULL(MtdActual,0)) - SUM(ISNULL(res.MtdReforecastQ1,0)) END AS MtdVarianceQ1,
	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(res.MtdReforecastQ2,0)) - SUM(ISNULL(MtdActual,0)) ELSE SUM(ISNULL(MtdActual,0)) - SUM(ISNULL(res.MtdReforecastQ2,0)) END AS MtdVarianceQ2,
	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(res.MtdReforecastQ3,0)) - SUM(ISNULL(MtdActual,0)) ELSE SUM(ISNULL(MtdActual,0)) - SUM(ISNULL(res.MtdReforecastQ3,0)) END AS MtdVarianceQ3,
	
	--Year to date
	SUM(ISNULL(res.YtdActual,0)) AS YtdActual,	
	SUM(ISNULL(res.YtdBudget,0)) AS YtdOriginalBudget,
	
	SUM(ISNULL(res.YtdReforecastQ1,0)) AS YtdReforecastQ1,
	SUM(ISNULL(res.YtdReforecastQ2,0)) YtdReforecastQ2,
	SUM(ISNULL(res.YtdReforecastQ3,0)) YtdReforecastQ3,
	
	/* Enhanced case statement: IMS 58120 */

	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(YtdBudget,0)) - SUM(ISNULL(YtdActual,0)) ELSE SUM(ISNULL(res.YtdActual,0)) - SUM(ISNULL(YtdBudget,0)) END AS YtdVarianceQ0,
	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(res.YtdReforecastQ1,0)) - SUM(ISNULL(YtdActual,0)) ELSE SUM(ISNULL(YtdActual,0)) - SUM(ISNULL(res.YtdReforecastQ1,0)) END AS YtdVarianceQ1,
	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(res.YtdReforecastQ2,0)) - SUM(ISNULL(YtdActual,0)) ELSE SUM(ISNULL(YtdActual,0)) - SUM(ISNULL(res.YtdReforecastQ2,0)) END AS YtdVarianceQ2,
	CASE WHEN gac.FeeOrExpense = ''EXPENSE'' AND NOT ( r.ReimbursableName = ''Reimbursable'' AND (gac.AccountSubTypeName = ''Payroll'' OR gac.AccountSubTypeName = ''Overhead'') ) THEN SUM(ISNULL(res.YtdReforecastQ3,0)) - SUM(ISNULL(YtdActual,0)) ELSE SUM(ISNULL(YtdActual,0)) - SUM(ISNULL(res.YtdReforecastQ3,0)) END AS YtdVarianceQ3,
	
	--Annual
	SUM(ISNULL(res.AnnualBudget,0)) AS AnnualOriginalBudget,	
	SUM(ISNULL(res.AnnualReforecastQ1,0)) AS AnnualReforecastQ1,
	SUM(ISNULL(res.AnnualReforecastQ2,0)) AS AnnualReforecastQ2,
	SUM(ISNULL(res.AnnualReforecastQ3,0)) AS AnnualReforecastQ3

INTO
	[#Output]
FROM
	#ProfitabilityReport res
	
	INNER JOIN Overhead oh ON oh.OverheadKey = res.OverheadKey

	INNER JOIN GlAccount ga on ga.GlAccountKey = res.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = res.GlAccountCategoryKey
		
    INNER JOIN Reimbursable r ON r.ReimbursableKey = res.ReimbursableKey
    INNER JOIN Source s ON s.SourceKey = res.SourceKey

    INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = res.AllocationRegionKey
    INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = res.OriginatingRegionKey
    INNER JOIN ActivityType a ON  a.ActivityTypeKey = res.ActivityTypeKey
    INNER JOIN PropertyFund pf ON pf.PropertyFundKey = res.PropertyFundKey
    INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = res.FunctionalDepartmentKey
    INNER JOIN FeeAdjustment fa ON fa.FeeAdjustmentKey = res.FeeAdjustmentKey

	
GROUP BY
	gac.AccountSubTypeName, 
	gac.FeeOrExpense,
    CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN ''Salaries/Bonus/Taxes/Benefits'' ELSE gac.MajorCategoryName END,
    gac.MinorCategoryName,
    a.BusinessLineName,
    a.ActivityTypeName,
	pf.PropertyFundName,
	ar.SubRegionName,
    orr.SubRegionName,
	CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN '''' ELSE ga.Code END,
    CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN '''' ELSE ga.Name END,
	r.ReimbursableName,
	fa.FeeAdjustmentCode,
	s.SourceName,
	gac.GlAccountCategoryKey,
	
	res.CalendarPeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
	res.PropertyFundCode,
	res.FunctionalDepartmentCode,
    res.OriginatingRegionCode


--Eliminate any rows, that all calcs product a 0 value, this is to reduce the report size
------------------------------------------------------------------------------------------------------------------------------------------
-- <<< NOTE !!!!!!! >>>
--Any changes to this resultset must be applied to the [stp_R_Profitability] for this stp is used in a insert into xxx exec xxx there
------------------------------------------------------------------------------------------------------------------------------------------
SELECT
	ExpenseType, 
	FeeOrExpense,
    MajorExpenseCategoryName,
    MinorExpenseCategoryName,
	GlobalGlAccountCode,
	GlobalGlAccountName,
    BusinessLine,
    ActivityType,
	ReportingEntityName,
	PropertyFundCode,
	FunctionalDepartmentCode,
	AllocationSubRegionName,
	OriginatingSubRegionName,
	ActualsExpensePeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
	ReimbursableName,
	FeeAdjustmentCode,
	SourceName,
	GlAccountCategoryKey,
	
	--Gross
	--Month to date    
	MtdActual,
	MtdOriginalBudget,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ1 END AS MtdReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ2 END AS MtdReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ3 END AS MtdReforecastQ3,

	MtdVarianceQ0,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdVarianceQ1 END AS MtdVarianceQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdVarianceQ2 END AS MtdVarianceQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdVarianceQ3 END AS MtdVarianceQ3,
	
	--Year to date
	YtdActual,	
	YtdOriginalBudget,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ1 END AS YtdReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ2 END AS YtdReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ3 END AS YtdReforecastQ3,

	YtdVarianceQ0,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdVarianceQ1 END AS YtdVarianceQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdVarianceQ2 END AS YtdVarianceQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdVarianceQ3 END AS YtdVarianceQ3,

	--Annual
	AnnualOriginalBudget,	
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ1 END AS AnnualReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ2 END AS AnnualReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ3 END AS AnnualReforecastQ3

FROM
	[#Output]
--WHERE
	----Gross
	----Month to date    
	--MtdActual <> 0.00 OR
	--MtdOriginalBudget <> 0.00 OR
	--MtdReforecastQ1 <> 0.00 OR
	--MtdReforecastQ2 <> 0.00 OR
	--MtdReforecastQ3 <> 0.00 OR
	--MtdVarianceQ0 <> 0.00 OR
	--MtdVarianceQ1 <> 0.00 OR
	--MtdVarianceQ2 <> 0.00 OR
	--MtdVarianceQ3 <> 0.00 OR
	
	----Year to date
	--YtdActual <> 0.00 OR
	--YtdOriginalBudget <> 0.00 OR
	--YtdReforecastQ1 <> 0.00 OR
	--YtdReforecastQ2 <> 0.00 OR
	--YtdReforecastQ3 <> 0.00 OR
	--YtdVarianceQ0 <> 0.00 OR
	--YtdVarianceQ1 <> 0.00 OR
	--YtdVarianceQ2 <> 0.00 OR
	--YtdVarianceQ3 <> 0.00 OR
	
	----Annual
	--AnnualOriginalBudget <> 0.00 OR
	--AnnualReforecastQ1 <> 0.00 OR
	--AnnualReforecastQ2 <> 0.00 OR
	--AnnualReforecastQ3 <> 0.00

IF 	OBJECT_ID(''tempdb..#ProfitabilityReport'') IS NOT NULL
    DROP TABLE #ProfitabilityReport

IF 	OBJECT_ID(''tempdb..#Output'') IS NOT NULL
    DROP TABLE #Output
    
IF 	OBJECT_ID(''tempdb..#ProfitabilityReport'') IS NOT NULL
    DROP TABLE #ProfitabilityReport

' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzarTotalComparisonDetail]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzarTotalComparisonDetail]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'


CREATE PROCEDURE [dbo].[stp_R_ExpenseCzarTotalComparisonDetail]
	@ReportExpensePeriod INT = NULL,
	@ReforecastQuaterName VARCHAR(10) = NULL, --''Q1'' or ''Q2'' or ''Q3''
	@PreviousReforecastQuaterName VARCHAR(10) = ''Q1'', -- or ''Q2'' or ''Q3''
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = ''Global'',
	@IsGross bit = 1,
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@CategoryActivityGroups dbo.CategoryActivityGroup READONLY,
	@OverheadCode Varchar(10)=''UNALLOC''
AS

/*
DECLARE @ReportExpensePeriod   INT,
	@AccountCategoryList   VARCHAR(8000),
	@DestinationCurrency   VARCHAR(3),
	@TranslationTypeName   VARCHAR(50),
	@FunctionalDepartmentList VARCHAR(8000),
	@AllocationRegionList VARCHAR(8000),
	@EntityList VARCHAR(8000)
	
	
	SET @ReportExpensePeriod = 201011
	SET @AccountCategoryList = ''IT Costs & Telecommunications''
	SET @DestinationCurrency =''USD''
	SET @TranslationTypeName = ''Global''
	SET @FunctionalDepartmentList = ''Information Technologies''
	SET @AllocationRegionList = NULL
	SET @EntityList = NULL
	
EXEC stp_R_ExpenseCzarTotalComparisonDetail
	@ReportExpensePeriod = 201011,
	@TranslationTypeName = ''Global'',
	@DestinationCurrency = ''USD'',

	@FunctionalDepartmentList = ''Information Technologies'',
	@AllocationRegionList = ''CHICAGO'',
	@EntityList = ''Aldgate|Centrium (St Cathrine House/Pegasus)''
*/

DECLARE
	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_ReforecastQuaterName VARCHAR(10) = @ReforecastQuaterName,
	@_PreviousReforecastQuaterName VARCHAR(10) = @PreviousReforecastQuaterName,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_TranslationTypeName VARCHAR(50) = @TranslationTypeName,
	@_IsGross bit = @IsGross,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList

IF LEN(@_FunctionalDepartmentList) > 7998 OR
	LEN(@_ActivityTypeList) > 7998 OR
	LEN(@_EntityList) > 7998 OR
	LEN(@_MajorAccountCategoryList) > 7998 OR
	LEN(@_MinorAccountCategoryList) > 7998 OR
	LEN(@_AllocationRegionList) > 7998 OR
	LEN(@_AllocationSubRegionList) > 7998 OR
	LEN(@_OriginatingRegionList) > 7998 OR
	LEN(@_OriginatingSubRegionList) > 7998
BEGIN
	RAISERROR(''Filter List parameter is too big'',9,1)
END

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + CAST(MONTH(GETDATE()) AS VARCHAR(2))AS INT)

--------------------------------------------------------------------------

-- Determine the ReforecastKey of the reforecast that is currently active (i.e.: 2011 Q1, 2011 Q2, 2012 Q0 etc)
DECLARE @ActiveReforecastKey INT = (SELECT ReforecastKey FROM dbo.GetCurrentReforecastRecord())

IF (@ActiveReforecastKey IS NULL) -- Safeguard against NULL ReforecastKey returned from previous statement
BEGIN
	SET @ActiveReforecastKey = (SELECT MAX(ReforecastKey) FROM dbo.ExchangeRate)
	PRINT (''Near disaster: @ActiveReforecastKey is NULL, so reverting to the largest/most recent ReforecastKey in dbo.ExchangeRate: '' + @ActiveReforecastKey)
END

--------------------------------------------------------------------------

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@TranslationTypeName IS NULL
	SET @TranslationTypeName = ''Global''

	DECLARE @CalendarYear AS INT
	SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)		
	
-- let latest reforecast (it will be zero if there is no data for the reforecast)
IF @ReforecastQuaterName IS NULL OR @ReforecastQuaterName NOT IN (''Q0'', ''Q1'', ''Q2'', ''Q3'')
	SET @ReforecastQuaterName = (SELECT TOP 1
									ReforecastQuarterName 
								 FROM
									dbo.Reforecast 
								 WHERE
									ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
									ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
								 ORDER BY
									ReforecastEffectivePeriod DESC)

-- Compute Reforecast Effective Periods

DECLARE @ReforecastEffectivePeriodQ1 INT
DECLARE @ReforecastEffectivePeriodQ2 INT
DECLARE @ReforecastEffectivePeriodQ3 INT

SET @ReforecastEffectivePeriodQ1 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q1''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ2 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q2''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ3 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q3''
									ORDER BY
										ReforecastEffectivePeriod)

-- Retrieve Reforecast Quarter Name

DECLARE @ReforecastQuarterNameQ1 CHAR(2)
DECLARE @ReforecastQuarterNameQ2 CHAR(2)
DECLARE @ReforecastQuarterNameQ3 CHAR(2)

IF (@ReforecastEffectivePeriodQ1 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ1 = (SELECT TOP 1
										ReforecastQuarterName 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ1)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ1 is NULL - cannot determine Q1 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ2 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ2 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ2)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ2 is NULL - cannot determine Q2 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ3 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ3 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ3)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ3 is NULL - cannot determine Q3 reforecast quarter name.'')
END
	
--------------------------------------------------------------------------
/*	Determine Report Exchange Rates	*/
--------------------------------------------------------------------------

SELECT
	SourceCurrencyKey,
	DestinationCurrencyKey,
	CalendarKey,
	Rate
INTO
	#ExchangeRate
FROM
	dbo.ExchangeRate
WHERE
	ReforecastKey = @ActiveReforecastKey -- We will use the exchange rate set that is active for the current reforecast.
	
--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
CREATE TABLE #EntityFilterTable (PropertyFundKey Int NOT NULL)
CREATE TABLE #FunctionalDepartmentFilterTable (FunctionalDepartmentKey Int NOT NULL)
CREATE TABLE #ActivityTypeFilterTable (ActivityTypeKey Int NOT NULL)
CREATE TABLE #AllocationRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #AllocationSubRegionFilterTable	(AllocationRegionKey Int NOT NULL)
CREATE TABLE #MajorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #MinorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #OriginatingRegionFilterTable (OriginatingRegionKey Int NOT NULL)
CREATE TABLE #OriginatingSubRegionFilterTable (OriginatingRegionKey Int NOT NULL)	
CREATE TABLE #CategoryActivityGroupFilterTable (GlAccountCategoryKey Int NOT NULL, ActivityTypeKey Int NULL)	

CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable (PropertyFundKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable (FunctionalDepartmentKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable (ActivityTypeKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable (AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable (AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable (GlAccountCategoryKey)	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable (GlAccountCategoryKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable (OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable (OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #CategoryActivityGroupFilterTable (GlAccountCategoryKey, ActivityTypeKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	INSERT INTO #OriginatingSubRegionFilterTable
	SELECT orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END		
	
IF EXISTS(SELECT * FROM @CategoryActivityGroups)
	BEGIN
	INSERT INTO #CategoryActivityGroupFilterTable
	SELECT gl.GlAccountCategoryKey, at.ActivityTypeKey 
	FROM @CategoryActivityGroups cag
		CROSS APPLY dbo.Split(cag.MinorAccountCategoryList) t1
		OUTER APPLY dbo.Split(cag.ActivityTypeList) t2
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item 
		LEFT OUTER JOIN ActivityType at ON at.ActivityTypeName = t2.item
	END
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------

IF 	OBJECT_ID(''tempdb..#ExpenseCzarTotalComparisonDetail'') IS NOT NULL
    DROP TABLE #ExpenseCzarTotalComparisonDetail

CREATE TABLE #ExpenseCzarTotalComparisonDetail
(	
	GlAccountCategoryKey	INT,
    FunctionalDepartmentKey	INT,
    AllocationRegionKey		INT,
    PropertyFundKey			INT,
	SourceName				VARCHAR(50),
	EntryDate				VARCHAR(10),
	[User]					NVARCHAR(20),
	[Description]			NVARCHAR(60),
	AdditionalDescription	NVARCHAR(4000),
	PropertyFundCode		VARCHAR(6) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	OriginatingRegionCode	VARCHAR(30) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	FunctionalDepartmentCode VARCHAR(15) DEFAULT(''''),
	GlAccountKey			INT NULL,
	CalendarPeriod			Varchar(6) DEFAULT(''''),

	--Month to date	
	MtdGrossActual			MONEY,
	MtdGrossBudget			MONEY,
	MtdGrossReforecastQ1	MONEY,
	MtdGrossReforecastQ2	MONEY,
	MtdGrossReforecastQ3	MONEY,
	MtdNetActual			MONEY,
	MtdNetBudget			MONEY,
	MtdNetReforecastQ1		MONEY,
	MtdNetReforecastQ2		MONEY,
	MtdNetReforecastQ3		MONEY,
	
	--Year to date
	YtdGrossActual			MONEY,	
	YtdGrossBudget			MONEY, 
	YtdGrossReforecastQ1	MONEY,
	YtdGrossReforecastQ2	MONEY,
	YtdGrossReforecastQ3	MONEY,
	YtdNetActual			MONEY, 
	YtdNetBudget			MONEY, 
	YtdNetReforecastQ1		MONEY,
	YtdNetReforecastQ2		MONEY,
	YtdNetReforecastQ3		MONEY,

	--Annual	
	AnnualGrossBudget		MONEY,
	AnnualGrossReforecastQ1	MONEY,
	AnnualGrossReforecastQ2	MONEY,
	AnnualGrossReforecastQ3	MONEY,

	AnnualNetBudget			MONEY,
	AnnualNetReforecastQ1	MONEY,
	AnnualNetReforecastQ2	MONEY,
	AnnualNetReforecastQ3	MONEY,


	--Annual estimated
	AnnualEstGrossBudget	MONEY,
	AnnualEstGrossReforecastQ1 MONEY,
	AnnualEstGrossReforecastQ2 MONEY,
	AnnualEstGrossReforecastQ3 MONEY,
	
	AnnualEstNetBudget		MONEY,
	AnnualEstNetReforecastQ1 MONEY,
	AnnualEstNetReforecastQ2 MONEY,
	AnnualEstNetReforecastQ3 MONEY
)

DECLARE @cmdString VARCHAR(8000)

--Get actual information
SET @cmdString = (SELECT ''
	
INSERT INTO #ExpenseCzarTotalComparisonDetail
SELECT 
	gac.GlAccountCategoryKey,
    pa.FunctionalDepartmentKey,
    pa.AllocationRegionKey,
    pa.PropertyFundKey,
    s.SourceName,
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101) as EntryDate,
    ISNULL(pa.[User], '''''''') [User],
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END as Description,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END as AdditionalDescription,
    ISNULL(pa.PropertyFundCode, '''''''') PropertyFundCode,
    ISNULL(pa.OriginatingRegionCode, '''''''') OriginatingRegionCode,
    ISNULL(pa.FunctionalDepartmentCode, '''''''') FunctionalDepartmentCode,
    pa.GlAccountKey,
    c.CalendarPeriod,
    
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*--  --------------------------*/ + ''
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,	
	
	'' + /*--  --------------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*--  --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,

	'' + /*--  --------------------------*/ + ''
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'' + /*--  --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,

	'')
	
	DECLARE @cmdString2 VARCHAR(8000)
	SET @cmdString2 = (SELECT ''

	'' + /*--  --------------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*--  --------------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	'' + /*--  --------------------------*/ + ''
	
	NULL as AnnualGrossBudget,
	
	'' + /*--  --------------------------*/ + ''
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*--  --------------------------*/ + ''

	NULL as AnnualNetBudget,
	
	'' + /*--  --------------------------*/ + ''
	
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	'' + /*--  --------------------------*/ + ''
		
	SUM(
        er.Rate *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
	) as AnnualEstGrossBudget,
	
	'' + /*--  --------------------------*/ + ''
	
	'')
	
	DECLARE @cmdString3 VARCHAR(8000)
	SET @cmdString3 = (SELECT ''
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	'' + /*--  --------------------------*/ + ''

    SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
    '' + /*--  --------------------------*/ + ''
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3	
	
	'' + /*--  --------------------------*/ + ''
	
FROM
	ProfitabilityActual pa

	INNER JOIN Overhead oh ON oh.OverheadKey = pa.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

		INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
				WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pa.EUCorporateGlAccountCategoryKey'' 
				WHEN @TranslationTypeName = ''US Property'' THEN ''pa.USPropertyGlAccountCategoryKey'' 
				WHEN @TranslationTypeName = ''US Fund'' THEN ''pa.USFundGlAccountCategoryKey'' 
				WHEN @TranslationTypeName = ''EU Property'' THEN ''pa.EUPropertyGlAccountCategoryKey'' 
				WHEN @TranslationTypeName = ''US Corporate'' THEN ''pa.USCorporateGlAccountCategoryKey'' 
				WHEN @TranslationTypeName = ''Development'' THEN ''pa.DevelopmentGlAccountCategoryKey'' 
				WHEN @TranslationTypeName = ''EU Fund'' THEN ''pa.EUFundGlAccountCategoryKey'' 
				WHEN @TranslationTypeName = ''Global'' THEN ''pa.GlobalGlAccountCategoryKey'' 
				ELSE ''break:not valid TranslationTypeName'' END + ''
				AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
				
	    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
	    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
	    INNER JOIN Calendar c ON  c.CalendarKey = pa.CalendarKey
	    INNER JOIN Source s ON s.SourceKey = pa.SourceKey
	    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pa.ReimbursableKey ''
	    
    + CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pa.ActivityTypeKey)'' ELSE '''' END + ''
			
WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationRegionFilterTable t1)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationSubRegionFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''
GROUP BY
	gac.GlAccountCategoryKey,
    pa.FunctionalDepartmentKey,
    pa.AllocationRegionKey,
    pa.PropertyFundKey,
    s.SourceName,
	CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101),
	pa.[User],
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END,
	ISNULL(pa.PropertyFundCode, ''''''''),
	ISNULL(pa.OriginatingRegionCode, ''''''''),
	ISNULL(pa.FunctionalDepartmentCode, ''''''''),
	pa.GlAccountKey,
	c.CalendarPeriod

'')

IF (LEN(@cmdString) > 7995 OR LEN(@cmdString2) > 7995 OR LEN(@cmdString3) > 7995)
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LTRIM(RTRIM(LEN(@cmdString)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString2)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString3)))))

PRINT @cmdString
PRINT @cmdString2
PRINT @cmdString3

EXEC (@cmdString + @cmdString2 + @cmdString3)

-- Get budget information
SET @cmdString = (Select ''	

INSERT INTO #ExpenseCzarTotalComparisonDetail
SELECT 
	gac.GlAccountCategoryKey,
	pb.FunctionalDepartmentKey,
	pb.AllocationRegionKey,
	pb.PropertyFundKey,
	s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END,
	'''''''' as CalendarPeriod,
    
   NULL as MtdGrossActual,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as MtdGrossBudget,	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as MtdNetBudget,    
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as YtdGrossBudget, 
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as YtdNetBudget, 
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	SUM(er.Rate * pb.LocalBudget) as AnnualGrossBudget,
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	SUM(er.Rate * r.MultiplicationFactor * pb.LocalBudget) as AnnualNetBudget,
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,

	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as AnnualEstGrossBudget,
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3
	
FROM
	ProfitabilityBudget pb

	INNER JOIN Overhead oh ON oh.OverheadKey = pb.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
		
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
		WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pb.EUCorporateGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''US Property'' THEN ''pb.USPropertyGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''US Fund'' THEN ''pb.USFundGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''EU Property'' THEN ''pb.EUPropertyGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''US Corporate'' THEN ''pb.USCorporateGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''Development'' THEN ''pb.DevelopmentGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''EU Fund'' THEN ''pb.EUFundGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''Global'' THEN ''pb.GlobalGlAccountCategoryKey'' 
		ELSE ''break:not valid TranslationTypeName'' END + ''
		AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')	

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pb.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pb.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pb.ReimbursableKey ''
	    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pb.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pb.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1 
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	gac.GlAccountCategoryKey,
    pb.FunctionalDepartmentKey,
    pb.AllocationRegionKey,
    pb.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

----------------------------------------------------------------------------------------------------
-- Get Q1 reforecast information
SET @cmdString = (Select ''	

INSERT INTO #ExpenseCzarTotalComparisonDetail
SELECT 
	gac.GlAccountCategoryKey,
    pr.FunctionalDepartmentKey,
    pr.AllocationRegionKey,
    pr.PropertyFundKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
	'''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget, 
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget, 
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ1,
    NULL as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
    NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ1,
    NULL as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3

FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
		
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid TranslationTypeName'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')	

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pr.ReimbursableKey ''
	    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ1,10,0) + ''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	gac.GlAccountCategoryKey,
    pr.FunctionalDepartmentKey,
    pr.AllocationRegionKey,
    pr.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END

'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)


----------------------------------------------------------------------------------------------------
-- Get Q2 reforecast information
SET @cmdString = (Select ''	

INSERT INTO #ExpenseCzarTotalComparisonDetail
SELECT 
	gac.GlAccountCategoryKey,
    pr.FunctionalDepartmentKey,
    pr.AllocationRegionKey,
    pr.PropertyFundKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
	'''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	NULL as MtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	NULL as MtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	NULL as YtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	NULL as YtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualGrossReforecastQ1,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ2,    
    NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualNetReforecastQ1,
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	NULL as AnnualEstGrossReforecastQ1,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	NULL as AnnualEstNetReforecastQ1,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3

FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
		
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid TranslationTypeName'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')	

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pr.ReimbursableKey ''
	    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ2,10,0) + ''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	gac.GlAccountCategoryKey,
    pr.FunctionalDepartmentKey,
    pr.AllocationRegionKey,
    pr.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END 
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)


----------------------------------------------------------------------------------------------------
-- Get Q3 reforecast information
SET @cmdString = (Select ''	

INSERT INTO #ExpenseCzarTotalComparisonDetail
SELECT 
	gac.GlAccountCategoryKey,
    pr.FunctionalDepartmentKey,
    pr.AllocationRegionKey,
    pr.PropertyFundKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ3

FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
		
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
		WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
		WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
		ELSE ''break:not valid TranslationTypeName'' END + ''
		AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')	

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pr.ReimbursableKey ''
	    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ3,10,0) + ''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	gac.GlAccountCategoryKey,
    pr.FunctionalDepartmentKey,
    pr.AllocationRegionKey,
    pr.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END 
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

------------------------------------------------------------------------------------------------------------------------------------

CREATE CLUSTERED INDEX IX ON #ExpenseCzarTotalComparisonDetail(
	PropertyFundKey,
	AllocationRegionKey,
	FunctionalDepartmentKey,
	GlAccountCategoryKey
)

SELECT 
	gac.AccountSubTypeName AS ExpenseType,
	gac.MajorCategoryName AS MajorExpenseCategoryName,
    gac.MinorCategoryName AS MinorExpenseCategoryName,    
    fd.FunctionalDepartmentName AS FunctionalDepartmentName,
    fd.FunctionalDepartmentName AS FunctionalDepartmentFilterName,
    ar.SubRegionName AS AllocationSubRegionName,
    ar.SubRegionName AS AllocationSubRegionFilterName,
    pf.PropertyFundName AS EntityName,
    res.CalendarPeriod AS ActualsExpensePeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
    res.SourceName AS SourceName,
    res.PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END AS OriginatingRegionCode,
    --res.OriginatingRegionCode,
    ISNULL(ga.Code, '''') GlAccountCode,
    ISNULL(ga.Name, '''') GlAccountName,    

	--Month to date    
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossActual,0) ELSE ISNULL(MtdNetActual,0) END) AS MtdActual,
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossBudget,0) ELSE ISNULL(MtdNetBudget,0) END) AS MtdOriginalBudget,
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END,0) 
	END) 
	AS MtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END,0) 
	END) 
	AS MtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END,0) 
	END) 
	AS MtdReforecastQ3,
	-------------------------------
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ3,
	-------------------------------
	
	--Year to date
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossActual,0) ELSE ISNULL(YtdNetActual,0) END) AS YtdActual,	
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossBudget,0) ELSE ISNULL(YtdNetBudget,0) END) AS YtdOriginalBudget,
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1
		END,0) 
	END) 
	AS YtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2
		END,0) 
	END) 
	AS YtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3
		END,0) 
	END) 
	AS YtdReforecastQ3,
	-------------------------------
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget
		ELSE 
			YtdGrossReforecastQ1
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget
		ELSE 
			YtdNetReforecastQ1
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget
		ELSE 
			YtdGrossReforecastQ2
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget
		ELSE 
			YtdNetReforecastQ2
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget
		ELSE 
			YtdGrossReforecastQ3
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget
		ELSE 
			YtdNetReforecastQ3
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ3,	
	-------------------------------
	
	--Annual
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnnualGrossBudget,0) ELSE ISNULL(AnnualNetBudget,0) END) AS AnnualOriginalBudget,	

	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualGrossBudget
		ELSE
			AnnualGrossReforecastQ1
		END,0)
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualNetBudget
		ELSE
			AnnualNetReforecastQ1
		END,0)
	END)
	AS AnnualReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualGrossBudget
		ELSE
			AnnualGrossReforecastQ2
		END,0)
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualNetBudget
		ELSE
			AnnualNetReforecastQ2
		END,0)
	END)
	AS AnnualReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualGrossBudget
		ELSE
			AnnualGrossReforecastQ3
		END,0)
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualNetBudget
		ELSE
			AnnualNetReforecastQ3
		END,0)
	END)
	AS AnnualReforecastQ3
	-------------------------------
INTO
	#Output	
FROM
	#ExpenseCzarTotalComparisonDetail res
	INNER JOIN PropertyFund pf ON pf.PropertyFundKey = res.PropertyFundKey
	INNER JOIN AllocationRegion ar ON ar.AllocationRegionKey = res.AllocationRegionKey
	INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentKey = res.FunctionalDepartmentKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = res.GlAccountCategoryKey 
	LEFT OUTER JOIN GlAccount ga ON ga.GlAccountKey = res.GlAccountKey 
GROUP BY
	gac.AccountSubTypeName,
	gac.MajorCategoryName,
    gac.MinorCategoryName,
    fd.FunctionalDepartmentName,
    ar.SubRegionName,
    pf.PropertyFundName,
    res.CalendarPeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
    res.SourceName,
    res.PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END,

    --res.OriginatingRegionCode,
    ISNULL(ga.Code, ''''),
    ISNULL(ga.Name, '''')
	
--Output
SELECT
	ExpenseType,
	MajorExpenseCategoryName,
    MinorExpenseCategoryName,
    FunctionalDepartmentName,
    FunctionalDepartmentFilterName,
    AllocationSubRegionName,
    AllocationSubRegionFilterName,
    EntityName,
    ActualsExpensePeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
    SourceName,
    PropertyFundCode,
    OriginatingRegionCode,
    GlAccountCode,
    GlAccountName,    
    
	--Month to date    
	MtdActual,
	MtdOriginalBudget,
	MtdReforecastQ1,
	--MtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ3 END AS MtdReforecastQ3,
	MtdVarianceQ1,
	--MtdVarianceQ2,
	--MtdVarianceQ3,
	
	--Year to date
	YtdActual,	
	YtdOriginalBudget,
	YtdReforecastQ1,
	--YtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ3 END AS YtdReforecastQ3,
	YtdVarianceQ1,
	--YtdVarianceQ2,
	--YtdVarianceQ3,
	
	--Annual
	AnnualOriginalBudget,
	AnnualReforecastQ1,	
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ1 END AS AnnualReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ2 END AS AnnualReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ3 END AS AnnualReforecastQ3
FROM
	#Output
WHERE
	--Month to date    
	MtdActual <> 0.00 OR
	MtdOriginalBudget <> 0.00 OR
	
	--MtdReforecastQ1 <> 0.00 OR
	--MtdReforecastQ2 <> 0.00 OR
	--MtdReforecastQ3 <> 0.00 OR
	MtdVarianceQ1 <> 0.00 OR
	--MtdVarianceQ2 <> 0.00 OR
	--MtdVarianceQ3 <> 0.00 OR
	
	--Year to date
	YtdActual <> 0.00 OR
	YtdOriginalBudget <> 0.00 OR
	
	--YtdReforecastQ1 <> 0.00 OR
	--YtdReforecastQ2 <> 0.00 OR
	--YtdReforecastQ3 <> 0.00 OR
	YtdVarianceQ1 <> 0.00 OR
	--YtdVarianceQ2 <> 0.00 OR
	--YtdVarianceQ3 <> 0.00 OR
	
	--Annual
	AnnualOriginalBudget <> 0.00 OR
	AnnualReforecastQ1 <> 0.00 
	--AnnualReforecastQ2 <> 0.00 OR
	--AnnualReforecastQ3 <> 0.00

IF 	OBJECT_ID(''tempdb..#ExpenseCzarTotalComparisonDetail'') IS NOT NULL
    DROP TABLE #ExpenseCzarTotalComparisonDetail

IF 	OBJECT_ID(''tempdb..#Output'') IS NOT NULL
    DROP TABLE #Output

IF 	OBJECT_ID(''tempdb..#EntityFilterTable'') IS NOT NULL
	DROP TABLE #EntityFilterTable
	
IF 	OBJECT_ID(''tempdb..#FunctionalDepartmentFilterTable'') IS NOT NULL
	DROP TABLE #FunctionalDepartmentFilterTable
	
IF 	OBJECT_ID(''tempdb..#ActivityTypeFilterTable'') IS NOT NULL
	DROP TABLE #ActivityTypeFilterTable
	
IF 	OBJECT_ID(''tempdb..#AllocationRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#AllocationSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationSubRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#MajorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MajorAccountCategoryFilterTable
	
IF 	OBJECT_ID(''tempdb..#MinorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MinorAccountCategoryFilterTable
	
IF 	OBJECT_ID(''tempdb..#OriginatingRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#OriginatingSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingSubRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#CategoryActivityGroupFilterTable'') IS NOT NULL
	DROP TABLE #CategoryActivityGroupFilterTable


' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzarTotalComparison]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzarTotalComparison]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'

CREATE PROCEDURE [dbo].[stp_R_ExpenseCzarTotalComparison]
	@ReportExpensePeriod INT = NULL,
	@ReforecastQuaterName VARCHAR(10) = NULL, --''Q1'' or ''Q2'' or ''Q3''
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = ''Global'',
	@IsGross bit = 1,
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@CategoryActivityGroups dbo.CategoryActivityGroup READONLY,
	@OverheadCode Varchar(10)=''UNALLOC''
AS
 
/*
DECLARE @ReportExpensePeriod   INT,
    @DestinationCurrency   VARCHAR(3),
    @MajorGlAccountCategoryList VARCHAR(8000),
    @TranslationTypeName         VARCHAR(50)

	SET @ReportExpensePeriod = 201002
	SET @DestinationCurrency = ''USD''
	SET @MajorGlAccountCategoryList = ''Salaries/Taxes/Benefits,Occupancy Costs''
	SET @TranslationTypeName = ''Global''
*/ 
/*
EXEC stp_R_ExpenseCzarTotalComparison
	@ReportExpensePeriod = 201011,
	@TranslationTypeName = ''Global'',
	@DestinationCurrency = ''USD'',

	@FunctionalDepartmentList = ''Information Technologies'',
	@AllocationRegionList = ''CHICAGO'',
	@EntityList = ''Aldgate|Centrium (St Cathrine House/Pegasus)''
*/

DECLARE
	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_TranslationTypeName VARCHAR(50) = @TranslationTypeName,
	@_IsGross bit = @IsGross,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList

IF LEN(@_FunctionalDepartmentList) > 7998 OR
	LEN(@_ActivityTypeList) > 7998 OR
	LEN(@_EntityList) > 7998 OR
	LEN(@_MajorAccountCategoryList) > 7998 OR
	LEN(@_MinorAccountCategoryList) > 7998 OR
	LEN(@_AllocationRegionList) > 7998 OR
	LEN(@_AllocationSubRegionList) > 7998 OR
	LEN(@_OriginatingRegionList) > 7998 OR
	LEN(@_OriginatingSubRegionList) > 7998
BEGIN
	RAISERROR(''Filter List parameter is too big'',9,1)
END

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + CAST(MONTH(GETDATE()) AS VARCHAR(2))AS INT)

--------------------------------------------------------------------------

-- Determine the ReforecastKey of the reforecast that is currently active (i.e.: 2011 Q1, 2011 Q2, 2012 Q0 etc)
DECLARE @ActiveReforecastKey INT = (SELECT ReforecastKey FROM dbo.GetCurrentReforecastRecord())

IF (@ActiveReforecastKey IS NULL) -- Safeguard against NULL ReforecastKey returned from previous statement
BEGIN
	SET @ActiveReforecastKey = (SELECT MAX(ReforecastKey) FROM dbo.ExchangeRate)
	PRINT (''Near disaster: @ActiveReforecastKey is NULL, so reverting to the largest/most recent ReforecastKey in dbo.ExchangeRate: '' + @ActiveReforecastKey)
END

--------------------------------------------------------------------------

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@TranslationTypeName IS NULL
	SET @TranslationTypeName = ''Global''

	DECLARE @CalendarYear AS INT
	SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)		
	
-- let latest reforecast (it will be zero if there is no data for the reforecast)
IF @ReforecastQuaterName IS NULL OR @ReforecastQuaterName NOT IN (''Q0'', ''Q1'', ''Q2'', ''Q3'')
	SET @ReforecastQuaterName = (SELECT TOP 1 ReforecastQuarterName 
									FROM dbo.Reforecast 
									WHERE ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
										  ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
									ORDER BY ReforecastEffectivePeriod DESC)

-- Compute Reforecast Effective Periods

DECLARE @ReforecastEffectivePeriodQ1 INT
DECLARE @ReforecastEffectivePeriodQ2 INT
DECLARE @ReforecastEffectivePeriodQ3 INT

SET @ReforecastEffectivePeriodQ1 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q1''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ2 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q2''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ3 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q3''
									ORDER BY
										ReforecastEffectivePeriod)

-- Retrieve Reforecast Quarter Name

DECLARE @ReforecastQuarterNameQ1 CHAR(2)
DECLARE @ReforecastQuarterNameQ2 CHAR(2)
DECLARE @ReforecastQuarterNameQ3 CHAR(2)

IF (@ReforecastEffectivePeriodQ1 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ1 = (SELECT TOP 1
										ReforecastQuarterName 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ1)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ1 is NULL - cannot determine Q1 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ2 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ2 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ2)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ2 is NULL - cannot determine Q2 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ3 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ3 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ3)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ3 is NULL - cannot determine Q3 reforecast quarter name.'')
END

--------------------------------------------------------------------------
/*	Determine Report Exchange Rates	*/
--------------------------------------------------------------------------

SELECT
	SourceCurrencyKey,
	DestinationCurrencyKey,
	CalendarKey,
	Rate
INTO
	#ExchangeRate
FROM
	dbo.ExchangeRate
WHERE
	ReforecastKey = @ActiveReforecastKey -- We will use the exchange rate set that is active for the current reforecast.

										
--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
CREATE TABLE #EntityFilterTable	(PropertyFundKey Int NOT NULL)
CREATE TABLE #FunctionalDepartmentFilterTable (FunctionalDepartmentKey Int NOT NULL)
CREATE TABLE #ActivityTypeFilterTable (ActivityTypeKey Int NOT NULL)
CREATE TABLE #AllocationRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #AllocationSubRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #MajorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #MinorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #OriginatingRegionFilterTable (OriginatingRegionKey Int NOT NULL)
CREATE TABLE #OriginatingSubRegionFilterTable (OriginatingRegionKey Int NOT NULL)	
CREATE TABLE #CategoryActivityGroupFilterTable (GlAccountCategoryKey Int NOT NULL, ActivityTypeKey Int NULL)	
	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable	(PropertyFundKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable	(FunctionalDepartmentKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable(ActivityTypeKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable(GlAccountCategoryKey)	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable(GlAccountCategoryKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable	(OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable	(OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #CategoryActivityGroupFilterTable	(GlAccountCategoryKey, ActivityTypeKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END	
	
IF EXISTS(SELECT * FROM @CategoryActivityGroups)
	BEGIN
	Insert Into #CategoryActivityGroupFilterTable
	Select gl.GlAccountCategoryKey, at.ActivityTypeKey 
	From @CategoryActivityGroups cag
		CROSS APPLY dbo.Split(cag.MinorAccountCategoryList) t1
		OUTER APPLY dbo.Split(cag.ActivityTypeList) t2
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item 
		LEFT OUTER JOIN ActivityType at ON at.ActivityTypeName = t2.item
	END	
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------
 
 -- Combine budget and actual values
IF OBJECT_ID(''tempdb..#TotalComparison'') IS NOT NULL
    DROP TABLE #TotalComparison

CREATE TABLE #TotalComparison
(	
	AccountSubTypeName      VARCHAR(50),
	TranslationTypeName     VARCHAR(50),
	MajorCategoryName       VARCHAR(100),
	MinorCategoryName       VARCHAR(100),
	CalendarPeriod          INT,
	SourceName				VARCHAR(50),
	EntryDate				VARCHAR(10),
	[User]					NVARCHAR(20),
	[Description]			NVARCHAR(60),
	AdditionalDescription	NVARCHAR(4000),
	PropertyFundCode		VARCHAR(6) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	OriginatingRegionCode	VARCHAR(30) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	FunctionalDepartmentCode	VARCHAR(15) DEFAULT(''''),
	GlAccountCode			VARCHAR(50),
	GlAccountName			VARCHAR(150),

	--Month to date
	MtdGrossActual           MONEY,
	MtdGrossBudget           MONEY,
	
	MtdGrossReforecastQ1     MONEY,
	MtdGrossReforecastQ2     MONEY,
	MtdGrossReforecastQ3     MONEY,
	
	MtdNetActual			 MONEY,
	MtdNetBudget			 MONEY,
	
	MtdNetReforecastQ1		 MONEY,
	MtdNetReforecastQ2		 MONEY,
	MtdNetReforecastQ3		 MONEY,
	
	--Year to date
	YtdGrossActual           MONEY,
	YtdGrossBudget           MONEY,
	
	YtdGrossReforecastQ1     MONEY,
	YtdGrossReforecastQ2     MONEY,
	YtdGrossReforecastQ3     MONEY,
	
	YtdNetActual			 MONEY,
	YtdNetBudget			 MONEY,
	
	YtdNetReforecastQ1		 MONEY,
	YtdNetReforecastQ2		 MONEY,
	YtdNetReforecastQ3		 MONEY,

	--Annual
	AnnualGrossBudget		 MONEY,
	
	AnnualGrossReforecastQ1	 MONEY,
	AnnualGrossReforecastQ2	 MONEY,
	AnnualGrossReforecastQ3	 MONEY,
	
	AnnualNetBudget			 MONEY,
	
	AnnualNetReforecastQ1	 MONEY,
	AnnualNetReforecastQ2	 MONEY,
	AnnualNetReforecastQ3	 MONEY,

	--Annual estimated
	AnnualEstGrossBudget     MONEY,
	
	AnnualEstGrossReforecastQ1 MONEY,
	AnnualEstGrossReforecastQ2 MONEY,
	AnnualEstGrossReforecastQ3 MONEY,
	
	AnnualEstNetBudget		 MONEY,
	
	AnnualEstNetReforecastQ1 MONEY,
	AnnualEstNetReforecastQ2 MONEY,
	AnnualEstNetReforecastQ3 MONEY
)

DECLARE @cmdString Varchar(8000)

--Get actual information
SET @cmdString = (SELECT ''
INSERT INTO #TotalComparison
SELECT 	
	gac.AccountSubTypeName,
    gac.TranslationTypeName,
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    c.CalendarPeriod,
    s.SourceName,
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101) as EntryDate,
    ISNULL(pa.[User], '''''''') [User],
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END as Description,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END as AdditionalDescription,
    ISNULL(pa.PropertyFundCode, '''''''') PropertyFundCode,
    ISNULL(pa.OriginatingRegionCode, '''''''') OriginatingRegionCode,
    ISNULL(pa.FunctionalDepartmentCode, '''''''') FunctionalDepartmentCode,
    ga.Code,
	ga.Name,
	
    (
		er.Rate *
		CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- MtdGrossReforecast --------------------------*/ + ''
	
	NULL as MtdGrossReforecastQ1,	
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
    
    '' + /*-- MtdGrossReforecast End --------------------------*/ + ''
    
    (
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as MtdNetActual,    
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
    (
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdGrossActual,    
    NULL as YtdGrossBudget,
    
    '' + /*-- YtdGrossReforecast --------------------------*/ + ''
    
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	  
	(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as YtdNetActual,
	NULL as YtdNetBudget,
   
    '' + /*-- YtdNetReforecast --------------------------*/ + ''
   
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	'')
	
	DECLARE @cmdString2 Varchar(8000)
	SET @cmdString2 = (SELECT ''	
	
	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
    NULL as AnnualGrossBudget,
    
    '' + /*-- AnnualGrossReforecast --------------------------*/ + ''
    
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''

	NULL as AnnualNetBudget,
	
	'' + /*-- AnnualNetReforecast --------------------------*/ + ''
	
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,

	'' + /*-- AnnualNetReforecast End --------------------------*/ + ''

	(
        er.Rate *
        CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
	) as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
    NULL as AnnualEstGrossReforecastQ1,
    NULL as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,
	'')
	
	DECLARE @cmdString3 Varchar(8000)
	SET @cmdString3 = (SELECT ''
	
	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
		
	(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
    '' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3

	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
	
FROM
	ProfitabilityActual pa

	INNER JOIN Overhead oh ON oh.OverheadKey = pa.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccount ga on ga.GlAccountKey = pa.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pa.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pa.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pa.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pa.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pa.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pa.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pa.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pa.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid TranslationTypeName'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
			
    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pa.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pa.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pa.ReimbursableKey ''
		
    + CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pa.ActivityTypeKey)'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationRegionFilterTable t1)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationSubRegionFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''    
'')

IF (LEN(@cmdString) > 7995 OR LEN(@cmdString2) > 7995 OR LEN(@cmdString3) > 7995)
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LTRIM(RTRIM(LEN(@cmdString)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString2)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString3)))))

PRINT @cmdString
PRINT @cmdString2
PRINT @cmdString3

EXEC (@cmdString + @cmdString2 + @cmdString3)

--------------------------------------------------------------------------------------------------------
--Get budget information
SET @cmdString = (Select ''
INSERT INTO #TotalComparison
SELECT 
	gac.AccountSubTypeName,
    gac.TranslationTypeName,
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Code END,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Name END,
	
    NULL as MtdGrossActual,    
    (
		er.Rate *
		CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
    
    NULL as MtdNetActual,
	(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as MtdNetBudget,
    
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
    
    NULL as YtdGrossActual,	
	(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual,	
	(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as YtdNetBudget,
    
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	(
		er.Rate * pb.LocalBudget
	) as AnnualGrossBudget,
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,
	
	(
		er.Rate * r.MultiplicationFactor * pb.LocalBudget
    ) as AnnualNetBudget,
    
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,
	
	(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,
	
    (
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3
    
FROM
	ProfitabilityBudget pb

	INNER JOIN Overhead oh ON oh.OverheadKey = pb.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccount ga on ga.GlAccountKey = pb.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pb.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pb.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pb.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pb.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pb.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pb.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pb.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pb.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid TranslationTypeName'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
	
    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pb.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pb.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pb.ReimbursableKey	''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pb.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pb.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1  
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''

'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

------------------------------------------------------------------------------------------------------------------------------
--Get Q1 reforecast information
SET @cmdString = (Select ''
INSERT INTO #TotalComparison
SELECT 
	gac.AccountSubTypeName,
    gac.TranslationTypeName,
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Code END,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Name END,
	
    NULL as MtdGrossActual,
    NULL as MtdGrossBudget,
    
    '' + /*-- MtdGrossReforecast --------------------------*/ + ''
    
    (
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
    
    '' + /*-- MtdGrossReforecast End --------------------------*/ + ''
    
    NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ1,
    NULL as MtdNetReforecastQ2,
    NULL as MtdNetReforecastQ3,
    
    '' + /*-- MtdNetReforecast End --------------------------*/ + ''
    
    NULL as YtdGrossActual,    
    NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	NULL as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
	(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ1,
    NULL as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,    
   	
   	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
   	
   	NULL as AnnualGrossBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    
    '' + /*-- AnnualGrossReforecast --------------------------*/ + ''
    
    (er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ1,
     NULL as AnnualGrossReforecastQ2,
     NULL as AnnualGrossReforecastQ3,
	
	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualNetBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''    
    '' + /*-- AnnualNetReforecast --------------------------*/ + ''
    
    (er.Rate * r.MultiplicationFactor * pr.LocalReforecast) as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,
    
    '' + /*-- AnnualNetReforecast End --------------------------*/ + ''
    
    NULL as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' +STR(@ReportExpensePeriod,10,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ1,
    NULL as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,
	
	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstNetBudget,
	
	'' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
	
	(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' +STR(@ReportExpensePeriod,10,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ1,
    NULL as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3
    
    '' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
    
FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccount ga on ga.GlAccountKey = pr.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid TranslationTypeName'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
	
    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey	''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1  
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ1,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''

'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

------------------------------------------------------------------------------------------------------------------------------
--Get Q2 reforecast information
SET @cmdString = (Select ''
INSERT INTO #TotalComparison
SELECT 
	gac.AccountSubTypeName,
    gac.TranslationTypeName,
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Code END,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Name END,
	
    NULL as MtdGrossActual,
    NULL as MtdGrossBudget,
    
    '' + /*-- MtdGrossReforecast --------------------------*/ + ''
    
    NULL as MtdGrossReforecastQ1,
    (
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
    
    '' + /*-- MtdGrossReforecast End --------------------------*/ + ''
    
    NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ2,
    NULL as MtdNetReforecastQ3,
    
    '' + /*-- MtdNetReforecast End --------------------------*/ + ''
    
    NULL as YtdGrossActual,    
    NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	NULL as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
	(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,   
   	
   	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
   	
   	NULL as AnnualGrossBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    
    '' + /*-- AnnualGrossReforecast --------------------------*/ + ''
    
    NULL as AnnualGrossReforecastQ1,
    (er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ2,
     NULL as AnnualGrossReforecastQ3,
	
	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualNetBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''    
    '' + /*-- AnnualNetReforecast --------------------------*/ + ''
    
    NULL as AnnualNetReforecastQ1,
    (er.Rate * r.MultiplicationFactor * pr.LocalReforecast) as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,
    
    '' + /*-- AnnualNetReforecast End --------------------------*/ + ''
    
    NULL as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' +STR(@ReportExpensePeriod,10,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,
	
	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstNetBudget,
	
	'' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
	
	NULL as AnnualEstNetReforecastQ1,
	(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' +STR(@ReportExpensePeriod,10,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3
    
    '' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
    
FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccount ga on ga.GlAccountKey = pr.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid TranslationTypeName'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
	
    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey	''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1  
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ2,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''

'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)



------------------------------------------------------------------------------------------------------------------------------
--Get Q2 reforecast information
SET @cmdString = (Select ''
INSERT INTO #TotalComparison
SELECT 
	gac.AccountSubTypeName,
    gac.TranslationTypeName,
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Code END,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN '''''''' ELSE ga.Name END,
	
    NULL as MtdGrossActual,
    NULL as MtdGrossBudget,
    
    '' + /*-- MtdGrossReforecast --------------------------*/ + ''
    
    NULL as MtdGrossReforecastQ1,
    NULL as MtdGrossReforecastQ2,
    (
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ3,
    
    '' + /*-- MtdGrossReforecast End --------------------------*/ + ''
    
    NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ3,
    
    '' + /*-- MtdNetReforecast End --------------------------*/ + ''
    
    NULL as YtdGrossActual,    
    NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ3,
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	NULL as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= ''+STR(@ReportExpensePeriod,10,0)+'') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ3,  
   	
   	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
   	
   	NULL as AnnualGrossBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    
    '' + /*-- AnnualGrossReforecast --------------------------*/ + ''
    
    NULL as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
    (er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ3,
    
	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualNetBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''    
    '' + /*-- AnnualNetReforecast --------------------------*/ + ''
    
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    (er.Rate * r.MultiplicationFactor * pr.LocalReforecast) as AnnualNetReforecastQ3,
    
    '' + /*-- AnnualNetReforecast End --------------------------*/ + ''
    
    NULL as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' +STR(@ReportExpensePeriod,10,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ3,
	
	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstNetBudget,
	
	'' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
	
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' +STR(@ReportExpensePeriod,10,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ3
    
    '' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
    
FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccount ga on ga.GlAccountKey = pr.GlAccountKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid TranslationTypeName'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
	
    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey	''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''

WHERE  1 = 1  
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ3,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''

'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)



------------------------------------------------------------------------------------------------------------------
-- Return results
SELECT
	AccountSubTypeName AS ExpenseType,
	TranslationTypeName AS AccountCategoryMappingName,
    MajorCategoryName AS MajorAccountCategoryName,
	MajorCategoryName AS MajorAccountCategoryFilterName,
    MinorCategoryName AS MinorAccountCategoryName,
    CalendarPeriod AS ExpensePeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
	SourceName AS SourceName,
	PropertyFundCode,
    CASE WHEN (SUBSTRING(SourceName, CHARINDEX('' '', SourceName) +1, 8) = ''Property'') THEN (RTRIM(OriginatingRegionCode) + LTRIM(FunctionalDepartmentCode)) ELSE OriginatingRegionCode END AS OriginatingRegionCode,

    --OriginatingRegionCode,	
    GlAccountCode,
    GlAccountName,
    
	--Month to date
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossActual,0) ELSE ISNULL(MtdNetActual,0) END) AS MtdActual,
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossBudget,0) ELSE ISNULL(MtdNetBudget,0) END) AS MtdOriginalBudget,
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END,0) 
	END) 
	AS MtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END,0) 
	END) 
	AS MtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END,0) 
	END) 
	AS MtdReforecastQ3,		
	-------------------------------
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ2,	
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ3,	
	-------------------------------
	
	-- Year to date
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossActual,0) ELSE ISNULL(YtdNetActual,0) END) AS YtdActual,	
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossBudget,0) ELSE ISNULL(YtdNetBudget,0) END) AS YtdOriginalBudget,
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1
		END,0) 
	END) 
	AS YtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2
		END,0) 
	END) 
	AS YtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3
		END,0) 
	END) 
	AS YtdReforecastQ3,		
	-------------------------------

	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1 
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ1,
	---
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ2,	
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3 
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3 
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ3,	
	-------------------------------
	
	--Annual
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnnualGrossBudget,0) ELSE ISNULL(AnnualNetBudget,0) END) AS AnnualOriginalBudget,
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ1
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ1
		END,0) 
	END) 
	AS AnnualReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ2
		END,0) 
	END) 
	AS AnnualReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ3
		END,0) 
	END) 
	AS AnnualReforecastQ3,
	-------------------------------
	
	--Annual Estimated
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualEstGrossBudget
		ELSE
			AnnualEstGrossReforecastQ1
		END,0)
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualEstNetBudget
		ELSE
			AnnualEstNetReforecastQ1
		END,0)
	END)
	AS AnnualEstimatedActualQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualEstGrossBudget
		ELSE
			AnnualEstGrossReforecastQ2
		END,0)
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualEstNetBudget
		ELSE
			AnnualEstNetReforecastQ2
		END,0)
	END)
	AS AnnualEstimatedActualQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualEstGrossBudget
		ELSE
			AnnualEstGrossReforecastQ3
		END,0)
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualEstNetBudget
		ELSE
			AnnualEstNetReforecastQ3
		END,0)
	END)
	AS AnnualEstimatedActualQ3,		
	-------------------------------
	
	-------------------------------
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(AnnualGrossBudget,0) - ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
												AnnualEstGrossBudget
											ELSE
												AnnualEstGrossReforecastQ1
											END,0)
		ELSE
			ISNULL(AnnualNetBudget,0) - ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
											AnnualEstNetBudget
										ELSE
											AnnualEstNetReforecastQ1
										END,0)
		END)
	AS AnnualEstimatedVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(AnnualGrossBudget,0) - ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
												AnnualEstGrossBudget
											ELSE
												AnnualEstGrossReforecastQ2
											END,0)
		ELSE
			ISNULL(AnnualNetBudget,0) - ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
											AnnualEstNetBudget
										ELSE
											AnnualEstNetReforecastQ2
										END,0)
		END)
	AS AnnualEstimatedVarianceQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(AnnualGrossBudget,0) - ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
												AnnualEstGrossBudget
											ELSE
												AnnualEstGrossReforecastQ3
											END,0)
		ELSE
			ISNULL(AnnualNetBudget,0) - ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
											AnnualEstNetBudget
										ELSE
											AnnualEstNetReforecastQ3
										END,0)
		END)
	AS AnnualEstimatedVarianceQ3		
	-------------------------------
INTO
	#Output
FROM
	#TotalComparison
GROUP BY
	AccountSubTypeName,
	TranslationTypeName,
    MajorCategoryName,
    MinorCategoryName,
    CalendarPeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
    SourceName,
    PropertyFundCode,
    CASE WHEN (SUBSTRING(SourceName, CHARINDEX('' '', SourceName) +1, 8) = ''Property'') THEN RTRIM(OriginatingRegionCode) + LTRIM(FunctionalDepartmentCode) ELSE OriginatingRegionCode END,

    --OriginatingRegionCode,
	GlAccountCode,
    GlAccountName


--Output
SELECT
	ExpenseType,
	AccountCategoryMappingName,
    MajorAccountCategoryName,
	MajorAccountCategoryFilterName,
    MinorAccountCategoryName,
    ExpensePeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
	SourceName,
	PropertyFundCode,
    OriginatingRegionCode,
	GlAccountCode,
	GlAccountName,

	--Month to date
	MtdActual,
	MtdOriginalBudget,
	
	MtdReforecastQ1,
	--MtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ3 END AS MtdReforecastQ3,
	
	MtdVarianceQ1,
	--MtdVarianceQ2,
	--MtdVarianceQ3,
	
	-- Year to date
	YtdActual,	
	YtdOriginalBudget,
	
	YtdReforecastQ1,
	--YtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ3 END AS YtdReforecastQ3,
	
	YtdVarianceQ1,
	--YtdVarianceQ2,
	--YtdVarianceQ3,
	
	--Annual
	AnnualOriginalBudget,
	AnnualReforecastQ1,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ1 END AS AnnualReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ2 END AS AnnualReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ3 END AS AnnualReforecastQ3,
		
	--Annual Estimated
	AnnualEstimatedActualQ1,
	--AnnualEstimatedActualQ2,
	--AnnualEstimatedActualQ3,
	
	AnnualEstimatedVarianceQ1
	--AnnualEstimatedVarianceQ2,
	--AnnualEstimatedVarianceQ3
	
FROM
	#Output
WHERE
	--Month to date
	MtdActual <> 0.00 OR
	MtdOriginalBudget <> 0.00 OR
	
	--MtdReforecastQ1 <> 0.00 OR
	--MtdReforecastQ2 <> 0.00 OR
	--MtdReforecastQ3 <> 0.00 OR
	
	MtdVarianceQ1 <> 0.00 OR
	--MtdVarianceQ2 <> 0.00 OR
	--MtdVarianceQ3 <> 0.00 OR
	
	-- Year to date
	YtdActual <> 0.00 OR
	YtdOriginalBudget <> 0.00 OR
	
	--YtdReforecastQ1 <> 0.00 OR
	--YtdReforecastQ2 <> 0.00 OR
	--YtdReforecastQ3 <> 0.00 OR
	
	YtdVarianceQ1 <> 0.00 OR
	--YtdVarianceQ2 <> 0.00 OR
	--YtdVarianceQ3 <> 0.00 OR
	
	--Annual
	AnnualOriginalBudget <> 0.00 OR
	
	AnnualReforecastQ1 <> 0.00 OR
	--AnnualReforecastQ2 <> 0.00 OR
	--AnnualReforecastQ3 <> 0.00 OR
	
	--Annual Estimated
	AnnualEstimatedActualQ1 <> 0.00 OR
	--AnnualEstimatedActualQ2 <> 0.00 OR
	--AnnualEstimatedActualQ3 <> 0.00 OR
	
	AnnualEstimatedVarianceQ1 <> 0.00 
	--AnnualEstimatedVarianceQ2 <> 0.00 OR
	--AnnualEstimatedVarianceQ3 <> 0.00

IF 	OBJECT_ID(''tempdb..#Output'') IS NOT NULL
    DROP TABLE #Output

IF 	OBJECT_ID(''tempdb..#EntityFilterTable'') IS NOT NULL
	DROP TABLE #EntityFilterTable
	
IF 	OBJECT_ID(''tempdb..#FunctionalDepartmentFilterTable'') IS NOT NULL	
	DROP TABLE #FunctionalDepartmentFilterTable
	
IF 	OBJECT_ID(''tempdb..#ActivityTypeFilterTable'') IS NOT NULL
	DROP TABLE #ActivityTypeFilterTable
	
IF 	OBJECT_ID(''tempdb..#AllocationRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#AllocationSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationSubRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#MajorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MajorAccountCategoryFilterTable
	
IF 	OBJECT_ID(''tempdb..#MinorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MinorAccountCategoryFilterTable
	
IF 	OBJECT_ID(''tempdb..#OriginatingRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#OriginatingSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingSubRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#CategoryActivityGroupFilterTable'') IS NOT NULL
	DROP TABLE #CategoryActivityGroupFilterTable


' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ExpenseCzar]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ExpenseCzar]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[stp_R_ExpenseCzar]
	@ReportExpensePeriod INT = NULL,
	@ReforecastQuaterName VARCHAR(10) = NULL, --''Q1'' or ''Q2'' or ''Q3''
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = ''Global'',
	@IsGross bit = 1,
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@CategoryActivityGroups dbo.CategoryActivityGroup READONLY,
	@OverheadCode Varchar(10)=''UNALLOC''
AS

/*
DECLARE @ReportExpensePeriod	AS INT,
	@AccountCategoryList	AS TEXT,
	@DestinationCurrency	AS VARCHAR(3),
	@TranslationTypeName	VARCHAR(50)
	
	SET @ReportExpensePeriod = 201011
	SET @AccountCategoryList = ''IT Costs & Telecommunications|Legal & Professional Fees|Marketing''
	SET @DestinationCurrency =''USD''
	SET @TranslationTypeName = ''Global''
	
EXEC stp_R_ExpenseCzar
	@ReportExpensePeriod = 201011,
	@TranslationTypeName = ''Global'',
	@DestinationCurrency = ''USD'',

	@FunctionalDepartmentList = ''Information Technologies'',
	@AllocationRegionList = ''CHICAGO'',
	@EntityList = ''Aldgate|Centrium (St Cathrine House/Pegasus)''
*/

DECLARE
	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_ReforecastQuaterName VARCHAR(10) = @ReforecastQuaterName,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_TranslationTypeName VARCHAR(50) = @TranslationTypeName,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList

IF LEN(@_FunctionalDepartmentList) > 7998 OR
	LEN(@_ActivityTypeList) > 7998 OR
	LEN(@_EntityList) > 7998 OR
	LEN(@_MajorAccountCategoryList) > 7998 OR
	LEN(@_MinorAccountCategoryList) > 7998 OR
	LEN(@_AllocationRegionList) > 7998 OR
	LEN(@_AllocationSubRegionList) > 7998 OR
	LEN(@_OriginatingRegionList) > 7998 OR
	LEN(@_OriginatingSubRegionList) > 7998
BEGIN
	RAISERROR(''Filter List parameter is too big'',9,1)
END

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + CAST(MONTH(GETDATE()) AS VARCHAR(2))AS INT)

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@TranslationTypeName IS NULL
	SET @TranslationTypeName = ''Global''

	DECLARE @CalendarYear AS INT
	SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)		

--------------------------------------------------------------------------

-- Determine the ReforecastKey of the reforecast that is currently active (i.e.: 2011 Q1, 2011 Q2, 2012 Q0 etc)
DECLARE @ActiveReforecastKey INT = (SELECT ReforecastKey FROM dbo.GetCurrentReforecastRecord())

IF (@ActiveReforecastKey IS NULL) -- Safeguard against NULL ReforecastKey returned from previous statement
BEGIN
	SET @ActiveReforecastKey = (SELECT MAX(ReforecastKey) FROM dbo.ExchangeRate)
	PRINT (''Near disaster: @ActiveReforecastKey is NULL, so reverting to the largest/most recent ReforecastKey in dbo.ExchangeRate: '' + @ActiveReforecastKey)
END

--------------------------------------------------------------------------

-- let latest reforecast (it will be zero if there is no data for the reforecast)
IF @ReforecastQuaterName IS NULL OR @ReforecastQuaterName NOT IN (''Q0'', ''Q1'', ''Q2'', ''Q3'')
	SET @ReforecastQuaterName = (SELECT TOP 1 ReforecastQuarterName 
									FROM dbo.Reforecast 
									WHERE ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
										  ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
									ORDER BY ReforecastEffectivePeriod DESC)

-- Compute Reforecast Effective Periods

DECLARE @ReforecastEffectivePeriodQ1 INT
DECLARE @ReforecastEffectivePeriodQ2 INT
DECLARE @ReforecastEffectivePeriodQ3 INT

SET @ReforecastEffectivePeriodQ1 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q1''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ2 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q2''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ3 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q3''
									ORDER BY
										ReforecastEffectivePeriod)

-- Retrieve Reforecast Quarter Name

DECLARE @ReforecastQuarterNameQ1 CHAR(2)
DECLARE @ReforecastQuarterNameQ2 CHAR(2)
DECLARE @ReforecastQuarterNameQ3 CHAR(2)

IF (@ReforecastEffectivePeriodQ1 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ1 = (SELECT TOP 1
										ReforecastQuarterName 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ1)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ1 is NULL - cannot determine Q1 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ2 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ2 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ2)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ2 is NULL - cannot determine Q2 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ3 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ3 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ3)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ3 is NULL - cannot determine Q3 reforecast quarter name.'')
END

--------------------------------------------------------------------------
/*	Determine Report Exchange Rates	*/
--------------------------------------------------------------------------

SELECT
	SourceCurrencyKey,
	DestinationCurrencyKey,
	CalendarKey,
	Rate
INTO
	#ExchangeRate
FROM
	dbo.ExchangeRate
WHERE
	ReforecastKey = @ActiveReforecastKey -- We will use the exchange rate set that is active for the current reforecast.


--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
CREATE TABLE #EntityFilterTable	(PropertyFundKey Int NOT NULL)
CREATE TABLE #FunctionalDepartmentFilterTable (FunctionalDepartmentKey Int NOT NULL)
CREATE TABLE #ActivityTypeFilterTable (ActivityTypeKey Int NOT NULL)
CREATE TABLE #AllocationRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #AllocationSubRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #MajorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #MinorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #OriginatingRegionFilterTable (OriginatingRegionKey Int NOT NULL)
CREATE TABLE #OriginatingSubRegionFilterTable (OriginatingRegionKey Int NOT NULL)	
CREATE TABLE #CategoryActivityGroupFilterTable (GlAccountCategoryKey Int NOT NULL, ActivityTypeKey Int NULL)	
	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable (PropertyFundKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable	(FunctionalDepartmentKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable (ActivityTypeKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable (AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable (GlAccountCategoryKey)	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable (GlAccountCategoryKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable (OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable (OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #CategoryActivityGroupFilterTable (GlAccountCategoryKey, ActivityTypeKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END		
	
IF EXISTS(SELECT * FROM @CategoryActivityGroups)
	BEGIN
	Insert Into #CategoryActivityGroupFilterTable
	Select gl.GlAccountCategoryKey, at.ActivityTypeKey 
	From @CategoryActivityGroups cag
		CROSS APPLY dbo.Split(cag.MinorAccountCategoryList) t1
		OUTER APPLY dbo.Split(cag.ActivityTypeList) t2
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item 
		LEFT OUTER JOIN ActivityType at ON at.ActivityTypeName = t2.item
	END
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------
		
IF 	OBJECT_ID(''tempdb..#ExpenseCzar'') IS NOT NULL
    DROP TABLE #ExpenseCzar
		
CREATE TABLE #ExpenseCzar
(	
	GlAccountCategoryKey		Int,
	AllocationRegionKey			Int,
	FunctionalDepartmentKey		Int,	
	PropertyFundKey				Int,
	CalendarPeriod				INT,
	SourceName					VarChar(50),
	EntryDate					VARCHAR(10),
	[User]						NVARCHAR(20),
	[Description]				NVARCHAR(60),
	AdditionalDescription		NVARCHAR(4000),
	PropertyFundCode			Varchar(6) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	OriginatingRegionCode		Varchar(30) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	FunctionalDepartmentCode	Varchar(15) DEFAULT(''''),
	GlAccountKey				Int  NULL,
	
	--Month to date	
	MtdGrossActual				MONEY,
	MtdGrossBudget				MONEY,
	
	MtdGrossReforecastQ1		MONEY,
	MtdGrossReforecastQ2		MONEY,
	MtdGrossReforecastQ3		MONEY,
	
	MtdNetActual				MONEY,
	MtdNetBudget				MONEY,
	
	MtdNetReforecastQ1			MONEY,
	MtdNetReforecastQ2			MONEY,
	MtdNetReforecastQ3			MONEY,
	
	--Year to date
	YtdGrossActual				MONEY,	
	YtdGrossBudget				MONEY,
	 
	YtdGrossReforecastQ1		MONEY,
	YtdGrossReforecastQ2		MONEY,
	YtdGrossReforecastQ3		MONEY,
	
	YtdNetActual				MONEY, 
	YtdNetBudget				MONEY, 
	
	YtdNetReforecastQ1			MONEY,
	YtdNetReforecastQ2			MONEY,
	YtdNetReforecastQ3			MONEY,

	--Annual	
	AnnualGrossBudget			MONEY,
	
	AnnualGrossReforecastQ1		MONEY,
	AnnualGrossReforecastQ2		MONEY,
	AnnualGrossReforecastQ3		MONEY,
	
	AnnualNetBudget				MONEY,
	
	AnnualNetReforecastQ1		MONEY,
	AnnualNetReforecastQ2		MONEY,
	AnnualNetReforecastQ3		MONEY,
	
	--Annual estimated
	AnnualEstGrossBudget		MONEY,
	
	AnnualEstGrossReforecastQ1	MONEY,
	AnnualEstGrossReforecastQ2	MONEY,
	AnnualEstGrossReforecastQ3	MONEY,
	
	AnnualEstNetBudget			MONEY,
	
	AnnualEstNetReforecastQ1	MONEY,
	AnnualEstNetReforecastQ2	MONEY,
	AnnualEstNetReforecastQ3	MONEY
)

DECLARE @cmdString VARCHAR(8000)

--Get actual information
SET @cmdString = (SELECT ''

INSERT INTO #ExpenseCzar
SELECT 
	gac.GlAccountCategoryKey,
	pa.AllocationRegionKey,
    pa.FunctionalDepartmentKey,    
    pa.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101) as EntryDate,
    ISNULL(pa.[User], '''''''') [User],
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END as Description,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END as AdditionalDescription,
    ISNULL(pa.PropertyFundCode, '''''''') PropertyFundCode,
    ISNULL(pa.OriginatingRegionCode, '''''''') OriginatingRegionCode,
    ISNULL(pa.FunctionalDepartmentCode, '''''''') FunctionalDepartmentCode,
    pa.GlAccountKey,
    
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- MtdGrossReforecast --------------------------*/ + ''
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	'' + /*-- MtdGrossReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'')
	
	DECLARE @cmdString2 VARCHAR(8000)
	SET @cmdString2 = (SELECT ''
	
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,

	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualGrossBudget,
	
	'' + /*-- AnnualGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''

	NULL as AnnualNetBudget,
	
	'' + /*-- AnnualNetReforecast --------------------------*/ + ''
	
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,
	
	'' + /*-- AnnualNetReforecast End --------------------------*/ + ''
		
	SUM(
        er.Rate *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
	) as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	'')
	
	DECLARE @cmdString3 VARCHAR(8000)
	SET @cmdString3 = (SELECT ''


	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''

    SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
    '' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3
	
	'' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
FROM
	ProfitabilityActual pa

	INNER JOIN Overhead oh ON oh.OverheadKey = pa.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pa.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pa.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pa.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pa.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pa.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pa.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pa.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pa.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
	INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
	INNER JOIN Calendar c ON  c.CalendarKey = pa.CalendarKey
	INNER JOIN Source s ON s.SourceKey = pa.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pa.ReimbursableKey ''
    			    
    + CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pa.ActivityTypeKey)'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationRegionFilterTable t1)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationSubRegionFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''	
GROUP BY
	gac.GlAccountCategoryKey,
	pa.AllocationRegionKey,
	pa.FunctionalDepartmentKey,		
	pa.PropertyFundKey,
	c.CalendarPeriod,
	s.SourceName,
	CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101),
	ISNULL(pa.[User], '''''''') ,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END,
	ISNULL(pa.PropertyFundCode, ''''''''),
	ISNULL(pa.OriginatingRegionCode, ''''''''),
	ISNULL(pa.FunctionalDepartmentCode, ''''''''),
	pa.GlAccountKey
'')

IF (LEN(@cmdString) > 7995 OR LEN(@cmdString2) > 7995 OR LEN(@cmdString3) > 7995)
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LTRIM(RTRIM(LEN(@cmdString)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString2)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString3)))))

PRINT @cmdString
PRINT @cmdString2
PRINT @cmdString3

EXEC (@cmdString + @cmdString2 + @cmdString3)

-- Get budget information
SET @cmdString = (Select ''
INSERT INTO #ExpenseCzar
SELECT 
	gac.GlAccountCategoryKey,
	pb.AllocationRegionKey,
	pb.FunctionalDepartmentKey,	
	pb.PropertyFundKey,
	c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END,
    
   NULL as MtdGrossActual,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as MtdGrossBudget,	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as MtdNetBudget,
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as YtdGrossBudget, 
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as YtdNetBudget, 
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	SUM(er.Rate * pb.LocalBudget) as AnnualGrossBudget,
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,
	

	SUM(er.Rate * r.MultiplicationFactor * pb.LocalBudget) as AnnualNetBudget,
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as AnnualEstGrossBudget,
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3
FROM
	ProfitabilityBudget pb

	INNER JOIN Overhead oh ON oh.OverheadKey = pb.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    
    	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pb.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pb.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pb.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pb.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pb.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pb.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pb.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pb.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pb.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pb.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pb.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pb.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pb.ActivityTypeKey)'' ELSE '''' END + ''
		
WHERE  1 = 1 
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''    
GROUP BY
	gac.GlAccountCategoryKey,
	pb.AllocationRegionKey,
	pb.FunctionalDepartmentKey,
	pb.PropertyFundKey,
	c.CalendarPeriod,
	s.SourceName,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

----------------------------------------------------------------------------------------------------------------------------------
-- Get Q1 reforecast information
SET @cmdString = (SELECT ''
INSERT INTO #ExpenseCzar
SELECT 
	gac.GlAccountCategoryKey,
	pr.AllocationRegionKey,
	pr.FunctionalDepartmentKey,	
	pr.PropertyFundKey,
	c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget, 
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget, 
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ1,
    NULL as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast) as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ1,
    NULL as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE
			0
        END
    ) as AnnualEstNetReforecastQ1,
    NULL as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3
    
FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    
    	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ1,10,0) + ''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''    
GROUP BY
	gac.GlAccountCategoryKey,
	pr.AllocationRegionKey,
	pr.FunctionalDepartmentKey,			
	pr.PropertyFundKey,
	c.CalendarPeriod,
	s.SourceName,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

----------------------------------------------------------------------------------------------------------------------------------
-- Get Q2 reforecast information
SET @cmdString = (SELECT ''
INSERT INTO #ExpenseCzar
SELECT 
	gac.GlAccountCategoryKey,
	pr.AllocationRegionKey,
	pr.FunctionalDepartmentKey,	
	pr.PropertyFundKey,
	c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	NULL as MtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	
	NULL as YtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualGrossReforecastQ1,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualNetReforecastQ1,
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast) as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	NULL as AnnualEstNetReforecastQ1,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE
			0
        END
    ) as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3
    
FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    
    	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ2,10,0) + ''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''    
GROUP BY
	gac.GlAccountCategoryKey,
	pr.AllocationRegionKey,
	pr.FunctionalDepartmentKey,			
	pr.PropertyFundKey,
	c.CalendarPeriod,
	s.SourceName,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)



----------------------------------------------------------------------------------------------------------------------------------
-- Get Q3 reforecast information
SET @cmdString = (SELECT ''
INSERT INTO #ExpenseCzar
SELECT 
	gac.GlAccountCategoryKey,
	pr.AllocationRegionKey,
	pr.FunctionalDepartmentKey,	
	pr.PropertyFundKey,
	c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,    
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast) as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE
			0
        END
    ) as AnnualEstNetReforecastQ3
    
FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    
    	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + 
	+ CASE WHEN EXISTS(SELECT * FROM @CategoryActivityGroups) THEN '' INNER JOIN #CategoryActivityGroupFilterTable cag ON cag.GlAccountCategoryKey = gac.GlAccountCategoryKey AND (cag.ActivityTypeKey IS NULL OR cag.ActivityTypeKey = pr.ActivityTypeKey)'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ3,10,0) + ''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''    
GROUP BY
	gac.GlAccountCategoryKey,
	pr.AllocationRegionKey,
	pr.FunctionalDepartmentKey,			
	pr.PropertyFundKey,
	c.CalendarPeriod,
	s.SourceName,
	CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

---------------------------------------------------------------------------------------------------
SELECT 
	gac.AccountSubTypeName AS ExpenseType,
	ar.RegionName AS AllocationRegionName,
    fd.FunctionalDepartmentName AS FunctionalDepartmentName,    
    gac.MajorCategoryName AS MajorExpenseCategoryName,
    gac.MinorCategoryName AS MinorExpenseCategoryName,
    pf.PropertyFundName AS EntityName,
    res.CalendarPeriod AS ExpensePeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
    res.SourceName AS SourceName,
    res.PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, (CHARINDEX('' '', res.SourceName) + 1), 8) = ''Property'') THEN (RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode)) ELSE res.OriginatingRegionCode END AS OriginatingRegionCode,
    --res.OriginatingRegionCode,
	ISNULL(ga.Code, '''') GlAccountCode,
    ISNULL(ga.Name, '''') GlAccountName,

	--Gross
	--Month to date    
	SUM(ISNULL(MtdGrossActual,0)) AS MtdGrossActual,
	SUM(ISNULL(MtdGrossBudget,0)) AS MtdGrossOriginalBudget,
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1 
	END,0)) AS MtdGrossReforecastQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2 
	END,0)) AS MtdGrossReforecastQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3 
	END,0)) AS MtdGrossReforecastQ3,		
	-----
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1 
	END, 0) - ISNULL(MtdGrossActual, 0)) 
	AS MtdGrossVarianceQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2 
	END, 0) - ISNULL(MtdGrossActual, 0)) 
	AS MtdGrossVarianceQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3 
	END, 0) - ISNULL(MtdGrossActual, 0)) 
	AS MtdGrossVarianceQ3,			
	-----
		
	--Year to date
	SUM(ISNULL(YtdGrossActual,0)) AS YtdGrossActual,	
	SUM(ISNULL(YtdGrossBudget,0)) AS YtdGrossOriginalBudget,
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1 
	END,0)) AS YtdGrossReforecastQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2 
	END,0)) AS YtdGrossReforecastQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3 
	END,0)) AS YtdGrossReforecastQ3,			
	-----
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1
		END, 0) - ISNULL(YtdGrossActual, 0)) 
	AS YtdGrossVarianceQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2
		END, 0) - ISNULL(YtdGrossActual, 0)) 
	AS YtdGrossVarianceQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3
		END, 0) - ISNULL(YtdGrossActual, 0)) 
	AS YtdGrossVarianceQ3,
	-----
	--Annual
	SUM(ISNULL(AnnualGrossBudget,0)) AS AnnualGrossOriginalBudget,	
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ1 
		END,0)) 
	AS AnnualGrossReforecastQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ2 
		END,0)) 
	AS AnnualGrossReforecastQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ3 
		END,0)) 
	AS AnnualGrossReforecastQ3,		
	-----

	--Net
	--Month to date    
	SUM(ISNULL(MtdNetActual,0)) AS MtdNetActual,
	SUM(ISNULL(MtdNetBudget,0)) AS MtdNetOriginalBudget,
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END,0)) 
	AS MtdNetReforecastQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END,0)) 
	AS MtdNetReforecastQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END,0)) 
	AS MtdNetReforecastQ3,	
	-----
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END, 0) - ISNULL(MtdNetActual, 0)) 
	AS MtdNetVarianceQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END, 0) - ISNULL(MtdNetActual, 0)) 
	AS MtdNetVarianceQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END, 0) - ISNULL(MtdNetActual, 0)) 
	AS MtdNetVarianceQ3,	
	-----
		
	--Year to date
	SUM(ISNULL(YtdNetActual,0)) AS YtdNetActual,	
	SUM(ISNULL(YtdNetBudget,0)) AS YtdNetOriginalBudget,
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1
		END,0)) 
	AS YtdNetReforecastQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2
		END,0)) 
	AS YtdNetReforecastQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3
		END,0)) 
	AS YtdNetReforecastQ3,
	-----
	
	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1
		END, 0) - ISNULL(YtdNetActual, 0)) 
	AS YtdNetVarianceQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2
		END, 0) - ISNULL(YtdNetActual, 0)) 
	AS YtdNetVarianceQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3
		END, 0) - ISNULL(YtdNetActual, 0)) 
	AS YtdNetVarianceQ3,
	-----
	
	--Annual
	SUM(ISNULL(AnnualNetBudget,0)) AS AnnualNetOriginalBudget,	

	-----
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ1
		END,0)) 
	AS AnnualNetReforecastQ1,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ2
		END,0)) 
	AS AnnualNetReforecastQ2,
	--
	SUM(ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ3
		END,0)) 
	AS AnnualNetReforecastQ3
	-----
INTO
	#Output
FROM
	#ExpenseCzar res
		INNER JOIN PropertyFund pf ON pf.PropertyFundKey = res.PropertyFundKey		
		INNER JOIN AllocationRegion ar ON ar.AllocationRegionKey = res.AllocationRegionKey
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentKey = res.FunctionalDepartmentKey
		INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = res.GlAccountCategoryKey 
		LEFT OUTER JOIN GlAccount ga ON ga.GlAccountKey = res.GlAccountKey 
GROUP BY
	gac.AccountSubTypeName,
	ar.RegionName,
    fd.FunctionalDepartmentName,    
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    pf.PropertyFundName,
    res.CalendarPeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
    res.SourceName,
    res.PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, (CHARINDEX('' '', res.SourceName) + 1), 8) = ''Property'') THEN (RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode)) ELSE res.OriginatingRegionCode END,
    --res.OriginatingRegionCode,
    
    ISNULL(ga.Code, ''''),
    ISNULL(ga.Name, '''')

--Output
SELECT
	ExpenseType,
	AllocationRegionName,
    FunctionalDepartmentName,    
    MajorExpenseCategoryName,
    MinorExpenseCategoryName,
    EntityName,
    ExpensePeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
    SourceName,
    PropertyFundCode,
    OriginatingRegionCode,
    GlAccountCode,
    GlAccountName,
    
	--Gross
	--Month to date    
	MtdGrossActual,
	MtdGrossOriginalBudget,

	MtdGrossReforecastQ1,
	--MtdGrossReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdGrossReforecastQ3 END AS MtdGrossReforecastQ3,
	
	MtdGrossVarianceQ1,
	--MtdGrossVarianceQ2,
	--MtdGrossVarianceQ3,
		
	--Year to date
	YtdGrossActual,	
	YtdGrossOriginalBudget,

	YtdGrossReforecastQ1,
	--YtdGrossReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdGrossReforecastQ3 END AS YtdGrossReforecastQ3,
	
	YtdGrossVarianceQ1,
	--YtdGrossVarianceQ2,
	--YtdGrossVarianceQ3,

	--Annual
	AnnualGrossOriginalBudget,
	
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualGrossReforecastQ1 END AS AnnualGrossReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualGrossReforecastQ2 END AS AnnualGrossReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualGrossReforecastQ3 END AS AnnualGrossReforecastQ3,

	--Annual Estimated
	--AnnualGrossEstimatedActual,
	--AnnualGrossEstimatedVariance,

	--Net
	--Month to date    
	MtdNetActual,
	MtdNetOriginalBudget,
	
	MtdNetReforecastQ1,
	--MtdNetReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdNetReforecastQ3 END AS MtdNetReforecastQ3,
	
	MtdNetVarianceQ1,
	--MtdNetVarianceQ2,
	--MtdNetVarianceQ3,

	--Year to date
	YtdNetActual,	
	YtdNetOriginalBudget,
	
	YtdNetReforecastQ1,
	--YtdNetReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdNetReforecastQ3 END AS YtdNetReforecastQ3,
	
	YtdNetVarianceQ1,
	--YtdNetVarianceQ2,
	--YtdNetVarianceQ3,

	--Annual
	AnnualNetOriginalBudget,	
	AnnualNetReforecastQ1,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualNetReforecastQ1 END AS AnnualNetReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualNetReforecastQ2 END AS AnnualNetReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualNetReforecastQ3 END AS AnnualNetReforecastQ3

	--Annual Estimated
	--AnnualNetEstimatedActual,	
	--AnnualNetEstimatedVariance
FROM
	#Output
WHERE
	--Gross
	--Month to date    
	MtdGrossActual <> 0.00 OR
	MtdGrossOriginalBudget <> 0.00 OR

	MtdGrossReforecastQ1 <> 0.00 OR
	--MtdGrossReforecastQ2 <> 0.00 OR
	--MtdGrossReforecastQ3 <> 0.00 OR
	
	MtdGrossVarianceQ1 <> 0.00 OR
	--MtdGrossVarianceQ2 <> 0.00 OR
	--MtdGrossVarianceQ3 <> 0.00 OR
		
	--Year to date
	YtdGrossActual <> 0.00 OR
	YtdGrossOriginalBudget <> 0.00 OR

	YtdGrossReforecastQ1 <> 0.00 OR
	--YtdGrossReforecastQ2 <> 0.00 OR
	--YtdGrossReforecastQ3 <> 0.00 OR
	
	YtdGrossVarianceQ1 <> 0.00 OR
	--YtdGrossVarianceQ2 <> 0.00 OR
	--YtdGrossVarianceQ3 <> 0.00 OR

	--Annual
	AnnualGrossOriginalBudget <> 0.00 OR
	
	AnnualGrossReforecastQ1 <> 0.00 OR
	--AnnualGrossReforecastQ2 <> 0.00 OR
	--AnnualGrossReforecastQ3 <> 0.00 OR
	
	--Annual Estimated
	--AnnualGrossEstimatedActual <> 0.00 OR
	--AnnualGrossEstimatedVariance <> 0.00 OR

	--Net
	--Month to date
	MtdNetActual <> 0.00 OR
	MtdNetOriginalBudget <> 0.00 OR
	
	MtdNetReforecastQ1 <> 0.00 OR
	--MtdNetReforecastQ2 <> 0.00 OR
	--MtdNetReforecastQ3 <> 0.00 OR
	
	MtdNetVarianceQ1 <> 0.00 OR
	--MtdNetVarianceQ2 <> 0.00 OR
	--MtdNetVarianceQ3 <> 0.00 OR

	--Year to date
	YtdNetActual <> 0.00 OR
	YtdNetOriginalBudget <> 0.00 OR
	
	YtdNetReforecastQ1 <> 0.00 OR
	--YtdNetReforecastQ2 <> 0.00 OR
	--YtdNetReforecastQ3 <> 0.00 OR
	
	YtdNetVarianceQ1 <> 0.00 OR
	--YtdNetVarianceQ2 <> 0.00 OR
	--YtdNetVarianceQ3 <> 0.00 OR

	--Annual
	AnnualNetOriginalBudget <> 0.00 OR
	
	AnnualNetReforecastQ1 <> 0.00
	--AnnualNetReforecastQ2 <> 0.00 OR
	--AnnualNetReforecastQ3 <> 0.00

IF 	OBJECT_ID(''tempdb..#AccountCategoryFilterTable'') IS NOT NULL
    DROP TABLE #AccountCategoryFilterTable
    
IF 	OBJECT_ID(''tempdb..#ActivityTypeFilterTable'') IS NOT NULL
    DROP TABLE #ActivityTypeFilterTable
    
IF 	OBJECT_ID(''tempdb..#MinorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MinorAccountCategoryFilterTable

IF 	OBJECT_ID(''tempdb..#CategoryActivityGroupFilterTable'') IS NOT NULL
	DROP TABLE #CategoryActivityGroupFilterTable

IF 	OBJECT_ID(''tempdb..#ExpenseCzar'') IS NOT NULL
    DROP TABLE #ExpenseCzar
    
IF 	OBJECT_ID(''tempdb..#Output'') IS NOT NULL
	DROP TABLE #Output

IF 	OBJECT_ID(''tempdb..#EntityFilterTable'') IS NOT NULL
	DROP TABLE #EntityFilterTable

IF 	OBJECT_ID(''tempdb..#FunctionalDepartmentFilterTable'') IS NOT NULL
	DROP TABLE #FunctionalDepartmentFilterTable

IF 	OBJECT_ID(''tempdb..#AllocationRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationRegionFilterTable

IF 	OBJECT_ID(''tempdb..#AllocationSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationSubRegionFilterTable

IF 	OBJECT_ID(''tempdb..#MajorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MajorAccountCategoryFilterTable

IF 	OBJECT_ID(''tempdb..#OriginatingRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingRegionFilterTable

IF 	OBJECT_ID(''tempdb..#OriginatingSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingSubRegionFilterTable


' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_BudgetOwner]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_BudgetOwner]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'


CREATE PROCEDURE [dbo].[stp_R_BudgetOwner]
	@ReportExpensePeriod INT = NULL,
	@ReforecastQuaterName VARCHAR(10) = NULL, --''Q1'' or ''Q2'' or ''Q3''
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = ''Global'',
	@IsGross bit = 1,
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@OverheadCode Varchar(10)=''ALLOC''
AS

/*
DECLARE @ReportExpensePeriod		AS INT,
        @DestinationCurrency		AS VARCHAR(3),
        @TranslationTypeName				VARCHAR(50)
				
SET @ReportExpensePeriod = 201011
SET @DestinationCurrency = ''USD''
SET @EntityList = ''Aldgate|Centrium (St Cathrine House/Pegasus)''
SET @TranslationTypeName = ''Global''

EXEC stp_R_BudgetOriginatorOwnerEntity
	@ReportExpensePeriod = 201011,
	@TranslationTypeName = ''Global'',
	@DestinationCurrency = ''USD'',

	@FunctionalDepartmentList = ''Information Technologies'',
	@AllocationRegionList = ''CHICAGO'',
	@EntityList = ''Aldgate|Centrium (St Cathrine House/Pegasus)''
*/
DECLARE

	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_ReforecastQuaterName VARCHAR(10) = @ReforecastQuaterName,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_TranslationTypeName VARCHAR(50) = @TranslationTypeName,
	@_IsGross bit = @IsGross,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList

IF LEN(@_FunctionalDepartmentList) > 7998 OR
	LEN(@_ActivityTypeList) > 7998 OR
	LEN(@_EntityList) > 7998 OR
	LEN(@_MajorAccountCategoryList) > 7998 OR
	LEN(@_MinorAccountCategoryList) > 7998 OR
	LEN(@_AllocationRegionList) > 7998 OR
	LEN(@_AllocationSubRegionList) > 7998 OR
	LEN(@_OriginatingRegionList) > 7998 OR
	LEN(@_OriginatingSubRegionList) > 7998
BEGIN
	RAISERROR(''Filter List parameter is too big'',9,1)
END

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + REPLACE(STR(MONTH(GETDATE()),2 ),'' '',''0'')AS INT)

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@TranslationTypeName IS NULL
	SET @TranslationTypeName = ''Global''

--------------------------------------------------------------------------

-- Determine the ReforecastKey of the reforecast that is currently active (i.e.: 2011 Q1, 2011 Q2, 2012 Q0 etc)
DECLARE @ActiveReforecastKey INT = (SELECT ReforecastKey FROM dbo.GetCurrentReforecastRecord())

IF (@ActiveReforecastKey IS NULL) -- Safeguard against NULL ReforecastKey returned from previous statement
BEGIN
	SET @ActiveReforecastKey = (SELECT MAX(ReforecastKey) FROM dbo.ExchangeRate)
	PRINT (''Near disaster: @ActiveReforecastKey is NULL, so reverting to the largest/most recent ReforecastKey in dbo.ExchangeRate: '' + @ActiveReforecastKey)
END

--------------------------------------------------------------------------

DECLARE @CalendarYear AS INT
SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)

--------------------------------------------------------------------------
IF @ReforecastQuaterName IS NULL OR @ReforecastQuaterName NOT IN (''Q0'', ''Q1'', ''Q2'', ''Q3'')
	SET @ReforecastQuaterName = (SELECT TOP 1
									ReforecastQuarterName 
								 FROM
									dbo.Reforecast 
								 WHERE
									ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
									ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
								 ORDER BY ReforecastEffectivePeriod DESC)
-- Compute Reforecast Effective Periods

DECLARE @ReforecastEffectivePeriodQ1 INT
DECLARE @ReforecastEffectivePeriodQ2 INT
DECLARE @ReforecastEffectivePeriodQ3 INT

SET @ReforecastEffectivePeriodQ1 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q1''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ2 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q2''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ3 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q3''
									ORDER BY
										ReforecastEffectivePeriod)

-- Retrieve Reforecast Quarter Name

DECLARE @ReforecastQuarterNameQ1 CHAR(2)
DECLARE @ReforecastQuarterNameQ2 CHAR(2)
DECLARE @ReforecastQuarterNameQ3 CHAR(2)

IF (@ReforecastEffectivePeriodQ1 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ1 = (SELECT TOP 1
										ReforecastQuarterName 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ1)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ1 is NULL - cannot determine Q1 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ2 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ2 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ2)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ2 is NULL - cannot determine Q2 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ3 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ3 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ3)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ3 is NULL - cannot determine Q3 reforecast quarter name.'')
END

--------------------------------------------------------------------------
/*	Determine Report Exchange Rates	*/
--------------------------------------------------------------------------

SELECT
	SourceCurrencyKey,
	DestinationCurrencyKey,
	CalendarKey,
	Rate
INTO
	#ExchangeRate
FROM
	dbo.ExchangeRate
WHERE
	ReforecastKey = @ActiveReforecastKey -- We will use the exchange rate set that is active for the current reforecast.

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
CREATE TABLE #EntityFilterTable	(PropertyFundKey Int NOT NULL)
CREATE TABLE #FunctionalDepartmentFilterTable (FunctionalDepartmentKey Int NOT NULL)
CREATE TABLE #ActivityTypeFilterTable (ActivityTypeKey Int NOT NULL)
CREATE TABLE #AllocationRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #AllocationSubRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #MajorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #MinorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #OriginatingRegionFilterTable (OriginatingRegionKey Int NOT NULL)
CREATE TABLE #OriginatingSubRegionFilterTable (OriginatingRegionKey Int NOT NULL)	
	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable	(PropertyFundKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable	(FunctionalDepartmentKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable(ActivityTypeKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable(GlAccountCategoryKey)	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable(GlAccountCategoryKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable	(OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable	(OriginatingRegionKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END		
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------
	
	--------------------------------------------------------------------------
/*    SETUP DIRECT/INDIRECT MAPPING DATA            */
--------------------------------------------------------------------------

-- Change Control 14. CC Ref 5.4 Create Direct or Indirect field and map Direct to all the properties, and Indirect to all the Corporates
IF  OBJECT_ID(''tempdb..#DirectIndirectMappings'') IS NOT NULL
		DROP TABLE #DirectIndirectMappings
	
CREATE TABLE #DirectIndirectMappings
	(
      SourceName varchar(50) PRIMARY KEY ,
      DirectIndirect varchar (10),
	)
	
INSERT INTO #DirectIndirectMappings
	SELECT SourceName, ''Direct'' AS DirectIndirect FROM Source WHERE IsProperty = ''YES''
	UNION
	SELECT SourceName, ''Indirect'' AS DirectIndirect FROM Source WHERE IsCorporate = ''YES''
	UNION
	SELECT SourceName, ''-'' AS DirectIndirect FROM Source WHERE IsCorporate = ''NO'' AND IsProperty = ''NO''

--------------------------------------------------------------------------
/*    END SETUP DIRECT/INDIRECT MAPPING DATA        */
--------------------------------------------------------------------------

	
--------------------------------------------------------------------------
/*    SETUP LOCAL/NON-LOCAL MAPPING DATA            */
--------------------------------------------------------------------------

-- Change Control 14. CC Ref 4.1 Create Direct or Indirect field and map Direct to all the properties, and Indirect to all the Corporates
IF  OBJECT_ID(''tempdb..#LocalNonLocalMappings'') IS NOT NULL
		DROP TABLE #LocalNonLocalMappings
	
CREATE TABLE #LocalNonLocalMapping
	(
      OriginatingRegionName varchar (50),
      OriginatingSubRegionName varchar(50),
      AllocationRegionName varchar (50),
      AllocationSubRegionName varchar(50),
      LocalNonLocal varchar (10),
	)
	
INSERT INTO #LocalNonLocalMapping
	SELECT [OR].RegionName, [OR].SubRegionName, AR.RegionName, AR.SubRegionName, ''Local'' 
	FROM ProfitabilityActual PA
		INNER JOIN OriginatingRegion [OR] ON PA.OriginatingRegionKey = [OR].OriginatingRegionKey 
		INNER JOIN AllocationRegion AR ON PA.AllocationRegionKey = AR.AllocationRegionKey
	WHERE
		([OR].SubRegionName = AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName <> ''China'')
		OR (AR.RegionName = ''China'' AND [OR].RegionName = ''China'')
	
	UNION
	
	SELECT [OR].RegionName, [OR].SubRegionName, AR.RegionName, AR.SubRegionName, ''Non-Local'' 
	FROM ProfitabilityActual PA
		INNER JOIN OriginatingRegion [OR] ON PA.OriginatingRegionKey = [OR].OriginatingRegionKey 
		INNER JOIN AllocationRegion AR ON PA.AllocationRegionKey = AR.AllocationRegionKey
	WHERE
		([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName <> ''China'')
		OR ([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName = ''China'' AND [OR].RegionName <> ''China'')
		OR ([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName = ''China'')
		
	UNION
	
	SELECT [OR].RegionName, [OR].SubRegionName, AR.RegionName, AR.SubRegionName, ''Local'' 
	FROM ProfitabilityBudget PB
		INNER JOIN OriginatingRegion [OR] ON PB.OriginatingRegionKey = [OR].OriginatingRegionKey 
		INNER JOIN AllocationRegion AR ON PB.AllocationRegionKey = AR.AllocationRegionKey
	WHERE
		([OR].SubRegionName = AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName <> ''China'')
		OR (AR.RegionName = ''China'' AND [OR].RegionName = ''China'')
	
	UNION
	
	SELECT [OR].RegionName, [OR].SubRegionName, AR.RegionName, AR.SubRegionName, ''Non-Local'' 
	FROM ProfitabilityBudget PB
		INNER JOIN OriginatingRegion [OR] ON PB.OriginatingRegionKey = [OR].OriginatingRegionKey 
		INNER JOIN AllocationRegion AR ON PB.AllocationRegionKey = AR.AllocationRegionKey
	WHERE
		([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName <> ''China'')
		OR ([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName = ''China'' AND [OR].RegionName <> ''China'')
		OR ([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName = ''China'')
		
			UNION
	
	SELECT [OR].RegionName, [OR].SubRegionName, AR.RegionName, AR.SubRegionName, ''Local'' 
	FROM ProfitabilityReforecast PR
		INNER JOIN OriginatingRegion [OR] ON PR.OriginatingRegionKey = [OR].OriginatingRegionKey 
		INNER JOIN AllocationRegion AR ON PR.AllocationRegionKey = AR.AllocationRegionKey
	WHERE
		([OR].SubRegionName = AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName <> ''China'')
		OR (AR.RegionName = ''China'' AND [OR].RegionName = ''China'')
	
	UNION
	
	SELECT [OR].RegionName, [OR].SubRegionName, AR.RegionName, AR.SubRegionName, ''Non-Local'' 
	FROM ProfitabilityReforecast PR
		INNER JOIN OriginatingRegion [OR] ON PR.OriginatingRegionKey = [OR].OriginatingRegionKey 
		INNER JOIN AllocationRegion AR ON PR.AllocationRegionKey = AR.AllocationRegionKey
	WHERE
		([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName <> ''China'')
		OR ([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName = ''China'' AND [OR].RegionName <> ''China'')
		OR ([OR].SubRegionName <> AR.SubRegionName AND AR.RegionName <> ''China'' AND [OR].RegionName = ''China'')


--------------------------------------------------------------------------
/*    END SETUP LOCAL/NON-LOCAL MAPPING DATA        */
--------------------------------------------------------------------------


IF 	OBJECT_ID(''tempdb..#BudgetOriginatorOwnerEntity'') IS NOT NULL
    DROP TABLE #BudgetOriginatorOwnerEntity

CREATE TABLE #BudgetOriginatorOwnerEntity
(
	ActivityTypeKey				Int,	
    GlAccountCategoryKey		Int,
    AllocationRegionKey			Int,
    OriginatingRegionKey		Int,
    FunctionalDepartmentKey		Int,
    PropertyFundKey				INT,
	SourceName					VarChar(50),
	EntryDate					VARCHAR(10),
	[User]						NVARCHAR(20),
	[Description]				NVARCHAR(60),
	AdditionalDescription		NVARCHAR(4000),
	PropertyFundCode			Varchar(6) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	OriginatingRegionCode		Varchar(30) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	FunctionalDepartmentCode	Varchar(15) DEFAULT(''''),
	GlAccountKey				Int NULL,
	CalendarPeriod				Varchar(6) DEFAULT(''''),

	--Month to date	
	MtdGrossActual				MONEY,
	MtdGrossBudget				MONEY,
	MtdGrossReforecastQ1		MONEY,
	MtdGrossReforecastQ2		MONEY,
	MtdGrossReforecastQ3		MONEY,
	
	MtdNetActual				MONEY,
	MtdNetBudget				MONEY,
	MtdNetReforecastQ1			MONEY,
	MtdNetReforecastQ2			MONEY,
	MtdNetReforecastQ3			MONEY,
	
	--Year to date
	YtdGrossActual				MONEY,	
	YtdGrossBudget				MONEY, 
	YtdGrossReforecastQ1		MONEY,
	YtdGrossReforecastQ2		MONEY,
	YtdGrossReforecastQ3		MONEY,
	
	YtdNetActual				MONEY, 
	YtdNetBudget				MONEY, 
	YtdNetReforecastQ1			MONEY, 
	YtdNetReforecastQ2			MONEY, 
	YtdNetReforecastQ3			MONEY, 

	--Annual	
	AnnualGrossBudget			MONEY,
	AnnualGrossReforecastQ1		MONEY,
	AnnualGrossReforecastQ2		MONEY,
	AnnualGrossReforecastQ3		MONEY,
	AnnualNetBudget				MONEY,
	AnnualNetReforecastQ1		MONEY,
	AnnualNetReforecastQ2		MONEY,
	AnnualNetReforecastQ3		MONEY,

	--Annual estimated
	AnnualEstGrossBudget		MONEY,
	AnnualEstGrossReforecastQ1	MONEY,
	AnnualEstGrossReforecastQ2	MONEY,
	AnnualEstGrossReforecastQ3	MONEY,
	AnnualEstNetBudget			MONEY,
	AnnualEstNetReforecastQ1	MONEY,
	AnnualEstNetReforecastQ2	MONEY,
	AnnualEstNetReforecastQ3	MONEY
)

DECLARE @cmdString	VARCHAR(MAX)
DECLARE @cmdString2	VARCHAR(MAX)
DECLARE @cmdString3	VARCHAR(MAX)

--Get actual information
SET @cmdString = (Select ''

INSERT INTO #BudgetOriginatorOwnerEntity
SELECT 
	pa.ActivityTypeKey,
    gac.GlAccountCategoryKey,
    pa.AllocationRegionKey,
    pa.OriginatingRegionKey,
    pa.FunctionalDepartmentKey,
    pa.PropertyFundKey,
    s.SourceName,
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101) as EntryDate,
    ISNULL(pa.[User], '''''''') [User],
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END as Description,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END as AdditionalDescription,
    ISNULL(pa.PropertyFundCode, '''''''') PropertyFundCode,
    ISNULL(pa.OriginatingRegionCode, '''''''') OriginatingRegionCode,
    ISNULL(pa.FunctionalDepartmentCode, '''''''') FunctionalDepartmentCode,
    pa.GlAccountKey,
    c.CalendarPeriod,
    
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- MtdGrossReforecast --------------------------*/ + ''	
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,	
	
	'' + /*-- MtdGrossReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,	

	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,		
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
	'')
	
	SET @cmdString2 = (Select ''	
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,

	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualGrossBudget,
	
	'' + /*-- AnnualGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''

	NULL as AnnualNetBudget,
	
	'' + /*-- AnnualNetReforecast --------------------------*/ + ''
	
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,	

	'' + /*-- AnnualNetReforecast End --------------------------*/ + ''
	
	SUM(
        er.Rate *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
	) as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''

	'')
	
	SET @cmdString3 = (Select ''

    SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
    '' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3		
	
	'' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
	
FROM
	ProfitabilityActual pa

	INNER JOIN Overhead oh ON oh.OverheadKey = pa.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pa.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pa.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pa.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pa.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pa.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pa.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pa.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pa.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
    
    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
    INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON c.CalendarKey = pa.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pa.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pa.ReimbursableKey ''
    
    + CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey'' ELSE '''' END + ''

WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationRegionFilterTable t1)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationSubRegionFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''
Group by
	pa.ActivityTypeKey,
    gac.GlAccountCategoryKey,
    pa.AllocationRegionKey,
    pa.OriginatingRegionKey,
    pa.FunctionalDepartmentKey,
    pa.PropertyFundKey,
    s.SourceName,
	CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101),
	ISNULL(pa.[User], '''''''') ,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END,
	ISNULL(pa.PropertyFundCode, ''''''''),
    ISNULL(pa.OriginatingRegionCode, ''''''''),
    ISNULL(pa.FunctionalDepartmentCode, ''''''''),
	pa.GlAccountKey,
	c.CalendarPeriod
'')

IF (LEN(@cmdString) > 7995 OR LEN(@cmdString2) > 7995 OR LEN(@cmdString3) > 7995)
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LTRIM(RTRIM(LEN(@cmdString)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString2)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString3)))))

PRINT @cmdString
PRINT @cmdString2
PRINT @cmdString3
EXEC (@cmdString + @cmdString2 + @cmdString3)

-- Get budget information
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwnerEntity
SELECT 
	pb.ActivityTypeKey,
    gac.GlAccountCategoryKey,
    pb.AllocationRegionKey,
    pb.OriginatingRegionKey,
    pb.FunctionalDepartmentKey,
    pb.PropertyFundKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
    NULL as MtdGrossActual,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as MtdNetBudget,
    
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as YtdNetBudget,
    
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	SUM(er.Rate * pb.LocalBudget) as AnnualGrossBudget,
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	SUM(er.Rate * r.MultiplicationFactor * pb.LocalBudget) as AnnualNetBudget,
	
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,	

	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3
FROM
	ProfitabilityBudget pb

	INNER JOIN Overhead oh ON oh.OverheadKey = pb.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pb.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pb.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pb.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pb.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pb.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pb.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pb.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pb.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pb.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pb.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pb.ReimbursableKey ''
        
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pb.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey'' ELSE '''' END + ''
	
WHERE  1 = 1 
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
 	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
 	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
Group By
	pb.ActivityTypeKey,
    gac.GlAccountCategoryKey,
    pb.AllocationRegionKey,
    pb.OriginatingRegionKey,
    pb.FunctionalDepartmentKey,
    pb.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

-- Get reforecast information
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwnerEntity
SELECT
	pr.ActivityTypeKey, 
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ1, 
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget, 
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ1,
    NULL as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
    NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,	
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ1,
    NULL as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ1,
    NULL as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3

FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pr.ReimbursableKey ''
        
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
	
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ1,10,0) + ''
 	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
 	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	pr.ActivityTypeKey,
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

-- Q2 -----------------------------------------------------------------------------------------------------
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwnerEntity
SELECT
	pr.ActivityTypeKey, 
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	NULL as MtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ2, 
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	
	NULL as YtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''NULL as AnnualGrossReforecastQ1,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ2,    
    NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''NULL as AnnualNetReforecastQ1,
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ2,    
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,	
	
	NULL as AnnualEstGrossReforecastQ1,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	
	NULL as AnnualEstNetReforecastQ1,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3

FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pr.ReimbursableKey ''
        
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
	
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ2,10,0) + ''
 	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
 	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	pr.ActivityTypeKey,
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

-- Q3 -----------------------------------------------------------------------------------------------------
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwnerEntity
SELECT
	pr.ActivityTypeKey, 
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ3,
	
	NULL as AnnualGrossBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''NULL as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget,'' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,	
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ3

FROM
	ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
    INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
    INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pr.ReimbursableKey ''
        
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
	
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ3,10,0) + ''
 	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
 	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
Group By
	pr.ActivityTypeKey,
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

print @cmdString
EXEC (@cmdString)
-------------------------------------------------------------------------------------------------------


--Entity Mode
SELECT 
	aty.ActivityTypeName as ActivityTypeName,
	aty.ActivityTypeName as ActivityTypeFilterName,
    gac.AccountSubTypeName as ExpenseType,
    ar.RegionName AS AllocationRegionName,
    ar.SubRegionName AS AllocationSubRegionName,
    ar.SubRegionName AS AllocationSubRegionFilterName,
    orr.RegionName AS OriginatingRegionName,
    orr.SubRegionName AS OriginatingSubRegionName,
    orr.SubRegionName AS OriginatingSubRegionFilterName,
    --NB!!!!!!!
    --The roll up to payroll is very sensitive information. It is crutial that information regarding payroll not 
    --get communicated to TS employees.
    CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN ''Payroll'' ELSE fd.FunctionalDepartmentName END AS FunctionalDepartmentName,
    gac.MajorCategoryName AS MajorExpenseCategoryName,
    gac.MinorCategoryName AS MinorExpenseCategoryName,
    pf.PropertyFundType AS EntityType,
    pf.PropertyFundName AS EntityName,
    res.CalendarPeriod AS ActualsExpensePeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
	res.SourceName AS SourceName,
	res.PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END AS OriginatingRegionCode,
    --res.OriginatingRegionCode,
    
	ISNULL(ga.Code, '''') GlAccountCode,
    ISNULL(ga.Name, '''') GlAccountName,
	
	--Month to date    
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossActual,0) ELSE ISNULL(MtdNetActual,0) END) AS MtdActual,
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossBudget,0) ELSE ISNULL(MtdNetBudget,0) END) AS MtdOriginalBudget,
	
	----------
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END,0) 
	END) AS MtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END,0) 
	END) AS MtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END,0) 
	END) AS MtdReforecastQ3,	
	
	----------
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) AS MtdVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) AS MtdVarianceQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) AS MtdVarianceQ3,		
	
	----------
	
	--Year to date
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossActual,0) ELSE ISNULL(YtdNetActual,0) END) AS YtdActual,	
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossBudget,0) ELSE ISNULL(YtdNetBudget,0) END) AS YtdOriginalBudget,
	
	----------
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1 
		END,0) 
	END) AS YtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2
		END,0) 
	END) AS YtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3
		END,0) 
	END) AS YtdReforecastQ3,	
	----------
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) AS YtdVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) AS YtdVarianceQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) AS YtdVarianceQ3,
	
	----------
	
	--Annual
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnnualGrossBudget,0) ELSE ISNULL(AnnualNetBudget,0) END) AS AnnualOriginalBudget,	
	----------
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ1 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ1
		END,0) 
	END) AS AnnualReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ2
		END,0) 
	END) AS AnnualReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ3
		END,0) 
	END) AS AnnualReforecastQ3
	--
	
INTO
	#Output
FROM
	#BudgetOriginatorOwnerEntity res
		INNER JOIN AllocationRegion ar ON ar.AllocationRegionKey = res.AllocationRegionKey
		INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = res.OriginatingRegionKey
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentKey = res.FunctionalDepartmentKey
		INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = res.GlAccountCategoryKey
		INNER JOIN PropertyFund pf ON pf.PropertyFundKey = res.PropertyFundKey
		INNER JOIN ActivityType aty ON aty.ActivityTypeKey = res.ActivityTypeKey
		LEFT OUTER JOIN GlAccount ga ON ga.GlAccountKey = res.GlAccountKey 
GROUP BY
	aty.ActivityTypeName,
    gac.AccountSubTypeName,
    ar.RegionName,
    ar.SubRegionName,
    orr.RegionName,
    orr.SubRegionName,
    --NB!!!!!!!
    --The roll up to payroll is very sensitive information. It is crutial that information regarding payroll not 
    --get communicated to TS employees.
    CASE WHEN (gac.MajorCategoryName = ''Salaries/Taxes/Benefits'') THEN ''Payroll'' ELSE fd.FunctionalDepartmentName END,
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    pf.PropertyFundType,
    pf.PropertyFundName,
    res.CalendarPeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
    res.SourceName,
    res.PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END,
    --res.OriginatingRegionCode,
    ISNULL(ga.Code, ''''),
    ISNULL(ga.Name, '''')

--Output
SELECT
	ActivityTypeName,
	ActivityTypeFilterName,
    ExpenseType,
    AllocationRegionName,
    AllocationSubRegionName,
    AllocationSubRegionFilterName,
    OriginatingRegionName,
    OriginatingSubRegionName,
    OriginatingSubRegionFilterName,
    FunctionalDepartmentName,
    MajorExpenseCategoryName,
    MinorExpenseCategoryName,
    EntityType,
    EntityName,
    ActualsExpensePeriod,
    EntryDate,
    [User],
    CASE WHEN ((AnnualOriginalBudget <> 0)OR (AnnualReforecastQ1 <> 0) OR (AnnualReforecastQ2 <> 0) OR (AnnualReforecastQ3 <> 0)) AND  ((MtdActual = 0) OR (YtdActual = 0)) THEN ''          [BUDGET/REFORECAST]'' ELSE [Description] END as [Description],
    AdditionalDescription,
	SourceName,
	PropertyFundCode,
    OriginatingRegionCode,
    GlAccountCode,
    GlAccountName,
	
	--Month to date    
	MtdActual,
	MtdOriginalBudget,
	
	MtdReforecastQ1,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ1 END AS MtdReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ2 END AS MtdReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ3 END AS MtdReforecastQ3,
	
	MtdVarianceQ1,
	MtdVarianceQ2,
	MtdVarianceQ3,
	
	--Year to date
	YtdActual,
	YtdOriginalBudget,
	
	YtdReforecastQ1,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ1 END AS YtdReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ2 END AS YtdReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ3 END AS YtdReforecastQ3,
	
	YtdVarianceQ1,
	YtdVarianceQ2,
	YtdVarianceQ3,
	--Annual
	AnnualOriginalBudget,
	
	AnnualReforecastQ1,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ1 END AS AnnualReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ2 END AS AnnualReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ3 END AS AnnualReforecastQ3,
	
	--Annual Estimated
	--AnnualEstimatedActual,
	--AnnualEstimatedVariance

	-- Change Control 14. CC Ref 4.1 Create Direct or Indirect field and map Direct to all the properties, and Indirect to all the Corporates
	(SELECT LocalNonLocal FROM #LocalNonLocalMapping
	WHERE #LocalNonLocalMapping.AllocationSubRegionName = #Output.AllocationSubRegionName  
	AND #LocalNonLocalMapping.AllocationRegionName = #Output.AllocationRegionName
	AND #LocalNonLocalMapping.OriginatingSubRegionName = #Output.OriginatingSubRegionName
	AND #LocalNonLocalMapping.OriginatingRegionName = #Output.OriginatingRegionName)
	AS LocalNonLocal,
	
	-- Change Control 14. CC Ref 5.4 Create Direct or Indirect field and map Direct to all the properties, and Indirect to all the Corporates
	(SELECT DirectIndirect FROM #DirectIndirectMappings WHERE SourceName = #Output.SourceName) AS DirectIndirect
	
FROM
	#Output
WHERE
	--Month to date    
	MtdActual <> 0.00 OR
	MtdOriginalBudget <> 0.00 OR
	
	--MtdReforecastQ1 <> 0.00 OR
	--MtdReforecastQ2 <> 0.00 OR
	--MtdReforecastQ3 <> 0.00 OR
	
	MtdVarianceQ1 <> 0.00 OR
	--MtdVarianceQ2 <> 0.00 OR
	--MtdVarianceQ3 <> 0.00 OR
	--Year to date
	YtdActual <> 0.00 OR
	YtdOriginalBudget <> 0.00 OR
	
	--YtdReforecastQ1 <> 0.00 OR
	--YtdReforecastQ2 <> 0.00 OR
	--YtdReforecastQ3 <> 0.00 OR
	
	YtdVarianceQ1 <> 0.00 OR
	--YtdVarianceQ2 <> 0.00 OR
	--YtdVarianceQ3 <> 0.00 OR
	--Annual
	AnnualOriginalBudget <> 0.00 OR
	
	AnnualReforecastQ1 <> 0.00 
	--AnnualReforecastQ2 <> 0.00 OR
	--AnnualReforecastQ3 <> 0.00
	--Annual Estimated
	--AnnualEstimatedActual <> 0.00 OR
	--AnnualEstimatedVariance <> 0.00

IF 	OBJECT_ID(''tempdb..#BudgetOriginatorOwnerEntity'') IS NOT NULL
    DROP TABLE #BudgetOriginatorOwnerEntity

IF 	OBJECT_ID(''tempdb..#Output'') IS NOT NULL
    DROP TABLE #Output

IF 	OBJECT_ID(''tempdb..#EntityFilterTable'') IS NOT NULL
	DROP TABLE	#EntityFilterTable

IF 	OBJECT_ID(''tempdb..#FunctionalDepartmentFilterTable'') IS NOT NULL
	DROP TABLE	#FunctionalDepartmentFilterTable
	
IF 	OBJECT_ID(''tempdb..#ActivityTypeFilterTable'') IS NOT NULL	
	DROP TABLE	#ActivityTypeFilterTable
	
IF 	OBJECT_ID(''tempdb..#AllocationRegionFilterTable'') IS NOT NULL	
	DROP TABLE	#AllocationRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#AllocationSubRegionFilterTable'') IS NOT NULL	
	DROP TABLE	#AllocationSubRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#MajorAccountCategoryFilterTable'') IS NOT NULL	
	DROP TABLE	#MajorAccountCategoryFilterTable

IF 	OBJECT_ID(''tempdb..#MinorAccountCategoryFilterTable'') IS NOT NULL	
	DROP TABLE	#MinorAccountCategoryFilterTable
	
IF 	OBJECT_ID(''tempdb..#OriginatingRegionFilterTable'') IS NOT NULL	
	DROP TABLE	#OriginatingRegionFilterTable

IF 	OBJECT_ID(''tempdb..#OriginatingSubRegionFilterTable'') IS NOT NULL	
	DROP TABLE	#OriginatingSubRegionFilterTable

IF 	OBJECT_ID(''tempdb..#ReforecastsEffectivePeriods'') IS NOT NULL	
	DROP TABLE #ReforecastsEffectivePeriods
	
-- Change Control 14. CC Ref 5.4 Create Direct or Indirect field and map Direct to all the properties, and Indirect to all the Corporates
IF  OBJECT_ID(''tempdb..#DirectIndirectMappings'') IS NOT NULL
    DROP TABLE #DirectIndirectMappings
    
-- Change Control 14. CC Ref 4.1 Create Direct or Indirect field and map Direct to all the properties, and Indirect to all the Corporates
IF  OBJECT_ID(''tempdb..#LocalNonLocalMappings'') IS NOT NULL
    DROP TABLE #LocalNonLocalMapping



' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_BudgetOriginator]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_BudgetOriginator]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'

CREATE PROCEDURE [dbo].[stp_R_BudgetOriginator]
	@ReportExpensePeriod INT = NULL,
	@ReforecastQuaterName VARCHAR(10) = NULL, --''Q1'' or ''Q2'' or ''Q3''
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = ''Global'',
	@IsGross bit = 1,
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@OverheadCode Varchar(10)=''UNALLOC''

AS

DECLARE
	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_ReforecastQuaterName VARCHAR(10) = @ReforecastQuaterName,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_TranslationTypeName VARCHAR(50) = @TranslationTypeName,
	@_IsGross bit = @IsGross,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList
	
IF LEN(@_FunctionalDepartmentList) > 7998 OR
	LEN(@_ActivityTypeList) > 7998 OR
	LEN(@_EntityList) > 7998 OR
	LEN(@_MajorAccountCategoryList) > 7998 OR
	LEN(@_MinorAccountCategoryList) > 7998 OR
	LEN(@_AllocationRegionList) > 7998 OR
	LEN(@_AllocationSubRegionList) > 7998 OR
	LEN(@_OriginatingRegionList) > 7998 OR
	LEN(@_OriginatingSubRegionList) > 7998
BEGIN
	RAISERROR(''Filter List parameter is to big'',19,1)
END
	
/*
DECLARE @ReportExpensePeriod		AS INT,
        @FunctionalDepartmentList  AS VARCHAR(8000),
        @DestinationCurrency		AS VARCHAR(3),
        @TranslationTypeName				VARCHAR(50)
				
		
SET @ReportExpensePeriod = 201011
SET @FunctionalDepartmentList = ''Information Technologies''
SET @DestinationCurrency = ''USD''
SET @TranslationTypeName = ''Global''

EXEC stp_R_BudgetOriginatorOwnerFunctionalDepartment
	@ReportExpensePeriod = 201011,
	@TranslationTypeName = ''Global'',
	@DestinationCurrency = ''USD'',

	@FunctionalDepartmentList = ''Information Technologies'',
	@AllocationRegionList = ''CHICAGO'',
	@EntityList = ''Aldgate|Centrium (St Cathrine House/Pegasus)''

*/

--------------------------------------------------------------------------
/*	SETUP MAPPING DATA		*/
--------------------------------------------------------------------------
-- Change Control 14. CC Ref 5.4 Create Direct or Indirect field and map Direct to all the properties, and Indirect to all the Corporates
IF 	OBJECT_ID(''tempdb..#DirectIndirectMappings'') IS NOT NULL
    DROP TABLE #DirectIndirectMappings

CREATE TABLE #DirectIndirectMappings
(
	SourceName varchar(50) PRIMARY KEY ,
	DirectIndirect varchar (10),
)	
INSERT INTO #DirectIndirectMappings
SELECT
	SourceName,
	''Direct'' AS DirectIndirect
FROM
	dbo.[Source]
WHERE
	IsProperty = ''YES''

UNION

SELECT
	SourceName,
	''Indirect'' AS DirectIndirect
FROM
	dbo.[Source]
WHERE
	IsCorporate = ''YES''

UNION

SELECT
	SourceName,
	''-'' AS DirectIndirect
FROM
	dbo.[Source]
WHERE
	IsCorporate = ''NO'' AND
	IsProperty = ''NO''

--------------------------------------------------------------------------
/*	END SETUP MAPPING DATA		*/
--------------------------------------------------------------------------

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + REPLACE(STR(MONTH(GETDATE()),2 ),'' '',''0'')AS INT)

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@TranslationTypeName IS NULL
	SET @TranslationTypeName = ''Global''

	DECLARE @CalendarYear AS INT
	SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)				

--------------------------------------------------------------------------

-- Determine the ReforecastKey of the reforecast that is currently active (i.e.: 2011 Q1, 2011 Q2, 2012 Q0 etc)
DECLARE @ActiveReforecastKey INT = (SELECT ReforecastKey FROM dbo.GetCurrentReforecastRecord())

IF (@ActiveReforecastKey IS NULL) -- Safeguard against NULL ReforecastKey returned from previous statement
BEGIN
	SET @ActiveReforecastKey = (SELECT MAX(ReforecastKey) FROM dbo.ExchangeRate)
	PRINT (''Near disaster: @ActiveReforecastKey is NULL, so reverting to the largest/most recent ReforecastKey in dbo.ExchangeRate: '' + @ActiveReforecastKey)
END

--------------------------------------------------------------------------

--------------------------------------------------------------------------
-- let latest reforecast (it will be zero if there is no data for the reforecast)
IF @ReforecastQuaterName IS NULL OR @ReforecastQuaterName NOT IN (''Q0'', ''Q1'', ''Q2'', ''Q3'')
	SET @ReforecastQuaterName = (SELECT TOP 1
									ReforecastQuarterName 
								 FROM
									dbo.Reforecast 
								 WHERE
									ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
									ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
								 ORDER BY ReforecastEffectivePeriod DESC)
--------------------------------------------------------------------------
-- Compute Reforecast Effective Periods

DECLARE @ReforecastEffectivePeriodQ1 INT
DECLARE @ReforecastEffectivePeriodQ2 INT
DECLARE @ReforecastEffectivePeriodQ3 INT

SET @ReforecastEffectivePeriodQ1 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q1''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ2 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q2''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ3 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q3''
									ORDER BY
										ReforecastEffectivePeriod)

-- Retrieve Reforecast Quarter Name

DECLARE @ReforecastQuarterNameQ1 CHAR(2)
DECLARE @ReforecastQuarterNameQ2 CHAR(2)
DECLARE @ReforecastQuarterNameQ3 CHAR(2)

IF (@ReforecastEffectivePeriodQ1 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ1 = (SELECT TOP 1
										ReforecastQuarterName 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ1)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ1 is NULL - cannot determine Q1 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ2 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ2 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ2)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ2 is NULL - cannot determine Q2 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ3 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ3 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ3)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ3 is NULL - cannot determine Q3 reforecast quarter name.'')
END

--------------------------------------------------------------------------
/*	Determine Report Exchange Rates	*/
--------------------------------------------------------------------------

SELECT
	SourceCurrencyKey,
	DestinationCurrencyKey,
	CalendarKey,
	Rate
INTO
	#ExchangeRate
FROM
	dbo.ExchangeRate
WHERE
	ReforecastKey = @ActiveReforecastKey -- We will use the exchange rate set that is active for the current reforecast.


--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
CREATE TABLE #EntityFilterTable	(PropertyFundKey Int NOT NULL)
CREATE TABLE #FunctionalDepartmentFilterTable (FunctionalDepartmentKey Int NOT NULL)
CREATE TABLE #ActivityTypeFilterTable (ActivityTypeKey Int NOT NULL)
CREATE TABLE #AllocationRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #AllocationSubRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #MajorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #MinorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #OriginatingRegionFilterTable (OriginatingRegionKey Int NOT NULL)
CREATE TABLE #OriginatingSubRegionFilterTable (OriginatingRegionKey Int NOT NULL)	
	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable	(PropertyFundKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable	(FunctionalDepartmentKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable(ActivityTypeKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable(GlAccountCategoryKey)	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable(GlAccountCategoryKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable	(OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable	(OriginatingRegionKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END		
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------
	
IF 	OBJECT_ID(''tempdb..#BudgetOriginatorOwner'') IS NOT NULL
    DROP TABLE #BudgetOriginatorOwner

CREATE TABLE #BudgetOriginatorOwner
(	
	ActivityTypeKey			INT,
	AllocationRegionKey		INT,
	OriginatingRegionKey	INT,
    PropertyFundKey			INT,
    FunctionalDepartmentKey INT,    
	GlAccountCategoryKey	INT,
	SourceName				VARCHAR(50),
	EntryDate				VARCHAR(10),
	[User]					NVARCHAR(20),
	[Description]			NVARCHAR(60),
	AdditionalDescription	NVARCHAR(4000),
	PropertyFundCode		VARCHAR(6) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	OriginatingRegionCode	VARCHAR(30) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	FunctionalDepartmentCode VARCHAR(15) DEFAULT(''''),
	GlAccountKey			INT NULL,
	CalendarPeriod			Varchar(6) DEFAULT(''''),

	--Month to date	
	MtdGrossActual			MONEY,
	MtdGrossBudget			MONEY,
	MtdGrossReforecastQ1	MONEY,
	MtdGrossReforecastQ2	MONEY,
	MtdGrossReforecastQ3	MONEY,
	MtdNetActual			MONEY,
	MtdNetBudget			MONEY,
	MtdNetReforecastQ1		MONEY,
	MtdNetReforecastQ2		MONEY,
	MtdNetReforecastQ3		MONEY,
	
	--Year to date
	YtdGrossActual			MONEY,	
	YtdGrossBudget			MONEY, 
	YtdGrossReforecastQ1	MONEY,
	YtdGrossReforecastQ2	MONEY,
	YtdGrossReforecastQ3	MONEY,
	YtdNetActual			MONEY, 
	YtdNetBudget			MONEY, 
	YtdNetReforecastQ1		MONEY,
	YtdNetReforecastQ2		MONEY,
	YtdNetReforecastQ3		MONEY,
	
	--Annual
	AnnualGrossBudget		MONEY,
	AnnualGrossReforecastQ1	MONEY,
	AnnualGrossReforecastQ2 MONEY,
	AnnualGrossReforecastQ3 MONEY,
	AnnualNetBudget			MONEY,
	AnnualNetReforecastQ1	MONEY,
	AnnualNetReforecastQ2	MONEY,
	AnnualNetReforecastQ3	MONEY,

	--Annual estimated
	AnnualEstGrossBudget	 MONEY,
	AnnualEstGrossReforecastQ1 MONEY,
	AnnualEstGrossReforecastQ2 MONEY,
	AnnualEstGrossReforecastQ3 MONEY,
	AnnualEstNetBudget		 MONEY,
	AnnualEstNetReforecastQ1 MONEY,
	AnnualEstNetReforecastQ2 MONEY,
	AnnualEstNetReforecastQ3 MONEY
)

DECLARE @cmdString Varchar(MAX)

--Get actual information
SET @cmdString = (Select ''

INSERT INTO #BudgetOriginatorOwner
SELECT 	
	pa.ActivityTypeKey,
	pa.AllocationRegionKey,
	pa.OriginatingRegionKey,
    pa.PropertyFundKey,
    pa.FunctionalDepartmentKey,    
	gac.GlAccountCategoryKey,
    s.SourceName,
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101) as EntryDate,
    ISNULL(pa.[User], '''''''') [User],
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END as Description,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END as AdditionalDescription,
    ISNULL(pa.PropertyFundCode, '''''''') PropertyFundCode,
    ISNULL(pa.OriginatingRegionCode, '''''''') OriginatingRegionCode,
    ISNULL(pa.FunctionalDepartmentCode, '''''''') FunctionalDepartmentCode,
    pa.GLAccountKey,
    c.CalendarPeriod,
    
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- ReforecastEffectivePeriod --------------------------*/ + ''
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	'' + /*-- ReforecastEffectivePeriod End ----------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,	
	
	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'' + /*-- YTDGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,

	'' + /*-- YTDGrossReforecast End ----------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdNetActual,
	NULL as YtdNetBudget,
	'')
	
	DECLARE @cmdString2 Varchar(MAX)
	SET @cmdString2 = (Select ''
	
	
	'' + /*-- YtdNetReforecast ----------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,

	'' +
	
	/*-- YtdNetReforecast End ------------------*/ + ''
	

	NULL as AnnualGrossBudget,
	
	'' + /*-- AnnualGrossReforecast ------------------*/ + ''
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End ------------------*/ + ''

	'')

	DECLARE @cmdString3 Varchar(MAX)
	SET @cmdString3 = (Select ''

	NULL as AnnualNetBudget,
	
	'' + /*-- AnnualNetReforecast ------------------*/ + ''
	
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	'' + /*-- AnnualNetReforecast End ------------------*/ + ''
	
	SUM(
        er.Rate *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
	) as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast ------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,	

	'' + /*-- AnnualEstGrossReforecast End ------------------*/ + ''

    SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
    '' + /*-- AnnualEstNetReforecast ------------------*/ + ''
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3		

	'' + /*-- AnnualEstNetReforecast End ------------------*/ + ''
	
FROM
	ProfitabilityActual pa

	INNER JOIN Overhead oh ON oh.OverheadKey = pa.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pa.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pa.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pa.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pa.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pa.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pa.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pa.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pa.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
	
    INNER JOIN #ExchangeRate er ON  er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
    INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey
    INNER JOIN Calendar c ON  c.CalendarKey = pa.CalendarKey
    INNER JOIN Source s ON s.SourceKey = pa.SourceKey
    INNER JOIN Reimbursable r ON  r.ReimbursableKey = pa.ReimbursableKey ''
    		
    + CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey'' ELSE '''' END + ''

WHERE  1 = 1
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
 	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
 	AND gac.MinorCategoryName <> ''''Bonus''''
 	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationRegionFilterTable t1)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationSubRegionFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''
GROUP BY
	pa.ActivityTypeKey,
	pa.AllocationRegionKey,
	pa.OriginatingRegionKey,
    pa.PropertyFundKey,
    pa.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
	s.SourceName,
	CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101),
	ISNULL(pa.[User], '''''''') ,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END,
	ISNULL(pa.PropertyFundCode, ''''''''),
    ISNULL(pa.OriginatingRegionCode, ''''''''),
    ISNULL(pa.FunctionalDepartmentCode, ''''''''),
	pa.GlAccountKey,
	c.CalendarPeriod
	
	'')

IF (LEN(@cmdString) > 7995 OR LEN(@cmdString2) > 7995 OR LEN(@cmdString3) > 7995)
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LTRIM(RTRIM(LEN(@cmdString)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString2)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString3)))))

PRINT (@cmdString)
PRINT (@cmdString2)
PRINT (@cmdString3)

EXEC (@cmdString + @cmdString2 + @cmdString3)

-- Get budget information
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwner
SELECT 
	pb.ActivityTypeKey,
	pb.AllocationRegionKey,
	pb.OriginatingRegionKey,
    pb.PropertyFundKey,
    pb.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
    NULL as MtdGrossActual,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as MtdNetBudget,
    
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as YtdNetBudget,
    
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	SUM(er.Rate * pb.LocalBudget) as AnnualGrossBudget,
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	SUM(er.Rate * r.MultiplicationFactor * pb.LocalBudget) as AnnualNetBudget,
	
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,

	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3
	
FROM
    ProfitabilityBudget pb

	INNER JOIN Overhead oh ON oh.OverheadKey = pb.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pb.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pb.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pb.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pb.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pb.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pb.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pb.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pb.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey 
	INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey    
	INNER JOIN Calendar c ON  c.CalendarKey = pb.CalendarKey
	INNER JOIN Source s ON s.SourceKey = pb.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pb.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pb.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey'' ELSE '''' END + ''
		
WHERE  1 = 1 
    AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Bonus''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
Group By
	pb.ActivityTypeKey,
	pb.AllocationRegionKey,
	pb.OriginatingRegionKey,
    pb.PropertyFundKey,
    pb.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
	s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END
    
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

-- Get reforecast information -------------------------------------------------------------------------------------------------

-- Q1
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwner
SELECT 
	pr.ActivityTypeKey,
	pr.AllocationRegionKey,
	pr.OriginatingRegionKey,
    pr.PropertyFundKey,
    pr.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ1,
    NULL as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
    
    NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ1,
     NULL as AnnualGrossReforecastQ2,
     NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ1,
    NULL as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ1,
    NULL as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3
FROM
    ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey 
	INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey    
	INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
	INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
	INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ1,6,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Bonus''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
Group By
	pr.ActivityTypeKey,
	pr.AllocationRegionKey,
	pr.OriginatingRegionKey,
    pr.PropertyFundKey,
    pr.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
	s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
    
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)


-- Q2 -------------------------------------------------------------------------------------------------
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwner
SELECT 
	pr.ActivityTypeKey,
	pr.AllocationRegionKey,
	pr.OriginatingRegionKey,
    pr.PropertyFundKey,
    pr.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	NULL as MtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	
	NULL as YtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ2,
    NULL as YtdNetReforecastQ3,
    
    NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''NULL as AnnualGrossReforecastQ1,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ2,     
     NULL as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualNetReforecastQ1,
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ2,    
    NULL as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ2,
    NULL as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	
	NULL as AnnualEstNetReforecastQ1,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ2,
    NULL as AnnualEstNetReforecastQ3
FROM
    ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey 
	INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey    
	INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
	INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
	INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ2,6,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Bonus''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	pr.ActivityTypeKey,
	pr.AllocationRegionKey,
	pr.OriginatingRegionKey,
    pr.PropertyFundKey,
    pr.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
	s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
    
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)


-- Q3 -------------------------------------------------------------------------------------------------
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginatorOwner
SELECT 
	pr.ActivityTypeKey,
	pr.AllocationRegionKey,
	pr.OriginatingRegionKey,
    pr.PropertyFundKey,
    pr.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    '''''''' as CalendarPeriod,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	NULL as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	NULL as YtdNetBudget,
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ3,    
    
    NULL as AnnualGrossBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''NULL as AnnualGrossReforecastQ1,
    NULL as AnnualGrossReforecastQ2,
    SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ3,

	NULL as AnnualNetBudget, '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
    ''
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ3,

	NULL as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstGrossReforecastQ3,

	NULL as AnnualEstNetBudget,
	
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ3
FROM
    ProfitabilityReforecast pr

	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
    	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey 
	INNER JOIN Currency dc ON  er.DestinationCurrencyKey = dc.CurrencyKey    
	INNER JOIN Calendar c ON  c.CalendarKey = pr.CalendarKey
	INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
	INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
		
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,10,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ3,6,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Bonus''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
	pr.ActivityTypeKey,
	pr.AllocationRegionKey,
	pr.OriginatingRegionKey,
    pr.PropertyFundKey,
    pr.FunctionalDepartmentKey,
	gac.GlAccountCategoryKey,
	s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
    
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

--Functional Department Mode
SELECT 
	aty.ActivityTypeName,
	aty.ActivityTypeName AS ActivityTypeFilterName,
	gac.AccountSubTypeName AS ExpenseType,
	ar.RegionName AS AllocationRegionName,
    ar.SubRegionName AS AllocationSubRegionName,
    ar.SubRegionName AS AllocationSubRegionFilterName,
    orr.RegionName AS OriginatingRegionName,
    orr.SubRegionName AS OriginatingSubRegionName,
    orr.SubRegionName AS OriginatingSubRegionFilterName,
	gac.MajorCategoryName AS MajorExpenseCategoryName,
	gac.MinorCategoryName AS MinorExpenseCategoryName,
	pf.PropertyFundType AS EntityType,
	pf.PropertyFundName AS EntityName,
	fd.FunctionalDepartmentName as FunctionalDepartmentName,
    res.CalendarPeriod AS ActualsExpensePeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
	res.SourceName AS SourceName,
	res.PropertyFundCode,
	CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END AS OriginatingRegionCode,
    --res.OriginatingRegionCode,
    ISNULL(ga.Code, '''') GlAccountCode,
    ISNULL(ga.Name, '''') GlAccountName,
    
	--Month to date    
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossActual,0) ELSE ISNULL(MtdNetActual,0) END) AS MtdActual,
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossBudget,0) ELSE ISNULL(MtdNetBudget,0) END) AS MtdOriginalBudget,
	
	--
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END,0) 
	END) 
	AS MtdReforecastQ1,

	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END,0) 
	END) 
	AS MtdReforecastQ2,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END,0) 
	END) 
	AS MtdReforecastQ3,	

	--
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1 
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ1,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ2,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ3,		
	
	--Year to date
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossActual,0) ELSE ISNULL(YtdNetActual,0) END) AS YtdActual,	
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossBudget,0) ELSE ISNULL(YtdNetBudget,0) END) AS YtdOriginalBudget,
	
	--
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1
		END,0) 
	END) 
	AS YtdReforecastQ1,

	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2 
		END,0) 
	END) 
	AS YtdReforecastQ2,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3 
		END,0) 
	END) 
	AS YtdReforecastQ3,	
	
	--
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ1,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2 
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2 
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ2,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3 
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3 
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ3,		
	
	--Annual
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnnualGrossBudget,0) ELSE ISNULL(AnnualNetBudget,0) END) AS AnnualOriginalBudget,

	--
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ1
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ1
		END,0) 
	END) 
	AS AnnualReforecastQ1,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ2
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ2
		END,0) 
	END) 
	AS AnnualReforecastQ2,
	
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ3
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ3
		END,0) 
	END) 
	AS AnnualReforecastQ3	
	
	--

INTO
	#Output
FROM
	#BudgetOriginatorOwner res
		INNER JOIN AllocationRegion ar ON ar.AllocationRegionKey = res.AllocationRegionKey
		INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = res.OriginatingRegionKey
		INNER JOIN PropertyFund pf ON pf.PropertyFundKey = res.PropertyFundKey
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentKey = res.FunctionalDepartmentKey
		INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = res.GlAccountCategoryKey
		INNER JOIN ActivityType aty ON aty.ActivityTypeKey = res.ActivityTypeKey
		LEFT OUTER JOIN GlAccount ga ON ga.GlAccountKey = res.GlAccountKey 
GROUP BY
	aty.ActivityTypeName,
	gac.AccountSubTypeName,
	ar.RegionName,
    ar.SubRegionName, 
    orr.RegionName,
    orr.SubRegionName,
	gac.MajorCategoryName,
	gac.MinorCategoryName,
	pf.PropertyFundType,
	pf.PropertyFundName,
	fd.FunctionalDepartmentName,
	res.CalendarPeriod,
	res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
	res.SourceName,
	res.PropertyFundCode,
	CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END,
    --res.OriginatingRegionCode,
    ISNULL(ga.Code, ''''),
    ISNULL(ga.Name, '''')

--Output
SELECT
	ActivityTypeName,
	ActivityTypeFilterName,
	ExpenseType,
	AllocationRegionName,
    AllocationSubRegionName,
    AllocationSubRegionFilterName,
    OriginatingRegionName,
    OriginatingSubRegionName,
    OriginatingSubRegionFilterName,
	MajorExpenseCategoryName,
	MinorExpenseCategoryName,
	EntityType,
	EntityName,
	FunctionalDepartmentName,
	ActualsExpensePeriod,
    EntryDate,
    [User],
    CASE WHEN ((AnnualOriginalBudget <> 0)OR (AnnualReforecastQ1 <> 0) OR (AnnualReforecastQ2 <> 0) OR (AnnualReforecastQ3 <> 0)) AND  ((MtdActual = 0) OR (YtdActual = 0)) THEN ''          [BUDGET/REFORECAST]'' ELSE [Description] END as [Description],
    AdditionalDescription,
	SourceName,
	PropertyFundCode,
    OriginatingRegionCode,   
    GlAccountCode,
    GlAccountName,
	
	--Month to date    
	MtdActual,
	MtdOriginalBudget,
	MtdReforecastQ1,
	--MtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ3 END AS MtdReforecastQ3,
	
	MtdVarianceQ1,
	--MtdVarianceQ2,
	--MtdVarianceQ3,
	
	--Year to date
	YtdActual,	
	YtdOriginalBudget,
	
	YtdReforecastQ1,
	--YtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ3 END AS YtdReforecastQ3,
	
	YtdVarianceQ1,
	--YtdVarianceQ2,
	--YtdVarianceQ3,
	
	--Annual
	AnnualOriginalBudget,
	
	AnnualReforecastQ1,	
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ1 END AS AnnualReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ2 END AS AnnualReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ3 END AS AnnualReforecastQ3,
	
	(select DirectIndirect from #DirectIndirectMappings where SourceName = #Output.SourceName) as DirectIndirect

FROM
	#Output
WHERE
	--Month to date    
	MtdActual <> 0.00 OR
	MtdOriginalBudget <> 0.00 OR
	
	--MtdReforecastQ1 <> 0.00 OR
	--MtdReforecastQ2 <> 0.00 OR
	--MtdReforecastQ3 <> 0.00 OR
	
	MtdVarianceQ1 <> 0.00 OR
	--MtdVarianceQ2 <> 0.00 OR
	--MtdVarianceQ3 <> 0.00 OR
	
	--Year to date
	YtdActual <> 0.00 OR
	YtdOriginalBudget <> 0.00 OR
	
	--YtdReforecastQ1 <> 0.00 OR
	--YtdReforecastQ2 <> 0.00 OR
	--YtdReforecastQ3 <> 0.00 OR
		
	YtdVarianceQ1 <> 0.00 OR
	--YtdVarianceQ2 <> 0.00 OR
	--YtdVarianceQ3 <> 0.00 OR
	
	--Annual
	AnnualOriginalBudget <> 0.00 OR
	
	AnnualReforecastQ1 <> 0.00 
	--AnnualReforecastQ2 <> 0.00 OR
	--AnnualReforecastQ3 <> 0.00

IF 	OBJECT_ID(''tempdb..#BudgetOriginatorOwner'') IS NOT NULL
    DROP TABLE #BudgetOriginatorOwner

IF 	OBJECT_ID(''tempdb..#Output'') IS NOT NULL
    DROP TABLE #Output

IF 	OBJECT_ID(''tempdb..#ReforecastsEffectivePeriods'') IS NOT NULL
	DROP TABLE #ReforecastsEffectivePeriods

IF 	OBJECT_ID(''tempdb..#EntityFilterTable'') IS NOT NULL
	DROP TABLE #EntityFilterTable
	
IF 	OBJECT_ID(''tempdb..#FunctionalDepartmentFilterTable'') IS NOT NULL	
	DROP TABLE #FunctionalDepartmentFilterTable
	
IF 	OBJECT_ID(''tempdb..#ActivityTypeFilterTable'') IS NOT NULL	
	DROP TABLE #ActivityTypeFilterTable

IF 	OBJECT_ID(''tempdb..#AllocationRegionFilterTable'') IS NOT NULL	
	DROP TABLE #AllocationRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#AllocationSubRegionFilterTable'') IS NOT NULL	
	DROP TABLE #AllocationSubRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#MajorAccountCategoryFilterTable'') IS NOT NULL	
	DROP TABLE #MajorAccountCategoryFilterTable
	
IF 	OBJECT_ID(''tempdb..#MinorAccountCategoryFilterTable'') IS NOT NULL	
	DROP TABLE #MinorAccountCategoryFilterTable
	
IF 	OBJECT_ID(''tempdb..#OriginatingRegionFilterTable'') IS NOT NULL	
	DROP TABLE #OriginatingRegionFilterTable
	
IF 	OBJECT_ID(''tempdb..#OriginatingSubRegionFilterTable'') IS NOT NULL	
	DROP TABLE #OriginatingSubRegionFilterTable


IF 	OBJECT_ID(''tempdb..#DirectIndirectMappings'') IS NOT NULL
    DROP TABLE #DirectIndirectMappings

' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_BudgetJobCodeDetail]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_BudgetJobCodeDetail]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[stp_R_BudgetJobCodeDetail]
	@ReportExpensePeriod INT = NULL,
	@ReforecastQuaterName VARCHAR(10) = NULL, --''Q1'' or ''Q2'' or ''Q3''
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = ''Global'',
	@IsGross bit = 1,
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@OverheadCode Varchar(10)=''UNALLOC''
AS

DECLARE
	@_ReportExpensePeriod INT = @ReportExpensePeriod,
	@_ReforecastQuaterName VARCHAR(10) = @ReforecastQuaterName,
	@_DestinationCurrency VARCHAR(3) = @DestinationCurrency,
	@_TranslationTypeName VARCHAR(50) = @TranslationTypeName,
	@_IsGross bit = @IsGross,
	@_FunctionalDepartmentList VARCHAR(8000) = @FunctionalDepartmentList,
	@_ActivityTypeList VARCHAR(8000) = @ActivityTypeList,
	@_EntityList VARCHAR(8000) = @EntityList,
	@_MajorAccountCategoryList VARCHAR(8000) = @MajorAccountCategoryList,
	@_MinorAccountCategoryList VARCHAR(8000) = @MinorAccountCategoryList,
	@_AllocationRegionList VARCHAR(8000) = @AllocationRegionList,
	@_AllocationSubRegionList VARCHAR(8000) = @AllocationSubRegionList,
	@_OriginatingRegionList VARCHAR(8000) = @OriginatingRegionList,
	@_OriginatingSubRegionList VARCHAR(8000) = @OriginatingSubRegionList


IF LEN(@_FunctionalDepartmentList) > 7998 OR
	LEN(@_ActivityTypeList) > 7998 OR
	LEN(@_EntityList) > 7998 OR
	LEN(@_MajorAccountCategoryList) > 7998 OR
	LEN(@_MinorAccountCategoryList) > 7998 OR
	LEN(@_AllocationRegionList) > 7998 OR
	LEN(@_AllocationSubRegionList) > 7998 OR
	LEN(@_OriginatingRegionList) > 7998 OR
	LEN(@_OriginatingSubRegionList) > 7998
BEGIN
	RAISERROR(''Filter List parameter is too big'',9,1)
END
--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Variable defaults		*/
--------------------------------------------------------------------------

IF @ReportExpensePeriod IS NULL
	SET @ReportExpensePeriod = CAST(CAST(YEAR(GETDATE()) AS VARCHAR(4)) + REPLACE(STR(MONTH(GETDATE()),2 ),'' '',''0'')AS INT)

IF @DestinationCurrency IS NULL
	SET @DestinationCurrency = ''USD''

IF 	@TranslationTypeName IS NULL
	SET @TranslationTypeName = ''Global''

	DECLARE @CalendarYear AS INT
	SET @CalendarYear = CAST(SUBSTRING(CAST(@ReportExpensePeriod AS VARCHAR(10)), 1, 4) AS INT)				

--------------------------------------------------------------------------

-- Determine the ReforecastKey of the reforecast that is currently active (i.e.: 2011 Q1, 2011 Q2, 2012 Q0 etc)
DECLARE @ActiveReforecastKey INT = (SELECT ReforecastKey FROM dbo.GetCurrentReforecastRecord())

IF (@ActiveReforecastKey IS NULL) -- Safeguard against NULL ReforecastKey returned from previous statement
BEGIN
	SET @ActiveReforecastKey = (SELECT MAX(ReforecastKey) FROM dbo.ExchangeRate)
	PRINT (''Near disaster: @ActiveReforecastKey is NULL, so reverting to the largest/most recent ReforecastKey in dbo.ExchangeRate: '' + @ActiveReforecastKey)
END

--------------------------------------------------------------------------

IF @ReforecastQuaterName IS NULL OR @ReforecastQuaterName NOT IN (''Q0'', ''Q1'', ''Q2'', ''Q3'')
	SET @ReforecastQuaterName = (SELECT TOP 1
									ReforecastQuarterName 
								 FROM
									dbo.Reforecast 
								 WHERE
									ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
									ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
								 ORDER BY ReforecastEffectivePeriod DESC)
-- Compute Reforecast Effective Periods

DECLARE @ReforecastEffectivePeriodQ1 INT
DECLARE @ReforecastEffectivePeriodQ2 INT
DECLARE @ReforecastEffectivePeriodQ3 INT

SET @ReforecastEffectivePeriodQ1 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q1''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ2 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q2''
									ORDER BY
										ReforecastEffectivePeriod)								

SET @ReforecastEffectivePeriodQ3 = (SELECT TOP 1
										ReforecastEffectivePeriod 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4) AND 
										ReforecastQuarterName = ''Q3''
									ORDER BY
										ReforecastEffectivePeriod)

-- Retrieve Reforecast Quarter Name

DECLARE @ReforecastQuarterNameQ1 CHAR(2)
DECLARE @ReforecastQuarterNameQ2 CHAR(2)
DECLARE @ReforecastQuarterNameQ3 CHAR(2)

IF (@ReforecastEffectivePeriodQ1 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ1 = (SELECT TOP 1
										ReforecastQuarterName 
									FROM
										dbo.Reforecast 
									WHERE
										ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ1)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ1 is NULL - cannot determine Q1 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ2 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ2 = (SELECT TOP 1
											ReforecastQuarterName 
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ2)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ2 is NULL - cannot determine Q2 reforecast quarter name.'')
END


IF (@ReforecastEffectivePeriodQ3 IS NOT NULL)
BEGIN
	SET @ReforecastQuarterNameQ3 = (SELECT TOP 1
											ReforecastQuarterName
										FROM
											dbo.Reforecast 
										WHERE
											ReforecastEffectivePeriod = @ReforecastEffectivePeriodQ3)
END
ELSE
BEGIN
	PRINT (''@ReforecastEffectivePeriodQ3 is NULL - cannot determine Q3 reforecast quarter name.'')
END

--------------------------------------------------------------------------
/*	Determine Report Exchange Rates	*/
--------------------------------------------------------------------------

SELECT
	SourceCurrencyKey,
	DestinationCurrencyKey,
	CalendarKey,
	Rate
INTO
	#ExchangeRate
FROM
	dbo.ExchangeRate
WHERE
	ReforecastKey = @ActiveReforecastKey -- We will use the exchange rate set that is active for the current reforecast.

--------------------------------------------------------------------------
/*	COMMON Block to setup the Report Filter Tables		*/
--------------------------------------------------------------------------
	
CREATE TABLE #EntityFilterTable (PropertyFundKey Int NOT NULL)
CREATE TABLE #FunctionalDepartmentFilterTable (FunctionalDepartmentKey Int NOT NULL)
CREATE TABLE #ActivityTypeFilterTable (ActivityTypeKey Int NOT NULL)
CREATE TABLE #AllocationRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #AllocationSubRegionFilterTable (AllocationRegionKey Int NOT NULL)
CREATE TABLE #MajorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #MinorAccountCategoryFilterTable (GlAccountCategoryKey Int NOT NULL)	
CREATE TABLE #OriginatingRegionFilterTable (OriginatingRegionKey Int NOT NULL)
CREATE TABLE #OriginatingSubRegionFilterTable (OriginatingRegionKey Int NOT NULL)	
	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #EntityFilterTable (PropertyFundKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #FunctionalDepartmentFilterTable	(FunctionalDepartmentKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #ActivityTypeFilterTable (ActivityTypeKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationRegionFilterTable	(AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #AllocationSubRegionFilterTable (AllocationRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MajorAccountCategoryFilterTable (GlAccountCategoryKey)	
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #MinorAccountCategoryFilterTable (GlAccountCategoryKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingRegionFilterTable (OriginatingRegionKey)
CREATE UNIQUE CLUSTERED INDEX IX_CL ON #OriginatingSubRegionFilterTable (OriginatingRegionKey)
	
IF (@EntityList IS NOT NULL)
	BEGIN
	Insert Into #EntityFilterTable
	Select pf.PropertyFundKey
	From dbo.Split(@_EntityList) t1
		INNER JOIN PropertyFund pf ON pf.PropertyFundName = t1.item
	
	END
	
IF (@FunctionalDepartmentList IS NOT NULL)
	BEGIN
	Insert Into #FunctionalDepartmentFilterTable
	Select fd.FunctionalDepartmentKey 
	From dbo.Split(@_FunctionalDepartmentList) t1
		INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentName = t1.item
	END

IF 	(@ActivityTypeList IS NOT NULL)
	BEGIN
    INSERT INTO #ActivityTypeFilterTable
    SELECT at.ActivityTypeKey 
    FROM dbo.Split(@_ActivityTypeList) t1
		INNER JOIN ActivityType at ON at.ActivityTypeName = t1.item
	END
	
IF (@AllocationRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationRegionFilterTable
	Select ar.AllocationRegionKey 
	From dbo.Split(@_AllocationRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.RegionName = t1.item
	END

IF (@AllocationSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #AllocationSubRegionFilterTable
	Select ar.AllocationRegionKey
	From dbo.Split(@_AllocationSubRegionList) t1
		INNER JOIN AllocationRegion ar ON ar.SubRegionName = t1.item
	END

IF (@MajorAccountCategoryList IS NOT NULL)
	BEGIN
	Insert Into #MajorAccountCategoryFilterTable
	Select gl.GlAccountCategoryKey 
	From dbo.Split(@_MajorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MajorCategoryName = t1.item
	END
	
IF 	(@MinorAccountCategoryList IS NOT NULL)
	BEGIN
    INSERT INTO #MinorAccountCategoryFilterTable
    SELECT gl.GlAccountCategoryKey 
    FROM dbo.Split(@MinorAccountCategoryList) t1
		INNER JOIN GlAccountCategory gl ON gl.MinorCategoryName = t1.item
	END	

IF (@OriginatingRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingRegionFilterTable
	Select orr.OriginatingRegionKey 
	From dbo.Split(@_OriginatingRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.RegionName = t1.item
	END

IF (@OriginatingSubRegionList IS NOT NULL)
	BEGIN
	Insert Into #OriginatingSubRegionFilterTable
	Select orr.OriginatingRegionKey  
	From dbo.Split(@OriginatingSubRegionList) t1
		INNER JOIN OriginatingRegion orr ON orr.SubRegionName = t1.item
	END		
--------------------------------------------------------------------------
/*	COMMON END															*/
--------------------------------------------------------------------------
	

IF 	OBJECT_ID(''tempdb..#BudgetOriginator'') IS NOT NULL
    DROP TABLE #BudgetOriginator

CREATE TABLE #BudgetOriginator
(	
	GlAccountCategoryKey		INT,
    AllocationRegionKey			INT,
    OriginatingRegionKey		INT,
    FunctionalDepartmentKey		INT,
    PropertyFundKey				INT,
	CalendarPeriod				INT,
	SourceName					VARCHAR(50),
	EntryDate					VARCHAR(10),
	[User]						NVARCHAR(20),
	[Description]				NVARCHAR(60),
	AdditionalDescription		NVARCHAR(4000),
	PropertyFundCode			Varchar(6) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	OriginatingRegionCode		Varchar(30) DEFAULT(''''), --Varchar, for this helps to keep reports size smaller
	FunctionalDepartmentCode	Varchar(15) DEFAULT(''''),
	GlAccountKey				Int  NULL,
	
	--Month to date	
	MtdGrossActual				MONEY,
	MtdGrossBudget				MONEY,
	MtdGrossReforecastQ1		MONEY,
	MtdGrossReforecastQ2		MONEY,
	MtdGrossReforecastQ3		MONEY,
	MtdNetActual				MONEY,
	MtdNetBudget				MONEY,
	MtdNetReforecastQ1			MONEY,
	MtdNetReforecastQ2			MONEY,
	MtdNetReforecastQ3			MONEY,
	
	--Year to date
	YtdGrossActual				MONEY,	
	YtdGrossBudget				MONEY, 
	YtdGrossReforecastQ1		MONEY,
	YtdGrossReforecastQ2		MONEY,
	YtdGrossReforecastQ3		MONEY,
	YtdNetActual				MONEY, 
	YtdNetBudget				MONEY, 
	YtdNetReforecastQ1			MONEY,
	YtdNetReforecastQ2			MONEY,
	YtdNetReforecastQ3			MONEY,

	--Annual	
	AnnualGrossBudget			MONEY,
	AnnualGrossReforecastQ1		MONEY,
	AnnualGrossReforecastQ2		MONEY,
	AnnualGrossReforecastQ3		MONEY,
	AnnualNetBudget				MONEY,
	AnnualNetReforecastQ1		MONEY,
	AnnualNetReforecastQ2		MONEY,
	AnnualNetReforecastQ3		MONEY,
	--Annual estimated
	AnnualEstGrossBudget		MONEY,
	AnnualEstGrossReforecastQ1	MONEY,
	AnnualEstGrossReforecastQ2	MONEY,
	AnnualEstGrossReforecastQ3	MONEY,
	AnnualEstNetBudget			MONEY,
	AnnualEstNetReforecastQ1	MONEY,
	AnnualEstNetReforecastQ2	MONEY,
	AnnualEstNetReforecastQ3	MONEY
)
DECLARE @cmdString Varchar(8000)

-- Get actual information
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginator
SELECT 	
	gac.GlAccountCategoryKey,
    pa.AllocationRegionKey,
    pa.OriginatingRegionKey,
    pa.FunctionalDepartmentKey,
    pa.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101) as EntryDate,
    ISNULL(pa.[User], '''''''') [User],
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END as Description,
    CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END as AdditionalDescription,
    ISNULL(pa.PropertyFundCode, '''''''') PropertyFundCode,
    ISNULL(pa.OriginatingRegionCode, '''''''') OriginatingRegionCode,
    ISNULL(pa.FunctionalDepartmentCode, '''''''') FunctionalDepartmentCode,
    pa.GlAccountKey,
    
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- MtdGrossReforecast --------------------------*/ + ''
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,		
	
	'' + /*-- MtdGrossReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,		
	
	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,				
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	'')
	DECLARE @cmdString2 VARCHAR(8000)
	SET @cmdString2 = (SELECT ''		
	
	SUM(
		er.Rate * r.MultiplicationFactor * 
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pa.LocalActual
		ELSE
			0
		END
	) as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,

	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualGrossBudget,
	
	'' + /*-- AnnualGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''

	NULL as AnnualNetBudget,
		
	'' + /*-- AnnualNetReforecast --------------------------*/ + ''
	
    NULL as AnnualNetReforecastQ1,
    NULL as AnnualNetReforecastQ2,
    NULL as AnnualNetReforecastQ3,		
	
	'' + /*-- AnnualNetReforecast End --------------------------*/ + ''
	
		'')
	DECLARE @cmdString3 VARCHAR(8000)
	SET @cmdString3 = (SELECT ''	
	
	SUM(
        er.Rate *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
	) as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''

    SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pa.LocalActual
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
    '' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3		
	
	'' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''

FROM
	ProfitabilityActual pa

	INNER JOIN Overhead oh ON oh.OverheadKey = pa.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pa.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pa.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pa.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pa.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pa.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pa.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pa.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pa.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')
			
    INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pa.LocalCurrencyKey AND er.CalendarKey = pa.CalendarKey
	INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
	INNER JOIN Calendar c ON c.CalendarKey = pa.CalendarKey
	INNER JOIN Source s ON s.SourceKey = pa.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pa.ReimbursableKey ''

    + CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pa.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pa.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pa.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pa.ActivityTypeKey'' ELSE '''' END +
    + CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pa.PropertyFundKey'' ELSE '''' END + ''

WHERE  1 = 1
	AND c.CalendarYear = '' + STR(@CalendarYear,4,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select t1.FunctionalDepartmentKey From #FunctionalDepartmentFilterTable t1)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select t1.ActivityTypeKey From #ActivityTypeFilterTable t1)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select t1.PropertyFundKey From #EntityFilterTable t1)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationRegionFilterTable t1)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select t1.AllocationRegionKey From #AllocationSubRegionFilterTable t1)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MajorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select t1.GlAccountCategoryKey From #MinorAccountCategoryFilterTable t1)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingRegionFilterTable t1)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select t1.OriginatingRegionKey From #OriginatingSubRegionFilterTable t1)'' END +
''
GROUP BY
	gac.GlAccountCategoryKey,
	pa.AllocationRegionKey,
	pa.OriginatingRegionKey,
	pa.FunctionalDepartmentKey,
	pa.PropertyFundKey,
	c.CalendarPeriod,
	s.SourceName,
	CONVERT(varchar(10),ISNULL(pa.EntryDate,''''''''), 101),
	ISNULL(pa.[User], ''''''''),
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.Description ELSE '''''''' END,
	CASE WHEN gac.AccountSubTypeName = ''''Non-Payroll'''' THEN pa.AdditionalDescription ELSE '''''''' END,
	ISNULL(pa.PropertyFundCode, ''''''''),
	ISNULL(pa.OriginatingRegionCode, ''''''''),
	ISNULL(pa.FunctionalDepartmentCode, ''''''''),
	pa.GlAccountKey
'')

IF (LEN(@cmdString) > 7995 OR LEN(@cmdString2) > 7995 OR LEN(@cmdString3) > 7995)
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LTRIM(RTRIM(LEN(@cmdString)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString2)))) + '' + '' + STR(LTRIM(RTRIM(LEN(@cmdString3)))))

PRINT @cmdString
PRINT @cmdString2
PRINT @cmdString3

EXEC (@cmdString + @cmdString2 + @cmdString3)

-----------------------------------------------------------------------------------------------------
-- Get budget information
SET @cmdString = (SELECT ''
INSERT INTO #BudgetOriginator
SELECT 	
	gac.GlAccountCategoryKey,
    pb.AllocationRegionKey,
    pb.OriginatingRegionKey,
    pb.FunctionalDepartmentKey,
    pb.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END,
    
    NULL as MtdGrossActual,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as MtdGrossBudget,
	
	NULL as MtdGrossReforecastQ1,
	NULL as MtdGrossReforecastQ2,
	NULL as MtdGrossReforecastQ3,
	
	NULL as MtdNetActual,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as MtdNetBudget,
    
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
	NULL as MtdNetReforecastQ3,
	
	NULL as YtdGrossActual,	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as YtdGrossBudget,
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	NULL as YtdNetActual, 
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as YtdNetBudget,
    
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	SUM(er.Rate * pb.LocalBudget) as AnnualGrossBudget,
	
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	SUM(er.Rate * r.MultiplicationFactor * pb.LocalBudget) as AnnualNetBudget,
	
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,	

	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pb.LocalBudget
		ELSE
			0
		END
	) as AnnualEstGrossBudget,
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,

	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pb.LocalBudget
        ELSE 
			0
        END
    ) as AnnualEstNetBudget,
    
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3
    
FROM
	ProfitabilityBudget pb 
	
	INNER JOIN Overhead oh ON oh.OverheadKey = pb.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1
	
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pb.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pb.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pb.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pb.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pb.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pb.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pb.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pb.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pb.LocalCurrencyKey AND er.CalendarKey = pb.CalendarKey
	INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
	INNER JOIN Calendar c ON c.CalendarKey = pb.CalendarKey
	INNER JOIN Source s ON s.SourceKey = pb.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pb.ReimbursableKey ''
    			
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pb.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pb.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pb.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pb.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pb.PropertyFundKey'' ELSE '''' END + ''
    
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,4,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
    gac.GlAccountCategoryKey,
    pb.AllocationRegionKey,
    pb.OriginatingRegionKey,
    pb.FunctionalDepartmentKey,
    pb.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pb.GlAccountKey END
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)))

print @cmdString
EXEC (@cmdString)

--------------------------------------------------------------------------------------------------------------------------
-- Get Q1 reforecast information
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginator
SELECT 	
	gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- MtdGrossReforecast --------------------------*/ + ''
	
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ1,
	NULL  as MtdGrossReforecastQ2,
	NULL  as MtdGrossReforecastQ3,
	
	'' + /*-- MtdGrossReforecast End --------------------------*/ + ''
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ1,
    NULL as MtdNetReforecastQ2,
    NULL as MtdNetReforecastQ3,    
	
	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
	NULL as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ1, 
	NULL as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	NULL as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ1,
	NULL  as YtdNetReforecastQ2,
	NULL  as YtdNetReforecastQ3,
	
	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualGrossBudget,
	
	'' + /*-- AnnualGrossReforecast --------------------------*/ + ''
		
	SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''

	NULL as AnnualNetBudget,
	
	'' + /*-- AnnualNetReforecast --------------------------*/ + ''
	
	SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,

	'' + /*-- AnnualNetReforecast End --------------------------*/ + ''

	NULL as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN 
			pr.LocalReforecast
		ELSE
			0
		END
	) as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,		
	
	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstNetBudget,
	
	'' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
	
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ1,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3        
    
    '' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
    
FROM
	ProfitabilityReforecast pr 
	
	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
	INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
	INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
	INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
	INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    			
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
    
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,4,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ1,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
	
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)


--------------------------------------------------------------------------------------------------------------------------
-- Get Q2 reforecast information
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginator
SELECT 	
	gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- MtdGrossReforecast --------------------------*/ + ''
	
	NULL  as MtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ2,
	NULL  as MtdGrossReforecastQ3,
	
	'' + /*-- MtdGrossReforecast End --------------------------*/ + ''
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ2,
    NULL as MtdNetReforecastQ3,    
	
	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
	NULL as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ2,
	NULL as YtdGrossReforecastQ3,
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	NULL as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ2,
	NULL as YtdNetReforecastQ3,
	
	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualGrossBudget,
	
	'' + /*-- AnnualGrossReforecast --------------------------*/ + ''
		
	NULL as AnnualGrossReforecastQ1,
	SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ2,
	NULL as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''

	NULL as AnnualNetBudget,
	
	'' + /*-- AnnualNetReforecast --------------------------*/ + ''
	
	NULL as AnnualNetReforecastQ1,
	SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ2,
	NULL as AnnualNetReforecastQ3,
	
	'' + /*-- AnnualNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN 
			pr.LocalReforecast
		ELSE
			0
		END
	) as AnnualEstGrossReforecastQ2,
	NULL as AnnualEstGrossReforecastQ3,		
	
	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstNetBudget,
	
	'' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
	
	NULL as AnnualEstNetReforecastQ1,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ2,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ2,
	NULL as AnnualEstNetReforecastQ3        
    
    '' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
    
FROM
	ProfitabilityReforecast pr 
	
	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
	INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
	INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
	INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
	INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    			
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
    
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,4,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ2,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
	
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

--------------------------------------------------------------------------------------------------------------------------
-- Get Q3 reforecast information
SET @cmdString = (Select ''
INSERT INTO #BudgetOriginator
SELECT 	
	gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    '''''''' as EntryDate,
    '''''''' as [User],
    '''''''' as Description,
    '''''''' as AdditionalDescription,
    '''''''' as PropertyFundCode,
    '''''''' as OriginatingRegionCode,
    '''''''' as FunctionalDepartmentCode,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END,
    
	NULL as MtdGrossActual,
	NULL as MtdGrossBudget,
	
	'' + /*-- MtdGrossReforecast --------------------------*/ + ''
	
	NULL  as MtdGrossReforecastQ1,
	NULL  as MtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as MtdGrossReforecastQ3,
	
	'' + /*-- MtdGrossReforecast End --------------------------*/ + ''
	
	NULL as MtdNetActual,
	NULL as MtdNetBudget,
	
	'' + /*-- MtdNetReforecast --------------------------*/ + ''
	
	NULL as MtdNetReforecastQ1,
	NULL as MtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod = '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as MtdNetReforecastQ3, 
	
	'' + /*-- MtdNetReforecast End --------------------------*/ + ''
	
	NULL as YtdGrossActual,
	NULL as YtdGrossBudget,
	
	'' + /*-- YtdGrossReforecast --------------------------*/ + ''
	
	NULL as YtdGrossReforecastQ1,
	NULL as YtdGrossReforecastQ2,
	SUM(
		er.Rate * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN
			pr.LocalReforecast
		ELSE
			0
		END
	) as YtdGrossReforecastQ3,
	
	'' + /*-- YtdGrossReforecast End --------------------------*/ + ''
	
	NULL as YtdNetActual,
	NULL as YtdNetBudget,
	
	'' + /*-- YtdNetReforecast --------------------------*/ + ''
	
	NULL as YtdNetReforecastQ1,
	NULL as YtdNetReforecastQ2,
    SUM(
        er.Rate * r.MultiplicationFactor * '' +
        /*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
        /*Remember that reforecast... actuals will get pulled here if it''s available (i.e we import it)*/
        ''CASE WHEN (c.CalendarPeriod <= '' + STR(@ReportExpensePeriod,6,0) + '') THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as YtdNetReforecastQ3,
	
	'' + /*-- YtdNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualGrossBudget,
	
	'' + /*-- AnnualGrossReforecast --------------------------*/ + ''
		
	NULL as AnnualGrossReforecastQ1,
	NULL as AnnualGrossReforecastQ2,
	SUM(er.Rate * pr.LocalReforecast) as AnnualGrossReforecastQ3,

	'' + /*-- AnnualGrossReforecast End --------------------------*/ + ''

	NULL as AnnualNetBudget,
	
	'' + /*-- AnnualNetReforecast --------------------------*/ + ''
	
	NULL as AnnualNetReforecastQ1,
	NULL as AnnualNetReforecastQ2,
	SUM (er.Rate * r.MultiplicationFactor * pr.LocalReforecast)as AnnualNetReforecastQ3,
	
	'' + /*-- AnnualNetReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstGrossBudget,
	
	'' + /*-- AnnualEstGrossReforecast --------------------------*/ + ''
	
	NULL as AnnualEstGrossReforecastQ1,
	NULL as AnnualEstGrossReforecastQ2,
	SUM(
		er.Rate *
		CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN 
			pr.LocalReforecast
		ELSE
			0
		END
	) as AnnualEstGrossReforecastQ3,
	
	'' + /*-- AnnualEstGrossReforecast End --------------------------*/ + ''
	
	NULL as AnnualEstNetBudget,
	
	'' + /*-- AnnualEstNetReforecast --------------------------*/ + ''
	
	NULL as AnnualEstNetReforecastQ1,
	NULL as AnnualEstNetReforecastQ2,
	SUM(
        er.Rate * r.MultiplicationFactor *
        CASE WHEN (c.CalendarPeriod > '' + STR(@ReportExpensePeriod,6,0) + 
			/*Hack to pull non-payroll actuals from the grinder for Q1, 201003... yes 201003 Q1. (Ask MikeC)*/ 
			/*Don''t use the category mapping here like for actual exclude because we want unknowns to come through*/
			''
				 OR (
						LEFT(pr.ReferenceCode,3) = ''''BC:''''
						AND '' + STR(@ReforecastEffectivePeriodQ3,6,0) + '' IN (201003, 201006, 201009)
					)
				 ) THEN 
			pr.LocalReforecast
        ELSE 
			0
        END
    ) as AnnualEstNetReforecastQ3
    
    '' + /*-- AnnualEstNetReforecast End --------------------------*/ + ''
    
FROM
	ProfitabilityReforecast pr 
	
	INNER JOIN Overhead oh ON oh.OverheadKey = pr.OverheadKey
		AND OverHeadCode IN (''''UNKNOWN'''', '''''' + @OverheadCode + '''''') -- GC :: Change Control 1

	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = '' + CASE 
			WHEN @TranslationTypeName = ''EU Corporate'' THEN ''pr.EUCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Property'' THEN ''pr.USPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Fund'' THEN ''pr.USFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Property'' THEN ''pr.EUPropertyGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''US Corporate'' THEN ''pr.USCorporateGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Development'' THEN ''pr.DevelopmentGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''EU Fund'' THEN ''pr.EUFundGlAccountCategoryKey'' 
			WHEN @TranslationTypeName = ''Global'' THEN ''pr.GlobalGlAccountCategoryKey'' 
			ELSE ''break:not valid hierarchyname'' END + ''
			AND gac.FeeOrExpense IN (''''EXPENSE'''',''''UNKNOWN'''')

	INNER JOIN #ExchangeRate er ON er.SourceCurrencyKey = pr.LocalCurrencyKey AND er.CalendarKey = pr.CalendarKey
	INNER JOIN Currency dc ON er.DestinationCurrencyKey = dc.CurrencyKey
	INNER JOIN Calendar c ON c.CalendarKey = pr.CalendarKey
	INNER JOIN Reforecast ref ON ref.ReforecastKey = pr.ReforecastKey
	INNER JOIN Source s ON s.SourceKey = pr.SourceKey
    INNER JOIN Reimbursable r ON r.ReimbursableKey = pr.ReimbursableKey ''
    			
	+ CASE WHEN @AllocationRegionList IS NOT NULL OR @AllocationSubRegionList IS NOT NULL THEN '' INNER JOIN AllocationRegion ar ON  ar.AllocationRegionKey = pr.AllocationRegionKey '' ELSE '''' END +
    + CASE WHEN @OriginatingRegionList IS NOT NULL OR @OriginatingSubRegionList IS NOT NULL THEN '' INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = pr.OriginatingRegionKey '' ELSE '''' END +
    + CASE WHEN @FunctionalDepartmentList IS NOT NULL THEN '' INNER JOIN FunctionalDepartment fd ON  fd.FunctionalDepartmentKey = pr.FunctionalDepartmentKey '' ELSE '''' END +
    + CASE WHEN @ActivityTypeList IS NOT NULL THEN '' INNER JOIN ActivityType a ON  a.ActivityTypeKey = pr.ActivityTypeKey'' ELSE '''' END +
	+ CASE WHEN @EntityList IS NOT NULL THEN '' INNER JOIN PropertyFund pf ON pf.PropertyFundKey = pr.PropertyFundKey'' ELSE '''' END + ''
    
WHERE  1 = 1 
	AND c.CalendarYear = '' + STR(@CalendarYear,4,0) + ''
	AND ref.ReforecastEffectivePeriod = '' + STR(@ReforecastEffectivePeriodQ3,10,0) + ''
	AND dc.CurrencyCode = '''''' + @DestinationCurrency + ''''''
	AND gac.MinorCategoryName <> ''''Architects & Engineering'''' /* IMS 51655 */
''
+ CASE WHEN @FunctionalDepartmentList IS NULL THEN '''' ELSE '' AND fd.FunctionalDepartmentKey IN (Select FunctionalDepartmentKey From #FunctionalDepartmentFilterTable)'' END +
+ CASE WHEN @ActivityTypeList IS NULL THEN '''' ELSE '' AND a.ActivityTypeKey IN (Select ActivityTypeKey From #ActivityTypeFilterTable)'' END +
+ CASE WHEN @EntityList IS NULL THEN '''' ELSE '' AND pf.PropertyFundKey IN (Select PropertyFundKey From #EntityFilterTable)'' END +
+ CASE WHEN @AllocationRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationRegionFilterTable)'' END +
+ CASE WHEN @AllocationSubRegionList IS NULL THEN '''' ELSE '' AND ar.AllocationRegionKey IN (Select AllocationRegionKey From #AllocationSubRegionFilterTable)'' END +
+ CASE WHEN @MajorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MajorAccountCategoryFilterTable)'' END +
+ CASE WHEN @MinorAccountCategoryList IS NULL THEN '''' ELSE '' AND gac.GlAccountCategoryKey IN (Select GlAccountCategoryKey From #MinorAccountCategoryFilterTable)'' END +
+ CASE WHEN @OriginatingRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingRegionFilterTable)'' END +
+ CASE WHEN @OriginatingSubRegionList IS NULL THEN '''' ELSE '' AND orr.OriginatingRegionKey IN (Select OriginatingRegionKey From #OriginatingSubRegionFilterTable)'' END +
''
GROUP BY
    gac.GlAccountCategoryKey,
    pr.AllocationRegionKey,
    pr.OriginatingRegionKey,
    pr.FunctionalDepartmentKey,
    pr.PropertyFundKey,
    c.CalendarPeriod,
    s.SourceName,
    CASE WHEN gac.MajorCategoryName = ''''Salaries/Taxes/Benefits'''' THEN NULL ELSE pr.GlAccountKey END
	
'')

IF (LEN(@cmdString)) > 7995
BEGIN
	RAISERROR(''The dynamic sql statement is greater than 7995 characters in length, which is the maximum. Cowardly aborting ...'',9,1)
END

PRINT (''Total dynamic sql statement size: '' + STR(LEN(@cmdString)) + '''')

PRINT @cmdString
EXEC (@cmdString)

-----------------------------------------------------------------------------------------------------------------------    
SELECT 
	gac.AccountSubTypeName ExpenseType,
    ar.RegionName AS AllocationRegionName,
    ar.SubRegionName AS AllocationSubRegionName,
    orr.RegionName AS OriginatingRegionName,
    orr.SubRegionName AS OriginatingSubRegionName,
    fd.FunctionalDepartmentName AS FunctionalDepartmentName,
    fd.SubFunctionalDepartmentName AS JobCode,
    gac.MajorCategoryName AS MajorExpenseCategoryName,
    gac.MinorCategoryName AS MinorExpenseCategoryName,
    pf.PropertyFundType AS EntityType,
    pf.PropertyFundName AS EntityName,
    res.CalendarPeriod AS ExpensePeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
    res.SourceName AS SourceName,
    res.PropertyFundCode PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END AS OriginatingRegionCode,
    --res.OriginatingRegionCode OriginatingRegionCode,
    ISNULL(ga.Code, '''') GlAccountCode,
    ISNULL(ga.Name, '''') GlAccountName,
    
	--Month to date    
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossActual,0) ELSE ISNULL(MtdNetActual,0) END) AS MtdActual,
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(MtdGrossBudget,0) ELSE ISNULL(MtdNetBudget,0) END) AS MtdOriginalBudget,
	
	----- MtdReforecast
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1
		END,0) 
	END) 
	AS MtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2 
		END,0) 
	END) 
	AS MtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3 
		END,0) 
	END) 
	AS MtdReforecastQ3,		
	----- MtdReforecast End
	
	----- MtdVariance
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ1 
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ1 
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ2 
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ2 
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdGrossBudget 
		ELSE 
			MtdGrossReforecastQ3 
		END, 0) - ISNULL(MtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			MtdNetBudget 
		ELSE 
			MtdNetReforecastQ3 
		END, 0) - ISNULL(MtdNetActual, 0) 
	END) 
	AS MtdVarianceQ3,		
	----- MtdVariance End
	
	--Year to date
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossActual,0) ELSE ISNULL(YtdNetActual,0) END) AS YtdActual,	
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(YtdGrossBudget,0) ELSE ISNULL(YtdNetBudget,0) END) AS YtdOriginalBudget,
	
	----- YtdReforecast
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1 
		END,0) 
	END) 
	AS YtdReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2 
		END,0) 
	END) 
	AS YtdReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3 
		END,0) 
	END) 
	AS YtdReforecastQ3,		
	----- YtdReforecast End
	
	----- YtdVariance
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ1 
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ1 
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ2 
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ2 
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdGrossBudget 
		ELSE 
			YtdGrossReforecastQ3 
		END, 0) - ISNULL(YtdGrossActual, 0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			YtdNetBudget 
		ELSE 
			YtdNetReforecastQ3 
		END, 0) - ISNULL(YtdNetActual, 0) 
	END) 
	AS YtdVarianceQ3,		
	----- YtdVariance End
	
	--Annual
	SUM(CASE WHEN (@IsGross = 1) THEN ISNULL(AnnualGrossBudget,0) ELSE ISNULL(AnnualNetBudget,0) END) AS AnnualOriginalBudget,	
	
	----- AnnualReforecast
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ1 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ1 
		END,0) 
	END) 
	AS AnnualReforecastQ1,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualGrossBudget 
		ELSE 
			AnnualGrossReforecastQ2 
		END,0) 
	ELSE 
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 
			AnnualNetBudget 
		ELSE 
			AnnualNetReforecastQ2 
		END,0) 
	END)
	AS AnnualReforecastQ2,
	--
	SUM(CASE WHEN (@IsGross = 1) THEN
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualGrossBudget
		ELSE
			AnnualGrossReforecastQ3
		END,0)
	ELSE
		ISNULL(CASE WHEN @ReforecastQuaterName = ''Q0'' THEN
			AnnualNetBudget
		ELSE
			AnnualNetReforecastQ3
		END,0)
	END)
	AS AnnualReforecastQ3	
	----- AnnualReforecast End
	
	--SUM(CASE WHEN (@IsGross = 1) THEN 
	--	ISNULL(CASE WHEN @PreviousReforecastQuaterName = ''Q1'' THEN 
	--		AnnualGrossReforecastQ1 		
	--	END,0) 
	--ELSE 
	--	ISNULL(CASE WHEN @PreviousReforecastQuaterName = ''Q1'' THEN 
	--		AnnualNetReforecastQ1	
	--	END,0) 
	--END) 
	--AS AnnualReforecastQ1

INTO
	#Output
FROM
	#BudgetOriginator res
	INNER JOIN AllocationRegion ar ON ar.AllocationRegionKey = res.AllocationRegionKey
	INNER JOIN OriginatingRegion orr ON orr.OriginatingRegionKey = res.OriginatingRegionKey
	INNER JOIN PropertyFund pf ON pf.PropertyFundKey = res.PropertyFundKey
	INNER JOIN FunctionalDepartment fd ON fd.FunctionalDepartmentKey = res.FunctionalDepartmentKey
	INNER JOIN GlAccountCategory gac ON gac.GlAccountCategoryKey = res.GlAccountCategoryKey 
	LEFT OUTER JOIN GlAccount ga ON ga.GlAccountKey = res.GlAccountKey 
GROUP BY	
	gac.AccountSubTypeName,
    ar.RegionName,
    ar.SubRegionName,
    orr.RegionName,
    orr.SubRegionName,
    fd.FunctionalDepartmentName,
    fd.SubFunctionalDepartmentName,
    gac.MajorCategoryName,
    gac.MinorCategoryName,
    pf.PropertyFundType,
    pf.PropertyFundName,
    res.CalendarPeriod,
    res.EntryDate,
    res.[User],
    res.[Description],
    res.AdditionalDescription,
    res.SourceName,
    res.PropertyFundCode,
    CASE WHEN (SUBSTRING(res.SourceName, CHARINDEX('' '', res.SourceName) +1, 8) = ''Property'') THEN RTRIM(res.OriginatingRegionCode) + LTRIM(res.FunctionalDepartmentCode) ELSE res.OriginatingRegionCode END,
    --res.OriginatingRegionCode,
    ISNULL(ga.Code, ''''),
    ISNULL(ga.Name, '''')
	
--Output
SELECT
	ExpenseType,
    AllocationRegionName,
    AllocationSubRegionName,
    OriginatingRegionName,
    OriginatingSubRegionName,
    FunctionalDepartmentName,
    JobCode,
    MajorExpenseCategoryName,
    MinorExpenseCategoryName,
    EntityType,
    EntityName,
    ExpensePeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
    SourceName,
    PropertyFundCode,
    OriginatingRegionCode,
    GlAccountCode,
    GlAccountName,
    
	--Month to date    
	MtdActual,
	MtdOriginalBudget,
	
	MtdReforecastQ1,
	--MtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE MtdReforecastQ3 END AS MtdReforecastQ3,
	
	MtdVarianceQ1,
	--MtdVarianceQ2,
	--MtdVarianceQ3,
		
	--Year to date
	YtdActual,	
	YtdOriginalBudget,
	
	YtdReforecastQ1,
	--YtdReforecastQ2,
	--CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE YtdReforecastQ3 END AS YtdReforecastQ3,
	
	YtdVarianceQ1,
	--YtdVarianceQ2,
	--YtdVarianceQ3,
	
	--Annual
	AnnualOriginalBudget,
	
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ1 END AS AnnualReforecastQ1,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ2 END AS AnnualReforecastQ2,
	CASE WHEN @ReforecastQuaterName = ''Q0'' THEN 0 ELSE AnnualReforecastQ3 END AS AnnualReforecastQ3
	
	--Annual Estimated
	--AnnualEstimatedActual,	
	--AnnualEstimatedVariance
FROM
	#Output
WHERE
	--Month to date    
	MtdActual <> 0.00 OR
	MtdOriginalBudget <> 0.00 OR
	
	
	MtdReforecastQ1 <> 0.00 OR
	--MtdReforecastQ2 <> 0.00 OR
	--MtdReforecastQ3 <> 0.00 OR
	
		
	MtdVarianceQ1 <> 0.00 OR
	--MtdVarianceQ2 <> 0.00 OR
	--MtdVarianceQ3 <> 0.00 OR
			
	--Year to date
	YtdActual <> 0.00 OR	
	YtdOriginalBudget <> 0.00 OR
	
	
	YtdReforecastQ1 <> 0.00 OR
	--YtdReforecastQ2 <> 0.00 OR
	--YtdReforecastQ3 <> 0.00 OR
	
	
	YtdVarianceQ1 <> 0.00 OR
	--YtdVarianceQ2 <> 0.00 OR
	--YtdVarianceQ3 <> 0.00 OR
		
	--Annual
	AnnualOriginalBudget <> 0.00 OR
	
	
	AnnualReforecastQ1 <> 0.00
	--AnnualReforecastQ2 <> 0.00 OR
	--AnnualReforecastQ3 <> 0.00
	
	
	--Annual Estimated
	--AnnualEstimatedActual <> 0.00 OR	
	--AnnualEstimatedVariance <> 0.00
	
IF OBJECT_ID(''tempdb..#BudgetOriginator'') IS NOT NULL
    DROP TABLE #BudgetOriginator

IF 	OBJECT_ID(''tempdb..#Output'') IS NOT NULL
    DROP TABLE #Output

IF 	OBJECT_ID(''tempdb..#EntityFilterTable'') IS NOT NULL
	DROP TABLE #EntityFilterTable

IF 	OBJECT_ID(''tempdb..#FunctionalDepartmentFilterTable'') IS NOT NULL
	DROP TABLE #FunctionalDepartmentFilterTable

IF 	OBJECT_ID(''tempdb..#ActivityTypeFilterTable'') IS NOT NULL
	DROP TABLE #ActivityTypeFilterTable

IF 	OBJECT_ID(''tempdb..#AllocationRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationRegionFilterTable

IF 	OBJECT_ID(''tempdb..#AllocationSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #AllocationSubRegionFilterTable

IF 	OBJECT_ID(''tempdb..#MajorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MajorAccountCategoryFilterTable

IF 	OBJECT_ID(''tempdb..#MinorAccountCategoryFilterTable'') IS NOT NULL
	DROP TABLE #MinorAccountCategoryFilterTable

IF 	OBJECT_ID(''tempdb..#OriginatingRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingRegionFilterTable

IF 	OBJECT_ID(''tempdb..#OriginatingSubRegionFilterTable'') IS NOT NULL
	DROP TABLE #OriginatingSubRegionFilterTable


' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ProfitabilityV2]    Script Date: 05/05/2011 10:41:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_R_ProfitabilityV2]') AND type in (N'P', N'PC'))
BEGIN

USE [GrReporting]
GO
/****** Object:  StoredProcedure [dbo].[stp_R_ProfitabilityV2]    Script Date: 04/21/2011 10:27:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[stp_R_ProfitabilityV2]
	@ReportExpensePeriod INT = NULL,
	@ReforecastQuaterName VARCHAR(10) = NULL, --'Q1' or 'Q2' or 'Q3'
	@DestinationCurrency VARCHAR(3) = NULL,
	@TranslationTypeName VARCHAR(50) = 'Global',
	@IsGross Bit=NULL, --not used, just placeholder
	@FunctionalDepartmentList TEXT = NULL,
	@ActivityTypeList TEXT = NULL,
	@EntityList TEXT = NULL,
	@MajorAccountCategoryList TEXT = NULL,
	@MinorAccountCategoryList TEXT = NULL,
	@AllocationRegionList TEXT = NULL,
	@AllocationSubRegionList TEXT = NULL,
	@OriginatingRegionList TEXT = NULL,
	@OriginatingSubRegionList TEXT = NULL,
	@DisplayOverheadBy Varchar(12)='Allocated', --alloc / unalloc

	--Customized Filter Logic Specific to this Report
	@IncludeGrossNonPayrollExpenses TinyInt = NULL,
	@IncludeFeeAdjustments TinyInt = NULL,
	@DisplayFeeAdjustmentsBy Varchar(20) = NULL,
	@OverheadOriginatingSubRegionList TEXT = NULL 
	

AS


IF ISNULL(@DisplayOverheadBy,'') NOT IN ('Allocated','Unallocated')
	BEGIN
	RAISERROR ('@DisplayOverheadBy have invalid value (Must be one of:Allocated,Unallocated)',18,1)
	RETURN
	END

IF (@IncludeFeeAdjustments = 1 AND ISNULL(@DisplayFeeAdjustmentsBy,'') NOT IN ('AllocationRegion','ReportingEntity'))
	BEGIN
	RAISERROR ('@DisplayFeeAdjustmentsBy have invalid value (Must be one of:AllocationRegion,ReportingEntity)',18,1)
	RETURN
	END
	
IF @ReforecastQuaterName IS NULL OR @ReforecastQuaterName NOT IN ('Q0', 'Q1', 'Q2', 'Q3')
	SET @ReforecastQuaterName = (SELECT TOP 1
									ReforecastQuarterName 
								 FROM
									dbo.Reforecast 
								 WHERE
									ReforecastEffectivePeriod <= @ReportExpensePeriod AND 
									ReforecastEffectiveYear = LEFT(CAST(@ReportExpensePeriod AS VARCHAR(6)),4)
								 ORDER BY
									ReforecastEffectivePeriod DESC)

CREATE TABLE #DetailResult(
	ExpenseType varchar(50) NULL,
	FeeOrExpense varchar(50) NULL,
	MajorExpenseCategoryName varchar(100) NULL,
	MinorExpenseCategoryName varchar(100) NULL,
	GlobalGlAccountCode varchar(50) NULL,
	GlobalGlAccountName varchar(150) NULL,
	BusinessLine varchar(50) NULL,
	ActivityType varchar(50) NULL,
	ReportingEntityName varchar(100) NULL,
	
	PropertyFundCode varchar(6) NULL,
	FunctionalDepartmentCode varchar(15) NULL,
	AllocationSubRegionName varchar(50) NULL,
	OriginatingSubRegionName varchar(50) NULL,

	ActualsExpensePeriod Varchar(6) NULL,
	EntryDate varchar(10) NULL,
	[User] nvarchar(20) NULL,
	Description nvarchar(60) NULL,
	AdditionalDescription nvarchar(4000) NULL,
	ReimbursableName varchar(50) NULL,
	FeeAdjustmentCode varchar(10) NULL,
	SourceName varchar(50) NULL,
	GlAccountCategoryKey int not null,
	
	MtdActual money NULL,
	MtdOriginalBudget money NULL,
	MtdReforecastQ1 money NULL,
	MtdReforecastQ2 money NULL,
	MtdReforecastQ3 money NULL,
	MtdVarianceQ0 money NULL,
	MtdVarianceQ1 money NULL,
	MtdVarianceQ2 money NULL,
	MtdVarianceQ3 money NULL,
	YtdActual money NULL,
	YtdOriginalBudget money NULL,
	YtdReforecastQ1 money NULL,
	YtdReforecastQ2 money NULL,
	YtdReforecastQ3 money NULL,
	YtdVarianceQ0 money NULL,
	YtdVarianceQ1 money NULL,
	YtdVarianceQ2 money NULL,
	YtdVarianceQ3 money NULL,
	AnnualOriginalBudget money NULL,
	AnnualReforecastQ1 money NULL,
	AnnualReforecastQ2 money NULL,
	AnnualReforecastQ3 money NULL
)

Insert Into #DetailResult
(	ExpenseType, 
	FeeOrExpense,
    MajorExpenseCategoryName,
    MinorExpenseCategoryName,
	GlobalGlAccountCode,
	GlobalGlAccountName,
    BusinessLine,
    ActivityType,
	ReportingEntityName,
	PropertyFundCode,
	FunctionalDepartmentCode,
	AllocationSubRegionName,
	OriginatingSubRegionName,
	ActualsExpensePeriod,
    EntryDate,
    [User],
    [Description],
    AdditionalDescription,
	ReimbursableName,
	FeeAdjustmentCode,
	SourceName,
	GlAccountCategoryKey,

	--Gross
	--Month to date    
	MtdActual,
	MtdOriginalBudget,
	MtdReforecastQ1,
	MtdReforecastQ2,
	MtdReforecastQ3,

	MtdVarianceQ0,
	MtdVarianceQ1,
	MtdVarianceQ2,
	MtdVarianceQ3,
	
	--Year to date
	YtdActual,	
	YtdOriginalBudget,
	YtdReforecastQ1,
	YtdReforecastQ2,
	YtdReforecastQ3,

	YtdVarianceQ0,
	YtdVarianceQ1,
	YtdVarianceQ2,
	YtdVarianceQ3,
	
	--Annual
	AnnualOriginalBudget,	
	AnnualReforecastQ1,
	AnnualReforecastQ2,
	AnnualReforecastQ3)
	
exec [stp_R_ProfitabilityDetailV2]
	@ReportExpensePeriod = @ReportExpensePeriod,
	@DestinationCurrency = @DestinationCurrency,
	@TranslationTypeName = @TranslationTypeName,
	@FunctionalDepartmentList = @FunctionalDepartmentList,
	@ActivityTypeList = @ActivityTypeList,
	@EntityList = @EntityList,
	@MajorAccountCategoryList = @MajorAccountCategoryList,
	@MinorAccountCategoryList = @MinorAccountCategoryList,
	@AllocationRegionList = @AllocationRegionList,
	@AllocationSubRegionList = @AllocationSubRegionList,
	@OriginatingRegionList = @OriginatingRegionList,
	@OriginatingSubRegionList = @OriginatingSubRegionList,
	@DisplayOverheadBy = @DisplayOverheadBy,
	@OverheadOriginatingSubRegionList = @OverheadOriginatingSubRegionList,
	@IncludeFeeAdjustments = @IncludeFeeAdjustments


--select * Into DetailResult From #DetailResult

--select * Into #DetailResult From DetailResult

			
CREATE TABLE #Result (
	NumberOfSpacesToPad TinyInt NOT NULL,
	GroupDisplayCode Varchar(500) NOT NULL,
	GroupDisplayName Varchar(500) NOT NULL,
	DisplayOrderNumber Int NOT NULL,
	MtdActual money NOT NULL DEFAULT(0),
	MtdOriginalBudget money NOT NULL DEFAULT(0),
	MtdReforecastQ1 money NOT NULL DEFAULT(0),
	MtdReforecastQ2 money NOT NULL DEFAULT(0),
	MtdReforecastQ3 money NOT NULL DEFAULT(0),
	
	MtdVarianceQ0 money NOT NULL DEFAULT(0),
	MtdVarianceQ1 money NOT NULL DEFAULT(0),
	MtdVarianceQ2 money NOT NULL DEFAULT(0),
	MtdVarianceQ3 money NOT NULL DEFAULT(0),

	MtdVariancePercentageQ0 money NOT NULL DEFAULT(0),
	MtdVariancePercentageQ1 money NOT NULL DEFAULT(0),
	MtdVariancePercentageQ2 money NOT NULL DEFAULT(0),
	MtdVariancePercentageQ3 money NOT NULL DEFAULT(0),
	
	YtdActual money NOT NULL DEFAULT(0),
	YtdOriginalBudget money NOT NULL DEFAULT(0),
	YtdReforecastQ1 money NOT NULL DEFAULT(0),
	YtdReforecastQ2 money NOT NULL DEFAULT(0),
	YtdReforecastQ3 money NOT NULL DEFAULT(0),
	
	YtdVarianceQ0 money NOT NULL DEFAULT(0),
	YtdVarianceQ1 money NOT NULL DEFAULT(0),
	YtdVarianceQ2 money NOT NULL DEFAULT(0),
	YtdVarianceQ3 money NOT NULL DEFAULT(0),
	
	YtdVariancePercentageQ0 money NOT NULL DEFAULT(0),
	YtdVariancePercentageQ1 money NOT NULL DEFAULT(0),
	YtdVariancePercentageQ2 money NOT NULL DEFAULT(0),
	YtdVariancePercentageQ3 money NOT NULL DEFAULT(0),
	
	AnnualOriginalBudget money NOT NULL DEFAULT(0),
	AnnualReforecastQ1 money NOT NULL DEFAULT(0),
	AnnualReforecastQ2 money NOT NULL DEFAULT(0),
	AnnualReforecastQ3 money NOT NULL DEFAULT(0)
)

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
VALUES(0,'REVENUE','REVENUE',100)

Insert Into #Result
(NumberOfSpacesToPad,GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
VALUES(0, 'FEEREVENUE', 'Fee Revenue',200)


Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		gac.MinorCategoryName GroupDisplayCode,
		gac.MinorCategoryName,
		201 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0),
		ISNULL(SUM(t1.MtdOriginalBudget),0),
		ISNULL(SUM(t1.MtdReforecastQ1),0),
		ISNULL(SUM(t1.MtdReforecastQ2),0),
		ISNULL(SUM(t1.MtdReforecastQ3),0),
		ISNULL(SUM(t1.MtdVarianceQ0),0),
		ISNULL(SUM(t1.MtdVarianceQ1),0),
		ISNULL(SUM(t1.MtdVarianceQ2),0),
		ISNULL(SUM(t1.MtdVarianceQ3),0),
		ISNULL(SUM(t1.YtdActual),0),
		ISNULL(SUM(t1.YtdOriginalBudget),0),
		ISNULL(SUM(t1.YtdReforecastQ1),0),
		ISNULL(SUM(t1.YtdReforecastQ2),0),
		ISNULL(SUM(t1.YtdReforecastQ3),0),
		ISNULL(SUM(t1.YtdVarianceQ0),0),
		ISNULL(SUM(t1.YtdVarianceQ1),0),
		ISNULL(SUM(t1.YtdVarianceQ2),0),
		ISNULL(SUM(t1.YtdVarianceQ3),0),
		ISNULL(SUM(t1.AnnualOriginalBudget),0),
		ISNULL(SUM(t1.AnnualReforecastQ1),0),
		ISNULL(SUM(t1.AnnualReforecastQ2),0),
		ISNULL(SUM(t1.AnnualReforecastQ3),0)

From 
		GlAccountCategory gac
			LEFT OUTER JOIN (Select * 
							From #DetailResult t1
							Where t1.FeeAdjustmentCode		= 'NORMAL'
							) t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey


Where	gac.FeeOrExpense		= 'INCOME'
AND		gac.MajorCategoryName	= 'Fee Income'
AND		gac.TranslationSubTypeName	= @TranslationTypeName
Group By 
		gac.MinorCategoryName
		
-- Fee adjustment Insert queries removed as per Change Request 13

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'TOTALFEEREVENUE' GroupDisplayCode,
		'Total Fee Revenue',
		203 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0),
		ISNULL(SUM(t1.MtdOriginalBudget),0),
		ISNULL(SUM(t1.MtdReforecastQ1),0),
		ISNULL(SUM(t1.MtdReforecastQ2),0),
		ISNULL(SUM(t1.MtdReforecastQ3),0),
		ISNULL(SUM(t1.MtdVarianceQ0),0),
		ISNULL(SUM(t1.MtdVarianceQ1),0),
		ISNULL(SUM(t1.MtdVarianceQ2),0),
		ISNULL(SUM(t1.MtdVarianceQ3),0),
		ISNULL(SUM(t1.YtdActual),0),
		ISNULL(SUM(t1.YtdOriginalBudget),0),
		ISNULL(SUM(t1.YtdReforecastQ1),0),
		ISNULL(SUM(t1.YtdReforecastQ2),0),
		ISNULL(SUM(t1.YtdReforecastQ3),0),
		ISNULL(SUM(t1.YtdVarianceQ0),0),
		ISNULL(SUM(t1.YtdVarianceQ1),0),
		ISNULL(SUM(t1.YtdVarianceQ2),0),
		ISNULL(SUM(t1.YtdVarianceQ3),0),
		ISNULL(SUM(t1.AnnualOriginalBudget),0),
		ISNULL(SUM(t1.AnnualReforecastQ1),0),
		ISNULL(SUM(t1.AnnualReforecastQ2),0),
		ISNULL(SUM(t1.AnnualReforecastQ3),0)

From #DetailResult t1


Where	t1.FeeOrExpense				= 'INCOME'
AND		t1.MajorExpenseCategoryName = 'Fee Income'	

Insert Into #Result
(NumberOfSpacesToPad,GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
VALUES(0, 'OTHERREVENUE', 'Other Revenue',210)
	
	
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		gac.MajorCategoryName GroupDisplayCode,
		gac.MajorCategoryName,
		211 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0),
		ISNULL(SUM(t1.MtdOriginalBudget),0),
		ISNULL(SUM(t1.MtdReforecastQ1),0),
		ISNULL(SUM(t1.MtdReforecastQ2),0),
		ISNULL(SUM(t1.MtdReforecastQ3),0),
		ISNULL(SUM(t1.MtdVarianceQ0),0),
		ISNULL(SUM(t1.MtdVarianceQ1),0),
		ISNULL(SUM(t1.MtdVarianceQ2),0),
		ISNULL(SUM(t1.MtdVarianceQ3),0),
		ISNULL(SUM(t1.YtdActual),0),
		ISNULL(SUM(t1.YtdOriginalBudget),0),
		ISNULL(SUM(t1.YtdReforecastQ1),0),
		ISNULL(SUM(t1.YtdReforecastQ2),0),
		ISNULL(SUM(t1.YtdReforecastQ3),0),
		ISNULL(SUM(t1.YtdVarianceQ0),0),
		ISNULL(SUM(t1.YtdVarianceQ1),0),
		ISNULL(SUM(t1.YtdVarianceQ2),0),
		ISNULL(SUM(t1.YtdVarianceQ3),0),
		ISNULL(SUM(t1.AnnualOriginalBudget),0),
		ISNULL(SUM(t1.AnnualReforecastQ1),0),
		ISNULL(SUM(t1.AnnualReforecastQ2),0),
		ISNULL(SUM(t1.AnnualReforecastQ3),0)

From GlAccountCategory gac

			LEFT OUTER JOIN #DetailResult t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey


Where	gac.FeeOrExpense		= 'INCOME'
AND		gac.MajorCategoryName	<> 'Fee Income'
AND		gac.MajorCategoryName	<> 'Realized (Gain)/Loss' --IMS #61973
AND		gac.TranslationSubTypeName	= @TranslationTypeName
Group By 
		gac.MajorCategoryName
	

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'TOTALOTHERREVENUE' GroupDisplayCode,
		'Total Other Revenue',
		212 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0),
		ISNULL(SUM(t1.MtdOriginalBudget),0),
		ISNULL(SUM(t1.MtdReforecastQ1),0),
		ISNULL(SUM(t1.MtdReforecastQ2),0),
		ISNULL(SUM(t1.MtdReforecastQ3),0),
		ISNULL(SUM(t1.MtdVarianceQ0),0),
		ISNULL(SUM(t1.MtdVarianceQ1),0),
		ISNULL(SUM(t1.MtdVarianceQ2),0),
		ISNULL(SUM(t1.MtdVarianceQ3),0),
		ISNULL(SUM(t1.YtdActual),0),
		ISNULL(SUM(t1.YtdOriginalBudget),0),
		ISNULL(SUM(t1.YtdReforecastQ1),0),
		ISNULL(SUM(t1.YtdReforecastQ2),0),
		ISNULL(SUM(t1.YtdReforecastQ3),0),
		ISNULL(SUM(t1.YtdVarianceQ0),0),
		ISNULL(SUM(t1.YtdVarianceQ1),0),
		ISNULL(SUM(t1.YtdVarianceQ2),0),
		ISNULL(SUM(t1.YtdVarianceQ3),0),
		ISNULL(SUM(t1.AnnualOriginalBudget),0),
		ISNULL(SUM(t1.AnnualReforecastQ1),0),
		ISNULL(SUM(t1.AnnualReforecastQ2),0),
		ISNULL(SUM(t1.AnnualReforecastQ3),0)

From #DetailResult t1


Where	t1.FeeOrExpense				= 'INCOME'
AND		t1.MajorExpenseCategoryName	<> 'Realized (Gain)/Loss' --IMS #61973
AND		t1.MajorExpenseCategoryName <> 'Fee Income'	


Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'TOTALREVENUE' GroupDisplayCode,
		'Total Revenue',
		220 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0),
		ISNULL(SUM(t1.MtdOriginalBudget),0),
		ISNULL(SUM(t1.MtdReforecastQ1),0),
		ISNULL(SUM(t1.MtdReforecastQ2),0),
		ISNULL(SUM(t1.MtdReforecastQ3),0),
		ISNULL(SUM(t1.MtdVarianceQ0),0),
		ISNULL(SUM(t1.MtdVarianceQ1),0),
		ISNULL(SUM(t1.MtdVarianceQ2),0),
		ISNULL(SUM(t1.MtdVarianceQ3),0),
		ISNULL(SUM(t1.YtdActual),0),
		ISNULL(SUM(t1.YtdOriginalBudget),0),
		ISNULL(SUM(t1.YtdReforecastQ1),0),
		ISNULL(SUM(t1.YtdReforecastQ2),0),
		ISNULL(SUM(t1.YtdReforecastQ3),0),
		ISNULL(SUM(t1.YtdVarianceQ0),0),
		ISNULL(SUM(t1.YtdVarianceQ1),0),
		ISNULL(SUM(t1.YtdVarianceQ2),0),
		ISNULL(SUM(t1.YtdVarianceQ3),0),
		ISNULL(SUM(t1.AnnualOriginalBudget),0),
		ISNULL(SUM(t1.AnnualReforecastQ1),0),
		ISNULL(SUM(t1.AnnualReforecastQ2),0),
		ISNULL(SUM(t1.AnnualReforecastQ3),0)

From #DetailResult t1
Where	t1.FeeOrExpense				= 'INCOME'
AND		t1.MajorExpenseCategoryName	<> 'Realized (Gain)/Loss' --IMS #61973


Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		230 DisplayOrderNumber


Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'EXPENSES' GroupDisplayCode,
		'EXPENSES',
		240 DisplayOrderNumber
		
		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'PAYROLLEXPENSES' GroupDisplayCode,
		'Payroll Expenses',
		241 DisplayOrderNumber


		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'Gross ' + t1.MajorExpenseCategoryName GroupDisplayCode,
		'Gross ' + t1.MajorExpenseCategoryName,
		242 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		
		-- Variance amounts adjusted as per IMS 61749
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From #DetailResult t1
Where	t1.FeeOrExpense				= 'EXPENSE'
AND		t1.MajorExpenseCategoryName = 'Salaries/Bonus/Taxes/Benefits'
AND		t1.ExpenseType				<> 'Overhead'
Group By 
		t1.MajorExpenseCategoryName
		
		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'Reimbursed ' + t1.MajorExpenseCategoryName GroupDisplayCode,
		'Reimbursed ' + t1.MajorExpenseCategoryName,
		243 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From #DetailResult t1
Where	t1.FeeOrExpense				= 'EXPENSE'
AND		t1.MajorExpenseCategoryName = 'Salaries/Bonus/Taxes/Benefits'
AND		t1.ReimbursableName			= 'Reimbursable'
AND		t1.ExpenseType				<> 'Overhead'
Group By 
		t1.MajorExpenseCategoryName	

		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'Total Net ' + t1.MajorExpenseCategoryName GroupDisplayCode,
		'Total Net ' + t1.MajorExpenseCategoryName,
		244 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From #DetailResult t1
Where	t1.FeeOrExpense				= 'EXPENSE'
AND		t1.MajorExpenseCategoryName = 'Salaries/Bonus/Taxes/Benefits'
AND		t1.ReimbursableName			= 'Not Reimbursable'
AND		t1.ExpenseType				<> 'Overhead'
Group By 
		t1.MajorExpenseCategoryName	
		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'Payroll Reimbursement Rate' GroupDisplayCode,
		'% Recovery',
		245 DisplayOrderNumber,
		ISNULL(Reimbursed.MtdActual / CASE WHEN Gross.MtdActual = 0 THEN NULL ELSE Gross.MtdActual END,0),
		ISNULL(Reimbursed.MtdOriginalBudget / CASE WHEN Gross.MtdOriginalBudget = 0 THEN NULL ELSE Gross.MtdOriginalBudget END,0),
		ISNULL(Reimbursed.MtdReforecastQ1 / CASE WHEN Gross.MtdReforecastQ1 = 0 THEN NULL ELSE Gross.MtdReforecastQ1 END,0),
		ISNULL(Reimbursed.MtdReforecastQ2 / CASE WHEN Gross.MtdReforecastQ2 = 0 THEN NULL ELSE Gross.MtdReforecastQ2 END,0),
		ISNULL(Reimbursed.MtdReforecastQ3 / CASE WHEN Gross.MtdReforecastQ3 = 0 THEN NULL ELSE Gross.MtdReforecastQ3 END,0),
		0,
		0,
		0,
		0,
		ISNULL(Reimbursed.YtdActual / CASE WHEN Gross.YtdActual = 0 THEN NULL ELSE Gross.YtdActual END,0),
		ISNULL(Reimbursed.YtdOriginalBudget / CASE WHEN Gross.YtdOriginalBudget = 0 THEN NULL ELSE Gross.YtdOriginalBudget END,0),
		ISNULL(Reimbursed.YtdReforecastQ1 / CASE WHEN Gross.YtdReforecastQ1 = 0 THEN NULL ELSE Gross.YtdReforecastQ1 END,0),
		ISNULL(Reimbursed.YtdReforecastQ2 / CASE WHEN Gross.YtdReforecastQ2 = 0 THEN NULL ELSE Gross.YtdReforecastQ2 END,0),
		ISNULL(Reimbursed.YtdReforecastQ3 / CASE WHEN Gross.YtdReforecastQ3 = 0 THEN NULL ELSE Gross.YtdReforecastQ3 END,0),
		0,
		0,
		0,
		0,
		ISNULL(Reimbursed.AnnualOriginalBudget / CASE WHEN Gross.AnnualOriginalBudget = 0 THEN NULL ELSE Gross.AnnualOriginalBudget END,0),
		ISNULL(Reimbursed.AnnualReforecastQ1 / CASE WHEN Gross.AnnualReforecastQ1 = 0 THEN NULL ELSE Gross.AnnualReforecastQ1 END,0),
		ISNULL(Reimbursed.AnnualReforecastQ2 / CASE WHEN Gross.AnnualReforecastQ2 = 0 THEN NULL ELSE Gross.AnnualReforecastQ2 END,0),
		ISNULL(Reimbursed.AnnualReforecastQ3 / CASE WHEN Gross.AnnualReforecastQ3 = 0 THEN NULL ELSE Gross.AnnualReforecastQ3 END,0)
From 
	(
		Select 
					ISNULL(SUM(t1.MtdActual),0) MtdActual,
					ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
					ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
					ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
					ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
					ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
					ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
					ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
					ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
					ISNULL(SUM(t1.YtdActual),0) YtdActual,
					ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
					ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
					ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
					ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
					ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
					ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
					ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
					ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
					ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
					ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
					ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
					ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

		From #DetailResult t1
		Where	t1.FeeOrExpense				= 'EXPENSE'
		AND		t1.MajorExpenseCategoryName = 'Salaries/Bonus/Taxes/Benefits'
		AND		t1.ReimbursableName			= 'Reimbursable'
		AND		t1.ExpenseType				<> 'Overhead'
		) Reimbursed
		CROSS JOIN 
			(
				Select 
					ISNULL(SUM(t1.MtdActual),0) MtdActual,
					ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
					ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
					ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
					ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
					ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
					ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
					ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
					ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
					ISNULL(SUM(t1.YtdActual),0) YtdActual,
					ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
					ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
					ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
					ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
					ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
					ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
					ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
					ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
					ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
					ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
					ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
					ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

				From #DetailResult t1
				Where	t1.FeeOrExpense				= 'EXPENSE'
				AND		t1.MajorExpenseCategoryName = 'Salaries/Bonus/Taxes/Benefits'
				AND		t1.ExpenseType				<> 'Overhead'
			
			) Gross 
	
--Calculate the Payroll Reimbursement Rate Variance Columns
Update 		#Result
Set			
			MtdVarianceQ0 = (MtdActual - MtdOriginalBudget),
			MtdVarianceQ1 = (MtdActual - MtdReforecastQ1),
			MtdVarianceQ2 = (MtdActual - MtdReforecastQ2),
			MtdVarianceQ3 = (MtdActual - MtdReforecastQ3),
			YtdVarianceQ0 = (YtdActual - YtdOriginalBudget),
			YtdVarianceQ1 = (YtdActual - YtdReforecastQ1),
			YtdVarianceQ2 = (YtdActual - YtdReforecastQ2),
			YtdVarianceQ3 = (YtdActual - YtdReforecastQ3)

Where	GroupDisplayCode = 'Payroll Reimbursement Rate'
AND		DisplayOrderNumber = 245	

	
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		250 DisplayOrderNumber
		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'OVERHEADEXPENSE' GroupDisplayCode,
		'Overhead  Expenses',
		260 DisplayOrderNumber

--Removed due to IMS #62074 
/*
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'GROSSOVERHEADEXPENSE' GroupDisplayCode,
		'Gross Overhead  Expenses',
		261 DisplayOrderNumber
*/

IF @DisplayOverheadBy = 'Unallocated'
	BEGIN

	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			'Gross ' + gac.MajorCategoryName GroupDisplayCode,
			'Gross ' + gac.MajorCategoryName,
			262 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			
			-- Variance amounts adjusted as per IMS 61749
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
			ISNULL(SUM(t1.YtdActual),0) * -1,
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From GlAccountCategory gac

				LEFT OUTER JOIN (Select * 
				From #DetailResult t1 
				Where t1.ExpenseType = 'Overhead') t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
				
	Where	gac.FeeOrExpense			= 'Expense'
	AND		gac.TranslationSubTypeName	= @TranslationTypeName
	AND		gac.AccountSubTypeName		= 'Overhead'
	AND		gac.MajorCategoryName		<> 'Corporate Tax'
	Group By 
			gac.MajorCategoryName	
				
	END
ELSE
	BEGIN

	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			'Gross ' + gac.MajorCategoryName GroupDisplayCode,
			'Gross ' + gac.MajorCategoryName,
			262 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			-- Variance amounts adjusted as per IMS 61749
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
			ISNULL(SUM(t1.YtdActual),0) * -1,
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From GlAccountCategory gac

				INNER JOIN (Select * 
				From #DetailResult t1 
				Where t1.ExpenseType = 'Overhead') t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
				
	Where	gac.FeeOrExpense		= 'Expense'
	AND		gac.TranslationSubTypeName	= @TranslationTypeName
	AND		gac.AccountSubTypeName		= 'Overhead'
	AND		gac.MajorCategoryName		<> 'Corporate Tax'
	Group By 
			gac.MajorCategoryName	
	END

--IMS #62074
/*
IF @DisplayOverheadBy = 'Unallocated'
	BEGIN
	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			'Total Gross Overhead Expense' GroupDisplayCode,
			'Total Gross Overhead Expense',
			263 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			-- Variance amounts adjusted as per IMS 61749
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
			ISNULL(SUM(t1.YtdActual),0) * -1,
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.ReimbursableName = 'Reimbursable' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From #DetailResult t1
	Where	t1.FeeOrExpense		= 'Expense'
	AND		t1.ExpenseType		= 'Overhead'
	AND		t1.MajorExpenseCategoryName <>  'Corporate Tax'

END
*/


--Removed due to IMS #62074 
/*
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'REIMBERSEDOVERHEADEXPENSE' GroupDisplayCode,
		'Reimbursed Overhead  Expenses',
		270 DisplayOrderNumber
*/

IF @DisplayOverheadBy = 'Unallocated'
	BEGIN
		
	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			'Reimbursed ' + gac.MajorCategoryName GroupDisplayCode,
			'Reimbursed ' + gac.MajorCategoryName,
			271 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
			ISNULL(SUM(t1.YtdActual),0) * -1,
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From GlAccountCategory gac

				LEFT OUTER JOIN (Select * 
								From #DetailResult t1
								Where	t1.ExpenseType		= 'Overhead'
								AND		t1.ReimbursableName	= 'Reimbursable'
								) t1
								 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
				
	Where	gac.FeeOrExpense		= 'Expense'
	AND		gac.TranslationSubTypeName	= @TranslationTypeName
	AND		gac.AccountSubTypeName		= 'Overhead'
	AND		gac.MajorCategoryName		<> 'Corporate Tax'
	Group By 
			gac.MajorCategoryName	
	END
ELSE
	BEGIN
	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			'Reimbursed ' + gac.MajorCategoryName GroupDisplayCode,
			'Reimbursed ' + gac.MajorCategoryName,
			271 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
			ISNULL(SUM(t1.YtdActual),0) * -1,
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From GlAccountCategory gac

				INNER JOIN (Select * 
								From #DetailResult t1
								Where	t1.ExpenseType		= 'Overhead'
								AND		t1.ReimbursableName	= 'Reimbursable'
								) t1
								 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
				
	Where	gac.FeeOrExpense		= 'Expense'
	AND		gac.TranslationSubTypeName	= @TranslationTypeName
	AND		gac.AccountSubTypeName		= 'Overhead'
	AND		gac.MajorCategoryName		<> 'Corporate Tax'
	Group By 
			gac.MajorCategoryName	
	END

--IMS #62074
/*			
IF @DisplayOverheadBy = 'Unallocated'
	BEGIN

	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			'Total Reimbursed Overhead Expense' GroupDisplayCode,
			'Total Reimbursed Overhead Expense',
			272 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
			ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
			ISNULL(SUM(t1.YtdActual),0) * -1,
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
			ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From #DetailResult t1
	Where	t1.FeeOrExpense		= 'Expense'
	AND		t1.ExpenseType		= 'Overhead'
	AND		ReimbursableName	= 'Reimbursable'
	AND		t1.MajorExpenseCategoryName <> 'Corporate Tax'
END
*/
		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'Total Net Overhead Expense' GroupDisplayCode,
		'Total Net Overhead Expense',
		273 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From #DetailResult t1
Where	t1.FeeOrExpense		= 'Expense'
AND		t1.ExpenseType		= 'Overhead'
AND		t1.ReimbursableName = 'Not Reimbursable'
AND		t1.MajorExpenseCategoryName <> 'Corporate Tax'


Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'Overhead Reimbursement Rate' GroupDisplayCode,
		'% Recovery',
		274 DisplayOrderNumber,
		ISNULL(Reimbursed.MtdActual / CASE WHEN Gross.MtdActual = 0 THEN NULL ELSE Gross.MtdActual END,0),
		ISNULL(Reimbursed.MtdOriginalBudget / CASE WHEN Gross.MtdOriginalBudget = 0 THEN NULL ELSE Gross.MtdOriginalBudget END,0),
		ISNULL(Reimbursed.MtdReforecastQ1 / CASE WHEN Gross.MtdReforecastQ1 = 0 THEN NULL ELSE Gross.MtdReforecastQ1 END,0),
		ISNULL(Reimbursed.MtdReforecastQ2 / CASE WHEN Gross.MtdReforecastQ2 = 0 THEN NULL ELSE Gross.MtdReforecastQ2 END,0),
		ISNULL(Reimbursed.MtdReforecastQ3 / CASE WHEN Gross.MtdReforecastQ3 = 0 THEN NULL ELSE Gross.MtdReforecastQ3 END,0),
		0,
		0,
		0,
		0,
		ISNULL(Reimbursed.YtdActual / CASE WHEN Gross.YtdActual = 0 THEN NULL ELSE Gross.YtdActual END,0),
		ISNULL(Reimbursed.YtdOriginalBudget / CASE WHEN Gross.YtdOriginalBudget = 0 THEN NULL ELSE Gross.YtdOriginalBudget END,0),
		ISNULL(Reimbursed.YtdReforecastQ1 / CASE WHEN Gross.YtdReforecastQ1 = 0 THEN NULL ELSE Gross.YtdReforecastQ1 END,0),
		ISNULL(Reimbursed.YtdReforecastQ2 / CASE WHEN Gross.YtdReforecastQ2 = 0 THEN NULL ELSE Gross.YtdReforecastQ2 END,0),
		ISNULL(Reimbursed.YtdReforecastQ3 / CASE WHEN Gross.YtdReforecastQ3 = 0 THEN NULL ELSE Gross.YtdReforecastQ3 END,0),
		0,
		0,
		0,
		0,
		ISNULL(Reimbursed.AnnualOriginalBudget / CASE WHEN Gross.AnnualOriginalBudget = 0 THEN NULL ELSE Gross.AnnualOriginalBudget END,0),
		ISNULL(Reimbursed.AnnualReforecastQ1 / CASE WHEN Gross.AnnualReforecastQ1 = 0 THEN NULL ELSE Gross.AnnualReforecastQ1 END,0),
		ISNULL(Reimbursed.AnnualReforecastQ2 / CASE WHEN Gross.AnnualReforecastQ2 = 0 THEN NULL ELSE Gross.AnnualReforecastQ2 END,0),
		ISNULL(Reimbursed.AnnualReforecastQ3 / CASE WHEN Gross.AnnualReforecastQ3 = 0 THEN NULL ELSE Gross.AnnualReforecastQ3 END,0)

From 
	(
		Select 
					ISNULL(SUM(t1.MtdActual),0) MtdActual,
					ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
					ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
					ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
					ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
					ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
					ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
					ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
					ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
					ISNULL(SUM(t1.YtdActual),0) YtdActual,
					ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
					ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
					ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
					ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
					ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
					ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
					ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
					ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
					ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
					ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
					ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
					ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

		From #DetailResult t1
		Where	t1.FeeOrExpense		= 'Expense'
		AND		t1.ExpenseType		= 'Overhead'
		AND		t1.ReimbursableName	= 'Reimbursable'
		AND		t1.MajorExpenseCategoryName <> 'Corporate Tax'
		) Reimbursed
		CROSS JOIN 
			(
				Select 
					ISNULL(SUM(t1.MtdActual),0) MtdActual,
					ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
					ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
					ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
					ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
					ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
					ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
					ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
					ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
					ISNULL(SUM(t1.YtdActual),0) YtdActual,
					ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
					ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
					ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
					ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
					ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
					ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
					ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
					ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
					ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
					ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
					ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
					ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

				From #DetailResult t1
				Where	t1.FeeOrExpense		= 'Expense'
				AND		t1.ExpenseType		= 'Overhead'
				AND		t1.MajorExpenseCategoryName <> 'Corporate Tax'
			) Gross 

--Calculate the Overhead Reimbursement Rate Variance Columns
Update 		#Result
Set			
			MtdVarianceQ0 = (MtdActual - MtdOriginalBudget),
			MtdVarianceQ1 = (MtdActual - MtdReforecastQ1),
			MtdVarianceQ2 = (MtdActual - MtdReforecastQ2),
			MtdVarianceQ3 = (MtdActual - MtdReforecastQ3),
			YtdVarianceQ0 = (YtdActual - YtdOriginalBudget),
			YtdVarianceQ1 = (YtdActual - YtdReforecastQ1),
			YtdVarianceQ2 = (YtdActual - YtdReforecastQ2),
			YtdVarianceQ3 = (YtdActual - YtdReforecastQ3)

Where	GroupDisplayCode = 'Overhead Reimbursement Rate'
AND		DisplayOrderNumber = 274

	
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		280 DisplayOrderNumber
		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'NONPAYROLLEXPENSE' GroupDisplayCode,
		'Non-Payroll Expenses',
		290 DisplayOrderNumber

IF @IncludeGrossNonPayrollExpenses = 1
	BEGIN
	
	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
	Select 
		0 NumberOfSpacesToPad,
		'GROSSNONPAYROLLEXPENSE' GroupDisplayCode,
		'Gross Non-Payroll  Expenses',
		291 DisplayOrderNumber

	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			CASE WHEN (gac.MajorCategoryName = 'Salaries/Taxes/Benefits') THEN 'Salaries/Bonus/Taxes/Benefits' ELSE gac.MajorCategoryName END as GroupDisplayCode,
			--gac.MajorCategoryName GroupDisplayCode,
			CASE WHEN (gac.MajorCategoryName = 'Salaries/Taxes/Benefits') THEN 'Salaries/Bonus/Taxes/Benefits' ELSE gac.MajorCategoryName END as MajorCategoryName,
			--gac.MajorCategoryName,
			292 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			
			--IMS #61973
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
			
			--ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
			--ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
			--ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
			--ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
			
			ISNULL(SUM(t1.YtdActual),0) * -1,			
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			
			--IMS #61973
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
			
			--ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
			--ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
			--ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
			--ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
			
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From GlAccountCategory gac

			LEFT OUTER JOIN (Select *
							From	#DetailResult t1
							Where	t1.ExpenseType		= 'Non-Payroll'
							) t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
			
	Where	gac.FeeOrExpense		= (CASE WHEN gac.MajorCategoryName <> 'Realized (Gain)/Loss' THEN 'Expense' ELSE gac.FeeOrExpense END) --IMS #61973
	AND		gac.TranslationSubTypeName	= @TranslationTypeName
	AND		gac.AccountSubTypeName		= 'Non-Payroll'
	AND		gac.MajorCategoryName NOT IN ('Depreciation Expense', 'Corporate Tax', 'Unrealized (Gain)/Loss')

	Group By 
			CASE WHEN (gac.MajorCategoryName = 'Salaries/Taxes/Benefits') THEN 'Salaries/Bonus/Taxes/Benefits' ELSE gac.MajorCategoryName END	
					

	Insert Into #Result
	(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
	MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
	MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
	YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
	YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
	AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

	Select 
			0 NumberOfSpacesToPad,
			'Total Gross Non-Payroll Expense' GroupDisplayCode,
			'Total Gross Non-Payroll Expense',
			293 DisplayOrderNumber,
			ISNULL(SUM(t1.MtdActual),0) * -1,
			ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
			
			--IMS #61973
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
			
			--ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
			--ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
			--ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
			--ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
			
			ISNULL(SUM(t1.YtdActual),0) * -1,
			ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
			ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
			
			--IMS #61973
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
			ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
			
			--ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
			--ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
			--ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
			--ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
			
			ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
			ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

	From #DetailResult t1
	Where	t1.FeeOrExpense		= (CASE WHEN t1.MajorExpenseCategoryName <> 'Realized (Gain)/Loss' THEN 'Expense' ELSE t1.FeeOrExpense END) --IMS #61973
	AND		t1.ExpenseType		= 'Non-Payroll'
	AND		t1.MajorExpenseCategoryName NOT IN ('Depreciation Expense', 'Corporate Tax', 'Unrealized (Gain)/Loss')


	END


Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
	0 NumberOfSpacesToPad,
	'NETNONPAYROLLEXPENSE' GroupDisplayCode,
	'Net Non-Payroll  Expenses',
	301 DisplayOrderNumber

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		CASE WHEN (gac.MajorCategoryName = 'Salaries/Taxes/Benefits') THEN 'Salaries/Bonus/Taxes/Benefits' ELSE gac.MajorCategoryName END as GroupDisplayCode,
		--gac.MajorCategoryName GroupDisplayCode,
		CASE WHEN (gac.MajorCategoryName = 'Salaries/Taxes/Benefits') THEN 'Salaries/Bonus/Taxes/Benefits' ELSE gac.MajorCategoryName END as MajorCategoryName,
		--gac.MajorCategoryName,
		302 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		
		--IMS #61973
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
			
		--ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		
		
		--IMS #61973
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
			
		--ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From GlAccountCategory gac

			LEFT OUTER JOIN (Select * 
							From	#DetailResult t1
							Where
									t1.ExpenseType		= 'Non-Payroll'
							AND		t1.ReimbursableName = 'Not Reimbursable'

							) t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
			
Where	gac.FeeOrExpense			= (CASE WHEN gac.MajorCategoryName <> 'Realized (Gain)/Loss' THEN 'Expense' ELSE gac.FeeOrExpense END) --IMS #61973
AND		gac.TranslationSubTypeName	= @TranslationTypeName
AND		gac.AccountSubTypeName		= 'Non-Payroll'
AND		gac.MinorCategoryName NOT IN ('Depreciation Expense', 'Corporate Tax', 'Unrealized (Gain)/Loss')

Group By 
		CASE WHEN (gac.MajorCategoryName = 'Salaries/Taxes/Benefits') THEN 'Salaries/Bonus/Taxes/Benefits' ELSE gac.MajorCategoryName END	
				

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'Total Net Non-Payroll Expense' GroupDisplayCode,
		'Total Net Non-Payroll Expense',
		303 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		
		
		--IMS #61973
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
		
		--ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		
		--IMS #61973
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
		
		--ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From #DetailResult t1
Where	t1.FeeOrExpense		= (CASE WHEN t1.MajorExpenseCategoryName <> 'Realized (Gain)/Loss' THEN 'Expense' ELSE t1.FeeOrExpense END) --IMS #61973
AND		t1.ExpenseType		= 'Non-Payroll'
AND		t1.ReimbursableName = 'Not Reimbursable'
AND		t1.MajorExpenseCategoryName NOT IN ('Depreciation Expense', 'Corporate Tax', 'Unrealized (Gain)/Loss')




Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		310 DisplayOrderNumber
		
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'TOTALNETEXPENSE' GroupDisplayCode,
		'Total Net Expenses',
		320 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		
		--IMS #61973
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ0 * -1) ELSE t1.MtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ1 * -1) ELSE t1.MtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ2 * -1) ELSE t1.MtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.MtdVarianceQ3 * -1) ELSE t1.MtdVarianceQ3 END),0) * -1,
		
		--ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		--ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		
		--IMS #61973
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ0 * -1) ELSE t1.YtdVarianceQ0 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ1 * -1) ELSE t1.YtdVarianceQ1 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ2 * -1) ELSE t1.YtdVarianceQ2 END),0) * -1,
		ISNULL(SUM(CASE WHEN t1.FeeOrExpense = 'Income' THEN (t1.YtdVarianceQ3 * -1) ELSE t1.YtdVarianceQ3 END),0) * -1,
		
		--ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		--ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From #DetailResult t1
Where	t1.FeeOrExpense		= (CASE WHEN t1.MajorExpenseCategoryName <> 'Realized (Gain)/Loss' THEN 'Expense' ELSE t1.FeeOrExpense END) --IMS #61973
AND		t1.ReimbursableName = 'Not Reimbursable'
AND		t1.MajorExpenseCategoryName NOT IN ('Depreciation Expense', 'Corporate Tax', 'Unrealized (Gain)/Loss')

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		321 DisplayOrderNumber

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)
Select 
		0 NumberOfSpacesToPad,
		'INCOMELOSSBEFOREDEPRECIATIONANDTAX' GroupDisplayCode,
		'Income / (Loss) Before Taxes and Depreciation',
		322 DisplayOrderNumber,
		(INC.MtdActual + EP.MtdActual) AS MtdActual,
		(INC.MtdOriginalBudget + EP.MtdOriginalBudget) AS MtdOriginalBudget,
		(INC.MtdReforecastQ1 + EP.MtdReforecastQ1) AS MtdReforecastQ1,
		(INC.MtdReforecastQ2 + EP.MtdReforecastQ2) AS MtdReforecastQ2,
		(INC.MtdReforecastQ3 + EP.MtdReforecastQ3) AS MtdReforecastQ3,
		(INC.MtdVarianceQ0 - EP.MtdVarianceQ0) AS MtdVarianceQ0,
		(INC.MtdVarianceQ1 - EP.MtdVarianceQ1) AS MtdVarianceQ1,
		(INC.MtdVarianceQ2 - EP.MtdVarianceQ2) AS MtdVarianceQ2,
		(INC.MtdVarianceQ3 - EP.MtdVarianceQ3) AS MtdVarianceQ3,
		(INC.YtdActual + EP.YtdActual) AS YtdActual,
		(INC.YtdOriginalBudget + EP.YtdOriginalBudget) AS YtdOriginalBudget,
		(INC.YtdReforecastQ1 + EP.YtdReforecastQ1) AS YtdReforecastQ1,
		(INC.YtdReforecastQ2 + EP.YtdReforecastQ2) AS YtdReforecastQ2,
		(INC.YtdReforecastQ3 + EP.YtdReforecastQ3) AS YtdReforecastQ3,
		(INC.YtdVarianceQ0 - EP.YtdVarianceQ0) AS YtdVarianceQ0,
		(INC.YtdVarianceQ1 - EP.YtdVarianceQ1) AS YtdVarianceQ1,
		(INC.YtdVarianceQ2 - EP.YtdVarianceQ2) AS YtdVarianceQ2,
		(INC.YtdVarianceQ3 - EP.YtdVarianceQ3) AS YtdVarianceQ3,
		(INC.AnnualOriginalBudget + EP.AnnualOriginalBudget) AS AnnualOriginalBudget,
		(INC.AnnualReforecastQ1 + EP.AnnualReforecastQ1) AS AnnualReforecastQ1,
		(INC.AnnualReforecastQ2 + EP.AnnualReforecastQ2) AS AnnualReforecastQ2,
		(INC.AnnualReforecastQ3 + EP.AnnualReforecastQ3) AS AnnualReforecastQ3
		
		
FROM	(
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

		From #DetailResult t1
		Where	t1.FeeOrExpense				= 'INCOME'
		) INC
		CROSS JOIN (
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

			From #DetailResult t1
			Where	t1.FeeOrExpense		= 'Expense'
			AND		t1.ReimbursableName = 'Not Reimbursable'
			AND		t1.MajorExpenseCategoryName NOT IN ('Depreciation Expense', 'Corporate Tax', 'Unrealized (Gain)/Loss')
		) EP
		
		Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		323 DisplayOrderNumber



Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		gac.MajorCategoryName GroupDisplayCode,
		gac.MajorCategoryName,
		324 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From GlAccountCategory gac

			LEFT OUTER JOIN (Select * 
							From	#DetailResult t1
							Where
									t1.ExpenseType		= 'Non-Payroll'
							AND		t1.ReimbursableName = 'Not Reimbursable'

							) t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
			
Where	gac.FeeOrExpense			= 'Expense'
AND		gac.TranslationSubTypeName	= @TranslationTypeName
AND		gac.AccountSubTypeName		= 'Non-Payroll'
AND		gac.MinorCategoryName = 'Depreciation Expense'
Group By 
		gac.MajorCategoryName	
		
		Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)
Select 
		0 NumberOfSpacesToPad,
		'INCOMELOSSBEFORETAX' GroupDisplayCode,
		'Income / (Loss) Before Taxes',
		325 DisplayOrderNumber,
		(INC.MtdActual + EP.MtdActual) AS MtdActual,
		(INC.MtdOriginalBudget + EP.MtdOriginalBudget) AS MtdOriginalBudget,
		(INC.MtdReforecastQ1 + EP.MtdReforecastQ1) AS MtdReforecastQ1,
		(INC.MtdReforecastQ2 + EP.MtdReforecastQ2) AS MtdReforecastQ2,
		(INC.MtdReforecastQ3 + EP.MtdReforecastQ3) AS MtdReforecastQ3,
		(INC.MtdVarianceQ0 - EP.MtdVarianceQ0) AS MtdVarianceQ0,
		(INC.MtdVarianceQ1 - EP.MtdVarianceQ1) AS MtdVarianceQ1,
		(INC.MtdVarianceQ2 - EP.MtdVarianceQ2) AS MtdVarianceQ2,
		(INC.MtdVarianceQ3 - EP.MtdVarianceQ3) AS MtdVarianceQ3,
		(INC.YtdActual + EP.YtdActual) AS YtdActual,
		(INC.YtdOriginalBudget + EP.YtdOriginalBudget) AS YtdOriginalBudget,
		(INC.YtdReforecastQ1 + EP.YtdReforecastQ1) AS YtdReforecastQ1,
		(INC.YtdReforecastQ2 + EP.YtdReforecastQ2) AS YtdReforecastQ2,
		(INC.YtdReforecastQ3 + EP.YtdReforecastQ3) AS YtdReforecastQ3,
		(INC.YtdVarianceQ0 - EP.YtdVarianceQ0) AS YtdVarianceQ0,
		(INC.YtdVarianceQ1 - EP.YtdVarianceQ1) AS YtdVarianceQ1,
		(INC.YtdVarianceQ2 - EP.YtdVarianceQ2) AS YtdVarianceQ2,
		(INC.YtdVarianceQ3 - EP.YtdVarianceQ3) AS YtdVarianceQ3,
		(INC.AnnualOriginalBudget + EP.AnnualOriginalBudget) AS AnnualOriginalBudget,
		(INC.AnnualReforecastQ1 + EP.AnnualReforecastQ1) AS AnnualReforecastQ1,
		(INC.AnnualReforecastQ2 + EP.AnnualReforecastQ2) AS AnnualReforecastQ2,
		(INC.AnnualReforecastQ3 + EP.AnnualReforecastQ3) AS AnnualReforecastQ3
		
		
FROM	(
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

		From #DetailResult t1
		Where	t1.FeeOrExpense				= 'INCOME'
		) INC
		CROSS JOIN (
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

			From #DetailResult t1
			Where	t1.FeeOrExpense		= 'Expense'
			AND		t1.ReimbursableName = 'Not Reimbursable'
			AND		t1.MajorExpenseCategoryName NOT IN ('Corporate Tax', 'Unrealized (Gain)/Loss')
			
		) EP
		
		Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		326 DisplayOrderNumber

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		gac.MajorCategoryName GroupDisplayCode,
		gac.MajorCategoryName,
		327 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From GlAccountCategory gac

			LEFT OUTER JOIN (Select * 
							From	#DetailResult t1
							Where
									t1.ExpenseType		= 'Non-Payroll'
							AND		t1.ReimbursableName = 'Not Reimbursable'

							) t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
			
Where	gac.FeeOrExpense			= 'Expense'
AND		gac.TranslationSubTypeName	= @TranslationTypeName
AND		gac.AccountSubTypeName		= 'Non-Payroll'
AND		gac.MinorCategoryName = 'Unrealized (Gain)/Loss'
Group By 
		gac.MajorCategoryName
	
Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		gac.MajorCategoryName GroupDisplayCode,
		gac.MajorCategoryName,
		328 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0) * -1,
		ISNULL(SUM(t1.MtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.MtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.MtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.YtdActual),0) * -1,
		ISNULL(SUM(t1.YtdOriginalBudget),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ1),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ2),0) * -1,
		ISNULL(SUM(t1.YtdReforecastQ3),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ0),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ1),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ2),0) * -1,
		ISNULL(SUM(t1.YtdVarianceQ3),0) * -1,
		ISNULL(SUM(t1.AnnualOriginalBudget),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ1),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ2),0) * -1,
		ISNULL(SUM(t1.AnnualReforecastQ3),0) * -1

From GlAccountCategory gac

			LEFT OUTER JOIN (Select * 
							From	#DetailResult t1
							Where
									t1.ExpenseType		= 'Non-Payroll'
							AND		t1.ReimbursableName = 'Not Reimbursable'

							) t1 ON gac.GlAccountCategoryKey = t1.GlAccountCategoryKey
			
Where	gac.FeeOrExpense			= 'Expense'
AND		gac.TranslationSubTypeName	= @TranslationTypeName
AND		gac.AccountSubTypeName		= 'Non-Payroll'
AND		gac.MinorCategoryName = 'Corporate Tax'
Group By 
		gac.MajorCategoryName

--Insert Into #Result
--(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
--Select 
--		0 NumberOfSpacesToPad,
--		'BLANK' GroupDisplayCode,
--		'',
--		321 DisplayOrderNumber

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)
Select 
		0 NumberOfSpacesToPad,
		'NETINCOMELOSS' GroupDisplayCode,
		'NET INCOME / (LOSS)',
		330 DisplayOrderNumber,
		(INC.MtdActual + EP.MtdActual) AS MtdActual,
		(INC.MtdOriginalBudget + EP.MtdOriginalBudget) AS MtdOriginalBudget,
		(INC.MtdReforecastQ1 + EP.MtdReforecastQ1) AS MtdReforecastQ1,
		(INC.MtdReforecastQ2 + EP.MtdReforecastQ2) AS MtdReforecastQ2,
		(INC.MtdReforecastQ3 + EP.MtdReforecastQ3) AS MtdReforecastQ3,
		(INC.MtdVarianceQ0 - EP.MtdVarianceQ0) AS MtdVarianceQ0,
		(INC.MtdVarianceQ1 - EP.MtdVarianceQ1) AS MtdVarianceQ1,
		(INC.MtdVarianceQ2 - EP.MtdVarianceQ2) AS MtdVarianceQ2,
		(INC.MtdVarianceQ3 - EP.MtdVarianceQ3) AS MtdVarianceQ3,
		(INC.YtdActual + EP.YtdActual) AS YtdActual,
		(INC.YtdOriginalBudget + EP.YtdOriginalBudget) AS YtdOriginalBudget,
		(INC.YtdReforecastQ1 + EP.YtdReforecastQ1) AS YtdReforecastQ1,
		(INC.YtdReforecastQ2 + EP.YtdReforecastQ2) AS YtdReforecastQ2,
		(INC.YtdReforecastQ3 + EP.YtdReforecastQ3) AS YtdReforecastQ3,
		(INC.YtdVarianceQ0 - EP.YtdVarianceQ0) AS YtdVarianceQ0,
		(INC.YtdVarianceQ1 - EP.YtdVarianceQ1) AS YtdVarianceQ1,
		(INC.YtdVarianceQ2 - EP.YtdVarianceQ2) AS YtdVarianceQ2,
		(INC.YtdVarianceQ3 - EP.YtdVarianceQ3) AS YtdVarianceQ3,
		(INC.AnnualOriginalBudget + EP.AnnualOriginalBudget) AS AnnualOriginalBudget,
		(INC.AnnualReforecastQ1 + EP.AnnualReforecastQ1) AS AnnualReforecastQ1,
		(INC.AnnualReforecastQ2 + EP.AnnualReforecastQ2) AS AnnualReforecastQ2,
		(INC.AnnualReforecastQ3 + EP.AnnualReforecastQ3) AS AnnualReforecastQ3
		
		
FROM	(
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

		From #DetailResult t1
		Where	t1.FeeOrExpense				= 'INCOME'
		) INC
		CROSS JOIN (
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

			From #DetailResult t1
			Where	t1.FeeOrExpense		= 'Expense'
			AND		t1.ReimbursableName = 'Not Reimbursable'
		) EP


Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)
Select 
		0 NumberOfSpacesToPad,
		'PROFITMARGIN' GroupDisplayCode,
		'Profit Margin (Net Income/(Loss)/ Total Revenue)',
		331 DisplayOrderNumber,
		ISNULL(((INC.MtdActual + EP.MtdActual) / CASE WHEN INC.MtdActual <> 0 THEN INC.MtdActual ELSE NULL END),0) AS MtdActual,
		ISNULL(((INC.MtdOriginalBudget + EP.MtdOriginalBudget) / CASE WHEN INC.MtdOriginalBudget <> 0 THEN INC.MtdOriginalBudget ELSE NULL END),0) AS MtdOriginalBudget,
		ISNULL(((INC.MtdReforecastQ1 + EP.MtdReforecastQ1) / CASE WHEN INC.MtdReforecastQ1 <> 0 THEN INC.MtdReforecastQ1 ELSE NULL END),0) AS MtdReforecastQ1,
		ISNULL(((INC.MtdReforecastQ2 + EP.MtdReforecastQ2) / CASE WHEN INC.MtdReforecastQ2 <> 0 THEN INC.MtdReforecastQ2 ELSE NULL END),0) AS MtdReforecastQ2,
		ISNULL(((INC.MtdReforecastQ3 + EP.MtdReforecastQ3) / CASE WHEN INC.MtdReforecastQ3 <> 0 THEN INC.MtdReforecastQ3 ELSE NULL END),0) AS MtdReforecastQ3,
		0 AS MtdVarianceQ0, --Done Below for it use these results to sub calculate
		0 AS MtdVarianceQ1, --Done Below for it use these results to sub calculate
		0 AS MtdVarianceQ2, --Done Below for it use these results to sub calculate
		0 AS MtdVarianceQ3, --Done Below for it use these results to sub calculate
		ISNULL(((INC.YtdActual + EP.YtdActual) / CASE WHEN INC.YtdActual <> 0 THEN INC.YtdActual ELSE NULL END),0) AS YtdActual,
		ISNULL(((INC.YtdOriginalBudget + EP.YtdOriginalBudget) / CASE WHEN INC.YtdOriginalBudget <> 0 THEN INC.YtdOriginalBudget ELSE NULL END),0) AS YtdOriginalBudget,
		ISNULL(((INC.YtdReforecastQ1 + EP.YtdReforecastQ1) / CASE WHEN INC.YtdReforecastQ1 <> 0 THEN INC.YtdReforecastQ1 ELSE NULL END),0) AS YtdReforecastQ1,
		ISNULL(((INC.YtdReforecastQ2 + EP.YtdReforecastQ2) / CASE WHEN INC.YtdReforecastQ2 <> 0 THEN INC.YtdReforecastQ2 ELSE NULL END),0) AS YtdReforecastQ2,
		ISNULL(((INC.YtdReforecastQ3 + EP.YtdReforecastQ3) / CASE WHEN INC.YtdReforecastQ3 <> 0 THEN INC.YtdReforecastQ3 ELSE NULL END),0) AS YtdReforecastQ3,
		0 AS YtdVarianceQ0, --Done Below for it use these results to sub calculate
		0 AS YtdVarianceQ1, --Done Below for it use these results to sub calculate
		0 AS YtdVarianceQ2, --Done Below for it use these results to sub calculate
		0 AS YtdVarianceQ3, --Done Below for it use these results to sub calculate
		ISNULL(((INC.AnnualOriginalBudget + EP.AnnualOriginalBudget) / CASE WHEN INC.AnnualOriginalBudget <> 0 THEN INC.AnnualOriginalBudget ELSE NULL END),0) AS AnnualOriginalBudget,
		ISNULL(((INC.AnnualReforecastQ1 + EP.AnnualReforecastQ1) / CASE WHEN INC.AnnualReforecastQ1 <> 0 THEN INC.AnnualReforecastQ1 ELSE NULL END),0) AS AnnualReforecastQ1,
		ISNULL(((INC.AnnualReforecastQ2 + EP.AnnualReforecastQ2) / CASE WHEN INC.AnnualReforecastQ2 <> 0 THEN INC.AnnualReforecastQ2 ELSE NULL END),0) AS AnnualReforecastQ2,
		ISNULL(((INC.AnnualReforecastQ3 + EP.AnnualReforecastQ3) / CASE WHEN INC.AnnualReforecastQ3 <> 0 THEN INC.AnnualReforecastQ3 ELSE NULL END),0) AS AnnualReforecastQ3
		
FROM	(
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

		From #DetailResult t1
		Where	t1.FeeOrExpense				= 'INCOME'
		) INC
		CROSS JOIN (
		Select 
				ISNULL(SUM(t1.MtdActual),0) MtdActual,
				ISNULL(SUM(t1.MtdOriginalBudget),0) MtdOriginalBudget,
				ISNULL(SUM(t1.MtdReforecastQ1),0) MtdReforecastQ1,
				ISNULL(SUM(t1.MtdReforecastQ2),0) MtdReforecastQ2,
				ISNULL(SUM(t1.MtdReforecastQ3),0) MtdReforecastQ3,
				ISNULL(SUM(t1.MtdVarianceQ0),0) MtdVarianceQ0,
				ISNULL(SUM(t1.MtdVarianceQ1),0) MtdVarianceQ1,
				ISNULL(SUM(t1.MtdVarianceQ2),0) MtdVarianceQ2,
				ISNULL(SUM(t1.MtdVarianceQ3),0) MtdVarianceQ3,
				ISNULL(SUM(t1.YtdActual),0) YtdActual,
				ISNULL(SUM(t1.YtdOriginalBudget),0) YtdOriginalBudget,
				ISNULL(SUM(t1.YtdReforecastQ1),0) YtdReforecastQ1,
				ISNULL(SUM(t1.YtdReforecastQ2),0) YtdReforecastQ2,
				ISNULL(SUM(t1.YtdReforecastQ3),0) YtdReforecastQ3,
				ISNULL(SUM(t1.YtdVarianceQ0),0) YtdVarianceQ0,
				ISNULL(SUM(t1.YtdVarianceQ1),0) YtdVarianceQ1,
				ISNULL(SUM(t1.YtdVarianceQ2),0) YtdVarianceQ2,
				ISNULL(SUM(t1.YtdVarianceQ3),0) YtdVarianceQ3,
				ISNULL(SUM(t1.AnnualOriginalBudget),0) AnnualOriginalBudget,
				ISNULL(SUM(t1.AnnualReforecastQ1),0) AnnualReforecastQ1,
				ISNULL(SUM(t1.AnnualReforecastQ2),0) AnnualReforecastQ2,
				ISNULL(SUM(t1.AnnualReforecastQ3),0) AnnualReforecastQ3

			From #DetailResult t1
			Where	t1.FeeOrExpense		= 'Expense'
			AND		t1.ReimbursableName = 'Not Reimbursable'
		) EP

--Calculate the Profit Variance Columns
Update 		#Result
Set			
			MtdVarianceQ0 = MtdActual - MtdOriginalBudget,
			MtdVarianceQ1 = MtdActual - MtdReforecastQ1,
			MtdVarianceQ2 = MtdActual - MtdReforecastQ2,
			MtdVarianceQ3 = MtdActual - MtdReforecastQ3,
			YtdVarianceQ0 = YtdActual - YtdOriginalBudget,
			YtdVarianceQ1 = YtdActual - YtdReforecastQ1,
			YtdVarianceQ2 = YtdActual - YtdReforecastQ2,
			YtdVarianceQ3 = YtdActual - YtdReforecastQ3

Where	GroupDisplayCode = 'PROFITMARGIN'
AND		DisplayOrderNumber = 331	
		
		
--------------------------------------------------------------------------------------------------------------------------------------	
--Final Common block to set the Variance% columns
--------------------------------------------------------------------------------------------------------------------------------------	
		
Update #Result
Set		
	MtdVariancePercentageQ0 = ISNULL(MtdVarianceQ0 / CASE WHEN MtdOriginalBudget <> 0 THEN MtdOriginalBudget ELSE NULL END,0) ,
	MtdVariancePercentageQ1 = ISNULL(MtdVarianceQ1 / CASE WHEN MtdReforecastQ1 <> 0 THEN MtdReforecastQ1 ELSE NULL END,0) ,
	MtdVariancePercentageQ2 = ISNULL(MtdVarianceQ2 / CASE WHEN MtdReforecastQ2 <> 0 THEN MtdReforecastQ2 ELSE NULL END,0) ,
	MtdVariancePercentageQ3 = ISNULL(MtdVarianceQ3 / CASE WHEN MtdReforecastQ3 <> 0 THEN MtdReforecastQ3 ELSE NULL END,0) ,

	YtdVariancePercentageQ0 = ISNULL(YtdVarianceQ0 / CASE WHEN YtdOriginalBudget <> 0 THEN YtdOriginalBudget ELSE NULL END,0) ,
	YtdVariancePercentageQ1 = ISNULL(YtdVarianceQ1 / CASE WHEN YtdReforecastQ1 <> 0 THEN YtdReforecastQ1 ELSE NULL END,0) ,
	YtdVariancePercentageQ2 = ISNULL(YtdVarianceQ2 / CASE WHEN YtdReforecastQ2 <> 0 THEN YtdReforecastQ2 ELSE NULL END,0) ,
	YtdVariancePercentageQ3 = ISNULL(YtdVarianceQ3 / CASE WHEN YtdReforecastQ3 <> 0 THEN YtdReforecastQ3 ELSE NULL END,0) 
Where GroupDisplayCode NOT IN('Payroll Reimbursement Rate','Overhead Reimbursement Rate','PROFITMARGIN')

--UNKNOWN MajorCategory

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber)
Select 
		0 NumberOfSpacesToPad,
		'BLANK' GroupDisplayCode,
		'',
		340 DisplayOrderNumber

Insert Into #Result
(NumberOfSpacesToPad, GroupDisplayCode, GroupDisplayName, DisplayOrderNumber,
MtdActual,MtdOriginalBudget,MtdReforecastQ1,MtdReforecastQ2,MtdReforecastQ3,
MtdVarianceQ0,MtdVarianceQ1,MtdVarianceQ2,MtdVarianceQ3,
YtdActual,	YtdOriginalBudget,YtdReforecastQ1,YtdReforecastQ2,YtdReforecastQ3,
YtdVarianceQ0,YtdVarianceQ1,YtdVarianceQ2,YtdVarianceQ3,
AnnualOriginalBudget,AnnualReforecastQ1,AnnualReforecastQ2,AnnualReforecastQ3)

Select 
		0 NumberOfSpacesToPad,
		'UNKNOWN' GroupDisplayCode,
		'Unknown',
		341 DisplayOrderNumber,
		ISNULL(SUM(t1.MtdActual),0),
		ISNULL(SUM(t1.MtdOriginalBudget),0),
		ISNULL(SUM(t1.MtdReforecastQ1),0),
		ISNULL(SUM(t1.MtdReforecastQ2),0),
		ISNULL(SUM(t1.MtdReforecastQ3),0),
		ISNULL(SUM(t1.MtdVarianceQ0),0),
		ISNULL(SUM(t1.MtdVarianceQ1),0),
		ISNULL(SUM(t1.MtdVarianceQ2),0),
		ISNULL(SUM(t1.MtdVarianceQ3),0),
		ISNULL(SUM(t1.YtdActual),0),
		ISNULL(SUM(t1.YtdOriginalBudget),0),
		ISNULL(SUM(t1.YtdReforecastQ1),0),
		ISNULL(SUM(t1.YtdReforecastQ2),0),
		ISNULL(SUM(t1.YtdReforecastQ3),0),
		ISNULL(SUM(t1.YtdVarianceQ0),0),
		ISNULL(SUM(t1.YtdVarianceQ1),0),
		ISNULL(SUM(t1.YtdVarianceQ2),0),
		ISNULL(SUM(t1.YtdVarianceQ3),0),
		ISNULL(SUM(t1.AnnualOriginalBudget),0),
		ISNULL(SUM(t1.AnnualReforecastQ1),0),
		ISNULL(SUM(t1.AnnualReforecastQ2),0),
		ISNULL(SUM(t1.AnnualReforecastQ3),0)

From #DetailResult t1
Where	t1.MajorExpenseCategoryName	= 'UNKNOWN'
Having (
		ISNULL(SUM(t1.MtdActual),0) <> 0 OR 
		ISNULL(SUM(t1.MtdOriginalBudget),0) <> 0 OR 
		ISNULL(SUM(t1.MtdReforecastQ1),0) <> 0 OR 
		ISNULL(SUM(t1.MtdReforecastQ2),0) <> 0 OR 
		ISNULL(SUM(t1.MtdReforecastQ3),0) <> 0 OR 
		ISNULL(SUM(t1.MtdVarianceQ0),0) <> 0 OR 
		ISNULL(SUM(t1.MtdVarianceQ1),0) <> 0 OR 
		ISNULL(SUM(t1.MtdVarianceQ2),0) <> 0 OR 
		ISNULL(SUM(t1.MtdVarianceQ3),0) <> 0 OR 
		ISNULL(SUM(t1.YtdActual),0) <> 0 OR 
		ISNULL(SUM(t1.YtdOriginalBudget),0) <> 0 OR 
		ISNULL(SUM(t1.YtdReforecastQ1),0) <> 0 OR 
		ISNULL(SUM(t1.YtdReforecastQ2),0) <> 0 OR 
		ISNULL(SUM(t1.YtdReforecastQ3),0) <> 0 OR 
		ISNULL(SUM(t1.YtdVarianceQ0),0) <> 0 OR 
		ISNULL(SUM(t1.YtdVarianceQ1),0) <> 0 OR 
		ISNULL(SUM(t1.YtdVarianceQ2),0) <> 0 OR 
		ISNULL(SUM(t1.YtdVarianceQ3),0) <> 0 OR 
		ISNULL(SUM(t1.AnnualOriginalBudget),0) <> 0 OR 
		ISNULL(SUM(t1.AnnualReforecastQ1),0) <> 0 OR 
		ISNULL(SUM(t1.AnnualReforecastQ2),0) <> 0 OR 
		ISNULL(SUM(t1.AnnualReforecastQ3),0) <> 0
	)




--------------------------------------------------------------------------------------------------------------------------------------	
--Final Result
--------------------------------------------------------------------------------------------------------------------------------------	

Select 
	NumberOfSpacesToPad,
	GroupDisplayCode,
	REPLICATE(' ', NumberOfSpacesToPad) + GroupDisplayName AS GroupDisplayName,
	DisplayOrderNumber,
	MtdActual,
	MtdOriginalBudget,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE MtdReforecastQ1 END AS MtdReforecastQ1,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE MtdReforecastQ2 END AS MtdReforecastQ2,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE MtdReforecastQ3 END AS MtdReforecastQ3,
	
	MtdVarianceQ0,
	MtdVarianceQ1,
	MtdVarianceQ2,
	MtdVarianceQ3,

	MtdVariancePercentageQ0,
	MtdVariancePercentageQ1,
	MtdVariancePercentageQ2,
	MtdVariancePercentageQ3,
	
	YtdActual,
	YtdOriginalBudget,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE YtdReforecastQ1 END AS YtdReforecastQ1,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE YtdReforecastQ2 END AS YtdReforecastQ2,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE YtdReforecastQ3 END AS YtdReforecastQ3,
	
	YtdVarianceQ0,
	YtdVarianceQ1,
	YtdVarianceQ2,
	YtdVarianceQ3,

	YtdVariancePercentageQ0,
	YtdVariancePercentageQ1,
	YtdVariancePercentageQ2,
	YtdVariancePercentageQ3,
		
	AnnualOriginalBudget,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE AnnualReforecastQ1 END AS AnnualReforecastQ1,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE AnnualReforecastQ2 END AS AnnualReforecastQ2,
	CASE WHEN @ReforecastQuaterName = 'Q0' THEN 0 ELSE AnnualReforecastQ3 END AS AnnualReforecastQ3
From #Result
Order By 
	DisplayOrderNumber,
	#Result.GroupDisplayCode

--Second Resultset for Excel
--Select * From #DetailResult



SELECT
	ExpenseType,
	FeeOrExpense,
	MajorExpenseCategoryName,
	MinorExpenseCategoryName,
	GlobalGlAccountCode,
	GlobalGlAccountName,
	BusinessLine,
	ActivityType,
	ReportingEntityName,
	
	PropertyFundCode,
	FunctionalDepartmentCode,
	AllocationSubRegionName,
	OriginatingSubRegionName,

	ActualsExpensePeriod,
	EntryDate,
	[User],
	Description,
	AdditionalDescription,
	ReimbursableName,
	FeeAdjustmentCode,
	SourceName,
	GlAccountCategoryKey,
	
	MtdActual,
	MtdOriginalBudget,
	MtdReforecastQ1,
	MtdReforecastQ2,
	MtdReforecastQ3,
	MtdVarianceQ0,
	MtdVarianceQ1,
	MtdVarianceQ2,
	MtdVarianceQ3,
	YtdActual,
	YtdOriginalBudget,
	YtdReforecastQ1,
	YtdReforecastQ2,
	YtdReforecastQ3,
	YtdVarianceQ0,
	YtdVarianceQ1,
	YtdVarianceQ2,
	YtdVarianceQ3,
	AnnualOriginalBudget,
	AnnualReforecastQ1,
	AnnualReforecastQ2,
	AnnualReforecastQ3 
FROM
	#DetailResult



END
GO























































































































/*
 
	1. All import stored procedures (besides Grinder import stored procedures)
 
		So far:	1.1.	dbo.stp_IU_LoadGrProfitabilityGBSReforecast
				1.2.	dbo.stp_IU_LoadGrProfitabilityGeneralLedger
				1.3		dbo.stp_IU_LoadGrProfitabilityOverhead
				1.4		dbo.stp_IU_LoadGrProfitabilityPayrollReforecast
				1.5		dbo.stp_IU_LoadGrProfitabilityPayrollOriginalBudget
				1.6		dbo.stp_IU_LoadGrProfitabilityGBSBudget
		
 
*/
 
-- ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||| --
--										1. All import stored procedures (besides Grinder import stored procedures)
-- ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||| --

USE [GrReportingStaging]
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyGeneralLedger]    Script Date: 05/16/2011 08:15:52 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyGeneralLedger]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyGeneralLedger]
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyOverhead]    Script Date: 05/16/2011 08:15:52 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyOverhead]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyOverhead]
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyGBSBudget]    Script Date: 05/16/2011 08:15:51 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyGBSBudget]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyGBSBudget]
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyGBSReforecast]    Script Date: 05/16/2011 08:15:51 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyGBSReforecast]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyGBSReforecast]
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyPayrollOriginalBudget]    Script Date: 05/16/2011 08:15:53 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyPayrollOriginalBudget]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyPayrollOriginalBudget]
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyPayrollReforecast]    Script Date: 05/16/2011 08:15:53 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyPayrollReforecast]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyPayrollReforecast]
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyPayrollReforecast]    Script Date: 05/16/2011 08:15:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyPayrollReforecast]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'CREATE PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyPayrollReforecast]
AS

PRINT ''####''
PRINT ''stp_IU_LoadGrProfitabiltyPayrollReforecast''
PRINT ''####''

SET NOCOUNT ON

DECLARE @RowCount INT


DECLARE @StartTime DATETIME
DECLARE @DebugMode BIT = 1 --- Running some extra test queries for debugging purposes. Start comment DEBUG MODE for search and check this variable.



DECLARE @DataPriorToDate DATETIME=NULL
IF (@DataPriorToDate IS NULL)
BEGIN
	SET @DataPriorToDate = CONVERT(DATETIME, (SELECT ConfiguredValue FROM SSISConfigurations WHERE ConfigurationFilter = ''PayrollBudgetDataPriorToDate''))
END

DECLARE @CanImportTapasReforecast INT = (SELECT ConfiguredValue FROM [GrReportingStaging].[dbo].[SSISConfigurations] WHERE ConfigurationFilter = ''CanImportTAPASReforecast'')

IF (@CanImportTapasReforecast <> 1)
BEGIN
	PRINT (''Import of TAPAS Reforecasts is not scheduled in GrReportingStaging.dbo.SSISConfigurations'')
	RETURN
END
	
--DECLARE @SourceSystemName varchar(50) = ''Tapas Budgeting''
--DECLARE @SourceSystemNameGBS varchar(50) = ''Global Budgeting System''
DECLARE
	@EUFundGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Fund Profit & Loss''      AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@EUCorporateGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@EUPropertyGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Property Profit & Loss''  AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@USFundGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Fund Profit & Loss''      AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@USPropertyGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Property Profit & Loss''  AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@USCorporateGlAccountCategoryKeyUnknown INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@DevelopmentGlAccountCategoryKeyUnknown INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''Development Profit & Loss''  AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@GlobalGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global'' AND TranslationSubTypeName = ''Global'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
	
-- Setup account categories and default to UNKNOWN.
DECLARE 
	@SalariesTaxesBenefitsMajorGlAccountCategoryId INT = -1,
	@BaseSalaryMinorGlAccountCategoryId INT = -1,
	@BenefitsMinorGlAccountCategoryId INT = -1,
	@BonusMinorGlAccountCategoryId INT = -1,
	@ProfitShareMinorGlAccountCategoryId INT = -1,
	@OccupancyCostsMajorGlAccountCategoryId INT = -1,
	@OverheadMinorGlAccountCategoryId INT = -1

DECLARE 
	@GlAccountKeyUnknown			INT = (SELECT GlAccountKey FROM GrReporting.dbo.GlAccount WHERE Code = ''UNKNOWN''),
	@SourceKeyUnknown				INT = (SELECT SourceKey FROM GrReporting.dbo.[Source] WHERE SourceName = ''UNKNOWN''),
	@FunctionalDepartmentKeyUnknown INT = (SELECT FunctionalDepartmentKey FROM GrReporting.dbo.FunctionalDepartment WHERE FunctionalDepartmentCode = ''UNKNOWN''),
	@ReimbursableKeyUnknown			INT = (SELECT ReimbursableKey FROM GrReporting.dbo.Reimbursable WHERE ReimbursableCode = ''UNKNOWN''),
	@ActivityTypeKeyUnknown			INT = (SELECT ActivityTypeKey FROM GrReporting.dbo.ActivityType WHERE ActivityTypeCode = ''UNKNOWN''),
	@PropertyFundKeyUnknown			INT = (SELECT PropertyFundKey FROM GrReporting.dbo.PropertyFund WHERE PropertyFundName = ''UNKNOWN''),
	@AllocationRegionKeyUnknown		INT = (SELECT AllocationRegionKey FROM GrReporting.dbo.AllocationRegion WHERE RegionCode = ''UNKNOWN''),
	@OriginatingRegionKeyUnknown	INT = (SELECT OriginatingRegionKey FROM GrReporting.dbo.OriginatingRegion WHERE RegionCode = ''UNKNOWN''),
	@OverheadKeyUnknown				INT = (Select OverheadKey From GrReporting.dbo.Overhead Where OverheadCode = ''UNKNOWN''),
    @LocalCurrencyKeyUnknown		INT = (SELECT CurrencyKey FROM GrReporting.dbo.Currency WHERE CurrencyCode =  ''UNK'' )

IF @LocalCurrencyKeyUnknown IS NULL
BEGIN
	PRINT ''@LocalCurrencyKeyUnknown is null. No unknown currency key found''
	RETURN
END    
   
DECLARE @ReforecastTypeIsTGBBUDKey INT = (SELECT BudgetReforecastTypeKey from GrReporting.dbo.BudgetReforecastType where BudgetReforecastTypeCode = ''TGBBUD'')
DECLARE @ReforecastTypeIsTGBACTKey INT = (SELECT BudgetReforecastTypeKey from GrReporting.dbo.BudgetReforecastType where BudgetReforecastTypeCode = ''TGBACT'')
	
DECLARE @ImportErrorTable TABLE (
	Error varchar(50)
);
	
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Setup mapping variables
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


-- Set gl account categories
SELECT TOP 1
	@SalariesTaxesBenefitsMajorGlAccountCategoryId = GLMajorCategoryId
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryName = ''Salaries/Taxes/Benefits''

print (@SalariesTaxesBenefitsMajorGlAccountCategoryId)
--NB!!!!!!!
--The roll up to payroll is very sensitive information. It is crutial that information regarding payroll not get 
--communicated to TS employees on certain reports. Changing the category name here will have ramifications because 
--some reports check for this name.
--NB!!!!!!!

SELECT
	@BaseSalaryMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsMajorGlAccountCategoryId AND
	GLMinorCategoryName = ''Base Salary''

SELECT
	@BenefitsMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsMajorGlAccountCategoryId AND
	GLMinorCategoryName = ''Benefits''

SELECT
	@BonusMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsMajorGlAccountCategoryId AND
	GLMinorCategoryName = ''Bonus''

SELECT
	@ProfitShareMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsMajorGlAccountCategoryId AND
	GLMinorCategoryName = ''Benefits'' -- Yes benefit is correct (Just incase they want to split profit share out again)

SELECT TOP 1
	@OccupancyCostsMajorGlAccountCategoryId = GLMajorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryName = ''General Overhead''

SELECT
	@OverheadMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @OccupancyCostsMajorGlAccountCategoryId AND
	GLMinorCategoryName = ''External General Overhead''

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Source Data
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--
-- Setup Bonus Cap Excess Project Setting
--

-- ==============================================================================================================================================
-- Get Budgets to Process
-- ==============================================================================================================================================

SELECT 
	BTPC.*,
	CRR.ReforecastKey
INTO 
	#BudgetsToProcess 
FROM 
	dbo.BudgetsToProcessCurrent(''TGB Budget/Reforecast'') BTPC
	INNER JOIN GrReporting.dbo.GetCurrentReforecastRecord() CRR ON
		BTPC.BudgetYear = CRR.ReforecastEffectiveYear AND
		BTPC.BudgetQuarter = CRR.ReforecastQuarterName	
WHERE 
	IsReforecast = 1

DECLARE @BTPRowCount INT = @@rowcount

PRINT (''Rows inserted into #BudgetsToProcess: '' + CONVERT(VARCHAR(10),@BTPRowCount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

IF (@BTPRowCount = 0)
BEGIN
	PRINT (''*******************************************************'')
	PRINT (''	stp_IU_LoadGrProfitabiltyPayrollReforecast is quitting because BudgetsToProcess returned no budgets to import.'')
	PRINT (''*******************************************************'')
	RETURN
END

-- ==============================================================================================================================================
-- Get Budgets
-- ==============================================================================================================================================



SET @StartTime = GETDATE()

SELECT 
	B.ImportBatchId,
	B.BudgetId,
	B.BudgetReportGroupPeriodId
INTO
	#LastImportedGBSBudgets
FROM
	GBS.Budget B
	INNER JOIN (
		SELECT 
			MAX(ImportBatchId) AS ImportBatchId
		FROM
			GBS.Budget
		WHERE 
			IsReforecast = 1
		) MB ON
		MB.ImportBatchId = B.ImportBatchId


SET @RowCount = @@ROWCOUNT
PRINT ''Completed inserting records into #LastImportedGBSBudgets:''+CONVERT(char(10),@RowCount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
IF (@RowCount = 0)
BEGIN
	PRINT ''WARNING: No GBS budgets found, so no actuals will be imported''
END

SET @StartTime = GETDATE()

--DECLARE @TempGBSImportBatchId INT = (SELECT MAX(BatchId) FROM dbo.Batch WHERE PackageName = ''ETL.Staging.GBS'')

CREATE TABLE #NewBudgets(
	ImportBatchId INT NOT NULL,
	ImportKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	BudgetId INT NOT NULL,
	RegionId INT NOT NULL,
	BudgetTypeId INT NOT NULL,
	BudgetStatusId INT NOT NULL,
	[Name] VARCHAR(100) NOT NULL,
	StartPeriod INT NOT NULL,
	EndPeriod INT NOT NULL,
	FirstProjectedPeriod INT NULL,
	CurrencyCode VARCHAR(3) NOT NULL,
	CanEmployeesViewBudget BIT NOT NULL,
	IsReforecast BIT NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	LastLockedDate DATETIME NULL,
	BudgetAllocationSetId INT NULL,
	LastAMUpdateDate DATETIME NULL,
	BudgetReportGroupPeriodId INT NOT NULL,
	BudgetReportGroupPeriod INT NOT NULL,
	GroupEndPeriod INT NOT NULL,
	GBSBudgetId INT NULL, -- CAN BE NULL IN WHICH CASE NO ACTUALS WILL BE IMPORTED
	MustImportAllActualsIntoWarehouse BIT NOT NULL,
	ReforecastKey INT NOT NULL,
	BudgetReportGroupId INT NOT NULL
)
INSERT INTO #NewBudgets(
	ImportBatchId,
	ImportKey,
	SnapshotId,
	BudgetId,
	RegionId,
	BudgetTypeId,
	BudgetStatusId,
	[Name],
	StartPeriod,
	EndPeriod,
	FirstProjectedPeriod,
	CurrencyCode,
	CanEmployeesViewBudget,
	IsReforecast,
	IsDeleted,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	LastLockedDate,
	BudgetAllocationSetId,
	LastAMUpdateDate,
	BudgetReportGroupPeriodId,
	BudgetReportGroupPeriod,
	GroupEndPeriod,
	GBSBudgetId,
	MustImportAllActualsIntoWarehouse,
	ReforecastKey,
	BudgetReportGroupId
)
SELECT 
	BTP.ImportBatchId,
	Budget.ImportKey,
	BTP.SnapshotId AS SnapshotId,	
	Budget.BudgetId, 
	Budget.RegionId,
	Budget.BudgetTypeId,
	Budget.BudgetStatusId,
	Budget.Name,
	Budget.StartPeriod,
	Budget.EndPeriod,
	Budget.FirstProjectedPeriod,
	Budget.CurrencyCode,
	Budget.CanEmployeesViewBudget,
	Budget.IsReforecast,
	Budget.IsDeleted,
	Budget.InsertedDate,
	Budget.UpdatedDate,
	Budget.UpdatedByStaffId,
	Budget.LastLockedDate,
	Budget.BudgetAllocationSetId,
	Budget.LastAMUpdateDate,
    brg.BudgetReportGroupPeriodId,
    brgp.Period AS BudgetReportGroupPeriod,
    brg.EndPeriod AS GroupEndPeriod,
    GBSBudget.BudgetId AS GBSBudgetId,
    BTP.MustImportAllActualsIntoWarehouse,
    BTP.ReforecastKey, 
    BRGD.BudgetReportGroupId
FROM
	TapasGlobalBudgeting.Budget Budget
		
	INNER JOIN #BudgetsToProcess BTP ON -- All TAPAS budgets in dbo.BudgetsToProcess must be considered because they are to be processed into the warehouse
		Budget.BudgetId = BTP.BudgetId AND
		Budget.ImportBatchId = BTP.ImportBatchId
			
	INNER JOIN TapasGlobalBudgeting.BudgetReportGroupDetail BRGD ON
		Budget.BudgetId = brgd.BudgetId AND
		BRGD.ImportBatchId = BTP.ImportBatchId
		
	INNER JOIN TapasGlobalBudgeting.BudgetReportGroup brg ON
		brgd.BudgetReportGroupId = brg.BudgetReportGroupId	 AND
		BRG.ImportBatchId = BTP.ImportBatchId
		
	INNER JOIN Gdm.BudgetReportGroupPeriod brgp ON
		brgp.BudgetReportGroupPeriodId = brg.BudgetReportGroupPeriodId
		
	INNER JOIN Gdm.BudgetReportGroupPeriodActive(@DataPriorToDate) brgpA ON
		brgp.ImportKey = brgpA.ImportKey
				   
	LEFT OUTER JOIN #LastImportedGBSBudgets LIGB ON
		LIGB.BudgetReportGroupPeriodId = BRG.BudgetReportGroupPeriodId

	LEFT OUTER JOIN GBS.Budget GBSBudget ON
	   GBSBudget.BudgetReportGroupPeriodId = LIGB.BudgetReportGroupPeriodId AND
	   GBSBudget.BudgetId = LIGB.BudgetId AND
	   GBSBudget.ImportBatchId = LIGB.ImportBatchId
		
DECLARE @NumberOfBudgets INT = @@rowcount
		
PRINT ''Completed inserting records into #NewBudgets:''+CONVERT(char(10),@NumberOfBudgets)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

IF @NumberOfBudgets = 0 BEGIN
	PRINT ''#NewBudgets: Found NO Budgets to import. Nothing to do. Quitting...''
	--PRINT ''GBSBudget ImportID: '' + STR(LTRIM(@TempGBSImportBatchId))
	RETURN
END

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_BudgetID ON #newBudgets (SnapshotId, BudgetId)

PRINT ''Completed creating indexes on #Budget''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


----------------------------------------------------------------------------------------------
-- Source the GBS Budget
SET @StartTime = GETDATE()

;WITH CteDistinctTapasBudgets
AS
(
   SELECT 
        B.SnapshotId, 
		B.GBSBudgetId AS BudgetId, 
		B.FirstProjectedPeriod,
		B.MustImportAllActualsIntoWarehouse,
		B.ReforecastKey
	FROM 
		#NewBudgets B
		INNER JOIN 
			(	
				SELECT 
					MIN(BudgetId) AS BudgetId,
					MIN(SnapshotId) AS SnapshotId
				FROM 
					#NewBudgets 
				WHERE
					MustImportAllActualsIntoWarehouse = 1
				GROUP BY
					GBSBudgetId, 
					SnapshotId  
			) DB ON
			DB.BudgetId = B.BudgetId AND
			DB.SnapshotId = B.SnapshotId 	   
)
SELECT 
	LIGB.ImportBatchId,
	TB.SnapshotId as SnapshotId, 
	TB.BudgetId as TapasBudgetId,
    TB.FirstProjectedPeriod as FirstProjectedPeriod,	
    TB.MustImportAllActualsIntoWarehouse,
    TB.ReforecastKey,
	GB.BudgetId AS BudgetId,
	GB.ImportKey
INTO 
	#GBSBudgets 
FROM
	GBS.Budget GB
	INNER JOIN CteDistinctTapasBudgets TB ON
		TB.BudgetId = GB.BudgetId 
		
	INNER JOIN #LastImportedGBSBudgets LIGB ON
		LIGB.ImportBatchId = GB.ImportBatchId AND
		LIGB.BudgetReportGroupPeriodId = GB.BudgetReportGroupPeriodId AND
		LIGB.BudgetId = GB.BudgetId		
		
--WHERE 
--	GB.ImportBatchId = @TempGBSImportBatchId				
		
PRINT ''Completed inserting records into #GBSBudgets:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

BEGIN TRY		
	CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #GBSBudgets (SnapshotId, BudgetId, FirstProjectedPeriod)
	PRINT ''Completed creating indexes on #GBSBudgets''
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

END TRY
BEGIN CATCH
    DECLARE @ErrorSeverity  INT = ERROR_SEVERITY(), @ErrorMessage   NVARCHAR(4000) =
		''Error creating indexes on #GBSBudgets: '' + CONVERT(VARCHAR(10), ERROR_NUMBER()) + '':'' + ERROR_MESSAGE() 
	SELECT * FROM #GBSBudgets
    RAISERROR ( @ErrorMessage, @ErrorSeverity, 1)
END CATCH

----------------------------------------------------------------------------------------------
-- DISTINCT Snapshots
----------------------------------------------------------------------------------------------
-- Source the Distinct snapshots

SELECT DISTINCT 
	SnapshotId 
INTO 
	#DistinctSnapshots 
FROM 
	#NewBudgets
	
SELECT DISTINCT
	ImportBatchId
INTO
	#DistinctImports
FROM 
	#BudgetsToProcess BTP

----------------------------------------------------------------------------------------------
-- All combined Budgets GBS + Tapas
----------------------------------------------------------------------------------------------

SELECT 
	SnapshotId, 
	BudgetId,
	ImportKey
INTO
	#AllBudgets	
FROM
	#NewBudgets
UNION ALL 
SELECT 
	SnapshotId, 
	BudgetId,
	ImportKey 
FROM
	#GBSBudgets

--SELECT * FROM #AllBudgets

CREATE TABLE #SystemSettingRegion
(
	SystemSettingId INT NOT NULL,
	SystemSettingName VARCHAR(50) NOT NULL,
	SystemSettingRegionId INT NOT NULL,
	RegionId INT,
	SourceCode VARCHAR(2),
	BonusCapExcessProjectId INT
)

SET @StartTime = GETDATE()

-- #GLTranslationType
CREATE TABLE #SnapshotGLTranslationType(
	SnapshotId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

SET @StartTime = GETDATE()

INSERT INTO #SnapshotGLTranslationType(
	SnapshotId,
	GLTranslationTypeId,
	Code,
	[Name],
	[Description],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	DS.SnapshotId,
	TT.GLTranslationTypeId,
	TT.Code,
	TT.Name,
	TT.[Description],
	TT.IsActive,
	TT.InsertedDate,
	TT.UpdatedDate,
	TT.UpdatedByStaffId
FROM
	Gdm.SnapshotGLTranslationType TT 
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = TT.SnapshotId

PRINT ''Completed inserting records into #SnapshotGLTranslationType:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE TABLE #SnapshotGLAccountType(
	SnapshotId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

-- #SystemSettingRegion
SET @StartTime = GETDATE()

INSERT INTO #SystemSettingRegion
(
	SystemSettingId,
	SystemSettingName,
	SystemSettingRegionId,
	RegionId,
	SourceCode,
	BonusCapExcessProjectId
)

SELECT 
	ss.SystemSettingId,
	ss.Name,
	ssr.SystemSettingRegionId,
	ssr.RegionId,
	ssr.SourceCode,
	ssr.BonusCapExcessProjectId
FROM
	(
		SELECT 
			ssr.* 
		FROM
			TapasGlobal.SystemSettingRegion ssr
			INNER JOIN TapasGlobal.SystemSettingRegionActive(@DataPriorToDate) ssrA ON
				ssr.ImportKey = ssrA.ImportKey
	 ) ssr

	INNER JOIN
		(
			SELECT
				ss.SystemSettingId,
				ss.Name
			FROM
			(
				SELECT	
					ss.*
				FROM
					TapasGlobal.SystemSetting ss
					INNER JOIN TapasGlobal.SystemSettingActive(@DataPriorToDate) ssA ON
						ss.ImportKey = ssA.ImportKey
			 ) ss
		) ss ON ssr.SystemSettingId = ss.SystemSettingId

PRINT ''Completed inserting #SystemSettingRegion''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

-- #GLTranslationSubType
CREATE TABLE #SnapshotGLTranslationSubType(
	SnapshotId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsGRDefault BIT NOT NULL
)
INSERT INTO #SnapshotGLTranslationSubType(
	SnapshotId,
	GLTranslationSubTypeId,
	GLTranslationTypeId,
	Code,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsGRDefault
)
SELECT
	DS.SnapshotId,
	TST.GLTranslationSubTypeId,
	TST.GLTranslationTypeId,
	TST.Code,
	TST.[Name],
	TST.IsActive,
	TST.InsertedDate,
	TST.UpdatedDate,
	TST.UpdatedByStaffId,
	TST.IsGRDefault
FROM
	Gdm.SnapshotGLTranslationSubType TST
	INNER JOIN #DistinctSnapshots DS ON
	  TST.SnapshotId = DS.SnapshotId
WHERE
    TST.Code = ''GL''	  AND
    TST.IsActive = 1

SET @RowCount = @@ROWCOUNT
IF @RowCount = 0
BEGIN
	RAISERROR(''#SnapshotGLTranslationSubType: NO Records inserted, please check there are rows in Gdm.SnapshotGLTranslationSubType for the Snapshots in BudgetsToProcess'', 16, -1)
	RETURN
END

PRINT ''Completed inserting records to #SnapshotGLTranslationSubType:''+CONVERT(char(10),@RowCount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE INDEX IX_SnapshotGLTranslationSubType1 ON #SnapshotGLTranslationSubType (SnapshotId)

PRINT ''Completed creating indexes on #SnapshotGLTranslationSubType''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE TABLE #SnapshotGLGlobalAccount(
	GLGlobalAccountId INT NOT NULL,
	ActivityTypeId INT NULL,
	GLStatutoryTypeId INT NOT NULL,
	ParentGLGlobalAccountId INT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] NVARCHAR(150) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsGR BIT NOT NULL,
	IsGbs BIT NOT NULL,
	IsRegionalOverheadCost BIT NOT NULL,
	ExpenseCzarStaffId INT NOT NULL,
	ParentCode AS (left(Code,(8))),
	SnapshotId INT NOT NULL
)
INSERT INTO #SnapshotGLGlobalAccount (
	GLGlobalAccountId,
	ActivityTypeId,
	GLStatutoryTypeId,
	ParentGLGlobalAccountId,
	Code,
	[Name],
	[Description],
	IsGR,
	IsGbs,
	IsRegionalOverheadCost,
	ExpenseCzarStaffId,
	SnapshotId
)
SELECT
	GLGA.GLGlobalAccountId,
	GLGA.ActivityTypeId,
	GLGA.GLStatutoryTypeId,
	GLGA.ParentGLGlobalAccountId,
	GLGA.Code,
	GLGA.Name,
	GLGA.[Description],
	GLGA.IsGR,
	GLGA.IsGbs,
	GLGA.IsRegionalOverheadCost,
	GLGA.ExpenseCzarStaffId,
	GLGA.SnapshotId
FROM
	Gdm.SnapshotGLGlobalAccount GLGA
	INNER JOIN #DistinctSnapshots DS ON
		GLGA.SnapshotId = DS.SnapshotId
WHERE
	GLGA.IsActive = 1

PRINT (''Rows inserted into #SnapshotGLGlobalAccount: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))	

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_SnapshotGLGlobalAccount1 ON #SnapshotGLGlobalAccount (SnapshotId, GLGlobalAccountId)

PRINT ''Completed creating indexes on #SnapshotGLGlobalAccount''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



-- AllocationSubRegion --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #SnapshotAllocationSubRegion (
	SnapshotId int NOT NULL,
	AllocationSubRegionGlobalRegionId int NOT NULL,
	Code varchar(10) NOT NULL,
	[Name] varchar(50) NOT NULL,
	AllocationRegionGlobalRegionId int NULL,
	DefaultCorporateSourceCode char(2) NOT NULL
)
INSERT INTO #SnapshotAllocationSubRegion
SELECT
	ASR.SnapshotId,
	ASR.AllocationSubRegionGlobalRegionId,
	ASR.Code,
	ASR.Name,
	ASR.AllocationRegionGlobalRegionId,
	ASR.DefaultCorporateSourceCode
FROM
	Gdm.SnapshotAllocationSubRegion ASR
	INNER JOIN #DistinctSnapshots DS ON
		ASR.SnapshotId = DS.SnapshotId
WHERE
	ASR.IsActive = 1

PRINT (''Rows inserted into #AllocationSubRegion: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- #GLMajorCategory

CREATE TABLE #SnapshotGLMajorCategory(
	SnapshotId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)
SET @StartTime = GETDATE()

INSERT INTO #SnapshotGLMajorCategory(
	SnapshotId,
	GLMajorCategoryId,
	GLTranslationSubTypeId,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	DS.SnapshotId,
	MajC.GLMajorCategoryId,
	MajC.GLTranslationSubTypeId,
	MajC.[Name],
	MajC.IsActive,
	MajC.InsertedDate,
	MajC.UpdatedDate,
	MajC.UpdatedByStaffId
FROM
	Gdm.SnapshotGLMajorCategory MajC
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = MajC.SnapshotId


PRINT (''Rows inserted into #SnapshotGLMajorCategory: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_SnapshotGLMajorCategory ON #SnapshotGLMajorCategory (SnapshotId, GLMajorCategoryId)

PRINT ''Completed creating indexes on #SnapshotGLMajorCategory''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- #GLMinorCategory

CREATE TABLE #SnapshotGLMinorCategory(
	SnapshotId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	[Name] VARCHAR(100) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)
SET @StartTime = GETDATE()

INSERT INTO #SnapshotGLMinorCategory(
	SnapshotId,
	GLMinorCategoryId,
	GLMajorCategoryId,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	DS.SnapshotId,
	Minc.GLMinorCategoryId,
	Minc.GLMajorCategoryId,
	Minc.[Name],
	Minc.IsActive,
	Minc.InsertedDate,
	Minc.UpdatedDate,
	Minc.UpdatedByStaffId
FROM
	Gdm.SnapshotGLMinorCategory MinC
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = MinC.SnapshotId
		
PRINT (''Rows inserted into #SnapshotGLMinorCategory: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
		
		
SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_SnapshotGLMinorCategory1 ON #SnapshotGLMinorCategory (SnapshotId, GLMinorCategoryId)

PRINT ''Completed creating indexes on #SnapshotGLMinorCategory''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
		
		
-- #GLAccountType
SET @StartTime = GETDATE()

INSERT INTO #SnapshotGLAccountType(
	SnapshotId,
	GLAccountTypeId,
	GLTranslationTypeId,
	Code,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	DS.SnapshotId,
	AT.GLAccountTypeId,
	AT.GLTranslationTypeId,
	AT.Code,
	AT.Name,
	AT.IsActive,
	AT.InsertedDate,
	AT.UpdatedDate,
	AT.UpdatedByStaffId	
FROM
	Gdm.SnapshotGLAccountType AT
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = AT.SnapshotId

PRINT (''Rows inserted into #SnapshotGLAccountType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
	
-- #GLAccountSubType

SET @StartTime = GETDATE()

CREATE TABLE #SnapshotGLAccountSubType(
	SnapshotId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)
INSERT INTO #SnapshotGLAccountSubType(
	SnapshotId,
	GLAccountSubTypeId,
	GLTranslationTypeId,
	Code,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	DS.SnapshotId,
	AST.GLAccountSubTypeId,
	AST.GLTranslationTypeId,
	AST.Code,
	AST.Name,
	AST.IsActive,
	AST.InsertedDate,
	AST.UpdatedDate,
	AST.UpdatedByStaffId
FROM
	Gdm.SnapshotGLAccountSubType AST
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = AST.SnapshotId

PRINT (''Rows inserted into #SnapshotGLAccountSubType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLGlobalAccount --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #SnapshotGLGlobalAccountTranslationSubType (
	SnapshotId INT NOT NULL,
	GLGlobalAccountTranslationSubTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL
)
INSERT INTO #SnapshotGLGlobalAccountTranslationSubType
SELECT
	GATST.SnapshotId,
	GATST.GLGlobalAccountTranslationSubTypeId,
	GATST.GLGlobalAccountId,
	GATST.GLTranslationSubTypeId,
	GATST.GLMinorCategoryId
FROM
	Gdm.SnapshotGLGlobalAccountTranslationSubType GATST
	INNER JOIN #DistinctSnapshots B ON
		GATST.SnapshotId = B.SnapshotId
WHERE
	GATST.IsActive = 1

PRINT (''Rows inserted into #SnapshotGLGlobalAccountTranslationSubType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLGlobalAccountTranslationType --------------------------------------------------

CREATE INDEX IX_SnapshotGLGlobalAccountTranslationSubType1 ON #SnapshotGLGlobalAccountTranslationSubType (GLGlobalAccountId, SnapshotId)

PRINT ''Completed creating indexes on #SnapshotGLGlobalAccountTranslationSubType''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE TABLE #SnapshotGLGlobalAccountTranslationType(
	GLGlobalAccountTranslationTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #SnapshotGLGlobalAccountTranslationType
SELECT
	GATT.GLGlobalAccountTranslationTypeId, 
	GATT.GLGlobalAccountId, 
	GATT.GLTranslationTypeId, 
	GATT.GLAccountTypeId,	
	CASE WHEN
			GA.ActivityTypeId = 99
		 THEN 
				-- GC :: CC1 >>
				-- Unallocated overhead expenses will be grouped under the “Overhead” expense 
				-- type and not “Non-Payroll”. This will be based on the activity of the 
				-- transaction; all transactions that have a corporate overhead activity 
				-- will have an expense type of “Overhead”.
			
			AST.GLAccountSubTypeId
			
				--(
				--	SELECT
				--		*--GST.GLAccountSubTypeId 
				--	FROM
				--		Gdm.SnapshotGLAccountSubType GST 
				--		INNER JOIN Gdm.SnapshotGLTranslationType GTT ON
				--			GTT.GLTranslationTypeId = GST.GLTranslationTypeId
				--		INNER JOIN #Budget B ON
				--			GST.SnapshotId = B.SnapshotId AND
				--			GTT.SnapshotId = B.SnapshotId
				--	WHERE
				--		GTT.Code = ''GL'' AND
				--		GST.Code = ''GRPOHD''	AND
				--		GST.IsActive = 1 AND
				--		GTT.IsActive = 1
				--)				
		 ELSE
			GATT.GLAccountSubTypeId
	END AS GLAccountSubTypeId,
	GATT.SnapshotId
FROM
	Gdm.SnapshotGLGlobalAccountTranslationType GATT
	
	INNER JOIN #GBSBudgets DS ON
		GATT.SnapshotId = DS.SnapshotId	

	LEFT OUTER JOIN (
						SELECT
							GA.*
						FROM
							#SnapshotGLGlobalAccount GA

					 ) GA ON
							GA.GLGlobalAccountId = GATT.GLGlobalAccountId AND
							GA.SnapshotId = GATT.SnapshotId

	LEFT OUTER JOIN (
						SELECT
							GST.GLAccountSubTypeId,
							B.BudgetId,
							GST.SnapshotId
						FROM
							Gdm.SnapshotGLAccountSubType GST 
							INNER JOIN Gdm.SnapshotGLTranslationType GTT ON
								GTT.GLTranslationTypeId = GST.GLTranslationTypeId
							INNER JOIN #GBSBudgets B ON
								GST.SnapshotId = B.SnapshotId AND
								GTT.SnapshotId = B.SnapshotId 
						WHERE
							GTT.Code = ''GL'' AND
							GST.Code = ''GRPOHD''	AND
							GST.IsActive = 1 AND
							GTT.IsActive = 1
					) AST ON
							GATT.SnapshotId = AST.SnapshotId AND
							DS.BudgetId = AST.BudgetId

WHERE
	GATT.IsActive = 1

PRINT (''Rows inserted into #GLGlobalAccountTranslationType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

------------------------------------------------------------------------------
-- Master GL Account Category mapping table GBS
------------------------------------------------------------------------------
SET @StartTime = GETDATE()

CREATE TABLE #GLAccountCategoryMapping (
	SnapshotId INT NOT NULL,
	GLAccountKey INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL
)
INSERT INTO #GLAccountCategoryMapping
SELECT
	DS.SnapshotId,
	Gla.GlAccountKey,
	TST.GLTranslationTypeId,
	TST.GLTranslationSubTypeId,
	MinC.GLMajorCategoryId,
	GLATST.GLMinorCategoryId,
	GLATT.GLAccountTypeId,
	GLATT.GLAccountSubTypeId
FROM
	#DistinctSnapshots DS

	INNER JOIN #SnapshotGLTranslationSubType TST ON
		DS.SnapshotId = TST.SnapshotId

	INNER JOIN #SnapshotGLGlobalAccountTranslationSubType GLATST ON
		TST.GLTranslationSubTypeId = GLATST.GLTranslationSubTypeId AND
		DS.SnapshotId = GLATST.SnapshotId
	
	INNER JOIN #SnapshotGLGlobalAccountTranslationType GLATT ON
		GLATST.GLGlobalAccountId = GLATT.GLGlobalAccountId AND
		TST.GLTranslationTypeId = GLATT.GLTranslationTypeId AND
		DS.SnapshotId = GLATT.SnapshotId

	INNER JOIN GrReporting.dbo.GlAccount Gla ON
		GLATT.GLGlobalAccountId = GLA.GLGlobalAccountId AND
		DS.SnapshotId = GLA.SnapshotId

	INNER JOIN #SnapshotGLMinorCategory MinC ON
		GLATST.GLMinorCategoryId = MinC.GLMinorCategoryId AND
		DS.SnapshotId = MinC.SnapshotId

	INNER JOIN #SnapshotGLMajorCategory MajC ON
		MinC.GLMajorCategoryId = MajC.GLMajorCategoryId AND
		DS.SnapshotId = MajC.SnapshotId

PRINT (''Rows inserted into #GLAccountCategoryMapping: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

-- Get GLTranslationType, GLTranslationSubType, GLAccountType(either expense type), and GLAccountSubType(either payroll type) data
-- This table is used when inserts are made to the TranslationSubType CategoryLookup tables: search for ''Map account categories'' section

CREATE TABLE #SnapshotGLAccountCategoryTranslationsPayroll(
	SnapshotId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLTranslationSubTypeCode VARCHAR(10) NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL
)

INSERT INTO #SnapshotGLAccountCategoryTranslationsPayroll(
	SnapshotId,
	GLTranslationTypeId,
	GLTranslationSubTypeId,
	GLTranslationSubTypeCode,
	GLAccountTypeId,
	GLAccountSubTypeId
)
SELECT
    TST.SnapshotId,
	TST.GLTranslationTypeId,
	TST.GLTranslationSubTypeId,
	TST.Code,
	AT.GLAccountTypeId,
	AST.GLAccountSubTypeId
FROM
	#SnapshotGLTranslationSubType TST

	INNER JOIN #SnapshotGLTranslationType TT ON
		TT.GLTranslationTypeId = TST.GLTranslationTypeId AND
		TST.SnapshotId = TT.SnapshotId

	INNER JOIN #SnapshotGLAccountType AT ON
		TST.GLTranslationTypeId = AT.GLTranslationTypeId AND
		AT.IsActive = 1 AND
		AT.SnapshotId = TST.SnapshotId

	INNER JOIN #SnapshotGLAccountSubType AST ON
		TST.GLTranslationTypeId = AST.GLTranslationTypeId AND
		AST.IsActive = 1 AND
		AST.SnapshotId = TST.SnapshotId
	
WHERE
	AST.Code LIKE ''%PYR'' AND -- This stored procedure exclusively looks at payroll. Only consider Account SubTypes related to payroll.
	AT.Code LIKE ''%EXP'' AND -- Only consider expense-related account types: Payroll is always considered as an expense.
	TT.IsActive = 1 AND
	TST.IsActive = 1 AND
	AT.IsActive = 1 AND
	AST.IsActive = 1

PRINT ''Completed inserting records to #SnapshotGLAccountCategoryTranslationsPayroll:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE TABLE #SnapshotGLAccountCategoryTranslationsOverhead(
    SnapshotId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLTranslationSubTypeCode VARCHAR(10) NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL
)

INSERT INTO #SnapshotGLAccountCategoryTranslationsOverhead(
	SnapshotId,
	GLTranslationTypeId,
	GLTranslationSubTypeId,
	GLTranslationSubTypeCode,
	GLAccountTypeId,
	GLAccountSubTypeId
)
SELECT
    TST.SnapshotId,
	TST.GLTranslationTypeId,
	TST.GLTranslationSubTypeId,
	TST.Code,
	AT.GLAccountTypeId,
	AST.GLAccountSubTypeId
FROM
	#SnapshotGLTranslationSubType TST

	INNER JOIN #SnapshotGLTranslationType TT ON
		TT.GLTranslationTypeId = TST.GLTranslationTypeId AND
		TT.SnapshotId = TST.SnapshotId

	INNER JOIN #SnapshotGLAccountType AT ON
		TST.GLTranslationTypeId = AT.GLTranslationTypeId AND
		AT.IsActive = 1 AND
		AT.SnapshotId = TST.SnapshotId

	INNER JOIN #SnapshotGLAccountSubType AST ON
		TST.GLTranslationTypeId = AST.GLTranslationTypeId AND
		AST.IsActive = 1 AND
		AST.SnapshotId = TST.SnapshotId
	
WHERE
	AST.Code LIKE ''%OHD'' AND -- This stored procedure exclusively looks at payroll. Only consider Account SubTypes related to payroll.
	AT.Code LIKE ''%EXP'' AND -- Only consider expense-related account types: Payroll is always considered as an expense.
	TT.IsActive = 1 AND
	TST.IsActive = 1 AND
	AT.IsActive = 1 AND
	AST.IsActive = 1

PRINT ''Completed inserting records to #SnapshotGLAccountCategoryTranslationsOverhead:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

------------------------------------------------------------------------------------------------------
--Source and identify report grouping records
------------------------------------------------------------------------------------------------------

-- Source tax type
SET @StartTime = GETDATE()


CREATE TABLE #TaxType(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	TaxTypeId INT NOT NULL,
	RegionId INT NOT NULL,
	FixedTaxTypeId INT NOT NULL,
	RateCalculationMethodId INT NOT NULL,
	Name VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL
)

INSERT INTO #TaxType(
	ImportKey,
	ImportBatchId,
	ImportDate,
	TaxTypeId,
	RegionId,
	FixedTaxTypeId,
	RateCalculationMethodId,
	Name,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	MinorGlAccountCategoryId
)
SELECT 
	TaxType.*
FROM 
	TapasGlobalBudgeting.TaxType TaxType
	
	INNER JOIN #DistinctImports DI ON
		DI.ImportBatchId = TaxType.ImportBatchId
	
	
PRINT ''Completed inserting records into #TaxType:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_TaxType ON #TaxType (ImportBatchId, TaxTypeId)

PRINT ''Completed creating indexes on #TaxType''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- Source budget report group detail. 

SET @StartTime = GETDATE()

CREATE TABLE #BudgetReportGroupDetail(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetReportGroupDetailId INT NOT NULL,
	BudgetReportGroupId INT NOT NULL,
	RegionId INT NOT NULL,
	BudgetId INT NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)
INSERT INTO #BudgetReportGroupDetail(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetReportGroupDetailId,
	BudgetReportGroupId,
	RegionId,
	BudgetId,
	IsDeleted,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	brgd.*
FROM 
	TapasGlobalBudgeting.BudgetReportGroupDetail brgd

	INNER JOIN #BudgetsToProcess BTP ON
		BRGD.ImportBatchId = BTP.ImportBatchId AND
		BRGD.BudgetId = BTP.BudgetId
	
--select * from #BudgetReportGroupDetail
		
PRINT ''Completed inserting records into #BudgetReportGroupDetail:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source budget report group.
SET @StartTime = GETDATE()

CREATE TABLE #BudgetReportGroup(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetReportGroupId INT NOT NULL,
	[Name] VARCHAR(100) NOT NULL,
	BudgetExchangeRateId INT NOT NULL,
	IsReforecast BIT NOT NULL,
	StartPeriod INT NOT NULL,
	EndPeriod INT NOT NULL,
	FirstProjectedPeriod INT NULL,
	IsDeleted BIT NOT NULL,
	GRChangedDate DATETIME NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	BudgetReportGroupPeriodId INT NULL
)

INSERT INTO #BudgetReportGroup(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetReportGroupId,
	[Name],
	BudgetExchangeRateId,
	IsReforecast,
	StartPeriod,
	EndPeriod,
	FirstProjectedPeriod,
	IsDeleted,
	GRChangedDate,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	BudgetReportGroupPeriodId
)
SELECT 
	brg.* 
FROM 
	TapasGlobalBudgeting.BudgetReportGroup brg
	INNER JOIN #BudgetsToProcess BTP ON
		BRG.ImportBatchId = BTP.ImportBatchId
		
	INNER JOIN #NewBudgets B ON
		B.BudgetId = BTP.BudgetId AND
		B.ImportBatchId = BTP.ImportBatchId AND
		B.BudgetReportGroupId = BRG.BudgetReportGroupId
	
--select * from #BudgetReportGroup
	
PRINT ''Completed inserting records into #BudgetReportGroup:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source report group period mapping.
SET @StartTime = GETDATE()

CREATE TABLE #BudgetReportGroupPeriod(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetReportGroupPeriodId INT NOT NULL,
	BudgetExchangeRateId INT NOT NULL,
	[Year] INT NOT NULL,
	Period INT NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #BudgetReportGroupPeriod(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetReportGroupPeriodId,
	BudgetExchangeRateId,
	[Year],
	Period,
	IsDeleted,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	brgp.*
FROM    
	Gdm.BudgetReportGroupPeriod brgp -- THIS TABLE HAS NO SNAPSHOT
	

	INNER JOIN Gdm.BudgetReportGroupPeriodActive(@DataPriorToDate) brgpA ON
		brgp.ImportKey = brgpA.ImportKey
			
--select * from #BudgetReportGroupPeriod

PRINT ''Completed inserting records into #BudgetReportGroupPeriod:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source budget status
SET @StartTime = GETDATE()

CREATE TABLE #BudgetStatus(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetStatusId INT NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	[Description] VARCHAR(100) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)
INSERT INTO #BudgetStatus(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetStatusId,
	[Name],
	[Description],
	InsertedDate,
	UpdatedByStaffId
)
SELECT 
	BudgetStatus.* 
FROM
	TapasGlobalBudgeting.BudgetStatus BudgetStatus
	
	INNER JOIN #DistinctImports DI ON
		DI.ImportBatchId = BudgetStatus.ImportBatchId
	
	
PRINT ''Completed inserting records into #BudgetStatus:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

------------------------------------------------------------------------------------------------------
--Source associated records
------------------------------------------------------------------------------------------------------

-- Source budget project
SET @StartTime = GETDATE()

CREATE TABLE #BudgetProject(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetProjectId INT NOT NULL,
	BudgetId INT NOT NULL,
	ProjectId INT NULL,
	RegionId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	Code VARCHAR(50) NULL,
	[Name] VARCHAR(100) NULL,
	CorporateDepartmentCode VARCHAR(6) NULL,
	CorporateSourceCode VARCHAR(2) NULL,
	StartPeriod INT NOT NULL,
	EndPeriod INT NULL,
	IsReimbursable BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetProjectId INT NULL,
	IsTsCost BIT NOT NULL,
	CanAllocateOverheads BIT NOT NULL,
	AllocateOverheadsProjectId INT NULL,
	MarkUpPercentage DECIMAL(5, 4) NULL,
	ProjectOwnerStaffId INT NULL,
	AMBudgetProjectId INT NULL
)
INSERT INTO #BudgetProject(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetProjectId,
	BudgetId,
	ProjectId,
	RegionId,
	PropertyFundId,
	ActivityTypeId,
	Code,
	[Name],
	CorporateDepartmentCode,
	CorporateSourceCode,
	StartPeriod,
	EndPeriod,
	IsReimbursable,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetProjectId,
	IsTsCost,
	CanAllocateOverheads,
	AllocateOverheadsProjectId,
	MarkUpPercentage,
	ProjectOwnerStaffId,
	AMBudgetProjectId
)
SELECT 
	BudgetProject.*
FROM 
	TapasGlobalBudgeting.BudgetProject BudgetProject

	INNER JOIN #BudgetsToProcess BTP ON
		BudgetProject.ImportBatchId = BTP.ImportBatchId AND
		BudgetProject.BudgetId = BTP.BudgetId
		

PRINT ''Completed inserting records into #BudgetProject:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_BudgetID ON #BudgetProject (BudgetId)
CREATE INDEX IX_BudgetProjectId ON #BudgetProject (BudgetProjectId)

PRINT ''Completed creating indexes on #BudgetProject''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source region
SET @StartTime = GETDATE()

CREATE TABLE #Region(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	RegionId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	PayCode VARCHAR(5) NULL,
	EnrollmentTypeId INT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)
INSERT INTO #Region(
	ImportKey,
	ImportBatchId,
	ImportDate,
	RegionId,
	SourceCode,
	Code,
	[Name],
	PayCode,
	EnrollmentTypeId,
	InsertedDate,
	UpdatedDate
)
SELECT 
	SourceRegion.*
FROM 
	HR.Region SourceRegion
	INNER JOIN HR.RegionActive(@DataPriorToDate) SourceRegionA ON
		SourceRegion.ImportKey = SourceRegionA.ImportKey

PRINT ''Completed inserting records into #Region:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Budget Employee
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployee(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	BudgetId INT NOT NULL,
	HrEmployeeId INT NULL,
	PayGroupId INT NOT NULL,
	JobTitleId INT NOT NULL,
	LocationId INT NOT NULL,
	StateId INT NULL,
	OverheadRegionId INT NOT NULL,
	ApproverStaffId INT NULL,
	[Name] VARCHAR(255) NOT NULL,
	IsUnion BIT NOT NULL,
	RehirePeriod INT NOT NULL,
	RehireDate DATETIME NOT NULL,
	TerminatePeriod INT NULL,
	TerminateDate DATETIME NULL,
	EmployeeHistoryEffectivePeriod INT NOT NULL,
	EmployeeHistoryEffectiveDate DATETIME NOT NULL,
	EmployeePayrollEffectiveDate DATETIME NULL,
	CurrentAnnualSalary DECIMAL(18, 2) NULL,
	PreviousYearSalary DECIMAL(18, 2) NULL,
	SalaryYear INT NOT NULL,
	PreviousYearBonus DECIMAL(18, 2) NULL,
	BonusYear INT NULL,
	IsActualEmployee BIT NOT NULL,
	IsReviewed BIT NOT NULL,
	IsPartTime BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetEmployeeId INT NULL
)
INSERT INTO #BudgetEmployee(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeeId,
	BudgetId,
	HrEmployeeId,
	PayGroupId,
	JobTitleId,
	LocationId,
	StateId,
	OverheadRegionId ,
	ApproverStaffId,
	[Name],
	IsUnion,
	RehirePeriod,
	RehireDate,
	TerminatePeriod,
	TerminateDate,
	EmployeeHistoryEffectivePeriod,
	EmployeeHistoryEffectiveDate,
	EmployeePayrollEffectiveDate,
	CurrentAnnualSalary,
	PreviousYearSalary,
	SalaryYear,
	PreviousYearBonus,
	BonusYear,
	IsActualEmployee,
	IsReviewed,
	IsPartTime,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetEmployeeId
)
SELECT 
	BudgetEmployee.* 
FROM 
	TapasGlobalBudgeting.BudgetEmployee BudgetEmployee
	
	INNER JOIN #BudgetsToProcess BTP ON
		BudgetEmployee.BudgetId = BTP.BudgetId AND
		BudgetEmployee.ImportBatchId = BTP.ImportBatchId
	

PRINT ''Completed inserting records into #BudgetEmployee:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_BudgetEmployeeID ON #BudgetEmployee (BudgetEmployeeId)
CREATE INDEX IX_BudgetId ON #BudgetEmployee (BudgetId)

PRINT ''Completed creating indexes on ##BudgetEmployee''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Budget Employee Functional Department
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeeFunctionalDepartment(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeeFunctionalDepartmentId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	SubDepartmentId INT NOT NULL,
	EffectivePeriod INT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL
)

INSERT INTO #BudgetEmployeeFunctionalDepartment(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeeFunctionalDepartmentId,
	BudgetEmployeeId,
	SubDepartmentId,
	EffectivePeriod,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	FunctionalDepartmentId
)
SELECT 
	efd.* 
FROM 
	TapasGlobalBudgeting.BudgetEmployeeFunctionalDepartment efd
	
	INNER JOIN #DistinctImports DI ON
		EFD.ImportBatchId = DI.ImportBatchId
	
	-- data limiting join
	INNER JOIN #BudgetEmployee be ON
		efd.BudgetEmployeeId = be.BudgetEmployeeId

PRINT ''Completed inserting records into #BudgetEmployeeFunctionalDepartment:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_BudgetEmployeeId ON #BudgetEmployeeFunctionalDepartment (ImportBatchId, BudgetEmployeeId)
CREATE INDEX IX_BudgetEmployeeFunctionalDepartment2 ON #BudgetEmployeeFunctionalDepartment (ImportBatchId, BudgetEmployeeId, EffectivePeriod)


PRINT ''Completed creating indexes on #BudgetEmployeeFunctionalDepartment''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- FunctionalDepartment --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #SnapshotFunctionalDepartment (
    SnapshotId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	Code VARCHAR(20) NULL,
	GlobalCode VARCHAR(30) NULL
)

INSERT INTO #SnapshotFunctionalDepartment
SELECT
    DS.SnapshotId,
	FunctionalDepartmentId,
	Code,
	GlobalCode
FROM
	Gdm.SnapshotFunctionalDepartment FD
	INNER JOIN #DistinctSnapshots DS ON
		FD.SnapshotId = DS.SnapshotId
WHERE
	FD.IsActive = 1

PRINT (''Rows inserted into #FunctionalDepartment: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- Source Property Fund
SET @StartTime = GETDATE()

CREATE TABLE #SnapshotPropertyFund(
--	ImportKey INT NOT NULL,
--	ImportBatchId INT NOT NULL,
--	ImportDate DATETIME NOT NULL,
	SnapshotId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	RelatedFundId INT NULL,
	EntityTypeId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	BudgetOwnerStaffId INT NOT NULL,
	RegionalOwnerStaffId INT NOT NULL,
	DefaultGLTranslationSubTypeId INT NULL,
	Name VARCHAR(100) NOT NULL,
	IsReportingEntity BIT NOT NULL,
	IsPropertyFund BIT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
--	SnapshotId INT NOT NULL
)

INSERT INTO #SnapshotPropertyFund(
	--ImportKey,
	--ImportBatchId,
	--ImportDate,
	SnapshotId,
	PropertyFundId,
	RelatedFundId,
	EntityTypeId,
	AllocationSubRegionGlobalRegionId,
	BudgetOwnerStaffId,
	RegionalOwnerStaffId,
	DefaultGLTranslationSubTypeId,
	Name,
	IsReportingEntity,
	IsPropertyFund,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
	--SnapshotId
)
SELECT 
	DS.SnapshotId,
	PropertyFund.PropertyFundId,
	PropertyFund.RelatedFundId,
	PropertyFund.EntityTypeId,
	PropertyFund.AllocationSubRegionGlobalRegionId,
	PropertyFund.BudgetOwnerStaffId,
	PropertyFund.RegionalOwnerStaffId,
	PropertyFund.DefaultGLTranslationSubTypeId,
	PropertyFund.Name,
	PropertyFund.IsReportingEntity,
	PropertyFund.IsPropertyFund,
	PropertyFund.IsActive,
	PropertyFund.InsertedDate,
	PropertyFund.UpdatedDate,
	PropertyFund.UpdatedByStaffId
	--PropertyFund.SnapshotId as SnapshotId
FROM 
	Gdm.SnapshotPropertyFund PropertyFund
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = PropertyFund.SnapshotId
	
	--INNER JOIN Gdm.PropertyFundActive(@DataPriorToDate) PropertyFundA ON
	--	PropertyFund.ImportKey = PropertyFundA.ImportKey 

PRINT ''Completed inserting records into #SnapshotPropertyFund:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_PropertyFundId ON #SnapshotPropertyFund (SnapshotId, PropertyFundId)

PRINT ''Completed creating indexes on #SnapshotPropertyFund''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Property Fund Mapping
SET @StartTime = GETDATE()

CREATE TABLE #SnapshotPropertyFundMapping(
	--ImportKey INT NOT NULL,
	--ImportBatchId INT NOT NULL,
	--ImportDate DATETIME NOT NULL,
	SnapshotId INT NOT NULL,
	PropertyFundMappingId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	PropertyFundCode VARCHAR(8) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL,
	ActivityTypeId INT NULL
)

INSERT INTO #SnapshotPropertyFundMapping(
	--ImportKey,
	--ImportBatchId,
	--ImportDate,
	SnapshotId,
	PropertyFundMappingId,
	PropertyFundId,
	SourceCode,
	PropertyFundCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted,
	ActivityTypeId
)
SELECT 
	DS.SnapshotId,
	PropertyFundMapping.PropertyFundMappingId,
	PropertyFundMapping.PropertyFundId,
	PropertyFundMapping.SourceCode,
	PropertyFundMapping.PropertyFundCode,
	PropertyFundMapping.InsertedDate,
	PropertyFundMapping.UpdatedDate,
	PropertyFundMapping.IsDeleted,
	PropertyFundMapping.ActivityTypeId
FROM 
	Gdm.SnapshotPropertyFundMapping PropertyFundMapping
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = PropertyFundMapping.SnapshotId
	
PRINT ''Completed inserting records into #PropertyFundMapping:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_PropertyFundId ON #SnapshotPropertyFundMapping (SnapshotId, PropertyFundCode, SourceCode, IsDeleted, ActivityTypeId)
CREATE INDEX IX_PropertyFundMapping2 ON #SnapshotPropertyFundMapping (PropertyFundId) -- create as a seperate index as this is how its used.

 -- remove property fund id PropertyFundId,

PRINT ''Completed creating indexes on #PropertyFundMapping''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source ReportingEntityCorporateDepartment
SET @StartTime = GETDATE()

CREATE TABLE #SnapshotReportingEntityCorporateDepartment( -- GDM 2.0 addition
	--ImportKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	ReportingEntityCorporateDepartmentId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	CorporateDepartmentCode CHAR(6) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsDeleted BIT NOT NULL,
)

INSERT INTO	#SnapshotReportingEntityCorporateDepartment(
	--ImportKey,
	SnapshotId,
	ReportingEntityCorporateDepartmentId,
	PropertyFundId,
	SourceCode,
	CorporateDepartmentCode,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsDeleted
)
SELECT
	--RECD.ImportKey,
	DS.SnapshotId,
	RECD.ReportingEntityCorporateDepartmentId,
	RECD.PropertyFundId,
	RECD.SourceCode,
	RECD.CorporateDepartmentCode,
	RECD.InsertedDate,
	RECD.UpdatedDate,
	RECD.UpdatedByStaffId,
	RECD.IsDeleted
FROM
	Gdm.SnapshotReportingEntityCorporateDepartment RECD
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = RECD.SnapshotId
		
PRINT ''Completed inserting records into #SnapshotReportingEntityCorporateDepartment:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()


CREATE CLUSTERED INDEX IX_SnapshotReportingEntityCorporateDepartment1 ON #SnapshotReportingEntityCorporateDepartment 
	(CorporateDepartmentCode, SourceCode, IsDeleted, SnapshotId)


PRINT ''Completed creating indexes on #SnapshotReportingEntityCorporateDepartment''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source ReportingEntityPropertyEntity
SET @StartTime = GETDATE()

CREATE TABLE #SnapshotReportingEntityPropertyEntity( -- GDM 2.0 addition
	--ImportKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	ReportingEntityPropertyEntityId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	PropertyEntityCode CHAR(6) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsDeleted BIT NOT NULL
)

INSERT INTO #SnapshotReportingEntityPropertyEntity(
	--ImportKey,
	SnapshotId,
	ReportingEntityPropertyEntityId,
	PropertyFundId,
	SourceCode,
	PropertyEntityCode,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsDeleted
)
SELECT
	--REPE.ImportKey,
	DS.SnapshotId,
	REPE.ReportingEntityPropertyEntityId,
	REPE.PropertyFundId,
	REPE.SourceCode,
	REPE.PropertyEntityCode,
	REPE.InsertedDate,
	REPE.UpdatedDate,
	REPE.UpdatedByStaffId,
	REPE.IsDeleted
FROM
	Gdm.SnapshotReportingEntityPropertyEntity REPE
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = REPE.SnapshotId
	
PRINT ''Completed inserting records into #SnapshotReportingEntityPropertyEntity:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_SnapshotReportingEntityPropertyEntity1 ON #SnapshotReportingEntityPropertyEntity (PropertyEntityCode, SourceCode, IsDeleted, SnapshotId)

PRINT ''Completed creating indexes on #SnapshotReportingEntityPropertyEntity''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Location
SET @StartTime = GETDATE()

CREATE TABLE #Location(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	LocationId INT NOT NULL,
	ExternalSubRegionId INT NOT NULL,
	StateId INT NULL,
	Code VARCHAR(10) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

INSERT INTO #Location(
	ImportKey,
	ImportBatchId,
	ImportDate,
	LocationId,
	ExternalSubRegionId,
	StateId,
	Code,
	Name,
	IsActive,
	InsertedDate,
	UpdatedDate
)
SELECT 
	Location.* 
FROM 
	HR.Location Location
	INNER JOIN HR.LocationActive(@DataPriorToDate) LocationA ON
		Location.ImportKey = LocationA.ImportKey
	
PRINT ''Completed inserting records into #Location:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_LocationId ON #Location (LocationId)

PRINT ''Completed creating indexes on #Location''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source region extended
SET @StartTime = GETDATE()

CREATE TABLE #RegionExtended(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	RegionId INT NOT NULL,
	RegionalAdministratorId INT NOT NULL,
	CountryId INT NOT NULL,
	HasEmployees BIT NOT NULL,
	CanChargeMarkupOnProject BIT NOT NULL,
	CanChargeMarkupOnPayrollOverhead BIT NOT NULL,
	CanUploadOverheadJournal BIT NOT NULL,
	ProjectRef VARCHAR(8) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OverheadFunctionalDepartmentId INT NOT NULL,
	CanRegionBillInArrears BIT NOT NULL
)

INSERT INTO #RegionExtended(
	ImportKey,
	ImportBatchId,
	ImportDate,
	RegionId,
	RegionalAdministratorId,
	CountryId,
	HasEmployees,
	CanChargeMarkupOnProject,
	CanChargeMarkupOnPayrollOverhead,
	CanUploadOverheadJournal,
	ProjectRef,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OverheadFunctionalDepartmentId,
	CanRegionBillInArrears
)
SELECT 
	RegionExtended.*
FROM 
	TapasGlobal.RegionExtended RegionExtended
	INNER JOIN TapasGlobal.RegionExtendedActive(@DataPriorToDate) RegionExtendedA ON
		RegionExtended.ImportKey = RegionExtendedA.ImportKey

PRINT ''Completed inserting records into #RegionExtended:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_RegionId ON #RegionExtended (RegionId)

PRINT ''Completed creating indexes on #RegionExtended''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- Source Payroll Originating Region
SET @StartTime = GETDATE()

CREATE TABLE #PayrollRegion(
	ImportKey INT NOT NULL,
	PayrollRegionId INT NOT NULL,
	RegionId INT NOT NULL,
	ExternalSubRegionId INT NOT NULL,
	CorporateEntityRef VARCHAR(6) NOT NULL,
	CorporateSourceCode VARCHAR(2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #PayrollRegion(
	ImportKey,
	PayrollRegionId,
	RegionId,
	ExternalSubRegionId,
	CorporateEntityRef,
	CorporateSourceCode,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT 
	PayrollRegion.*
FROM 
	TapasGlobal.PayrollRegion PayrollRegion
	INNER JOIN TapasGlobal.PayrollRegionActive(@DataPriorToDate) PayrollRegionA ON
		PayrollRegion.ImportKey = PayrollRegionA.ImportKey
	
PRINT ''Completed inserting records into #PayrollRegion:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_PayrollRegionId ON #PayrollRegion (PayrollRegionId)

PRINT ''Completed creating indexes on #PayrollRegion''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Overhead Originating Region
SET @StartTime = GETDATE()

CREATE TABLE #OverheadRegion(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	OverheadRegionId INT NOT NULL,
	RegionId INT NOT NULL,
	CorporateEntityRef VARCHAR(6) NULL,
	CorporateSourceCode VARCHAR(2) NULL,
	Name VARCHAR(50) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #OverheadRegion(
	ImportKey,
	ImportBatchId,
	ImportDate,
	OverheadRegionId,
	RegionId,
	CorporateEntityRef,
	CorporateSourceCode,
	Name,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)

SELECT 
	OverheadRegion.*
FROM 
	TapasGlobal.OverheadRegion OverheadRegion
	INNER JOIN TapasGlobal.OverheadRegionActive(@DataPriorToDate) OverheadRegionA ON
		OverheadRegion.ImportKey = OverheadRegionA.ImportKey
	
PRINT ''Completed inserting records into #OverheadRegion:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_OverheadRegionId ON #OverheadRegion (OverheadRegionId)

PRINT ''Completed creating indexes on #OverheadRegion''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source project
SET @StartTime = GETDATE()

CREATE TABLE #Project(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	ProjectId INT NOT NULL,
	RegionId INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	ProjectOwnerId INT NULL,
	CorporateDepartmentCode VARCHAR(8) NOT NULL,
	CorporateSourceCode CHAR(2) NOT NULL,
	Code VARCHAR(50) NOT NULL,
	Name VARCHAR(100) NOT NULL,
	StartPeriod INT NOT NULL,
	EndPeriod INT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	PropertyOverheadGLAccountCode VARCHAR(15) NULL,
	PropertyOverheadDepartmentCode VARCHAR(6) NULL,
	PropertyOverheadJobCode VARCHAR(15) NULL,
	PropertyOverheadSourceCode CHAR(2) NULL,
	CorporateUnionPayrollIncomeCategoryCode VARCHAR(6) NULL,
	CorporateNonUnionPayrollIncomeCategoryCode VARCHAR(6) NULL,
	CorporateOverheadIncomeCategoryCode VARCHAR(6) NULL,
	PropertyFundId INT NOT NULL,
	MarkUpPercentage DECIMAL(5, 4) NULL,
	HistoricalProjectCode VARCHAR(50) NULL,
	IsTSCost BIT NOT NULL,
	CanAllocateOverheads BIT NOT NULL,
	AllocateOverheadsProjectId INT NULL
)

INSERT INTO #Project(
	ImportKey,
	ImportBatchId,
	ImportDate,
	ProjectId,
	RegionId,
	ActivityTypeId,
	ProjectOwnerId,
	CorporateDepartmentCode,
	CorporateSourceCode,
	Code,
	Name,
	StartPeriod,
	EndPeriod,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	PropertyOverheadGLAccountCode,
	PropertyOverheadDepartmentCode,
	PropertyOverheadJobCode,
	PropertyOverheadSourceCode,
	CorporateUnionPayrollIncomeCategoryCode,
	CorporateNonUnionPayrollIncomeCategoryCode,
	CorporateOverheadIncomeCategoryCode,
	PropertyFundId,
	MarkUpPercentage,
	HistoricalProjectCode,
	IsTSCost,
	CanAllocateOverheads,
	AllocateOverheadsProjectId
)
SELECT 
	Project.*
FROM 
	TapasGlobal.Project Project
	INNER JOIN TapasGlobal.ProjectActive(@DataPriorToDate) ProjectA ON
		Project.ImportKey = ProjectA.ImportKey 

PRINT ''Completed inserting records into #Project:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_ProjectId ON #Project (ProjectId)

PRINT ''Completed creating indexes on #Project''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- #Department
SET @StartTime = GETDATE()


-- #OriginatingRegionPropertyDepartment

CREATE TABLE #SnapshotOriginatingRegionPropertyDepartment( -- GDM 2.0 addition
	--ImportKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	OriginatingRegionPropertyDepartmentId INT NOT NULL,
	GlobalRegionId INT NOT NULL,
	PropertyDepartmentCode VARCHAR(10) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL	
)


------------------------------------------------------------------------------------------------------
-- Additional required mappings
------------------------------------------------------------------------------------------------------

-- #OriginatingRegionCorporateEntity
SET @StartTime = GETDATE()

CREATE TABLE #SnapshotOriginatingRegionCorporateEntity( -- GDM 2.0 addition
--	ImportKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	OriginatingRegionCorporateEntityId INT NOT NULL,
	GlobalRegionId INT NOT NULL,
	CorporateEntityCode VARCHAR(10) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL	
)

INSERT INTO #SnapshotOriginatingRegionCorporateEntity(
	--ImportKey,
	SnapshotId,
	OriginatingRegionCorporateEntityId,
	GlobalRegionId,
	CorporateEntityCode,
	SourceCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted
)
SELECT
--	ORCE.ImportKey,
	DS.SnapshotId,
	ORCE.OriginatingRegionCorporateEntityId,
	ORCE.GlobalRegionId,
	ORCE.CorporateEntityCode,
	ORCE.SourceCode,
	ORCE.InsertedDate,
	ORCE.UpdatedDate,
	ORCE.IsDeleted	
FROM
	Gdm.SnapshotOriginatingRegionCorporateEntity ORCE
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = ORCE.SnapshotId

PRINT ''Completed inserting into #OriginatingRegionCorporateEntity''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #SnapshotOriginatingRegionCorporateEntity (SnapshotId, CorporateEntityCode, 
	SourceCode, IsDeleted) -- remove GlobalRegionId

PRINT ''Completed creating indexes on #OriginatingRegionCorporateEntity''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()


INSERT INTO #SnapshotOriginatingRegionPropertyDepartment(
	--ImportKey,
	SnapshotId,
	OriginatingRegionPropertyDepartmentId,
	GlobalRegionId,
	PropertyDepartmentCode,
	SourceCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted
)
SELECT
	--ORPD.ImportKey,
	DS.SnapshotId,
	ORPD.OriginatingRegionPropertyDepartmentId,
	ORPD.GlobalRegionId,
	ORPD.PropertyDepartmentCode,
	ORPD.SourceCode,
	ORPD.InsertedDate,
	ORPD.UpdatedDate,
	ORPD.IsDeleted
FROM
	Gdm.SnapshotOriginatingRegionPropertyDepartment ORPD
	INNER JOIN #DistinctSnapshots DS ON
		DS.SnapShotId = ORPD.SnapshotId

PRINT ''Completed inserting records into #SnapshotOriginatingRegionPropertyDepartment:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()
	
CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #SnapshotOriginatingRegionPropertyDepartment (SnapshotId, PropertyDepartmentCode, 
	SourceCode, IsDeleted) --, GlobalRegionId) -- not needed?

PRINT ''Completed Creating Indexes on #SnapshotOriginatingRegionPropertyDepartment''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

-- #Department


CREATE TABLE #Department(
	[ImportKey] [int] NOT NULL,
	[Department] [char](8) NOT NULL,
	[Description] [varchar](50) NULL,
	[LastDate] [datetime] NULL,
	[MRIUserID] [char](20) NULL,
	[Source] [char](2) NOT NULL,
	[IsActive] [bit] NOT NULL,
	[FunctionalDepartmentId] [int] NULL,
	[UpdatedDate] [datetime] NOT NULL,
	[IsTsCost] [bit] NOT NULL
)


INSERT INTO	#Department 
(ImportKey, Department,Description,LastDate,MRIUserID,Source,IsActive,FunctionalDepartmentId,UpdatedDate,IsTsCost)
SELECT
	Dept.ImportKey, Dept.Department, Dept.Description, Dept.LastDate, Dept.MRIUserID, Dept.Source,
	Dept.IsActive, Dept.FunctionalDepartmentId, Dept.UpdatedDate, Dept.IsTsCost
FROM
	Gacs.Department Dept
	
	INNER JOIN Gacs.DepartmentActive(@DataPriorToDate) DeptA ON
		DeptA.ImportKey = Dept.ImportKey
	

PRINT ''Completed inserting records into #Department:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
	
SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_Department ON #Department (Department, [Source])

PRINT ''Completed creating indexes on #Department''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
	
		
------------------------------------------------------------------------------------------------------
--Source allocation records
------------------------------------------------------------------------------------------------------

-- Source payroll allocation
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeePayrollAllocation(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	BudgetProjectId INT NOT NULL,
	BudgetProjectGroupId INT NULL,
	Period INT NOT NULL,
	SalaryAllocationValue DECIMAL(18, 9) NOT NULL,
	BonusAllocationValue DECIMAL(18, 9) NULL,
	BonusCapAllocationValue DECIMAL(18, 9) NULL,
	ProfitShareAllocationValue DECIMAL(18, 9) NULL,
	PreTaxSalaryAmount DECIMAL(18, 2) NOT NULL,
	PreTaxBonusAmount DECIMAL(18, 2) NULL,
	PreTaxBonusCapExcessAmount DECIMAL(18, 2) NULL,
	PreTaxProfitShareAmount DECIMAL(18, 2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetEmployeePayrollAllocationId INT NULL
)

INSERT INTO #BudgetEmployeePayrollAllocation(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeePayrollAllocationId,
	BudgetEmployeeId,
	BudgetProjectId,
	BudgetProjectGroupId,
	Period,
	SalaryAllocationValue,
	BonusAllocationValue,
	BonusCapAllocationValue,
	ProfitShareAllocationValue,
	PreTaxSalaryAmount,
	PreTaxBonusAmount,
	PreTaxBonusCapExcessAmount,
	PreTaxProfitShareAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetEmployeePayrollAllocationId
)
SELECT
	Allocation.*
FROM
	TapasGlobalBudgeting.BudgetEmployeePayrollAllocation Allocation

	INNER JOIN #DistinctImports DI ON
		Allocation.ImportBatchId = DI.ImportBatchId

	--data limiting join
	INNER JOIN #BudgetProject BP ON
		Allocation.BudgetProjectId = bp.BudgetProjectId 
		


PRINT ''Completed inserting records into #BudgetEmployeePayrollAllocation:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_BudgetEmployeePayrollAllocationId ON #BudgetEmployeePayrollAllocation (ImportBatchId, BudgetEmployeePayrollAllocationId)


PRINT ''Completed creating indexes on #BudgetEmployeePayrollAllocation''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source payroll tax detail
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Using the ''active'' function here cause serious performance issues and the only way around it, was to extract the logic from the is active function 
--to seperate peaces of code.
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeePayrollAllocationDetailBatches(
	BudgetEmployeePayrollAllocationDetailId int NOT NULL,
	ImportBatchId INT NOT NULL
)

INSERT INTO #BudgetEmployeePayrollAllocationDetailBatches(
	BudgetEmployeePayrollAllocationDetailId,
	ImportBatchId
)
SELECT
	B2.BudgetEmployeePayrollAllocationDetailId,
	MAX(B2.ImportBatchId) AS ImportBatchId
FROM 
	[TapasGlobalBudgeting].[BudgetEmployeePayrollAllocationDetail] B2
	
	INNER JOIN #DistinctImports DI ON
		DI.ImportBatchId = B2.ImportBatchId

GROUP BY
	B2.BudgetEmployeePayrollAllocationDetailId		
		
/*WHERE	
	batch.BatchEndDate IS NOT NULL AND
	batch.PackageName = ''ETL.Staging.TapasGlobalBudgeting'' AND
	batch.ImportEndDate <= @DataPriorToDate		
GROUP BY
	B2.BudgetEmployeePayrollAllocationDetailId*/

PRINT ''Completed inserting records into #BudgetEmployeePayrollAllocationDetailBatches:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_BudgetEmployeePayrollAllocationDetailBatches ON #BudgetEmployeePayrollAllocationDetailBatches (ImportBatchId, BudgetEmployeePayrollAllocationDetailId)

PRINT ''Completed creating indexes IX_BudgetEmployeePayrollAllocationDetailBatches:''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE TABLE #BEPADa(
	ImportKey INT NOT NULL
)

INSERT INTO #BEPADa(
	ImportKey
)
SELECT
	MAX(B1.ImportKey) ImportKey
FROM
	[TapasGlobalBudgeting].[BudgetEmployeePayrollAllocationDetail] B1

	INNER JOIN #BudgetEmployeePayrollAllocationDetailBatches t1 ON 
		t1.ImportBatchId = B1.ImportBatchId AND
		t1.BudgetEmployeePayrollAllocationDetailId = B1.BudgetEmployeePayrollAllocationDetailId
		

GROUP BY
	B1.BudgetEmployeePayrollAllocationDetailId

PRINT ''Completed inserting records into #BEPADa:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE INDEX IX_BEPADa1 ON #BEPADa (ImportKey)

PRINT ''Completed creating indexes on #Budget''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeePayrollAllocationDetail(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeePayrollAllocationDetailId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BenefitOptionId INT NULL,
	BudgetTaxTypeId INT NULL,
	SalaryAmount DECIMAL(18, 2) NULL,
	BonusAmount DECIMAL(18, 2) NULL,
	ProfitShareAmount DECIMAL(18, 2) NULL,
	BonusCapExcessAmount DECIMAL(18, 2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #BudgetEmployeePayrollAllocationDetail(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeePayrollAllocationDetailId,
	BudgetEmployeePayrollAllocationId,
	BenefitOptionId,
	BudgetTaxTypeId,
	SalaryAmount,
	BonusAmount,
	ProfitShareAmount,
	BonusCapExcessAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	TaxDetail.*
FROM
	TapasGlobalBudgeting.BudgetEmployeePayrollAllocationDetail TaxDetail
	
	/*
	INNER JOIN #DistinctImports DI ON
		DI.ImportBatchId = TaxDetail.ImportBatchId*/
	
    --data limiting join
	INNER JOIN #BudgetEmployeePayrollAllocation Allocation ON
		Allocation.ImportBatchId = TaxDetail.ImportBatchId AND
		Allocation.BudgetEmployeePayrollAllocationId = TaxDetail.BudgetEmployeePayrollAllocationId
		
	INNER JOIN #BEPADa TaxDetailA ON
		TaxDetail.ImportKey = TaxDetailA.ImportKey
		

PRINT ''Completed inserting records into #BudgetEmployeePayrollAllocationDetail:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_BudgetEmployeePayrollAllocationDetailId ON #BudgetEmployeePayrollAllocationDetail (ImportBatchId, BudgetEmployeePayrollAllocationDetailId)

PRINT ''Completed creating indexes on #BudgetEmployeePayrollAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source budget tax type
SET @StartTime = GETDATE()

CREATE TABLE #BudgetTaxType(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetTaxTypeId INT NOT NULL,
	BudgetId INT NOT NULL,
	TaxTypeId INT NOT NULL,
	FixedTaxTypeId INT NOT NULL,
	RateCalculationMethodId INT NOT NULL,
	Name VARCHAR(100) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetTaxTypeId INT NULL
)

INSERT INTO #BudgetTaxType(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetTaxTypeId,
	BudgetId,
	TaxTypeId,
	FixedTaxTypeId,
	RateCalculationMethodId,
	Name,
	InsertedDate,
	UpdatedByStaffId,
	OriginalBudgetTaxTypeId
)
SELECT 
	BudgetTaxType.* 
FROM 
	TapasGlobalBudgeting.BudgetTaxType BudgetTaxType
	
	INNER JOIN #BudgetsToProcess BTP ON
		BudgetTaxType.ImportBatchId = BTP.ImportBatchId AND
		BudgetTaxType.BudgetId = BTP.BudgetId
	
PRINT ''Completed inserting records into #BudgetTaxType:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_BudgetTaxTypeId ON #BudgetTaxType (BudgetTaxTypeId)

PRINT ''Completed creating indexes on #BudgetTaxType''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

-- Source payroll allocation Tax detail
CREATE TABLE #EmployeePayrollAllocationDetail
(
	ImportKey INT NOT NULL,
	BudgetEmployeePayrollAllocationDetailId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	MinorGlAccountCategoryId INT NULL,
	BudgetTaxTypeId INT NULL,
	SalaryAmount DECIMAL(18, 2) NULL,
	BonusAmount DECIMAL(18, 2) NULL,
	ProfitShareAmount DECIMAL(18, 2) NULL,
	BonusCapExcessAmount DECIMAL(18, 2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #EmployeePayrollAllocationDetail
(
	ImportKey,
	BudgetEmployeePayrollAllocationDetailId,
	BudgetEmployeePayrollAllocationId,
	MinorGlAccountCategoryId,
	BudgetTaxTypeId,
	SalaryAmount,
	BonusAmount,
	ProfitShareAmount,
	BonusCapExcessAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	TaxDetail.ImportKey,
	TaxDetail.BudgetEmployeePayrollAllocationDetailId,
	TaxDetail.BudgetEmployeePayrollAllocationId,
	CASE WHEN (TaxDetail.BenefitOptionId IS NOT NULL) THEN @BenefitsMinorGlAccountCategoryId ELSE TaxType.MinorGlAccountCategoryId END AS MinorGlAccountCategoryId,
	TaxDetail.BudgetTaxTypeId,
	TaxDetail.SalaryAmount,
	TaxDetail.BonusAmount,
	TaxDetail.ProfitShareAmount,
	TaxDetail.BonusCapExcessAmount,
	TaxDetail.InsertedDate,
	TaxDetail.UpdatedDate,
	TaxDetail.UpdatedByStaffId
FROM

	-- Joining on allocation to limit amount of data
	#BudgetEmployeePayrollAllocation Allocation


	INNER JOIN #BudgetEmployeePayrollAllocationDetail TaxDetail ON
		Allocation.BudgetEmployeePayrollAllocationId = TaxDetail.BudgetEmployeePayrollAllocationId  AND
		Allocation.ImportBatchId = TaxDetail.ImportBatchId
			
	LEFT OUTER JOIN #BudgetTaxType BudgetTaxType ON
		TaxDetail.BudgetTaxTypeId = BudgetTaxType.BudgetTaxTypeId AND
		BudgetTaxType.ImportBatchId = Allocation.ImportBatchId
				
	LEFT OUTER JOIN #TaxType TaxType ON
		BudgetTaxType.TaxTypeId = TaxType.TaxTypeId	AND
		BudgetTaxType.ImportBatchId = TaxType.ImportBatchId
			
PRINT ''Completed inserting records into #EmployeePayrollAllocationDetail:''+CONVERT(char(10),@@rowcount)

PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #EmployeePayrollAllocationDetail (BudgetEmployeePayrollAllocationDetailId,  BudgetEmployeePayrollAllocationId)
CREATE INDEX IX_EmployeePayrollAllocationDetail2 ON #EmployeePayrollAllocationDetail (BudgetEmployeePayrollAllocationId)


PRINT ''Completed creating indexes on #EmployeePayrollAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--*/
-- Source payroll overhead allocation

SET @StartTime = GETDATE()

CREATE TABLE #BudgetOverheadAllocation(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetOverheadAllocationId INT NOT NULL,
	BudgetId INT NOT NULL,
	OverheadRegionId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	BudgetPeriod INT NOT NULL,
	AllocationAmount DECIMAL(18, 2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetOverheadAllocationId INT NULL
)

INSERT INTO #BudgetOverheadAllocation(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetOverheadAllocationId,
	BudgetId,
	OverheadRegionId,
	BudgetEmployeeId,
	BudgetPeriod,
	AllocationAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetOverheadAllocationId
)
SELECT
	OverheadAllocation.*
FROM
	TapasGlobalBudgeting.BudgetOverheadAllocation OverheadAllocation
	
	INNER JOIN #BudgetsToProcess BTP ON
		OverheadAllocation.ImportBatchId = BTP.ImportBatchId AND
		OverheadAllocation.BudgetId = BTP.BudgetId

PRINT ''Completed inserting records into #BudgetOverheadAllocation:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_Clustered ON #BudgetOverheadAllocation (BudgetOverheadAllocationId,BudgetId,OverheadRegionId,BudgetEmployeeId)
PRINT ''Completed creating indexes on #BudgetOverheadAllocation''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source overhead allocation detail
SET @StartTime = GETDATE()

CREATE TABLE #BudgetOverheadAllocationDetail(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetOverheadAllocationDetailId INT NOT NULL,
	BudgetOverheadAllocationId INT NOT NULL,
	BudgetProjectId INT NOT NULL,
	AllocationValue DECIMAL(18, 9) NOT NULL,
	AllocationAmount DECIMAL(18, 2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #BudgetOverheadAllocationDetail(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetOverheadAllocationDetailId,
	BudgetOverheadAllocationId,
	BudgetProjectId,
	AllocationValue,
	AllocationAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT 
	OverheadDetail.*
FROM			
	TapasGlobalBudgeting.BudgetOverheadAllocationDetail OverheadDetail
	
	INNER JOIN #DistinctImports DI ON
		OverheadDetail.ImportBatchId = DI.ImportBatchId
	
	-- data limiting join
	INNER JOIN #BudgetProject B ON
		OverheadDetail.BudgetProjectId = b.BudgetProjectId

PRINT ''Completed inserting records into #BudgetOverheadAllocationDetail:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_Clustered ON #BudgetOverheadAllocationDetail (BudgetOverheadAllocationId,BudgetOverheadAllocationDetailId)
CREATE INDEX IX_BudgetOverheadAllocationDetail2 ON #BudgetOverheadAllocationDetail (BudgetOverheadAllocationId)


PRINT ''Completed creating indexes on #BudgetOverheadAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source payroll overhead allocation detail
SET @StartTime = GETDATE()

CREATE TABLE #OverheadAllocationDetail
(
	ImportKey INT NOT NULL,
	BudgetOverheadAllocationDetailId INT NOT NULL,
	BudgetOverheadAllocationId INT NOT NULL,
	BudgetProjectId INT NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL,
	AllocationValue DECIMAL(18, 9) NOT NULL,
	AllocationAmount DECIMAL(18, 2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #OverheadAllocationDetail
(
	ImportKey,
	BudgetOverheadAllocationDetailId,
	BudgetOverheadAllocationId,
	BudgetProjectId,
	MinorGlAccountCategoryId,
	AllocationValue,
	AllocationAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	OverheadDetail.ImportKey,
	OverheadDetail.BudgetOverheadAllocationDetailId,
	OverheadDetail.BudgetOverheadAllocationId,
	OverheadDetail.BudgetProjectId,
	@OverheadMinorGlAccountCategoryId AS MinorGlAccountCategoryId,
	OverheadDetail.AllocationValue,
	OverheadDetail.AllocationAmount,
	OverheadDetail.InsertedDate,
	OverheadDetail.UpdatedDate,
	OverheadDetail.UpdatedByStaffId
FROM

	-- Joining on allocation to limit amount of data
	#BudgetOverheadAllocation OverheadAllocation
	
	INNER JOIN #BudgetOverheadAllocationDetail OverheadDetail ON
		OverheadAllocation.BudgetOverheadAllocationId = OverheadDetail.BudgetOverheadAllocationId 

PRINT ''Completed inserting records into #OverheadAllocationDetail:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_Clustered ON #OverheadAllocationDetail (BudgetOverheadAllocationId,BudgetOverheadAllocationDetailId)
CREATE INDEX IX_OverheadAllocationDetail2 ON #OverheadAllocationDetail (BudgetOverheadAllocationId)

PRINT ''Completed creating indexes on #OverheadAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Map Data
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

--Calculate effective functional department
SET @StartTime = GETDATE()

CREATE TABLE #EffectiveFunctionalDepartment(
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL
)

INSERT INTO #EffectiveFunctionalDepartment(
	BudgetEmployeePayrollAllocationId,
	BudgetEmployeeId,
	FunctionalDepartmentId
)
SELECT 
	Allocation.BudgetEmployeePayrollAllocationId,
	Allocation.BudgetEmployeeId,
	(
		SELECT 
			EFD.FunctionalDepartmentId
		FROM 
			(
				SELECT 
					Allocation2.ImportBatchId,
					Allocation2.BudgetEmployeeId,
					MAX(EFD.EffectivePeriod) AS EffectivePeriod
				FROM
					#BudgetEmployeePayrollAllocation Allocation2

					INNER JOIN #BudgetEmployeeFunctionalDepartment EFD ON
						Allocation2.BudgetEmployeeId = EFD.BudgetEmployeeId AND
						Allocation2.ImportBatchId = EFD.ImportBatchId
				
				WHERE
					Allocation.BudgetEmployeePayrollAllocationId = Allocation2.BudgetEmployeePayrollAllocationId AND
					Allocation.ImportBatchId = Allocation2.ImportBatchId AND
					EFD.EffectivePeriod <= Allocation.Period
					  
				GROUP BY
					Allocation2.ImportBatchId,
					Allocation2.BudgetEmployeeId
			) EFDo
		
			LEFT OUTER JOIN #BudgetEmployeeFunctionalDepartment EFD ON
				EFD.ImportBatchId = EFDo.ImportBatchId AND
				EFD.BudgetEmployeeId = EFDo.BudgetEmployeeId AND
				EFD.EffectivePeriod = EFDo.EffectivePeriod
				
	 ) AS FunctionalDepartmentId
FROM
	#BudgetEmployeePayrollAllocation Allocation

	INNER JOIN #BudgetProject BudgetProject ON 
		Allocation.BudgetProjectId = BudgetProject.BudgetProjectId

PRINT ''Completed inserting records into #EffectiveFunctionalDepartment:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

CREATE INDEX IX_EffectiveFunctionalDepartment_AllocId ON #EffectiveFunctionalDepartment (BudgetEmployeePayrollAllocationId)

PRINT ''Completed creating indexes on #EffectiveFunctionalDepartment''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

--Map Pre Tax Amounts
CREATE TABLE #ProfitabilityPreTaxSource
(
	ImportBatchId INT NOT NULL,
	BudgetId INT NOT NULL,
	BudgetRegionId INT NOT NULL,
	FirstProjectedPeriod char(6) NOT NULL,
	ProjectId INT NOT NULL,
	HrEmployeeId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	SalaryPreTaxAmount MONEY NOT NULL,
	ProfitSharePreTaxAmount MONEY NOT NULL,
	BonusPreTaxAmount MONEY NOT NULL,
	BonusCapExcessPreTaxAmount MONEY NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	FunctionalDepartmentCode VARCHAR(31) NULL,
	Reimbursable BIT NULL,
	ActivityTypeId INT NOT NULL,
	ActivityTypeCode VARCHAR(50) NOT NULL,
	PropertyFundId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode CHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	AllocationUpdatedDate DATETIME NOT NULL,
	BudgetReportGroupPeriod INT NOT NULL
)
-- Insert original budget amounts
INSERT INTO #ProfitabilityPreTaxSource
(
	ImportBatchId,
	BudgetId,
	BudgetRegionId,
	FirstProjectedPeriod,
	ProjectId,
	HrEmployeeId,
	BudgetEmployeePayrollAllocationId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	SalaryPreTaxAmount,
	ProfitSharePreTaxAmount,
	BonusPreTaxAmount,
	BonusCapExcessPreTaxAmount,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	ActivityTypeId,
	ActivityTypeCode,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	AllocationUpdatedDate,
	BudgetReportGroupPeriod
)
SELECT 
	Budget.ImportBatchId,
	Budget.BudgetId AS BudgetId,
	Budget.RegionId AS BudgetRegionId,
	Budget.FirstProjectedPeriod,
	ISNULL(BudgetProject.ProjectId,0) AS ProjectId,
	ISNULL(BudgetEmployee.HrEmployeeId,0) AS HrEmployeeId,
	Allocation.BudgetEmployeePayrollAllocationId,
	''TGB:BudgetId='' + CONVERT(varchar,Budget.BudgetId) + ''&ProjectId='' + CONVERT(varchar,ISNULL(BudgetProject.ProjectId,0)) + ''&HrEmployeeId='' + CONVERT(varchar,ISNULL(BudgetEmployee.HrEmployeeId,0)) + ''&BudgetEmployeePayrollAllocationId='' + CONVERT(varchar,Allocation.BudgetEmployeePayrollAllocationId) + ''&BudgetEmployeePayrollAllocationDetailId=0&BudgetOverheadAllocationDetailId=0'' + ''&ImportKey='' + CONVERT(varchar, Allocation.ImportKey) AS ReferenceCode,
	Allocation.Period AS ExpensePeriod,
	SourceRegion.SourceCode,
	ISNULL(Allocation.PreTaxSalaryAmount,0) AS SalaryPreTaxAmount,
	ISNULL(Allocation.PreTaxProfitShareAmount, 0) AS ProfitSharePreTaxAmount,
	ISNULL(Allocation.PreTaxBonusAmount,0) AS BonusPreTaxAmount, 
	ISNULL(Allocation.PreTaxBonusCapExcessAmount,0) AS BonusCapExcessPreTaxAmount,
	ISNULL(EFD.FunctionalDepartmentId, -1),
	fd.GlobalCode AS FunctionalDepartmentCode, 
	--CASE WHEN BudgetProject.IsTsCost = 0 THEN 1 ELSE 0 END AS Reimbursable, -- CC 4 :: GC
	CASE WHEN Dept.IsTsCost = 0 THEN 1 ELSE 0 END Reimbursable,
	BudgetProject.ActivityTypeId,
	Att.ActivityTypeCode,
	ISNULL(CASE
				WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.PropertyFundId
				ELSE
					DepartmentPropertyFund.PropertyFundId 
			END, -1) AS PropertyFundId,
	-- Same case logic AS above
	
	ISNULL(CASE -- Same case logic as above
				WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,
			
	OriginatingRegion.CorporateEntityRef,
	OriginatingRegion.CorporateSourceCode,
	Budget.CurrencyCode AS LocalCurrencyCode,
	Allocation.UpdatedDate,
	Budget.BudgetReportGroupPeriod
FROM
	#BudgetEmployeePayrollAllocation Allocation

	INNER JOIN #BudgetProject BudgetProject ON 
		Allocation.BudgetProjectId = BudgetProject.BudgetProjectId
			
	--INNER JOIN  #FilteredModifiedReportBudget fmrb ON
		--BudgetProject.BudgetId = fmrb.BudgetId
			
	INNER JOIN #NewBudgets Budget ON 
		BudgetProject.BudgetId = Budget.BudgetId 
		
	LEFT OUTER JOIN #Region SourceRegion ON 
		Budget.RegionId = SourceRegion.RegionId 
		

	LEFT OUTER JOIN #EffectiveFunctionalDepartment efd ON
		Allocation.BudgetEmployeePayrollAllocationId = efd.BudgetEmployeePayrollAllocationId

	LEFT OUTER JOIN #SnapshotFunctionalDepartment fd ON 
		efd.FunctionalDepartmentId = fd.FunctionalDepartmentId and
		fd.SnapshotId = Budget.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON 
		GrSc.SourceCode = BudgetProject.CorporateSourceCode 
		
		

	LEFT OUTER JOIN #SnapshotPropertyFundMapping pfm ON
		BudgetProject.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		BudgetProject.CorporateSourceCode = pfm.SourceCode AND
		pfm.IsDeleted = 0 AND 
		(
			(GrSc.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId = BudgetProject.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND BudgetProject.ActivityTypeId IS NULL)
			)
		) AND
		Budget.BudgetReportGroupPeriod < 201007 AND
		Budget.SnapshotId = pfm.SnapshotId
	
	LEFT OUTER JOIN	#SnapshotReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		RECD.SourceCode = BudgetProject.CorporateSourceCode AND
		Budget.BudgetReportGroupPeriod >= 201007 AND			   
		RECD.IsDeleted = 0 AND
		RECD.SnapshotId = Budget.SnapshotId
		   
	LEFT OUTER JOIN #SnapshotReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		REPE.SourceCode = BudgetProject.CorporateSourceCode AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		REPE.IsDeleted = 0	 AND
		REPE.SnapshotId = Budget.SnapshotId
	
	LEFT OUTER JOIN #SnapshotPropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN Budget.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END
		AND DepartmentPropertyFund.SnapshotId = Budget.SnapshotId

	LEFT OUTER JOIN #SnapshotPropertyFund ProjectPropertyFund ON
		BudgetProject.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		ProjectPropertyFund.SnapshotId = Budget.SnapshotId
		

	LEFT OUTER JOIN #BudgetEmployee BudgetEmployee ON
		Allocation.BudgetEmployeeId = BudgetEmployee.BudgetEmployeeId
		
	LEFT OUTER JOIN #Location Location ON 
		Location.LocationId = BudgetEmployee.LocationId
		
	LEFT OUTER JOIN #PayrollRegion OriginatingRegion ON 
		Location.ExternalSubRegionId = OriginatingRegion.ExternalSubRegionId AND
		Budget.RegionId = OriginatingRegion.RegionId

	INNER JOIN GrReporting.dbo.ActivityType Att ON 
		Att.ActivityTypeId = BudgetProject.ActivityTypeId and
		Att.SnapshotId = Budget.SnapshotId
	
	LEFT OUTER JOIN #Department Dept ON
		Dept.DEPARTMENT = BudgetProject.CorporateDepartmentCode AND 
		Dept.[Source] = SourceRegion.SourceCode
		
WHERE
	Allocation.Period BETWEEN Budget.FirstProjectedPeriod AND Budget.GroupEndPeriod
	--Change Control 1 : GC 2010-09-01
	--BudgetProject.ActivityTypeId <> 99 -- exclude Corporate Overhead

PRINT ''Completed inserting records into #ProfitabilityPreTaxSource:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE INDEX IX_SalaryPreTaxAmount ON #ProfitabilityPreTaxSource (SalaryPreTaxAmount)
CREATE INDEX IX_ProfitSharePreTaxAmount ON #ProfitabilityPreTaxSource (ProfitSharePreTaxAmount)
CREATE INDEX IX_BonusPreTaxAmount ON #ProfitabilityPreTaxSource (BonusPreTaxAmount)
CREATE INDEX IX_BonusCapExcessPreTaxAmount ON #ProfitabilityPreTaxSource (BonusCapExcessPreTaxAmount)
CREATE INDEX IX_ProfitabilityPreTaxSource5 ON #ProfitabilityPreTaxSource (BudgetEmployeePayrollAllocationId)


PRINT ''Completed creating indexes on #ProfitabilityPreTaxSource''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--Map Tax Amounts
SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityTaxSource
(
	ImportBatchId INT NOT NULL,
	BudgetId INT NOT NULL,
	BudgetRegionId INT NOT NULL,
	FirstProjectedPeriod CHAR(6) NOT NULL,
	ProjectId INT NOT NULL,
	HrEmployeeId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BudgetEmployeePayrollAllocationDetailId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	SalaryTaxAmount MONEY NOT NULL,
	ProfitShareTaxAmount MONEY NOT NULL,
	BonusTaxAmount MONEY NOT NULL,
	BonusCapExcessTaxAmount MONEY NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	FunctionalDepartmentCode VARCHAR(31) NULL,
	Reimbursable BIT NULL,
	ActivityTypeId INT NOT NULL,
	ActivityTypeCode VARCHAR(50) NOT NULL,
	PropertyFundId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode CHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	AllocationUpdatedDate DATETIME NOT NULL,
	BudgetReportGroupPeriod INT NOT NULL,
)
--/*
-- Insert original budget amounts
INSERT INTO #ProfitabilityTaxSource
(
	ImportBatchId,
	BudgetId,
	BudgetRegionId,
	FirstProjectedPeriod,
	ProjectId,
	HrEmployeeId,
	BudgetEmployeePayrollAllocationId,
	BudgetEmployeePayrollAllocationDetailId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	SalaryTaxAmount,
	ProfitShareTaxAmount,
	BonusTaxAmount,
	BonusCapExcessTaxAmount,
	MinorGlAccountCategoryId,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	ActivityTypeId,
	ActivityTypeCode,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	AllocationUpdatedDate,
	BudgetReportGroupPeriod
)
SELECT 
	B.ImportBatchId,
	pts.BudgetId,
	pts.BudgetRegionId,
	pts.FirstProjectedPeriod,
	ISNULL(pts.ProjectId,0) AS ProjectId,
	ISNULL(pts.HrEmployeeId,0) AS HrEmployeeId,
	pts.BudgetEmployeePayrollAllocationId,
	TaxDetail.BudgetEmployeePayrollAllocationDetailId,
	''TGB:BudgetId='' + CONVERT(varchar,pts.BudgetId) + ''&ProjectId='' + CONVERT(varchar,ISNULL(pts.ProjectId,0)) + ''&HrEmployeeId='' + CONVERT(varchar,ISNULL(pts.HrEmployeeId,0)) + ''&BudgetEmployeePayrollAllocationId='' + CONVERT(varchar,pts.BudgetEmployeePayrollAllocationId) + ''&BudgetEmployeePayrollAllocationDetailId='' + CONVERT(varchar,TaxDetail.BudgetEmployeePayrollAllocationDetailId) + ''&BudgetOverheadAllocationDetailId=0'' + ''&ImportKey='' + CONVERT(varchar, TaxDetail.ImportKey) AS ReferenceCode,
	pts.ExpensePeriod,
	pts.SourceCode,
	ISNULL(TaxDetail.SalaryAmount, 0) AS SalaryTaxAmount,
	ISNULL(TaxDetail.ProfitShareAmount, 0) AS ProfitShareTaxAmount,
	ISNULL(TaxDetail.BonusAmount, 0) AS BonusTaxAmount,
	ISNULL(TaxDetail.BonusCapExcessAmount, 0) AS BonusCapExcessTaxAmount,
	TaxDetail.MinorGlAccountCategoryId,
	ISNULL(pts.FunctionalDepartmentId, -1),
	pts.FunctionalDepartmentCode, 
	pts.Reimbursable,
	pts.ActivityTypeId,
	pts.ActivityTypeCode,
	pts.PropertyFundId,
	ISNULL(PF.AllocationSubRegionGlobalRegionId, -1) AS AllocationSubRegionGlobalRegionId,
	pts.OriginatingRegionCode,
	pts.OriginatingRegionSourceCode,
	pts.LocalCurrencyCode,
	pts.AllocationUpdatedDate,
	pts.BudgetReportGroupPeriod
FROM
	#EmployeePayrollAllocationDetail TaxDetail

	INNER JOIN #ProfitabilityPreTaxSource pts ON
		TaxDetail.BudgetEmployeePayrollAllocationId = pts.BudgetEmployeePayrollAllocationId
		
	INNER JOIN #NewBudgets B on 
		B.BudgetId = pts.BudgetId
		
	LEFT OUTER JOIN #SnapshotPropertyFund PF ON
		pts.PropertyFundId = PF.PropertyFundId AND
		B.SnapshotId = PF.SnapshotId

PRINT ''Completed inserting records into #ProfitabilityTaxSource:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



SET @StartTime = GETDATE()

CREATE INDEX IX_ProfitabilityTaxSource1 ON #ProfitabilityTaxSource (SalaryTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource2 ON #ProfitabilityTaxSource  (ProfitShareTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource3 ON #ProfitabilityTaxSource  (BonusTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource4 ON #ProfitabilityTaxSource  (BonusCapExcessTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource5 ON #ProfitabilityTaxSource  (BudgetEmployeePayrollAllocationId)


PRINT ''Completed creating indexes on #ProfitabilityPreTaxSource''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


--Map Overhead Amounts
SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityOverheadSource
(
	ImportBatchId INT NOT NULL,
	BudgetId INT NOT NULL,
	FirstProjectedPeriod CHAR(6) NOT NULL,
	ProjectId INT NOT NULL,
	HrEmployeeId INT NOT NULL,
	BudgetOverheadAllocationDetailId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	OverheadAllocationAmount MONEY NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	FunctionalDepartmentCode VARCHAR(31) NULL,
	Reimbursable BIT NULL,
	ActivityTypeId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode CHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	OverheadUpdatedDate DATETIME NOT NULL
)
-- Insert original overhead amounts
INSERT INTO #ProfitabilityOverheadSource
(
	ImportBatchId,
	BudgetId,
	FirstProjectedPeriod,
	ProjectId,
	HrEmployeeId,
	BudgetOverheadAllocationDetailId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	OverheadAllocationAmount,
	MinorGlAccountCategoryId,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,	
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	OverheadUpdatedDate
)
SELECT
	Budget.ImportBatchId,
	Budget.BudgetId AS BudgetId,
	Budget.FirstProjectedPeriod,
	ISNULL(BudgetProject.ProjectId,0) AS ProjectId,
	ISNULL(BudgetEmployee.HrEmployeeId,0) AS HrEmployeeId,
	OverheadDetail.BudgetOverheadAllocationDetailId,
	''TGB:BudgetId='' + CONVERT(varchar,Budget.BudgetId) + ''&ProjectId='' + CONVERT(varchar,ISNULL(BudgetProject.ProjectId,0)) + ''&HrEmployeeId='' + CONVERT(varchar,ISNULL(BudgetEmployee.HrEmployeeId,0)) + ''&BudgetEmployeePayrollAllocationId=0&BudgetEmployeePayrollAllocationDetailId=0'' + ''&BudgetOverheadAllocationDetailId='' + CONVERT(varchar,OverheadDetail.BudgetOverheadAllocationDetailId) + ''&ImportKey='' + CONVERT(varchar, OverheadDetail.ImportKey) AS ReferenceCode,
	OverheadAllocation.BudgetPeriod AS ExpensePeriod,
	SourceRegion.SourceCode,
	ISNULL(OverheadDetail.AllocationAmount,0) AS OverheadAllocationAmount,
	OverheadDetail.MinorGlAccountCategoryId,
	ISNULL(RegionExtended.OverheadFunctionalDepartmentId, -1) AS FunctionalDepartmentId,
	fd.GlobalCode AS FunctionalDepartmentCode, 
	
	CASE
		WHEN (BudgetProject.AllocateOverheadsProjectId IS NULL OR BudgetProject.AllocateOverheadsProjectId = 0) THEN 
			CASE
				WHEN (BudgetProject.IsTsCost = 0) THEN -- Where ISTSCost is False the cost will be reimbursable
					1 
				ELSE
					0
			END
		ELSE
			0  --Where the BudgetProject.OverheadAllocationProjectID is populated: non-reimbursable
	END AS Reimbursable,
	
	BudgetProject.ActivityTypeId,
	
	CASE WHEN (BudgetProject.AllocateOverheadsProjectId IS NULL OR BudgetProject.AllocateOverheadsProjectId = 0) THEN 
		ISNULL(CASE WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.PropertyFundId
				ELSE 
					DepartmentPropertyFund.PropertyFundId 
				END, -1) 
	ELSE 
		ISNULL(OverheadPropertyFund.PropertyFundId, -1) 
	END AS PropertyFundId,
	
	ISNULL(CASE -- Same case logic as above
				WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,		
	
	OriginatingRegion.CorporateEntityRef,
	OriginatingRegion.CorporateSourceCode,
	Budget.CurrencyCode AS LocalCurrencyCode,
	OverheadDetail.UpdatedDate

FROM
	#BudgetOverheadAllocation OverheadAllocation 

	INNER JOIN #BudgetEmployee BudgetEmployee ON
		OverheadAllocation.BudgetEmployeeId = BudgetEmployee.BudgetEmployeeId

	INNER JOIN #OverheadAllocationDetail OverheadDetail ON
		OverheadAllocation.BudgetOverheadAllocationId = OverheadDetail.BudgetOverheadAllocationId
			
	INNER JOIN #BudgetProject BudgetProject ON 
		OverheadDetail.BudgetProjectId = BudgetProject.BudgetProjectId
		
	--INNER JOIN #FilteredModifiedReportBudget fmrb ON
	--	BudgetProject.BudgetId = fmrb.BudgetId
		
	INNER JOIN #NewBudgets Budget ON 
		BudgetProject.BudgetId = Budget.BudgetId
		
	LEFT OUTER JOIN #Region SourceRegion ON 
		Budget.RegionId = SourceRegion.RegionId
		
	LEFT OUTER JOIN #RegionExtended RegionExtended ON 
		SourceRegion.RegionId = RegionExtended.RegionId

	LEFT OUTER JOIN #SnapshotFunctionalDepartment fd ON 
		RegionExtended.OverheadFunctionalDepartmentId = fd.FunctionalDepartmentId and
		fd.SnapshotId = Budget.SnapshotId

	LEFT OUTER JOIN	#Project OverheadProject ON
		BudgetProject.AllocateOverheadsProjectId = OverheadProject.ProjectId

	LEFT OUTER JOIN #SnapshotPropertyFund ProjectPropertyFund ON
		BudgetProject.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		Budget.SnapshotId = ProjectPropertyFund.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON GrSc.SourceCode = BudgetProject.CorporateSourceCode
	
	LEFT OUTER JOIN #SnapshotPropertyFundMapping pfm ON
		BudgetProject.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		BudgetProject.CorporateSourceCode = pfm.SourceCode AND
		--ISNULL(BudgetProject.ActivityTypeId, -1) = ISNULL(pfm.ActivityTypeId, -1) AND 
		pfm.IsDeleted = 0 AND 
		(
			(GrSc.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId = BudgetProject.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND BudgetProject.ActivityTypeId IS NULL)
			)
		) AND
		Budget.BudgetReportGroupPeriod < 201007 AND
		Budget.SnapshotId = pfm.SnapshotId
	
	LEFT OUTER JOIN	#SnapshotReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		RECD.SourceCode = BudgetProject.CorporateSourceCode AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		RECD.IsDeleted = 0 AND
		RECD.SnapshotID = Budget.SnapshotId
		   
	LEFT OUTER JOIN #SnapshotReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		REPE.SourceCode = BudgetProject.CorporateSourceCode AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		REPE.IsDeleted = 0	 AND
		Budget.SnapshotId = REPE.SnapshotId
	
	LEFT OUTER JOIN #SnapshotPropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN Budget.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END
		AND DepartmentPropertyFund.SnapshotId = Budget.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.[Source] GrScO ON GrScO.SourceCode = OverheadProject.CorporateSourceCode

	LEFT OUTER JOIN #SnapshotPropertyFundMapping opfm ON
		OverheadProject.CorporateDepartmentCode = opfm.PropertyFundCode AND -- Combination of entity and corporate department
		OverheadProject.CorporateSourceCode = opfm.SourceCode AND
		--ISNULL(BudgetProject.ActivityTypeId, -1) = ISNULL(opfm.ActivityTypeId, -1) AND 
		opfm.IsDeleted = 0 AND 
		(
			(GrScO.IsProperty = ''YES'' AND opfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrScO.IsCorporate = ''YES'' AND opfm.ActivityTypeId = BudgetProject.ActivityTypeId)
				OR
				(GrScO.IsCorporate = ''YES'' AND opfm.ActivityTypeId IS NULL AND BudgetProject.ActivityTypeId IS NULL)
			)
		) AND
		Budget.BudgetReportGroupPeriod < 201007 AND
		Budget.SnapshotId = opfm.SnapshotId
	
	LEFT OUTER JOIN #SnapshotPropertyFund OverheadPropertyFund ON
		OverheadPropertyFund.PropertyFundId =	
			CASE
				WHEN Budget.BudgetReportGroupPeriod < 201007 THEN opfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END
		AND OverheadPropertyFund.SnapshotId = Budget.SnapshotId
	
	LEFT OUTER JOIN #OverheadRegion OriginatingRegion ON 
		OverheadAllocation.OverheadRegionId = OriginatingRegion.OverheadRegionId
		
WHERE
	OverheadAllocation.BudgetPeriod BETWEEN Budget.FirstProjectedPeriod AND Budget.GroupEndPeriod
		
PRINT ''Completed inserting records into #ProfitabilityOverheadSource:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

CREATE INDEX IX_ProfitabilityOverheadSource1 ON #ProfitabilityOverheadSource (OverheadAllocationAmount)

PRINT ''Completed creating indexes on #ProfitabilityOverheadSource''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Generate mapping records
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

 /*
;WITH CTE_GetGLAccountOverheadSubIds(SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode)
AS
(
	SELECT B.SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode From #SnapshotGLAccountCategoryTranslationsOverhead GLCTO	
		INNER JOIN #NewBudgets B ON
			B.SnapshotId = GLCTO.SnapshotId
	WHERE 
		GLTranslationSubTypeCode = ''GL''
),
CTE_GetGLAccountPayrollSubIds(SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode)
AS
(
	Select B.SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode From #SnapshotGLAccountCategoryTranslationsPayroll GLCTP
		INNER JOIN #NewBudgets B ON
			B.SnapshotId = GLCTP.SnapshotId
	WHERE 
		GLTranslationSubTypeCode = ''GL''
)
select top 1000
     ''#ProfitabilityPreTaxSource'' as Source, CASE WHEN PTS.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = PTS.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = PTS.BudgetId)
		END GLAccountSubTypeId, *
   from #ProfitabilityPreTaxSource PTS		
	*/	
SET @StartTime = GETDATE()
		
CREATE TABLE #ProfitabilityPayrollMapping
(
	ImportBatchId INT NOT NULL,
	SourceName varchar(50),
	BudgetId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	FirstProjectedPeriod CHAR(6) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	BudgetAmount MONEY NOT NULL,
	MajorGlAccountCategoryId INT NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	FunctionalDepartmentCode VARCHAR(31) NULL,
	Reimbursable BIT NOT NULL,
	FeeOrExpense  Varchar(20) NOT NULL,
	ActivityTypeId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode CHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	AllocationUpdatedDate DATETIME NOT NULL,
	GLAccountSubTypeIdGlobal INT NOT NULL,
	GlobalGlAccountCode Varchar(10) NULL
);
 
WITH CTE_GetGLAccountOverheadSubIds(SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode)
AS
(
	SELECT B.SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode From #SnapshotGLAccountCategoryTranslationsOverhead GLCTO	
		INNER JOIN #NewBudgets B ON
			B.SnapshotId = GLCTO.SnapshotId
	WHERE 
		GLTranslationSubTypeCode = ''GL''
),
CTE_GetGLAccountPayrollSubIds(SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode)
AS
(
	Select B.SnapshotId, BudgetId, GLAccountSubTypeId, GLTranslationSubTypeCode From #SnapshotGLAccountCategoryTranslationsPayroll GLCTP
		INNER JOIN #NewBudgets B ON
			B.SnapshotId = GLCTP.SnapshotId
	WHERE 
		GLTranslationSubTypeCode = ''GL''
)
INSERT INTO #ProfitabilityPayrollMapping
(
	ImportBatchId,
    SourceName, 
	BudgetId,
	ReferenceCode,
	FirstProjectedPeriod,
	ExpensePeriod,
	SourceCode,
	BudgetAmount,
	MajorGlAccountCategoryId,
	MinorGlAccountCategoryId,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	FeeOrExpense,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	AllocationUpdatedDate,
	GLAccountSubTypeIdGlobal,
	GlobalGlAccountCode
)
-- Get Base Salary Payroll pre tax mappings and budget
SELECT
	pps.ImportBatchId,
	''Budget-SalaryPreTaxAmount'' as SourceName,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=SalaryPreTax'' AS ReferenceCode,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.SalaryPreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	@BaseSalaryMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''SalaryPreTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps
WHERE
	pps.SalaryPreTaxAmount <> 0

-- Get Profit Share Benefit pre tax mappings and budget
UNION ALL

SELECT
	pps.ImportBatchId,
	''Budget-ProfitSharePreTaxAmount'' as SourceName,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=ProfitSharePreTax'' AS ReferenceCod,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.ProfitSharePreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	@ProfitShareMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''ProfitSharePreTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		---ELSE (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		
		
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps
WHERE
	pps.ProfitSharePreTaxAmount <> 0

-- Get Bonus pre tax mappings and budget
UNION ALL

SELECT
	pps.ImportBatchId,
    ''Budget-BonusPreTaxAmount'' as SourceName,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusPreTax'' AS ReferenceCod,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusPreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	@BonusMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''BonusPreTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps
WHERE
	pps.BonusPreTaxAmount <> 0

--Get bonus cap pre tax mappings
UNION ALL

SELECT
	pps.ImportBatchId,
    ''Budget-BonusCapExcessPreTaxAmount'' as SourceName,	
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusCapExcessPreTax'' AS ReferenceCod,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusCapExcessPreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	@BonusMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	0 AS Reimbursable, -- Always Non-reimbursable for bunus cap amounts 
	''BonusCapExcessPreTax'' FeeOrExpense,
	ISNULL(p.ActivityTypeId, -1) AS ActivityTypeId,

	ISNULL(CASE
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.PropertyFundId
				ELSE
					DepartmentPropertyFund.PropertyFundId 
			END, -1) AS PropertyFundId,
	-- Same case logic AS above

	ISNULL(CASE -- Same case logic as above
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,

	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		
		
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps
	INNER JOIN #NewBudgets B on
	  PPS.BudgetId = B.BudgetId
	LEFT OUTER JOIN #SystemSettingRegion ssr ON
		pps.SourceCode = ssr.SourceCode AND
		pps.BudgetRegionId = ssr.RegionId AND
		ssr.SystemSettingName = ''BonusCapExcess''
		
	LEFT OUTER JOIN #Project p ON
		ssr.BonusCapExcessProjectId = p.ProjectId
			
	LEFT OUTER JOIN #SnapshotPropertyFund ProjectPropertyFund ON
		p.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		B.SnapshotId = ProjectPropertyFund.SnapshotId
		
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON
		GrSc.SourceCode = p.CorporateSourceCode

	LEFT OUTER JOIN #SnapshotPropertyFundMapping pfm ON
		p.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		p.CorporateSourceCode = pfm.SourceCode AND
		pfm.IsDeleted = 0 AND 
		(
			(GrSc.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId = p.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND p.ActivityTypeId IS NULL)
			)
		) AND
		pps.BudgetReportGroupPeriod < 201007 AND
		B.SnapshotId = pfm.SnapshotId

	LEFT OUTER JOIN	#SnapshotReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		RECD.SourceCode = p.CorporateSourceCode AND
		pps.BudgetReportGroupPeriod >= 201007 AND			   
		RECD.IsDeleted = 0 AND
		RECD.SnapshotId = B.SnapshotId

	LEFT OUTER JOIN #SnapshotReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		REPE.SourceCode = p.CorporateSourceCode AND
		pps.BudgetReportGroupPeriod >= 201007 AND
		REPE.IsDeleted = 0	 AND
		REPE.SnapshotId = B.SnapshotId

	LEFT OUTER JOIN #SnapshotPropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN pps.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END
			AND DepartmentPropertyFund.SnapshotId = B.SnapshotId
		
WHERE
	pps.BonusCapExcessPreTaxAmount <> 0

UNION ALL

-- Get Base Salary Payroll Tax mappings and budget
SELECT
    pps.ImportBatchId,
    ''Budget-SalaryTaxAmount'' as SourceName,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=SalaryTax'' AS ReferenceCod,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.SalaryTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''SalaryTaxTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		
		
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps
WHERE
	pps.SalaryTaxAmount <> 0

-- Get Profit Share Benefit Tax mappings and budget
UNION ALL

SELECT
    pps.ImportBatchId,
	''Budget-ProfitShareTaxAmount'' as SourceName,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=ProfitShareTax'' AS ReferenceCod,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.ProfitShareTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''ProfitShareTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps
WHERE
	pps.ProfitShareTaxAmount <> 0

-- Get Bonus Tax mappings and budget
UNION ALL

SELECT
    pps.ImportBatchId,
	''Budget-BonusTaxAmount'' as SourceName,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusTax'' AS ReferenceCod,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''BonusTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps
	INNER JOIN #NewBudgets B on
	  PPS.BudgetId = B.BudgetId
WHERE
	pps.BonusTaxAmount <> 0

-- Get Bonus cap Tax mappings 
UNION ALL

SELECT
    pps.ImportBatchId,
	''Budget-BonusCapExcessTaxAmount'' as SourceName,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusCapExcessTax'' AS ReferenceCod,
	pps.FirstProjectedPeriod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusCapExcessTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	0 AS Reimbursable, -- Always Non-reimbursable for bunus cap amounts 
	''BonusCapExcessTax'' FeeOrExpense,
	ISNULL(p.ActivityTypeId, -1) AS ActivityTypeId,
	
	ISNULL(CASE
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.PropertyFundId
				ELSE
					DepartmentPropertyFund.PropertyFundId 
			END, -1) AS PropertyFundId,
	-- Same case logic AS above

	ISNULL(CASE -- Same case logic as above
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,

	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		--THEN  (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL'')
		--ELSE (Select GLAccountSubTypeId From #GLAccountCategoryTranslationsPayroll Where GLTranslationSubTypeCode = ''GL'')
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps
	INNER JOIN #NewBudgets B on
		b.BudgetId = pps.BudgetId
		
	LEFT OUTER JOIN #SystemSettingRegion ssr ON
		pps.SourceCode = ssr.SourceCode AND
		pps.BudgetRegionId = ssr.RegionId AND
		ssr.SystemSettingName = ''BonusCapExcess''

	LEFT OUTER JOIN #Project p ON
		ssr.BonusCapExcessProjectId = p.ProjectId

	LEFT OUTER JOIN #SnapshotPropertyFund ProjectPropertyFund ON
		p.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		b.SnapshotId = ProjectPropertyFund.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON
		GrSc.SourceCode = p.CorporateSourceCode

	LEFT OUTER JOIN #SnapshotPropertyFundMapping pfm ON
		p.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		p.CorporateSourceCode = pfm.SourceCode AND
		pfm.IsDeleted = 0 AND 
		(
			(GrSc.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId = p.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND p.ActivityTypeId IS NULL)
			)
		) AND
		pps.BudgetReportGroupPeriod < 201007 AND
		b.SnapshotId = pfm.SnapshotId

	LEFT OUTER JOIN	#SnapshotReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		RECD.SourceCode = p.CorporateSourceCode AND
		pps.BudgetReportGroupPeriod >= 201007 AND			   
		RECD.IsDeleted = 0 AND
		RECD.SnapshotId = B.SnapshotId
		   
	LEFT OUTER JOIN #SnapshotReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		REPE.SourceCode = p.CorporateSourceCode AND
		pps.BudgetReportGroupPeriod >= 201007 AND
		REPE.IsDeleted = 0 AND
		B.SnapshotId = REPE.SnapshotId

	LEFT OUTER JOIN #SnapshotPropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN pps.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END
		AND DepartmentPropertyFund.SnapshotId = B.SnapshotId

WHERE
	pps.BonusCapExcessTaxAmount <> 0
	
-- Get Overhead mappings	
UNION ALL

SELECT
    pos.ImportBatchId,
	''Budget-OverheadAllocationAmount'' as SourceName,
	pos.BudgetId,
	pos.ReferenceCode + ''&Type=OverheadAllocation'' AS ReferenceCod,
	pos.FirstProjectedPeriod,
	pos.ExpensePeriod,
	pos.SourceCode,
	pos.OverheadAllocationAmount AS BudgetAmount,
	@OccupancyCostsMajorGlAccountCategoryId AS MajorGlAccountCategoryId,
	pos.MinorGlAccountCategoryId, 
	pos.FunctionalDepartmentId,
	pos.FunctionalDepartmentCode,
	pos.Reimbursable,  
	''Overhead'' FeeOrExpense,
	pos.ActivityTypeId,
	pos.PropertyFundId,
	pos.AllocationSubRegionGlobalRegionId,
	pos.OriginatingRegionCode,
	pos.OriginatingRegionSourceCode,
	pos.LocalCurrencyCode,
	pos.OverheadUpdatedDate,
	--(Select GLAccountSubTypeId From #GLAccountCategoryTranslationsOverhead Where GLTranslationSubTypeCode = ''GL''),
	(SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pos.BudgetId),
	--General Allocated Overhead Account :: CC8
	''50029500''+RIGHT(''0''+LTRIM(STR(pos.ActivityTypeId,3,0)),2) as GlobalGlAccountCode
FROM
	#ProfitabilityOverheadSource pos
	INNER JOIN #NewBudgets B on
		b.BudgetId = pos.BudgetId
	
WHERE
	pos.OverheadAllocationAmount <> 0

PRINT ''Completed inserting records into #ProfitabilityPayrollMapping:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_AllocationUpdatedDate ON #ProfitabilityPayrollMapping(ReferenceCode,AllocationUpdatedDate)

PRINT ''Completed creating indexes on #ProfitabilityPayrollMapping''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Map mapped source data into the "REAL" fact table
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
------------------------------------------------------------------------------------------------------
-- Map to the fact
------------------------------------------------------------------------------------------------------
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--If the join is not possible, default the link to the ''UNKNOWN'' link
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityReforecast(
	ImportBatchId INT NOT NULL,
    SourceName varchar(50),
    BudgetReforecastTypeKey INT NOT NULL,
    SnapshotId INT NOT NULL,
	CalendarKey INT NOT NULL,
	ReforecastKey INT NOT NULL,
	GlAccountKey INT NOT NULL,
	SourceKey INT NOT NULL,
	FunctionalDepartmentKey INT NOT NULL,
	ReimbursableKey INT NOT NULL,
	ActivityTypeKey INT NOT NULL,
	PropertyFundKey INT NOT NULL,	
	AllocationRegionKey INT NOT NULL,
	OriginatingRegionKey INT NOT NULL,
	OverheadKey INT NOT NULL,
	LocalCurrencyKey INT NOT NULL,
	LocalReforecast MONEY NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	BudgetId INT NOT NULL,
	
	EUCorporateGlAccountCategoryKey INT NULL,
	EUPropertyGlAccountCategoryKey INT NULL,
	EUFundGlAccountCategoryKey INT NULL,

	USPropertyGlAccountCategoryKey INT NULL,
	USCorporateGlAccountCategoryKey INT NULL,
	USFundGlAccountCategoryKey INT NULL,

	GlobalGlAccountCategoryKey INT NULL,
	DevelopmentGlAccountCategoryKey INT NULL
) 



INSERT INTO #ProfitabilityReforecast 
(
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
	SnapshotId,
	CalendarKey,
	ReforecastKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId
)
SELECT
	PBM.ImportBatchId,
    pbm.SourceName,
    @ReforecastTypeIsTGBBUDKey,
    B.SnapshotId,
	DATEDIFF(dd, ''1900-01-01'', LEFT(pbm.ExpensePeriod,4)+''-''+RIGHT(pbm.ExpensePeriod,2)+''-01'') AS CalendarKey,
	--DATEDIFF(dd, ''1900-01-01'', LEFT(pbm.FirstProjectedPeriod,4)+''-''+RIGHT(pbm.FirstProjectedPeriod,2)+''-01'') AS ReforecastKey,
	B.ReforecastKey AS ReforecastKey,
	CASE WHEN GrGa.GlAccountKey IS NULL THEN @GlAccountKeyUnknown ELSE GrGa.GlAccountKey END GlAccountKey,
	CASE WHEN GrSc.[SourceKey] IS NULL THEN @SourceKeyUnknown ELSE GrSc.[SourceKey] END SourceKey,
	CASE WHEN GrFdm.[FunctionalDepartmentKey] IS NULL THEN @FunctionalDepartmentKeyUnknown ELSE GrFdm.[FunctionalDepartmentKey] END FunctionalDepartmentKey,
	CASE WHEN GrRi.ReimbursableCode IS NULL THEN @ReimbursableKeyUnknown ELSE GrRi.ReimbursableKey END ReimbursableKey,
	CASE WHEN GrAt.[ActivityTypeKey] IS NULL THEN @ActivityTypeKeyUnknown ELSE GrAt.[ActivityTypeKey] END ActivityTypeKey,
	CASE WHEN GrPf.[PropertyFundKey] IS NULL THEN @PropertyFundKeyUnknown ELSE GrPf.[PropertyFundKey] END PropertyFundKey,
	CASE WHEN GrAr.[AllocationRegionKey] IS NULL THEN @AllocationRegionKeyUnknown ELSE GrAr.[AllocationRegionKey] END AllocationRegionKey,
	CASE WHEN GrOr.[OriginatingRegionKey] IS NULL THEN @OriginatingRegionKeyUnknown ELSE GrOr.[OriginatingRegionKey] END OriginatingRegionKey,
	CASE WHEN GrOh.[OverheadKey] IS NULL THEN @OverheadKeyUnknown ELSE GrOh.[OverheadKey] END OverheadKey,
	CASE WHEN GrCu.[CurrencyKey] IS NULL THEN @LocalCurrencyKeyUnknown ELSE GrCu.[CurrencyKey] END LocalCurrencyKey,
	pbm.BudgetAmount,
	pbm.ReferenceCode,
	pbm.BudgetId
FROM
	#ProfitabilityPayrollMapping pbm
	
	INNER JOIN #NewBudgets B on
		B.BudgetId = pbm.BudgetId 
	
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON
		pbm.SourceCode = GrSc.SourceCode 

	LEFT OUTER JOIN GrReporting.dbo.GlAccount GrGa ON
		GrGa.Code = pbm.GlobalGlAccountCode AND
		--pbm.AllocationUpdatedDate BETWEEN GrGa.StartDate AND GrGa.EndDate AND
		GrGa.SnapshotId = B.SnapshotId		
		
	--Parent Level (No job code for payroll)
	LEFT OUTER JOIN GrReporting.dbo.FunctionalDepartment GrFdm ON
		GrFdm.ReferenceCode LIKE pbm.FunctionalDepartmentCode +'':%'' AND
		pbm.AllocationUpdatedDate BETWEEN GrFdm.StartDate AND GrFdm.EndDate AND
		GrFdm.SubFunctionalDepartmentCode = GrFdm.FunctionalDepartmentCode 
		

	LEFT OUTER JOIN GrReporting.dbo.Reimbursable GrRi ON
		CASE WHEN pbm.Reimbursable = 1 THEN ''YES'' ELSE ''NO'' END = GrRi.ReimbursableCode 		

	LEFT OUTER JOIN GrReporting.dbo.ActivityType GrAt ON
		pbm.ActivityTypeId = GrAt.ActivityTypeId AND
		-- THIS IS NO LONGER NEEDED?
		--pbm.AllocationUpdatedDate BETWEEN GrAt.StartDate AND GrAt.EndDate AND
		GrAt.SnapshotId = B.SnapshotId		

	LEFT OUTER JOIN GrReporting.dbo.Overhead GrOh ON
		--GC :: Change Control 1
		GrOh.OverheadCode = CASE WHEN pbm.FeeOrExpense = ''Overhead'' THEN ''ALLOC'' 
									WHEN GrAt.ActivityTypeCode = ''CORPOH'' THEN ''UNALLOC'' 
									ELSE ''UNKNOWN'' END 
		--AND GrOh.SnapshotId = B.SnapshotId										
								
									
	LEFT OUTER JOIN GrReporting.dbo.PropertyFund GrPf ON
		pbm.PropertyFundId = GrPf.PropertyFundId AND
		--pbm.AllocationUpdatedDate BETWEEN GrPf.StartDate AND GrPf.EndDate 
		GrPf.SnapshotId = B.SnapshotId

	-- HACK: At some point tapas was supposed to pull project region out of GDM. 
	-- Now allocation regions are source based??? So I use the code because it is built up from the ProjectRegionId since there is only data for one source anyway.
	-- I don''t check source because actuals also don''t check source. 
	--LEFT OUTER JOIN #AllocationRegionMapping Arm ON
	--	Arm.RegionCode = pbm.ProjectRegionId AND -- TODO: Pull the RegionCode through from the top.
	--	Arm.IsDeleted = 0
	
		
	LEFT OUTER JOIN #SnapshotAllocationSubRegion ASR ON
		pbm.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId AND
		B.SnapshotId = ASR.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion GrAr ON
		ASR.AllocationSubRegionGlobalRegionId = GrAr.GlobalRegionId AND
		--pbm.AllocationUpdatedDate BETWEEN GrAr.StartDate AND GrAr.EndDate
		GrAr.SnapshotId = B.SnapshotId

/* -- At some point Allocation region in GDM was going to become the master list
	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion GrAr ON
		pbm.ProjectRegionId = GrAr.GlobalRegionId AND
		pbm.AllocationUpdatedDate BETWEEN GrAr.StartDate AND GrAr.EndDate
*/

	--LEFT OUTER JOIN #OriginatingRegionMapping Orm ON
	--	Orm.RegionCode = CASE WHEN RIGHT(pbm.OriginatingRegionSourceCode,1) = ''C'' THEN LTRIM(RTRIM(pbm.OriginatingRegionCode))
	--							ELSE LTRIM(RTRIM(pbm.OriginatingRegionCode)) + LTRIM(RTRIM(pbm.FunctionalDepartmentCode)) END AND
	--	Orm.SourceCode = pbm.OriginatingRegionSourceCode AND
	--	Orm.IsDeleted = 0
		
				
	LEFT OUTER JOIN #SnapshotOriginatingRegionCorporateEntity ORCE ON
		ORCE.SnapshotId = B.SnapshotId AND
		ORCE.CorporateEntityCode = LTRIM(RTRIM(pbm.OriginatingRegionCode)) AND
		ORCE.SourceCode = pbm.OriginatingRegionSourceCode AND
		ORCE.IsDeleted = 0
		
		   
	LEFT OUTER JOIN #SnapshotOriginatingRegionPropertyDepartment ORPD ON
		B.SnapshotId = ORPD.SnapshotId	AND
		ORPD.PropertyDepartmentCode = LTRIM(RTRIM(pbm.OriginatingRegionCode)) AND
		ORPD.SourceCode = pbm.OriginatingRegionSourceCode AND
		ORPD.IsDeleted = 0
		
		
		
	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion GrOr ON
		GrOr.GlobalRegionId = ISNULL(ORCE.GlobalRegionId, ORPD.GlobalRegionId) AND
		--pbm.AllocationUpdatedDate BETWEEN GrOr.StartDate AND GrOr.EndDate
		GrOr.SnapshotId = B.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.Currency GrCu ON
		pbm.LocalCurrencyCode = GrCu.CurrencyCode


PRINT ''Completed inserting budget portions into #ProfitabilityReforecast:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

------------------------------------------------------------------------------------------------------
-- INSERT ACTUALS
------------------------------------------------------------------------------------------------------
SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityActualSource
(
	ImportBatchId INT NOT NULL,
    SourceName VARCHAR(50),
    BudgetReforecastTypeKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	CalendarKey INT NOT NULL,
	ReforecastKey INT NOT NULL,
	GlAccountKey INT NOT NULL,
	SourceKey INT NOT NULL,
	FunctionalDepartmentKey INT NOT NULL,
	ReimbursableKey INT NOT NULL,
	ActivityTypeKey INT NOT NULL,
	PropertyFundKey INT NOT NULL,
	AllocationRegionKey INT NOT NULL,
	OriginatingRegionKey INT NOT NULL,
	OverheadKey INT NOT NULL,
	LocalCurrencyKey INT NOT NULL,
	LocalReforecast MONEY NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	BudgetId INT NOT NULL,
)
INSERT INTO #ProfitabilityActualSource
(
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
	SnapshotId,
	CalendarKey,
	ReforecastKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId
)
SELECT  
	BPA.ImportBatchId AS ImportBatchId,
	''Actuals'' as SourceName,
	@ReforecastTypeIsTGBACTKey as BudgetReforecastTypeKey,
    B.SnapshotId,
    DATEDIFF(dd, ''1900-01-01'', LEFT(BPA.Period,4)+''-''+RIGHT(BPA.Period,2)+''-01'') AS CalendarKey,
	--DATEDIFF(dd, ''1900-01-01'', LEFT(BPA.Period,4)+''-''+RIGHT(BPA.Period,2)+''-01'') AS ReforecastKey,
	B.ReforecastKey AS ReforecastKey,
	CASE WHEN GrGa.GlAccountKey IS NULL THEN @GlAccountKeyUnknown ELSE GrGa.GlAccountKey END GlAccountKey,
	CASE WHEN GrSc.[SourceKey] IS NULL THEN @SourceKeyUnknown ELSE GrSc.[SourceKey] END SourceKey,
	--CASE WHEN GrFdm.[FunctionalDepartmentKey] IS NULL THEN @FunctionalDepartmentKeyUnknown ELSE GrFdm.[FunctionalDepartmentKey] END FunctionalDepartmentKey,
	-- New logic use GBS logic instead as this is actuals and from GBS
	CASE WHEN
		ISNULL(FDJobCode.FunctionalDepartmentKey, GrFdm.FunctionalDepartmentKey) IS NULL
		THEN
			@FunctionalDepartmentKeyUnknown
		ELSE
			ISNULL(FDJobCode.FunctionalDepartmentKey, GrFdm.FunctionalDepartmentKey) END AS FunctionalDepartmentKey,	
	
	
	CASE WHEN GrRi.ReimbursableCode IS NULL THEN @ReimbursableKeyUnknown ELSE GrRi.ReimbursableKey END ReimbursableKey,
	CASE WHEN GrAt.[ActivityTypeKey] IS NULL THEN @ActivityTypeKeyUnknown ELSE GrAt.[ActivityTypeKey] END ActivityTypeKey,
	CASE WHEN GrPf.[PropertyFundKey] IS NULL THEN @PropertyFundKeyUnknown ELSE GrPf.[PropertyFundKey] END PropertyFundKey,
	
	CASE WHEN GrAr.[AllocationRegionKey] IS NULL THEN @AllocationRegionKeyUnknown ELSE GrAr.[AllocationRegionKey] END AllocationRegionKey,
	CASE WHEN GrOr.[OriginatingRegionKey] IS NULL THEN @OriginatingRegionKeyUnknown ELSE GrOr.[OriginatingRegionKey] END OriginatingRegionKey,
	CASE WHEN GrOh.[OverheadKey] IS NULL THEN @OverheadKeyUnknown ELSE GrOh.[OverheadKey] END OverheadKey,
	CASE WHEN GrCu.[CurrencyKey] IS NULL THEN @LocalCurrencyKeyUnknown ELSE GrCu.[CurrencyKey] END LocalCurrencyKey,	
	BPA.Amount AS LocalReforecast,
   ''TGB:GBSBudgetId='' + LTRIM(RTRIM(STR(B.BudgetId))) + ''&BudgetProfitabilityActualId='' + LTRIM(RTRIM(STR(bpa.BudgetProfitabilityActualId))) + ''&SnapshotId='' + LTRIM(RTRIM(STR(b.SnapshotId))) as ReferenceCode, -- ReferenceCode
	B.BudgetId
FROM 
    GBS.BudgetProfitabilityActual BPA 
    INNER JOIN  #GBSBudgets B ON 
		B.BudgetId = BPA.BudgetId AND 
		B.MustImportAllActualsIntoWarehouse = 1 AND
		B.ImportBatchId = BPA.ImportBatchId
    
	INNER JOIN #SnapshotGLTranslationSubType TST ON
		B.SnapshotId = TST.SnapshotId	

  		
	LEFT OUTER JOIN #SnapshotGLGlobalAccount GA ON
		BPA.GLGlobalAccountId = GA.GLGlobalAccountId AND
		B.SnapshotId = GA.SnapshotId
		
    LEFT OUTER JOIN GBS.OverheadType OHT ON
		BPA.OverheadTypeId = OHT.OverheadTypeId AND
		OHT.ImportBatchId = B.ImportBatchId

	LEFT OUTER JOIN GrReporting.dbo.GlAccount GrGa ON
		GrGa.GLGlobalAccountId = BPA.GLGlobalAccountId AND		
		GrGa.SnapshotId = B.SnapshotId		
		
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON 
		GrSc.SourceCode = BPA.SourceCode


	-- FunctionalDepartmentCode
	LEFT OUTER JOIN #SnapshotFunctionalDepartment FD ON
		BPA.FunctionalDepartmentId = FD.FunctionalDepartmentId and
		B.SnapshotId = FD.SnapshotId


	-- Detail/Sub Level (Job Code) -- job code is stored as SubFunctionalDepartment in GrReporting.dbo.FunctionalDepartment
	LEFT OUTER JOIN (
						SELECT
							FunctionalDepartmentKey,
							FunctionalDepartmentCode,
							FunctionalDepartmentName,
							SubFunctionalDepartmentCode,
							SubFunctionalDepartmentName
						FROM
							GrReporting.dbo.FunctionalDepartment
						WHERE
							FunctionalDepartmentCode <> SubFunctionalDepartmentCode
							
	) FDJobCode ON
		FD.GlobalCode = FDJobCode.SubFunctionalDepartmentCode AND
		FD.GlobalCode = FDJobCode.FunctionalDepartmentCode 
		

	-- Parent Level
	LEFT OUTER JOIN (
						SELECT
							FunctionalDepartmentKey,
							FunctionalDepartmentCode,
							FunctionalDepartmentName,
							SubFunctionalDepartmentCode,
							SubFunctionalDepartmentName
						FROM
							GrReporting.dbo.FunctionalDepartment
						WHERE
							SubFunctionalDepartmentCode = FunctionalDepartmentCode
	) GrFdm ON
		FD.GlobalCode = GrFdm.FunctionalDepartmentCode

	/* --- Because this is tapas actuals this wont work i think so lets try the logic above from GBS
	LEFT OUTER JOIN GrReporting.dbo.FunctionalDepartment GrFdm ON
		GrFdm.ReferenceCode LIKE FD.Code +'':%'' AND
		BPA.UpdatedDate BETWEEN GrFdm.StartDate AND GrFdm.EndDate AND
		GrFdm.SubFunctionalDepartmentCode = GrFdm.FunctionalDepartmentCode 
		--and GrFdm.SnapshotId = B.SnapshotId			*/
	


	LEFT OUTER JOIN #SnapshotAllocationSubRegion ASR ON
		BPA.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId AND 
		B.SnapshotId = ASR.SnapshotId
		
		
	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion GrAr ON
		ASR.AllocationSubRegionGlobalRegionId = GrAr.GlobalRegionId AND
		--BPA.UpdatedDate BETWEEN GrAr.StartDate AND GrAr.EndDate
		GrAr.SnapshotId = B.SnapshotId		
		
		

    LEFT OUTER JOIN  #SnapshotPropertyFund PF ON
		PF.PropertyFundId = BPA.ReportingEntityPropertyFundId AND
		B.SnapshotId = PF.SnapshotId
		
	LEFT OUTER JOIN GrReporting.dbo.PropertyFund GrPf ON	
	    GrPf.PropertyFundId = BPA.ReportingEntityPropertyFundId AND
	    Grpf.SnapshotId = PF.SnapshotId	      
		
	
	LEFT OUTER JOIN GrReporting.dbo.ActivityType GrAt ON
		BPA.ActivityTypeId = GrAt.ActivityTypeId AND
		--BPA.UpdatedDate BETWEEN GrAt.StartDate AND GrAt.EndDate AND
		GrAt.SnapshotId = B.SnapshotId		
		
		
	LEFT OUTER JOIN GrReporting.dbo.Reimbursable GrRi ON
	     GrRi.ReimbursableCode = CASE WHEN BPA.IsTsCost = 0 THEN ''YES'' ELSE ''NO'' END
	    
    LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion GrOr ON 
		BPA.OriginatingSubRegionGlobalRegionId = GrOr.GlobalRegionId and
		GrOr.SnapshotId = B.SnapshotId
	    
	  
	
	LEFT OUTER JOIN GrReporting.dbo.Overhead GrOh ON
		OHT.Code = GrOh.OverheadCode
		--GC :: Change Control 1
		--GrOh.OverheadCode =  CASE WHEN GrAt.ActivityTypeCode = ''CORPOH'' THEN ''UNALLOC'' ELSE ''UNKNOWN'' END    
		--GrOh.OverheadCode = ''ALLOC''
		--AND GrOh.SnapshotId = B.SnapshotId					
	
	LEFT OUTER JOIN GrReporting.dbo.Currency GrCu ON
		BPA.CurrencyCode = GrCu.CurrencyCode	
		
	LEFT OUTER JOIN #SnapshotGLGlobalAccountTranslationSubType GLATST ON
		GLATST.GLGlobalAccountId = GA.GLGlobalAccountId AND
		B.SnapshotId = GLATST.SnapshotId		

	LEFT OUTER JOIN #SnapshotGLMinorCategory MinC ON
		GLATST.GLMinorCategoryId = MinC.GLMinorCategoryId AND
		B.SnapshotId = MinC.SnapshotId

	LEFT OUTER JOIN #SnapshotGLMajorCategory MajC ON
		MinC.GLMajorCategoryId = MajC.GLMajorCategoryId AND
		B.SnapshotId = MajC.SnapshotId

WHERE 
	BPA.Period < B.FirstProjectedPeriod AND		
	MajC.Name in (''Salaries/Taxes/Benefits'', ''General Overhead'') AND
	(OHT.Code IS NULL OR OHT.Code = ''ALLOC'')
	


PRINT ''Completed inserting Actuals into #ProfitabilityActualSource:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

INSERT INTO #ProfitabilityReforecast 
(
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
	SnapshotId,
	CalendarKey,
	ReforecastKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId
)
SELECT
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
	SnapshotId,
	CalendarKey,
	ReforecastKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId
FROM
	#ProfitabilityActualSource

PRINT ''Completed inserting Actuals portions into #ProfitabilityReforecast:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #ProfitabilityReforecast (ReferenceCode)
CREATE INDEX IX_CalendarKey ON #ProfitabilityReforecast (CalendarKey)

PRINT ''Completed creating indexes on #OriginatingRegionMapping''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Remove existing data for modified budget projects
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

CREATE TABLE #DeletingBudget
(
	BudgetId INT NOT NULL
)

INSERT INTO #DeletingBudget
(
	BudgetId
)
SELECT DISTINCT 
	BudgetId
FROM
	#NewBudgets
UNION ALL
SELECT DISTINCT 
	BudgetId
FROM
	#GBSBudgets	

DECLARE @BudgetId INT = -1
DECLARE @LoopCount INT = 0 -- Infinite loop safe guard
DECLARE @TotalDeleteCount INT = 0
WHILE (EXISTS (SELECT TOP 1 BudgetId FROM #DeletingBudget) AND @LoopCount < 100000)
BEGIN
	
	SET @LoopCount = @LoopCount + 1
	SET @BudgetId = (SELECT TOP 1 BudgetId FROM #DeletingBudget)


	DECLARE @row Int = 1
	DECLARE @deleteCnt Int = 0
	WHILE (@row > 0)
		BEGIN
		-- Remove old facts
		DELETE TOP (100000)
		FROM 
			GrReporting.dbo.ProfitabilityReforecast 
		WHERE 
			BudgetId = @BudgetId AND
			BudgetReforecastTypeKey in (@ReforecastTypeIsTGBBUDKey, @ReforecastTypeIsTGBACTKey)
		
		
		SET @row = @@rowcount
		SET @deleteCnt = @deleteCnt + @row
		SET @TotalDeleteCount = @TotalDeleteCount + @row
		PRINT ''>>>:''+CONVERT(char(10),@row)
		PRINT CONVERT(Varchar(27), getdate(), 121)
		
		END
		
	PRINT ''Rows Deleted FOR BudgetID ('' + STR(@BudgetId) + '') FROM  ProfitabilityReforecast:''+CONVERT(VARCHAR(10),@deleteCnt)		
	--PRINT ''Rows Deleted from ProfitabilityReforecast:''+CONVERT(char(10),@deleteCnt)
	PRINT CONVERT(Varchar(27), getdate(), 121)

	DELETE FROM #DeletingBudget WHERE BudgetId = @BudgetId
END
PRINT ''TOTAL Rows Deleted from ProfitabilityReforecast:''+CONVERT(char(10),@TotalDeleteCount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

print ''Cleaned up rows in ProfitabilityReforecast''

------------------------------------------------------------------------------------------------------
-- Map account categories
------------------------------------------------------------------------------------------------------

--GlobalGlAccountCategoryKey
SET @StartTime = GETDATE()

CREATE TABLE #GlobalCategoryLookup(
    SnapshotId INT NOT NULL,
	GlAccountCategoryKey INT NULL,
	ReferenceCode VARCHAR(300) NOT NULL
)

INSERT INTO #GlobalCategoryLookup(
    SnapshotId,
	GlAccountCategoryKey,
	ReferenceCode
)
SELECT 
	 Gl.SnapshotId,
	GlAcGlobal.GlAccountCategoryKey,
	Gl.ReferenceCode
FROM
	(
		SELECT 
		    B.SnapshotId,
			GlAcHg.GLTranslationTypeId,
			GlAcHg.GLTranslationSubTypeId,
			Gl.MajorGlAccountCategoryId GLMajorCategoryId,
			Gl.MinorGlAccountCategoryId GLMinorCategoryId,
			GlAcHg.GLAccountTypeId,
			GlAcHg.GLAccountSubTypeId,
			Gl.AllocationUpdatedDate,
			Gl.ReferenceCode
		 FROM	
			#ProfitabilityPayrollMapping Gl		
			INNER JOIN #NewBudgets B ON
				B.BudgetId = GL.BudgetId 
				
			LEFT OUTER JOIN (
							SELECT
								ACT.SnapshotId,
								ACT.GLTranslationTypeId,
								ACT.GLTranslationSubTypeId,
								ACT.GLAccountTypeId,
								ACT.GLAccountSubTypeId
							FROM
								#SnapshotGLAccountCategoryTranslationsPayroll ACT
							WHERE
								ACT.GLTranslationSubTypeCode = ''GL'' 
							UNION ALL
							SELECT
								ACT.SnapshotId,
								ACT.GLTranslationTypeId,
								ACT.GLTranslationSubTypeId,
								ACT.GLAccountTypeId,
								ACT.GLAccountSubTypeId
							FROM
								#SnapshotGLAccountCategoryTranslationsOverhead ACT
							WHERE
								ACT.GLTranslationSubTypeCode = ''GL'' 

						) GlAcHg ON 
						GlAcHg.GLAccountSubTypeId = Gl.GLAccountSubTypeIdGlobal AND
						GlAcHg.SnapshotId = B.SnapshotId
						
		 
		) Gl
															
		LEFT OUTER JOIN GrReporting.dbo.GlAccountCategory GlAcGlobal ON GlAcGlobal.GlobalGlAccountCategoryCode = 
			CONVERT(VARCHAR(32), LTRIM(STR(Gl.GLTranslationTypeId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLTranslationSubTypeId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLMajorCategoryId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLMinorCategoryId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLAccountTypeId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLAccountSubTypeId, 10, 0)))

			--AND Gl.AllocationUpdatedDate BETWEEN GlAcGlobal.StartDate AND GlAcGlobal.EndDate
			AND GlAcGlobal.SnapshotId = Gl.SnapshotId

PRINT ''Completed inserting #GlobalCategoryLookup:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
			
SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX ON #GlobalCategoryLookup (SnapshotId, ReferenceCode)

UPDATE
	#ProfitabilityReforecast
SET
	GlobalGlAccountCategoryKey = CASE WHEN t1.GlAccountCategoryKey IS NULL THEN @GlobalGlAccountCategoryKeyUnknown ELSE t1.GlAccountCategoryKey END
FROM
	#GlobalCategoryLookup t1
WHERE
	t1.ReferenceCode = #ProfitabilityReforecast.ReferenceCode AND
	#ProfitabilityReforecast.BudgetReforecastTypeKey <> @ReforecastTypeIsTGBACTKey


PRINT ''Completed converting all GlobalGlAccountCategoryKey keys for Budgets:''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))








-- ==============================================================================================================================================
-- Update #ProfitibilityReforecast.GlobalGlAccountCategoryKey for Actuals
-- ==============================================================================================================================================

--select * from #ProfitabilitySource

SET @StartTime = GETDATE()

UPDATE
	#ProfitabilityReforecast
SET
	GlobalGlAccountCategoryKey = CASE WHEN GLAC.GlAccountCategoryKey IS NULL THEN @GlobalGlAccountCategoryKeyUnknown ELSE GLAC.GlAccountCategoryKey END
FROM #ProfitabilityReforecast Gl

	LEFT OUTER JOIN #GLAccountCategoryMapping GLACM ON
		Gl.GlAccountKey = GLACM.GlAccountKey AND
		Gl.SnapshotId = GLACM.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.GlAccountCategory GLAC ON
		--Gl.CalendarKey BETWEEN GLAC.StartDate AND GLAC.EndDate AND
		GLAC.GlobalGlAccountCategoryCode =  CONVERT(VARCHAR(32),
											CONVERT(VARCHAR(8), GLACM.GLTranslationTypeId) + '':'' + 
											CONVERT(VARCHAR(8), GLACM.GLTranslationSubTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLMajorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLMinorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLAccountTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLAccountSubTypeId)) AND
		Gl.SnapshotId = GLAC.SnapshotId

where
	Gl.BudgetReforecastTypeKey = @ReforecastTypeIsTGBACTKey
	
PRINT (''Rows updated from #ProfitibilityReforecast.GlobalGlAccountCategoryKey for Actuals: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(MILLISECOND, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- ==============================================================================================================================================







---------------------------------------------------------------------------------------------
----  Register Unknowns
---------------------------------------------------------------------------------------------

--- Smoke All OLD TAPAS Unknowns were about to insert new ones (Reforecast Budget + Reforecast Actuals from [dbo].[ProfitabilityBudgetUnknowns])
SET @StartTime = GETDATE()

DELETE 
    PRU
FROM    
	[dbo].[ProfitabilityReforecastUnknowns] PRU
WHERE
  PRU.BudgetReforecastTypeKey IN (@ReforecastTypeIsTGBBUDKey, @ReforecastTypeIsTGBACTKey)

PRINT (''Rows Deleted that was OLD from ProfitabilitReforecastUnknowns: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-------------


SET @StartTime = GETDATE()

INSERT INTO [dbo].[ProfitabilityReforecastUnknowns]
   ([ImportBatchId]
   ,[CalendarKey]
   ,[GlAccountKey]
   ,[SourceKey]
   ,[FunctionalDepartmentKey]
   ,[ReimbursableKey]
   ,[ActivityTypeKey]
   ,[PropertyFundKey]
   ,[AllocationRegionKey]
   ,[OriginatingRegionKey]
   ,[LocalCurrencyKey]
   ,[LocalReforecast]
   ,[ReferenceCode]
   ,[EUCorporateGlAccountCategoryKey]
   ,[USPropertyGlAccountCategoryKey]
   ,[USFundGlAccountCategoryKey]
   ,[EUPropertyGlAccountCategoryKey]
   ,[USCorporateGlAccountCategoryKey]
   ,[DevelopmentGlAccountCategoryKey]
   ,[EUFundGlAccountCategoryKey]
   ,[GlobalGlAccountCategoryKey]
   ,[BudgetId]
   ,[OverheadKey]
   ,[FeeAdjustmentKey]
   ,[BudgetReforecastTypeKey]
   ,[SnapshotId])
SELECT
	PR.ImportBatchId,
	PR.CalendarKey,
	PR.GlAccountKey,
	PR.SourceKey,
	PR.FunctionalDepartmentKey,
	PR.ReimbursableKey,
	PR.ActivityTypeKey,
	PR.PropertyFundKey,
	PR.AllocationRegionKey,
	PR.OriginatingRegionKey,
	PR.LocalCurrencyKey,
	PR.LocalReforecast,
	PR.ReferenceCode,
	@EUCorporateGlAccountCategoryKeyUnknown,
	@USPropertyGlAccountCategoryKeyUnknown,	
	@USFundGlAccountCategoryKeyUnknown, 	
	@EUPropertyGlAccountCategoryKeyUnknown,
	@USCorporateGlAccountCategoryKeyUnknown, 
	@DevelopmentGlAccountCategoryKeyUnknown,
	@EUFundGlAccountCategoryKeyUnknown, 
	PR.GlobalGlAccountCategoryKey,	
	PR.BudgetId,
	PR.OverheadKey,
	(SELECT FeeAdjustmentKey FROM GrReporting.dbo.FeeAdjustment WHERE FeeAdjustmentCode = ''NORMAL''),
	BudgetReforecastTypeKey,
	AB.SnapshotId
	
FROM 
	#ProfitabilityReforecast PR
	INNER JOIN #AllBudgets AB ON
		AB.BudgetId = PR.BudgetId AND
		AB.SnapshotId = PR.SnapshotId
WHERE	
	PR.BudgetReforecastTypeKey IN (@ReforecastTypeIsTGBBUDKey, @ReforecastTypeIsTGBACTKey) AND
	(
		@FunctionalDepartmentKeyUnknown = PR.FunctionalDepartmentKey OR
		@ReimbursableKeyUnknown = PR.ReimbursableKey OR
		@ActivityTypeKeyUnknown = PR.ActivityTypeKey OR
		@PropertyFundKeyUnknown = PR.PropertyFundKey OR
		@AllocationRegionKeyUnknown = PR.AllocationRegionKey OR
		@OriginatingRegionKeyUnknown = PR.OriginatingRegionKey OR
		@LocalCurrencyKeyUnknown = PR.LocalCurrencyKey
	)

PRINT (''Rows inserted into ProfitabilitReforecastUnknowns: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


--------------------------------------------------------------------------------------------
---  BUILD Unknown Budgets - Get all the budgets for Budget rows that have unknowns
-------------------------------------------------------------------------------------------
SET @StartTime = GETDATE()


SELECT DISTINCT
	B.SnapshotId, 
	B.BudgetId,
	B.ImportKey,
	PRU.BudgetReforecastTypeKey	
INTO
   #BudgetsWithUnknownBudgets
FROM 
   dbo.ProfitabilityReforecastUnknowns  PRU
   INNER JOIN #AllBudgets B ON
		B.SnapshotId = PRU.SnapshotId AND
		B.BudgetId = PRU.BudgetId 
WHERE
  PRU.BudgetReforecastTypeKey = @ReforecastTypeIsTGBBudKey

DECLARE @RowsToDeleteFromPRBudgets INT = @@rowcount

PRINT (''Rows inserted into #BudgetsWithUnknownBudgets: '' + CONVERT(VARCHAR(10),@RowsToDeleteFromPRBudgets))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

----------------------------------------------------------------------------------------------------
---  BUILD Unknown Actuals - Get all the budgets for Budget rows that have unknowns
----------------------------------------------------------------------------------------------------

SELECT DISTINCT
	B.SnapshotId, 
	B.BudgetId,
	B.ImportKey,
	PRU.BudgetReforecastTypeKey
INTO
   #BudgetsWithUnknownActuals
FROM 
   dbo.ProfitabilityReforecastUnknowns  PRU
   INNER JOIN #AllBudgets B ON
		B.SnapshotId = PRU.SnapshotId AND
		B.BudgetId = PRU.BudgetId 
WHERE
  PRU.BudgetReforecastTypeKey = @ReforecastTypeIsTGBActKey




DECLARE @RowsToDeleteFromPRActuals INT = @@rowcount
PRINT (''Rows inserted into #BudgetsWithUnknownActuals: '' + CONVERT(VARCHAR(10),@RowsToDeleteFromPRActuals))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


------------------------------------------------------------------------------------------------------------------------------------------------------
---  BUILD ALL Unknown Budgets - Now merge them into one unique budget set and these are all budgets that need deleting
------------------------------------------------------------------------------------------------------------------------------------------------------
SET @StartTime = GETDATE()

SELECT 
   BUA.SnapshotId, 
   BUA.BudgetId,
   BUA.ImportKey
INTO 
	#AllUnknownBudgets
FROM 
	#BudgetsWithUnknownActuals BUA
	INNER JOIN #BudgetsWithUnknownBudgets BUB ON
		BUB.BudgetId = BUA.BudgetId AND
		BUB.SnapshotId = BUA.SnapshotId AND
		BUB.ImportKey = BUA.ImportKey		
   
   
     
   
	PRINT (''Rows INSERTED INTO #AllUnknownBudgets that have Unknowns: '' + CONVERT(VARCHAR(10),@@rowcount))
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

	INSERT INTO @ImportErrorTable (Error) SELECT ''Unknowns''
	
	IF @RowsToDeleteFromPRBudgets > 0 BEGIN
	    INSERT INTO @ImportErrorTable (Error) SELECT ''Unknown Budgets''
	END
	IF @RowsToDeleteFromPRActuals > 0 BEGIN
	    INSERT INTO @ImportErrorTable (Error) SELECT ''Unknown Actuals''
	END	
	
	
	/**************************************************** DELETIONS COMMENTED OUT FOR NOW, DELETE THIS COMMENT **************************
	
	---------------- Delete the unknown budget portions
	SET @StartTime = GETDATE()

	DELETE
		PR
	FROM
		#ProfitabilityReforecast PR
		INNER JOIN #BudgetsWithUnknownBudgets AUB ON
		  PR.BudgetId = AUB.BudgetId AND
		  PR.SnapshotId = AUB.SnapshotId AND
		  PR.BudgetReforecastTypeKey = AUB.BudgetReforecastTypeKey
	  
	PRINT (''Rows DELETED from #ProfitabilityReforecast that have Unknown Budgets: '' + CONVERT(VARCHAR(10),@@rowcount))
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

	---------------- Delete the unknown actual portions
	SET @StartTime = GETDATE()

	DELETE
		PR
	FROM
		#ProfitabilityReforecast PR
		INNER JOIN #BudgetsWithUnknownActuals AUB ON
		  PR.BudgetId = AUB.BudgetId AND
		  PR.SnapshotId = AUB.SnapshotId AND
		  PR.BudgetReforecastTypeKey = AUB.BudgetReforecastTypeKey		  
	
	
	PRINT (''Rows DELETED from #ProfitabilityReforecast that have Unknown Actuals: '' + CONVERT(VARCHAR(10),@@rowcount))
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			SET @StartTime = GETDATE()
			DELETE x
			FROM TapasGlobalBudgeting.BudgetEmployeeFunctionalDepartment x
			INNER JOIN #BudgetEmployeeFunctionalDepartment xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #BudgetEmployee be ON
				be.BudgetEmployeeId = xh.BudgetEmployeeId
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = be.BudgetId

			PRINT ''Deleted from BudgetEmployeeFunctionalDepartment: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			DELETE x
			FROM TapasGlobalBudgeting.BudgetEmployee x
			INNER JOIN #BudgetEmployee xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = xh.BudgetId

			PRINT ''Deleted from BudgetEmployee: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			DELETE x
			FROM TapasGlobalBudgeting.BudgetEmployeePayrollAllocationDetail x
			INNER JOIN #BudgetEmployeePayrollAllocationDetail xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #BudgetEmployeePayrollAllocation bpa ON
				bpa.BudgetEmployeePayrollAllocationId = xh.BudgetEmployeePayrollAllocationId
			INNER JOIN #BudgetProject bp ON
				bp.BudgetProjectId = bpa.BudgetProjectId
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = bp.BudgetId

			PRINT ''Deleted from BudgetEmployeePayrollAllocationDetail: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT CONVERT(VARCHAR(27), GETDATE(), 121)

			DELETE x
			FROM TapasGlobalBudgeting.BudgetEmployeePayrollAllocation x
			INNER JOIN #BudgetEmployeePayrollAllocation xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #BudgetProject bp ON
				bp.BudgetProjectId = xh.BudgetProjectId
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = bp.BudgetId

			PRINT ''Deleted from BudgetEmployeePayrollAllocation: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			DELETE x
			FROM TapasGlobalBudgeting.BudgetOverheadAllocationDetail x
			INNER JOIN #BudgetOverheadAllocationDetail xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #BudgetProject bp ON
				bp.BudgetProjectId = xh.BudgetProjectId
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = bp.BudgetId

			PRINT ''Deleted from BudgetOverheadAllocationDetail: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			DELETE x
			FROM TapasGlobalBudgeting.BudgetProject x
			INNER JOIN #BudgetProject xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = xh.BudgetId
				
			PRINT ''Deleted from BudgetProject: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			DELETE x
			FROM TapasGlobalBudgeting.BudgetTaxType x
			INNER JOIN #BudgetTaxType xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = xh.BudgetId

			PRINT ''Deleted from BudgetTaxType: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			DELETE x
			FROM TapasGlobalBudgeting.BudgetReportGroupDetail x
			INNER JOIN #AllUnknownBudgets b ON
				b.BudgetId = x.BudgetId 
				--b.ImportBatchId = x.ImportBatchId
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = b.BudgetId

			PRINT ''Deleted from BudgetReportGroupDetail: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

			DELETE x
			FROM TapasGlobalBudgeting.Budget x
			INNER JOIN #AllUnknownBudgets xh ON
				xh.ImportKey = x.ImportKey
			INNER JOIN #AllUnknownBudgets d ON
				d.BudgetId = xh.BudgetId

			PRINT ''Deleted from Budget: '' + CONVERT(CHAR(10), @@ROWCOUNT)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
			
			
	**************************************************** DELETIONS COMMENTED OUT FOR NOW, DELETE THIS COMMENT **************************/








-- ==============================================================================================================================================












-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Insert modified and new data 
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

SET @StartTime = GETDATE()

INSERT INTO GrReporting.dbo.ProfitabilityReforecast
(
	SnapshotId,
	BudgetReforecastTypeKey,
	CalendarKey,
	ReforecastKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId,
	
	EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,

	USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey
)
SELECT
    SnapshotId,
    BudgetReforecastTypeKey,
	CalendarKey,
	ReforecastKey, 
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	(Select FeeAdjustmentKey From GrReporting.dbo.FeeAdjustment Where FeeAdjustmentCode = ''NORMAL''),
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId,
	
	@EUCorporateGlAccountCategoryKeyUnknown, --EUCorporateGlAccountCategoryKey,
	@EUPropertyGlAccountCategoryKeyUnknown, --EUPropertyGlAccountCategoryKey,
	@EUFundGlAccountCategoryKeyUnknown, --EUFundGlAccountCategoryKey,

	@USPropertyGlAccountCategoryKeyUnknown, --USPropertyGlAccountCategoryKey,
	@USCorporateGlAccountCategoryKeyUnknown, ----USCorporateGlAccountCategoryKey,
	@USFundGlAccountCategoryKeyUnknown, --USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	@DevelopmentGlAccountCategoryKeyUnknown --DevelopmentGlAccountCategoryKey
FROM 
	#ProfitabilityReforecast
DECLARE @RowsInsertedIntoProfitabilityReforecastWH INT = @@ROWCOUNT

print ''Rows Inserted in GrReporting.dbo.ProfitabilityReforecast:''+CONVERT(char(10),@RowsInsertedIntoProfitabilityReforecastWH)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- ==============================================================================================================================================
-- Mark budgets as being successfully processed into the warehouse
-- ==============================================================================================================================================

DECLARE @ImportErrorText VARCHAR(500)
SELECT @ImportErrorText = COALESCE(@ImportErrorText + '', '', '''') + Error from @ImportErrorTable

UPDATE
	BTP
SET
    --- Note Slight reverse logic from originally, original it looked if there are anything left in the temp table, now it looks:
    --- IS THERE ANYTHING THAT WAS UNKNOWN for Budgets and Actuals Seperately
	BTP.ReforecastBudgetsProcessedIntoWarehouse = CASE WHEN BWUB.BudgetId IS NULL THEN 1 ELSE 0 END, -- 0 if import fails, 1 if import succeeds
	BTP.ReforecastActualsProcessedIntoWarehouse = CASE WHEN BWUA.BudgetId IS NULL THEN 1 ELSE 0 END, -- 0 if import fails, 1 if import succeeds
	ReasonForFailure = @ImportErrorText,
	BTP.DateBudgetProcessedIntoWarehouse = GETDATE() -- date that the buget import either failed or succeeded (depending on 0 or 1 above)
FROM
	dbo.BudgetsToProcess BTP
	
	INNER JOIN #BudgetsToProcess BTPT ON
		BTP.BudgetsToProcessId = BTPT.BudgetsToProcessId	
	
	LEFT OUTER JOIN #BudgetsWithUnknownBudgets BWUB ON
		BTP.BudgetId = BWUB.BudgetId 

	LEFT OUTER JOIN #BudgetsWithUnknownActuals BWUA ON
		BTP.BudgetId = BWUA.BudgetId 
	
PRINT (''Rows updated from dbo.BudgetsToProcess: '' + CONVERT(VARCHAR(10),@@rowcount))



-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Clean up
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

DROP TABLE #SystemSettingRegion
DROP TABLE #SnapshotGLTranslationType
DROP TABLE #SnapshotGLTranslationSubType
DROP TABLE #SnapshotGLMajorCategory
DROP TABLE #SnapshotGLMinorCategory
DROP TABLE #SnapshotGLAccountType
DROP TABLE #SnapshotGLAccountSubType
DROP TABLE #SnapshotGLAccountCategoryTranslationsPayroll
DROP TABLE #BudgetReportGroupDetail
DROP TABLE #BudgetReportGroup
DROP TABLE #BudgetReportGroupPeriod
DROP TABLE #BudgetStatus
DROP TABLE #NewBudgets
--DROP TABLE #AllModifiedReportBudget
--DROP TABLE #LockedModifiedReportGroup
--DROP TABLE #FilteredModifiedReportBudget
--DROP TABLE #NewBudgets
DROP TABLE #BudgetProject
DROP TABLE #Region
DROP TABLE #BudgetEmployee
DROP TABLE #BudgetEmployeeFunctionalDepartment
DROP TABLE #SnapshotFunctionalDepartment
DROP TABLE #SnapshotPropertyFund
DROP TABLE #SnapshotPropertyFundMapping
DROP TABLE #SnapshotReportingEntityCorporateDepartment
DROP TABLE #SnapshotReportingEntityPropertyEntity
DROP TABLE #Location
DROP TABLE #RegionExtended
DROP TABLE #PayrollRegion
DROP TABLE #OverheadRegion
DROP TABLE #Project
DROP TABLE #BudgetEmployeePayrollAllocation
DROP TABLE #BudgetEmployeePayrollAllocationDetailBatches
DROP TABLE #BEPADa
DROP TABLE #BudgetEmployeePayrollAllocationDetail
DROP TABLE #BudgetTaxType
DROP TABLE #TaxType
DROP TABLE #EmployeePayrollAllocationDetail
DROP TABLE #BudgetOverheadAllocation
DROP TABLE #BudgetOverheadAllocationDetail
DROP TABLE #OverheadAllocationDetail
DROP TABLE #EffectiveFunctionalDepartment
DROP TABLE #ProfitabilityPreTaxSource
DROP TABLE #ProfitabilityTaxSource
DROP TABLE #ProfitabilityOverheadSource
DROP TABLE #ProfitabilityPayrollMapping
DROP TABLE #SnapshotOriginatingRegionCorporateEntity
DROP TABLE #SnapshotOriginatingRegionPropertyDepartment
DROP TABLE #SnapshotAllocationSubRegion
DROP TABLE #ProfitabilityReforecast
DROP TABLE #DeletingBudget

DROP TABLE #GLAccountCategoryMapping
DROP TABLE #SnapshotGLGlobalAccountTranslationType
DROP TABLE #SnapshotGLGlobalAccount
DROP TABLE #SnapshotGLGlobalAccountTranslationSubType


--DROP TABLE #EUCorpCategoryLookup
--DROP TABLE #EUPropCategoryLookup
--DROP TABLE #EUFundCategoryLookup
--DROP TABLE #USPropCategoryLookup
--DROP TABLE #USCorpCategoryLookup
--DROP TABLE #USFundCategoryLookup
DROP TABLE #GlobalCategoryLookup
--DROP TABLE #DevelCategoryLookup

DROP TABLE #BudgetsToProcess 

print ''Cleanup Completed:''+CONVERT(char(10),@RowsInsertedIntoProfitabilityReforecastWH)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
PRINT ''ALL DONE''

' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyPayrollOriginalBudget]    Script Date: 05/16/2011 08:15:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyPayrollOriginalBudget]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyPayrollOriginalBudget]	
	@DataPriorToDate	DateTime=NULL
AS
SET NOCOUNT ON
--DECLARE	@runId int
--EXEC @return_value = dbo.LogMessage ''Now that''''s what I call a message!'', ''stp_IU_LoadGrProfitabiltyPayrollOriginalBudget.#BEPADa'', 1, @Time1, 900, True


PRINT ''####''
PRINT ''stp_IU_LoadGrProfitabiltyPayrollOriginalBudget''
PRINT ''####''

-- Check whether the stored procedure should be run
DECLARE @StartTime DATETIME
DECLARE @StartTime2 DATETIME
DECLARE @RowCount INT
DECLARE @CanImportTapasBudget INT = (SELECT ConfiguredValue FROM [GrReportingStaging].[dbo].[SSISConfigurations] WHERE ConfigurationFilter = ''CanImportTapasBudget'')
DECLARE @ImportErrorTable TABLE (
	Error varchar(50)
);



IF (@CanImportTapasBudget = 0)
BEGIN
	PRINT (''Import TapasBudget not scheduled in SSISConfigurations'')
	RETURN
END

CREATE TABLE #BudgetsToProcess
(
	BudgetsToProcessId INT NOT NULL,
	BatchId INT NOT NULL,
	ImportBatchId INT NOT NULL,
	BudgetReforecastTypeName VARCHAR(50) NOT NULL,
	BudgetId INT NOT NULL,
	BudgetExchangeRateId INT NOT NULL,
	BudgetReportGroupPeriodId INT NOT NULL,
	ImportBudgetFromSourceSystem bit NOT NULL,
	IsReforecast bit NOT NULL,
	SnapshotId INT NOT NULL,
	ImportSnapshotFromSourceSystem BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	MustImportAllActualsIntoWarehouse BIT NULL,
	OriginalBudgetProcessedIntoWarehouse SMALLINT NULL,
	ReforecastActualsProcessedIntoWarehouse SMALLINT NULL,
	ReforecastBudgetsProcessedIntoWarehouse SMALLINT NULL,
	ReasonForFailure VARCHAR(512) NULL,
	DateBudgetProcessedIntoWarehouse DATETIME NULL,
	ReforecastKey INT NOT NULL
)

INSERT #BudgetsToProcess
SELECT 
	BudgetsToProcessId,
	CurrentBatchId,
	ImportBatchId,
	BudgetReforecastTypeName,
	BudgetId,
	BudgetExchangeRateId,
	BudgetReportGroupPeriodId,
	ImportBudgetFromSourceSystem,
	IsReforecast,
	SnapshotId,
	ImportSnapshotFromSourceSystem,
	InsertedDate,
	MustImportAllActualsIntoWarehouse,
	OriginalBudgetProcessedIntoWarehouse,
	ReforecastActualsProcessedIntoWarehouse,
	ReforecastBudgetsProcessedIntoWarehouse,
	ReasonForFailure,
	DateBudgetProcessedIntoWarehouse,
	RR.ReforecastKey
FROM 
	BudgetsToProcessCurrent(''TGB Budget/Reforecast'') BTPC
	
	INNER JOIN (	
		SELECT 
			MIN(ReforecastEffectiveMonth) AS ReforecastEffectiveMonth,
			ReforecastQuarterName,
			ReforecastEffectiveYear
		FROM 		 
			Grreporting.dbo.Reforecast 	
		GROUP BY
			ReforecastQuarterName,
			ReforecastEffectiveYear
	) CRR ON
	CRR.ReforecastEffectiveYear = BTPC.BudgetYear AND
	CRR.ReforecastQuarterName = BTPC.BudgetQuarter
	
	INNER JOIN Grreporting.dbo.Reforecast RR ON
		RR.ReforecastEffectiveMonth = CRR.ReforecastEffectiveMonth AND
		RR.ReforecastQuarterName = CRR.ReforecastQuarterName AND
		RR.ReforecastEffectiveYear = CRR.ReforecastEffectiveYear
		
WHERE 
	IsReforecast = 0

PRINT ''Completed inserting records into #BudgetsToProcess: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


IF NOT EXISTS (SELECT 1 FROM #BudgetsToProcess)
BEGIN
	PRINT (''*******************************************************'')
	PRINT (''	stp_IU_LoadGrProfitabiltyPayrollOriginalBudget is quitting because there are no TAPAS budgets set to be imported.'')
	PRINT (''*******************************************************'')
	RETURN
END

-- finshed checks

IF (@DataPriorToDate IS NULL)
BEGIN
	SET @DataPriorToDate = CONVERT(DateTime,(select ConfiguredValue From SSISConfigurations Where ConfigurationFilter = ''PayrollBudgetDataPriorToDate''))
END

--DECLARE	 @LastImportBatchId INT = (SELECT MAX(BatchId) FROM Batch WHERE PackageName = ''ETL.Staging.TapasGlobalBudgeting'' AND BatchEndDate IS NOT NULL)

/*
exec [stp_IU_LoadGrProfitabiltyPayrollOriginalBudget]
	@ImportStartDate	= ''1900-01-01'',
	@ImportEndDate		= ''2010-12-31'',
	@DataPriorToDate	= ''2010-12-31''
*/ 

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Setup mapping variables
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--/*
-- Setup Bonus Cap Excess Project Setting

CREATE TABLE #SystemSettingRegion(
	SystemSettingId INT NOT NULL,
	SystemSettingName VARCHAR(50) NOT NULL,
	SystemSettingRegionId INT NOT NULL,
	RegionId INT,
	SourceCode VARCHAR(2),
	BonusCapExcessProjectId INT
)
INSERT INTO #SystemSettingRegion(
	SystemSettingId,
	SystemSettingName,
	SystemSettingRegionId,
	RegionId,
	SourceCode,
	BonusCapExcessProjectId
)

SELECT
	ss.SystemSettingId,
	ss.Name,
	ssr.SystemSettingRegionId,
	ssr.RegionId,
	ssr.SourceCode,
	ssr.BonusCapExcessProjectId
FROM
	(SELECT 
		ssr.* 
	 FROM
		TapasGlobal.SystemSettingRegion ssr
		INNER JOIN TapasGlobal.SystemSettingRegionActive(@DataPriorToDate) ssrA ON
			ssr.ImportKey = ssrA.ImportKey
	 ) ssr
	INNER JOIN
		(SELECT
			ss.SystemSettingId,
			ss.Name
		 FROM
			(SELECT	
				ss.*
			 FROM
				TapasGlobal.SystemSetting ss
				INNER JOIN TapasGlobal.SystemSettingActive(@DataPriorToDate) ssA ON
					ss.ImportKey = ssA.ImportKey
			 ) ss

		  ) ss ON
		ssr.SystemSettingId = ss.SystemSettingId
		
PRINT ''Completed getting system settings''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--*/
-- Setup account categories and default to UNKNOWN.
DECLARE 
	@SalariesTaxesBenefitsGLMajorCategoryId INT = -1,
	@BaseSalaryMinorGlAccountCategoryId INT = -1,
	@BenefitsMinorGlAccountCategoryId INT = -1,
	@BonusMinorGlAccountCategoryId INT = -1,
	@ProfitShareMinorGlAccountCategoryId INT = -1,
	@OccupancyCostsMajorGlAccountCategoryId INT = -1,
	@OverheadMinorGlAccountCategoryId INT = -1
	
DECLARE 
	@GlAccountKey			 INT = (SELECT GlAccountKey FROM GrReporting.dbo.GlAccount WHERE Code = ''UNKNOWN''),
	@SourceKey				 INT = (SELECT SourceKey FROM GrReporting.dbo.[Source] WHERE SourceName = ''UNKNOWN''),
	@FunctionalDepartmentKey INT = (SELECT FunctionalDepartmentKey FROM GrReporting.dbo.FunctionalDepartment WHERE FunctionalDepartmentCode = ''UNKNOWN''),
	@ReimbursableKey		 INT = (SELECT ReimbursableKey FROM GrReporting.dbo.Reimbursable WHERE ReimbursableCode = ''UNKNOWN''),
	@ActivityTypeKey		 INT = (SELECT ActivityTypeKey FROM GrReporting.dbo.ActivityType WHERE ActivityTypeCode = ''UNKNOWN''),
	@PropertyFundKey		 INT = (SELECT PropertyFundKey FROM GrReporting.dbo.PropertyFund WHERE PropertyFundName = ''UNKNOWN''),
	@AllocationRegionKey	 INT = (SELECT AllocationRegionKey FROM GrReporting.dbo.AllocationRegion WHERE RegionCode = ''UNKNOWN''),
	@OriginatingRegionKey	 INT = (SELECT OriginatingRegionKey FROM GrReporting.dbo.OriginatingRegion WHERE RegionCode = ''UNKNOWN''),
	@OverheadKey			 INT = (Select OverheadKey From GrReporting.dbo.Overhead Where OverheadCode = ''UNKNOWN''),
    @LocalCurrencyKey		 INT = (SELECT CurrencyKey FROM GrReporting.dbo.Currency WHERE CurrencyCode = ''UNK'')

DECLARE
	@EUFundGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Fund Profit & Loss''      AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@EUCorporateGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@EUPropertyGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Property Profit & Loss''  AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@USFundGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Fund Profit & Loss''      AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@USPropertyGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Property Profit & Loss''  AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@USCorporateGlAccountCategoryKeyUnknown INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@DevelopmentGlAccountCategoryKeyUnknown INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''Development Profit & Loss''  AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN''),
	@GlobalGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global'' AND TranslationSubTypeName = ''Global'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')


DECLARE @BudgetReforecastTypeKey INT = (
	SELECT 
		BudgetReforecastTypeKey 
	FROM 
		GrReporting.dbo.BudgetReforecastType 
	WHERE 
		BudgetReforecastTypeCode = ''TGBBUD'')



-- Set gl account categories
SELECT TOP 1
	@SalariesTaxesBenefitsGLMajorCategoryId = GLMajorCategoryId
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryName = ''Salaries/Taxes/Benefits''

print (@SalariesTaxesBenefitsGLMajorCategoryId)

--NB!!!!!!!
--The roll up to payroll is very sensitive information. It is crutial that information regarding payroll not get 
--communicated to TS employees on certain reports. Changing the category name here will have ramifications because 
--some reports check for this name.
--NB!!!!!!!

SELECT
	@BaseSalaryMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsGLMajorCategoryId AND
	GLMinorCategoryName = ''Base Salary''

SELECT
	@BenefitsMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsGLMajorCategoryId AND
	GLMinorCategoryName = ''Benefits''

SELECT
	@BonusMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsGLMajorCategoryId AND
	GLMinorCategoryName = ''Bonus''

SELECT
	@ProfitShareMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @SalariesTaxesBenefitsGLMajorCategoryId AND
	GLMinorCategoryName = ''Benefits'' -- Yes benefit is correct (Just incase they want to split profit share out again)

SELECT TOP 1
	@OccupancyCostsMajorGlAccountCategoryId = GLMajorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryName = ''General Overhead''

SELECT
	@OverheadMinorGlAccountCategoryId = GLMinorCategoryId 
FROM
	Gr.GetSnapshotGlobalGlAccountCategoryTranslation()
WHERE
	GLMajorCategoryId = @OccupancyCostsMajorGlAccountCategoryId AND
	GLMinorCategoryName = ''External General Overhead''


-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Source Data
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--/*

CREATE TABLE #BudgetAllocationSetSnapshots(
	BudgetAllocationSetId INT NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #BudgetAllocationSetSnapshots(
	BudgetAllocationSetId,
	SnapshotId
)
SELECT
	CAST(GroupKey AS INT),
	SnapshotId
FROM 
	Gdm.Snapshot
WHERE
	GroupName = ''BudgetAllocationSet''
	
SET @StartTime = GETDATE()

-- Get GLTranslationType, GLTranslationSubType, GLAccountType(either expense type), and GLAccountSubType(either payroll type) data
-- This table is used when inserts are made to the TranslationSubType CategoryLookup tables: search for ''Map account categories'' section
CREATE TABLE #GLAccountCategoryTranslations(
	SnapshotId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLTranslationSubTypeCode VARCHAR(10) NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL,
	IsPayroll BIT NOT NULL,
	IsOverhead BIT NOT NULL
)

INSERT INTO #GLAccountCategoryTranslations(
	SnapshotId,
	GLTranslationTypeId,
	GLTranslationSubTypeId,
	GLTranslationSubTypeCode,
	GLAccountTypeId,
	GLAccountSubTypeId,
	IsPayroll,
	IsOverhead
)
SELECT
	TST.SnapshotId,
	TST.GLTranslationTypeId,
	TST.GLTranslationSubTypeId,
	TST.Code,
	AT.GLAccountTypeId,
	AST.GLAccountSubTypeId,
	CASE WHEN AST.Code LIKE ''%PYR'' THEN 1 ELSE 0 END IsPayroll,
	CASE WHEN AST.Code LIKE ''%OHD'' THEN 1 ELSE 0 END IsOverhead	
FROM
	Gdm.SnapshotGLTranslationSubType TST

	INNER JOIN Gdm.SnapshotGLTranslationType TT ON
		TT.GLTranslationTypeId = TST.GLTranslationTypeId AND
		TT.SnapshotId = TST.SnapshotId

	INNER JOIN Gdm.SnapshotGLAccountType AT ON
		TST.GLTranslationTypeId = AT.GLTranslationTypeId AND
		TST.SnapshotId = AT.SnapshotId

	INNER JOIN Gdm.SnapshotGLAccountSubType AST ON
		TST.GLTranslationTypeId = AST.GLTranslationTypeId AND
		TST.SnapshotId = AST.SnapshotId
	
WHERE	
	(AST.Code LIKE ''%PYR'' OR AST.Code LIKE ''%OHD'') AND
	TST.Code = ''GL'' AND	
	AT.Code LIKE ''%EXP'' AND
	TT.IsActive = 1 AND
	TST.IsActive = 1 AND
	AT.IsActive = 1 AND
	AST.IsActive = 1


PRINT ''Completed inserting records into #GLAccountCategoryTranslations: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


CREATE TABLE #DistinctImports
(
	ImportBatchId INT NOT NULL
)
INSERT INTO #DistinctImports
SELECT DISTINCT
	ImportBatchId
FROM 
	#BudgetsToProcess BTP

SET @StartTime = GETDATE()


CREATE TABLE #Budget(	
	SnapshotId INT NOT NULL,
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	BudgetId INT NOT NULL,
	RegionId INT NOT NULL,	
	CurrencyCode VARCHAR(3) NOT NULL,
	BudgetReportGroupId INT NOT NULL,
	BudgetReportGroupPeriod	INT NOT NULL,
	GroupStartPeriod INT NOT NULL,
	GroupEndPeriod INT NOT NULL,
	ReforecastKey INT NOT NULL
)

INSERT INTO #Budget(
	SnapshotId,	
	ImportKey,
	ImportBatchId,
	BudgetId,
	RegionId,	
	CurrencyCode,
	BudgetReportGroupId,
	BudgetReportGroupPeriod,
	GroupStartPeriod,
	GroupEndPeriod,
	ReforecastKey
	
)
SELECT 		
	btp.SnapshotId,
	Budget.ImportKey,
	Budget.ImportBatchId,
	Budget.BudgetId,
	Budget.RegionId,
	Budget.CurrencyCode,		
	brg.BudgetReportGroupId,
	brgp.Period AS BudgetReportGroupPeriod,
	brg.StartPeriod AS GroupStartPeriod,
	brg.EndPeriod AS GroupEndPeriod,
	BTP.ReforecastKey
FROM
	#BudgetsToProcess btp 
	
	INNER JOIN TapasGlobalBudgeting.Budget Budget ON
		Budget.BudgetId = btp.BudgetId AND
		Budget.ImportBatchId = btp.ImportBatchId

	INNER JOIN TapasGlobalBudgeting.BudgetReportGroupDetail brgd ON
		Budget.BudgetId = brgd.BudgetId AND
		Budget.ImportBatchId = brgd.ImportBatchId
		
	INNER JOIN TapasGlobalBudgeting.BudgetReportGroup brg ON
		brgd.BudgetReportGroupId = brg.BudgetReportGroupId AND
		brgd.ImportBatchId = brg.ImportBatchId	
	
	INNER JOIN Gdm.BudgetReportGroupPeriod brgp ON
		brgp.BudgetReportGroupPeriodId = brg.BudgetReportGroupPeriodId
		
	INNER JOIN Gdm.BudgetReportGroupPeriodActive(@DataPriorToDate) brgpA ON
		brgp.ImportKey = brgpA.ImportKey

PRINT ''Completed inserting records into #Budget: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_BudgetID ON #Budget (BudgetId)
PRINT ''Completed creating indexes on #Budget''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()


CREATE TABLE #GLAccountSubTypeIdBudgetMappings
(
	SnapshotId INT NOT NULL,
	BudgetId INT NOT NULL,	
	GLAccountSubTypeId INT NOT NULL,	
	IsPayroll BIT NOT NULL,
	IsOverhead BIT NOT NULL 
)
INSERT INTO #GLAccountSubTypeIdBudgetMappings
SELECT 
	B.SnapshotId, 
	BudgetId, 
	GLAccountSubTypeId, 
	IsPayroll, 
	IsOverhead
FROM 
	#GLAccountCategoryTranslations GLCTO	
	INNER JOIN #Budget B ON
		B.SnapshotId = GLCTO.SnapshotId
WHERE 
	GLTranslationSubTypeCode = ''GL''


SET @RowCount = @@ROWCOUNT

PRINT ''Completed inserting records into #GLAccountSubTypeIdBudgetMappings: ''+CONVERT(char(10),@RowCount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

IF (@RowCount = 0)
BEGIN
   RAISERROR(''#GLAccountSubTypeIdBudgetMappings: NO Records inserted, please check there are rows in Gdm.SnapshotGLTranslationType for the Budgets in BudgetsToProcess'', 16, -1)
   RETURN
END



--*/
------------------------------------------------------------------------------------------------------
--Source associated records
------------------------------------------------------------------------------------------------------


SET @StartTime = GETDATE()

--/*
-- Source budget project
-- Get all the budget projects that are associated with the budgets that will be pulled, as per code above
CREATE TABLE #BudgetProject(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetProjectId INT NOT NULL,
	BudgetId INT NOT NULL,
	ProjectId INT NULL,
	RegionId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	Code VARCHAR(50) NULL,
	[Name] VARCHAR(100) NULL,
	CorporateDepartmentCode VARCHAR(6) NULL,
	CorporateSourceCode VARCHAR(2) NULL,
	StartPeriod INT NOT NULL,
	EndPeriod INT NULL,
	IsReimbursable BIT NOT NULL, --“NonPayrollReimbursable” 
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetProjectId INT NULL,
	IsTsCost BIT NOT NULL,
	CanAllocateOverheads BIT NOT NULL,
	AllocateOverheadsProjectId INT NULL,
	MarkUpPercentage DECIMAL(5, 4) NULL,
	ProjectOwnerStaffId INT NULL,
	AMBudgetProjectId INT NULL
)

INSERT INTO #BudgetProject(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetProjectId,
	BudgetId,
	ProjectId,
	RegionId,
	PropertyFundId,
	ActivityTypeId,
	Code,
	[Name],
	CorporateDepartmentCode,
	CorporateSourceCode,
	StartPeriod,
	EndPeriod,
	IsReimbursable,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetProjectId,
	IsTsCost,
	CanAllocateOverheads,
	AllocateOverheadsProjectId,
	MarkUpPercentage,
	ProjectOwnerStaffId,
	AMBudgetProjectId
)
SELECT 
	BudgetProject.* 
FROM 
	TapasGlobalBudgeting.BudgetProject BudgetProject
		
	-- data limiting join
	INNER JOIN #Budget b ON
		BudgetProject.BudgetId = b.BudgetId AND
		BudgetProject.ImportBatchId = b.ImportBatchId

PRINT ''Completed inserting records into #BudgetProject: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()


CREATE CLUSTERED INDEX IX_BudgetID ON #BudgetProject (BudgetId)
PRINT ''Completed creating indexes on #BudgetProject''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source region
SET @StartTime = GETDATE()

CREATE TABLE #Region(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	RegionId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	PayCode VARCHAR(5) NULL,
	EnrollmentTypeId INT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

INSERT INTO #Region(
	ImportKey,
	ImportBatchId,
	ImportDate,
	RegionId,
	SourceCode,
	Code,
	[Name],
	PayCode,
	EnrollmentTypeId,
	InsertedDate,
	UpdatedDate
)
SELECT 
	SourceRegion.* 
FROM 
	HR.Region SourceRegion
	INNER JOIN HR.RegionActive(@DataPriorToDate) SourceRegionA ON
		SourceRegion.ImportKey = SourceRegionA.ImportKey
PRINT ''Completed inserting records into #Region: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Budget Employee
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployee(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	BudgetId INT NOT NULL,
	HrEmployeeId INT NULL,
	PayGroupId INT NOT NULL,
	JobTitleId INT NOT NULL,
	LocationId INT NOT NULL,
	StateId INT NULL,
	OverheadRegionId INT NOT NULL,
	ApproverStaffId INT NULL,
	[Name] VARCHAR(255) NOT NULL,
	IsUnion BIT NOT NULL,
	RehirePeriod INT NOT NULL,
	RehireDate DATETIME NOT NULL,
	TerminatePeriod INT NULL,
	TerminateDate DATETIME NULL,
	EmployeeHistoryEffectivePeriod INT NOT NULL,
	EmployeeHistoryEffectiveDate DATETIME NOT NULL,
	EmployeePayrollEffectiveDate DATETIME NULL,
	CurrentAnnualSalary DECIMAL(18, 2) NULL,
	PreviousYearSalary DECIMAL(18, 2) NULL,
	SalaryYear INT NOT NULL,
	PreviousYearBonus DECIMAL(18, 2) NULL,
	BonusYear INT NULL,
	IsActualEmployee BIT NOT NULL,
	IsReviewed BIT NOT NULL,
	IsPartTime BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetEmployeeId INT NULL
)

INSERT INTO #BudgetEmployee(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeeId,
	BudgetId,
	HrEmployeeId,
	PayGroupId,
	JobTitleId,
	LocationId,
	StateId,
	OverheadRegionId ,
	ApproverStaffId,
	[Name],
	IsUnion,
	RehirePeriod,
	RehireDate,
	TerminatePeriod,
	TerminateDate,
	EmployeeHistoryEffectivePeriod,
	EmployeeHistoryEffectiveDate,
	EmployeePayrollEffectiveDate,
	CurrentAnnualSalary,
	PreviousYearSalary,
	SalaryYear,
	PreviousYearBonus,
	BonusYear,
	IsActualEmployee,
	IsReviewed,
	IsPartTime,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetEmployeeId
)
SELECT 
	BudgetEmployee.* 
FROM 
	TapasGlobalBudgeting.BudgetEmployee BudgetEmployee

	--data limiting join
	INNER JOIN #Budget b ON
		BudgetEmployee.BudgetId = b.BudgetId AND
		BudgetEmployee.ImportBatchId = b.ImportBatchId

PRINT ''Completed inserting records into #BudgetEmployee: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_BudgetEmployeeID ON #BudgetEmployee (BudgetEmployeeId)
CREATE INDEX IX_BudgetId ON #BudgetEmployee (BudgetId)

PRINT ''Completed creating indexes on #BudgetEmployee''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Budget Employee Functional Department
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeeFunctionalDepartment(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeeFunctionalDepartmentId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	SubDepartmentId INT NOT NULL,
	EffectivePeriod INT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL
)

INSERT INTO #BudgetEmployeeFunctionalDepartment(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeeFunctionalDepartmentId,
	BudgetEmployeeId,
	SubDepartmentId,
	EffectivePeriod,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	FunctionalDepartmentId
)

SELECT 
	efd.* 
FROM 
	TapasGlobalBudgeting.BudgetEmployeeFunctionalDepartment efd

	-- data limiting join
	INNER JOIN #BudgetEmployee be ON
		efd.BudgetEmployeeId = be.BudgetEmployeeId AND
		efd.ImportBatchId = be.ImportBatchId

PRINT ''Completed inserting records into #BudgetEmployeeFunctionalDepartment: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_BudgetEmployeeId ON #BudgetEmployeeFunctionalDepartment (BudgetEmployeeId)
CREATE INDEX IX_BudgetEmployeeFunctionalDepartment2 ON #BudgetEmployeeFunctionalDepartment (ImportBatchId, BudgetEmployeeId, EffectivePeriod)


PRINT ''Completed creating indexes on #BudgetEmployeeFunctionalDepartment''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source Location
SET @StartTime = GETDATE()

CREATE TABLE #Location(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	LocationId INT NOT NULL,
	ExternalSubRegionId INT NOT NULL,
	StateId INT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

INSERT INTO #Location(
	ImportKey,
	ImportBatchId,
	ImportDate,
	LocationId,
	ExternalSubRegionId,
	StateId,
	Code,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate
)
SELECT 
	Location.* 
FROM 
	HR.Location Location
	INNER JOIN HR.LocationActive(@DataPriorToDate) LocationA ON
		Location.ImportKey = LocationA.ImportKey
	
PRINT ''Completed inserting records into #Location: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_LocationId ON #Location (LocationId)

PRINT ''Completed creating indexes on #Location''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source region extended
SET @StartTime = GETDATE()

CREATE TABLE #RegionExtended(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	RegionId INT NOT NULL,
	RegionalAdministratorId INT NOT NULL,
	CountryId INT NOT NULL,
	HasEmployees BIT NOT NULL,
	CanChargeMarkupOnProject BIT NOT NULL,
	CanChargeMarkupOnPayrollOverhead BIT NOT NULL,
	CanUploadOverheadJournal BIT NOT NULL,
	ProjectRef VARCHAR(8) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OverheadFunctionalDepartmentId INT NOT NULL,
	CanRegionBillInArrears BIT NOT NULL
)

INSERT INTO #RegionExtended(
	ImportKey,
	ImportBatchId,
	ImportDate,
	RegionId,
	RegionalAdministratorId,
	CountryId,
	HasEmployees,
	CanChargeMarkupOnProject,
	CanChargeMarkupOnPayrollOverhead,
	CanUploadOverheadJournal,
	ProjectRef,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OverheadFunctionalDepartmentId,
	CanRegionBillInArrears
)
SELECT 
	RegionExtended.* 
FROM 
	TapasGlobal.RegionExtended RegionExtended
	INNER JOIN TapasGlobal.RegionExtendedActive(@DataPriorToDate) RegionExtendedA ON
		RegionExtended.ImportKey = RegionExtendedA.ImportKey

PRINT ''Completed inserting records into #RegionExtended: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_RegionId ON #RegionExtended (RegionId)

PRINT ''Completed creating indexes on #RegionExtended''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- Source project
SET @StartTime = GETDATE()

CREATE TABLE #Project(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	ProjectId INT NOT NULL,
	RegionId INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	ProjectOwnerId INT NULL,
	CorporateDepartmentCode VARCHAR(8) NOT NULL,
	CorporateSourceCode CHAR(2) NOT NULL,
	Code VARCHAR(50) NOT NULL,
	[Name] VARCHAR(100) NOT NULL,
	StartPeriod INT NOT NULL,
	EndPeriod INT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	PropertyOverheadGLAccountCode VARCHAR(15) NULL,
	PropertyOverheadDepartmentCode VARCHAR(6) NULL,
	PropertyOverheadJobCode VARCHAR(15) NULL,
	PropertyOverheadSourceCode CHAR(2) NULL,
	CorporateUnionPayrollIncomeCategoryCode VARCHAR(6) NULL,
	CorporateNonUnionPayrollIncomeCategoryCode VARCHAR(6) NULL,
	CorporateOverheadIncomeCategoryCode VARCHAR(6) NULL,
	PropertyFundId INT NOT NULL,
	MarkUpPercentage DECIMAL(5, 4) NULL,
	HistoricalProjectCode VARCHAR(50) NULL,
	IsTSCost BIT NOT NULL,
	CanAllocateOverheads BIT NOT NULL,
	AllocateOverheadsProjectId INT NULL
)

INSERT INTO #Project(
	ImportKey,
	ImportBatchId,
	ImportDate,
	ProjectId,
	RegionId,
	ActivityTypeId,
	ProjectOwnerId,
	CorporateDepartmentCode,
	CorporateSourceCode,
	Code,
	[Name],
	StartPeriod,
	EndPeriod,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	PropertyOverheadGLAccountCode,
	PropertyOverheadDepartmentCode,
	PropertyOverheadJobCode,
	PropertyOverheadSourceCode,
	CorporateUnionPayrollIncomeCategoryCode,
	CorporateNonUnionPayrollIncomeCategoryCode,
	CorporateOverheadIncomeCategoryCode,
	PropertyFundId,
	MarkUpPercentage,
	HistoricalProjectCode,
	IsTSCost,
	CanAllocateOverheads,
	AllocateOverheadsProjectId
)
SELECT 
	Project.*
FROM 
	TapasGlobal.Project Project
	INNER JOIN TapasGlobal.ProjectActive(@DataPriorToDate) ProjectA ON
		Project.ImportKey = ProjectA.ImportKey 

PRINT ''Completed inserting records into #Project: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_ProjectId ON #Project (ProjectId)

PRINT ''Completed creating indexes on #Project''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

------------------------------------------------------------------------------------------------------
--Source allocation records
------------------------------------------------------------------------------------------------------

-- Source payroll allocation
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeePayrollAllocation(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	BudgetProjectId INT NOT NULL,
	BudgetProjectGroupId INT NULL,
	Period INT NOT NULL,
	SalaryAllocationValue DECIMAL(18, 9) NOT NULL,
	BonusAllocationValue DECIMAL(18, 9) NULL,
	BonusCapAllocationValue DECIMAL(18, 9) NULL,
	ProfitShareAllocationValue DECIMAL(18, 9) NULL,
	PreTaxSalaryAmount DECIMAL(18, 2) NOT NULL,
	PreTaxBonusAmount DECIMAL(18, 2) NULL,
	PreTaxBonusCapExcessAmount DECIMAL(18, 2) NULL,
	PreTaxProfitShareAmount DECIMAL(18, 2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetEmployeePayrollAllocationId INT NULL
)

INSERT INTO #BudgetEmployeePayrollAllocation(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeePayrollAllocationId,
	BudgetEmployeeId,
	BudgetProjectId,
	BudgetProjectGroupId,
	Period,
	SalaryAllocationValue,
	BonusAllocationValue,
	BonusCapAllocationValue,
	ProfitShareAllocationValue,
	PreTaxSalaryAmount,
	PreTaxBonusAmount,
	PreTaxBonusCapExcessAmount,
	PreTaxProfitShareAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetEmployeePayrollAllocationId
)
SELECT
	Allocation.*
FROM
	TapasGlobalBudgeting.BudgetEmployeePayrollAllocation Allocation


	INNER JOIN #DistinctImports DI ON
		Allocation.ImportBatchId = DI.ImportBatchId

	--data limiting join
	INNER JOIN #BudgetProject bp ON
		Allocation.BudgetProjectId = bp.BudgetProjectId

PRINT ''Completed inserting records into #BudgetEmployeePayrollAllocation: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_BudgetEmployeePayrollAllocationId ON #BudgetEmployeePayrollAllocation (ImportBatchId, BudgetEmployeePayrollAllocationId)

PRINT ''Completed creating indexes on #BudgetEmployeePayrollAllocation''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source payroll tax detail
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Using the ''active'' function here cause serious performance issues and the only way around it, was to extract the logic from the is active function 
--to seperate peaces of code.
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeePayrollAllocationDetailBatches(
	BudgetEmployeePayrollAllocationDetailId int NOT NULL,
	ImportBatchId INT NOT NULL
)

INSERT INTO #BudgetEmployeePayrollAllocationDetailBatches(
	BudgetEmployeePayrollAllocationDetailId,
	ImportBatchId
)
SELECT 
	B2.BudgetEmployeePayrollAllocationDetailId,
	MAX(B2.ImportBatchId) AS ImportBatchId
FROM 
	[TapasGlobalBudgeting].[BudgetEmployeePayrollAllocationDetail] B2
		
	INNER JOIN #DistinctImports DI ON
		B2.ImportBatchId = DI.ImportBatchId
		
GROUP BY
	B2.BudgetEmployeePayrollAllocationDetailId

PRINT ''Completed inserting records into #BudgetEmployeePayrollAllocationDetailBatches: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_BudgetEmployeePayrollAllocationDetailBatches ON #BudgetEmployeePayrollAllocationDetailBatches (ImportBatchId, BudgetEmployeePayrollAllocationDetailId)

PRINT ''Completed creating indexes on #BudgetEmployeePayrollAllocationDetailBatches''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

----------
SET @StartTime = GETDATE()

CREATE TABLE #BEPADa(
	ImportKey INT NOT NULL
)

INSERT INTO #BEPADa(
	ImportKey
)
SELECT
	MAX(B1.ImportKey) ImportKey
FROM
	[TapasGlobalBudgeting].[BudgetEmployeePayrollAllocationDetail] B1

	INNER JOIN #BudgetEmployeePayrollAllocationDetailBatches t1 ON 
		t1.BudgetEmployeePayrollAllocationDetailId = B1.BudgetEmployeePayrollAllocationDetailId AND
		t1.ImportBatchId = B1.ImportBatchId

GROUP BY
	B1.BudgetEmployeePayrollAllocationDetailId

SET @StartTime = GETDATE()

PRINT ''Completed inserting records into #BEPADa: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE INDEX IX_BEPADa1 ON #BEPADa (ImportKey)

PRINT ''Completed creating indexes on #BEPADa''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

CREATE TABLE #BudgetEmployeePayrollAllocationDetail(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetEmployeePayrollAllocationDetailId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BenefitOptionId INT NULL,
	BudgetTaxTypeId INT NULL,
	SalaryAmount DECIMAL(18, 2) NULL,
	BonusAmount DECIMAL(18, 2) NULL,
	ProfitShareAmount DECIMAL(18, 2) NULL,
	BonusCapExcessAmount DECIMAL(18, 2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #BudgetEmployeePayrollAllocationDetail(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetEmployeePayrollAllocationDetailId,
	BudgetEmployeePayrollAllocationId,
	BenefitOptionId,
	BudgetTaxTypeId,
	SalaryAmount,
	BonusAmount,
	ProfitShareAmount,
	BonusCapExcessAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	TaxDetail.*
FROM
	TapasGlobalBudgeting.BudgetEmployeePayrollAllocationDetail TaxDetail
	
    --data limiting join
	INNER JOIN #BudgetEmployeePayrollAllocation Allocation ON
		Allocation.ImportBatchId = TaxDetail.ImportBatchId AND
		Allocation.BudgetEmployeePayrollAllocationId = TaxDetail.BudgetEmployeePayrollAllocationId
		
	INNER JOIN #BEPADa TaxDetailA ON
		TaxDetail.ImportKey = TaxDetailA.ImportKey

PRINT ''Completed inserting records into #BudgetEmployeePayrollAllocationDetail: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE UNIQUE CLUSTERED INDEX IX_BudgetEmployeePayrollAllocationDetailId ON #BudgetEmployeePayrollAllocationDetail (ImportBatchId, BudgetEmployeePayrollAllocationDetailId)

PRINT ''Completed creating indexes on #BudgetEmployeePayrollAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source budget tax type
SET @StartTime = GETDATE()

CREATE TABLE #BudgetTaxType(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetTaxTypeId INT NOT NULL,
	BudgetId INT NOT NULL,
	TaxTypeId INT NOT NULL,
	FixedTaxTypeId INT NOT NULL,
	RateCalculationMethodId INT NOT NULL,
	Name VARCHAR(100) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetTaxTypeId INT NULL
)

INSERT INTO #BudgetTaxType(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetTaxTypeId,
	BudgetId,
	TaxTypeId,
	FixedTaxTypeId,
	RateCalculationMethodId,
	Name,
	InsertedDate,
	UpdatedByStaffId,
	OriginalBudgetTaxTypeId
)
SELECT 
	BudgetTaxType.* 
FROM 
	TapasGlobalBudgeting.BudgetTaxType BudgetTaxType

	-- data limiting join
	INNER JOIN #Budget b ON
		BudgetTaxType.BudgetId = b.BudgetId AND
		BudgetTaxType.ImportBatchId = b.ImportBatchId

PRINT ''Completed inserting records into #BudgetTaxType: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_BudgetTaxTypeId ON #BudgetTaxType (BudgetTaxTypeId)
PRINT ''Completed creating indexes on #BudgetTaxType''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source tax type
SET @StartTime = GETDATE()

CREATE TABLE #TaxType(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	TaxTypeId INT NOT NULL,
	RegionId INT NOT NULL,
	FixedTaxTypeId INT NOT NULL,
	RateCalculationMethodId INT NOT NULL,
	Name VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL
)

INSERT INTO #TaxType(
	ImportKey,
	ImportBatchId,
	ImportDate,
	TaxTypeId,
	RegionId,
	FixedTaxTypeId,
	RateCalculationMethodId,
	Name,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	MinorGlAccountCategoryId
)
SELECT 
	TaxType.* 
FROM 
	TapasGlobalBudgeting.TaxType TaxType
	
	INNER JOIN #DistinctImports DI ON
		DI.ImportBatchId = TaxType.ImportBatchId


PRINT ''Completed inserting records into #TaxType: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_TaxType ON #TaxType (ImportBatchId, TaxTypeId)

PRINT ''Completed creating indexes on #TaxType''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

-- Source payroll allocation Tax detail
CREATE TABLE #EmployeePayrollAllocationDetail
(
	ImportKey INT NOT NULL,
	BudgetEmployeePayrollAllocationDetailId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	MinorGlAccountCategoryId INT NULL,
	BudgetTaxTypeId INT NULL,
	SalaryAmount DECIMAL(18, 2) NULL,
	BonusAmount DECIMAL(18, 2) NULL,
	ProfitShareAmount DECIMAL(18, 2) NULL,
	BonusCapExcessAmount DECIMAL(18, 2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

-- Classifies tax types into minor categories, see CASE statement; gets set here because it can be overwritten later in the stored procedure

INSERT INTO #EmployeePayrollAllocationDetail
(
	ImportKey,
	BudgetEmployeePayrollAllocationDetailId,
	BudgetEmployeePayrollAllocationId,
	MinorGlAccountCategoryId,
	BudgetTaxTypeId,
	SalaryAmount,
	BonusAmount,
	ProfitShareAmount,
	BonusCapExcessAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	TaxDetail.ImportKey,
	TaxDetail.BudgetEmployeePayrollAllocationDetailId,
	TaxDetail.BudgetEmployeePayrollAllocationId,
	CASE WHEN (TaxDetail.BenefitOptionId IS NOT NULL) THEN @BenefitsMinorGlAccountCategoryId ELSE TaxType.MinorGlAccountCategoryId END AS MinorGlAccountCategoryId,
	TaxDetail.BudgetTaxTypeId,
	TaxDetail.SalaryAmount,
	TaxDetail.BonusAmount,
	TaxDetail.ProfitShareAmount,
	TaxDetail.BonusCapExcessAmount,
	TaxDetail.InsertedDate,
	TaxDetail.UpdatedDate,
	TaxDetail.UpdatedByStaffId
FROM

	-- Joining on allocation to limit amount of data
	#BudgetEmployeePayrollAllocation Allocation
	
	INNER JOIN #BudgetEmployeePayrollAllocationDetail TaxDetail ON
		Allocation.BudgetEmployeePayrollAllocationId = TaxDetail.BudgetEmployeePayrollAllocationId AND
		Allocation.ImportBatchId = TaxDetail.ImportBatchId
			
	LEFT OUTER JOIN #BudgetTaxType BudgetTaxType ON -- rather pull through as unknown than exclude, therefore LEFT JOIN
		TaxDetail.BudgetTaxTypeId = BudgetTaxType.BudgetTaxTypeId AND
		TaxDetail.ImportBatchId = BudgetTaxType.ImportBatchId
		
				
	LEFT OUTER JOIN #TaxType TaxType ON
		BudgetTaxType.TaxTypeId = TaxType.TaxTypeId	AND
		BudgetTaxType.ImportBatchId = TaxType.ImportBatchId
			
PRINT ''Completed inserting records into #EmployeePayrollAllocationDetail: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #EmployeePayrollAllocationDetail (BudgetEmployeePayrollAllocationDetailId,  BudgetEmployeePayrollAllocationId)
CREATE INDEX IX_EmployeePayrollAllocationDetail2 ON #EmployeePayrollAllocationDetail (BudgetEmployeePayrollAllocationId)

PRINT ''Completed creating indexes on #EmployeePayrollAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--*/
-- Source payroll overhead allocation
SET @StartTime = GETDATE()

CREATE TABLE #BudgetOverheadAllocation(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetOverheadAllocationId INT NOT NULL,
	BudgetId INT NOT NULL,
	OverheadRegionId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	BudgetPeriod INT NOT NULL,
	AllocationAmount DECIMAL(18, 2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	OriginalBudgetOverheadAllocationId INT NULL
)

INSERT INTO #BudgetOverheadAllocation(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetOverheadAllocationId,
	BudgetId,
	OverheadRegionId,
	BudgetEmployeeId,
	BudgetPeriod,
	AllocationAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	OriginalBudgetOverheadAllocationId
)
SELECT
	OverheadAllocation.*
FROM
	TapasGlobalBudgeting.BudgetOverheadAllocation OverheadAllocation

	-- data limiting join
	INNER JOIN #Budget b ON
		OverheadAllocation.BudgetId = b.BudgetId AND
		OverheadAllocation.ImportBatchId = b.ImportBatchId

PRINT ''Completed inserting records into #BudgetOverheadAllocation: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_Clustered ON #BudgetOverheadAllocation (BudgetOverheadAllocationId,BudgetId,OverheadRegionId,BudgetEmployeeId)
PRINT ''Completed creating indexes on #BudgetOverheadAllocation''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Source overhead allocation detail
SET @StartTime = GETDATE()

CREATE TABLE #BudgetOverheadAllocationDetail(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	ImportDate DATETIME NOT NULL,
	BudgetOverheadAllocationDetailId INT NOT NULL,
	BudgetOverheadAllocationId INT NOT NULL,
	BudgetProjectId INT NOT NULL,
	AllocationValue DECIMAL(18, 9) NOT NULL,
	AllocationAmount DECIMAL(18, 2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #BudgetOverheadAllocationDetail(
	ImportKey,
	ImportBatchId,
	ImportDate,
	BudgetOverheadAllocationDetailId,
	BudgetOverheadAllocationId,
	BudgetProjectId,
	AllocationValue,
	AllocationAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT 
	OverheadDetail.*
FROM			
	TapasGlobalBudgeting.BudgetOverheadAllocationDetail OverheadDetail

	INNER JOIN #DistinctImports DI ON
		OverheadDetail.ImportBatchId = DI.ImportBatchId

	-- data limiting join
	INNER JOIN #BudgetProject b ON
		OverheadDetail.BudgetProjectId = b.BudgetProjectId

PRINT ''Completed inserting records into #BudgetOverheadAllocationDetail: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_Clustered ON #BudgetOverheadAllocationDetail (BudgetOverheadAllocationId,BudgetOverheadAllocationDetailId)
CREATE INDEX IX_BudgetOverheadAllocationDetail2 ON #BudgetOverheadAllocationDetail (BudgetOverheadAllocationId)


PRINT ''Completed creating indexes on #BudgetOverheadAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

-- Source payroll overhead allocation detail
CREATE TABLE #OverheadAllocationDetail
(
	ImportKey INT NOT NULL,
	BudgetOverheadAllocationDetailId INT NOT NULL,
	BudgetOverheadAllocationId INT NOT NULL,
	BudgetProjectId INT NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL,
	AllocationValue DECIMAL(18, 9) NOT NULL,
	AllocationAmount DECIMAL(18, 2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

INSERT INTO #OverheadAllocationDetail
(
	ImportKey,
	BudgetOverheadAllocationDetailId,
	BudgetOverheadAllocationId,
	BudgetProjectId,
	MinorGlAccountCategoryId,
	AllocationValue,
	AllocationAmount,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	OverheadDetail.ImportKey,
	OverheadDetail.BudgetOverheadAllocationDetailId,
	OverheadDetail.BudgetOverheadAllocationId,
	OverheadDetail.BudgetProjectId,
	@OverheadMinorGlAccountCategoryId AS MinorGlAccountCategoryId, -- Hardcode to a specific minor category, could be changed later in the stored proc
	OverheadDetail.AllocationValue,
	OverheadDetail.AllocationAmount,
	OverheadDetail.InsertedDate,
	OverheadDetail.UpdatedDate,
	OverheadDetail.UpdatedByStaffId
FROM

	-- Joining on allocation to limit amount of data
	#BudgetOverheadAllocation OverheadAllocation
	
	INNER JOIN #BudgetOverheadAllocationDetail OverheadDetail ON -- Only pull allocationDetails for the allocations we are pulling
		OverheadAllocation.BudgetOverheadAllocationId = OverheadDetail.BudgetOverheadAllocationId AND
		OverheadAllocation.ImportBatchId = OverheadDetail.ImportBatchId
			
PRINT ''Completed inserting records into #OverheadAllocationDetail: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

CREATE CLUSTERED INDEX IX_Clustered ON #OverheadAllocationDetail (BudgetOverheadAllocationId,BudgetOverheadAllocationDetailId)
CREATE INDEX IX_OverheadAllocationDetail2 ON #OverheadAllocationDetail (BudgetOverheadAllocationId)


PRINT ''Completed creating indexes on #OverheadAllocationDetail''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Map Data
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

SET @StartTime = GETDATE()

--Calculate effective functional department
-- What was the last period before an employee changed her functional department, finds all functional departments that an employee is associated with
CREATE TABLE #EffectiveFunctionalDepartment(
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BudgetEmployeeId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL
)

INSERT INTO #EffectiveFunctionalDepartment(
	BudgetEmployeePayrollAllocationId,
	BudgetEmployeeId,
	FunctionalDepartmentId
)
SELECT 
	Allocation.BudgetEmployeePayrollAllocationId,
	Allocation.BudgetEmployeeId,
	ISNULL((
		SELECT 
			EFD.FunctionalDepartmentId
		FROM 
			(
				SELECT
					Allocation2.ImportBatchId,
					Allocation2.BudgetEmployeeId,
					MAX(EFD.EffectivePeriod) AS EffectivePeriod
				FROM
					#BudgetEmployeePayrollAllocation Allocation2

					INNER JOIN #BudgetEmployeeFunctionalDepartment EFD ON
						Allocation2.BudgetEmployeeId = EFD.BudgetEmployeeId AND
						Allocation2.ImportBatchId = EFD.ImportBatchId
		
				WHERE
					Allocation.BudgetEmployeePayrollAllocationId = Allocation2.BudgetEmployeePayrollAllocationId AND
					Allocation.ImportBatchId = Allocation2.ImportBatchId AND
					EFD.EffectivePeriod <= Allocation.Period
			  
				GROUP BY
					Allocation2.ImportBatchId,
					Allocation2.BudgetEmployeeId
			) EFDo
		
			LEFT OUTER JOIN #BudgetEmployeeFunctionalDepartment EFD ON
				EFD.ImportBatchId = EFDo.ImportBatchId AND
				EFD.BudgetEmployeeId = EFDo.BudgetEmployeeId AND				
				EFD.EffectivePeriod = EFDo.EffectivePeriod
	 ), -1) AS FunctionalDepartmentId
FROM
	#BudgetEmployeePayrollAllocation Allocation

	INNER JOIN #BudgetProject BudgetProject ON 
		Allocation.BudgetProjectId = BudgetProject.BudgetProjectId AND
		Allocation.ImportBatchId = BudgetProject.ImportBatchId

PRINT ''Completed inserting records into #EffectiveFunctionalDepartment: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE INDEX IX_EffectiveFunctionalDepartment_AllocId ON #EffectiveFunctionalDepartment (BudgetEmployeePayrollAllocationId)

PRINT ''Completed creating indexes on #EffectiveFunctionalDepartment''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

--Map Pre Tax Amounts
CREATE TABLE #ProfitabilityPreTaxSource
(
	ImportBatchId INT NOT NULL,
	BudgetReforecastTypeKey INT NOT NULL,
	ReforecastKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	BudgetId INT NOT NULL,
	BudgetRegionId INT NOT NULL,
	ProjectId INT NOT NULL,
	HrEmployeeId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	SalaryPreTaxAmount MONEY NOT NULL,
	ProfitSharePreTaxAmount MONEY NOT NULL,
	BonusPreTaxAmount MONEY NOT NULL,
	BonusCapExcessPreTaxAmount MONEY NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	FunctionalDepartmentCode VARCHAR(31) NULL,
	Reimbursable BIT NULL,
	ActivityTypeId INT NOT NULL,
	ActivityTypeCode Varchar(50) NOT NULL,
	PropertyFundId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode CHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	AllocationUpdatedDate DATETIME NOT NULL,
	BudgetReportGroupPeriod INT NOT NULL
)
-- Insert original budget amounts
-- links everything that we have pulled above (applying linking logic to tax, pre-tax and overhead data)
INSERT INTO #ProfitabilityPreTaxSource
(
	ImportBatchId,
	BudgetReforecastTypeKey,
	ReforecastKey,
	SnapshotId,
	BudgetId,
	BudgetRegionId,
	ProjectId,
	HrEmployeeId,
	BudgetEmployeePayrollAllocationId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	SalaryPreTaxAmount,
	ProfitSharePreTaxAmount,
	BonusPreTaxAmount,
	BonusCapExcessPreTaxAmount,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	ActivityTypeId,
	ActivityTypeCode,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	AllocationUpdatedDate,
	BudgetReportGroupPeriod
)
SELECT 
	Budget.ImportBatchId,
	@BudgetReforecastTypeKey,
	Budget.ReforecastKey,
	Budget.SnapshotId,
	Budget.BudgetId AS BudgetId,
	Budget.RegionId AS BudgetRegionId,
	ISNULL(BudgetProject.ProjectId,0) AS ProjectId,
	ISNULL(BudgetEmployee.HrEmployeeId,0) AS HrEmployeeId,
	Allocation.BudgetEmployeePayrollAllocationId,
	''TGB:BudgetId='' + CONVERT(varchar,Budget.BudgetId) + ''&ProjectId='' + CONVERT(varchar,ISNULL(BudgetProject.ProjectId,0)) + ''&HrEmployeeId='' + CONVERT(varchar,ISNULL(BudgetEmployee.HrEmployeeId,0)) + ''&BudgetEmployeePayrollAllocationId='' + CONVERT(varchar,Allocation.BudgetEmployeePayrollAllocationId) + ''&BudgetEmployeePayrollAllocationDetailId=0&BudgetOverheadAllocationDetailId=0'' + ''&ImportKey='' + CONVERT(varchar, Allocation.ImportKey) AS ReferenceCode,
	Allocation.Period AS ExpensePeriod,
	SourceRegion.SourceCode,
	ISNULL(Allocation.PreTaxSalaryAmount,0) AS SalaryPreTaxAmount,
	ISNULL(Allocation.PreTaxProfitShareAmount, 0) AS ProfitSharePreTaxAmount,
	ISNULL(Allocation.PreTaxBonusAmount,0) AS BonusPreTaxAmount, 
	ISNULL(Allocation.PreTaxBonusCapExcessAmount,0) AS BonusCapExcessPreTaxAmount,
	ISNULL(EFD.FunctionalDepartmentId, -1),
	fd.GlobalCode AS FunctionalDepartmentCode, 
	--CASE WHEN BudgetProject.IsTsCost = 0 THEN 1 ELSE 0 END AS Reimbursable, -- CC 4 :: GC
	CASE WHEN Dept.IsTsCost = 0 THEN 1 ELSE 0 END Reimbursable,
	BudgetProject.ActivityTypeId,
	Att.ActivityTypeCode,
	
	ISNULL(CASE
				WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN -- which property fund are we looking at 
					ProjectPropertyFund.PropertyFundId -- fall back
				ELSE -- else it is not @ or null, so use the mapping below (joining property fund from department to source)
					DepartmentPropertyFund.PropertyFundId 
			END, -1) AS PropertyFundId, -- else use -1, which is UNKNOWN
	
	ISNULL(CASE -- Same case logic as above
				WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,
		
	OriginatingRegion.CorporateEntityRef,
	OriginatingRegion.CorporateSourceCode,
	Budget.CurrencyCode AS LocalCurrencyCode,
	Allocation.UpdatedDate,
	Budget.BudgetReportGroupPeriod
	
FROM
	#BudgetEmployeePayrollAllocation Allocation -- tax amount

	INNER JOIN #BudgetProject BudgetProject ON 
		Allocation.BudgetProjectId = BudgetProject.BudgetProjectId AND
		Allocation.ImportBatchId = BudgetProject.ImportBatchId				
			
	INNER JOIN #Budget Budget ON 
		BudgetProject.BudgetId = Budget.BudgetId AND
		BudgetProject.ImportBatchId = Budget.ImportBatchId			
		
	LEFT OUTER JOIN #Region SourceRegion ON 
		Budget.RegionId = SourceRegion.RegionId

	LEFT OUTER JOIN #EffectiveFunctionalDepartment efd ON
		Allocation.BudgetEmployeePayrollAllocationId = efd.BudgetEmployeePayrollAllocationId

	LEFT OUTER JOIN Gdm.SnapshotFunctionalDepartment fd ON 
		efd.FunctionalDepartmentId = fd.FunctionalDepartmentId AND
		fd.SnapshotId = Budget.SnapshotId 

	LEFT OUTER JOIN Gdm.SnapshotPropertyFund ProjectPropertyFund ON
		BudgetProject.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		ProjectPropertyFund.SnapshotId = Budget.SnapshotId 
		
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON 
		GrSc.SourceCode = SourceRegion.SourceCode

	LEFT OUTER JOIN Gdm.SnapshotPropertyFundMapping pfm ON
		BudgetProject.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		BudgetProject.CorporateSourceCode = pfm.SourceCode AND
		pfm.SnapshotId = Budget.SnapshotId  AND
						
		pfm.IsDeleted = 0 AND 
		(
			(GrSc.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId = BudgetProject.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND BudgetProject.ActivityTypeId IS NULL)
			)
		) AND
		Budget.BudgetReportGroupPeriod < 201007	
	
	LEFT OUTER JOIN	Gdm.SnapshotReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		RECD.SourceCode = BudgetProject.CorporateSourceCode AND
		RECD.SnapshotId = Budget.SnapshotId AND
		Budget.BudgetReportGroupPeriod >= 201007 AND			   
		RECD.IsDeleted = 0 
				   
	LEFT OUTER JOIN Gdm.SnapshotReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		REPE.SourceCode = BudgetProject.CorporateSourceCode AND
		REPE.SnapshotId = Budget.SnapshotId  AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		REPE.IsDeleted = 0

	LEFT OUTER JOIN Gdm.SnapshotPropertyFund DepartmentPropertyFund ON -- property fund could be coming from multiple sources
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN Budget.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END AND
		DepartmentPropertyFund.SnapshotId = Budget.SnapshotId

	LEFT OUTER JOIN #BudgetEmployee BudgetEmployee ON
		Allocation.BudgetEmployeeId = BudgetEmployee.BudgetEmployeeId
		
	LEFT OUTER JOIN #Location Location ON 
		Location.LocationId = BudgetEmployee.LocationId
		
	LEFT OUTER JOIN Gdm.SnapshotPayrollRegion OriginatingRegion ON 
		Location.ExternalSubRegionId = OriginatingRegion.ExternalSubRegionId AND
		Budget.RegionId = OriginatingRegion.RegionId AND
		OriginatingRegion.SnapshotId = Budget.SnapshotId

	INNER JOIN GrReporting.dbo.ActivityType Att ON 
		Att.ActivityTypeId = BudgetProject.ActivityTypeId AND
		Att.SnapshotId = Budget.SnapshotId
		
	LEFT OUTER JOIN Gdm.SnapshotCorporateDepartment Dept ON
		Dept.Code = BudgetProject.CorporateDepartmentCode AND 
		Dept.SourceCode = SourceRegion.SourceCode AND
		Dept.SnapshotId = Budget.SnapshotId

WHERE
	Allocation.Period BETWEEN Budget.GroupStartPeriod AND Budget.GroupEndPeriod --AND
	--Change Control 1 : GC 2010-09-01
	--BudgetProject.ActivityTypeId <> 99 -- exclude Corporate Overhead

PRINT ''Completed inserting records into #ProfitabilityPreTaxSource: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE INDEX IX_SalaryPreTaxAmount ON #ProfitabilityPreTaxSource (SalaryPreTaxAmount)
CREATE INDEX IX_ProfitSharePreTaxAmount ON #ProfitabilityPreTaxSource (ProfitSharePreTaxAmount)
CREATE INDEX IX_BonusPreTaxAmount ON #ProfitabilityPreTaxSource (BonusPreTaxAmount)
CREATE INDEX IX_BonusCapExcessPreTaxAmount ON #ProfitabilityPreTaxSource (BonusCapExcessPreTaxAmount)
CREATE INDEX IX_ProfitabilityPreTaxSource5 ON #ProfitabilityPreTaxSource (BudgetEmployeePayrollAllocationId)

PRINT ''Completed creating indexes on #ProfitabilityPreTaxSource''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--Map Tax Amounts
SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityTaxSource
(
	ImportBatchId INT NOT NULL,
	BudgetReforecastTypeKey INT NOT NULL,
	ReforecastKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	BudgetId INT NOT NULL,
	BudgetRegionId INT NOT NULL,
	ProjectId INT NOT NULL,
	HrEmployeeId INT NOT NULL,
	BudgetEmployeePayrollAllocationId INT NOT NULL,
	BudgetEmployeePayrollAllocationDetailId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	SalaryTaxAmount MONEY NOT NULL,
	ProfitShareTaxAmount MONEY NOT NULL,
	BonusTaxAmount MONEY NOT NULL,
	BonusCapExcessTaxAmount MONEY NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	FunctionalDepartmentCode VARCHAR(31) NULL,
	Reimbursable BIT NULL,
	ActivityTypeId INT NOT NULL,
	ActivityTypeCode Varchar(50) NOT NULL,
	PropertyFundId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode CHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	AllocationUpdatedDate DATETIME NOT NULL,
	BudgetReportGroupPeriod INT NOT NULL	
)
-- Insert original budget amounts
INSERT INTO #ProfitabilityTaxSource
(
	ImportBatchId,
	BudgetReforecastTypeKey,
	ReforecastKey,
	SnapshotId,
	BudgetId,
	BudgetRegionId,
	ProjectId,
	HrEmployeeId,
	BudgetEmployeePayrollAllocationId,
	BudgetEmployeePayrollAllocationDetailId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	SalaryTaxAmount,
	ProfitShareTaxAmount,
	BonusTaxAmount,
	BonusCapExcessTaxAmount,
	MinorGlAccountCategoryId,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	ActivityTypeId,
	ActivityTypeCode,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	AllocationUpdatedDate,
	BudgetReportGroupPeriod
)
SELECT
	pts.ImportBatchId,
	pts.BudgetReforecastTypeKey,
	pts.ReforecastKey,
	pts.SnapshotId,
	pts.BudgetId,
	pts.BudgetRegionId,
	ISNULL(pts.ProjectId,0) AS ProjectId,
	ISNULL(pts.HrEmployeeId,0) AS HrEmployeeId,
	pts.BudgetEmployeePayrollAllocationId,
	TaxDetail.BudgetEmployeePayrollAllocationDetailId,
	''TGB:BudgetId='' + CONVERT(varchar,pts.BudgetId) + ''&ProjectId='' + CONVERT(varchar,ISNULL(pts.ProjectId,0)) + ''&HrEmployeeId='' + CONVERT(varchar,ISNULL(pts.HrEmployeeId,0)) + ''&BudgetEmployeePayrollAllocationId='' + CONVERT(varchar,pts.BudgetEmployeePayrollAllocationId) + ''&BudgetEmployeePayrollAllocationDetailId='' + CONVERT(varchar,TaxDetail.BudgetEmployeePayrollAllocationDetailId) + ''&BudgetOverheadAllocationDetailId=0'' + ''&ImportKey='' + CONVERT(varchar, TaxDetail.ImportKey) AS ReferenceCode,
	pts.ExpensePeriod,
	pts.SourceCode,
	ISNULL(TaxDetail.SalaryAmount, 0) AS SalaryTaxAmount,
	ISNULL(TaxDetail.ProfitShareAmount, 0) AS ProfitShareTaxAmount,
	ISNULL(TaxDetail.BonusAmount, 0) AS BonusTaxAmount,
	ISNULL(TaxDetail.BonusCapExcessAmount, 0) AS BonusCapExcessTaxAmount,
	TaxDetail.MinorGlAccountCategoryId,
	ISNULL(pts.FunctionalDepartmentId, -1),
	pts.FunctionalDepartmentCode, 
	pts.Reimbursable,
	pts.ActivityTypeId,
	pts.ActivityTypeCode,
	pts.PropertyFundId,
	pts.AllocationSubRegionGlobalRegionId,
	pts.OriginatingRegionCode,
	pts.OriginatingRegionSourceCode,
	pts.LocalCurrencyCode,
	pts.AllocationUpdatedDate,
	pts.BudgetReportGroupPeriod
FROM
	#EmployeePayrollAllocationDetail TaxDetail 

	INNER JOIN #ProfitabilityPreTaxSource pts ON -- pre tax has already been resolved, above, so join to limit taxdetail
		TaxDetail.BudgetEmployeePayrollAllocationId = pts.BudgetEmployeePayrollAllocationId


PRINT ''Completed inserting records into #ProfitabilityTaxSource: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE INDEX IX_ProfitabilityTaxSource1 ON #ProfitabilityTaxSource (SalaryTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource2 ON #ProfitabilityTaxSource  (ProfitShareTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource3 ON #ProfitabilityTaxSource  (BonusTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource4 ON #ProfitabilityTaxSource  (BonusCapExcessTaxAmount)
CREATE INDEX IX_ProfitabilityTaxSource5 ON #ProfitabilityTaxSource  (BudgetEmployeePayrollAllocationId)


PRINT ''Completed creating indexes on #ProfitabilityPreTaxSource''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



--Map Overhead Amounts
SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityOverheadSource
(
	ImportBatchId INT NOT NULL,
	BudgetReforecastTypeKey INT NOT NULL,
	ReforecastKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	BudgetId INT NOT NULL,
	ProjectId INT NOT NULL,
	HrEmployeeId INT NOT NULL,
	BudgetOverheadAllocationId INT NOT NULL,
	BudgetOverheadAllocationDetailId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	OverheadAllocationAmount MONEY NOT NULL,
	MinorGlAccountCategoryId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	FunctionalDepartmentCode VARCHAR(31) NULL,
	Reimbursable BIT NULL,
	ActivityTypeId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode CHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	OverheadUpdatedDate DATETIME NOT NULL
)
-- Insert original overhead amounts
INSERT INTO #ProfitabilityOverheadSource
(
	ImportBatchId,
	BudgetReforecastTypeKey,
	ReforecastKey,
	SnapshotId,
	BudgetId,
	ProjectId,
	HrEmployeeId,
	BudgetOverheadAllocationId,
	BudgetOverheadAllocationDetailId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	OverheadAllocationAmount,
	MinorGlAccountCategoryId,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	OverheadUpdatedDate
)
SELECT
	Budget.ImportBatchId,
	@BudgetReforecastTypeKey,
	Budget.ReforecastKey,
	Budget.SnapshotId,
	Budget.BudgetId AS BudgetId,
	ISNULL(BudgetProject.ProjectId,0) AS ProjectId,
	ISNULL(BudgetEmployee.HrEmployeeId,0) AS HrEmployeeId,
	OverheadDetail.BudgetOverheadAllocationId,
	OverheadDetail.BudgetOverheadAllocationDetailId,
	''TGB:BudgetId='' + CONVERT(varchar,Budget.BudgetId) + ''&ProjectId='' + CONVERT(varchar,ISNULL(BudgetProject.ProjectId,0)) + ''&HrEmployeeId='' + CONVERT(varchar,ISNULL(BudgetEmployee.HrEmployeeId,0)) + ''&BudgetEmployeePayrollAllocationId=0&BudgetEmployeePayrollAllocationDetailId=0'' + ''&BudgetOverheadAllocationDetailId='' + CONVERT(varchar,OverheadDetail.BudgetOverheadAllocationDetailId) + ''&ImportKey='' + CONVERT(varchar, OverheadDetail.ImportKey) AS ReferenceCode,
	OverheadAllocation.BudgetPeriod AS ExpensePeriod,
	SourceRegion.SourceCode,
	ISNULL(OverheadDetail.AllocationAmount,0) AS OverheadAllocationAmount,
	OverheadDetail.MinorGlAccountCategoryId,
	ISNULL(RegionExtended.OverheadFunctionalDepartmentId, -1) AS FunctionalDepartmentId,
	fd.GlobalCode AS FunctionalDepartmentCode,
	 
	CASE
		WHEN (BudgetProject.AllocateOverheadsProjectId IS NULL OR BudgetProject.AllocateOverheadsProjectId = 0) THEN 
			CASE
				WHEN (BudgetProject.IsTsCost = 0) THEN -- Where ISTSCost is False the cost will be reimbursable
					1
				ELSE
					0
			END
		ELSE
			0  --Where the BudgetProject.OverheadAllocationProjectID is populated: non-reimbursable
	END AS Reimbursable,
	
	BudgetProject.ActivityTypeId,
	
	CASE -- allocation region gets sourced from property fund, project region = allocation region
		WHEN (BudgetProject.AllocateOverheadsProjectId IS NULL OR BudgetProject.AllocateOverheadsProjectId = 0) THEN 
			ISNULL(CASE
						WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN 
							ProjectPropertyFund.PropertyFundId
						ELSE
							DepartmentPropertyFund.PropertyFundId 
				   END, -1) 
		ELSE
			ISNULL(OverheadPropertyFund.PropertyFundId, -1)
	END AS PropertyFundId,
	
	ISNULL(CASE -- Same case logic as above
				WHEN (BudgetProject.CorporateDepartmentCode = ''@'' OR BudgetProject.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,	
	
	OriginatingRegion.CorporateEntityRef,
	OriginatingRegion.CorporateSourceCode,
	Budget.CurrencyCode AS LocalCurrencyCode,
	OverheadDetail.UpdatedDate

FROM
	#BudgetOverheadAllocation OverheadAllocation 

	INNER JOIN #BudgetEmployee BudgetEmployee ON
		OverheadAllocation.BudgetEmployeeId = BudgetEmployee.BudgetEmployeeId

	INNER JOIN #OverheadAllocationDetail OverheadDetail ON -- where overhead amount sits
		OverheadAllocation.BudgetOverheadAllocationId = OverheadDetail.BudgetOverheadAllocationId
			
	INNER JOIN #BudgetProject BudgetProject ON 
		OverheadDetail.BudgetProjectId = BudgetProject.BudgetProjectId
		
	INNER JOIN #Budget Budget ON 
		BudgetProject.BudgetId = Budget.BudgetId AND
		BudgetProject.ImportBatchId = Budget.ImportBatchId		
		
	LEFT OUTER JOIN #Region SourceRegion ON 
		Budget.RegionId = SourceRegion.RegionId
		
	LEFT OUTER JOIN #RegionExtended RegionExtended ON 
		SourceRegion.RegionId = RegionExtended.RegionId

	LEFT OUTER JOIN Gdm.SnapshotFunctionalDepartment fd ON
		RegionExtended.OverheadFunctionalDepartmentId = fd.FunctionalDepartmentId AND
		fd.SnapshotId = Budget.SnapshotId 

	LEFT OUTER JOIN	#Project OverheadProject ON
		BudgetProject.AllocateOverheadsProjectId = OverheadProject.ProjectId

	LEFT OUTER JOIN Gdm.SnapshotPropertyFund ProjectPropertyFund ON
		BudgetProject.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		ProjectPropertyFund.SnapshotId = Budget.SnapshotId 
	
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrScC ON
		GrScC.SourceCode = BudgetProject.CorporateSourceCode

	LEFT OUTER JOIN Gdm.SnapshotPropertyFundMapping pfm ON
		BudgetProject.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		BudgetProject.CorporateSourceCode = pfm.SourceCode AND
		pfm.SnapshotId = Budget.SnapshotId AND
		
		pfm.IsDeleted = 0 AND 
		(
			(GrScC.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrScC.IsCorporate = ''YES'' AND pfm.ActivityTypeId = BudgetProject.ActivityTypeId)
				OR
				(GrScC.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND BudgetProject.ActivityTypeId IS NULL)
			)
		) AND
		Budget.BudgetReportGroupPeriod < 201007
	
	LEFT OUTER JOIN	Gdm.SnapshotReportingEntityCorporateDepartment RECDC ON
		GrScC.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECDC.CorporateDepartmentCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		RECDC.SourceCode = BudgetProject.CorporateSourceCode AND
		RECDC.SnapshotId = Budget.SnapshotId AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		RECDC.IsDeleted = 0
		   
	LEFT OUTER JOIN Gdm.SnapshotReportingEntityPropertyEntity REPEC ON
		GrScC.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPEC.PropertyEntityCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		REPEC.SourceCode = BudgetProject.CorporateSourceCode AND
		REPEC.SnapshotId = Budget.SnapshotId  AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		REPEC.IsDeleted = 0	
	
	LEFT OUTER JOIN Gdm.SnapshotPropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN Budget.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrScC.IsCorporate = ''YES'' THEN RECDC.PropertyFundId
						ELSE REPEC.PropertyFundId
					END
			END AND
		DepartmentPropertyFund.SnapshotId = Budget.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.[Source] GrScO ON
		GrScO.SourceCode = OverheadProject.CorporateSourceCode

	LEFT OUTER JOIN Gdm.SnapshotPropertyFundMapping opfm ON
		OverheadProject.CorporateDepartmentCode = opfm.PropertyFundCode AND -- Combination of entity and corporate department
		OverheadProject.CorporateSourceCode = opfm.SourceCode AND
		opfm.SnapshotId = Budget.SnapshotId AND
		
		opfm.IsDeleted = 0 AND 
		(
			(GrScO.IsProperty = ''YES'' AND opfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrScO.IsCorporate = ''YES'' AND opfm.ActivityTypeId = BudgetProject.ActivityTypeId)
				OR
				(GrScO.IsCorporate = ''YES'' AND opfm.ActivityTypeId IS NULL AND BudgetProject.ActivityTypeId IS NULL)
			)
		) AND
		Budget.BudgetReportGroupPeriod < 201007

	LEFT OUTER JOIN	Gdm.SnapshotReportingEntityCorporateDepartment RECDO ON
		GrScO.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECDO.CorporateDepartmentCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		RECDO.SourceCode = BudgetProject.CorporateSourceCode AND
		RECDO.SnapshotId = Budget.SnapshotId AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		RECDO.IsDeleted = 0
		   
	LEFT OUTER JOIN Gdm.SnapshotReportingEntityPropertyEntity REPEO ON
		GrScO.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPEO.PropertyEntityCode = LTRIM(RTRIM(BudgetProject.CorporateDepartmentCode)) AND
		REPEO.SourceCode = BudgetProject.CorporateSourceCode AND
		REPEO.SnapshotId = Budget.SnapshotId AND
		Budget.BudgetReportGroupPeriod >= 201007 AND
		REPEO.IsDeleted = 0	

	LEFT OUTER JOIN Gdm.SnapshotPropertyFund OverheadPropertyFund ON
		OverheadPropertyFund.PropertyFundId =
			CASE
				WHEN Budget.BudgetReportGroupPeriod < 201007 THEN opfm.PropertyFundId
				ELSE
					CASE
						WHEN GrScO.IsCorporate = ''YES'' THEN RECDO.PropertyFundId
						ELSE REPEO.PropertyFundId
					END
			END AND
		OverheadPropertyFund.SnapshotId = Budget.SnapshotId

	LEFT OUTER JOIN Gdm.SnapshotOverheadRegion OriginatingRegion ON 
		OverheadAllocation.OverheadRegionId = OriginatingRegion.OverheadRegionId AND
		OriginatingRegion.SnapshotId = Budget.SnapshotId
		
WHERE
	OverheadAllocation.BudgetPeriod BETWEEN Budget.GroupStartPeriod AND Budget.GroupEndPeriod
		
PRINT ''Completed inserting records into #ProfitabilityOverheadSource: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE INDEX IX_ProfitabilityOverheadSource1 ON #ProfitabilityOverheadSource (OverheadAllocationAmount)

PRINT ''Completed creating indexes on #ProfitabilityOverheadSource''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Generate mapping records
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

SET @StartTime = GETDATE()


CREATE TABLE #ProfitabilityPayrollMapping
(
	ImportBatchId INT NOT NULL,
	BudgetReforecastTypeKey INT NOT NULL,
	ReforecastKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	BudgetId int NOT NULL,
	ReferenceCode varchar(300) NOT NULL,
	ExpensePeriod char(6) NOT NULL,	
	SourceCode varchar(2) NULL,
	BudgetAmount money NOT NULL,
	MajorGlAccountCategoryId int NOT NULL,
	MinorGlAccountCategoryId int NOT NULL,
	FunctionalDepartmentId int NOT NULL,
	FunctionalDepartmentCode varchar(31) NULL,
	Reimbursable bit NOT NULL,
	FeeOrExpense  Varchar(20) NOT NULL,
	ActivityTypeId int NOT NULL,
	PropertyFundId int NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	OriginatingRegionCode char(6) NULL,
	OriginatingRegionSourceCode varchar(2) NULL,
	LocalCurrencyCode char(3) NOT NULL,
	AllocationUpdatedDate datetime NOT NULL,
	GLAccountSubTypeIdGlobal INT NOT NULL,
	GlobalGlAccountCode Varchar(10) NULL	
)

;WITH CTE_GetGLAccountOverheadSubIds
AS
(
	SELECT 
		  GLAccountSubTypeId,
		  BudgetId
	FROM
		#GLAccountSubTypeIdBudgetMappings 
	WHERE
		IsOverhead = 1
),
CTE_GetGLAccountPayrollSubIds
AS
(
	SELECT 
		  GLAccountSubTypeId,
		  BudgetId
	FROM
		#GLAccountSubTypeIdBudgetMappings 
	WHERE
		IsPayroll = 1
)

INSERT INTO #ProfitabilityPayrollMapping
(
	ImportBatchId,
	BudgetReforecastTypeKey,
	ReforecastKey,
	SnapshotId,
	BudgetId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	BudgetAmount,
	MajorGlAccountCategoryId,
	MinorGlAccountCategoryId,
	FunctionalDepartmentId,
	FunctionalDepartmentCode,
	Reimbursable,
	FeeOrExpense,
	ActivityTypeId,
	PropertyFundId,
	
	AllocationSubRegionGlobalRegionId,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	LocalCurrencyCode,
	AllocationUpdatedDate,
	GLAccountSubTypeIdGlobal,
	GlobalGlAccountCode
)
-- Get Base Salary Payroll pre tax mappings and budget
SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=SalaryPreTax'' AS ReferenceCode,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.SalaryPreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	@BaseSalaryMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''SalaryPreTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId from CTE_GetGLAccountOverheadSubIds CTE_SIDO WHERE CTE_SIDO.BudgetId = pps.BudgetId)
		ELSE  (Select GLAccountSubTypeId From CTE_GetGLAccountPayrollSubIds CTE_SIDP WHERE CTE_SIDP.BudgetId = pps.BudgetId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps -- pull all pre-tax amounts that are not zero
WHERE
	pps.SalaryPreTaxAmount <> 0

-- Get Profit Share Benefit pre tax mappings and budget
UNION ALL

SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=ProfitSharePreTax'' AS ReferenceCod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.ProfitSharePreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	@ProfitShareMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''ProfitSharePreTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pps.SnapshotId)
		ELSE (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsPayroll = 1 AND SnapshotId = pps.SnapshotId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps
	INNER JOIN GrReporting.dbo.ActivityType Att ON 
		Att.ActivityTypeId = pps.ActivityTypeId AND
		Att.SnapshotId = pps.SnapshotId
WHERE
	pps.ProfitSharePreTaxAmount <> 0

-- Get Bonus pre tax mappings and budget
UNION ALL

SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusPreTax'' AS ReferenceCod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusPreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	@BonusMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''BonusPreTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pps.SnapshotId)
		ELSE (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsPayroll = 1 AND SnapshotId = pps.SnapshotId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps
	INNER JOIN GrReporting.dbo.ActivityType Att ON 
		Att.ActivityTypeId = pps.ActivityTypeId AND
		Att.SnapshotId = pps.SnapshotId
WHERE
	pps.BonusPreTaxAmount <> 0

--Get bonus cap pre tax mappings
UNION ALL

SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusCapExcessPreTax'' AS ReferenceCod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusCapExcessPreTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	@BonusMinorGlAccountCategoryId AS MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	0 AS Reimbursable, -- Always Non-reimbursable for bunus cap amounts 
	''BonusCapExcessPreTax'' FeeOrExpense,
	ISNULL(p.ActivityTypeId, -1) AS ActivityTypeId,
	
	ISNULL(CASE
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN -- settings logic for bonus cap, override property fund
					ProjectPropertyFund.PropertyFundId
				ELSE 
					DepartmentPropertyFund.PropertyFundId 
		   END, -1) AS PropertyFundId,

	ISNULL(CASE -- Same case logic as above
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,

	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pps.SnapshotId)
		ELSE (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsPayroll = 1 AND SnapshotId = pps.SnapshotId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityPreTaxSource pps	

	INNER JOIN GrReporting.dbo.ActivityType Att ON 
		Att.ActivityTypeId = pps.ActivityTypeId AND
		Att.SnapshotId = pps.SnapshotId
	
	LEFT OUTER JOIN #SystemSettingRegion ssr ON
		pps.SourceCode = ssr.SourceCode AND
		pps.BudgetRegionId = ssr.RegionId AND
		ssr.SystemSettingName = ''BonusCapExcess''
		
	LEFT OUTER JOIN #Project p ON
		ssr.BonusCapExcessProjectId = p.ProjectId
			
	LEFT OUTER JOIN Gdm.SnapshotPropertyFund ProjectPropertyFund ON
		p.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		ProjectPropertyFund.SnapshotId = pps.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON
		GrSc.SourceCode = pps.SourceCode
		
	LEFT OUTER JOIN Gdm.SnapshotPropertyFundMapping pfm ON
		p.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		p.CorporateSourceCode = pfm.SourceCode AND
		pfm.SnapshotId = pps.SnapshotId AND
		--This is a bypass for the ''NULL'' scenario, for only CORP have ActivityTypeId''s set
		ISNULL(p.ActivityTypeId, -1) = ISNULL(pfm.ActivityTypeId, -1) AND --This is a bypass for the ''NULL'' scenario, for only CORP have ActivityTypeId''s set
		pfm.IsDeleted = 0 AND 
		(
			(GrSc.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId = p.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND p.ActivityTypeId IS NULL)
			)
		) AND
		pps.BudgetReportGroupPeriod < 201007
	
	LEFT OUTER JOIN	Gdm.SnapshotReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		RECD.SourceCode = p.CorporateSourceCode AND
		RECD.SnapshotId = pps.SnapshotId AND
		pps.BudgetReportGroupPeriod >= 201007 AND			   
		RECD.IsDeleted = 0
		   
	LEFT OUTER JOIN Gdm.SnapshotReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		REPE.SourceCode = p.CorporateSourceCode AND
		REPE.SnapshotId = pps.SnapshotId AND
		pps.BudgetReportGroupPeriod >= 201007 AND
		REPE.IsDeleted = 0	
	
	LEFT OUTER JOIN Gdm.SnapshotPropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN pps.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END AND
		DepartmentPropertyFund.SnapshotId = pps.SnapshotId
		
WHERE
	pps.BonusCapExcessPreTaxAmount <> 0

UNION ALL

-- Get Base Salary Payroll Tax mappings and budget
SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=SalaryTax'' AS ReferenceCod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.SalaryTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''SalaryTaxTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pps.SnapshotId)
		ELSE (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsPayroll = 1 AND SnapshotId = pps.SnapshotId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps
	INNER JOIN GrReporting.dbo.ActivityType Att ON 
		Att.ActivityTypeId = pps.ActivityTypeId AND
		Att.SnapshotId = pps.SnapshotId
WHERE
	pps.SalaryTaxAmount <> 0

-- Get Profit Share Benefit Tax mappings and budget
UNION ALL

SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=ProfitShareTax'' AS ReferenceCod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.ProfitShareTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''ProfitShareTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pps.SnapshotId)
		ELSE (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsPayroll = 1 AND SnapshotId = pps.SnapshotId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps
	INNER JOIN GrReporting.dbo.ActivityType Att ON 
		Att.ActivityTypeId = pps.ActivityTypeId AND
		Att.SnapshotId = pps.SnapshotId
WHERE
	pps.ProfitShareTaxAmount <> 0

-- Get Bonus Tax mappings and budget
UNION ALL

SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusTax'' AS ReferenceCod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	pps.Reimbursable,  
	''BonusTax'' FeeOrExpense,
	pps.ActivityTypeId,
	pps.PropertyFundId,
	pps.AllocationSubRegionGlobalRegionId,
	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pps.SnapshotId)
		ELSE (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsPayroll = 1 AND SnapshotId = pps.SnapshotId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps
WHERE
	pps.BonusTaxAmount <> 0

-- Get Bonus cap Tax mappings 
UNION ALL

SELECT
	pps.ImportBatchId,
	pps.BudgetReforecastTypeKey,
	pps.ReforecastKey,
	pps.SnapshotId,
	pps.BudgetId,
	pps.ReferenceCode + ''&Type=BonusCapExcessTax'' AS ReferenceCod,
	pps.ExpensePeriod,
	pps.SourceCode,
	pps.BonusCapExcessTaxAmount AS BudgetAmount,
	@SalariesTaxesBenefitsGLMajorCategoryId AS MinorGlAccountCategoryId,
	pps.MinorGlAccountCategoryId, 
	pps.FunctionalDepartmentId,
	pps.FunctionalDepartmentCode,
	0 AS Reimbursable, -- Always Non-reimbursable for bunus cap amounts 
	''BonusCapExcessTax'' FeeOrExpense,
	ISNULL(p.ActivityTypeId, -1) AS ActivityTypeId,
	
	ISNULL(CASE
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.PropertyFundId
				ELSE 
					DepartmentPropertyFund.PropertyFundId 
		   END, -1) AS PropertyFundId,
		   
	ISNULL(CASE -- Same case logic as above
				WHEN (p.CorporateDepartmentCode = ''@'' OR p.CorporateDepartmentCode IS NULL) THEN 
					ProjectPropertyFund.AllocationSubRegionGlobalRegionId
				ELSE 
					DepartmentPropertyFund.AllocationSubRegionGlobalRegionId
			END, -1) AS AllocationSubRegionGlobalRegionId,		   

	pps.OriginatingRegionCode,
	pps.OriginatingRegionSourceCode,
	pps.LocalCurrencyCode,
	pps.AllocationUpdatedDate,
	--GC :: Change Control 1
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' 
		THEN (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pps.SnapshotId)
		ELSE (SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsPayroll = 1 AND SnapshotId = pps.SnapshotId)
		END GLAccountSubTypeId,
	--General Allocated Overhead Account :: CC8
	CASE WHEN pps.ActivityTypeCode = ''CORPOH'' THEN
		''50029500''+RIGHT(''0''+LTRIM(STR(pps.ActivityTypeId,3,0)),2)
	ELSE
		NULL
	END as GlobalGlAccountCode
FROM
	#ProfitabilityTaxSource pps	
		
	LEFT OUTER JOIN #SystemSettingRegion ssr ON
		pps.SourceCode = ssr.SourceCode AND
		pps.BudgetRegionId = ssr.RegionId AND
		ssr.SystemSettingName = ''BonusCapExcess''

	LEFT OUTER JOIN #Project p ON
		ssr.BonusCapExcessProjectId = p.ProjectId

	LEFT OUTER JOIN Gdm.SnapshotPropertyFund ProjectPropertyFund ON
		p.PropertyFundId = ProjectPropertyFund.PropertyFundId AND
		ProjectPropertyFund.SnapshotId = pps.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.Source GrSc ON 
		GrSc.SourceCode = pps.SourceCode

	LEFT OUTER JOIN Gdm.SnapshotPropertyFundMapping pfm ON
		p.CorporateDepartmentCode = pfm.PropertyFundCode AND -- Combination of entity and corporate department
		p.CorporateSourceCode = pfm.SourceCode AND
		pfm.SnapshotId = pps.SnapshotId AND
		pfm.IsDeleted = 0 AND 
		(
			(GrSc.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId = p.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND p.ActivityTypeId IS NULL)
			)
		) AND
		pps.BudgetReportGroupPeriod < 201007
	
	LEFT OUTER JOIN	Gdm.SnapshotReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		RECD.SourceCode = p.CorporateSourceCode AND
		RECD.SnapshotId = pps.SnapshotId AND
		pps.BudgetReportGroupPeriod >= 201007 AND			   
		RECD.IsDeleted = 0
		   
	LEFT OUTER JOIN Gdm.SnapshotReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(p.CorporateDepartmentCode)) AND
		REPE.SourceCode = p.CorporateSourceCode AND
		REPE.SnapshotId = pps.SnapshotId AND
		pps.BudgetReportGroupPeriod >= 201007 AND
		REPE.IsDeleted = 0		
	
	LEFT OUTER JOIN Gdm.SnapshotPropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN pps.BudgetReportGroupPeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END AND
		DepartmentPropertyFund.SnapshotId = pps.SnapshotId

WHERE
	pps.BonusCapExcessTaxAmount <> 0
	
-- Get Overhead mappings	
UNION ALL

SELECT
	pos.ImportBatchId,
	pos.BudgetReforecastTypeKey,
	pos.ReforecastKey,
	pos.SnapshotId,
	pos.BudgetId,
	pos.ReferenceCode + ''&Type=OverheadAllocation'' AS ReferenceCode,
	pos.ExpensePeriod,
	pos.SourceCode,
	pos.OverheadAllocationAmount AS BudgetAmount,
	@OccupancyCostsMajorGlAccountCategoryId AS MinorGlAccountCategoryId,
	pos.MinorGlAccountCategoryId, 
	pos.FunctionalDepartmentId,
	pos.FunctionalDepartmentCode,
	pos.Reimbursable,  
	''Overhead'' FeeOrExpense,
	pos.ActivityTypeId,
	pos.PropertyFundId,
	pos.AllocationSubRegionGlobalRegionId,
	pos.OriginatingRegionCode,
	pos.OriginatingRegionSourceCode,
	pos.LocalCurrencyCode,
	pos.OverheadUpdatedDate,
	(SELECT GLAccountSubTypeId FROM #GLAccountCategoryTranslations WHERE IsOverhead = 1 AND SnapshotId = pos.SnapshotId),
	--General Allocated Overhead Account :: CC8
	''50029500''+RIGHT(''0''+LTRIM(STR(pos.ActivityTypeId,3,0)),2)
FROM
	#ProfitabilityOverheadSource pos
WHERE
	pos.OverheadAllocationAmount <> 0


PRINT ''Completed inserting records into #ProfitabilityPayrollMapping: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE CLUSTERED INDEX IX_AllocationUpdatedDate ON #ProfitabilityPayrollMapping(ReferenceCode,AllocationUpdatedDate)
PRINT ''Completed creating indexes on #ProfitabilityPayrollMapping''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Map mapped source data into the "REAL" fact table
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
------------------------------------------------------------------------------------------------------
-- Map to the fact
------------------------------------------------------------------------------------------------------
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--If the join is not possible, default the link to the ''UNKNOWN'' link
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityBudget(
	ImportBatchId INT NOT NULL,
	BudgetReforecastTypeKey INT NOT NULL,
	ReforecastKey INT NOT NULL,
	CalendarKey int NOT NULL,
	GlAccountKey int NOT NULL,
	SourceKey int NOT NULL,
	FunctionalDepartmentKey int NOT NULL,
	ReimbursableKey int NOT NULL,
	ActivityTypeKey int NOT NULL,
	PropertyFundKey int NOT NULL,	
	AllocationRegionKey int NOT NULL,
	OriginatingRegionKey int NOT NULL,
	OverheadKey int NOT NULL,
	LocalCurrencyKey int NOT NULL,
	LocalBudget money NOT NULL,
	ReferenceCode Varchar(300) NOT NULL,
	BudgetId int NOT NULL,
	
	EUCorporateGlAccountCategoryKey int NULL,
	EUPropertyGlAccountCategoryKey int NULL,
	EUFundGlAccountCategoryKey int NULL,

	USPropertyGlAccountCategoryKey int NULL,
	USCorporateGlAccountCategoryKey int NULL,
	USFundGlAccountCategoryKey int NULL,

	GlobalGlAccountCategoryKey int NULL,
	DevelopmentGlAccountCategoryKey int NULL,
	SnapshotId INT NOT NULL
) 

INSERT INTO #ProfitabilityBudget 
(
	ImportBatchId, 
	BudgetReforecastTypeKey,
	ReforecastKey,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	BudgetId,
	SnapshotId
)
SELECT
	pbm.ImportBatchId,
	pbm.BudgetReforecastTypeKey,
	pbm.ReforecastKey,
	DATEDIFF(dd, ''1900-01-01'', LEFT(pbm.ExpensePeriod,4)+''-''+RIGHT(pbm.ExpensePeriod,2)+''-01'') AS CalendarKey,
	CASE WHEN GrGa.GlAccountKey IS NULL THEN @GlAccountKey ELSE GrGa.GlAccountKey END GlAccountKey,
	CASE WHEN GrSc.[SourceKey] IS NULL THEN @SourceKey ELSE GrSc.[SourceKey] END SourceKey,
	CASE WHEN GrFdm.[FunctionalDepartmentKey] IS NULL THEN @FunctionalDepartmentKey ELSE GrFdm.[FunctionalDepartmentKey] END FunctionalDepartmentKey,
	CASE WHEN GrRi.ReimbursableCode IS NULL THEN @ReimbursableKey ELSE GrRi.ReimbursableKey END ReimbursableKey,
	CASE WHEN GrAt.[ActivityTypeKey] IS NULL THEN @ActivityTypeKey ELSE GrAt.[ActivityTypeKey] END ActivityTypeKey,
	CASE WHEN GrPf.[PropertyFundKey] IS NULL THEN @PropertyFundKey ELSE GrPf.[PropertyFundKey] END PropertyFundKey,
	CASE WHEN GrAr.[AllocationRegionKey] IS NULL THEN @AllocationRegionKey ELSE GrAr.[AllocationRegionKey] END AllocationRegionKey,
	CASE WHEN GrOr.[OriginatingRegionKey] IS NULL THEN @OriginatingRegionKey ELSE GrOr.[OriginatingRegionKey] END OriginatingRegionKey,
	CASE WHEN GrOh.[OverheadKey] IS NULL THEN @OverheadKey ELSE GrOh.[OverheadKey] END OverheadKey,
	CASE WHEN GrCu.[CurrencyKey] IS NULL THEN @LocalCurrencyKey ELSE GrCu.[CurrencyKey] END LocalCurrencyKey,
	pbm.BudgetAmount,
	pbm.ReferenceCode,
	pbm.BudgetId,
	pbm.SnapshotId
FROM
	#ProfitabilityPayrollMapping pbm
	
	LEFT OUTER JOIN GrReporting.dbo.Source GrSc ON
		GrSc.SourceCode = pbm.SourceCode

	LEFT OUTER JOIN GrReporting.dbo.GlAccount GrGa ON
		GrGa.Code = pbm.GlobalGlAccountCode AND --Gam.GlobalGlAccountId AND
		--pbm.AllocationUpdatedDate BETWEEN GrGa.StartDate AND GrGa.EndDate AND
		GrGa.SnapshotId = pbm.SnapshotId
		
	--Parent Level (No job code for payroll)
	LEFT OUTER JOIN GrReporting.dbo.FunctionalDepartment GrFdm ON
		pbm.AllocationUpdatedDate BETWEEN GrFdm.StartDate AND GrFdm.EndDate AND
		GrFdm.SubFunctionalDepartmentCode = GrFdm.FunctionalDepartmentCode AND
		--GrFdm.ReferenceCode LIKE pbm.FunctionalDepartmentCode +'':%'' AND --replaced by new logic below
		GrFdm.FunctionalDepartmentCode = pbm.FunctionalDepartmentCode
		
	LEFT OUTER JOIN GrReporting.dbo.Reimbursable GrRi ON
		CASE WHEN pbm.Reimbursable = 1 THEN ''YES'' ELSE ''NO'' END = GrRi.ReimbursableCode

	LEFT OUTER JOIN GrReporting.dbo.ActivityType GrAt ON
		pbm.ActivityTypeId = GrAt.ActivityTypeId AND
		--pbm.AllocationUpdatedDate BETWEEN GrAt.StartDate AND GrAt.EndDate AND
		GrAt.SnapshotId = pbm.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.Overhead GrOh ON
		--GC :: Change Control 1
		GrOh.OverheadCode = CASE WHEN pbm.FeeOrExpense = ''Overhead'' THEN ''ALLOC'' 
									WHEN GrAt.ActivityTypeCode = ''CORPOH'' THEN ''UNALLOC'' 
									ELSE ''UNKNOWN'' END

	LEFT OUTER JOIN GrReporting.dbo.PropertyFund GrPf ON
		pbm.PropertyFundId = GrPf.PropertyFundId AND
		--pbm.AllocationUpdatedDate BETWEEN GrPf.StartDate AND GrPf.EndDate AND
		GrPf.SnapshotId = pbm.SnapshotId

	LEFT OUTER JOIN Gdm.SnapshotAllocationSubRegion ASR ON
		pbm.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId AND
		ASR.SnapshotId = pbm.SnapshotId 

	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion GrAr ON
		ASR.AllocationSubRegionGlobalRegionId = GrAr.GlobalRegionId AND
		--pbm.AllocationUpdatedDate BETWEEN GrAr.StartDate AND GrAr.EndDate AND
		GrAr.SnapshotId = pbm.SnapshotId

	LEFT OUTER JOIN Gdm.SnapshotOriginatingRegionCorporateEntity ORCE ON
		ORCE.CorporateEntityCode = pbm.OriginatingRegionCode AND
		ORCE.SourceCode = pbm.OriginatingRegionSourceCode AND 
		ORCE.SnapshotId = pbm.SnapshotId AND
		ORCE.IsDeleted = 0
		   
	LEFT OUTER JOIN Gdm.SnapshotOriginatingRegionPropertyDepartment ORPD ON
		ORPD.PropertyDepartmentCode = pbm.OriginatingRegionCode AND
		ORPD.SourceCode = pbm.OriginatingRegionSourceCode AND
		ORPD.SnapshotId = pbm.SnapshotId AND
		ORPD.IsDeleted = 0		
		
	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion GrOr ON
		GrOr.GlobalRegionId = ISNULL(ORCE.GlobalRegionId, ORPD.GlobalRegionId) AND
		--pbm.AllocationUpdatedDate BETWEEN GrOr.StartDate AND GrOr.EndDate AND
		GrOr.SnapshotId = pbm.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.Currency GrCu ON
		pbm.LocalCurrencyCode = GrCu.CurrencyCode

PRINT ''Completed inserting records into #ProfitabilityBudget: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #ProfitabilityBudget (ReferenceCode)
CREATE INDEX IX_CalendarKey ON #ProfitabilityBudget (CalendarKey)

PRINT ''Completed creating indexes on #OriginatingRegionMapping''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

------------------------------------------------------------------------------------------------------
-- Map account categories
------------------------------------------------------------------------------------------------------

--GlobalGlAccountCategoryKey
SET @StartTime = GETDATE()

CREATE TABLE #GlobalCategoryLookup(
	GlAccountCategoryKey INT NULL,
	ReferenceCode VARCHAR(300) NOT NULL
)

INSERT INTO #GlobalCategoryLookup(
	GlAccountCategoryKey,
	ReferenceCode
)

SELECT 
	GlAcGlobal.GlAccountCategoryKey,
	Gl.ReferenceCode
FROM
	(
		SELECT 
			ACT.GLTranslationTypeId,
			ACT.GLTranslationSubTypeId,
			Gl.MajorGlAccountCategoryId GLMajorCategoryId,
			Gl.MinorGlAccountCategoryId GLMinorCategoryId,
			ACT.GLAccountTypeId,
			ACT.GLAccountSubTypeId,
			Gl.AllocationUpdatedDate,
			Gl.ReferenceCode,
			Gl.SnapshotId
		 FROM	
			#ProfitabilityPayrollMapping Gl				
			LEFT OUTER JOIN #GLAccountCategoryTranslations ACT ON 
				ACT.GLAccountSubTypeId = Gl.GLAccountSubTypeIdGlobal AND
				ACT.SnapshotId = Gl.SnapshotId
		) Gl
															
		LEFT OUTER JOIN GrReporting.dbo.GlAccountCategory GlAcGlobal ON GlAcGlobal.GlobalGlAccountCategoryCode = 
			CONVERT(VARCHAR(32), LTRIM(STR(Gl.GLTranslationTypeId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLTranslationSubTypeId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLMajorCategoryId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLMinorCategoryId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLAccountTypeId, 10, 0)) + '':'' + 
								 LTRIM(STR(Gl.GLAccountSubTypeId, 10, 0))) AND
			--AND Gl.AllocationUpdatedDate  BETWEEN GlAcGlobal.StartDate AND GlAcGlobal.EndDate AND
			GlAcGlobal.SnapshotId = Gl.SnapshotId

PRINT ''Completed inserting records into #GlobalCategoryLookup: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX ON #GlobalCategoryLookup (ReferenceCode)

PRINT ''Completed creating indexes on #GlobalCategoryLookup''
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


SET @StartTime = GETDATE()

UPDATE
	#ProfitabilityBudget
SET
	GlobalGlAccountCategoryKey = CASE WHEN t1.GlAccountCategoryKey IS NULL THEN @GlobalGlAccountCategoryKeyUnknown ELSE t1.GlAccountCategoryKey END
FROM
	#GlobalCategoryLookup t1
WHERE
	t1.ReferenceCode = #ProfitabilityBudget.ReferenceCode



PRINT ''Completed converting all GlobalGlAccountCategoryKey keys: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


--=========================================================================================================================================
-- REGISTER UNKNOWNS
--=========================================================================================================================================
/****** Stash unknowns and remove budget groups from import ******/
SET @StartTime = GETDATE()

DELETE [dbo].[ProfitabilityBudgetUnknowns]
WHERE BudgetReforecastTypeKey IN (@BudgetReforecastTypeKey)

INSERT INTO [dbo].[ProfitabilityBudgetUnknowns]
(
   [ImportBatchId]
   ,[CalendarKey]
   ,[GlAccountKey]
   ,[SourceKey]
   ,[FunctionalDepartmentKey]
   ,[ReimbursableKey]
   ,[ActivityTypeKey]
   ,[PropertyFundKey]
   ,[AllocationRegionKey]
   ,[OriginatingRegionKey]
   ,[LocalCurrencyKey]
   ,[LocalBudget]
   ,[ReferenceCode]
   ,[EUCorporateGlAccountCategoryKey]
   ,[USPropertyGlAccountCategoryKey]
   ,[USFundGlAccountCategoryKey]
   ,[EUPropertyGlAccountCategoryKey]
   ,[USCorporateGlAccountCategoryKey]
   ,[DevelopmentGlAccountCategoryKey]
   ,[EUFundGlAccountCategoryKey]
   ,[GlobalGlAccountCategoryKey]
   ,[BudgetId]
   ,[OverheadKey]
   ,FeeAdjustmentKey,
	BudgetReforecastTypeKey,
	SnapshotId
   )
SELECT
	b.ImportBatchId,
	pb.CalendarKey,
	pb.GlAccountKey,
	pb.SourceKey,
	pb.FunctionalDepartmentKey,
	pb.ReimbursableKey,
	pb.ActivityTypeKey,
	pb.PropertyFundKey,
	pb.AllocationRegionKey,
	pb.OriginatingRegionKey,
	pb.LocalCurrencyKey,
	pb.LocalBudget,
	pb.ReferenceCode,
	@EUCorporateGlAccountCategoryKeyUnknown,
	@USPropertyGlAccountCategoryKeyUnknown,	
	@USFundGlAccountCategoryKeyUnknown, 	
	@EUPropertyGlAccountCategoryKeyUnknown,
	@USCorporateGlAccountCategoryKeyUnknown, 
	@DevelopmentGlAccountCategoryKeyUnknown,
	@EUFundGlAccountCategoryKeyUnknown, 
	pb.GlobalGlAccountCategoryKey,	
	pb.BudgetId,
	pb.OverheadKey,
	(Select FeeAdjustmentKey From GrReporting.dbo.FeeAdjustment Where FeeAdjustmentCode = ''NORMAL'') AS FeeAdjustmentKey,	
	BudgetReforecastTypeKey,
	pb.SnapshotId	
	
FROM 
	#ProfitabilityBudget pb
	INNER JOIN #Budget b ON
		pb.BudgetId = b.BudgetId	
WHERE	
	@SourceKey = pb.SourceKey OR
	@FunctionalDepartmentKey = pb.FunctionalDepartmentKey OR
	@ReimbursableKey = pb.ReimbursableKey OR
	@ActivityTypeKey = pb.ActivityTypeKey OR
	@PropertyFundKey = pb.PropertyFundKey OR
	@AllocationRegionKey = pb.AllocationRegionKey OR
	@OriginatingRegionKey = pb.OriginatingRegionKey OR
	@LocalCurrencyKey = pb.LocalCurrencyKey

PRINT ''Completed inserting records into ProfitabilityBudgetUnknowns: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

/******* Remove rows from staging import batch which are associated with budgets with unknowns ******/
SET @StartTime = GETDATE()

CREATE TABLE #DeletingBudget
(
	BudgetId INT NOT NULL
)

INSERT INTO #DeletingBudget
(
	BudgetId
)
SELECT DISTINCT 
	BudgetId
FROM
	[dbo].[ProfitabilityBudgetUnknowns]

SET @RowCount = @@ROWCOUNT
PRINT ''Completed inserting records into #DeletingBudget: '' + CONVERT(CHAR(10), @RowCount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

IF @RowCount > 0 
BEGIN
	INSERT INTO @ImportErrorTable (Error) SELECT ''Unknowns found in budget''
END


--=========================================================================================================================================
-- DELETE UNKNOWNS
--=========================================================================================================================================

PRINT ''WARNING: DELETION OF UNKNOWNS COMMENTED OUT''
/*

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetEmployeeFunctionalDepartment x
INNER JOIN #BudgetEmployeeFunctionalDepartment xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #BudgetEmployee be ON
	be.BudgetEmployeeId = xh.BudgetEmployeeId AND
	be.ImportBatchId = xh.ImportBatchId
INNER JOIN #DeletingBudget d ON
	d.BudgetId = be.BudgetId

PRINT ''Deleted from BudgetEmployeeFunctionalDepartment: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetEmployee x
INNER JOIN #BudgetEmployee xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #DeletingBudget d ON
	d.BudgetId = xh.BudgetId

PRINT ''Deleted from BudgetEmployee: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetEmployeePayrollAllocationDetail x
INNER JOIN #BudgetEmployeePayrollAllocationDetail xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #BudgetEmployeePayrollAllocation bpa ON
	bpa.BudgetEmployeePayrollAllocationId = xh.BudgetEmployeePayrollAllocationId
INNER JOIN #BudgetProject bp ON
	bp.BudgetProjectId = bpa.BudgetProjectId
INNER JOIN #DeletingBudget d ON
	d.BudgetId = bp.BudgetId

PRINT ''Deleted from BudgetEmployeePayrollAllocationDetail: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetEmployeePayrollAllocation x
INNER JOIN #BudgetEmployeePayrollAllocation xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #BudgetProject bp ON
	bp.BudgetProjectId = xh.BudgetProjectId
INNER JOIN #DeletingBudget d ON
	d.BudgetId = bp.BudgetId

PRINT ''Deleted from BudgetEmployeePayrollAllocation: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetOverheadAllocationDetail x
INNER JOIN #BudgetOverheadAllocationDetail xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #BudgetProject bp ON
	bp.BudgetProjectId = xh.BudgetProjectId
INNER JOIN #DeletingBudget d ON
	d.BudgetId = bp.BudgetId

PRINT ''Deleted from BudgetOverheadAllocationDetail: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetProject x
INNER JOIN #BudgetProject xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #DeletingBudget d ON
	d.BudgetId = xh.BudgetId
	
PRINT ''Deleted from BudgetProject: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetTaxType x
INNER JOIN #BudgetTaxType xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #DeletingBudget d ON
	d.BudgetId = xh.BudgetId

PRINT ''Deleted from BudgetTaxType: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.BudgetReportGroupDetail x
INNER JOIN #Budget b ON
	b.BudgetId = x.BudgetId AND
	b.ImportBatchId = x.ImportBatchId
INNER JOIN #DeletingBudget d ON
	d.BudgetId = b.BudgetId

PRINT ''Deleted from BudgetReportGroupDetail: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

DELETE x
FROM TapasGlobalBudgeting.Budget x
INNER JOIN #Budget xh ON
	xh.ImportKey = x.ImportKey
INNER JOIN #DeletingBudget d ON
	d.BudgetId = xh.BudgetId

PRINT ''Deleted from Budget: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

/******* Remove rows from budgets in bugdet report groups in which there are budgets with unknowns ****/

SET @StartTime = GETDATE()


DELETE #ProfitabilityBudget
WHERE 
	BudgetId IN (
		SELECT DISTINCT BudgetId 
		FROM #Budget
		WHERE BudgetReportGroupId IN (
			SELECT DISTINCT BudgetReportGroupId
			FROM #Budget 
			WHERE BudgetId IN (
				SELECT DISTINCT BudgetId
				FROM [dbo].[ProfitabilityBudgetUnknowns]
			)			
		)
	)

PRINT ''Completed removing records from #ProfitabilityBudget: '' + CONVERT(CHAR(10), @@ROWCOUNT)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))




*/









-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Remove existing data for modified budget projects
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


CREATE TABLE #BudgetsToImportOriginal ( -- we keep an original copy of the budgets to insert because #BudgetsToImport will always be empty after the loop below
	BudgetId INT NOT NULL
)
INSERT INTO #BudgetsToImportOriginal
(
	BudgetId
)
SELECT DISTINCT 
	BudgetId
FROM
	#ProfitabilityBudget

CREATE TABLE #BudgetsToImport (
	BudgetId INT NOT NULL
)
INSERT INTO #BudgetsToImport (
	BudgetId
)
SELECT
	BudgetId
FROM
	#BudgetsToImportOriginal


DECLARE @BudgetId int = -1
DECLARE @LoopCount int = 0 -- Infinite loop safe guard

SET @StartTime = GETDATE()
DECLARE @TotalDeleteCount INT = 0

WHILE (EXISTS (SELECT TOP 1 BudgetId FROM #BudgetsToImport) AND @LoopCount < 100000)
BEGIN
	
	SET @LoopCount = @LoopCount + 1
	SET @BudgetId = (SELECT TOP 1 BudgetId FROM #BudgetsToImport)
	
	DECLARE @row Int = 1
	DECLARE @deleteCnt Int = 0
	SET @StartTime2 = GETDATE()
	WHILE (@row > 0)
	BEGIN
			
			-- Remove old facts
			DELETE TOP (100000)
			FROM GrReporting.dbo.ProfitabilityBudget 
			WHERE 
				BudgetId = @BudgetId AND
				BudgetReforecastTypeKey in (@BudgetReforecastTypeKey)
			
			SET @row = @@rowcount
			SET @deleteCnt = @deleteCnt + @row
			SET @TotalDeleteCount = @TotalDeleteCount + @row
			
			PRINT ''>>>: ''+CONVERT(char(10),@row)
			PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime2, GETDATE()), 121) + '' ms'' + CHAR(13))
		
	END
	
	PRINT ''Rows deleted from ProfitabilityBudget for BudgetID ('' + CONVERT(VARCHAR(10),@BudgetId) + '') FROM  ProfitabilityBudget:''+CONVERT(VARCHAR(10),@deleteCnt)		
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime2, GETDATE()), 121) + '' ms'' + CHAR(13))

	DELETE
	FROM
		#BudgetsToImport
	WHERE
		BudgetId = @BudgetId
END
PRINT ''Completed deleting records from ProfitabilityBudget. Total Rows Deleted:''+CONVERT(varchar,@TotalDeleteCount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Insert modified and new data 
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

SET @StartTime = GETDATE()

INSERT INTO GrReporting.dbo.ProfitabilityBudget
(
	SnapshotId,
	BudgetReforecastTypeKey,
	ReforecastKey,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	BudgetId,
	
	EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,

	USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey
)
SELECT 
	SnapshotId,
	BudgetReforecastTypeKey,
	ReforecastKey,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	(Select FeeAdjustmentKey From GrReporting.dbo.FeeAdjustment Where FeeAdjustmentCode = ''NORMAL''),
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	BudgetId,
	
	@EUCorporateGlAccountCategoryKeyUnknown, --EUCorporateGlAccountCategoryKey,
	@EUPropertyGlAccountCategoryKeyUnknown, --EUPropertyGlAccountCategoryKey,
	@EUFundGlAccountCategoryKeyUnknown, --EUFundGlAccountCategoryKey,

	@USPropertyGlAccountCategoryKeyUnknown, --USPropertyGlAccountCategoryKey,
	@USCorporateGlAccountCategoryKeyUnknown, ----USCorporateGlAccountCategoryKey,
	@USFundGlAccountCategoryKeyUnknown, --USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	@DevelopmentGlAccountCategoryKeyUnknown --DevelopmentGlAccountCategoryKey

FROM 
	#ProfitabilityBudget

print ''Rows Inserted in ProfitabilityBudget: ''+CONVERT(char(10),@@rowcount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))












-- ==============================================================================================================================================
-- Mark budgets as being successfully processed into the warehouse
-- ==============================================================================================================================================
DECLARE @ImportErrorText VARCHAR(500)
SELECT @ImportErrorText = COALESCE(@ImportErrorText + '', '', '''') + Error from @ImportErrorTable

BEGIN TRY		

	SELECT
		BTP.BudgetsToProcessId,
		CASE WHEN BWUB.BudgetId IS NULL THEN 1 ELSE 0 END AS OriginalBudgetProcessedIntoWarehouse, -- 0 if import fails, 1 if import succeeds
		@ImportErrorText AS ReasonForFailure,
		GETDATE() AS DateBudgetProcessedIntoWarehouse-- date that the buget import either failed or succeeded (depending on 0 or 1 above)
	INTO 
		#BudgetsToProcessToUpdate
	FROM
		dbo.BudgetsToProcess BTP
		INNER JOIN #BudgetsToProcess BTPT ON
			BTP.BudgetsToProcessId = BTPT.BudgetsToProcessId	
		
		LEFT OUTER JOIN #DeletingBudget BWUB ON
			BTP.BudgetId = BWUB.BudgetId 

	UPDATE
		BTP
	SET
		BTP.OriginalBudgetProcessedIntoWarehouse = BTPTU.OriginalBudgetProcessedIntoWarehouse,
		BTP.ReasonForFailure = BTPTU.ReasonForFailure,
		BTP.DateBudgetProcessedIntoWarehouse = BTPTU.DateBudgetProcessedIntoWarehouse
	FROM
		dbo.BudgetsToProcess BTP
		INNER JOIN #BudgetsToProcessToUpdate BTPTU ON
			BTPTU.BudgetsToProcessId = BTP.BudgetsToProcessId
		
	PRINT (''Rows updated from dbo.BudgetsToProcess: '' + CONVERT(VARCHAR(10),@@rowcount))

END TRY
BEGIN CATCH
	
	SET @ImportErrorText = NULL
		SELECT @ImportErrorText =  
			COALESCE(@ImportErrorText + '', '', '''') + 
			''BudgetsToProcessId:''+ LTRIM(STR(BTPTU.BudgetsToProcessId)) + 
			'' ReforecastBudgetsProcessedIntoWarehouse:'' + LTRIM(STR(BTPTU.ReforecastBudgetsProcessedIntoWarehouse))  +
			'' ReforecastActualsProcessedIntoWarehouse:'' + LTRIM(STR(BTPTU.ReforecastActualsProcessedIntoWarehouse))  +
			'' ReasonForFailure:'' + ReasonForFailure +
			'' DateBudgetProcessedIntoWarehouse:'' + CONVERT(VARCHAR(27), BTPTU.DateBudgetProcessedIntoWarehouse)
			
		from #BudgetsToProcessToUpdate BTPTU

	PRINT ''Error updating budgets to pricess, The Values were:''
	PRINT @ImportErrorText
	
	
    DECLARE @ErrorSeverity  INT = ERROR_SEVERITY(), @ErrorMessage NVARCHAR(4000) =
		''Error updating BudgetsToProcess: '' + CONVERT(VARCHAR(10), ERROR_NUMBER()) + '':'' + ERROR_MESSAGE() 	
    RAISERROR ( @ErrorMessage, @ErrorSeverity, 1)
END CATCH





-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
-- Clean up
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
SET @StartTime = GETDATE()

DROP TABLE #SystemSettingRegion
DROP TABLE #BudgetAllocationSetSnapshots
DROP TABLE #GLAccountCategoryTranslations
DROP TABLE #Budget
DROP TABLE #BudgetProject
DROP TABLE #Region
DROP TABLE #BudgetEmployee
DROP TABLE #BudgetEmployeeFunctionalDepartment
DROP TABLE #Location
DROP TABLE #RegionExtended
DROP TABLE #Project
DROP TABLE #BudgetEmployeePayrollAllocation
DROP TABLE #BudgetEmployeePayrollAllocationDetailBatches
DROP TABLE #BEPADa
DROP TABLE #BudgetEmployeePayrollAllocationDetail
DROP TABLE #BudgetTaxType
DROP TABLE #TaxType
DROP TABLE #EmployeePayrollAllocationDetail
DROP TABLE #BudgetOverheadAllocation
DROP TABLE #BudgetOverheadAllocationDetail
DROP TABLE #OverheadAllocationDetail
DROP TABLE #EffectiveFunctionalDepartment
DROP TABLE #ProfitabilityPreTaxSource
DROP TABLE #ProfitabilityTaxSource
DROP TABLE #ProfitabilityOverheadSource
DROP TABLE #ProfitabilityPayrollMapping
DROP TABLE #ProfitabilityBudget
DROP TABLE #DeletingBudget
DROP TABLE #BudgetsToImportOriginal
DROP TABLE #GlobalCategoryLookup
DROP TABLE #BudgetsToProcess

' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyGBSReforecast]    Script Date: 05/16/2011 08:15:51 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyGBSReforecast]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'CREATE PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyGBSReforecast]
AS

SET NOCOUNT ON


PRINT ''####''
PRINT ''stp_IU_LoadGrProfitabiltyGBSReforecast''
PRINT ''####''

--DECLARE @LatestImportBatchId INT = (SELECT MAX(ImportBatchId) FROM dbo.BudgetsToProcess WHERE IsReforecast = 1 and SourceSystemName = ''Global Budgeting System'' AND BudgetProcessedIntoWarehouse IS NULL AND DateBudgetProcessedIntoWarehouse IS NULL)

DECLARE @DataPriorToDate DATETIME=NULL
IF (@DataPriorToDate IS NULL)
	BEGIN
		SET @DataPriorToDate = CONVERT(DATETIME, 
			(
				SELECT 
					ConfiguredValue 
				FROM 
					SSISConfigurations 
				WHERE 
					ConfigurationFilter = ''ActualDataPriorToDate''
			)
		)
	END



DECLARE @CanImportGBSReforecast INT = (SELECT ConfiguredValue FROM [GrReportingStaging].[dbo].[SSISConfigurations] WHERE ConfigurationFilter = ''CanImportGBSReforecast'')

IF (@CanImportGBSReforecast <> 1)
BEGIN
	PRINT (''Import of GBS Reforecasts is not scheduled in GrReportingStaging.dbo.SSISConfigurations'')
	RETURN
END


DECLARE @StartTime DATETIME = GETDATE()

-- ==============================================================================================================================================
-- Get Budgets to Process
-- ==============================================================================================================================================

SELECT 
	BTPC.*, 
	CRR.ReforecastKey
INTO 
	#BudgetsToProcess 
FROM 
	dbo.[BudgetsToProcessCurrent](''GBS Budget/Reforecast'') BTPC
	INNER JOIN GrReporting.dbo.GetCurrentReforecastRecord() CRR ON
		BTPC.BudgetYear = CRR.ReforecastEffectiveYear AND
		BTPC.BudgetQuarter = CRR.ReforecastQuarterName
WHERE 
	IsReforecast = 1

DECLARE @BTPRowCount INT = @@rowcount
PRINT (''Rows inserted into #BudgetsToProcess: '' + CONVERT(VARCHAR(10),@BTPRowCount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


IF (@BTPRowCount = 0)
BEGIN
	PRINT (''*******************************************************'')
	PRINT (''	stp_IU_LoadGrProfitabiltyGBSBudget is quitting because there are no GBS BudgetsToProcess set to be imported.'')
	PRINT (''*******************************************************'')
	RETURN
END


-- ==============================================================================================================================================
-- Declare Local Variables
-- ==============================================================================================================================================
DECLARE @DebugMode BIT = 1 --- Running some extra test queries for debugging purposes. Start comment DEBUG MODE for search and check this variable.

DECLARE @ReasonsForFailure VARCHAR(500) = ''Success''
DECLARE @GlAccountKeyUnknown			INT = (SELECT GlAccountKey FROM GrReporting.dbo.GlAccount WHERE Code = ''UNKNOWN'')
DECLARE	@SourceKeyUnknown				INT = (SELECT SourceKey FROM GrReporting.dbo.Source WHERE SourceName = ''UNKNOWN'')
DECLARE	@FunctionalDepartmentKeyUnknown	INT = (SELECT FunctionalDepartmentKey FROM GrReporting.dbo.FunctionalDepartment WHERE FunctionalDepartmentCode = ''UNKNOWN'')
DECLARE	@ReimbursableKeyUnknown			INT = (SELECT ReimbursableKey FROM GrReporting.dbo.Reimbursable WHERE ReimbursableCode = ''UNKNOWN'')
DECLARE	@ActivityTypeKeyUnknown			INT = (SELECT ActivityTypeKey FROM GrReporting.dbo.ActivityType WHERE ActivityTypeCode = ''UNKNOWN'')
DECLARE	@PropertyFundKeyUnknown			INT = (SELECT PropertyFundKey FROM GrReporting.dbo.PropertyFund WHERE PropertyFundName = ''UNKNOWN'')
DECLARE	@AllocationRegionKeyUnknown		INT = (SELECT AllocationRegionKey FROM GrReporting.dbo.AllocationRegion WHERE RegionCode = ''UNKNOWN'')
DECLARE	@OriginatingRegionKeyUnknown	INT = (SELECT OriginatingRegionKey FROM GrReporting.dbo.OriginatingRegion WHERE RegionCode = ''UNKNOWN'')
DECLARE	@OverheadKeyUnknown				INT = (SELECT OverheadKey FROM GrReporting.dbo.Overhead WHERE OverheadCode = ''UNKNOWN'')
DECLARE	@LocalCurrencyKeyUnknown		INT = (SELECT CurrencyKey FROM GrReporting.dbo.Currency WHERE CurrencyCode = ''UNK'')

IF (@LocalCurrencyKeyUnknown IS NULL)
BEGIN
	PRINT (''Cant find unknown currency key, quitting...'')
	RETURN
END


DECLARE	@FeeAdjustmentKeyUnknown		INT = (SELECT FeeAdjustmentKey FROM GrReporting.dbo.FeeAdjustment WHERE FeeAdjustmentCode = ''UNKNOWN'')--,
--	@CanImportCorporateBudget	INT = (SELECT ConfiguredValue FROM GrReportingStaging.dbo.SSISConfigurations WHERE ConfigurationFilter = ''CanImportCorporateBudget'')

DECLARE @EUFundGlAccountCategoryKeyUnknown		INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE @EUCorporateGlAccountCategoryKeyUnknown	INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@EUPropertyGlAccountCategoryKeyUnknown	INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@USFundGlAccountCategoryKeyUnknown		INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@USPropertyGlAccountCategoryKeyUnknown	INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@USCorporateGlAccountCategoryKeyUnknown	INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@DevelopmentGlAccountCategoryKeyUnknown	INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''Development Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@GlobalGlAccountCategoryKeyUnknown		INT = (SELECT TOP 1 GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global'' AND TranslationSubTypeName = ''Global'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')

--DECLARE @SourceSystemId INT = (SELECT SourceSystemId FROM GrReporting.dbo.SourceSystem WHERE Name = ''Global Budgeting System'')
-- There could be up to three copies of the same GBS data due to three seperate imports, so work with latest GBS import which should have the
-- highest ImportBatchId.

--DECLARE @ImportBatchId INT = (SELECT MAX(ImportBatchId) FROM #BudgetsToProcess)
--DECLARE @BudgetCategoryFeesId INT = (SELECT BudgetCategoryId  from GBS.BudgetCategory WHERE Name = ''Fee-Income'' and ImportBatchId = @ImportBatchId)
--DECLARE @BudgetCategoryNonPayrollId INT = (SELECT BudgetCategoryId from GBS.BudgetCategory WHERE Name = ''Non-Payroll'' and ImportBatchId = @ImportBatchId)
--DECLARE @ReforecastKey INT = (SELECT ReforecastKey FROM GrReporting.dbo.GetCurrentReforecastRecord())

DECLARE @ReforecastTypeIsGBSBUDKey INT = (SELECT BudgetReforecastTypeKey from GrReporting.dbo.BudgetReforecastType where BudgetReforecastTypeCode = ''GBSBUD'')
DECLARE @ReforecastTypeIsGBSACTKey INT = (SELECT BudgetReforecastTypeKey from GrReporting.dbo.BudgetReforecastType where BudgetReforecastTypeCode = ''GBSACT'')
--DECLARE	@OverheadTypeIdUnAllocated INT = (Select [OverheadTypeId] From GrReportingStaging.GBS.OverheadType Where [Code] = ''UNALLOC'' AND ImportBatchID = @ImportBatchId)


DECLARE @ImportErrorTable TABLE (
	Error varchar(50)
);

-- ==============================================================================================================================================
-- Source Budget data from GBS
-- ==============================================================================================================================================

CREATE TABLE #Budget(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	BudgetId INT NOT NULL,
	BudgetAllocationSetId INT NOT NULL,
	BudgetReportGroupPeriodId INT NOT NULL,
	BudgetExchangeRateId INT NOT NULL,
	BudgetStatusId INT NOT NULL,
	CreatorStaffId INT NOT NULL,
	Name VARCHAR(50) NOT NULL,
	HealthyTensionStartDate DATETIME NOT NULL,
	HealthyTensionEndDate DATETIME NOT NULL,
	LastLockedDate DATETIME NULL,
	PriorBudgetId INT NULL,
	IsReforecast BIT NOT NULL,
	CopiedFromBudgetId INT NULL,
	ImportBudgetIntoGR BIT NOT NULL,
	LastImportBudgetIntoGRDate DATETIME NULL,
	SnapshotId INT NOT NULL,
	Period INT NOT NULL,
	FirstProjectedPeriodFees INT NOT NULL,
	FirstProjectedPeriodNonPayroll INT NOT NULL,
	MustImportAllActualsIntoWarehouse BIT NOT NULL,
	ReforecastKey INT NOT NULL
);

WITH GetFirstProjectedPeriodFees
AS
(
	SELECT
		BudgetId,
		Period AS ProjectedPeriod,
		ImportBatchId
	FROM
		GBS.BudgetPeriod
	WHERE
		IsFeeFirstProjectedPeriod = 1 
),
GetFirstProjectedPeriodNonPayRoll
AS
(
	SELECT
		BudgetId,
		Period AS ProjectedPeriod,
		ImportBatchId
	FROM
		GBS.BudgetPeriod
	WHERE
		IsNonPayrollFirstProjectedPeriod = 1 
)

INSERT INTO #Budget
SELECT
	Budget.ImportKey,
	BTP.ImportBatchId,
	Budget.BudgetId,
	Budget.BudgetAllocationSetId,
	Budget.BudgetReportGroupPeriodId,
	Budget.BudgetExchangeRateId,
	Budget.BudgetStatusId,
	Budget.CreatorStaffId,
	Budget.Name,
	Budget.HealthyTensionStartDate,
	Budget.HealthyTensionEndDate,
	Budget.LastLockedDate,
	Budget.PriorBudgetId,
	Budget.IsReforecast,
	Budget.CopiedFromBudgetId,
	Budget.ImportBudgetIntoGR,
	Budget.LastImportBudgetIntoGRDate,
	BTP.SnapshotId,
	BRGP.Period,
	FPPF.ProjectedPeriod AS FirstProjectedPeriodFees,
	FPPNP.ProjectedPeriod AS FirstProjectedPeriodNonPayroll,
	BTP.MustImportAllActualsIntoWarehouse,
	BTP.ReforecastKey
FROM
  GBS.Budget Budget

	INNER JOIN #BudgetsToProcess BTP ON -- All GBS budgets in dbo.BudgetsToProcess must be considered because they are to be processed into the warehouse
		Budget.BudgetId = BTP.BudgetId AND
		Budget.ImportBatchId = BTP.ImportBatchId
		
    INNER JOIN GDM.BudgetReportGroupPeriod BRGP ON
		BRGP.BudgetReportGroupPeriodId = Budget.BudgetReportGroupPeriodId 
		
	INNER JOIN Gdm.BudgetReportGroupPeriodActive(@DataPriorToDate) brgpA ON
		brgp.ImportKey = brgpA.ImportKey	
		
		
    INNER JOIN GetFirstProjectedPeriodFees FPPF ON
		FPPF.BudgetId = Budget.BudgetId AND
		FPPF.ImportBatchId = BTP.ImportBatchId
		
    INNER JOIN GetFirstProjectedPeriodNonPayRoll FPPNP ON
		FPPNP.BudgetId = Budget.BudgetId AND
		FPPNP.ImportBatchId = BTP.ImportBatchId
    
WHERE
	Budget.IsActive = 1 
	
DECLARE @BudgetRowCount INT = @@rowcount
PRINT (''Rows inserted into #Budget: '' + CONVERT(VARCHAR(10),@BudgetRowCount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

IF (@BudgetRowCount = 0)
BEGIN
	PRINT (''*******************************************************'')
	PRINT (''	stp_IU_LoadGrProfitabiltyGBSBudget is quitting because there are no GBS budgets set to be imported.'')
	PRINT (''*******************************************************'')
	RETURN
END

CREATE UNIQUE CLUSTERED INDEX IX_Budget ON #Budget (SnapshotId, BudgetId)

--SELECT * FROM #Budget rollback return

--select * from #Budget ROLLBACK RETURN
-- ==============================================================================================================================================
-- Source Snapshot mapping data from GDM
-- ==============================================================================================================================================


-- GLGlobalAccount --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLGlobalAccount(
	GLGlobalAccountId INT NOT NULL,
	ActivityTypeId INT NULL,
	GLStatutoryTypeId INT NOT NULL,
	ParentGLGlobalAccountId INT NULL,
	Code VARCHAR(10) NOT NULL,
	Name NVARCHAR(150) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsGR BIT NOT NULL,
	IsGbs BIT NOT NULL,
	IsRegionalOverheadCost BIT NOT NULL,
	ExpenseCzarStaffId INT NOT NULL,
	ParentCode AS (left(Code,(8))),
	SnapshotId INT NOT NULL
)
INSERT INTO #GLGlobalAccount (
	GLGlobalAccountId,
	ActivityTypeId,
	GLStatutoryTypeId,
	ParentGLGlobalAccountId,
	Code,
	Name,
	[Description],
	IsGR,
	IsGbs,
	IsRegionalOverheadCost,
	ExpenseCzarStaffId,
	SnapshotId
)
SELECT
	GLGA.GLGlobalAccountId,
	GLGA.ActivityTypeId,
	GLGA.GLStatutoryTypeId,
	GLGA.ParentGLGlobalAccountId,
	GLGA.Code,
	GLGA.Name,
	GLGA.[Description],
	GLGA.IsGR,
	GLGA.IsGbs,
	GLGA.IsRegionalOverheadCost,
	GLGA.ExpenseCzarStaffId,
	GLGA.SnapshotId
FROM
	Gdm.SnapshotGLGlobalAccount GLGA
	
	INNER JOIN #Budget B ON
		GLGA.SnapshotId = B.SnapshotId
WHERE
	GLGA.IsActive = 1

PRINT (''Rows inserted into #GLGlobalAccount: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLTranslationSubType -----------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLTranslationSubType (
	[SnapshotId] [int] NOT NULL,
	[GLTranslationSubTypeId] [int] NOT NULL,
	[GLTranslationTypeId] [int] NOT NULL,
	[Code] [varchar](10) NOT NULL
)
INSERT INTO #GLTranslationSubType
SELECT
	TST.SnapshotId,
	GLTranslationSubTypeId,
	GLTranslationTypeId,
	Code
FROM
	Gdm.SnapshotGLTranslationSubType TST
	INNER JOIN #Budget B ON
		TST.SnapshotId = B.SnapshotId
WHERE
	TST.Code = ''GL'' AND -- This limits to the Global translation sub type; for multiple sub types remove this constraint and add TST.Code to SELECT
	TST.IsActive = 1

PRINT (''Rows inserted into ##GLTranslationSubType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLGlobalAccountTranslationType --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLGlobalAccountTranslationType(
	GLGlobalAccountTranslationTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #GLGlobalAccountTranslationType
SELECT
	GATT.GLGlobalAccountTranslationTypeId, 
	GATT.GLGlobalAccountId, 
	GATT.GLTranslationTypeId, 
	GATT.GLAccountTypeId,	
	CASE WHEN
			GA.ActivityTypeId = 99
		 THEN 
				-- GC :: CC1 >>
				-- Unallocated overhead expenses will be grouped under the “Overhead” expense 
				-- type and not “Non-Payroll”. This will be based on the activity of the 
				-- transaction; all transactions that have a corporate overhead activity 
				-- will have an expense type of “Overhead”.
			
			AST.GLAccountSubTypeId
			
				--(
				--	SELECT
				--		*--GST.GLAccountSubTypeId 
				--	FROM
				--		Gdm.SnapshotGLAccountSubType GST 
				--		INNER JOIN Gdm.SnapshotGLTranslationType GTT ON
				--			GTT.GLTranslationTypeId = GST.GLTranslationTypeId
				--		INNER JOIN #Budget B ON
				--			GST.SnapshotId = B.SnapshotId AND
				--			GTT.SnapshotId = B.SnapshotId
				--	WHERE
				--		GTT.Code = ''GL'' AND
				--		GST.Code = ''GRPOHD''	AND
				--		GST.IsActive = 1 AND
				--		GTT.IsActive = 1
				--)				
		 ELSE
			GATT.GLAccountSubTypeId
	END AS GLAccountSubTypeId,
	GATT.SnapshotId
FROM
	Gdm.SnapshotGLGlobalAccountTranslationType GATT
	
	INNER JOIN #Budget B ON
		GATT.SnapshotId = B.SnapshotId	

	LEFT OUTER JOIN (
						SELECT
							GA.*
						FROM
							#GLGlobalAccount GA
							
					 ) GA ON
							GA.GLGlobalAccountId = GATT.GLGlobalAccountId AND
							GA.SnapshotId = GATT.SnapshotId
	
	LEFT OUTER JOIN (
						SELECT
							GST.GLAccountSubTypeId,
							B.BudgetId,
							gst.SnapshotId
							--GST.GLAccountSubTypeId 
						FROM
							Gdm.SnapshotGLAccountSubType GST 
							INNER JOIN Gdm.SnapshotGLTranslationType GTT ON
								GTT.GLTranslationTypeId = GST.GLTranslationTypeId
							INNER JOIN #Budget B ON
								GST.SnapshotId = B.SnapshotId AND
								GTT.SnapshotId = B.SnapshotId
						WHERE
							GTT.Code = ''GL'' AND
							GST.Code = ''GRPOHD''	AND
							GST.IsActive = 1 AND
							GTT.IsActive = 1
					) AST ON
							GATT.SnapshotId = AST.SnapshotId AND
							B.BudgetId = AST.BudgetId
	
WHERE
	GATT.IsActive = 1

PRINT (''Rows inserted into #GLGlobalAccountTranslationType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- SnapshotGLGlobalAccountTranslationSubType -------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLGlobalAccountTranslationSubType (
	SnapshotId INT NOT NULL,
	GLGlobalAccountTranslationSubTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL
)
INSERT INTO #GLGlobalAccountTranslationSubType
SELECT
	GATST.SnapshotId,
	GATST.GLGlobalAccountTranslationSubTypeId,
	GATST.GLGlobalAccountId,
	GATST.GLTranslationSubTypeId,
	GATST.GLMinorCategoryId
FROM
	Gdm.SnapshotGLGlobalAccountTranslationSubType GATST
	INNER JOIN #Budget B ON
		GATST.SnapshotId = B.SnapshotId
WHERE
	GATST.IsActive = 1

PRINT (''Rows inserted into #GLGlobalAccountTranslationSubType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLMinorCategory

SET @StartTime = GETDATE()

CREATE TABLE #GLMinorCategory (
	SnapshotId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL
)
INSERT INTO #GLMinorCategory
SELECT
	MinC.SnapshotId,
	MinC.GLMinorCategoryId,
	MinC.GLMajorCategoryId
FROM
	Gdm.SnapshotGLMinorCategory MinC
	INNER JOIN #Budget B ON
		MinC.SnapshotId = B.SnapshotId
WHERE
	MinC.IsActive = 1

PRINT (''Rows inserted into #GLMinorCategory: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLMajorCategory

SET @StartTime = GETDATE()

CREATE TABLE #GLMajorCategory (
	[SnapshotId] [int] NOT NULL,
	[GLMajorCategoryId] [int] NOT NULL,
	[GLTranslationSubTypeId] [int] NOT NULL
)
INSERT INTO #GLMajorCategory
SELECT
	MajC.SnapshotId,
	MajC.GLMajorCategoryId,
	MajC.GLTranslationSubTypeId
FROM
	Gdm.SnapshotGLMajorCategory MajC
	INNER JOIN #Budget B ON
		MajC.SnapshotId = B.SnapshotId
WHERE
	MajC.IsActive = 1

PRINT (''Rows inserted into #GLMajorCategory: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- ReportingEntityCorporateDepartment --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #ReportingEntityCorporateDepartment(
	ReportingEntityCorporateDepartmentId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	CorporateDepartmentCode CHAR(6) NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO	#ReportingEntityCorporateDepartment
SELECT
	RECD.ReportingEntityCorporateDepartmentId,
	RECD.PropertyFundId,
	RECD.SourceCode,
	RECD.CorporateDepartmentCode,
	RECD.SnapshotId
FROM
	Gdm.SnapshotReportingEntityCorporateDepartment RECD
	INNER JOIN #Budget B ON
		RECD.SnapshotId = B.SnapshotId
WHERE
	RECD.IsDeleted = 0

PRINT (''Rows inserted into #ReportingEntityCorporateDepartment: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- PropertyFund --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #PropertyFund(
	PropertyFundId INT NOT NULL,
	RelatedFundId INT NULL,
	EntityTypeId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	BudgetOwnerStaffId INT NOT NULL,
	RegionalOwnerStaffId INT NOT NULL,
	DefaultGLTranslationSubTypeId INT NULL,
	Name VARCHAR(100) NOT NULL,
	IsReportingEntity BIT NOT NULL,
	IsPropertyFund BIT NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #PropertyFund
SELECT
	PF.PropertyFundId,
	PF.RelatedFundId,
	PF.EntityTypeId,
	PF.AllocationSubRegionGlobalRegionId,
	PF.BudgetOwnerStaffId,
	PF.RegionalOwnerStaffId,
	PF.DefaultGLTranslationSubTypeId,
	PF.Name,
	PF.IsReportingEntity,
	PF.IsPropertyFund,
	PF.SnapshotId
FROM
	Gdm.SnapshotPropertyFund PF
	INNER JOIN #Budget B ON
		B.SnapshotId = PF.SnapshotId
WHERE
	PF.IsActive = 1

PRINT (''Rows inserted into #PropertyFund: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- ActivityType --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #ActivityType(
	ActivityTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #ActivityType
SELECT
	ActivityTypeId,
	Code,
	AT.SnapshotId
FROM
	Gdm.SnapshotActivityType AT
	INNER JOIN #Budget B ON
		AT.SnapshotId = B.SnapshotId
WHERE
	AT.IsActive = 1

PRINT (''Rows inserted into #ActivityType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Department --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #CorporateDepartment(
	Code CHAR(8) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	FunctionalDepartmentId INT NULL,
	IsTsCost BIT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO	#CorporateDepartment
SELECT
	D.Code,
	D.SourceCode,
	D.FunctionalDepartmentId,
	D.IsTsCost,
	D.SnapshotId
FROM
	Gdm.SnapshotCorporateDepartment D
	INNER JOIN #Budget B ON
		D.SnapshotId = B.SnapshotId
WHERE
	D.IsActive = 1

PRINT (''Rows inserted into #CorporateDepartment: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- FunctionalDepartment --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #FunctionalDepartment (
    SnapshotId INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	Code VARCHAR(20) NULL,
	GlobalCode VARCHAR(30) NULL
)

INSERT INTO #FunctionalDepartment
SELECT
    B.SnapshotId,
	FunctionalDepartmentId,
	Code,
	GlobalCode
FROM
	Gdm.SnapshotFunctionalDepartment FD
	INNER JOIN #Budget B ON
		FD.SnapshotId = B.SnapshotId
WHERE
	FD.IsActive = 1

PRINT (''Rows inserted into #FunctionalDepartment: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- AllocationSubRegion --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #AllocationSubRegion (
	[SnapshotId] [int] NOT NULL,
	[AllocationSubRegionGlobalRegionId] [int] NOT NULL,
	[Code] [varchar](10) NOT NULL,
	[Name] [varchar](50) NOT NULL,
	[AllocationRegionGlobalRegionId] [int] NULL,
	[DefaultCorporateSourceCode] [char](2) NOT NULL
)
INSERT INTO #AllocationSubRegion
SELECT
	ASR.SnapshotId,
	ASR.AllocationSubRegionGlobalRegionId,
	ASR.Code,
	ASR.Name,
	ASR.AllocationRegionGlobalRegionId,
	ASR.DefaultCorporateSourceCode
FROM
	Gdm.SnapshotAllocationSubRegion ASR
	INNER JOIN #Budget B ON
		ASR.SnapshotId = B.SnapshotId
WHERE
	ASR.IsActive = 1

PRINT (''Rows inserted into #AllocationSubRegion: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Master GL Account Category mapping table

SET @StartTime = GETDATE()

CREATE TABLE #GLAccountCategoryMapping (
	SnapshotId INT NOT NULL,
	GLAccountKey INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL
)
INSERT INTO #GLAccountCategoryMapping
SELECT
	Budget.SnapshotId,
	Gla.GlAccountKey,
	TST.GLTranslationTypeId,
	TST.GLTranslationSubTypeId,
	MinC.GLMajorCategoryId,
	GLATST.GLMinorCategoryId,
	GLATT.GLAccountTypeId,
	GLATT.GLAccountSubTypeId
FROM
	#Budget Budget

	INNER JOIN #GLTranslationSubType TST ON
		Budget.SnapshotId = TST.SnapshotId

	INNER JOIN #GLGlobalAccountTranslationSubType GLATST ON
		TST.GLTranslationSubTypeId = GLATST.GLTranslationSubTypeId AND
		Budget.SnapshotId = GLATST.SnapshotId
	
	INNER JOIN #GLGlobalAccountTranslationType GLATT ON
		GLATST.GLGlobalAccountId = GLATT.GLGlobalAccountId AND
		TST.GLTranslationTypeId = GLATT.GLTranslationTypeId AND
		Budget.SnapshotId = GLATT.SnapshotId

	INNER JOIN GrReporting.dbo.GlAccount Gla ON
		GLATT.GLGlobalAccountId = GLA.GLGlobalAccountId

	INNER JOIN #GLMinorCategory MinC ON
		GLATST.GLMinorCategoryId = MinC.GLMinorCategoryId AND
		Budget.SnapshotId = MinC.SnapshotId

	INNER JOIN #GLMajorCategory MajC ON
		MinC.GLMajorCategoryId = MajC.GLMajorCategoryId AND
		Budget.SnapshotId = MajC.SnapshotId

PRINT (''Rows inserted into #GLAccountCategoryMapping: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Corporate Property Sources

CREATE TABLE #CorporatePropertySourceCodes (
	CorporateSourceCode CHAR(2) NOT NULL,
	PropertySourceCode CHAR(2) NOT NULL
)

INSERT INTO #CorporatePropertySourceCodes
SELECT ''UC'', ''US'' UNION ALL
SELECT ''EC'', ''EU'' UNION ALL
SELECT ''IC'', ''IN'' UNION ALL
SELECT ''BC'', ''BR'' UNION ALL
SELECT ''CC'', ''CN''


-- ==============================================================================================================================================
-- Get Non-Payroll Expense Budget items from GBS
-- ==============================================================================================================================================

SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilitySource (
	ImportBatchId INT NOT NULL,
    SourceName varchar(20),
    BudgetReforecastTypeKey INT NOT NULL,
    SnapshotId INT NOT NULL,
	BudgetId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	BudgetAmount MONEY NOT NULL,
	GLGlobalAccountId INT NULL,
	FunctionalDepartmentCode VARCHAR(20) NULL,
	JobCode VARCHAR(20) NULL,
	Reimbursable VARCHAR(3) NULL, -- NULL because this field is determined via an outer join
	ActivityTypeId INT NULL, -- NULL because for Fees this field is determined via an outer join
	PropertyFundId INT NULL, -- NULL because this field is determined via an outer join
	AllocationSubRegionGlobalRegionId INT NULL, -- NULL because this field is determined via an outer join
	OriginatingGlobalRegionId INT NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	LockedDate DATETIME NULL,
	IsExpense BIT NOT NULL,
	UnallocatedOverhead CHAR(7) NULL, -- NULL because this field is determined via an outer join
	FeeAdjustment VARCHAR(9) NOT NULL,
	ReforecastKey INT NOT NULL
)
-- Insert original budget amounts
INSERT INTO #ProfitabilitySource (
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
    SnapshotId,
	BudgetId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	BudgetAmount,
	GLGlobalAccountId,
	FunctionalDepartmentCode,
	JobCode,
	Reimbursable,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingGlobalRegionId,
	LocalCurrencyCode,
	LockedDate,
	IsExpense,
	UnallocatedOverhead,
	FeeAdjustment,
	ReforecastKey
)

SELECT --TOP 100
	Budget.ImportBatchId,
    ''NPEB'' as SourceName,
    @ReforecastTypeIsGBSBUDKey,
    Budget.SnapshotId,
	Budget.BudgetId, -- BudgetId
	''GBS:BudgetId='' + LTRIM(RTRIM(STR(Budget.BudgetId))) + ''&NonPayrollExpenseBreakdownId='' + LTRIM(RTRIM(STR(NPEB.NonPayrollExpenseBreakdownId))) + ''&SnapshotId='' + LTRIM(RTRIM(STR(Budget.SnapshotId))), -- ReferenceCode
	NPEB.Period, -- ExpensePeriod: Period is actually a foreign key to PeriodExtended but is also the implied period value, e.g.: 201009
	CASE WHEN NPEB.IsDirectCost = 1 THEN CPSC.PropertySourceCode ELSE NPEB.CorporateSourceCode END AS CorporateSourceCode,	
	NPEB.Amount, -- BudgetAmount
	ISNULL(NPEB.ActivitySpecificGLGlobalAccountId, NPEB.GLGlobalAccountId), -- GLGlobalAccountId
	FD.GlobalCode, -- FunctionalDepartmentCode
	NPEB.JobCode, -- JobCode
	CASE WHEN CD.IsTsCost = 0 THEN ''YES'' ELSE ''NO'' END, -- Reimbursable
	NPEB.ActivityTypeId, -- ActivityTypeId: this Id should correspond to the correct Id in GDM
	RECD.PropertyFundId, -- PropertyFundId
	PF.AllocationSubRegionGlobalRegionId, -- AllocationSubRegionGlobalRegionId
	NPEB.OriginatingSubRegionGlobalRegionId, -- OriginatingGlobalRegionId
	NPEB.CurrencyCode, -- LocalCurrencyCode
	Budget.LastLockedDate, -- LockedDate
	1, -- IsExpense
	CASE WHEN AT.Code = ''CORPOH'' THEN ''UNALLOC'' ELSE ''UNKNOWN'' END, -- UnallocatedOverhead
	''NORMAL'', -- FeeAdjustment,
	Budget.ReforecastKey
FROM
	#Budget Budget
	
	INNER JOIN GBS.NonPayrollExpenseBreakdown NPEB ON
		Budget.BudgetId = NPEB.BudgetId AND
		Budget.ImportBatchId = NPEB.ImportBatchId
	
	INNER JOIN #CorporatePropertySourceCodes CPSC ON
		NPEB.CorporateSourceCode = CPSC.CorporateSourceCode
	
	LEFT OUTER JOIN ( -- these NonPayrollExpenses need to be excluded because they are in dispute
	
		/* Disputes are created at the level of a budget project. A budget project will dispute the portion of a non-payroll expense that is
		   allocated to them (via the NonPayrollExpenseBreakdown table, which includes the NonPayrollExpenseId and BudgetProjectId fields,
		   allowing for the portion of the non-payroll expense that has been allocated to the budget project to be determined).
		   
		   If, for example, a non-payroll expense is split between two budget projects, and one of these budget projects is disputing their
		   allocation, the portion of the non-payroll expense that is allocated to the budget project that is not disputing must still be
		   included. Only thet portion of the non-payroll expense that is currently being disputed must be excluded.	   
		*/
	
		SELECT DISTINCT
			NPED.ImportBatchId,
			NPED.NonPayrollExpenseId,
			NPED.BudgetProjectId
		FROM
			GBS.NonPayrollExpenseDispute NPED
			INNER JOIN GBS.DisputeStatus DS ON
				NPED.DisputeStatusId = DS.DisputeStatusId AND
				NPED.ImportBatchId = DS.ImportBatchId
		WHERE
			DS.Name <> ''Resolved'' AND
			DS.IsActive = 1
			
	) DisputedNonPayrollExpenseItems ON
		NPEB.NonPayrollExpenseId = DisputedNonPayrollExpenseItems.NonPayrollExpenseId AND
		NPEB.BudgetProjectId = DisputedNonPayrollExpenseItems.BudgetProjectId AND
		NPEB.ImportBatchId = DisputedNonPayrollExpenseItems.ImportBatchId

	-- PropertyFundId
	LEFT OUTER JOIN #ReportingEntityCorporateDepartment RECD ON				-- Only corporate budgets should be handled by GBS, so when we map
		 NPEB.CorporateDepartmentCode = RECD.CorporateDepartmentCode AND	-- to find a Reporting Entity we assume that the source is corporate
		 NPEB.CorporateSourceCode = RECD.SourceCode AND
		 Budget.SnapshotId = RECD.SnapshotId
	
	-- AllocationRegionId
	LEFT OUTER JOIN #PropertyFund PF ON
		RECD.PropertyFundId = PF.PropertyFundId AND
		RECD.SnapshotId = PF.SnapshotId
	
	-- Overhead Type
	LEFT OUTER JOIN #ActivityType AT ON
		NPEB.ActivityTypeId = AT.ActivityTypeId AND
		Budget.SnapshotId = AT.SnapshotId -- 
	
	-- Reimbursable
	LEFT OUTER JOIN #CorporateDepartment CD ON
		NPEB.CorporateSourceCode = CD.SourceCode AND
		NPEB.CorporateDepartmentCode = CD.Code AND
		Budget.SnapshotId = CD.SnapshotId --

	-- FunctionalDepartmentCode
	LEFT OUTER JOIN #FunctionalDepartment FD ON
		NPEB.FunctionalDepartmentId = FD.FunctionalDepartmentId 

WHERE
	NPEB.IsActive = 1 
	AND DisputedNonPayrollExpenseItems.NonPayrollExpenseId IS NULL -- Exclude all disputed items
    AND NPEB.Period >= Budget.FirstProjectedPeriodNonPayroll

PRINT (''Rows inserted into #ProfitabilitySource: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



--select ''NonPayrollExpenseBreakDown'' as DataSource, * from #ProfitabilitySource

-- ==============================================================================================================================================
-- Get Fee Budget items from GBS
-- ==============================================================================================================================================

SET @StartTime = GETDATE()

INSERT INTO #ProfitabilitySource (
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
    SnapshotId,
	BudgetId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	BudgetAmount,
	GLGlobalAccountId,
	FunctionalDepartmentCode,
	JobCode,
	Reimbursable,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingGlobalRegionId,
	LocalCurrencyCode,
	LockedDate,
	IsExpense,
	UnallocatedOverhead,
	FeeAdjustment,
	ReforecastKey
)
SELECT --TOP 100
	Budget.ImportBatchId,
    ''Fees'' as SourceName,
    @ReforecastTypeIsGBSBUDKey,
    Budget.Snapshotid,
	Budget.BudgetId, -- BudgetId
	''GBS:BudgetId='' + LTRIM(RTRIM(STR(Budget.BudgetId))) + ''&FeeId='' + LTRIM(RTRIM(STR(Fee.FeeId))) + ''&FeeDetailId='' + LTRIM(RTRIM(STR(FeeDetail.FeeDetailId))) + ''&SnapshotId='' + LTRIM(RTRIM(STR(Budget.SnapshotId))), -- ReferenceCode
	FeeDetail.Period,
	ASR.DefaultCorporateSourceCode, -- SourceCode
	FeeDetail.Amount,
	GA.GLGlobalAccountId, -- GLGlobalAccountId
	NULL, -- FunctionalDepartmentId
	NULL, -- JobCode
	''NO'', -- Reimbursable
	GA.ActivityTypeId, -- ActivityType: determined by finding Fee.GLGlobalAccountId on GrReportingStaging.dbo.GLGlobalAccount
	Fee.PropertyFundId, -- PropertyFundId
	Fee.AllocationSubRegionGlobalRegionId, -- AllocationSubRegionGlobalRegionId
	Fee.AllocationSubRegionGlobalRegionId, -- OriginatingGlobalRegionId: allocation region = originating region for fee income
	Fee.CurrencyCode,
	Budget.LastLockedDate, -- LockedDate
	0,  -- IsExpense
	''UNKNOWN'', -- IsUnallocatedOverhead: defaults to UNKNOWN for fees
	CASE WHEN FeeDetail.IsAdjustment = 1 THEN ''FEEADJUST'' ELSE ''NORMAL'' END, -- IsFeeAdjustment, field isn''t NULLABLE
	Budget.ReforecastKey
FROM
	#Budget Budget

	INNER JOIN GBS.Fee Fee ON
		Budget.BudgetId = Fee.BudgetId AND
		Budget.ImportBatchId = Fee.ImportBatchId

	INNER JOIN GBS.FeeDetail FeeDetail ON
		Fee.FeeId = FeeDetail.FeeId AND
		Fee.ImportBatchId = FeeDetail.ImportBatchId

	LEFT OUTER JOIN #GLGlobalAccount GA ON
		Fee.GLGlobalAccountId = GA.GLGlobalAccountId AND
		Budget.SnapshotId = GA.SnapshotId

	-- SourceCode
	LEFT OUTER JOIN #AllocationSubRegion ASR ON
		Fee.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId

WHERE
	Fee.IsDeleted = 0 AND
	FeeDetail.Amount <> 0 AND
	FeeDetail.Period >= Budget.FirstProjectedPeriodFees

PRINT (''Fee Budgets inserted into #ProfitabilitySource: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--select ''Fee'' as DataSource, * from #ProfitabilitySource

------------------------------------------------------------------------------------------------------------------

-- ==============================================================================================================================================
-- Get ProfitibilityActuals from GBS
-- ==============================================================================================================================================

SET @StartTime = GETDATE()

;WITH CTE_UncallocatedOverhead
AS
(
	SELECT 
		BTP.ImportBatchId,
		OverheadTypeId
	FROM 
		GrReportingStaging.GBS.OverheadType  OHT
		INNER JOIN #BudgetsToProcess BTP ON
			BTP.ImportBatchId = OHT.ImportBatchId
	WHERE [Code] = ''UNALLOC''
),
CTE_BudgetCategory
AS
(
	SELECT 
	    BTP.ImportBatchId,
		BudgetCategoryId,
		OverheadTypeId,
		Name
	FROM 
		GBS.BudgetCategory BC
		INNER JOIN #BudgetsToProcess BTP ON
			BTP.ImportBatchId = BC.ImportBatchId		
			
		LEFT OUTER JOIN CTE_UncallocatedOverhead UAOHT ON
			BC.ImportBatchId = UAOHT.ImportBatchId
)
SELECT
     ''Actual-Fees'' AS SourceName, 
     0 as IsExpense,
     BPA.* 
INTO 
	#Actuals 
FROM
	GBS.BudgetProfitabilityActual BPA
	
    INNER JOIN #Budget B ON		
		b.BudgetId = BPA.BudgetId AND
		B.ImportBatchId = BPA.ImportBatchId
		
    INNER JOIN CTE_BudgetCategory BC ON 
		BC.BudgetCategoryId = BPA.BudgetCategoryId AND
		BC.Name = ''Fee-Income'' 

WHERE
	BPA.Period < B.FirstProjectedPeriodFees 
UNION ALL
SELECT
	''Actual-NonPayroll'' AS SourceName,
	1 as IsExpense,
	BPA.*
FROM
	GBS.BudgetProfitabilityActual BPA 

    INNER JOIN #Budget B ON
		B.BudgetId = BPA.BudgetId AND
		B.ImportBatchId = BPA.ImportBatchId AND 
		B.MustImportAllActualsIntoWarehouse = 1
    
    INNER JOIN CTE_BudgetCategory BC ON 
		BC.BudgetCategoryId = BPA.BudgetCategoryId AND
		(
		    (BC.Name = ''Non-Payroll'') OR 
            (BC.Name = ''Overhead'' AND BPA.OverheadTypeId = BC.OverheadTypeId)
        )  AND
        BC.ImportBatchId = BPA.ImportBatchId
		
WHERE
	BPA.Period < B.FirstProjectedPeriodNonPayroll
	
	
PRINT (''Actuals Queried'')
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



INSERT INTO #ProfitabilitySource (
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
    SnapshotId,
	BudgetId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	BudgetAmount,
	GLGlobalAccountId,
	FunctionalDepartmentCode,
	JobCode,
	Reimbursable,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingGlobalRegionId,
	LocalCurrencyCode,
	LockedDate,
	IsExpense,
	UnallocatedOverhead,
	FeeAdjustment,
	ReforecastKey
)
SELECT  
	BPA.ImportBatchId,
    BC.Name AS SourceName,  
    @ReforecastTypeIsGBSACTKey,
    b.SnapshotId,
	b.BudgetId, 
	''GBS:BudgetId='' + LTRIM(RTRIM(STR(b.BudgetId))) + ''&BudgetProfitabilityActualId='' + LTRIM(RTRIM(STR(bpa.BudgetProfitabilityActualId))) + ''&SnapshotId='' + LTRIM(RTRIM(STR(b.SnapshotId))) AS ReferenceCode, -- ReferenceCode
	BPA.Period,
	ASR.DefaultCorporateSourceCode, -- SourceCode
	BPA.Amount,
	GA.GLGlobalAccountId, -- GLGlobalAccountId
	FD.GlobalCode,
	BPA.CorporateJobCode,
	CASE WHEN BPA.IsTsCost = 0 THEN ''YES'' ELSE ''NO'' END,
	BPA.ActivityTypeId,
	PF.PropertyFundId,
	BPA.AllocationSubRegionGlobalRegionId,
	BPA.OriginatingSubRegionGlobalRegionId,	
	BPA.CurrencyCode,
	B.LastLockedDate,
	BPA.IsExpense,
	CASE WHEN AT.Code = ''CORPOH'' THEN ''UNALLOC'' ELSE ''UNKNOWN'' END, -- UnallocatedOverhead
	''Normal'' AS FeeAdjustment,
	B.ReforecastKey
FROM 
    #Actuals BPA

    INNER JOIN  #Budget B ON
		B.BudgetId = BPA.BudgetId
    
    INNER JOIN [GBS].[BudgetCategory] BC ON 
		BC.BudgetCategoryId = BPA.BudgetCategoryId AND
		BC.ImportBatchId = B.ImportBatchId		
    
	LEFT OUTER JOIN #AllocationSubRegion ASR ON
		BPA.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId
		
	LEFT OUTER JOIN #GLGlobalAccount GA ON
		BPA.GLGlobalAccountId = GA.GLGlobalAccountId AND
		B.SnapshotId = GA.SnapshotId

	LEFT OUTER JOIN #FunctionalDepartment FD on 
		FD.FunctionalDepartmentId = BPA.FunctionalDepartmentId
		and b.SnapshotId = FD.SnapshotId

    LEFT OUTER JOIN  #PropertyFund PF
		on PF.PropertyFundId = BPA.ReportingEntityPropertyFundId
		and B.SnapshotId = PF.SnapshotId
		
	-- Overhead Type
	LEFT OUTER JOIN #ActivityType AT ON
		BPA.ActivityTypeId = AT.ActivityTypeId AND
		B.SnapshotId = AT.SnapshotId -- 

PRINT (''ProfitibilityActuals Rows inserted into #ProfitabilitySource: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
				
--where    
 --   ((BC.BudgetCategoryId = @BudgetCategoryFeesId) AND (BPA.Period < B.FirstProjectedPeriodFees)) 
 --  OR ((BC.BudgetCategoryId = @BudgetCategoryNonPayrollId) AND (BPA.Period < B.FirstProjectedPeriodNonPayroll))

  --  ((BC.Name = ''Fee-Income'') AND (BPA.Period < B.FirstProjectedPeriodFees)) 
  -- OR ((BC.Name = ''Non-Payroll'') AND (BPA.Period < B.FirstProjectedPeriodNonPayroll))
   -- (BC.Name = ''Fee-Income'') AND (BPA.Period < B.FirstProjectedPeriodFees)
    
UPDATE
	PS
SET
	PS.GLGlobalAccountId = GLGA2.GLGlobalAccountId
FROM
	#ProfitabilitySource PS

	INNER JOIN #GLGlobalAccount GLGA1 ON
		PS.GLGlobalAccountId = GLGA1.GLGlobalAccountId

	INNER JOIN #GLGlobalAccount GLGA2 ON
		(LEFT(GLGA1.Code, 10 - LEN(PS.ActivityTypeId)) + LTRIM(RTRIM(STR(PS.ActivityTypeId)))) = GLGA2.Code
WHERE
	LEN(GLGA1.Code) = 10 AND -- A code of 10 characters excludes the account prefix (CP, TS) and includes the activity type code, i.e.: 5020100012
	RIGHT(GLGA1.Code, 2) = ''00'' -- where the header account has been budgeted against

PRINT (''Rows updated in #ProfitabilitySource (GLAccount update from head to activity-specific GL Account: '' + LTRIM(RTRIM(STR(@@rowcount))))

------------------------------------------------------------------------------------------------------------------

-- Perhaps create index for #ProfitabilitySource here

-- ==============================================================================================================================================
-- Join to dimension tables in GrReporting and attempt to resolve keys, otherwise default to UNKNOWN if NULL
-- ==============================================================================================================================================

SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityReforecast(
	ImportBatchId INT NOT NULL,
    SourceName varchar(20),
    BudgetReforecastTypeKey INT NOT NULL,
    SnapshotId INT NOT NULL,
	CalendarKey int NOT NULL,
	GlAccountKey int NOT NULL,
	SourceKey int NOT NULL,
	FunctionalDepartmentKey int NOT NULL,
	ReimbursableKey int NOT NULL,
	ActivityTypeKey int NOT NULL,
	PropertyFundKey int NOT NULL,	
	AllocationRegionKey int NOT NULL,
	OriginatingRegionKey int NOT NULL,
	OverheadKey int NOT NULL,
	FeeAdjustmentKey int NOT NULL,
	LocalCurrencyKey int NOT NULL,
	LocalReforecast money NOT NULL,
	ReferenceCode Varchar(300) NOT NULL,
	BudgetId int NOT NULL,
	--SourceSystemId int NOT NULL,
	IsExpense BIT NOT NULL,

	EUCorporateGlAccountCategoryKey int NULL,
	EUPropertyGlAccountCategoryKey int NULL,
	EUFundGlAccountCategoryKey int NULL,

	USPropertyGlAccountCategoryKey int NULL,
	USCorporateGlAccountCategoryKey int NULL,
	USFundGlAccountCategoryKey int NULL,

	GlobalGlAccountCategoryKey int NULL,
	DevelopmentGlAccountCategoryKey int NULL,
	ReforecastKey INT NOT NULL	
	
)
INSERT INTO #ProfitabilityReforecast 
(
	ImportBatchId,
    SourceName,
    BudgetReforecastTypeKey,
    SnapshotId,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId,
	--SourceSystemId,
	IsExpense,
	PS.ReforecastKey
)

SELECT
	PS.ImportBatchId,
    PS.SourceName,
    PS.BudgetReforecastTypeKey,
    PS.SnapshotId,
	DATEDIFF(DD, ''1900-01-01'', LEFT(PS.ExpensePeriod, 4)+''-'' + RIGHT(PS.ExpensePeriod, 2) + ''-01''), -- CalendarKey,
	CASE WHEN GA.GlAccountKey IS NULL THEN @GlAccountKeyUnknown ELSE GA.GlAccountKey END, -- GlAccountKey,
	CASE WHEN S.SourceKey IS NULL THEN @SourceKeyUnknown ELSE S.SourceKey END, -- SourceKey,
	CASE WHEN
		ISNULL(FDJobCode.FunctionalDepartmentKey, FD.FunctionalDepartmentKey) IS NULL
		THEN
			@FunctionalDepartmentKeyUnknown
		ELSE
			ISNULL(FDJobCode.FunctionalDepartmentKey, FD.FunctionalDepartmentKey) END,	-- FunctionalDepartmentKey,
	CASE WHEN R.ReimbursableCode IS NULL THEN @ReimbursableKeyUnknown ELSE R.ReimbursableKey END, -- ReimbursableKey,
	CASE WHEN AT.ActivityTypeKey IS NULL THEN @ActivityTypeKeyUnknown ELSE AT.ActivityTypeKey END, -- ActivityTypeKey,
	CASE WHEN PF.PropertyFundKey IS NULL THEN @PropertyFundKeyUnknown ELSE PF.PropertyFundKey END, -- PropertyFundKey,
	CASE WHEN AR.AllocationRegionKey IS NULL THEN @AllocationRegionKeyUnknown ELSE AR.AllocationRegionKey END, -- AllocationRegionKey,
	CASE WHEN
		PS.IsExpense = 1
		THEN
			CASE WHEN
				ORR.OriginatingRegionKey IS NULL
			THEN
				@OriginatingRegionKeyUnknown
			ELSE
				ORR.OriginatingRegionKey
			END
		ELSE
			CASE WHEN
				ORRFee.OriginatingRegionKey IS NULL
			THEN
				@OriginatingRegionKeyUnknown
			ELSE
				ORRFee.OriginatingRegionKey
			END
	END, -- OriginatingRegionKey,
	CASE WHEN O.OverheadKey IS NULL THEN @OverheadKeyUnknown ELSE O.OverheadKey END, -- OverheadKey,
	CASE WHEN FA.FeeAdjustmentKey IS NULL THEN @FeeAdjustmentKeyUnknown ELSE FA.FeeAdjustmentKey END, -- FeeAdjustmentKey,
	CASE WHEN C.CurrencyKey IS NULL THEN @LocalCurrencyKeyUnknown ELSE C.CurrencyKey END, -- LocalCurrencyKey,
	PS.BudgetAmount, -- LocalBudget,
	PS.ReferenceCode, -- ReferenceCode,
	PS.BudgetId, -- BudgetId,
	--@SourceSystemId, -- SourceSystemId
	PS.IsExpense,
	PS.ReforecastKey
FROM
	#ProfitabilitySource PS

	LEFT OUTER JOIN GrReporting.dbo.GlAccount GA ON
		PS.GLGlobalAccountId = GA.GLGlobalAccountId AND
		PS.SnapshotId = GA.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.[Source] S ON
		PS.SourceCode = S.SourceCode 

	LEFT OUTER JOIN GrReporting.dbo.Reimbursable R ON
		PS.Reimbursable = R.ReimbursableCode 
		

	LEFT OUTER JOIN GrReporting.dbo.ActivityType AT ON
		PS.ActivityTypeId = AT.ActivityTypeId AND
		PS.SnapshotId = AT.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.PropertyFund PF ON
		PS.PropertyFundId = PF.PropertyFundId AND
		PS.SnapshotId = PF.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion AR ON
		PS.AllocationSubRegionGlobalRegionId = AR.GlobalRegionId AND 
		PS.SnapshotId = AR.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion ORRFee ON -- For fee income, allocation region = originating region
		PS.AllocationSubRegionGlobalRegionId = ORRFee.GlobalRegionId AND
		PS.SnapshotId = ORRFee.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion ORR ON
		PS.OriginatingGlobalRegionId = ORR.GlobalRegionId AND
		PS.SnapshotId = ORR.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.Currency C ON
		PS.LocalCurrencyCode = C.CurrencyCode
	
	LEFT OUTER JOIN GrReporting.dbo.Overhead O ON
		PS.UnallocatedOverhead = O.OverheadCode 
		
	
	LEFT OUTER JOIN GrReporting.dbo.FeeAdjustment FA ON
		PS.FeeAdjustment = FA.FeeAdjustmentCode 

	-- Detail/Sub Level (Job Code) -- job code is stored as SubFunctionalDepartment in GrReporting.dbo.FunctionalDepartment
	LEFT OUTER JOIN (
						SELECT
							FunctionalDepartmentKey,
							FunctionalDepartmentCode,
							FunctionalDepartmentName,
							SubFunctionalDepartmentCode,
							SubFunctionalDepartmentName
						FROM
							GrReporting.dbo.FunctionalDepartment
						WHERE
							FunctionalDepartmentCode <> SubFunctionalDepartmentCode
							
	) FDJobCode ON
		PS.JobCode = FDJobCode.SubFunctionalDepartmentCode AND
		PS.FunctionalDepartmentCode = FDJobCode.FunctionalDepartmentCode 
		

	-- Parent Level
	LEFT OUTER JOIN (
						SELECT
							FunctionalDepartmentKey,
							FunctionalDepartmentCode,
							FunctionalDepartmentName,
							SubFunctionalDepartmentCode,
							SubFunctionalDepartmentName
						FROM
							GrReporting.dbo.FunctionalDepartment
						WHERE
							SubFunctionalDepartmentCode = FunctionalDepartmentCode
	) FD ON
		PS.FunctionalDepartmentCode = FD.FunctionalDepartmentCode

WHERE
	PS.BudgetAmount <> 0

PRINT (''Rows inserted into #ProfitabilityReforecast: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(MILLISECOND, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

PRINT (''Creating Unique INDEX  IX_ProfitibilityRecforecast1 on #ProfitabilityReforecast on ReferenceCode'')
SET @StartTime = GETDATE()
CREATE UNIQUE CLUSTERED INDEX IX_ProfitibilityRecforecast1 ON #ProfitabilityReforecast (ReferenceCode)
PRINT (''Created Unique INDEX  IX_ProfitibilityRecforecast1 on #ProfitabilityReforecast '')
PRINT (CONVERT(VARCHAR(27), DATEDIFF(MILLISECOND, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))




-- ==============================================================================================================================================
-- Update #ProfitibilityReforecast.GlobalGlAccountCategoryKey
-- ==============================================================================================================================================

--select * from #ProfitabilitySource

SET @StartTime = GETDATE()

UPDATE
	#ProfitabilityReforecast
SET
	GlobalGlAccountCategoryKey = CASE WHEN GLAC.GlAccountCategoryKey IS NULL THEN @GlobalGlAccountCategoryKeyUnknown ELSE GLAC.GlAccountCategoryKey END
FROM #ProfitabilityReforecast Gl

	LEFT OUTER JOIN #GLAccountCategoryMapping GLACM ON
		Gl.GlAccountKey = GLACM.GlAccountKey AND
		Gl.SnapshotId = GLACM.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.GlAccountCategory GLAC ON
		Gl.CalendarKey BETWEEN GLAC.StartDate AND GLAC.EndDate AND
		GLAC.GlobalGlAccountCategoryCode =  CONVERT(VARCHAR(32),
											CONVERT(VARCHAR(8), GLACM.GLTranslationTypeId) + '':'' + 
											CONVERT(VARCHAR(8), GLACM.GLTranslationSubTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLMajorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLMinorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLAccountTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLAccountSubTypeId)) AND
		Gl.SnapshotId = GLAC.SnapshotId

PRINT (''Rows updated from #ProfitibilityReforecast.GlobalGlAccountCategoryKey: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(MILLISECOND, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- ==============================================================================================================================================
-- Delete budgets to insert that have UNKNOWNS in their mapping
-- ==============================================================================================================================================

SET @StartTime = GETDATE()

-- Delete all existing GBS records from dbo.ProfitabilityBudgetUnknowns
DELETE
FROM
	dbo.ProfitabilityReforecastUnknowns
WHERE
	BudgetReforecastTypeKey IN (@ReforecastTypeIsGBSBUDKey, @ReforecastTypeIsGBSActKey) -- Only delete GBS records, leave TAPAS records

PRINT (''Rows deleted from ProfitabilityReforecastUnknowns: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

SET @StartTime = GETDATE()

INSERT INTO dbo.ProfitabilityReforecastUnknowns (
	ImportBatchId,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	EUCorporateGlAccountCategoryKey,
	USPropertyGlAccountCategoryKey,
	USFundGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,
	GlobalGlAccountCategoryKey,
	BudgetId,
	--SourceSystemId,
	OverheadKey,
	FeeAdjustmentKey,
	BudgetReforecastTypeKey,
	SnapshotId
)
SELECT
	ImportBatchId,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	EUCorporateGlAccountCategoryKey,
	USPropertyGlAccountCategoryKey,
	USFundGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,
	GlobalGlAccountCategoryKey,
	BudgetId,
	--SourceSystemId,
	OverheadKey,
	FeeAdjustmentKey,
	BudgetReforecastTypeKey,
	SnapshotId
FROM
	#ProfitabilityReforecast

WHERE
	GlAccountKey = @GlAccountKeyUnknown OR
	SourceKey = @SourceKeyUnknown OR
	(FunctionalDepartmentKey = @FunctionalDepartmentKeyUnknown AND IsExpense = 1) OR	
	ReimbursableKey = @ReimbursableKeyUnknown OR
	ActivityTypeKey = @ActivityTypeKeyUnknown OR
	PropertyFundKey = @PropertyFundKeyUnknown OR
	AllocationRegionKey = @AllocationRegionKeyUnknown OR
	OriginatingRegionKey = @OriginatingRegionKeyUnknown OR
	FeeAdjustmentKey = @FeeAdjustmentKeyUnknown OR
	LocalCurrencyKey = @LocalCurrencyKeyUnknown OR
	GlobalGlAccountCategoryKey = @GlobalGlAccountCategoryKeyUnknown
	-- LocalBudget
	-- OverheadKey: always UNKNOWN for Fees, UNKNOWN from non-payroll if Activity Type code <> CORPOH
	-- CalendarKey: not required to check if UNKNOWN or NULL because CalendarKey is hard-coded	
	-- ReferenceCode: not required to check if UNKNOWN or NULL because CalendarKey is hard-coded
	-- BudgetId: This field is sourced directly from GBS.Budget and cannot be NULL (has a ''not null'' dbase constraint in source system)
	-- SourceSystemId

DECLARE @RowsInserted INT = @@rowcount
PRINT (''Rows inserted into ProfitabilitReforecastUnknowns: '' + CONVERT(VARCHAR(10),@RowsInserted))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--------------------------------------------------
---  BUILD Unknown Budgets
--------------------------------------------------
SET @StartTime = GETDATE()

SELECT DISTINCT
	PRU.ImportBatchId,
	B.SnapshotId, 
	B.BudgetId,
	B.ImportKey,
	PRU.BudgetReforecastTypeKey
INTO
   #BudgetsWithUnknownBudgets
FROM 
   dbo.ProfitabilityReforecastUnknowns  PRU
   INNER JOIN #Budget B ON
		B.SnapshotId = PRU.SnapshotId AND
		B.BudgetId = PRU.BudgetId 
WHERE
  PRU.BudgetReforecastTypeKey = @ReforecastTypeIsGBSBudKey

DECLARE @RowsToDeleteFromPRBudgets INT = @@rowcount

PRINT (''Rows inserted into #BudgetsWithUnknownBudgets: '' + CONVERT(VARCHAR(10),@RowsToDeleteFromPRBudgets))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--------------------------------------------------
---  BUILD Unknown Actuals
--------------------------------------------------

SET @StartTime = GETDATE()

SELECT DISTINCT
	PRU.ImportBatchId,
	B.SnapshotId, 
	B.BudgetId,
	B.ImportKey,
	PRU.BudgetReforecastTypeKey
INTO
   #BudgetsWithUnknownActuals
FROM 
   dbo.ProfitabilityReforecastUnknowns  PRU
   INNER JOIN #Budget B ON
		B.SnapshotId = PRU.SnapshotId AND
		B.BudgetId = PRU.BudgetId 
	
WHERE
  PRU.BudgetReforecastTypeKey = @ReforecastTypeIsGBSActKey

DECLARE @RowsToDeleteFromPRActuals INT = @@rowcount
PRINT (''Rows inserted into #BudgetsWithUnknownActuals: '' + CONVERT(VARCHAR(10),@RowsToDeleteFromPRActuals))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
  
--------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------------------------------
---  BUILD ALL Unknown Budgets - Now merge them into one unique budget set and these are all budgets that need deleting
------------------------------------------------------------------------------------------------------------------------------------------------------
SET @StartTime = GETDATE()

SELECT 
   BUA.ImportBatchId,
   BUA.SnapshotId, 
   BUA.BudgetId,
   BUA.ImportKey
INTO 
	#AllUnknownBudgets
FROM 
	#BudgetsWithUnknownActuals BUA
	INNER JOIN #BudgetsWithUnknownBudgets BUB ON
		BUB.BudgetId = BUA.BudgetId AND
		BUB.SnapshotId = BUA.SnapshotId AND
		BUB.ImportKey = BUA.ImportKey		
   
PRINT (''Rows INSERTED INTO #AllUnknownBudgets that have Unknowns: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
   

--------------------------------------------------


IF (@RowsInserted > 0)
BEGIN
	PRINT (''Oh no - there are '' + CONVERT(VARCHAR(10), @RowsInserted) + '' unknowns in #ProfitibilityReforecast. They have been inserted into dbo.ProfitabilityBudgetUnknowns.'')
	PRINT (''Deleting records associated with budgets that have unknowns...'')
	
	PRINT ''WARNING WARNING: DELETE UNKNOWNS COMMENTED OUT''
	/*	
	INSERT INTO @ImportErrorTable (Error) SELECT ''Unknowns''
	
	IF @RowsToDeleteFromPRBudgets > 0 BEGIN
	    INSERT INTO @ImportErrorTable (Error) SELECT ''Unknown Budgets''
	END
	IF @RowsToDeleteFromPRActuals > 0 BEGIN
	    INSERT INTO @ImportErrorTable (Error) SELECT ''Unknown Actuals''
	END	
	
	
	---------------- Delete the unknown budget portions
	SET @StartTime = GETDATE()

	DELETE
		PR
	FROM
		#ProfitabilityReforecast PR
		INNER JOIN #BudgetsWithUnknownBudgets AUB ON
		  PR.BudgetId = AUB.BudgetId AND
		  PR.SnapshotId = AUB.SnapshotId AND
		  PR.BudgetReforecastTypeKey = AUB.BudgetReforecastTypeKey
	  
	PRINT (''Rows DELETED from #ProfitabilityReforecast that have Unknown Budgets: '' + CONVERT(VARCHAR(10),@@rowcount))
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

	---------------- Delete the unknown actual portions
	SET @StartTime = GETDATE()

	
	
	DELETE 
		PR
	FROM 
		#ProfitabilityReforecast PR
		INNER JOIN #BudgetsWithUnknownActuals AUB ON
		  PR.BudgetId = AUB.BudgetId AND
		  PR.SnapshotId = AUB.SnapshotId AND
		  PR.BudgetReforecastTypeKey = AUB.BudgetReforecastTypeKey		  
	
	
	PRINT (''Rows DELETED from #ProfitabilityReforecast that have Unknown Actuals: '' + CONVERT(VARCHAR(10),@@rowcount))
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
	
	SET @StartTime = GETDATE()	
    
	DECLARE @BudgetsWithUnknowns AS GBSBudgetImportBatchType
	INSERT INTO 
		@BudgetsWithUnknowns (
			ImportBatchId,
			BudgetId,
			ImportKey
		)	
	SELECT 
			ImportBatchId,
			BudgetId,
			ImportKey
	FROM
		#AllUnknownBudgets
		
	PRINT (''Rows INSERTED INTO @BudgetsWithUnknowns That are all Unknown: '' + CONVERT(VARCHAR(10),@@rowcount))
	PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
		
	
	-- delete these budgets and their associated data from GrReportingStaging
	-- EXEC dbo.stp_D_GBSBudget @BudgetsWithUnknowns

	--PRINT (''Deleting GrReportingStaging GBS records associated with budgets that have unknowns: '' + LTRIM(RTRIM(STR(@@rowcount))) + '' (completed)'')
	*/
END

-- ==============================================================================================================================================
-- Delete existing Reforecasts that we are about to insert
-- ==============================================================================================================================================

/*CREATE TABLE #ReforecastsToImportOriginal( -- an original copy of the Reforecasts that are to be imported is kept here - the Reforecasts in the table below will be deleted during insertion into the warehouse
	BudgetId INT NOT NULL
)*/

CREATE TABLE #ReforecastsToImport(
	BudgetId INT NOT NULL
)
INSERT INTO #ReforecastsToImport
SELECT DISTINCT
	BudgetId
FROM
	#ProfitabilityReforecast


/*INSERT INTO #ReforecastsToImportOriginal
SELECT DISTINCT
	BudgetId
FROM
	#ProfitabilityReforecast*/


/*
SELECT DISTINCT
	BudgetId
FROM
	#RecorecastsBudgetsToImportOnly
WHERE 
	BudgetReforecastTypeKey = @ReforecastTypeIsGBSBudKey

SELECT DISTINCT
	BudgetId
FROM
	#RecorecastsActualsToImportOnly
WHERE 
	BudgetReforecastTypeKey = @ReforecastTypeIsGBSActKey
*/
SET @StartTime = GETDATE()

DECLARE @ReforecastId int = -1
DECLARE @LoopCount int = 0 -- Infinite loop safe guard
DECLARE @TotalDeleteCount INT = 0
WHILE (EXISTS (SELECT TOP 1 BudgetId FROM #ReforecastsToImport) AND @LoopCount < 100000)
BEGIN
	
	SET @LoopCount = @LoopCount + 1
	
	SET @ReforecastId = (SELECT TOP 1 BudgetId FROM #ReforecastsToImport)

	DECLARE @row Int = 1
	DECLARE @deleteCnt Int = 0
	WHILE (@row > 0)
		BEGIN
		
			DELETE TOP (100000) -- Remove old facts
			FROM
				GrReporting.dbo.ProfitabilityReforecast 
			WHERE
				BudgetId = @ReforecastId AND
				BudgetReforecastTypeKey in (@ReforecastTypeIsGBSBUDKey, @ReforecastTypeIsGBSACTKey)
				--SourceSystemId = @SourceSystemId
			
			SET @row = @@rowcount
			SET @deleteCnt = @deleteCnt + @row
			SET @TotalDeleteCount = @TotalDeleteCount + @row
			
			PRINT ''Deleted OLD rows from dbo.ProfitabilityReforecast >>>:''+CONVERT(VARCHAR(10),@row)
			PRINT CONVERT(VARCHAR(27), getdate(), 121)
		
		END
		
	PRINT ''Rows Deleted FOR BudgetID ('' + STR(@ReforecastId) + '') FROM  ProfitabilityReforecast:''+CONVERT(VARCHAR(10),@deleteCnt)
	
	PRINT CONVERT(VARCHAR(27), GETDATE(), 121)
	
	DELETE FROM #ReforecastsToImport WHERE BudgetId = @ReforecastId
	
	PRINT ''Rows Deleted from #DeletingReforecast:''+CONVERT(VARCHAR(10),@@ROWCOUNT)
	PRINT CONVERT(VARCHAR(27), GETDATE(), 121)
	
END
PRINT ''TOTAL Rows Deleted from ProfitabilityReforecast:''+CONVERT(char(10),@TotalDeleteCount)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



-- ==============================================================================================================================================
-- Insert budget records into GrReporting.dbo.ProfitabilityBudget
-- ==============================================================================================================================================

------------------------------------------------ DEBUG MODE ----------------------------------------
if @DebugMode = 1 BEGIN
	DECLARE @DebugMaxReforecastIdBefore INT = (SELECT MAX(ProfitabilityReforecastKey) from GrReporting.dbo.ProfitabilityReforecast)
	DECLARE @DebugDuplicateReferenceCodesBefore INT = (
		SELECT TOP 1
			COUNT(*) 
		FROM
			GrReporting.dbo.ProfitabilityReforecast PR
			INNER JOIN #Budget B ON
				B.BudgetId = PR.BudgetId AND
				B.SnapshotId = PR.SnapshotId
		GROUP BY 
			PR.ReferenceCode			
	)
END

INSERT INTO GrReporting.dbo.ProfitabilityReforecast
(
    SnapshotId,
	BudgetReforecastTypeKey,
    ReforecastKey,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId,
	--SourceSystemId,
	
	EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,

	USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey
)
SELECT
    SnapshotId,
	BudgetReforecastTypeKey,
    ReforecastKey,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalReforecast,
	ReferenceCode,
	BudgetId,
	--SourceSystemId,
	
	@EUCorporateGlAccountCategoryKeyUnknown, --EUCorporateGlAccountCategoryKey,
	@EUPropertyGlAccountCategoryKeyUnknown, --EUPropertyGlAccountCategoryKey,
	@EUFundGlAccountCategoryKeyUnknown, --EUFundGlAccountCategoryKey,

	@USPropertyGlAccountCategoryKeyUnknown, --USPropertyGlAccountCategoryKey,
	@USCorporateGlAccountCategoryKeyUnknown, ----USCorporateGlAccountCategoryKey,
	@USFundGlAccountCategoryKeyUnknown, --USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	@DevelopmentGlAccountCategoryKeyUnknown --DevelopmentGlAccountCategoryKey
FROM 
	#ProfitabilityReforecast

DECLARE @RowsInsertedIntoProfitabilityReforecastWH INT = @@ROWCOUNT
PRINT ''Rows Inserted into GrReporting.dbo.ProfitabilityReforecast:''+CONVERT(VARCHAR(10),@RowsInsertedIntoProfitabilityReforecastWH)
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

------------------------------------------------ DEBUG MODE ----------------------------------------
IF @DebugMode = 1 BEGIN
	DECLARE @DebugMaxReforecastIdAfter INT = (SELECT MAX(ProfitabilityReforecastKey) from GrReporting.dbo.ProfitabilityReforecast)

	DECLARE @DebugDuplicateReferenceCodesAfter INT = (
		SELECT TOP 1
			COUNT(*) 
		FROM
			GrReporting.dbo.ProfitabilityReforecast PR
			INNER JOIN #Budget B ON
				B.BudgetId = PR.BudgetId AND
				B.SnapshotId = PR.SnapshotId
		GROUP BY 
			PR.ReferenceCode			
	)
	DECLARE @DebugDuplicateReferenceCodesDelta INT = @DebugDuplicateReferenceCodesAfter - @DebugDuplicateReferenceCodesBefore
	
	IF (@DebugDuplicateReferenceCodesDelta <> 0) BEGIN
		PRINT ''Number Of Duplicate ReferenceCodes DELTA = '' + STR(@DebugDuplicateReferenceCodesDelta)
	    PRINT ''WARNING!!: Some duplicate reference codes may be inserted''
	END
	DECLARE @DebugNewProfitabilityReforecastKeyCount INT = (
		SELECT COUNT(*) FROM GrReporting.dbo.ProfitabilityReforecast where (ProfitabilityReforecastKey > @DebugMaxReforecastIdBefore AND ProfitabilityReforecastKey <= @DebugMaxReforecastIdAfter)
	)
	DECLARE @RowsInsertedIntoProfitabilityReforecastWHNewPRKeyCountDelta INT =  @RowsInsertedIntoProfitabilityReforecastWH - @DebugNewProfitabilityReforecastKeyCount
	IF @RowsInsertedIntoProfitabilityReforecastWHNewPRKeyCountDelta <> 0 BEGIN
		PRINT ''WARNING: Max ProfitabilityReforecastKey count does not match the insertions (POSSIBLY concurrent inserts happened?) DELTA: '' + STR(@RowsInsertedIntoProfitabilityReforecastWHNewPRKeyCountDelta)
	END	
	ELSE  BEGIN
	   PRINT ''Max ProfitabilityReforecastKey matches count of insertions''
	END
END
--------------------------------------------------------------------------------------------------------

-- ==============================================================================================================================================
-- Mark budgets as being successfully processed into the warehouse
-- ==============================================================================================================================================

DECLARE @ImportErrorText VARCHAR(500)
SELECT @ImportErrorText = COALESCE(@ImportErrorText + '', '', '''') + Error from @ImportErrorTable

BEGIN TRY		

	SELECT
		--- Note Slight reverse logic from originally, original it looked if there are anything left in the temp table, now it looks:
		--- IS THERE ANYTHING THAT WAS UNKNOWN for Budgets and Actuals Seperately
		BTP.BudgetsToProcessId,
		CASE WHEN BWUB.BudgetId IS NULL THEN 1 ELSE 0 END AS ReforecastBudgetsProcessedIntoWarehouse, -- 0 if import fails, 1 if import succeeds
		CASE WHEN BWUA.BudgetId IS NULL THEN 1 ELSE 0 END AS ReforecastActualsProcessedIntoWarehouse, -- 0 if import fails, 1 if import succeeds
		@ImportErrorText AS ReasonForFailure,
		GETDATE() AS DateBudgetProcessedIntoWarehouse-- date that the buget import either failed or succeeded (depending on 0 or 1 above)
	INTO 
		#BudgetsToProcessToUpdate
	FROM
		dbo.BudgetsToProcess BTP
		INNER JOIN #BudgetsToProcess BTPT ON
			BTP.BudgetsToProcessId = BTPT.BudgetsToProcessId	
		
		LEFT OUTER JOIN #BudgetsWithUnknownBudgets BWUB ON
			BTP.BudgetId = BWUB.BudgetId 

		LEFT OUTER JOIN #BudgetsWithUnknownActuals BWUA ON
			BTP.BudgetId = BWUA.BudgetId 

	UPDATE
		BTP
	SET
		BTP.ReforecastBudgetsProcessedIntoWarehouse = BTPTU.ReforecastBudgetsProcessedIntoWarehouse,
		BTP.ReforecastActualsProcessedIntoWarehouse = BTPTU.ReforecastActualsProcessedIntoWarehouse,
		BTP.ReasonForFailure = BTPTU.ReasonForFailure,
		BTP.DateBudgetProcessedIntoWarehouse = BTPTU.DateBudgetProcessedIntoWarehouse
	FROM
		dbo.BudgetsToProcess BTP
		INNER JOIN #BudgetsToProcessToUpdate BTPTU ON
			BTPTU.BudgetsToProcessId = BTP.BudgetsToProcessId
		
	PRINT (''Rows updated from dbo.BudgetsToProcess: '' + CONVERT(VARCHAR(10),@@rowcount))

END TRY
BEGIN CATCH
	
	SET @ImportErrorText = NULL
		SELECT @ImportErrorText =  
			COALESCE(@ImportErrorText + '', '', '''') + 
			''BudgetsToProcessId:''+ LTRIM(STR(BTPTU.BudgetsToProcessId)) + 
			'' ReforecastBudgetsProcessedIntoWarehouse:'' + LTRIM(STR(BTPTU.ReforecastBudgetsProcessedIntoWarehouse))  +
			'' ReforecastActualsProcessedIntoWarehouse:'' + LTRIM(STR(BTPTU.ReforecastActualsProcessedIntoWarehouse))  +
			'' ReasonForFailure:'' + ReasonForFailure +
			'' DateBudgetProcessedIntoWarehouse:'' + CONVERT(VARCHAR(27), BTPTU.DateBudgetProcessedIntoWarehouse)
			
		from #BudgetsToProcessToUpdate BTPTU

	PRINT ''Error updating budgets to pricess, The Values were:''
	PRINT @ImportErrorText
	
	
    DECLARE @ErrorSeverity  INT = ERROR_SEVERITY(), @ErrorMessage NVARCHAR(4000) =
		''Error updating BudgetsToProcess: '' + CONVERT(VARCHAR(10), ERROR_NUMBER()) + '':'' + ERROR_MESSAGE() 	
    RAISERROR ( @ErrorMessage, @ErrorSeverity, 1)
END CATCH




-- ==============================================================================================================================================
-- Delete archived budgets: only keep the last three budgets - older budgets must be deleted
-- ==============================================================================================================================================

/* COMMENTED OUT FOR NOW, PLEASE REVISIT AS POTENTIAL TO SPLIT TO A DIFFERENT PROC OR RE ENABLE
DECLARE @BudgetsToDelete AS GBSBudgetImportBatchType

INSERT INTO @BudgetsToDelete
SELECT
	Budget.ImportKey,
	Budget.BudgetId,
	Budget.ImportBatchId
FROM
	GBS.Budget Budget
	LEFT OUTER JOIN (
						SELECT
							B1.*,
							B4.ranknum
						FROM
							GBS.Budget B1
							INNER JOIN (
								SELECT
									B2.ImportKey,
									COUNT(*) AS ranknum
								FROM
									GBS.Budget B2
									INNER JOIN GBS.Budget B3 ON
										B2.BudgetId = B3.BudgetId AND
										B2.ImportKey <= B3.ImportKey
								GROUP BY
									B2.ImportKey
								HAVING
									COUNT(*) <= 3 -- the number of version of a given budget that are to be archived (including the current budget)
							) B4 ON
								B1.ImportKey = B4.ImportKey
	) BudgetsToKeep ON
		Budget.ImportKey = BudgetsToKeep.ImportKey
WHERE
	BudgetsToKeep.ImportKey IS NULL

EXEC dbo.stp_D_GBSBudget @BudgetsToDelete
*/



IF 	OBJECT_ID(''tempdb..#Budget'') IS NOT NULL
    DROP TABLE #Budget

IF 	OBJECT_ID(''tempdb..#GLGlobalAccount'') IS NOT NULL
    DROP TABLE #GLGlobalAccount

IF 	OBJECT_ID(''tempdb..#GLTranslationSubType'') IS NOT NULL
    DROP TABLE #GLTranslationSubType

IF 	OBJECT_ID(''tempdb..#GLGlobalAccountTranslationSubType'') IS NOT NULL
    DROP TABLE #GLGlobalAccountTranslationSubType
    
IF 	OBJECT_ID(''tempdb..#GLMinorCategory'') IS NOT NULL
    DROP TABLE #GLMinorCategory
    
IF 	OBJECT_ID(''tempdb..#GLMajorCategory'') IS NOT NULL
    DROP TABLE #GLMajorCategory

IF 	OBJECT_ID(''tempdb..#GLGlobalAccountTranslationType'') IS NOT NULL
    DROP TABLE #GLGlobalAccountTranslationType

IF 	OBJECT_ID(''tempdb..#ReportingEntityCorporateDepartment'') IS NOT NULL
    DROP TABLE #ReportingEntityCorporateDepartment

IF 	OBJECT_ID(''tempdb..#PropertyFund'') IS NOT NULL
    DROP TABLE #PropertyFund

IF 	OBJECT_ID(''tempdb..#ActivityType'') IS NOT NULL
    DROP TABLE #ActivityType

IF 	OBJECT_ID(''tempdb..#CorporateDepartment'') IS NOT NULL
    DROP TABLE #CorporateDepartment

IF 	OBJECT_ID(''tempdb..#FunctionalDepartment'') IS NOT NULL
    DROP TABLE #FunctionalDepartment

IF 	OBJECT_ID(''tempdb..#AllocationSubRegion'') IS NOT NULL
    DROP TABLE #AllocationSubRegion

IF 	OBJECT_ID(''tempdb..#GLAccountCategoryMapping'') IS NOT NULL
    DROP TABLE #GLAccountCategoryMapping

IF 	OBJECT_ID(''tempdb..#ProfitabilitySource'') IS NOT NULL
    DROP TABLE #ProfitabilitySource

IF 	OBJECT_ID(''tempdb..#ProfitabilityBudget'') IS NOT NULL
    DROP TABLE #ProfitabilityBudget

IF 	OBJECT_ID(''tempdb..#BudgetsToImport'') IS NOT NULL
    DROP TABLE #BudgetsToImport

IF 	OBJECT_ID(''tempdb..#BudgetsToImportOriginal'') IS NOT NULL
	DROP TABLE #BudgetsToImportOriginal

IF 	OBJECT_ID(''tempdb..#BudgetsToDelete'') IS NOT NULL
    DROP TABLE #BudgetsToDelete

IF 	OBJECT_ID(''tempdb..#CorporatePropertySourceCodes'') IS NOT NULL
    DROP TABLE #CorporatePropertySourceCodes

IF 	OBJECT_ID(''tempdb..#BudgetsWithUnknowns'') IS NOT NULL
    DROP TABLE #BudgetsWithUnknowns


IF 	OBJECT_ID(''tempdb..#FunctionalDepartment'') IS NOT NULL
    DROP TABLE #FunctionalDepartment

IF 	OBJECT_ID(''tempdb..#Actuals'') IS NOT NULL
    DROP TABLE #Actuals

IF 	OBJECT_ID(''tempdb..#BudgetsWithUnknownBudgets'') IS NOT NULL
    DROP TABLE #BudgetsWithUnknownBudgets

IF 	OBJECT_ID(''tempdb..#BudgetsWithUnknownActuals'') IS NOT NULL
    DROP TABLE #BudgetsWithUnknownActuals

IF 	OBJECT_ID(''tempdb..#AllUnknownBudgets'') IS NOT NULL
    DROP TABLE #AllUnknownBudgets

IF 	OBJECT_ID(''tempdb..#BudgetsToProcess'') IS NOT NULL
    DROP TABLE #BudgetsToProcess

IF 	OBJECT_ID(''tempdb..#BudgetsToProcessToUpdate'') IS NOT NULL
    DROP TABLE #BudgetsToProcessToUpdate



' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyGBSBudget]    Script Date: 05/16/2011 08:15:51 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyGBSBudget]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'


CREATE PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyGBSBudget]

AS

PRINT ''####''
PRINT ''stp_IU_LoadGrProfitabiltyGBSBudget''
PRINT ''####''
DECLARE @RowCount INT
DECLARE @StartTime DATETIME = GETDATE()
DECLARE @CanImportGBSBudget INT = (SELECT ConfiguredValue FROM [GrReportingStaging].[dbo].[SSISConfigurations] WHERE ConfigurationFilter = ''CanImportGBSBudget'')

IF (@CanImportGBSBudget <> 1)
BEGIN
	PRINT (''Import of GBS Budget is not scheduled in GrReportingStaging.dbo.SSISConfigurations'')
	RETURN
END

SET @StartTime = GETDATE()


-- ==============================================================================================================================================
-- Get Budgets to Process
-- ==============================================================================================================================================

SELECT 
	BTPC.*, 
	Reforecast.ReforecastKey
INTO 
	#BudgetsToProcess 
FROM 
	dbo.[BudgetsToProcessCurrent](''GBS Budget/Reforecast'') BTPC
	
	INNER JOIN
	(
		SELECT
			MIN(ReforecastKey) AS ReforecastKey, -- ReforecastKey and ReforecastEffectivePeriod have the same ordering. ReforecastKey is computed
			ReforecastEffectiveYear				 -- the same as CalendarKey, and is therefore date-based
		FROM
			GrReporting.dbo.Reforecast
		WHERE
			ReforecastQuarterName = ''Q0'' -- This is the original budget stored procedure; we can therefore hard-code ''Q0''
		GROUP BY
			ReforecastEffectiveYear
	) Reforecast ON
		BTPC.BudgetYear = Reforecast.ReforecastEffectiveYear
WHERE 
	IsReforecast = 0 -- This stored procedure handles original GBS budgets only (and not reforecasts)

------------------------

DECLARE @BTPRowCount INT = @@rowcount
PRINT (''Rows inserted into #BudgetsToProcess: '' + CONVERT(VARCHAR(10),@BTPRowCount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

IF (@BTPRowCount = 0)
BEGIN
	PRINT (''*******************************************************'')
	PRINT (''	stp_IU_LoadGrProfitabiltyGBSBudget is quitting because there are no GBS BudgetsToProcess set to be imported.'')
	PRINT (''*******************************************************'')
	RETURN
END

-- ==============================================================================================================================================
-- Declare Local Variables
-- ==============================================================================================================================================

DECLARE @GlAccountKeyUnknown			INT = (SELECT GlAccountKey FROM GrReporting.dbo.GlAccount WHERE Code = ''UNKNOWN'')
DECLARE	@SourceKeyUnknown				INT = (SELECT SourceKey FROM GrReporting.dbo.Source WHERE SourceName = ''UNKNOWN'')
DECLARE	@FunctionalDepartmentKeyUnknown	INT = (SELECT FunctionalDepartmentKey FROM GrReporting.dbo.FunctionalDepartment WHERE FunctionalDepartmentCode = ''UNKNOWN'')
DECLARE	@ReimbursableKeyUnknown			INT = (SELECT ReimbursableKey FROM GrReporting.dbo.Reimbursable WHERE ReimbursableCode = ''UNKNOWN'')
DECLARE	@ActivityTypeKeyUnknown			INT = (SELECT ActivityTypeKey FROM GrReporting.dbo.ActivityType WHERE ActivityTypeCode = ''UNKNOWN'')
DECLARE	@PropertyFundKeyUnknown			INT = (SELECT PropertyFundKey FROM GrReporting.dbo.PropertyFund WHERE PropertyFundName = ''UNKNOWN'')
DECLARE	@AllocationRegionKeyUnknown		INT = (SELECT AllocationRegionKey FROM GrReporting.dbo.AllocationRegion WHERE RegionCode = ''UNKNOWN'')
DECLARE	@OriginatingRegionKeyUnknown	INT = (SELECT OriginatingRegionKey FROM GrReporting.dbo.OriginatingRegion WHERE RegionCode = ''UNKNOWN'')
DECLARE	@OverheadKeyUnknown				INT = (SELECT OverheadKey FROM GrReporting.dbo.Overhead WHERE OverheadCode = ''UNKNOWN'')
DECLARE	@LocalCurrencyKeyUnknown		INT = (SELECT CurrencyKey FROM GrReporting.dbo.Currency WHERE CurrencyCode = ''UNKNOWN'')
DECLARE	@FeeAdjustmentKeyUnknown		INT = (SELECT FeeAdjustmentKey FROM GrReporting.dbo.FeeAdjustment WHERE FeeAdjustmentCode = ''UNKNOWN'')--,
--	@CanImportCorporateBudget	INT = (SELECT ConfiguredValue FROM GrReportingStaging.dbo.SSISConfigurations WHERE ConfigurationFilter = ''CanImportCorporateBudget'')

DECLARE @EUFundGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE @EUCorporateGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@EUPropertyGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@USFundGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@USPropertyGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@USCorporateGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@DevelopmentGlAccountCategoryKeyUnknown	INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''Development Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
DECLARE	@GlobalGlAccountCategoryKeyUnknown		INT = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global'' AND TranslationSubTypeName = ''Global'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')

DECLARE @BudgetReforecastTypeKey INT = (SELECT TOP 1 BudgetReforecastTypeKey FROM GrReporting.dbo.BudgetReforecastType WHERE BudgetReforecastTypeCode = ''GBSBUD'')

-- There could be up to three copies of the same GBS data due to three seperate imports, so work with latest GBS import which should have the
-- highest ImportBatchId.

--DECLARE @ImportBatchId INT = (SELECT MAX(BatchId) FROM dbo.Batch WHERE PackageName = ''ETL.Staging.GBS'')
DECLARE @ImportErrorTable TABLE (
	Error varchar(50)
);

-- ==============================================================================================================================================
-- Source Budget data from GBS
-- ==============================================================================================================================================

CREATE TABLE #BudgetsWithUnknownBudgets(
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	BudgetId INT NOT NULL
)

--SELECT * FROM #BudgetsToProcess
	
SET @StartTime = GETDATE()

CREATE TABLE #Budget(
	ReforecastKey INT NOT NULL,
	ImportKey INT NOT NULL,
	ImportBatchId INT NOT NULL,
	BudgetId INT NOT NULL,
	BudgetAllocationSetId INT NOT NULL,
	BudgetReportGroupPeriodId INT NOT NULL,
	BudgetExchangeRateId INT NOT NULL,
	BudgetStatusId INT NOT NULL,
	CreatorStaffId INT NOT NULL,
	Name VARCHAR(50) NOT NULL,
	HealthyTensionStartDate DATETIME NOT NULL,
	HealthyTensionEndDate DATETIME NOT NULL,
	LastLockedDate DATETIME NULL,
	PriorBudgetId INT NULL,
	IsReforecast BIT NOT NULL,
	CopiedFromBudgetId INT NULL,
	ImportBudgetIntoGR BIT NOT NULL,
	LastImportBudgetIntoGRDate DATETIME NULL,
	SnapshotId INT NOT NULL
)
INSERT INTO #Budget
SELECT
	BTP.ReforecastKey,
	Budget.ImportKey,
	Budget.ImportBatchId,
	Budget.BudgetId,
	Budget.BudgetAllocationSetId,
	Budget.BudgetReportGroupPeriodId,
	Budget.BudgetExchangeRateId,
	Budget.BudgetStatusId,
	Budget.CreatorStaffId,
	Budget.Name,
	Budget.HealthyTensionStartDate,
	Budget.HealthyTensionEndDate,
	Budget.LastLockedDate,
	Budget.PriorBudgetId,
	Budget.IsReforecast,
	Budget.CopiedFromBudgetId,
	Budget.ImportBudgetIntoGR,
	Budget.LastImportBudgetIntoGRDate,
	BTP.SnapshotId
FROM
	GBS.Budget Budget
	
	INNER JOIN #BudgetsToProcess BTP ON -- All GBS budgets in dbo.BudgetsToProcess must be considered because they are to be processed into the warehouse
		Budget.BudgetId = BTP.BudgetId AND
		Budget.ImportBatchId = BTP.ImportBatchId
		
WHERE
	Budget.IsActive = 1
	
DECLARE @BudgetRowCount INT = @@rowcount

CREATE UNIQUE CLUSTERED INDEX IX_Budget ON #Budget (SnapshotId, BudgetId)

PRINT (''Rows inserted into #Budget: '' + CONVERT(VARCHAR(10),@BudgetRowCount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))



IF (@BudgetRowCount = 0)
BEGIN
	PRINT (''*******************************************************'')
	PRINT (''	stp_IU_LoadGrProfitabiltyGBSBudget is quitting because there are no GBS budgets set to be imported.'')
	PRINT (''*******************************************************'')
	RETURN
END

-- ==============================================================================================================================================
-- Source Snapshot mapping data from GDM
-- ==============================================================================================================================================

-- GLGlobalAccount --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLGlobalAccount(
	GLGlobalAccountId INT NOT NULL,
	ActivityTypeId INT NULL,
	GLStatutoryTypeId INT NOT NULL,
	ParentGLGlobalAccountId INT NULL,
	Code VARCHAR(10) NOT NULL,
	Name NVARCHAR(150) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsGR BIT NOT NULL,
	IsGbs BIT NOT NULL,
	IsRegionalOverheadCost BIT NOT NULL,
	ExpenseCzarStaffId INT NOT NULL,
	ParentCode AS (left(Code,(8))),
	SnapshotId INT NOT NULL
)
INSERT INTO #GLGlobalAccount (
	GLGlobalAccountId,
	ActivityTypeId,
	GLStatutoryTypeId,
	ParentGLGlobalAccountId,
	Code,
	Name,
	[Description],
	IsGR,
	IsGbs,
	IsRegionalOverheadCost,
	ExpenseCzarStaffId,
	SnapshotId
)
SELECT
	GLGA.GLGlobalAccountId,
	GLGA.ActivityTypeId,
	GLGA.GLStatutoryTypeId,
	GLGA.ParentGLGlobalAccountId,
	GLGA.Code,
	GLGA.Name,
	GLGA.[Description],
	GLGA.IsGR,
	GLGA.IsGbs,
	GLGA.IsRegionalOverheadCost,
	GLGA.ExpenseCzarStaffId,
	GLGA.SnapshotId
FROM
	Gdm.SnapshotGLGlobalAccount GLGA
	INNER JOIN #Budget B ON
		GLGA.SnapshotId = B.SnapshotId
WHERE
	GLGA.IsActive = 1

PRINT (''Rows inserted into #GLGlobalAccount: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLTranslationSubType -----------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLTranslationSubType (
	SnapshotId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL
)
INSERT INTO #GLTranslationSubType
SELECT
	TST.SnapshotId,
	GLTranslationSubTypeId,
	GLTranslationTypeId,
	Code
FROM
	Gdm.SnapshotGLTranslationSubType TST
	INNER JOIN #Budget B ON
		TST.SnapshotId = B.SnapshotId
WHERE
	TST.Code = ''GL'' AND -- This limits to the Global translation sub type; for multiple sub types remove this constraint and add TST.Code to SELECT
	TST.IsActive = 1

PRINT (''Rows inserted into ##GLTranslationSubType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLGlobalAccountTranslationType --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLGlobalAccountTranslationType(
	GLGlobalAccountTranslationTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #GLGlobalAccountTranslationType
SELECT
	GATT.GLGlobalAccountTranslationTypeId, 
	GATT.GLGlobalAccountId, 
	GATT.GLTranslationTypeId, 
	GATT.GLAccountTypeId,	
	CASE WHEN
			GA.ActivityTypeId = 99
		 THEN 
				-- GC :: CC1 >>
				-- Unallocated overhead expenses will be grouped under the “Overhead” expense 
				-- type and not “Non-Payroll”. This will be based on the activity of the 
				-- transaction; all transactions that have a corporate overhead activity 
				-- will have an expense type of “Overhead”.
			
			AST.GLAccountSubTypeId
			
					
		 ELSE
			GATT.GLAccountSubTypeId
	END AS GLAccountSubTypeId,
	GATT.SnapshotId
FROM
	Gdm.SnapshotGLGlobalAccountTranslationType GATT
	
	INNER JOIN #Budget B ON
		GATT.SnapshotId = B.SnapshotId	

	LEFT OUTER JOIN (
						SELECT
							GA.*
						FROM
							#GLGlobalAccount GA
							
					 ) GA ON
							GA.GLGlobalAccountId = GATT.GLGlobalAccountId AND
							GA.SnapshotId = GATT.SnapshotId
	
	LEFT OUTER JOIN (
						SELECT
							GST.GLAccountSubTypeId,
							B.BudgetId,
							gst.SnapshotId
							--GST.GLAccountSubTypeId 
						FROM
							Gdm.SnapshotGLAccountSubType GST 
							INNER JOIN Gdm.SnapshotGLTranslationType GTT ON
								GTT.GLTranslationTypeId = GST.GLTranslationTypeId
							INNER JOIN #Budget B ON
								GST.SnapshotId = B.SnapshotId AND
								GTT.SnapshotId = B.SnapshotId
						WHERE
							GTT.Code = ''GL'' AND
							GST.Code = ''GRPOHD''	AND
							GST.IsActive = 1 AND
							GTT.IsActive = 1
					) AST ON
							GATT.SnapshotId = AST.SnapshotId AND
							B.BudgetId = AST.BudgetId
	
WHERE
	GATT.IsActive = 1

PRINT (''Rows inserted into #GLGlobalAccountTranslationType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- SnapshotGLGlobalAccountTranslationSubType -------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLGlobalAccountTranslationSubType (
	SnapshotId INT NOT NULL,
	GLGlobalAccountTranslationSubTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL
)
INSERT INTO #GLGlobalAccountTranslationSubType
SELECT
	GATST.SnapshotId,
	GATST.GLGlobalAccountTranslationSubTypeId,
	GATST.GLGlobalAccountId,
	GATST.GLTranslationSubTypeId,
	GATST.GLMinorCategoryId
FROM
	Gdm.SnapshotGLGlobalAccountTranslationSubType GATST
	INNER JOIN #Budget B ON
		GATST.SnapshotId = B.SnapshotId
WHERE
	GATST.IsActive = 1

PRINT (''Rows inserted into #GLGlobalAccountTranslationSubType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLMinorCategory -----------------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLMinorCategory (
	SnapshotId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL
)
INSERT INTO #GLMinorCategory
SELECT
	MinC.SnapshotId,
	MinC.GLMinorCategoryId,
	MinC.GLMajorCategoryId
FROM
	Gdm.SnapshotGLMinorCategory MinC
	INNER JOIN #Budget B ON
		MinC.SnapshotId = B.SnapshotId
WHERE
	MinC.IsActive = 1

PRINT (''Rows inserted into #GLMinorCategory: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- GLMajorCategory ---------------------------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLMajorCategory (
	SnapshotId int NOT NULL,
	GLMajorCategoryId int NOT NULL,
	GLTranslationSubTypeId int NOT NULL
)
INSERT INTO #GLMajorCategory
SELECT
	MajC.SnapshotId,
	MajC.GLMajorCategoryId,
	MajC.GLTranslationSubTypeId
FROM
	Gdm.SnapshotGLMajorCategory MajC
	INNER JOIN #Budget B ON
		MajC.SnapshotId = B.SnapshotId
WHERE
	MajC.IsActive = 1

PRINT (''Rows inserted into #GLMajorCategory: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- ReportingEntityCorporateDepartment --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #ReportingEntityCorporateDepartment(
	ReportingEntityCorporateDepartmentId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	CorporateDepartmentCode CHAR(6) NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO	#ReportingEntityCorporateDepartment
SELECT
	RECD.ReportingEntityCorporateDepartmentId,
	RECD.PropertyFundId,
	RECD.SourceCode,
	RECD.CorporateDepartmentCode,
	RECD.SnapshotId
FROM
	Gdm.SnapshotReportingEntityCorporateDepartment RECD
	INNER JOIN #Budget B ON
		RECD.SnapshotId = B.SnapshotId
WHERE
	RECD.IsDeleted = 0

PRINT (''Rows inserted into #ReportingEntityCorporateDepartment: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- PropertyFund --------------------------------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #PropertyFund(
	PropertyFundId INT NOT NULL,
	RelatedFundId INT NULL,
	EntityTypeId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	BudgetOwnerStaffId INT NOT NULL,
	RegionalOwnerStaffId INT NOT NULL,
	DefaultGLTranslationSubTypeId INT NULL,
	Name VARCHAR(100) NOT NULL,
	IsReportingEntity BIT NOT NULL,
	IsPropertyFund BIT NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #PropertyFund
SELECT
	PF.PropertyFundId,
	PF.RelatedFundId,
	PF.EntityTypeId,
	PF.AllocationSubRegionGlobalRegionId,
	PF.BudgetOwnerStaffId,
	PF.RegionalOwnerStaffId,
	PF.DefaultGLTranslationSubTypeId,
	PF.Name,
	PF.IsReportingEntity,
	PF.IsPropertyFund,
	PF.SnapshotId
FROM
	Gdm.SnapshotPropertyFund PF
	INNER JOIN #Budget B ON
		B.SnapshotId = PF.SnapshotId
WHERE
	PF.IsActive = 1

PRINT (''Rows inserted into #PropertyFund: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- ActivityType --------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #ActivityType(
	ActivityTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO #ActivityType
SELECT
	ActivityTypeId,
	Code,
	AT.SnapshotId
FROM
	Gdm.SnapshotActivityType AT
	INNER JOIN #Budget B ON
		AT.SnapshotId = B.SnapshotId
WHERE
	AT.IsActive = 1

PRINT (''Rows inserted into #ActivityType: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Department -----------------------------------------------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #CorporateDepartment(
	Code CHAR(8) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	FunctionalDepartmentId INT NULL,
	IsTsCost BIT NULL,
	SnapshotId INT NOT NULL
)

INSERT INTO	#CorporateDepartment
SELECT
	D.Code,
	D.SourceCode,
	D.FunctionalDepartmentId,
	D.IsTsCost,
	D.SnapshotId
FROM
	Gdm.SnapshotCorporateDepartment D
	INNER JOIN #Budget B ON
		D.SnapshotId = B.SnapshotId
WHERE
	D.IsActive = 1

PRINT (''Rows inserted into #CorporateDepartment: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- FunctionalDepartment -------------------------------------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #FunctionalDepartment (
	FunctionalDepartmentId INT NOT NULL,
	Code VARCHAR(20) NULL,
	GlobalCode VARCHAR(30) NULL
)

INSERT INTO #FunctionalDepartment
SELECT
	FunctionalDepartmentId,
	Code,
	GlobalCode
FROM
	Gdm.SnapshotFunctionalDepartment FD
	INNER JOIN #Budget B ON
		FD.SnapshotId = B.SnapshotId
WHERE
	FD.IsActive = 1

PRINT (''Rows inserted into #FunctionalDepartment: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- AllocationSubRegion -----------------------------------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #AllocationSubRegion (
	SnapshotId int NOT NULL,
	AllocationSubRegionGlobalRegionId int NOT NULL,
	Code varchar(10) NOT NULL,
	Name varchar(50) NOT NULL,
	AllocationRegionGlobalRegionId int NULL,
	DefaultCorporateSourceCode char(2) NOT NULL
)
INSERT INTO #AllocationSubRegion
SELECT
	ASR.SnapshotId,
	ASR.AllocationSubRegionGlobalRegionId,
	ASR.Code,
	ASR.Name,
	ASR.AllocationRegionGlobalRegionId,
	ASR.DefaultCorporateSourceCode
FROM
	Gdm.SnapshotAllocationSubRegion ASR
	INNER JOIN #Budget B ON
		ASR.SnapshotId = B.SnapshotId
WHERE
	ASR.IsActive = 1

PRINT (''Rows inserted into #AllocationSubRegion: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Master GL Account Category mapping table -----------------------------------------------------------

SET @StartTime = GETDATE()

CREATE TABLE #GLAccountCategoryMapping (
	SnapshotId INT NOT NULL,
	GLAccountKey INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL
)
INSERT INTO #GLAccountCategoryMapping
SELECT
	Budget.SnapshotId,
	Gla.GlAccountKey,
	TST.GLTranslationTypeId,
	TST.GLTranslationSubTypeId,
	MinC.GLMajorCategoryId,
	GLATST.GLMinorCategoryId,
	GLATT.GLAccountTypeId,
	GLATT.GLAccountSubTypeId
FROM
	#Budget Budget

	INNER JOIN #GLTranslationSubType TST ON
		Budget.SnapshotId = TST.SnapshotId

	INNER JOIN #GLGlobalAccountTranslationSubType GLATST ON
		TST.GLTranslationSubTypeId = GLATST.GLTranslationSubTypeId AND
		Budget.SnapshotId = GLATST.SnapshotId
	
	INNER JOIN #GLGlobalAccountTranslationType GLATT ON
		GLATST.GLGlobalAccountId = GLATT.GLGlobalAccountId AND
		TST.GLTranslationTypeId = GLATT.GLTranslationTypeId AND
		Budget.SnapshotId = GLATT.SnapshotId

	INNER JOIN GrReporting.dbo.GlAccount Gla ON
		GLATT.GLGlobalAccountId = GLA.GLGlobalAccountId AND
		Budget.SnapshotId = Gla.SnapshotId		

	INNER JOIN #GLMinorCategory MinC ON
		GLATST.GLMinorCategoryId = MinC.GLMinorCategoryId AND
		Budget.SnapshotId = MinC.SnapshotId

	INNER JOIN #GLMajorCategory MajC ON
		MinC.GLMajorCategoryId = MajC.GLMajorCategoryId AND
		Budget.SnapshotId = MajC.SnapshotId

PRINT (''Rows inserted into #GLAccountCategoryMapping: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- Corporate Property Sources --------------------------------------------------------------------------------

CREATE TABLE #CorporatePropertySourceCodes (
	CorporateSourceCode CHAR(2) NOT NULL,
	PropertySourceCode CHAR(2) NOT NULL
)

INSERT INTO #CorporatePropertySourceCodes
SELECT
	''UC'', ''US''
UNION ALL
SELECT
	''EC'', ''EU''
UNION ALL
SELECT
	''IC'', ''IN''
UNION ALL
SELECT
	''BC'', ''BR''
UNION ALL
SELECT
	''CC'', ''CN''

-- ==============================================================================================================================================
-- Get Non-Payroll Expense Budget items from GBS
-- ==============================================================================================================================================

SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilitySource (
	ImportBatchId INT NOT NULL,
	ReforecastKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	BudgetId INT NOT NULL,
	ReferenceCode VARCHAR(300) NOT NULL,
	ExpensePeriod CHAR(6) NOT NULL,	
	SourceCode VARCHAR(2) NULL,
	BudgetAmount MONEY NOT NULL,
	GLGlobalAccountId INT NULL,
	FunctionalDepartmentCode VARCHAR(20) NULL,
	JobCode VARCHAR(20) NULL,
	Reimbursable VARCHAR(3) NULL, -- NULL because this field is determined via an outer join
	ActivityTypeId INT NULL, -- NULL because for Fees this field is determined via an outer join
	PropertyFundId INT NULL, -- NULL because this field is determined via an outer join
	AllocationSubRegionGlobalRegionId INT NULL, -- NULL because this field is determined via an outer join
	OriginatingGlobalRegionId INT NULL,
	LocalCurrencyCode CHAR(3) NOT NULL,
	LockedDate DATETIME NULL,
	IsExpense BIT NOT NULL,
	UnallocatedOverhead CHAR(7) NULL, -- NULL because this field is determined via an outer join
	FeeAdjustment VARCHAR(9) NOT NULL
)

-- Insert original budget amounts
INSERT INTO #ProfitabilitySource (
	ImportBatchId,
	ReforecastKey,
	SnapshotId,
	BudgetId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	BudgetAmount,
	GLGlobalAccountId,
	FunctionalDepartmentCode,
	JobCode,
	Reimbursable,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingGlobalRegionId,
	LocalCurrencyCode,
	LockedDate,
	IsExpense,
	UnallocatedOverhead,
	FeeAdjustment
)

SELECT
	Budget.ImportBatchId,
	Budget.ReforecastKey,
	Budget.SnapshotId,
	Budget.BudgetId, -- BudgetId
	''GBS:BudgetId='' + LTRIM(RTRIM(STR(Budget.BudgetId))) + ''&NonPayrollExpenseBreakdownId='' + LTRIM(RTRIM(STR(NPEB.NonPayrollExpenseBreakdownId))) + ''&SnapshotId='' + LTRIM(RTRIM(STR(Budget.SnapshotId))), -- ReferenceCode
	NPEB.Period, -- ExpensePeriod: Period is actually a foreign key to PeriodExtended but is also the implied period value, e.g.: 201009
	CASE WHEN NPEB.IsDirectCost = 1 THEN CPSC.PropertySourceCode ELSE NPEB.CorporateSourceCode END AS CorporateSourceCode,	
	NPEB.Amount, -- BudgetAmount
	ISNULL(NPEB.ActivitySpecificGLGlobalAccountId, NPEB.GLGlobalAccountId), -- GLGlobalAccountId
	FD.GlobalCode, -- FunctionalDepartmentCode
	NPEB.JobCode, -- JobCode
	CASE WHEN CD.IsTsCost = 0 THEN ''YES'' ELSE ''NO'' END, -- Reimbursable
	NPEB.ActivityTypeId, -- ActivityTypeId: this Id should correspond to the correct Id in GDM
	RECD.PropertyFundId, -- PropertyFundId
	PF.AllocationSubRegionGlobalRegionId, -- AllocationSubRegionGlobalRegionId
	NPEB.OriginatingSubRegionGlobalRegionId, -- OriginatingGlobalRegionId
	NPEB.CurrencyCode, -- LocalCurrencyCode
	Budget.LastLockedDate, -- LockedDate
	1, -- IsExpense
	CASE WHEN AT.Code = ''CORPOH'' THEN ''UNALLOC'' ELSE ''UNKNOWN'' END, -- UnallocatedOverhead
	''NORMAL'' -- FeeAdjustment
FROM
	#Budget Budget
	
	INNER JOIN GBS.NonPayrollExpenseBreakdown NPEB ON
		Budget.BudgetId = NPEB.BudgetId AND
		Budget.ImportBatchId = NPEB.ImportBatchId
	
	INNER JOIN #CorporatePropertySourceCodes CPSC ON
		NPEB.CorporateSourceCode = CPSC.CorporateSourceCode
	
	LEFT OUTER JOIN ( -- these NonPayrollExpenses need to be excluded because they are in dispute
	
		/* Disputes are created at the level of a budget project. A budget project will dispute the portion of a non-payroll expense that is
		   allocated to them (via the NonPayrollExpenseBreakdown table, which includes the NonPayrollExpenseId and BudgetProjectId fields,
		   allowing for the portion of the non-payroll expense that has been allocated to the budget project to be determined).
		   
		   If, for example, a non-payroll expense is split between two budget projects, and one of these budget projects is disputing their
		   allocation, the portion of the non-payroll expense that is allocated to the budget project that is not disputing must still be
		   included. Only thet portion of the non-payroll expense that is currently being disputed must be excluded.	   
		*/
	
		SELECT DISTINCT
			NPED.ImportBatchId,
			NPED.NonPayrollExpenseId,
			NPED.BudgetProjectId
		FROM
			GBS.NonPayrollExpenseDispute NPED
			INNER JOIN GBS.DisputeStatus DS ON
				NPED.DisputeStatusId = DS.DisputeStatusId AND
				NPED.ImportBatchId = DS.ImportBatchId
		WHERE
			DS.Name <> ''Resolved'' AND
			DS.IsActive = 1
			
	) DisputedNonPayrollExpenseItems ON
		NPEB.NonPayrollExpenseId = DisputedNonPayrollExpenseItems.NonPayrollExpenseId AND
		NPEB.BudgetProjectId = DisputedNonPayrollExpenseItems.BudgetProjectId AND
		NPEB.ImportBatchId = DisputedNonPayrollExpenseItems.ImportBatchId

	-- PropertyFundId
	LEFT OUTER JOIN #ReportingEntityCorporateDepartment RECD ON				-- Only corporate budgets should be handled by GBS, so when we map
		 NPEB.CorporateDepartmentCode = RECD.CorporateDepartmentCode AND	-- to find a Reporting Entity we assume that the source is corporate
		 NPEB.CorporateSourceCode = RECD.SourceCode AND
		 Budget.SnapshotId = RECD.SnapshotId
	
	-- AllocationRegionId
	LEFT OUTER JOIN #PropertyFund PF ON
		RECD.PropertyFundId = PF.PropertyFundId AND
		RECD.SnapshotId = PF.SnapshotId
	
	-- Overhead Type
	LEFT OUTER JOIN #ActivityType AT ON
		NPEB.ActivityTypeId = AT.ActivityTypeId AND
		Budget.SnapshotId = AT.SnapshotId -- 
	
	-- Reimbursable
	LEFT OUTER JOIN #CorporateDepartment CD ON
		NPEB.CorporateSourceCode = CD.SourceCode AND
		NPEB.CorporateDepartmentCode = CD.Code AND
		Budget.SnapshotId = CD.SnapshotId --

	-- FunctionalDepartmentCode
	LEFT OUTER JOIN #FunctionalDepartment FD ON
		NPEB.FunctionalDepartmentId = FD.FunctionalDepartmentId
WHERE
	NPEB.IsActive = 1 AND
	DisputedNonPayrollExpenseItems.NonPayrollExpenseId IS NULL -- Exclude all disputed items

PRINT (''Rows inserted into #ProfitabilitySource: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--select * from #ProfitabilitySource

-- ==============================================================================================================================================
-- Get Fee Budget items from GBS
-- ==============================================================================================================================================


SET @StartTime = GETDATE()

INSERT INTO #ProfitabilitySource (
	ImportBatchId,
	ReforecastKey,
	SnapshotId,
	BudgetId,
	ReferenceCode,
	ExpensePeriod,
	SourceCode,
	BudgetAmount,
	GLGlobalAccountId,
	FunctionalDepartmentCode,
	JobCode,
	Reimbursable,
	ActivityTypeId,
	PropertyFundId,
	AllocationSubRegionGlobalRegionId,
	OriginatingGlobalRegionId,
	LocalCurrencyCode,
	LockedDate,
	IsExpense,
	UnallocatedOverhead,
	FeeAdjustment
)
SELECT
	Budget.ImportBatchId,
	Budget.ReforecastKey,
	Budget.SnapshotId,
	Budget.BudgetId, -- BudgetId
	''GBS:BudgetId='' + LTRIM(RTRIM(STR(Budget.BudgetId))) + ''&FeeId='' + LTRIM(RTRIM(STR(Fee.FeeId))) + ''&FeeDetailId='' + LTRIM(RTRIM(STR(FeeDetail.FeeDetailId))) + ''&SnapshotId='' + LTRIM(RTRIM(STR(Budget.SnapshotId))), -- ReferenceCode
	FeeDetail.Period,
	ASR.DefaultCorporateSourceCode, -- SourceCode
	FeeDetail.Amount,
	GA.GLGlobalAccountId, -- GLGlobalAccountId
	NULL, -- FunctionalDepartmentId
	NULL, -- JobCode
	''NO'', -- Reimbursable
	GA.ActivityTypeId, -- ActivityType: determined by finding Fee.GLGlobalAccountId on GrReportingStaging.dbo.GLGlobalAccount
	Fee.PropertyFundId, -- PropertyFundId
	Fee.AllocationSubRegionGlobalRegionId, -- AllocationSubRegionGlobalRegionId
	Fee.AllocationSubRegionGlobalRegionId, -- OriginatingGlobalRegionId: allocation region = originating region for fee income
	Fee.CurrencyCode,
	Budget.LastLockedDate, -- LockedDate
	0,  -- IsExpense
	''UNKNOWN'', -- IsUnallocatedOverhead: defaults to UNKNOWN for fees
	CASE WHEN FeeDetail.IsAdjustment = 1 THEN ''FEEADJUST'' ELSE ''NORMAL'' END -- IsFeeAdjustment, field isn''t NULLABLE
FROM
	#Budget Budget

	INNER JOIN GBS.Fee Fee ON
		Budget.BudgetId = Fee.BudgetId AND
		Budget.ImportBatchId = Fee.ImportBatchId

	INNER JOIN GBS.FeeDetail FeeDetail ON
		Fee.FeeId = FeeDetail.FeeId AND
		Fee.ImportBatchId = FeeDetail.ImportBatchId

	LEFT OUTER JOIN #GLGlobalAccount GA ON
		Fee.GLGlobalAccountId = GA.GLGlobalAccountId AND
		Budget.SnapshotId = GA.SnapshotId

	LEFT OUTER JOIN #AllocationSubRegion ASR ON
		Fee.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId

WHERE
	Fee.IsDeleted = 0 AND
	FeeDetail.Amount <> 0

PRINT (''Rows inserted into #ProfitabilitySource: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

--select distinct COUNT(*) from #ProfitabilitySource
RAISERROR( ''Completed inserting budget portions into #ProfitabilitySource'',0,1) WITH NOWAIT

------------------------------------------------------------------------------------------------------------------
RAISERROR( ''Starting to update #ProfitabilitySource GLGlobalAccountId'',0,1) WITH NOWAIT

SET @StartTime = GETDATE()

UPDATE
	PS
SET
	PS.GLGlobalAccountId = GLGA2.GLGlobalAccountId
FROM
	#ProfitabilitySource PS

	INNER JOIN #GLGlobalAccount GLGA1 ON
		PS.GLGlobalAccountId = GLGA1.GLGlobalAccountId

	INNER JOIN #GLGlobalAccount GLGA2 ON
		(LEFT(GLGA1.Code, 10 - LEN(PS.ActivityTypeId)) + LTRIM(RTRIM(STR(PS.ActivityTypeId)))) = GLGA2.Code
WHERE
	LEN(GLGA1.Code) = 10 AND -- A code of 10 characters excludes the account prefix (CP, TS) and includes the activity type code, i.e.: 5020100012
	RIGHT(GLGA1.Code, 2) = ''00'' -- where the header account has been budgeted against

PRINT (''Rows updated in #ProfitabilitySource (GLAccount update from head to activity-specific GL Account: '' + LTRIM(RTRIM(STR(@@rowcount))))

------------------------------------------------------------------------------------------------------------------

-- Perhaps create index for #ProfitabilitySource here

-- ==============================================================================================================================================
-- Join to dimension tables in GrReporting and attempt to resolve keys, otherwise default to UNKNOWN if NULL
-- ==============================================================================================================================================

RAISERROR( ''Starting to insert into #ProfitabilityBudget'',0,1) WITH NOWAIT

SET @StartTime = GETDATE()

CREATE TABLE #ProfitabilityBudget(
	ImportBatchId INT NOT NULL,
	ReforecastKey INT NOT NULL,
	SnapshotId INT NOT NULL,
	CalendarKey int NOT NULL,
	GlAccountKey int NOT NULL,
	SourceKey int NOT NULL,
	FunctionalDepartmentKey int NOT NULL,
	ReimbursableKey int NOT NULL,
	ActivityTypeKey int NOT NULL,
	PropertyFundKey int NOT NULL,	
	AllocationRegionKey int NOT NULL,
	OriginatingRegionKey int NOT NULL,
	OverheadKey int NOT NULL,
	FeeAdjustmentKey int NOT NULL,
	LocalCurrencyKey int NOT NULL,
	LocalBudget money NOT NULL,
	ReferenceCode Varchar(300) NOT NULL,
	BudgetId int NOT NULL,
	IsExpense BIT NOT NULL,

	EUCorporateGlAccountCategoryKey int NULL,
	EUPropertyGlAccountCategoryKey int NULL,
	EUFundGlAccountCategoryKey int NULL,

	USPropertyGlAccountCategoryKey int NULL,
	USCorporateGlAccountCategoryKey int NULL,
	USFundGlAccountCategoryKey int NULL,

	GlobalGlAccountCategoryKey int NULL,
	DevelopmentGlAccountCategoryKey int NULL
)

INSERT INTO #ProfitabilityBudget 
(
	ImportBatchId,
	ReforecastKey,
	SnapshotId,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	BudgetId,
	IsExpense
)

SELECT
	PS.ImportBatchId,
	PS.ReforecastKey,
	PS.SnapshotId,
	DATEDIFF(DD, ''1900-01-01'', LEFT(PS.ExpensePeriod, 4)+''-'' + RIGHT(PS.ExpensePeriod, 2) + ''-01''), -- CalendarKey,
	CASE WHEN GA.GlAccountKey IS NULL THEN @GlAccountKeyUnknown ELSE GA.GlAccountKey END, -- GlAccountKey,
	CASE WHEN S.SourceKey IS NULL THEN @SourceKeyUnknown ELSE S.SourceKey END, -- SourceKey,
	CASE WHEN
		ISNULL(FDJobCode.FunctionalDepartmentKey, FD.FunctionalDepartmentKey) IS NULL
		THEN
			@FunctionalDepartmentKeyUnknown
		ELSE
			ISNULL(FDJobCode.FunctionalDepartmentKey, FD.FunctionalDepartmentKey) END,	-- FunctionalDepartmentKey,
	CASE WHEN R.ReimbursableCode IS NULL THEN @ReimbursableKeyUnknown ELSE R.ReimbursableKey END, -- ReimbursableKey,
	CASE WHEN AT.ActivityTypeKey IS NULL THEN @ActivityTypeKeyUnknown ELSE AT.ActivityTypeKey END, -- ActivityTypeKey,
	CASE WHEN PF.PropertyFundKey IS NULL THEN @PropertyFundKeyUnknown ELSE PF.PropertyFundKey END, -- PropertyFundKey,
	CASE WHEN AR.AllocationRegionKey IS NULL THEN @AllocationRegionKeyUnknown ELSE AR.AllocationRegionKey END, -- AllocationRegionKey,
	CASE WHEN
		PS.IsExpense = 1
		THEN
			CASE WHEN
				ORR.OriginatingRegionKey IS NULL
			THEN
				@OriginatingRegionKeyUnknown
			ELSE
				ORR.OriginatingRegionKey
			END
		ELSE
			CASE WHEN
				ORRFee.OriginatingRegionKey IS NULL
			THEN
				@OriginatingRegionKeyUnknown
			ELSE
				ORRFee.OriginatingRegionKey
			END
	END, -- OriginatingRegionKey,
	CASE WHEN O.OverheadKey IS NULL THEN @OverheadKeyUnknown ELSE O.OverheadKey END, -- OverheadKey,
	CASE WHEN FA.FeeAdjustmentKey IS NULL THEN @FeeAdjustmentKeyUnknown ELSE FA.FeeAdjustmentKey END, -- FeeAdjustmentKey,
	CASE WHEN C.CurrencyKey IS NULL THEN @LocalCurrencyKeyUnknown ELSE C.CurrencyKey END, -- LocalCurrencyKey,
	PS.BudgetAmount, -- LocalBudget,
	PS.ReferenceCode, -- ReferenceCode,
	PS.BudgetId, -- BudgetId,
	PS.IsExpense
FROM
	#ProfitabilitySource PS

	LEFT OUTER JOIN GrReporting.dbo.GlAccount GA ON
		PS.GLGlobalAccountId = GA.GLGlobalAccountId AND
		PS.SnapshotId = GA.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.[Source] S ON -- dbo.Source is not snapshotted; this is why there''s no join on a SnapshotId field
		PS.SourceCode = S.SourceCode	

	LEFT OUTER JOIN GrReporting.dbo.Reimbursable R ON -- dbo.Reimbursable is not snapshotted; this is why there''s no join on a SnapshotId field
		PS.Reimbursable = R.ReimbursableCode

	LEFT OUTER JOIN GrReporting.dbo.ActivityType AT ON
		PS.ActivityTypeId = AT.ActivityTypeId AND
		PS.SnapshotId = AT.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.PropertyFund PF ON
		PS.PropertyFundId = PF.PropertyFundId AND
		PS.SnapshotId = PF.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion AR ON
		PS.AllocationSubRegionGlobalRegionId = AR.GlobalRegionId AND 
		PS.SnapshotId = AR.SnapshotId

	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion ORRFee ON -- For fee income, allocation region = originating region
		PS.AllocationSubRegionGlobalRegionId = ORRFee.GlobalRegionId AND
		PS.SnapshotId = ORRFee.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion ORR ON
		PS.OriginatingGlobalRegionId = ORR.GlobalRegionId AND
		PS.SnapshotId = ORR.SnapshotId
	
	LEFT OUTER JOIN GrReporting.dbo.Currency C ON -- dbo.Currency is not snapshotted; this is why there''s no join on a SnapshotId field
		PS.LocalCurrencyCode = C.CurrencyCode
	
	LEFT OUTER JOIN GrReporting.dbo.Overhead O ON -- dbo.Overhead is not snapshotted; this is why there''s no join on a SnapshotId field
		PS.UnallocatedOverhead = O.OverheadCode
	
	LEFT OUTER JOIN GrReporting.dbo.FeeAdjustment FA ON -- dbo.FeeAdjustment is not snapshotted; this is why there''s no join on a SnapshotId field
		PS.FeeAdjustment = FA.FeeAdjustmentCode

	-- Detail/Sub Level (Job Code) -- job code is stored as SubFunctionalDepartment in GrReporting.dbo.FunctionalDepartment
	LEFT OUTER JOIN (
						SELECT
							FunctionalDepartmentKey,
							FunctionalDepartmentCode,
							FunctionalDepartmentName,
							SubFunctionalDepartmentCode,
							SubFunctionalDepartmentName
						FROM
							GrReporting.dbo.FunctionalDepartment
						WHERE
							FunctionalDepartmentCode <> SubFunctionalDepartmentCode
	) FDJobCode ON
		PS.JobCode = FDJobCode.SubFunctionalDepartmentCode AND -- dbo.FunctionalDepartment is not snapshotted but should be! When we do make this
															   -- change we should be also joining on SnapshotId
		PS.FunctionalDepartmentCode = FDJobCode.FunctionalDepartmentCode 

	-- Parent Level
	LEFT OUTER JOIN (
						SELECT
							FunctionalDepartmentKey,
							FunctionalDepartmentCode,
							FunctionalDepartmentName,
							SubFunctionalDepartmentCode,
							SubFunctionalDepartmentName
						FROM
							GrReporting.dbo.FunctionalDepartment
						WHERE
							SubFunctionalDepartmentCode = FunctionalDepartmentCode
	) FD ON
		PS.FunctionalDepartmentCode = FD.FunctionalDepartmentCode
WHERE
	PS.BudgetAmount <> 0

PRINT (''Rows inserted into #ProfitabilityBudget: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

PRINT (''Creating Unique INDEX  IX_ProfitabilityBudget on #ProfitabilityBudget on ReferenceCode'')
SET @StartTime = GETDATE()

CREATE UNIQUE CLUSTERED INDEX IX_ProfitabilityBudget ON #ProfitabilityBudget (ReferenceCode)

PRINT (''Created Unique INDEX  IX_ProfitabilityBudget on #ProfitabilityBudget '')
PRINT (CONVERT(VARCHAR(27), DATEDIFF(MILLISECOND, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))


-- ==============================================================================================================================================
-- Update #ProfitabilityBudget.GlobalGlAccountCategoryKey
-- ==============================================================================================================================================

--select * from #ProfitabilitySource
RAISERROR( ''Updating #ProfitabilityBudget GlobalGlAccountCategoryKey'',0,1) WITH NOWAIT


SET @StartTime = GETDATE()

UPDATE
	#ProfitabilityBudget
SET
	GlobalGlAccountCategoryKey = CASE WHEN GLAC.GlAccountCategoryKey IS NULL THEN @GlobalGlAccountCategoryKeyUnknown ELSE GLAC.GlAccountCategoryKey END
FROM #ProfitabilityBudget Gl

	LEFT OUTER JOIN #GLAccountCategoryMapping GLACM ON
		Gl.GlAccountKey = GLACM.GlAccountKey
	
	LEFT OUTER JOIN GrReporting.dbo.GlAccountCategory GLAC ON
		--Gl.CalendarKey BETWEEN GLAC.StartDate AND GLAC.EndDate AND
		GLACM.SnapshotId = GLAC.SnapshotId AND
		GLAC.GlobalGlAccountCategoryCode =  CONVERT(VARCHAR(32),
											CONVERT(VARCHAR(8), GLACM.GLTranslationTypeId) + '':'' + 
											CONVERT(VARCHAR(8), GLACM.GLTranslationSubTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLMajorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLMinorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLAccountTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLACM.GLAccountSubTypeId))

PRINT (''Rows updated from #ProfitabilityBudget: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))

-- ==============================================================================================================================================
-- Delete budgets to insert that have UNKNOWNS in their mapping
-- ==============================================================================================================================================

-- Delete all existing GBS records from dbo.ProfitabilityBudgetUnknowns
DELETE
FROM
	dbo.ProfitabilityBudgetUnknowns
WHERE
	BudgetReforecastTypeKey = @BudgetReforecastTypeKey -- Only delete GBS records, leave TAPAS records

INSERT INTO dbo.ProfitabilityBudgetUnknowns (
	ImportBatchId,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	EUCorporateGlAccountCategoryKey,
	USPropertyGlAccountCategoryKey,
	USFundGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,
	GlobalGlAccountCategoryKey,
	BudgetId,
	BudgetReforecastTypeKey,
	OverheadKey,
	FeeAdjustmentKey,
	SnapshotId
)
SELECT
	ImportBatchId,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	EUCorporateGlAccountCategoryKey,
	USPropertyGlAccountCategoryKey,
	USFundGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,
	GlobalGlAccountCategoryKey,
	BudgetId,
	@BudgetReforecastTypeKey,
	OverheadKey,
	FeeAdjustmentKey,
	SnapshotId
FROM
	#ProfitabilityBudget

WHERE
	GlAccountKey = @GlAccountKeyUnknown OR
	SourceKey = @SourceKeyUnknown OR
	(FunctionalDepartmentKey = @FunctionalDepartmentKeyUnknown AND IsExpense = 1) OR	
	ReimbursableKey = @ReimbursableKeyUnknown OR
	ActivityTypeKey = @ActivityTypeKeyUnknown OR
	PropertyFundKey = @PropertyFundKeyUnknown OR
	AllocationRegionKey = @AllocationRegionKeyUnknown OR
	OriginatingRegionKey = @OriginatingRegionKeyUnknown OR
	FeeAdjustmentKey = @FeeAdjustmentKeyUnknown OR
	LocalCurrencyKey = @LocalCurrencyKeyUnknown OR
	GlobalGlAccountCategoryKey = @GlobalGlAccountCategoryKeyUnknown
	-- LocalBudget
	-- OverheadKey: always UNKNOWN for Fees, UNKNOWN from non-payroll if Activity Type code <> CORPOH
	-- CalendarKey: not required to check if UNKNOWN or NULL because CalendarKey is hard-coded	
	-- ReferenceCode: not required to check if UNKNOWN or NULL because CalendarKey is hard-coded
	-- BudgetId: This field is sourced directly from GBS.Budget and cannot be NULL (has a ''not null'' dbase constraint in source system)
	-- SourceSystemId

DECLARE @RowsInserted INT = @@rowcount

IF (@RowsInserted > 0)
BEGIN
	PRINT (''Oh no - there are '' + CONVERT(VARCHAR(10), @RowsInserted) + '' unknowns in #ProfitabilityBudget. They have been inserted into dbo.ProfitabilityBudgetUnknowns.'')
	PRINT (''Deleting records associated with budgets that have unknowns...'')
	
	INSERT INTO #BudgetsWithUnknownBudgets
	SELECT DISTINCT
		Budget.ImportKey,
		Budget.BudgetId,
		Budget.ImportBatchId
	FROM
		#Budget Budget
		INNER JOIN (
			SELECT DISTINCT
				PBU.BudgetId
			FROM
				dbo.ProfitabilityBudgetUnknowns PBU
		) UnknownBudgets ON
			UnknownBudgets.BudgetId = Budget.BudgetId
	
	-- delete budgets with unknowns from #ProfitabilityBudget	
	DELETE
		PB
	FROM
		#ProfitabilityBudget PB
		INNER JOIN dbo.ProfitabilityBudgetUnknowns PBU ON
			PB.BudgetId = PBU.BudgetId
	
	PRINT (''Deleting #ProfitabilityBudget records associated with budgets that have unknowns: '' + LTRIM(RTRIM(STR(@@rowcount))) + '' (completed) '')
	
	-- delete these budgets and their associated data from GrReportingStaging
	DECLARE @BudgetsWithUnknowns AS GBSBudgetImportBatchType
	
	INSERT INTO @BudgetsWithUnknowns
	SELECT
		*
	FROM
		#BudgetsWithUnknownBudgets
	
	EXEC dbo.stp_D_GBSBudget @BudgetsWithUnknowns

	PRINT (''Deleting GrReportingStaging GBS records associated with budgets that have unknowns: '' + LTRIM(RTRIM(STR(@@rowcount))) + '' (completed)'')
END

-- ==============================================================================================================================================
-- Delete existing budgets that we are about to insert
-- ==============================================================================================================================================

CREATE TABLE #BudgetsToImportOriginal( -- an original copy of the budgets that are to be imported is kept here - the budgets in the table below will be deleted during insertion into the warehouse
	BudgetId INT NOT NULL
)

CREATE TABLE #BudgetsToImport(
	BudgetId INT NOT NULL
)

INSERT INTO #BudgetsToImportOriginal
SELECT DISTINCT
	BudgetId
FROM
	#ProfitabilityBudget

INSERT INTO #BudgetsToImport
SELECT DISTINCT
	BudgetId
FROM
	#BudgetsToImportOriginal


DECLARE @BudgetId int = -1
DECLARE @LoopCount int = 0 -- Infinite loop safe guard
WHILE (EXISTS (SELECT TOP 1 BudgetId FROM #BudgetsToImport) AND @LoopCount < 100000)
BEGIN
	
	SET @LoopCount = @LoopCount + 1
	
	SET @BudgetId = (SELECT TOP 1 BudgetId FROM #BudgetsToImport)

	DECLARE @row Int = 1
	DECLARE @deleteCnt Int = 0
	WHILE (@row > 0)
		BEGIN
		
				DELETE TOP (100000)
				FROM
					GrReporting.dbo.ProfitabilityBudget 
				WHERE
					BudgetId = @BudgetId AND
					BudgetReforecastTypeKey = @BudgetReforecastTypeKey

			SET @row = @@rowcount
			SET @deleteCnt = @deleteCnt + @row
			
			PRINT ''>>>:''+CONVERT(VARCHAR(10),@row)
			PRINT CONVERT(VARCHAR(27), getdate(), 121)
		
		END
		
	PRINT ''Rows Deleted from ProfitabilityBudget:''+CONVERT(VARCHAR(10),@deleteCnt)
	PRINT CONVERT(VARCHAR(27), GETDATE(), 121)
	
	DELETE FROM #BudgetsToImport WHERE BudgetId = @BudgetId
	
	PRINT ''Rows Deleted from #DeletingBudget:''+CONVERT(VARCHAR(10),@@ROWCOUNT)
	PRINT CONVERT(VARCHAR(27), GETDATE(), 121)
	
END

-- ==============================================================================================================================================
-- Insert budget records into GrReporting.dbo.ProfitabilityBudget
-- ==============================================================================================================================================

INSERT INTO GrReporting.dbo.ProfitabilityBudget
(
	SnapshotId,
	ReforecastKey,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	BudgetId,
	BudgetReforecastTypeKey,
	
	EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,

	USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey
)
SELECT
	SnapshotId,
	ReforecastKey,
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	PropertyFundKey,
	AllocationRegionKey,
	OriginatingRegionKey,
	OverheadKey,
	FeeAdjustmentKey,
	LocalCurrencyKey,
	LocalBudget,
	ReferenceCode,
	BudgetId,
	@BudgetReforecastTypeKey,
	
	@EUCorporateGlAccountCategoryKeyUnknown, --EUCorporateGlAccountCategoryKey,
	@EUPropertyGlAccountCategoryKeyUnknown, --EUPropertyGlAccountCategoryKey,
	@EUFundGlAccountCategoryKeyUnknown, --EUFundGlAccountCategoryKey,

	@USPropertyGlAccountCategoryKeyUnknown, --USPropertyGlAccountCategoryKey,
	@USCorporateGlAccountCategoryKeyUnknown, ----USCorporateGlAccountCategoryKey,
	@USFundGlAccountCategoryKeyUnknown, --USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey,
	@DevelopmentGlAccountCategoryKeyUnknown --DevelopmentGlAccountCategoryKey
FROM 
	#ProfitabilityBudget
	
	
PRINT (''Rows inserted into GrReporting.dbo.ProfitabilityBudget: '' + CONVERT(VARCHAR(10),@@rowcount))
PRINT (CONVERT(VARCHAR(27), DATEDIFF(millisecond, @StartTime, GETDATE()), 121) + '' ms'' + CHAR(13))
	

-- ==============================================================================================================================================
-- Mark budgets as being successfully processed into the warehouse
-- ==============================================================================================================================================
DECLARE @ImportErrorText VARCHAR(500)
SELECT @ImportErrorText = COALESCE(@ImportErrorText + '', '', '''') + Error from @ImportErrorTable

BEGIN TRY		

	SELECT
		BTP.BudgetsToProcessId,
		CASE WHEN BWUB.BudgetId IS NULL THEN 1 ELSE 0 END AS OriginalBudgetProcessedIntoWarehouse, -- 0 if import fails, 1 if import succeeds
		@ImportErrorText AS ReasonForFailure,
		GETDATE() AS DateBudgetProcessedIntoWarehouse-- date that the buget import either failed or succeeded (depending on 0 or 1 above)
	INTO 
		#BudgetsToProcessToUpdate
	FROM
		dbo.BudgetsToProcess BTP
		INNER JOIN #BudgetsToProcess BTPT ON
			BTP.BudgetsToProcessId = BTPT.BudgetsToProcessId	
		
		LEFT OUTER JOIN #BudgetsWithUnknownBudgets BWUB ON
			BTP.BudgetId = BWUB.BudgetId 

	UPDATE
		BTP
	SET
		BTP.OriginalBudgetProcessedIntoWarehouse = BTPTU.OriginalBudgetProcessedIntoWarehouse,
		BTP.ReasonForFailure = BTPTU.ReasonForFailure,
		BTP.DateBudgetProcessedIntoWarehouse = BTPTU.DateBudgetProcessedIntoWarehouse
	FROM
		dbo.BudgetsToProcess BTP
		INNER JOIN #BudgetsToProcessToUpdate BTPTU ON
			BTPTU.BudgetsToProcessId = BTP.BudgetsToProcessId
		
	PRINT (''Rows updated from dbo.BudgetsToProcess: '' + CONVERT(VARCHAR(10),@@rowcount))

END TRY
BEGIN CATCH
	
	SET @ImportErrorText = NULL
		SELECT @ImportErrorText =  
			COALESCE(@ImportErrorText + '', '', '''') + 
			''BudgetsToProcessId:''+ LTRIM(STR(BTPTU.BudgetsToProcessId)) + 
			'' ReforecastBudgetsProcessedIntoWarehouse:'' + LTRIM(STR(BTPTU.ReforecastBudgetsProcessedIntoWarehouse))  +
			'' ReforecastActualsProcessedIntoWarehouse:'' + LTRIM(STR(BTPTU.ReforecastActualsProcessedIntoWarehouse))  +
			'' ReasonForFailure:'' + ReasonForFailure +
			'' DateBudgetProcessedIntoWarehouse:'' + CONVERT(VARCHAR(27), BTPTU.DateBudgetProcessedIntoWarehouse)
			
		from #BudgetsToProcessToUpdate BTPTU

	PRINT ''Error updating budgets to pricess, The Values were:''
	PRINT @ImportErrorText
	
	
    DECLARE @ErrorSeverity  INT = ERROR_SEVERITY(), @ErrorMessage NVARCHAR(4000) =
		''Error updating BudgetsToProcess: '' + CONVERT(VARCHAR(10), ERROR_NUMBER()) + '':'' + ERROR_MESSAGE() 	
    RAISERROR ( @ErrorMessage, @ErrorSeverity, 1)
END CATCH

-- ==============================================================================================================================================
-- Delete archived budgets: only keep the last three budgets - older budgets must be deleted
-- ==============================================================================================================================================

/*
DECLARE @BudgetsToDelete AS GBSBudgetImportBatchType

INSERT INTO @BudgetsToDelete
SELECT
	Budget.ImportKey,
	Budget.BudgetId,
	Budget.ImportBatchId
FROM
	GBS.Budget Budget
	LEFT OUTER JOIN (
						SELECT
							B1.*,
							B4.ranknum
						FROM
							GBS.Budget B1
							INNER JOIN (
								SELECT
									B2.ImportKey,
									COUNT(*) AS ranknum
								FROM
									GBS.Budget B2
									INNER JOIN GBS.Budget B3 ON
										B2.BudgetId = B3.BudgetId AND
										B2.ImportKey <= B3.ImportKey
								GROUP BY
									B2.ImportKey
								HAVING
									COUNT(*) <= 3 -- the number of version of a given budget that are to be archived (including the current budget)
							) B4 ON
								B1.ImportKey = B4.ImportKey
	) BudgetsToKeep ON
		Budget.ImportKey = BudgetsToKeep.ImportKey
WHERE
	BudgetsToKeep.ImportKey IS NULL

EXEC dbo.stp_D_GBSBudget @BudgetsToDelete
*/

-- ==============================================================================================================================================
-- Clean up: drop temp tables
-- ==============================================================================================================================================

IF 	OBJECT_ID(''tempdb..#Budget'') IS NOT NULL
    DROP TABLE #Budget

IF 	OBJECT_ID(''tempdb..#GLGlobalAccount'') IS NOT NULL
    DROP TABLE #GLGlobalAccount

IF 	OBJECT_ID(''tempdb..#GLTranslationSubType'') IS NOT NULL
    DROP TABLE #GLTranslationSubType

IF 	OBJECT_ID(''tempdb..#GLGlobalAccountTranslationSubType'') IS NOT NULL
    DROP TABLE #GLGlobalAccountTranslationSubType
    
IF 	OBJECT_ID(''tempdb..#GLMinorCategory'') IS NOT NULL
    DROP TABLE #GLMinorCategory
    
IF 	OBJECT_ID(''tempdb..#GLMajorCategory'') IS NOT NULL
    DROP TABLE #GLMajorCategory

IF 	OBJECT_ID(''tempdb..#GLGlobalAccountTranslationType'') IS NOT NULL
    DROP TABLE #GLGlobalAccountTranslationType

IF 	OBJECT_ID(''tempdb..#ReportingEntityCorporateDepartment'') IS NOT NULL
    DROP TABLE #ReportingEntityCorporateDepartment

IF 	OBJECT_ID(''tempdb..#PropertyFund'') IS NOT NULL
    DROP TABLE #PropertyFund

IF 	OBJECT_ID(''tempdb..#ActivityType'') IS NOT NULL
    DROP TABLE #ActivityType

IF 	OBJECT_ID(''tempdb..#CorporateDepartment'') IS NOT NULL
    DROP TABLE #CorporateDepartment

IF 	OBJECT_ID(''tempdb..#FunctionalDepartment'') IS NOT NULL
    DROP TABLE #FunctionalDepartment

IF 	OBJECT_ID(''tempdb..#AllocationSubRegion'') IS NOT NULL
    DROP TABLE #AllocationSubRegion

IF 	OBJECT_ID(''tempdb..#GLAccountCategoryMapping'') IS NOT NULL
    DROP TABLE #GLAccountCategoryMapping

IF 	OBJECT_ID(''tempdb..#ProfitabilitySource'') IS NOT NULL
    DROP TABLE #ProfitabilitySource

IF 	OBJECT_ID(''tempdb..#ProfitabilityBudget'') IS NOT NULL
    DROP TABLE #ProfitabilityBudget

IF 	OBJECT_ID(''tempdb..#BudgetsToImport'') IS NOT NULL
    DROP TABLE #BudgetsToImport

IF 	OBJECT_ID(''tempdb..#BudgetsToImportOriginal'') IS NOT NULL
	DROP TABLE #BudgetsToImportOriginal

IF 	OBJECT_ID(''tempdb..#BudgetsToDelete'') IS NOT NULL
    DROP TABLE #BudgetsToDelete

IF 	OBJECT_ID(''tempdb..#CorporatePropertySourceCodes'') IS NOT NULL
    DROP TABLE #CorporatePropertySourceCodes

IF 	OBJECT_ID(''tempdb..#BudgetsWithUnknowns'') IS NOT NULL
    DROP TABLE #BudgetsWithUnknowns

IF 	OBJECT_ID(''tempdb..#PreviousBudgetsLastLockedDate'') IS NOT NULL
    DROP TABLE #PreviousBudgetsLastLockedDate

IF 	OBJECT_ID(''tempdb..#BudgetsToProcess'') IS NOT NULL
    DROP TABLE #BudgetsToProcess

IF 	OBJECT_ID(''tempdb..#BudgetsWithUnknownBudgets'') IS NOT NULL
    DROP TABLE #BudgetsWithUnknownBudgets

' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyOverhead]    Script Date: 05/16/2011 08:15:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyOverhead]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyOverhead]
      @ImportStartDate  DateTime=NULL,
      @ImportEndDate          DateTime=NULL,
      @DataPriorToDate  DateTime=NULL
AS
IF (@ImportStartDate IS NULL)
      BEGIN
      SET @ImportStartDate = CONVERT(DateTime,(select ConfiguredValue From SSISConfigurations Where ConfigurationFilter = ''ActualImportStartDate''))
      END

IF (@ImportEndDate IS NULL)
      BEGIN
      SET @ImportEndDate = CONVERT(DateTime,(select ConfiguredValue From SSISConfigurations Where ConfigurationFilter = ''ActualImportEndDate''))
      END

IF (@DataPriorToDate IS NULL)
      BEGIN
      SET @DataPriorToDate = CONVERT(DateTime,(select ConfiguredValue From SSISConfigurations Where ConfigurationFilter = ''ActualDataPriorToDate''))
      END

SET NOCOUNT ON
IF @DataPriorToDate IS NULL 
	SET @DataPriorToDate = GETDATE()

DECLARE 
	@GlAccountKeyUnknown INT,
	--@OverheadGlAccountKeyUnknown INT,
	@FunctionalDepartmentKeyUnknown INT,
	@ReimbursableKeyUnknown INT,
	@ActivityTypeKeyUnknown INT,
	@SourceKeyUnknown INT,
	@OriginatingRegionKeyUnknown INT,
	@AllocationRegionKeyUnknown INT,
	@PropertyFundKeyUnknown INT,
	@OverheadKeyUnknown INT,
		--@CurrencyKey INT,
	@EUFundGlAccountCategoryKeyUnknown INT,
	@EUCorporateGlAccountCategoryKeyUnknown INT,
	@EUPropertyGlAccountCategoryKeyUnknown	INT,
	@USFundGlAccountCategoryKeyUnknown	INT,
	@USPropertyGlAccountCategoryKeyUnknown	INT,
	@USCorporateGlAccountCategoryKeyUnknown INT,
	@DevelopmentGlAccountCategoryKeyUnknown INT,
	@GlobalGlAccountCategoryKeyUnknown INT

PRINT ''####''
PRINT ''stp_IU_LoadGrProfitabiltyOverhead''
PRINT ''####''
SET NOCOUNT ON
  
--Default FK for the Fact table
/*

DECLARE	@ImportStartDate DateTime
DECLARE	@ImportEndDate DateTime
DECLARE	@DataPriorToDate DateTime

SET	@ImportStartDate = ''1900-01-01''
SET	@ImportEndDate = ''2010-12-31''
SET	@DataPriorToDate = ''2010-12-31''

exec [stp_IU_LoadGrProfitabiltyOverhead]
	@ImportStartDate	= ''1900-01-01'',
	@ImportEndDate		= ''2010-12-31'',
	@DataPriorToDate	= ''2010-12-31''
*/  
     
SET @GlAccountKeyUnknown			= (SELECT GlAccountKey FROM GrReporting.dbo.GlAccount WHERE Code = ''UNKNOWN'')
--SET @OverheadGlAccountKeyUnknown	= (SELECT GlAccountKey FROM GrReporting.dbo.GlAccount WHERE Code = ''5002950000  '') -- Only log against header account (This might be changed back so only commented out)
SET @FunctionalDepartmentKeyUnknown	= (SELECT FunctionalDepartmentKey FROM GrReporting.dbo.FunctionalDepartment WHERE FunctionalDepartmentCode = ''UNKNOWN'')
SET @ReimbursableKeyUnknown			= (SELECT ReimbursableKey FROM GrReporting.dbo.Reimbursable WHERE ReimbursableCode = ''UNKNOWN'')
SET @ActivityTypeKeyUnknown			= (SELECT ActivityTypeKey FROM GrReporting.dbo.ActivityType WHERE ActivityTypeCode = ''UNKNOWN'')
SET @SourceKeyUnknown				= (SELECT SourceKey FROM GrReporting.dbo.Source WHERE SourceName = ''UNKNOWN'')
SET @OriginatingRegionKeyUnknown	= (SELECT OriginatingRegionKey FROM GrReporting.dbo.OriginatingRegion WHERE RegionCode = ''UNKNOWN'')
SET @AllocationRegionKeyUnknown		= (SELECT AllocationRegionKey FROM GrReporting.dbo.AllocationRegion WHERE RegionCode = ''UNKNOWN'')
SET @PropertyFundKeyUnknown			= (SELECT PropertyFundKey FROM GrReporting.dbo.PropertyFund WHERE PropertyFundName = ''UNKNOWN'')
--SET @CurrencyKey					= (SELECT CurrencyKey FROM GrReporting.dbo.Currency WHERE CurrencyCode = ''UNK'')
SET @OverheadKeyUnknown				= (SELECT OverheadKey FROM GrReporting.dbo.Overhead WHERE OverheadName = ''UNKNOWN'')

SET @EUFundGlAccountCategoryKeyUnknown      = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
SET @EUCorporateGlAccountCategoryKeyUnknown = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
SET @EUPropertyGlAccountCategoryKeyUnknown  = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
SET @USFundGlAccountCategoryKeyUnknown      = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
SET @USPropertyGlAccountCategoryKeyUnknown  = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
SET @USCorporateGlAccountCategoryKeyUnknown = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
SET @DevelopmentGlAccountCategoryKeyUnknown = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''Development Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')
SET @GlobalGlAccountCategoryKeyUnknown      = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global'' AND TranslationSubTypeName = ''Global'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'')


----- Temp table creation and data inserts - Change Control 7

CREATE TABLE #ManageType(
	ImportKey INT NOT NULL,
	ManageTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #ManageCorporateDepartment(
	ImportKey INT NOT NULL,
	ManageCorporateDepartmentId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	CorporateDepartmentCode CHAR(8) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #ManageCorporateEntity(
	ImportKey INT NOT NULL,
	ManageCorporateEntityId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	CorporateEntityCode CHAR(6) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)


CREATE TABLE #ManagePropertyDepartment(
	ImportKey INT NOT NULL,
	ManagePropertyDepartmentId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	PropertyDepartmentCode CHAR(8) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #ManagePropertyEntity(
	ImportKey INT NOT NULL,
	ManagePropertyEntityId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	PropertyEntityCode CHAR(6) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)
----

-- #ManageType

INSERT INTO #ManageType(
	ImportKey,
	ManageTypeId,
	Code,
	Name,
	[Description],
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MT.ImportKey,
	MT.ManageTypeId,
	MT.Code,
	MT.Name,
	MT.[Description],
	MT.IsDeleted,
	MT.InsertedDate,
	MT.UpdatedDate
FROM
	Gdm.ManageType MT
	INNER JOIN Gdm.ManageTypeActive(@DataPriorToDate) MTA ON
		MT.ImportKey = MTA.ImportKey
		
-- #ManageCorporateDepartment

INSERT INTO #ManageCorporateDepartment(
	ImportKey,
	ManageCorporateDepartmentId,
	ManageTypeId,
	CorporateDepartmentCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MCD.ImportKey,
	MCD.ManageCorporateDepartmentId,
	MCD.ManageTypeId,
	MCD.CorporateDepartmentCode,
	MCD.SourceCode,
	MCD.IsDeleted,
	MCD.InsertedDate,
	MCD.UpdatedDate 
FROM
	Gdm.ManageCorporateDepartment MCD
	INNER JOIN Gdm.ManageCorporateDepartmentActive(@DataPriorToDate) MCDA ON
		MCD.ImportKey = MCDA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MCD.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-- #ManageCorporateEntity

INSERT INTO #ManageCorporateEntity(
	ImportKey,
	ManageCorporateEntityId,
	ManageTypeId,
	CorporateEntityCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MCE.ImportKey,
	MCE.ManageCorporateEntityId,
	MCE.ManageTypeId,
	MCE.CorporateEntityCode,
	MCE.SourceCode,
	MCE.IsDeleted,
	MCE.InsertedDate,
	MCE.UpdatedDate 
FROM
	Gdm.ManageCorporateEntity MCE
	INNER JOIN Gdm.ManageCorporateEntityActive(@DataPriorToDate) MCEA ON
		MCE.ImportKey = MCEA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MCE.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-- #ManagePropertyDepartment

INSERT INTO #ManagePropertyDepartment(
	ImportKey,
	ManagePropertyDepartmentId,
	ManageTypeId,
	PropertyDepartmentCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MPD.ImportKey,
	MPD.ManagePropertyDepartmentId,
	MPD.ManageTypeId,
	MPD.PropertyDepartmentCode,
	MPD.SourceCode,
	MPD.IsDeleted,
	MPD.InsertedDate,
	MPD.UpdatedDate 
FROM
	Gdm.ManagePropertyDepartment MPD
	INNER JOIN Gdm.ManagePropertyDepartmentActive(@DataPriorToDate) MPDA ON
		MPD.ImportKey = MPDA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MPD.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-- #ManagePropertyEntity

INSERT INTO #ManagePropertyEntity(
	ImportKey,
	ManagePropertyEntityId,
	ManageTypeId,
	PropertyEntityCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MPE.ImportKey,
	MPE.ManagePropertyEntityId,
	MPE.ManageTypeId,
	MPE.PropertyEntityCode,
	MPE.SourceCode,
	MPE.IsDeleted,
	MPE.InsertedDate,
	MPE.UpdatedDate 
FROM
	Gdm.ManagePropertyEntity MPE
	INNER JOIN Gdm.ManagePropertyEntityActive(@DataPriorToDate) MPEA ON
		MPE.ImportKey = MPEA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MPE.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-- change control 7 end

CREATE TABLE #ActivityTypeGLAccount(
	ActivityTypeId INT,
	GLAccountCode VARCHAR(12)
)

INSERT INTO #ActivityTypeGLAccount (
	ActivityTypeId, 
	GLAccountCode
)
SELECT NULL AS ActivityTypeId, ''5002950000'' AS GLAccountCode UNION ALL --header (NULL in on hierarchy)
SELECT 1, ''5002950001'' UNION ALL --Leasing
SELECT 2, ''5002950002'' UNION ALL --Acquisitions
SELECT 3, ''5002950003'' UNION ALL --Asset Management
SELECT 4, ''5002950004'' UNION ALL --Development
SELECT 5, ''5002950005'' UNION ALL --Property Management Escalatable
SELECT 6, ''5002950006'' UNION ALL --Property Management Non-Escalatable
SELECT 7, ''5002950007'' UNION ALL --Syndication (Investment and Fund)
SELECT 8, ''5002950008'' UNION ALL --Fund Organization
SELECT 9, ''5002950009'' UNION ALL --Fund Operations
SELECT 10, ''5002950010'' UNION ALL --Property Management TI
SELECT 11, ''5002950011'' UNION ALL --Property Management CapEx
SELECT 12, ''5002950012'' UNION ALL --Corporate
SELECT 99, ''5002950099'' --Corporate Overhead (No corporate overhead (5002950099) account  use header instead)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Create the temp tables used on the "active" records for optimization
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

CREATE TABLE #AllocationRegion(
	ImportKey INT NOT NULL,
	AllocationRegionGlobalRegionId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	ProjectCodePortion VARCHAR(2) NOT NULL,
	DefaultCurrencyCode CHAR(3) NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)
CREATE TABLE #AllocationSubRegion(
	ImportKey INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	ProjectCodePortion VARCHAR(2) NOT NULL,
	AllocationRegionGlobalRegionId INT NULL,
	DefaultCurrencyCode CHAR(3) NOT NULL,
	CountryId INT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #BillingUpload(
	ImportKey INT  NOT NULL,
	BillingUploadId INT NOT NULL,
	BillingUploadBatchId INT NULL,
	BillingUploadTypeId INT NOT NULL,
	TimeAllocationId INT NOT NULL,
	CostTypeId INT NOT NULL,
	RegionId INT NOT NULL,
	ExternalRegionId INT NOT NULL,
	ExternalSubRegionId INT NOT NULL,
	PayrollId INT NULL,
	OverheadId INT NULL,
	PayGroupId INT NULL,
	UnionCodeId INT NULL,
	OverheadRegionId INT NULL,
	HREmployeeId INT NOT NULL,
	ProjectId INT NOT NULL,
	SubDepartmentId INT NOT NULL,
	ExpensePeriod INT NOT NULL,
	PayrollDescription NVARCHAR(100) NULL,
	OverheadDescription NVARCHAR(100) NULL,
	ProjectCode VARCHAR(50) NOT NULL,
	ReversalPeriod INT NULL,
	AllocationPeriod INT NOT NULL,
	AllocationValue DECIMAL(18, 9) NOT NULL,
	IsReversable BIT NOT NULL,
	IsReversed BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	HasNoInactiveProjects BIT NOT NULL,
	LocationId INT NOT NULL,
	ProjectGroupAllocationAdjustmentId INT NULL,
	AdjustedTimeAllocationDetailId INT NULL,
	PayrollPayDate DATETIME NULL,
	PayrollFromDate DATETIME NULL,
	PayrollToDate DATETIME NULL,
	FunctionalDepartmentId INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	OverheadFunctionalDepartmentId INT NULL,
)

CREATE TABLE #BillingUploadDetail(
	ImportKey INT NOT NULL,
	BillingUploadDetailId INT NOT NULL,
	BillingUploadBatchId INT NOT NULL,
	BillingUploadId INT NOT NULL,
	BillingUploadDetailTypeId INT NOT NULL,
	ExpenseTypeId INT NULL,
	GLAccountCode VARCHAR(15) NOT NULL,
	CorporateEntityRef VARCHAR(6) NULL,
	CorporateDepartmentCode VARCHAR(8) NOT NULL,
	CorporateDepartmentIsRechargedToAr BIT NOT NULL,
	CorporateSourceCode VARCHAR(2) NOT NULL,
	AllocationAmount DECIMAL(18, 9) NOT NULL,
	CurrencyCode CHAR(3) NOT NULL,
	IsUnion BIT NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	CorporateDepartmentIsRechargedToAp BIT NOT NULL
)

CREATE TABLE #Overhead(
	ImportKey INT NOT NULL,
	OverheadId INT NOT NULL,
	RegionId INT NOT NULL,
	ExpensePeriod INT NOT NULL,
	AllocationStartPeriod INT NOT NULL,
	AllocationEndPeriod INT NULL,
	[Description] NVARCHAR(60) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	InsertedByStaffId INT NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	InvoiceNumber VARCHAR(13) NULL
)

CREATE TABLE #FunctionalDepartment(
	ImportKey INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	Code VARCHAR(20) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	GlobalCode CHAR(3) NULL
)

CREATE TABLE #Project(
	ImportKey INT NOT NULL,
	ProjectId INT NOT NULL,
	RegionId INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	ProjectOwnerId INT NULL,
	CorporateDepartmentCode VARCHAR(8) NOT NULL,
	CorporateSourceCode CHAR(2) NOT NULL,
	Code VARCHAR(50) NOT NULL,
	[Name] VARCHAR(100) NOT NULL,
	StartPeriod INT NOT NULL,
	EndPeriod INT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	PropertyOverheadGLAccountCode VARCHAR(15) NULL,
	PropertyOverheadDepartmentCode VARCHAR(6) NULL,
	PropertyOverheadJobCode VARCHAR(15) NULL,
	PropertyOverheadSourceCode CHAR(2) NULL,
	CorporateUnionPayrollIncomeCategoryCode VARCHAR(6) NULL,
	CorporateNonUnionPayrollIncomeCategoryCode VARCHAR(6) NULL,
	CorporateOverheadIncomeCategoryCode VARCHAR(6) NULL,
	PropertyFundId INT NOT NULL,
	MarkUpPercentage DECIMAL(5, 4) NULL,
	HistoricalProjectCode VARCHAR(50) NULL,
	IsTSCost BIT NOT NULL,
	CanAllocateOverheads BIT NOT NULL,
	AllocateOverheadsProjectId INT NULL
)

CREATE TABLE #PropertyFund( -- GDM 2.0 change
	ImportKey INT NOT NULL,
	PropertyFundId INT NOT NULL,
	RelatedFundId INT NULL,
	EntityTypeId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	BudgetOwnerStaffId INT NOT NULL,
	RegionalOwnerStaffId INT NOT NULL,
	DefaultGLTranslationSubTypeId INT NULL,
	[Name] VARCHAR(100) NOT NULL,
	IsReportingEntity BIT NOT NULL,
	IsPropertyFund BIT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #PropertyFundMapping(
	ImportKey INT NOT NULL,
	PropertyFundMappingId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode char(2) NOT NULL,
	PropertyFundCode VARCHAR(8) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL,
	ActivityTypeId INT NULL
)

CREATE TABLE #ReportingEntityCorporateDepartment( -- GDM 2.0 addition - used to be AllocationRegionMapping
	ImportKey INT NOT NULL,
	ReportingEntityCorporateDepartmentId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	CorporateDepartmentCode CHAR(6) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsDeleted BIT NOT NULL,
)

CREATE TABLE #ReportingEntityPropertyEntity( -- GDM 2.0 addition - used to be AllocationRegionMapping
	ImportKey INT NOT NULL,
	ReportingEntityPropertyEntityId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	PropertyEntityCode CHAR(6) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsDeleted BIT NOT NULL
)

CREATE TABLE #OriginatingRegionCorporateEntity( -- GDM 2.0 addition - used to be OriginatingRegionMapping
	ImportKey INT NOT NULL,
	OriginatingRegionCorporateEntityId INT NOT NULL,
	GlobalRegionId INT NOT NULL,
	CorporateEntityCode VARCHAR(10) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL	
)

CREATE TABLE #OriginatingRegionPropertyDepartment( -- GDM 2.0 addition - used to be OriginatingRegionMapping
	ImportKey INT NOT NULL,
	OriginatingRegionPropertyDepartmentId INT NOT NULL,
	GlobalRegionId INT NOT NULL,
	PropertyDepartmentCode VARCHAR(10) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL	
)

CREATE TABLE #GLGlobalAccount(
	ImportKey INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	ActivityTypeId INT NULL,
	GLStatutoryTypeId INT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(150) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsGR BIT NOT NULL,
	IsGbs BIT NOT NULL,
	IsRegionalOverheadCost BIT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #ActivityType(
	ImportKey INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	ActivityTypeCode VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	GLSuffix CHAR(2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #OverheadRegion(
	ImportKey INT NOT NULL,
	OverheadRegionId INT NOT NULL,
	RegionId INT NOT NULL,
	CorporateEntityRef VARCHAR(6) NULL,
	CorporateSourceCode VARCHAR(2) NULL,
	[Name] VARCHAR(50) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLTranslationType(
	ImportKey INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLTranslationSubType(
	ImportKey INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsGRDefault BIT NOT NULL
)

CREATE TABLE #GLGlobalAccountTranslationType(
	ImportKey INT NOT NULL,
	GLGlobalAccountTranslationTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLGlobalAccountTranslationSubType(
	ImportKey INT NOT NULL,
	GLGlobalAccountTranslationSubTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLMajorCategory(
	ImportKey INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLMinorCategory(
	ImportKey INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	[Name] VARCHAR(100) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

--======================================================================================================================================

INSERT INTO #BillingUpload (
	ImportKey,
	BillingUploadId,
	BillingUploadBatchId,
	BillingUploadTypeId,
	TimeAllocationId,
	CostTypeId,
	RegionId,
	ExternalRegionId,
	ExternalSubRegionId,
	PayrollId,
	OverheadId,
	PayGroupId,
	UnionCodeId,
	OverheadRegionId,
	HREmployeeId,
	ProjectId,
	SubDepartmentId,
	ExpensePeriod,
	PayrollDescription,
	OverheadDescription,
	ProjectCode,
	ReversalPeriod,
	AllocationPeriod,
	AllocationValue,
	IsReversable,
	IsReversed,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	HasNoInactiveProjects,
	LocationId,
	ProjectGroupAllocationAdjustmentId,
	AdjustedTimeAllocationDetailId,
	PayrollPayDate,
	PayrollFromDate,
	PayrollToDate,
	FunctionalDepartmentId,
	ActivityTypeId,
	OverheadFunctionalDepartmentId
)
SELECT 
	Bu.ImportKey,
	Bu.BillingUploadId,
	Bu.BillingUploadBatchId,
	Bu.BillingUploadTypeId,
	Bu.TimeAllocationId,
	Bu.CostTypeId,
	Bu.RegionId,
	Bu.ExternalRegionId,
	Bu.ExternalSubRegionId,
	Bu.PayrollId,
	Bu.OverheadId,
	Bu.PayGroupId,
	Bu.UnionCodeId,
	Bu.OverheadRegionId,
	Bu.HREmployeeId,
	Bu.ProjectId,
	Bu.SubDepartmentId,
	Bu.ExpensePeriod,
	Bu.PayrollDescription,
	Bu.OverheadDescription,
	Bu.ProjectCode,
	Bu.ReversalPeriod,
	Bu.AllocationPeriod,
	Bu.AllocationValue,
	Bu.IsReversable,
	Bu.IsReversed,
	Bu.InsertedDate,
	Bu.UpdatedDate,
	Bu.UpdatedByStaffId,
	Bu.HasNoInactiveProjects,
	Bu.LocationId,
	Bu.ProjectGroupAllocationAdjustmentId,
	Bu.AdjustedTimeAllocationDetailId,
	Bu.PayrollPayDate,
	Bu.PayrollFromDate,
	Bu.PayrollToDate,
	Bu.FunctionalDepartmentId,
	Bu.ActivityTypeId,
	Bu.OverheadFunctionalDepartmentId
FROM
	TapasGlobal.BillingUpload	Bu
	INNER JOIN TapasGlobal.BillingUploadActive(@DataPriorToDate) BuA ON
		BuA.ImportKey = Bu.ImportKey

------------

INSERT INTO #BillingUploadDetail (
	ImportKey,
	BillingUploadDetailId,
	BillingUploadBatchId,
	BillingUploadId,
	BillingUploadDetailTypeId,
	ExpenseTypeId,
	GLAccountCode,
	CorporateEntityRef,
	CorporateDepartmentCode,
	CorporateDepartmentIsRechargedToAr,
	CorporateSourceCode,
	AllocationAmount,
	CurrencyCode,
	IsUnion,
	UpdatedByStaffId,
	InsertedDate,
	UpdatedDate,
	CorporateDepartmentIsRechargedToAp
)
SELECT 
	Bud.ImportKey,
	Bud.BillingUploadDetailId,
	Bud.BillingUploadBatchId,
	Bud.BillingUploadId,
	Bud.BillingUploadDetailTypeId,
	Bud.ExpenseTypeId,
	Bud.GLAccountCode,
	Bud.CorporateEntityRef,
	Bud.CorporateDepartmentCode,
	Bud.CorporateDepartmentIsRechargedToAr,
	Bud.CorporateSourceCode,
	Bud.AllocationAmount,
	Bud.CurrencyCode,
	Bud.IsUnion,
	Bud.UpdatedByStaffId,
	Bud.InsertedDate,
	Bud.UpdatedDate,
	Bud.CorporateDepartmentIsRechargedToAp
FROM
	TapasGlobal.BillingUploadDetail Bud
	INNER JOIN TapasGlobal.BillingUploadDetailActive(@DataPriorToDate) BudA ON
		BudA.ImportKey = Bud.ImportKey

----------

INSERT INTO #Overhead (
	ImportKey,
	OverheadId,
	RegionId,
	ExpensePeriod,
	AllocationStartPeriod,
	AllocationEndPeriod,
	[Description],
	InsertedDate,
	InsertedByStaffId,
	UpdatedDate,
	UpdatedByStaffId,
	InvoiceNumber
)
SELECT 
	 Oh.ImportKey,
	 Oh.OverheadId,
	 Oh.RegionId,
	 Oh.ExpensePeriod,
	 Oh.AllocationStartPeriod,
	 Oh.AllocationEndPeriod,
	 Oh.[Description],
	 Oh.InsertedDate,
	 Oh.InsertedByStaffId,
	 Oh.UpdatedDate,
	 Oh.UpdatedByStaffId,
	 Oh.InvoiceNumber
FROM
	TapasGlobal.Overhead Oh 
	INNER JOIN TapasGlobal.OverheadActive(@DataPriorToDate) OhA ON
		OhA.ImportKey = Oh.ImportKey

----------

INSERT INTO #FunctionalDepartment (
	ImportKey,
	FunctionalDepartmentId,
	Name,
	Code,
	IsActive,
	InsertedDate,
	UpdatedDate,
	GlobalCode
)
SELECT
	Fd.ImportKey,
	Fd.FunctionalDepartmentId,
	Fd.Name,
	Fd.Code,
	Fd.IsActive,
	Fd.InsertedDate,
	Fd.UpdatedDate,
	Fd.GlobalCode
FROM
	HR.FunctionalDepartment Fd 
	INNER JOIN HR.FunctionalDepartmentActive(@DataPriorToDate) FdA ON
		FdA.ImportKey = Fd.ImportKey

----------

INSERT INTO #Project (
	ImportKey,
	ProjectId,
	RegionId,
	ActivityTypeId,
	ProjectOwnerId,
	CorporateDepartmentCode,
	CorporateSourceCode,
	Code,
	Name,
	StartPeriod,
	EndPeriod,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	PropertyOverheadGLAccountCode,
	PropertyOverheadDepartmentCode,
	PropertyOverheadJobCode,
	PropertyOverheadSourceCode,
	CorporateUnionPayrollIncomeCategoryCode,
	CorporateNonUnionPayrollIncomeCategoryCode,
	CorporateOverheadIncomeCategoryCode,
	PropertyFundId,
	MarkUpPercentage,
	HistoricalProjectCode,
	IsTSCost,
	CanAllocateOverheads,
	AllocateOverheadsProjectId
)
SELECT 
	P2.ImportKey,
	P2.ProjectId,
	P2.RegionId,
	P2.ActivityTypeId,
	P2.ProjectOwnerId,
	P2.CorporateDepartmentCode,
	P2.CorporateSourceCode,
	P2.Code,
	P2.Name,
	P2.StartPeriod,
	P2.EndPeriod,
	P2.InsertedDate,
	P2.UpdatedDate,
	P2.UpdatedByStaffId,
	P2.PropertyOverheadGLAccountCode,
	P2.PropertyOverheadDepartmentCode,
	P2.PropertyOverheadJobCode,
	P2.PropertyOverheadSourceCode,
	P2.CorporateUnionPayrollIncomeCategoryCode,
	P2.CorporateNonUnionPayrollIncomeCategoryCode,
	P2.CorporateOverheadIncomeCategoryCode,
	P2.PropertyFundId,
	P2.MarkUpPercentage,
	P2.HistoricalProjectCode,
	P2.IsTSCost,
	P2.CanAllocateOverheads,
	P2.AllocateOverheadsProjectId
FROM
	TapasGlobal.Project P2
	INNER JOIN TapasGlobal.ProjectActive(@DataPriorToDate) P2A ON
		P2A.ImportKey = P2.ImportKey

----------------------------------------------------------------------------------------------

-- #AllocationRegion

INSERT INTO #AllocationRegion(
	ImportKey,
	AllocationRegionGlobalRegionId,
	Code,
	[Name],
	ProjectCodePortion,
	DefaultCurrencyCode,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	AR.ImportKey,
	AR.AllocationRegionGlobalRegionId,
	AR.Code,
	AR.[Name],
	AR.ProjectCodePortion,
	AR.DefaultCurrencyCode,
	AR.IsActive,
	AR.InsertedDate,
	AR.UpdatedDate,
	AR.UpdatedByStaffId
FROM
	Gdm.AllocationRegion AR
	INNER JOIN Gdm.AllocationRegionActive(@DataPriorToDate) ARA ON
		ARA.ImportKey = AR.ImportKey

-- #AllocationSubRegion

INSERT INTO #AllocationSubRegion(
	ImportKey,
	AllocationSubRegionGlobalRegionId,
	Code,
	[Name],
	ProjectCodePortion,
	AllocationRegionGlobalRegionId,
	DefaultCurrencyCode,
	CountryId,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	ASR.ImportKey,
	ASR.AllocationSubRegionGlobalRegionId,
	ASR.Code,
	ASR.[Name],
	ASR.ProjectCodePortion,
	ASR.AllocationRegionGlobalRegionId,
	ASR.DefaultCurrencyCode,
	ASR.CountryId,
	ASR.IsActive,
	ASR.InsertedDate,
	ASR.UpdatedDate,
	ASR.UpdatedByStaffId
FROM
	Gdm.AllocationSubRegion ASR
	INNER JOIN	Gdm.AllocationSubRegionActive(@DataPriorToDate) ASRA ON ASRA.ImportKey = ASR.ImportKey

-- #PropertyFund
	
INSERT INTO #PropertyFund(
	ImportKey,
	PropertyFundId,
	RelatedFundId,
	EntityTypeId,
	AllocationSubRegionGlobalRegionId,
	BudgetOwnerStaffId,
	RegionalOwnerStaffId,
	DefaultGLTranslationSubTypeId,
	[Name],
	IsReportingEntity,
	IsPropertyFund,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	PF.ImportKey,
	PF.PropertyFundId,
	PF.RelatedFundId,
	PF.EntityTypeId,
	PF.AllocationSubRegionGlobalRegionId,
	PF.BudgetOwnerStaffId,
	PF.RegionalOwnerStaffId,
	PF.DefaultGLTranslationSubTypeId,
	PF.[Name],
	PF.IsReportingEntity,
	PF.IsPropertyFund,
	PF.IsActive,
	PF.InsertedDate,
	PF.UpdatedDate,
	PF.UpdatedByStaffId
FROM
	Gdm.PropertyFund PF 
	INNER JOIN Gdm.PropertyFundActive(@DataPriorToDate) PFA ON
		PFA.ImportKey = PF.ImportKey

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #PropertyFund (PropertyFundId)

-- #PropertyFundMapping

INSERT INTO #PropertyFundMapping(
	ImportKey,
	PropertyFundMappingId,
	PropertyFundId,
	SourceCode,
	PropertyFundCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted,
	ActivityTypeId
)
SELECT
	Pfm.ImportKey,
	Pfm.PropertyFundMappingId,
	Pfm.PropertyFundId,
	Pfm.SourceCode,
	Pfm.PropertyFundCode,
	Pfm.InsertedDate,
	Pfm.UpdatedDate,
	Pfm.IsDeleted,
	Pfm.ActivityTypeId
FROM
	Gdm.PropertyFundMapping Pfm 
	INNER JOIN Gdm.PropertyFundMappingActive(@DataPriorToDate) PfmA ON
		PfmA.ImportKey = Pfm.ImportKey

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #PropertyFundMapping (PropertyFundCode, SourceCode, IsDeleted, PropertyFundId, PropertyFundMappingId, ActivityTypeId)

-- #ReportingEntityCorporateDepartment

INSERT INTO #ReportingEntityCorporateDepartment(
	ImportKey,
	ReportingEntityCorporateDepartmentId,
	PropertyFundId,
	SourceCode,
	CorporateDepartmentCode,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsDeleted
)
SELECT
	RECD.ImportKey,
	RECD.ReportingEntityCorporateDepartmentId,
	RECD.PropertyFundId,
	RECD.SourceCode,
	RECD.CorporateDepartmentCode,
	RECD.InsertedDate,
	RECD.UpdatedDate,
	RECD.UpdatedByStaffId,
	RECD.IsDeleted
FROM
	Gdm.ReportingEntityCorporateDepartment RECD
	INNER JOIN Gdm.ReportingEntityCorporateDepartmentActive(@DataPriorToDate) RECDA ON
		RECDA.ImportKey = RECD.ImportKey

-- #ReportingEntityPropertyEntity

INSERT INTO #ReportingEntityPropertyEntity(
	ImportKey,
	ReportingEntityPropertyEntityId,
	PropertyFundId,
	SourceCode,
	PropertyEntityCode,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsDeleted
)
SELECT
	REPE.ImportKey,
	REPE.ReportingEntityPropertyEntityId,
	REPE.PropertyFundId,
	REPE.SourceCode,
	REPE.PropertyEntityCode,
	REPE.InsertedDate,
	REPE.UpdatedDate,
	REPE.UpdatedByStaffId,
	REPE.IsDeleted
FROM
	Gdm.ReportingEntityPropertyEntity REPE
	INNER JOIN Gdm.ReportingEntityPropertyEntityActive(@DataPriorToDate) REPEA ON
		REPEA.ImportKey = REPE.ImportKey

-- #OriginatingRegionCorporateEntity

INSERT INTO #OriginatingRegionCorporateEntity(
	ImportKey,
	OriginatingRegionCorporateEntityId,
	GlobalRegionId,
	CorporateEntityCode,
	SourceCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted
)
SELECT
	ORCE.ImportKey,
	ORCE.OriginatingRegionCorporateEntityId,
	ORCE.GlobalRegionId,
	ORCE.CorporateEntityCode,
	ORCE.SourceCode,
	ORCE.InsertedDate,
	ORCE.UpdatedDate,
	ORCE.IsDeleted	
FROM
	Gdm.OriginatingRegionCorporateEntity ORCE
	INNER JOIN Gdm.OriginatingRegionCorporateEntityActive (@DataPriorToDate) ORCEA ON
		ORCEA.ImportKey = ORCE.ImportKey

-- #OriginatingRegionPropertyDepartment

INSERT INTO #OriginatingRegionPropertyDepartment(
	ImportKey,
	OriginatingRegionPropertyDepartmentId,
	GlobalRegionId,
	PropertyDepartmentCode,
	SourceCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted
)
SELECT
	ORPD.ImportKey,
	ORPD.OriginatingRegionPropertyDepartmentId,
	ORPD.GlobalRegionId,
	ORPD.PropertyDepartmentCode,
	ORPD.SourceCode,
	ORPD.InsertedDate,
	ORPD.UpdatedDate,
	ORPD.IsDeleted
FROM
	Gdm.OriginatingRegionPropertyDepartment ORPD
	INNER JOIN Gdm.OriginatingRegionPropertyDepartmentActive(@DataPriorToDate) ORPDA ON
		ORPDA.ImportKey = ORPD.ImportKey

-- #ActivityType

INSERT INTO #ActivityType(
	ImportKey,
	ActivityTypeId,
	ActivityTypeCode,
	[Name],
	GLSuffix,
	InsertedDate,
	UpdatedDate
)
SELECT
	At.ImportKey,
	At.ActivityTypeId,
	At.Code,
	At.Name,
	At.GLAccountSuffix,
	At.InsertedDate,
	At.UpdatedDate
FROM
	Gdm.ActivityType At
	INNER JOIN Gdm.ActivityTypeActive(@DataPriorToDate) Ata ON
		Ata.ImportKey = At.ImportKey

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #ActivityType (ActivityTypeId)

-- #GLGlobalAccount

INSERT INTO #GLGlobalAccount(
	ImportKey,
	GLGlobalAccountId,
	ActivityTypeId,
	GLStatutoryTypeId,
	Code,
	[Name],
	[Description],
	IsGR,
	IsGbs,
	IsRegionalOverheadCost,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	GLA.ImportKey,
	GLA.GLGlobalAccountId,
	GLA.ActivityTypeId,
	GLA.GLStatutoryTypeId,
	GLA.Code,
	GLA.[Name], 
	GLA.[Description],
	GLA.IsGR,
	GLA.IsGbs,
	GLA.IsRegionalOverheadCost,
	GLA.IsActive,
	GLA.InsertedDate,
	GLA.UpdatedDate,
	GLA.UpdatedByStaffId
FROM
	Gdm.GLGlobalAccount GLA
	INNER JOIN Gdm.GLGlobalAccountActive(@DataPriorToDate) GLAA ON
		GLAA.ImportKey = GLA.ImportKey
	
CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #GLGlobalAccount (GLGlobalAccountId, ActivityTypeId)

INSERT INTO #OverheadRegion(
	ImportKey,
	OverheadRegionId,
	RegionId,
	CorporateEntityRef,
	CorporateSourceCode,
	Name,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	Ovr.ImportKey,
	Ovr.OverheadRegionId,
	Ovr.RegionId,
	Ovr.CorporateEntityRef,
	Ovr.CorporateSourceCode,
	Ovr.Name,
	Ovr.InsertedDate,
	Ovr.UpdatedDate,
	Ovr.UpdatedByStaffId
FROM	TapasGlobal.OverheadRegion Ovr 
		INNER JOIN TapasGlobal.OverheadRegionActive(@DataPriorToDate) OvrA ON
			OvrA.ImportKey = Ovr.ImportKey

-- #GLGlobalAccountTranslationType

INSERT INTO #GLGlobalAccountTranslationType(
	ImportKey,
	GLGlobalAccountTranslationTypeId,
	GLGlobalAccountId,
	GLTranslationTypeId,
	GLAccountTypeId,
	GLAccountSubTypeId,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	GATT.ImportKey,
	GATT.GLGlobalAccountTranslationTypeId,
	GATT.GLGlobalAccountId,
	GATT.GLTranslationTypeId,
	GATT.GLAccountTypeId,
	GATT.GLAccountSubTypeId,
	GATT.IsActive,
	GATT.InsertedDate,
	GATT.UpdatedDate,
	GATT.UpdatedByStaffId
FROM
	Gdm.GLGlobalAccountTranslationType GATT
	INNER JOIN Gdm.GLGlobalAccountTranslationTypeActive(@DataPriorToDate) GATTA ON
		GATTA.ImportKey = GATT.ImportKey

-- #GLGlobalAccountTranslationSubType

INSERT INTO #GLGlobalAccountTranslationSubType(
	ImportKey,
	GLGlobalAccountTranslationSubTypeId,
	GLGlobalAccountId,
	GLTranslationSubTypeId,
	GLMinorCategoryId,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	GATST.ImportKey,
	GATST.GLGlobalAccountTranslationSubTypeId,
	GATST.GLGlobalAccountId,
	GATST.GLTranslationSubTypeId,
	GATST.GLMinorCategoryId,
	GATST.IsActive,
	GATST.InsertedDate,
	GATST.UpdatedDate,
	GATST.UpdatedByStaffId
FROM
	Gdm.GLGlobalAccountTranslationSubType GATST
	INNER JOIN Gdm.GLGlobalAccountTranslationSubTypeActive(@DataPriorToDate) GATSTA ON
		GATSTA.ImportKey = GATST.ImportKey

-- #GLTranslationType

INSERT INTO #GLTranslationType(
	ImportKey,
	GLTranslationTypeId,
	Code,
	[Name],
	[Description],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	TT.ImportKey,
	TT.GLTranslationTypeId,
	TT.Code,
	TT.[Name],
	TT.[Description],
	TT.IsActive,
	TT.InsertedDate,
	TT.UpdatedDate,
	TT.UpdatedByStaffId
FROM
	Gdm.GLTranslationType TT
	INNER JOIN Gdm.GLTranslationTypeActive(@DataPriorToDate) TTA ON
		TTA.ImportKey = TT.ImportKey

-- #GLTranslationSubType

INSERT INTO #GLTranslationSubType(
	ImportKey,
	GLTranslationSubTypeId,
	GLTranslationTypeId,
	Code,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsGRDefault
)
SELECT
	TST.ImportKey,
	TST.GLTranslationSubTypeId,
	TST.GLTranslationTypeId,
	TST.Code,
	TST.[Name],
	TST.IsActive,
	TST.InsertedDate,
	TST.UpdatedDate,
	TST.UpdatedByStaffId,
	TST.IsGRDefault
FROM
	Gdm.GLTranslationSubType TST
	INNER JOIN Gdm.GLTranslationSubTypeActive(@DataPriorToDate) TSTA ON
		TSTA.ImportKey = TST.ImportKey

-- #GLMajorCategory

INSERT INTO #GLMajorCategory(
	ImportKey,
	GLMajorCategoryId,
	GLTranslationSubTypeId,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	MajC.ImportKey,
	MajC.GLMajorCategoryId,
	MajC.GLTranslationSubTypeId,
	MajC.[Name],
	MajC.IsActive,
	MajC.InsertedDate,
	MajC.UpdatedDate,
	MajC.UpdatedByStaffId
FROM
	Gdm.GLMajorCategory MajC
	INNER JOIN Gdm.GLMajorCategoryActive(@DataPriorToDate) MajCA ON
		MajC.ImportKey = MajCA.ImportKey

-- #GLMinorCategory

INSERT INTO #GLMinorCategory(
	ImportKey,
	GLMinorCategoryId,
	GLMajorCategoryId,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	Minc.ImportKey,
	Minc.GLMinorCategoryId,
	Minc.GLMajorCategoryId,
	Minc.[Name],
	Minc.IsActive,
	Minc.InsertedDate,
	Minc.UpdatedDate,
	Minc.UpdatedByStaffId
FROM
	Gdm.GLMinorCategory MinC
	INNER JOIN Gdm.GLMinorCategoryActive(@DataPriorToDate) MinCA ON
		MinCA.ImportKey = MinC.ImportKey

PRINT ''Completed inserting Active records into temp table''
PRINT CONVERT(Varchar(27), getdate(), 121)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Now use the temp tables and load the #ProfitabilityOverhead
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

CREATE TABLE #ProfitabilityOverhead(
	BillingUploadDetailId INT NOT NULL,
	CorporateDepartmentCode VARCHAR(8)  NULL,
	CorporateSourceCode VARCHAR(2)  NULL,
	CanAllocateOverheads Bit NOT NULL,
	ExpensePeriod INT NOT NULL,
	AllocationRegionCode VARCHAR(6) NULL,
	OriginatingRegionCode VARCHAR(6) NULL,
	OriginatingRegionSourceCode VARCHAR(2) NULL,
	PropertyFundCode char(12) NULL,
	PropertyFundId INT NOT NULL,
	FunctionalDepartmentCode CHAR(3) NULL,
	ActivityTypeCode VARCHAR(10) NULL,
	ExpenseType VARCHAR(8) NOT NULL,
	LocalCurrency CHAR(3) NOT NULL,
	LocalActual DECIMAL(18,12) NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	InsertedDate DATETIME NOT NULL
)

INSERT INTO #ProfitabilityOverhead(
	BillingUploadDetailId,
	CorporateDepartmentCode,
	CorporateSourceCode,
	CanAllocateOverheads,
	ExpensePeriod,
	AllocationRegionCode,
	OriginatingRegionCode,
	OriginatingRegionSourceCode,
	PropertyFundId,
	FunctionalDepartmentCode,
	ActivityTypeCode,
	ExpenseType,
	LocalCurrency,
	LocalActual,
	UpdatedDate,
	InsertedDate,
	PropertyFundCode
)
SELECT 
	Bud.BillingUploadDetailId,
	
	CASE
		WHEN P1.AllocateOverheadsProjectId IS NULL THEN Bud.CorporateDepartmentCode
		ELSE P2.CorporateDepartmentCode
	END AS CorporateDepartmentCode,
	
	Bud.CorporateSourceCode,
	
	CASE
		WHEN P1.AllocateOverheadsProjectId IS NULL THEN P1.CanAllocateOverheads
		ELSE P2.CanAllocateOverheads
	END AS CanAllocateOverheads,
	
	Bu.ExpensePeriod,
	GrAr.RegionCode AllocationRegionCode, --Pr.Code AllocationRegionCode,
	Ovr.CorporateEntityRef OriginatingRegionCode,
	Ovr.CorporateSourceCode OriginatingRegionSourceCode,
	
	CASE
		WHEN (P1.AllocateOverheadsProjectId IS NULL OR P1.AllocateOverheadsProjectId = 0) THEN 
			ISNULL(DepartmentPropertyFund.PropertyFundId, -1)
		ELSE
			ISNULL(OverheadPropertyFund.PropertyFundId, -1)
	END AS PropertyFundId, --This is seen as the Gdm.Gr.GlobalPropertyFundId
	
	Fd.GlobalCode FunctionalDepartmentCode,
	At.ActivityTypeCode,
	''Overhead'' ExpenseType,
	Bud.CurrencyCode ForeignCurrency,
	Bud.AllocationAmount ForeignActual,
	Bud.UpdatedDate,
	Bud.InsertedDate,
	P1.CorporateDepartmentCode as PropertyFundCode
FROM
	#BillingUpload Bu
		
	INNER JOIN #BillingUploadDetail Bud ON
		Bud.BillingUploadId = Bu.BillingUploadId

	INNER JOIN #Overhead Oh ON
		Oh.OverheadId = Bu.OverheadId

	LEFT OUTER JOIN #FunctionalDepartment Fd ON
		Fd.FunctionalDepartmentId = Bu.OverheadFunctionalDepartmentId

	LEFT OUTER JOIN #Project P1 ON
		P1.ProjectId = Bu.ProjectId

	LEFT OUTER JOIN #Project P2 ON
		P2.ProjectId = P1.AllocateOverheadsProjectId

	-- P1 ---------------------------

	LEFT OUTER JOIN GrReporting.dbo.[Source] GrScC ON
		GrScC.SourceCode = P1.CorporateSourceCode

	/*
		2010-11-23
		The commented code below is what was previously used to determine the corporate department of an overhead actual.
		The join criteria shows that the budget project''s corporate department is used for this. This approach isn''t suitable as this field
		could change at any time (and has). A more stable strategy is to use the corporate department that is saved in the budget upload
		detail table, as this is guaranteed to never change (unless someone manually changes it via the back end).
	*/


	LEFT OUTER JOIN	#ReportingEntityCorporateDepartment RECDC ON -- added
		GrScC.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECDC.CorporateDepartmentCode = LTRIM(RTRIM(Bud.CorporateDepartmentCode)) AND
		RECDC.SourceCode = Bud.CorporateSourceCode AND
		Bu.ExpensePeriod >= 201007 AND		   
		RECDC.IsDeleted = 0
		   
	LEFT OUTER JOIN #ReportingEntityPropertyEntity REPEC ON -- added
		GrScC.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPEC.PropertyEntityCode = LTRIM(RTRIM(Bud.CorporateDepartmentCode)) AND
		REPEC.SourceCode = Bud.CorporateSourceCode AND
		Bu.ExpensePeriod >= 201007 AND
		REPEC.IsDeleted = 0

	LEFT OUTER JOIN #PropertyFundMapping pfm ON
		pfm.PropertyFundCode = Bud.CorporateDepartmentCode AND -- Combination of entity and corporate department
		pfm.SourceCode = Bud.CorporateSourceCode AND
		pfm.IsDeleted = 0 AND 
		(
			(GrScC.IsProperty = ''YES'' AND pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrScC.IsCorporate = ''YES'' AND pfm.ActivityTypeId = Bu.ActivityTypeId)
				OR
				(GrScC.IsCorporate = ''YES'' AND pfm.ActivityTypeId IS NULL AND Bu.ActivityTypeId IS NULL)
			)
		) AND Bu.ExpensePeriod < 201007

	LEFT OUTER JOIN GrReporting.dbo.PropertyFund DepartmentPropertyFund ON
		DepartmentPropertyFund.PropertyFundId =
			CASE
				WHEN Bu.ExpensePeriod < 201007 THEN pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrScC.IsCorporate = ''YES'' THEN RECDC.PropertyFundId
						ELSE REPEC.PropertyFundId
					END
			END AND
		Bu.UpdatedDate BETWEEN DepartmentPropertyFund.StartDate AND DepartmentPropertyFund.EndDate AND
		DepartmentPropertyFund.SnapshotId = 0

	-- P1 end -----------------------
	-- P2 begin ---------------------

	LEFT OUTER JOIN GrReporting.dbo.[Source] GrScO
		ON GrScO.SourceCode = P2.CorporateSourceCode

    /*
		2010-11-23
		Unlike the previous three joins used to determine the reporting entity, the joins below are still required to used the budget project''s
		corporate department code when determining the reporting entity for the case when the AllocatedOverheadProjectID is not null. This is
		not ideal as again, the corporate department associated with this project could change, but it''s GR''s best effort as it stands as TAPAS
		is unable to snapshot data. When the GR rolling window begins to be used as it was intended, the potential inconsistencies that this
		may cause will be limited as the window will be much smaller than what it is currently set to.
    */
    
	LEFT OUTER JOIN	#ReportingEntityCorporateDepartment RECDO ON -- added
		GrScO.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECDO.CorporateDepartmentCode = LTRIM(RTRIM(P2.CorporateDepartmentCode)) AND
		RECDO.SourceCode = P2.CorporateSourceCode AND
		Bu.ExpensePeriod >= ''201007''  AND			   
		RECDO.IsDeleted = 0
		   
	LEFT OUTER JOIN #ReportingEntityPropertyEntity REPEO ON -- added
		GrScO.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPEO.PropertyEntityCode = LTRIM(RTRIM(P2.CorporateDepartmentCode)) AND
		REPEO.SourceCode = P2.CorporateSourceCode AND
		Bu.ExpensePeriod >= ''201007''  AND
		REPEO.IsDeleted = 0

	LEFT OUTER JOIN #PropertyFundMapping opfm ON
		P2.CorporateDepartmentCode = opfm.PropertyFundCode AND -- Combination of entity and corporate department
		P2.CorporateSourceCode = opfm.SourceCode AND
		opfm.IsDeleted = 0  AND 
		(
			(GrScO.IsProperty = ''YES'' AND opfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrScO.IsCorporate = ''YES'' AND opfm.ActivityTypeId = Bu.ActivityTypeId)
				OR
				(GrScO.IsCorporate = ''YES'' AND opfm.ActivityTypeId IS NULL AND Bu.ActivityTypeId IS NULL) 
			)	
		) AND Bu.ExpensePeriod < ''201007'' 

	LEFT OUTER JOIN GrReporting.dbo.PropertyFund OverheadPropertyFund ON
		OverheadPropertyFund.PropertyFundId =
			CASE
				WHEN Bu.ExpensePeriod < 201007 THEN opfm.PropertyFundId
				ELSE
					CASE
						WHEN GrScO.IsCorporate = ''YES'' THEN RECDO.PropertyFundId
						ELSE REPEO.PropertyFundId
					END
			END AND
		Bu.UpdatedDate BETWEEN OverheadPropertyFund.StartDate AND OverheadPropertyFund.EndDate AND
		OverheadPropertyFund.SnapshotId = 0

	-- P2 end -----------------------

	LEFT OUTER JOIN #PropertyFund PF ON
		PF.PropertyFundId = (
								CASE
									WHEN (P1.AllocateOverheadsProjectId IS NULL OR P1.AllocateOverheadsProjectId = 0) THEN 
										ISNULL(DepartmentPropertyFund.PropertyFundId, -1)
									ELSE
										ISNULL(OverheadPropertyFund.PropertyFundId, -1)
								END
							) --AND
		--PF.IsActive = 1
		
	LEFT OUTER JOIN #AllocationSubRegion ASR ON
		PF.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId --AND
		--ASR.IsActive = 1		

	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion GrAr ON
		GrAr.GlobalRegionId = ASR.AllocationSubRegionGlobalRegionId AND
		Bu.UpdatedDate BETWEEN GrAr.StartDate AND GrAr.EndDate AND
		GrAr.SnapshotId = 0

	LEFT OUTER JOIN #ActivityType At ON
		At.ActivityTypeId = Bu.ActivityTypeId

	LEFT OUTER JOIN #OverheadRegion Ovr ON
		Ovr.OverheadRegionId = Bu.OverheadRegionId

WHERE
	Bu.BillingUploadBatchId IS NOT NULL AND
	Bud.BillingUploadDetailTypeId <> 2 
	--AND ISNULL(Bu.UpdatedDate, Bu.UpdatedDate) BETWEEN @ImportStartDate AND @ImportEndDate --NOTE:: GC I am note sure it can work with the date filter

--IMS 48953 - Exclude overhead mark up from the import

PRINT ''Rows Inserted into #ProfitabilityOverhead:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(Varchar(27), getdate(), 121)

-- Change control 7 - begin

PRINT ''Deleting records in #ProfitabilityOverhead which are associated with entries in the ManageCorporateEntity and ManageCorporateDepartment tables''
PRINT CONVERT(Varchar(27), getdate(), 121)

DELETE
	PO
FROM
	#ProfitabilityOverhead PO
	INNER JOIN #ManageCorporateEntity MCE ON
		PO.OriginatingRegionCode = MCE.CorporateEntityCode AND
		PO.CorporateSourceCode = MCE.SourceCode
WHERE
	MCE.IsDeleted = 0 AND
	RIGHT(MCE.SourceCode, 1) = ''C'' AND
	RIGHT(PO.CorporateSourceCode, 1) = ''C''	

PRINT (CONVERT(char(10),@@rowcount) + '' records deleted from #ProfitabilityOverhead'')

DELETE
	PO
FROM
	#ProfitabilityOverhead PO
	INNER JOIN #ManageCorporateDepartment MCD ON
		PO.PropertyFundCode = MCD.CorporateDepartmentCode AND
		PO.CorporateSourceCode = MCD.SourceCode
WHERE
	MCD.IsDeleted = 0 AND
	RIGHT(MCD.SourceCode, 1) = ''C'' AND	
	RIGHT(PO.CorporateSourceCode, 1) = ''C''	

PRINT (CONVERT(char(10),@@rowcount) + '' records deleted from #ProfitabilityOverhead'')

PRINT ''Finished deleting from #ProfitabilityOverhead''
PRINT CONVERT(Varchar(27), getdate(), 121)

-- Change control 7 - end

--------------------------------------------------------------------------------------------------------------------------------------
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Take the different sources and combine them into the "REAL" fact table
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--If the join is not possible, default the link to the ''UNKNOWN'' link
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

CREATE TABLE #ProfitabilityActual(
	CalendarKey INT NOT NULL,
	GlAccountKey INT NOT NULL,
	SourceKey INT NOT NULL,
	FunctionalDepartmentKey INT NOT NULL,
	ReimbursableKey INT NOT NULL,
	ActivityTypeKey INT NOT NULL,
	OriginatingRegionKey INT NOT NULL,
	AllocationRegionKey INT NOT NULL,
	PropertyFundKey INT NOT NULL,
	OverheadKey INT NOT NULL,
	ReferenceCode VARCHAR(100) NOT NULL,
	LocalCurrencyKey INT NOT NULL,
	LocalActual MONEY NOT NULL,
	ProfitabilityActualSourceTableId INT NOT NULL,
	
	EUCorporateGlAccountCategoryKey INT NULL,
	EUPropertyGlAccountCategoryKey INT NULL,
	EUFundGlAccountCategoryKey INT NULL,

	USPropertyGlAccountCategoryKey INT NULL,
	USCorporateGlAccountCategoryKey INT NULL,
	USFundGlAccountCategoryKey INT NULL,

	GlobalGlAccountCategoryKey INT NULL,
	DevelopmentGlAccountCategoryKey INT NULL,
	
	OriginatingRegionCode char(6) NULL,
	PropertyFundCode char(12) NULL,
	FunctionalDepartmentCode char(15) NULL 
) 

INSERT INTO #ProfitabilityActual(
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	OriginatingRegionKey,
	AllocationRegionKey,
	PropertyFundKey,
	OverheadKey,
	ReferenceCode,
	LocalCurrencyKey,
	LocalActual,
	ProfitabilityActualSourceTableId,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode
)
SELECT 
	DATEDIFF(dd, ''1900-01-01'', LEFT(Gl.ExpensePeriod, 4) + ''-'' + RIGHT(Gl.ExpensePeriod, 2) + ''-01'') CalendarKey,
	--,ISNULL(@OverheadGlAccountKeyUnknown, @GlAccountKeyUnknown) GlAccountKey,
	CASE WHEN GrGa.GlAccountKey IS NULL THEN @GlAccountKeyUnknown ELSE GrGa.GlAccountKey END GlAccountKey,
	CASE WHEN GrSc.SourceKey IS NULL THEN @SourceKeyUnknown ELSE GrSc.SourceKey END SourceKey,
	CASE WHEN GrFdm.FunctionalDepartmentKey IS NULL THEN @FunctionalDepartmentKeyUnknown ELSE GrFdm.FunctionalDepartmentKey END FunctionalDepartmentKey,
	CASE WHEN GrRi.ReimbursableCode IS NULL THEN @ReimbursableKeyUnknown ELSE GrRi.ReimbursableKey END ReimbursableKey,
	CASE WHEN GrAt.ActivityTypeKey IS NULL THEN @ActivityTypeKeyUnknown ELSE GrAt.ActivityTypeKey END ActivityTypeKey,
	CASE WHEN GrOr.OriginatingRegionKey IS NULL THEN @OriginatingRegionKeyUnknown ELSE GrOr.OriginatingRegionKey END OriginatingRegionKey,
	CASE WHEN GrAr.AllocationRegionKey IS NULL THEN @AllocationRegionKeyUnknown ELSE GrAr.AllocationRegionKey END AllocationRegionKey,
	CASE WHEN GrPf.PropertyFundKey IS NULL THEN @PropertyFundKeyUnknown ELSE GrPf.PropertyFundKey END PropertyFundKey,
	CASE WHEN GrOh.OverheadKey IS NULL THEN @OverheadKeyUnknown ELSE GrOh.OverheadKey END OverheadKey,
		''BillingUploadDetailId='' + LTRIM(STR(Gl.BillingUploadDetailId, 10, 0)),
	Cu.CurrencyKey,
	Gl.LocalActual,
	3 ProfitabilityActualSourceTableId, --BillingUploadDetail
	Gl.OriginatingRegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode
	

FROM
	#ProfitabilityOverhead Gl

	LEFT OUTER JOIN GrReporting.dbo.Currency Cu ON
		Cu.CurrencyCode = Gl.LocalCurrency

	LEFT OUTER JOIN GrReporting.dbo.FunctionalDepartment GrFdm ON
		GrFdm.FunctionalDepartmentCode = Gl.FunctionalDepartmentCode AND
		GrFdm.SubFunctionalDepartmentCode = Gl.FunctionalDepartmentCode AND
		Gl.UpdatedDate BETWEEN GrFdm.StartDate AND ISNULL(GrFdm.EndDate, Gl.UpdatedDate)

	LEFT OUTER JOIN #ActivityType At ON
		At.ActivityTypeCode = Gl.ActivityTypeCode 
		
	LEFT OUTER JOIN GrReporting.dbo.ActivityType GrAt ON
		GrAt.ActivityTypeId = At.ActivityTypeId AND
		Gl.UpdatedDate BETWEEN GrAt.StartDate AND ISNULL(GrAt.EndDate, Gl.UpdatedDate) AND
		GrAt.SnapshotId = 0
	
	LEFT OUTER JOIN GrReporting.dbo.Overhead GrOh ON
		GrOh.OverheadCode = ''ALLOC''
		
	LEFT OUTER JOIN #ActivityTypeGLAccount AtGla ON
		AtGla.ActivityTypeId = At.ActivityTypeId

	LEFT OUTER JOIN #GLGlobalAccount GA ON
		GA.Code = AtGla.GLAccountCode AND
		ISNULL(AtGla.ActivityTypeId, 0) = ISNULL(GA.ActivityTypeId, 0) -- Nulls for header (00) accounts. (Should really have an activity for this)

	LEFT OUTER JOIN GrReporting.dbo.GlAccount GrGA ON
		GrGA.GLGlobalAccountId = GA.GLGlobalAccountId AND
		Gl.UpdatedDate BETWEEN GrGA.StartDate AND GrGA.EndDate AND
		GrGA.SnapshotId = 0
		
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON
		GrSc.SourceCode = Gl.CorporateSourceCode
	
	LEFT OUTER JOIN GrReporting.dbo.PropertyFund GrPf ON
		GrPf.PropertyFundId = Gl.PropertyFundId AND
		Gl.UpdatedDate BETWEEN GrPf.StartDate AND ISNULL(GrPf.EndDate, Gl.UpdatedDate) AND
		GrPf.SnapshotId = 0

	LEFT OUTER JOIN #OriginatingRegionCorporateEntity ORCE ON
		ORCE.CorporateEntityCode = Gl.OriginatingRegionCode AND
		ORCE.SourceCode = Gl.OriginatingRegionSourceCode AND
		ORCE.IsDeleted = 0
			   
	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion GrOr ON
		GrOr.GlobalRegionId = ORCE.GlobalRegionId AND
		--GrOr.GlobalRegionId = ORPD.GlobalRegionId AND
		Gl.UpdatedDate BETWEEN GrOr.StartDate AND ISNULL(GrOr.EndDate, Gl.UpdatedDate) AND
		GrOr.SnapshotId = 0
	
	LEFT OUTER JOIN #PropertyFund PF ON
		PF.PropertyFundId = Gl.PropertyFundId --AND
		--PF.IsActive = 1

	LEFT OUTER JOIN #AllocationSubRegion ASR ON
		PF.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId --AND
		--ASR.IsActive = 1		

	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion GrAr ON
		GrAr.GlobalRegionId = ASR.AllocationSubRegionGlobalRegionId AND
		Gl.UpdatedDate BETWEEN GrAr.StartDate AND ISNULL(GrAr.EndDate, Gl.UpdatedDate) AND
		GrAr.SnapshotId = 0

	LEFT OUTER JOIN (
						SELECT ''UC'' SOURCECODE, DEPARTMENT, NETTSCOST FROM USCorp.GDEP UNION ALL
						SELECT ''EC'' SOURCECODE, DEPARTMENT, NETTSCOST FROM EUCorp.GDEP UNION ALL
						SELECT ''IC'' SOURCECODE, DEPARTMENT, NETTSCOST FROM INCorp.GDEP UNION ALL
						SELECT ''BC'' SOURCECODE, DEPARTMENT, NETTSCOST FROM BRCorp.GDEP UNION ALL
						SELECT ''CC'' SOURCECODE, DEPARTMENT, NETTSCOST FROM CNCorp.GDEP
					) RiCo ON
		RiCo.DEPARTMENT = Gl.CorporateDepartmentCode AND
		RiCo.SOURCECODE = Gl.CorporateSourceCode	

	LEFT OUTER JOIN GrReporting.dbo.Reimbursable GrRi ON
		GrRi.ReimbursableCode = CASE
									WHEN ISNULL(RiCo.NETTSCOST, ''N'') = ''Y'' THEN ''NO'' ELSE ''YES''
								END								

WHERE
	Gl.UpdatedDate BETWEEN @ImportStartDate AND @ImportEndDate

----Prepare data for later Clean-up of Key''s that have changed and 
----as such left the current record to be not required anymore	
--Update GrReporting.dbo.ProfitabilityActual
--SET 	
--Actual						= 0
--Where	SourceKey	IN (Select DISTINCT SourceKey From #ProfitabilityActual)
--AND		CalendarKey	BETWEEN DATEDIFF(dd,''1900-01-01'', @ImportStartDate) AND 
--							 DATEDIFF(dd,''1900-01-01'', @ImportEndDate)
--Transfer the updated rows
	
-------------------------------------------------------------------------------------------------------------------
--GlobalGlAccountCategoryKey
UPDATE
	#ProfitabilityActual
SET
	GlobalGlAccountCategoryKey = CASE WHEN GLAC.GlAccountCategoryKey IS NULL THEN @GlobalGlAccountCategoryKeyUnknown ELSE GLAC.GlAccountCategoryKey END
FROM #ProfitabilityActual Gl

	LEFT OUTER JOIN 
	(
		SELECT	
			Gla.GlAccountKey,
			TST.GLTranslationTypeId,
			TST.GLTranslationSubTypeId,
			MinC.GLMajorCategoryId,
			GLATST.GLMinorCategoryId,
			GLATT.GLAccountTypeId,
			GLATT.GLAccountSubTypeId
		FROM	
			#GLTranslationSubType TST 

			INNER JOIN #GLGlobalAccountTranslationSubType GLATST ON
				TST.GLTranslationSubTypeId = GLATST.GLTranslationSubTypeId AND
				GLATST.IsActive = 1
			
			INNER JOIN #GLGlobalAccountTranslationType GLATT ON
				GLATST.GLGlobalAccountId = GLATT.GLGlobalAccountId AND
				TST.GLTranslationTypeId = GLATT.GLTranslationTypeId AND
				GLATT.IsActive = 1

			INNER JOIN GrReporting.dbo.GlAccount Gla ON
				GLATT.GLGlobalAccountId = GLA.GLGlobalAccountId AND
				Gla.SnapshotId = 0

			INNER JOIN #GLMinorCategory MinC ON
				GLATST.GLMinorCategoryId = MinC.GLMinorCategoryId AND
				MinC.IsActive = 1

			INNER JOIN #GLMajorCategory MajC ON
				MinC.GLMajorCategoryId = MajC.GLMajorCategoryId AND
				MajC.IsActive = 1

		WHERE 
				TST.Code = ''GL'' AND 
				TST.IsActive = 1
	) as GLAD ON
		GLAD.GlAccountKey = Gl.GlAccountKey
	
	LEFT OUTER JOIN GrReporting.dbo.GlAccountCategory GLAC ON
		Gl.CalendarKey BETWEEN GLAC.StartDate AND GLAC.EndDate AND
		GLAC.GlobalGlAccountCategoryCode = CONVERT(VARCHAR(32),
											CONVERT(VARCHAR(8), GLAD.GLTranslationTypeId) + '':'' + 
											CONVERT(VARCHAR(8), GLAD.GLTranslationSubTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLAD.GLMajorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLAD.GLMinorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GLAD.GLAccountTypeId) + '':'' +
											CONVERT(VARCHAR(8), GLAD.GLAccountSubTypeId)) AND
		GLAC.SnapshotId = 0


PRINT ''Completed converting all GlobalGlAccountCategoryKey keys:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)


CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #ProfitabilityActual (SourceKey, ReferenceCode)
PRINT ''Completed building clustered index on #ProfitabilityActual''
PRINT CONVERT(Varchar(27), getdate(), 121)

UPDATE
	GrReporting.dbo.ProfitabilityActual
SET 	
	CalendarKey						 = Pro.CalendarKey,
	GlAccountKey					 = Pro.GlAccountKey,
	FunctionalDepartmentKey			 = Pro.FunctionalDepartmentKey,
	ReimbursableKey					 = Pro.ReimbursableKey,
	ActivityTypeKey					 = Pro.ActivityTypeKey,
	OriginatingRegionKey			 = Pro.OriginatingRegionKey,
	AllocationRegionKey				 = Pro.AllocationRegionKey,
	PropertyFundKey					 = Pro.PropertyFundKey,
	OverheadKey						 = Pro.OverheadKey,
	LocalCurrencyKey				 = Pro.LocalCurrencyKey,
	LocalActual						 = Pro.LocalActual,
	ProfitabilityActualSourceTableId = Pro.ProfitabilityActualSourceTableId,
		
	EUCorporateGlAccountCategoryKey	 = @EUCorporateGlAccountCategoryKeyUnknown, --Pro.EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey	 = @EUPropertyGlAccountCategoryKeyUnknown, --Pro.EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey		 = @EUFundGlAccountCategoryKeyUnknown, --Pro.EUFundGlAccountCategoryKey,

	USPropertyGlAccountCategoryKey	 = @USPropertyGlAccountCategoryKeyUnknown, --Pro.USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey	 = @USCorporateGlAccountCategoryKeyUnknown, --Pro.USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey		 = @USFundGlAccountCategoryKeyUnknown, --Pro.USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey		 = Pro.GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey	 = @DevelopmentGlAccountCategoryKeyUnknown, --Pro.DevelopmentGlAccountCategoryKey
	
	OriginatingRegionCode			 = Pro.OriginatingRegionCode,
	PropertyFundCode				 = Pro.PropertyFundCode,
	FunctionalDepartmentCode		 = Pro.FunctionalDepartmentCode
	
FROM
	#ProfitabilityActual Pro
WHERE
	ProfitabilityActual.SourceKey = Pro.SourceKey AND
	ProfitabilityActual.ReferenceCode = Pro.ReferenceCode

PRINT ''Rows Updated in Profitability:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(Varchar(27), getdate(), 121)

--Transfer the new rows
INSERT INTO GrReporting.dbo.ProfitabilityActual(
	CalendarKey,
	GlAccountKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	SourceKey,
	OriginatingRegionKey,
	AllocationRegionKey,
	PropertyFundKey,
	OverheadKey,
	ReferenceCode,
	LocalCurrencyKey,
	LocalActual,
	ProfitabilityActualSourceTableId,
	EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,
	USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey,
	GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey,
	
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode
)
SELECT
	Pro.CalendarKey,
	Pro.GlAccountKey,
	Pro.FunctionalDepartmentKey,
	Pro.ReimbursableKey,
	Pro.ActivityTypeKey,
	Pro.SourceKey,
	Pro.OriginatingRegionKey,
	Pro.AllocationRegionKey,
	Pro.PropertyFundKey,
	Pro.OverheadKey,
	Pro.ReferenceCode, 
	Pro.LocalCurrencyKey, 
	Pro.LocalActual,
	Pro.ProfitabilityActualSourceTableId, --BillingUploadDetail

	@EUCorporateGlAccountCategoryKeyUnknown, --Pro.EUCorporateGlAccountCategoryKey,
	@EUPropertyGlAccountCategoryKeyUnknown, --Pro.EUPropertyGlAccountCategoryKey,
	@EUFundGlAccountCategoryKeyUnknown, --Pro.EUFundGlAccountCategoryKey,

	@USPropertyGlAccountCategoryKeyUnknown, --Pro.USPropertyGlAccountCategoryKey,
	@USCorporateGlAccountCategoryKeyUnknown, ----Pro.USCorporateGlAccountCategoryKey,
	@USFundGlAccountCategoryKeyUnknown, --Pro.USFundGlAccountCategoryKey,

	Pro.GlobalGlAccountCategoryKey,
	@DevelopmentGlAccountCategoryKeyUnknown, --Pro.DevelopmentGlAccountCategoryKey
	
	Pro.OriginatingRegionCode,
	Pro.PropertyFundCode,
	Pro.FunctionalDepartmentCode				
FROM
	#ProfitabilityActual Pro
	LEFT OUTER JOIN GrReporting.dbo.ProfitabilityActual ProExists ON
		ProExists.SourceKey	= Pro.SourceKey AND
		ProExists.ReferenceCode	= Pro.ReferenceCode

WHERE
	ProExists.SourceKey IS NULL

PRINT ''Rows Inserted in Profitability:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(Varchar(27), getdate(), 121)
--Uploaded BillingUploads should never be deleted ....
--hence we should never have to delete records

-- remove orphan rows from the warehouse that have been removed in the source data systems
EXEC stp_IU_ArchiveProfitabilityOverheadActual @ImportStartDate=@ImportStartDate, @ImportEndDate=@ImportEndDate, @DataPriorToDate=@DataPriorToDate

DROP TABLE #ManageType
DROP TABLE #ManageCorporateDepartment
DROP TABLE #ManageCorporateEntity
DROP TABLE #ManagePropertyDepartment
DROP TABLE #ManagePropertyEntity

DROP TABLE #ActivityTypeGLAccount
DROP TABLE #AllocationRegion
DROP TABLE #AllocationSubRegion
DROP TABLE #BillingUpload
DROP TABLE #BillingUploadDetail
DROP TABLE #Overhead
DROP TABLE #FunctionalDepartment
DROP TABLE #Project
DROP TABLE #PropertyFund
DROP TABLE #PropertyFundMapping
DROP TABLE #ReportingEntityCorporateDepartment
DROP TABLE #ReportingEntityPropertyEntity
DROP TABLE #OriginatingRegionCorporateEntity
DROP TABLE #OriginatingRegionPropertyDepartment
DROP TABLE #GLGlobalAccount
DROP TABLE #ActivityType
DROP TABLE #OverheadRegion
DROP TABLE #GLTranslationType
DROP TABLE #GLTranslationSubType
DROP TABLE #GLGlobalAccountTranslationType
DROP TABLE #GLGlobalAccountTranslationSubType
DROP TABLE #GLMajorCategory
DROP TABLE #GLMinorCategory
DROP TABLE #ProfitabilityOverhead
DROP TABLE #ProfitabilityActual

' 
END
GO
/****** Object:  StoredProcedure [dbo].[stp_IU_LoadGrProfitabiltyGeneralLedger]    Script Date: 05/16/2011 08:15:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[stp_IU_LoadGrProfitabiltyGeneralLedger]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[stp_IU_LoadGrProfitabiltyGeneralLedger]
	@ImportStartDate	DateTime=NULL,
	@ImportEndDate		DateTime=NULL,
	@DataPriorToDate	DateTime=NULL
AS
IF (@ImportStartDate IS NULL)
	BEGIN
	SET @ImportStartDate = CONVERT(DateTime,(select ConfiguredValue From SSISConfigurations Where ConfigurationFilter = ''ActualImportStartDate''))
	END

IF (@ImportEndDate IS NULL)
	BEGIN
	SET @ImportEndDate = CONVERT(DateTime,(select ConfiguredValue From SSISConfigurations Where ConfigurationFilter = ''ActualImportEndDate''))
	END

IF (@DataPriorToDate IS NULL)
	BEGIN
	SET @DataPriorToDate = CONVERT(DateTime,(select ConfiguredValue From SSISConfigurations Where ConfigurationFilter = ''ActualDataPriorToDate''))
	END

DECLARE 
		@GlAccountKeyUnknown INT,
		@GlAccountCategoryKey INT,
		@FunctionalDepartmentKeyUnknown INT,
		@ReimbursableKeyUnknown INT,
		@ActivityTypeKeyUnknown INT,
		@SourceKeyUnknown INT,
		@OriginatingRegionKeyUnknown INT,
		@AllocationRegionKeyUnknown INT,
		@PropertyFundKeyUnknown INT,
		@OverheadKeyUnknown INT,
		-- @CurrencyKey	INT,
		@EUFundGlAccountCategoryKeyUnknown	INT,
		@EUCorporateGlAccountCategoryKeyUnknown INT,
		@EUPropertyGlAccountCategoryKeyUnknown	INT,
		@USFundGlAccountCategoryKeyUnknown INT,
		@USPropertyGlAccountCategoryKeyUnknown	INT,
		@USCorporateGlAccountCategoryKeyUnknown INT,
		@DevelopmentGlAccountCategoryKeyUnknown INT,
		@GlobalGlAccountCategoryKeyUnknown INT
      
--Default FK for the Fact table
/*

DECLARE	@ImportStartDate DateTime
DECLARE	@ImportEndDate DateTime
DECLARE	@DataPriorToDate DateTime

SET	@ImportStartDate = ''1900-01-01''
SET	@ImportEndDate = ''2010-12-31''
SET	@DataPriorToDate = ''2010-12-31''

[stp_IU_LoadGrProfitabiltyGeneralLedgerVer2]
	@ImportStartDate	= ''1900-01-01'',
	@ImportEndDate		= ''2010-12-31'',
	@DataPriorToDate	= ''2010-12-31''
*/       
SET @GlAccountKeyUnknown			= (SELECT GlAccountKey FROM GrReporting.dbo.GlAccount WHERE Code = ''UNKNOWN'' AND SnapshotId = 0) -- GDM: changed GlAccountCode to Code
SET @FunctionalDepartmentKeyUnknown = (SELECT FunctionalDepartmentKey FROM GrReporting.dbo.FunctionalDepartment WHERE FunctionalDepartmentCode = ''UNKNOWN'')
SET @ReimbursableKeyUnknown		    = (SELECT ReimbursableKey FROM GrReporting.dbo.Reimbursable WHERE ReimbursableCode = ''UNKNOWN'')
SET @ActivityTypeKeyUnknown		    = (SELECT ActivityTypeKey FROM GrReporting.dbo.ActivityType WHERE ActivityTypeCode = ''UNKNOWN'')
SET @SourceKeyUnknown				= (SELECT SourceKey FROM GrReporting.dbo.Source WHERE SourceName = ''UNKNOWN'')
SET @OriginatingRegionKeyUnknown	= (SELECT OriginatingRegionKey FROM GrReporting.dbo.OriginatingRegion WHERE RegionCode = ''UNKNOWN'' AND SnapshotId = 0)
SET @AllocationRegionKeyUnknown	    = (SELECT AllocationRegionKey FROM GrReporting.dbo.AllocationRegion WHERE RegionCode = ''UNKNOWN'' AND SnapshotId = 0)
SET @PropertyFundKeyUnknown		    = (SELECT PropertyFundKey FROM GrReporting.dbo.PropertyFund WHERE PropertyFundName = ''UNKNOWN'' AND SnapshotId = 0)
--SET @CurrencyKey			 = (Select CurrencyKey From GrReporting.dbo.Currency Where CurrencyCode = ''UNK'')
SET @OverheadKeyUnknown				= (SELECT OverheadKey FROM GrReporting.dbo.Overhead WHERE OverheadName = ''UNKNOWN'')

SET @EUFundGlAccountCategoryKeyUnknown      = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)
SET @EUCorporateGlAccountCategoryKeyUnknown = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)
SET @EUPropertyGlAccountCategoryKeyUnknown  = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''EU Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)
SET @USFundGlAccountCategoryKeyUnknown      = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Fund Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)
SET @USPropertyGlAccountCategoryKeyUnknown  = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Property Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)
SET @USCorporateGlAccountCategoryKeyUnknown = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''US Corporate Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)
SET @DevelopmentGlAccountCategoryKeyUnknown = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global Profit & Loss'' AND TranslationSubTypeName = ''Development Profit & Loss'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)
SET @GlobalGlAccountCategoryKeyUnknown      = (SELECT GlAccountCategoryKey FROM GrReporting.dbo.GlAccountCategory WHERE TranslationTypeName = ''Global'' AND TranslationSubTypeName = ''Global'' AND MajorCategoryName = ''UNKNOWN'' AND MinorCategoryName = ''UNKNOWN'' AND FeeOrExpense = ''UNKNOWN'' AND AccountSubTypeName = ''UNKNOWN'' AND SnapshotId = 0)

IF (@DataPriorToDate IS NULL)
	SET @DataPriorToDate = GETDATE()

IF 	(@DataPriorToDate < ''2010-01-01'')
	SET @DataPriorToDate = ''2010-01-01''
	
SET NOCOUNT ON
PRINT ''####''
PRINT ''stp_IU_LoadGrProfitabiltyGeneralLedger''
PRINT CONVERT(VARCHAR(27), getdate(), 121)
PRINT ''####''

----- Temp table creation and data inserts - Change Control 7

CREATE TABLE #ManageType(
	ImportKey INT NOT NULL,
	ManageTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #ManageCorporateDepartment(
	ImportKey INT NOT NULL,
	ManageCorporateDepartmentId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	CorporateDepartmentCode CHAR(8) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #ManageCorporateEntity(
	ImportKey INT NOT NULL,
	ManageCorporateEntityId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	CorporateEntityCode CHAR(6) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)


CREATE TABLE #ManagePropertyDepartment(
	ImportKey INT NOT NULL,
	ManagePropertyDepartmentId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	PropertyDepartmentCode CHAR(8) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #ManagePropertyEntity(
	ImportKey INT NOT NULL,
	ManagePropertyEntityId INT NOT NULL,
	ManageTypeId INT NOT NULL,
	PropertyEntityCode CHAR(6) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	IsDeleted BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)
----

-- #ManageType

INSERT INTO #ManageType(
	ImportKey,
	ManageTypeId,
	Code,
	Name,
	[Description],
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MT.ImportKey,
	MT.ManageTypeId,
	MT.Code,
	MT.Name,
	MT.[Description],
	MT.IsDeleted,
	MT.InsertedDate,
	MT.UpdatedDate
FROM
	Gdm.ManageType MT
	INNER JOIN Gdm.ManageTypeActive(@DataPriorToDate) MTA ON
		MT.ImportKey = MTA.ImportKey
		
-- #ManageCorporateDepartment

INSERT INTO #ManageCorporateDepartment(
	ImportKey,
	ManageCorporateDepartmentId,
	ManageTypeId,
	CorporateDepartmentCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MCD.ImportKey,
	MCD.ManageCorporateDepartmentId,
	MCD.ManageTypeId,
	MCD.CorporateDepartmentCode,
	MCD.SourceCode,
	MCD.IsDeleted,
	MCD.InsertedDate,
	MCD.UpdatedDate 
FROM
	Gdm.ManageCorporateDepartment MCD
	INNER JOIN Gdm.ManageCorporateDepartmentActive(@DataPriorToDate) MCDA ON
		MCD.ImportKey = MCDA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MCD.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-- #ManageCorporateEntity

INSERT INTO #ManageCorporateEntity(
	ImportKey,
	ManageCorporateEntityId,
	ManageTypeId,
	CorporateEntityCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MCE.ImportKey,
	MCE.ManageCorporateEntityId,
	MCE.ManageTypeId,
	MCE.CorporateEntityCode,
	MCE.SourceCode,
	MCE.IsDeleted,
	MCE.InsertedDate,
	MCE.UpdatedDate 
FROM
	Gdm.ManageCorporateEntity MCE
	INNER JOIN Gdm.ManageCorporateEntityActive(@DataPriorToDate) MCEA ON
		MCE.ImportKey = MCEA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MCE.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-- #ManagePropertyDepartment

INSERT INTO #ManagePropertyDepartment(
	ImportKey,
	ManagePropertyDepartmentId,
	ManageTypeId,
	PropertyDepartmentCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MPD.ImportKey,
	MPD.ManagePropertyDepartmentId,
	MPD.ManageTypeId,
	MPD.PropertyDepartmentCode,
	MPD.SourceCode,
	MPD.IsDeleted,
	MPD.InsertedDate,
	MPD.UpdatedDate 
FROM
	Gdm.ManagePropertyDepartment MPD
	INNER JOIN Gdm.ManagePropertyDepartmentActive(@DataPriorToDate) MPDA ON
		MPD.ImportKey = MPDA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MPD.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-- #ManagePropertyEntity

INSERT INTO #ManagePropertyEntity(
	ImportKey,
	ManagePropertyEntityId,
	ManageTypeId,
	PropertyEntityCode,
	SourceCode,
	IsDeleted,
	InsertedDate,
	UpdatedDate  
)
SELECT
	MPE.ImportKey,
	MPE.ManagePropertyEntityId,
	MPE.ManageTypeId,
	MPE.PropertyEntityCode,
	MPE.SourceCode,
	MPE.IsDeleted,
	MPE.InsertedDate,
	MPE.UpdatedDate 
FROM
	Gdm.ManagePropertyEntity MPE
	INNER JOIN Gdm.ManagePropertyEntityActive(@DataPriorToDate) MPEA ON
		MPE.ImportKey = MPEA.ImportKey
	INNER JOIN #ManageType MT ON
		MT.ManageTypeId = MPE.ManageTypeId
WHERE
	MT.Code = ''GMREXCL''

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Master Temp table for the combined ledger results from MRI Sources
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

CREATE TABLE #ProfitabilityGeneralLedger(
	SourcePrimaryKey VARCHAR(100) NULL,
	SourceTableId INT NOT NULL,
	SourceCode VARCHAR(2) NOT NULL,
	Period CHAR(6) NOT NULL,
	OriginatingRegionCode CHAR(6) NOT NULL,
	PropertyFundCode CHAR(12) NOT NULL,
	FunctionalDepartmentCode CHAR(15) NULL,
	JobCode CHAR(15) NULL,
	GlAccountCode CHAR(12) NOT NULL,
	LocalCurrency CHAR(3) NOT NULL,
	LocalActual MONEY NOT NULL,
	EnterDate DATETIME NULL,
	[User] NVARCHAR(20) NULL,
	[Description] NCHAR(60) NULL,
	AdditionalDescription NVARCHAR(4000) NULL,
	Basis CHAR(1) NOT NULL,
	LastDate DATETIME NULL,
	GlAccountSuffix VARCHAR(2) NULL,
	NetTSCost CHAR(1) NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--US PROP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger (
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate
)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	''USD'' ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000), ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	''N'',
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM 
	USProp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					USProp.GeneralLedger Gl
				GROUP BY 
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND
		t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					USProp.ENTITY En
					INNER JOIN USProp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.PropertyFundCode
			
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					USProp.GACC Ga
					INNER JOIN USProp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode

WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Gl.CorporateDepartmentCode, ''N'') = ''N'' AND
	Gl.BALFOR <> ''B'' AND
	RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99'' AND
	( -- Change Control 6
		ISNULL(Ga.IsGR, ''N'') = ''Y''
			OR
		Ga.ACCTNUM IN ( SELECT
							PEAI.GLAccountCode
						FROM
							(
								SELECT
									PEAI.*
								FROM							
									Gdm.PropertyEntityGLAccountInclusion PEAI
									INNER JOIN Gdm.PropertyEntityGLAccountInclusionActive(@DataPriorToDate) PEAIA ON
										PEAIA.ImportKey = PEAI.ImportKey
							) PEAI
						WHERE
							PEAI.PropertyEntityCode = Gl.PropertyFundCode AND
							PEAI.IsDeleted = 0 AND
							PEAI.SourceCode = ''US'')
	) AND
	
	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Property Entity

		SELECT
			MPE.PropertyEntityCode
		FROM
			#ManagePropertyEntity MPE
		WHERE
			MPE.SourceCode = ''US'' AND
			MPE.IsDeleted = 0

	) AND
	(LTRIM(RTRIM(Gl.RegionCode)) + LTRIM(RTRIM(Gl.FunctionalDepartmentCode))) NOT IN ( -- exclude Property Department
	
		SELECT
			MPD.PropertyDepartmentCode
		FROM
			#ManagePropertyDepartment MPD
		WHERE
			MPD.SourceCode = ''US'' AND
			MPD.IsDeleted = 0
	)

	-- Change Control 7: IS - end

PRINT ''US PROP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--US CORP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,

	''USD'' ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000), ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	ISNULL(Gd.NETTSCOST, ''N'') NetTSCost,
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM USCorp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					USCorp.GeneralLedger Gl
				GROUP BY
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND
		t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					USCorp.ENTITY En
					INNER JOIN USCorp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.RegionCode
			
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					USCorp.GACC Ga
					INNER JOIN USCorp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode
				
	INNER JOIN (
				SELECT
					Gd.*
				FROM
					USCorp.GDEP Gd
					INNER JOIN USCorp.GDepActive(@DataPriorToDate) GdA ON
						GdA.ImportKey = Gd.ImportKey
				) Gd ON
		Gd.DEPARTMENT = Gl.PropertyFundCode
										
WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Ga.IsGR,0) = ''Y'' AND
	Gl.BALFOR <> ''B'' AND
	
	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Corporate Department
		
		SELECT
			MCD.CorporateDepartmentCode
		FROM
			#ManageCorporateDepartment MCD
		WHERE
			MCD.IsDeleted = 0 AND
			MCD.SourceCode = ''UC''
	
	) AND
	Gl.RegionCode NOT IN ( -- exclude Corporate Entity
	
		SELECT
			MCE.CorporateEntityCode
		FROM
			#ManageCorporateEntity MCE
		WHERE
			MCE.IsDeleted = 0 AND
			MCE.SourceCode = ''UC''
	)
	
	-- Change Control 7: IS - end	
	--Change Control 1 : GC 2010-09-01
	--RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99''


PRINT ''US CORP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--EU PROP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	CASE WHEN ISNULL(Gl.OcurrCode, En.CurrCode) = ''PLZ'' THEN ''PLN'' ELSE ISNULL(Gl.OcurrCode, En.CurrCode) END ForeignCurrency,
	ISNULL(Gl.Amount,0) ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.Description, '''')),
	RTRIM(CONVERT(NVARCHAR(4000), ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	''N'',
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM EUProp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					EUProp.GeneralLedger Gl
				GROUP BY
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND
		t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					EUProp.ENTITY En
					INNER JOIN EUProp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.PropertyFundCode

	INNER JOIN (
				SELECT
					Ga.*
				FROM
					EUProp.GACC Ga
					INNER JOIN EUProp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode

WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Gl.CorporateDepartmentCode, ''N'') = ''N'' AND
	Gl.BALFOR <> ''B'' AND
	RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99'' AND
	( -- Change Control 6
		ISNULL(Ga.IsGR, ''N'') = ''Y''
			OR
		Ga.ACCTNUM IN ( SELECT
							PEAI.GLAccountCode
						FROM
							(
								SELECT
									PEAI.*
								FROM							
									Gdm.PropertyEntityGLAccountInclusion PEAI
									INNER JOIN Gdm.PropertyEntityGLAccountInclusionActive(@DataPriorToDate) PEAIA ON
										PEAIA.ImportKey = PEAI.ImportKey
							) PEAI
						WHERE
							PEAI.PropertyEntityCode = Gl.PropertyFundCode AND
							PEAI.IsDeleted = 0 AND
							PEAI.SourceCode = ''EU'')
	) AND

	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Property Entity

		SELECT
			MPE.PropertyEntityCode
		FROM
			#ManagePropertyEntity MPE
		WHERE
			MPE.SourceCode = ''EU'' AND
			MPE.IsDeleted = 0

	) AND
	(LTRIM(RTRIM(Gl.RegionCode)) + LTRIM(RTRIM(Gl.FunctionalDepartmentCode))) NOT IN ( -- exclude Property Department
	
		SELECT
			MPD.PropertyDepartmentCode
		FROM
			#ManagePropertyDepartment MPD
		WHERE
			MPD.SourceCode = ''EU'' AND
			MPD.IsDeleted = 0
	)

	-- Change Control 7: IS - end

PRINT ''EU PROP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--EU CORP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode, 
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription, 
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate
)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	CASE WHEN ISNULL(Gl.OcurrCode, En.CurrCode) = ''PLZ'' THEN ''PLN'' ELSE ISNULL(Gl.OcurrCode, En.CurrCode) END ForeignCurrency,
	ISNULL(Gl.Amount, 0) ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000), ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	ISNULL(Gd.NETTSCOST, ''N'') NetTSCost,
	ISNULL(Gl.LastDate, Gl.EnterDate)
	
FROM EUCorp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					EUCorp.GeneralLedger Gl
				GROUP BY
						SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND
		t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					EUCorp.ENTITY En
					INNER JOIN EUCorp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.RegionCode
				
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					EUCorp.GACC Ga
					INNER JOIN EUCorp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode

	INNER JOIN (
				SELECT
					Gd.*
				FROM
					EUCorp.GDEP Gd
					INNER JOIN EUCorp.GDepActive(@DataPriorToDate) GdA ON
						GdA.ImportKey = Gd.ImportKey
				) Gd ON
		Gd.DEPARTMENT = Gl.PropertyFundCode

WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Ga.IsGR, 0) = ''Y'' AND
	Gl.BALFOR <> ''B'' --AND
	--Change Control 1 : GC 2010-09-01
	--RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99''
	AND

	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Corporate Department
		
		SELECT
			MCD.CorporateDepartmentCode
		FROM
			#ManageCorporateDepartment MCD
		WHERE
			MCD.IsDeleted = 0 AND
			MCD.SourceCode = ''EC''
	
	) AND
	Gl.RegionCode NOT IN ( -- exclude Corporate Entity
	
		SELECT
			MCE.CorporateEntityCode
		FROM
			#ManageCorporateEntity MCE
		WHERE
			MCE.IsDeleted = 0 AND
			MCE.SourceCode = ''EC''
	)
	
	-- Change Control 7: IS - end	

PRINT ''EU CORP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--BR PROP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate
)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	Gl.OcurrCode ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.Description, '''')),
	RTRIM(CONVERT(NVARCHAR(4000), ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	''N'',
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM
	BRProp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					BRProp.GeneralLedger Gl
				GROUP BY
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND
		t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					BRProp.ENTITY En
					INNER JOIN BRProp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.PropertyFundCode
			
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					BRProp.GACC Ga
					INNER JOIN BRProp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode
					
WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Gl.CorporateDepartmentCode, ''N'') = ''N'' AND
	Gl.BALFOR <> ''B'' AND
	Gl.[Source]	= ''GR'' AND
	RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99'' AND
	( -- Change Control 6
		ISNULL(Ga.IsGR, ''N'') = ''Y''
			OR
		Ga.ACCTNUM IN ( SELECT
							PEAI.GLAccountCode
						FROM
							(
								SELECT
									PEAI.*
								FROM							
									Gdm.PropertyEntityGLAccountInclusion PEAI
									INNER JOIN Gdm.PropertyEntityGLAccountInclusionActive(@DataPriorToDate) PEAIA ON
										PEAIA.ImportKey = PEAI.ImportKey
							) PEAI
						WHERE
							PEAI.PropertyEntityCode = Gl.PropertyFundCode AND
							PEAI.IsDeleted = 0 AND
							PEAI.SourceCode = ''BR'')
	) AND
	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Property Entity

		SELECT
			MPE.PropertyEntityCode
		FROM
			#ManagePropertyEntity MPE
		WHERE
			MPE.SourceCode = ''BR'' AND
			MPE.IsDeleted = 0

	) AND
	(LTRIM(RTRIM(Gl.RegionCode)) + LTRIM(RTRIM(Gl.FunctionalDepartmentCode))) NOT IN ( -- exclude Property Department
	
		SELECT
			MPD.PropertyDepartmentCode
		FROM
			#ManagePropertyDepartment MPD
		WHERE
			MPD.SourceCode = ''BR'' AND
			MPD.IsDeleted = 0
	)

	-- Change Control 7: IS - end

PRINT ''BR PROP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--BR CORP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate
)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	''BRL'' ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(IsNull(Gl.[User], '''')),
	RTRIM(IsNull(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000),IsNull(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	ISNULL(Gd.NETTSCOST, ''N'') NetTSCost,
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM BRCorp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
						SourcePrimaryKey,
						MAX(SourceTableId) SourceTableId
				FROM
						BRCorp.GeneralLedger Gl
				GROUP BY
						SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					BRCorp.ENTITY En
					INNER JOIN BRCorp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.RegionCode
			
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					BRCorp.GACC Ga
					INNER JOIN BRCorp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode

	INNER JOIN (
				SELECT
					Gd.*
				FROM
					BRCorp.GDEP Gd
					INNER JOIN BRCorp.GDepActive(@DataPriorToDate) GdA ON
						GdA.ImportKey = Gd.ImportKey
				) Gd ON
		Gd.DEPARTMENT = Gl.PropertyFundCode
															
WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Ga.IsGR,0) = ''Y'' AND
	Gl.BALFOR <> ''B'' AND
	Gl.[Source] = ''GR'' --AND
	--Change Control 1 : GC 2010-09-01
	--RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99''
	AND

	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Corporate Department
		
		SELECT
			MCD.CorporateDepartmentCode
		FROM
			#ManageCorporateDepartment MCD
		WHERE
			MCD.IsDeleted = 0 AND
			MCD.SourceCode = ''BC''
	
	) AND
	Gl.RegionCode NOT IN ( -- exclude Corporate Entity
	
		SELECT
			MCE.CorporateEntityCode
		FROM
			#ManageCorporateEntity MCE
		WHERE
			MCE.IsDeleted = 0 AND
			MCE.SourceCode = ''BC''
	)
	
	-- Change Control 7: IS - end

PRINT ''BR CORP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--CH PROP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	ISNULL(Em.LocalEntityRef, Gl.PropertyFundCode) PropertyFundCode, --Generic convert 7char to 6char EntityID
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	Gl.OcurrCode ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(IsNull(Gl.[User], '''')),
	RTRIM(IsNull(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000),IsNull(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	''N'',
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM
	CNProp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					CNProp.GeneralLedger Gl
				GROUP BY 
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND
		t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					CNProp.ENTITY En
					INNER JOIN CNProp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.PropertyFundCode
			
	INNER JOIN (
				SELECT
					Em.*
				FROM
					GACS.EntityMapping Em
					INNER JOIN GACS.EntityMappingActive(@DataPriorToDate) EmA ON
						EmA.ImportKey = Em.ImportKey
				) Em ON
		Em.OriginalEntityRef = Gl.PropertyFundCode AND
		Em.[Source] = Gl.SourceCode -- this should filter EntityMapping by source of ''CN'', because Gl.SourceCode will always be this
			
	LEFT OUTER JOIN (
				SELECT
					Ga.*
				FROM
					CNProp.GACC Ga
					INNER JOIN CNProp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode
					
WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Gl.CorporateDepartmentCode, ''N'') = ''N'' AND
	Gl.BALFOR <> ''B'' AND
	RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99'' AND
	( -- Change Control 6
		ISNULL(Ga.IsGR, ''N'') = ''Y''
			OR
		Ga.ACCTNUM IN ( SELECT
							PEAI.GLAccountCode
						FROM
							(
								SELECT
									PEAI.*
								FROM							
									Gdm.PropertyEntityGLAccountInclusion PEAI
									INNER JOIN Gdm.PropertyEntityGLAccountInclusionActive(@DataPriorToDate) PEAIA ON
										PEAIA.ImportKey = PEAI.ImportKey
							) PEAI
						WHERE
							PEAI.PropertyEntityCode = CASE --Gl.PropertyFundCode AND
														WHEN LTRIM(RTRIM(Gl.PropertyFundCode)) = LTRIM(RTRIM(Em.OriginalEntityRef)) THEN Em.LocalEntityRef ELSE Gl.PropertyFundCode
													  END AND							
							
							PEAI.IsDeleted = 0 AND
							PEAI.SourceCode = ''CN'')
	) AND
	-- Change Control 7: IS - begin
			
	CASE --Gl.PropertyFundCode NOT IN ( -- exclude Property Entity
		WHEN LTRIM(RTRIM(Gl.PropertyFundCode)) = LTRIM(RTRIM(Em.OriginalEntityRef)) THEN Em.LocalEntityRef ELSE Gl.PropertyFundCode
	END NOT IN (

		SELECT
			MPE.PropertyEntityCode
		FROM
			#ManagePropertyEntity MPE
		WHERE
			MPE.SourceCode = ''CN'' AND
			MPE.IsDeleted = 0

	) AND
	(LTRIM(RTRIM(Gl.RegionCode)) + LTRIM(RTRIM(Gl.FunctionalDepartmentCode))) NOT IN ( -- exclude Property Department
	
		SELECT
			MPD.PropertyDepartmentCode
		FROM
			#ManagePropertyDepartment MPD
		WHERE
			MPD.SourceCode = ''CN'' AND
			MPD.IsDeleted = 0
	)

	-- Change Control 7: IS - end

PRINT ''CH PROP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--CH CORP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate
)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	Gl.OcurrCode ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000),ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	ISNULL(Gd.NETTSCOST, ''N'') NetTSCost,
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM
	CNCorp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					CNCorp.GeneralLedger Gl
				GROUP BY
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					CNCorp.ENTITY En
					INNER JOIN CNCorp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.RegionCode
			
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					CNCorp.GACC Ga
					INNER JOIN CNCorp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode

	INNER JOIN (
				SELECT
					Gd.*
				FROM
					CNCorp.GDEP Gd
					INNER JOIN CNCorp.GDepActive(@DataPriorToDate) GdA ON
						GdA.ImportKey = Gd.ImportKey
				) Gd ON
		Gd.DEPARTMENT = Gl.PropertyFundCode
															
WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Ga.IsGR,0) = ''Y'' AND
	Gl.BALFOR <> ''B'' --AND
	--Change Control 1 : GC 2010-09-01
	--RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99''
	AND

	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Corporate Department
		
		SELECT
			MCD.CorporateDepartmentCode
		FROM
			#ManageCorporateDepartment MCD
		WHERE
			MCD.IsDeleted = 0 AND
			MCD.SourceCode = ''CC''
	
	) AND
	Gl.RegionCode NOT IN ( -- exclude Corporate Entity
	
		SELECT
			MCE.CorporateEntityCode
		FROM
			#ManageCorporateEntity MCE
		WHERE
			MCE.IsDeleted = 0 AND
			MCE.SourceCode = ''CC''
	)
	
	-- Change Control 7: IS - end
	
PRINT ''CH CORP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--IN PROP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate
)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	Gl.OcurrCode ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000),ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	''N'',
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM
	INProp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					INProp.GeneralLedger Gl
				GROUP BY
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					INProp.ENTITY En
					INNER JOIN INProp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.PropertyFundCode
			
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					INProp.GACC Ga
					INNER JOIN INProp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode
					
WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Gl.CorporateDepartmentCode, ''N'') = ''N'' AND
	Gl.BALFOR <> ''B'' AND
	Gl.[Source] = ''GR'' AND
	RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99'' AND
	( -- Change Control 6
		ISNULL(Ga.IsGR, ''N'') = ''Y''
			OR
		Ga.ACCTNUM IN ( SELECT
							PEAI.GLAccountCode
						FROM
							(
								SELECT
									PEAI.*
								FROM							
									Gdm.PropertyEntityGLAccountInclusion PEAI
									INNER JOIN Gdm.PropertyEntityGLAccountInclusionActive(@DataPriorToDate) PEAIA ON
										PEAIA.ImportKey = PEAI.ImportKey
							) PEAI
						WHERE
							PEAI.PropertyEntityCode = Gl.PropertyFundCode AND
							PEAI.IsDeleted = 0 AND
							PEAI.SourceCode = ''IN'')
	) AND
	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Property Entity

		SELECT
			MPE.PropertyEntityCode
		FROM
			#ManagePropertyEntity MPE
		WHERE
			MPE.SourceCode = ''IN'' AND
			MPE.IsDeleted = 0

	) AND
	(LTRIM(RTRIM(Gl.RegionCode)) + LTRIM(RTRIM(Gl.FunctionalDepartmentCode))) NOT IN ( -- exclude Property Department
	
		SELECT
			MPD.PropertyDepartmentCode
		FROM
			#ManagePropertyDepartment MPD
		WHERE
			MPD.SourceCode = ''IN'' AND
			MPD.IsDeleted = 0
	)

	-- Change Control 7: IS - end

PRINT ''IN PROP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--IN CORP
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
INSERT INTO #ProfitabilityGeneralLedger(
	SourcePrimaryKey,
	SourceTableId,
	SourceCode,
	Period,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode,
	JobCode,
	GlAccountCode,
	LocalCurrency,
	LocalActual,
	EnterDate,
	[User],
	[Description],
	AdditionalDescription,
	Basis,
	LastDate,
	GlAccountSuffix,
	NetTSCost,
	UpdatedDate
)
SELECT 
	Gl.SourcePrimaryKey,
	Gl.SourceTableId,
	Gl.SourceCode,
	Gl.Period,
	Gl.RegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode,
	Gl.JobCode,
	Gl.GlAccountCode,
	
	Gl.OcurrCode ForeignCurrency,
	Gl.Amount ForeignActual,

	Gl.EnterDate,
	RTRIM(ISNULL(Gl.[User], '''')),
	RTRIM(ISNULL(Gl.[Description], '''')),
	RTRIM(CONVERT(NVARCHAR(4000),ISNULL(Gl.AdditionalDescription, ''''))),
	Gl.Basis,
	Gl.LastDate,
	Gl.GlAccountSuffix,
	ISNULL(Gd.NETTSCOST,''N'') NetTSCost,
	ISNULL(Gl.LastDate, Gl.EnterDate)
		
FROM
	INCorp.GeneralLedger Gl
	INNER JOIN (
				--This allows JOURNAL&GHIS to each have a record with the same PK,
				--but that is incorrect data and as such GR will pick GHIS as the 
				--more accurate data, for it is posted data, where journal data is still open data
				SELECT 
					SourcePrimaryKey,
					MAX(SourceTableId) SourceTableId
				FROM
					INCorp.GeneralLedger Gl
				GROUP BY
					SourcePrimaryKey
				) t1 ON
		t1.SourcePrimaryKey = Gl.SourcePrimaryKey AND t1.SourceTableId = Gl.SourceTableId

	INNER JOIN (
				SELECT
					En.*
				FROM
					INCorp.ENTITY En
					INNER JOIN INCorp.EntityActive(@DataPriorToDate) EnA ON
						EnA.ImportKey = En.ImportKey
				) En ON
		En.EntityId = Gl.RegionCode
			
	INNER JOIN (
				SELECT
					Ga.*
				FROM
					INCorp.GACC Ga
					INNER JOIN INCorp.GAccActive(@DataPriorToDate) GaA ON
						GaA.ImportKey = Ga.ImportKey
				) Ga ON
		Ga.ACCTNUM = Gl.GlAccountCode
				
	INNER JOIN (
				SELECT
					Gd.*
				FROM
					INCorp.GDEP Gd
					INNER JOIN INCorp.GDepActive(@DataPriorToDate) GdA ON
						GdA.ImportKey = Gd.ImportKey
				) Gd ON
		Gd.DEPARTMENT = Gl.PropertyFundCode
										
WHERE
	ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate AND
	Gl.Basis IN (''A'',''B'') AND
	-- En.Name	NOT LIKE ''%Intercompany%'' AND -- Change Control 7: IS - removed
	ISNULL(Ga.IsGR, 0) = ''Y'' AND
	Gl.BALFOR <> ''B'' AND
	Gl.[Source] = ''GR'' --AND
	--Change Control 1 : GC 2010-09-01
	--RIGHT(LTRIM(RTRIM(Gl.GlAccountCode)), 2) <> ''99''
	AND
	-- Change Control 7: IS - begin
	
	Gl.PropertyFundCode NOT IN ( -- exclude Corporate Department
		
		SELECT
			MCD.CorporateDepartmentCode
		FROM
			#ManageCorporateDepartment MCD
		WHERE
			MCD.IsDeleted = 0 AND
			MCD.SourceCode = ''IC''
	
	) AND
	Gl.RegionCode NOT IN ( -- exclude Corporate Entity
	
		SELECT
			MCE.CorporateEntityCode
		FROM
			#ManageCorporateEntity MCE
		WHERE
			MCE.IsDeleted = 0 AND
			MCE.SourceCode = ''IC''
	)
	
	-- Change Control 7: IS - end

PRINT ''IN CORP:Rows Inserted Into #ProfitabilityGeneralLedger:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)


CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #ProfitabilityGeneralLedger (UpdatedDate, FunctionalDepartmentCode, JobCode, GlAccountCode, SourceCode, Period, OriginatingRegionCode, PropertyFundCode, SourcePrimaryKey)

PRINT ''Completed building clustered index on #ProfitabilityGeneralLedger''
PRINT CONVERT(VARCHAR(27), getdate(), 121)

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Take the different sources and combine them INTo the "REAL" fact table
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
--Prepare the # tables used for performance optimization
-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
CREATE TABLE #FunctionalDepartment(
	ImportKey INT NOT NULL,
	FunctionalDepartmentId INT NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	Code VARCHAR(31) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	GlobalCode CHAR(3) NULL
)

CREATE TABLE #Department(
	ImportKey INT NOT NULL,
	Department CHAR(8) NOT NULL,
	[Description] VARCHAR(50) NULL,
	LastDate DATETIME NULL,
	MRIUserID CHAR(20) NULL,
	[Source] CHAR(2) NOT NULL,
	IsActive BIT NOT NULL,
	FunctionalDepartmentId INT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #JobCode(
	ImportKey INT NOT NULL,
	JobCode VARCHAR(15) NOT NULL,
	[Source] CHAR(2) NOT NULL,
	JobType VARCHAR(15) NOT NULL,
	BuildingRef VARCHAR(6) NULL,
	LastDate DATETIME NOT NULL,
	IsActive BIT NOT NULL,
	Reference VARCHAR(50) NOT NULL,
	MRIUserID CHAR(20) NOT NULL,
	[Description] VARCHAR(50) NULL,
	StartDate DATETIME NULL,
	EndDate DATETIME NULL,
	AccountingComment VARCHAR(5000) NULL,
	PMComment VARCHAR(5000) NULL,
	LeaseRef VARCHAR(20) NULL,
	Area INT NULL,
	AreaType VARCHAR(20) NULL,
	RMPropertyRef VARCHAR(6) NULL,
	IsAssumption BIT NOT NULL,
	FunctionalDepartmentId INT NULL
) 

CREATE TABLE #ActivityType(
	ImportKey INT NOT NULL,
	ActivityTypeId INT NOT NULL,
	ActivityTypeCode VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	GLAccountSuffix char(2) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL
)

CREATE TABLE #GLGlobalAccount(
	ImportKey INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	ActivityTypeId INT NULL,
	GLStatutoryTypeId INT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(150) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsGR BIT NOT NULL,
	IsGbs BIT NOT NULL,
	IsRegionalOverheadCost BIT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLGlobalAccountGLAccount( -- used to be #GlAccountMapping in GDM 1.2
	ImportKey INT NOT NULL,
	GLGlobalAccountGLAccountId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	Code VARCHAR(12) NOT NULL,
	[Name] NVARCHAR(50) NOT NULL,
	[Description] NVARCHAR(255) NOT NULL,
	PreGlobalAccountCode VARCHAR(50) NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #OriginatingRegionCorporateEntity( -- GDM 2.0 addition
	ImportKey INT NOT NULL,
	OriginatingRegionCorporateEntityId INT NOT NULL,
	GlobalRegionId INT NOT NULL,
	CorporateEntityCode VARCHAR(10) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL	
)

CREATE TABLE #OriginatingRegionPropertyDepartment( -- GDM 2.0 addition
	ImportKey INT NOT NULL,
	OriginatingRegionPropertyDepartmentId INT NOT NULL,
	GlobalRegionId INT NOT NULL,
	PropertyDepartmentCode VARCHAR(10) NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL	
)

CREATE TABLE #PropertyFundMapping(
	ImportKey INT NOT NULL,
	PropertyFundMappingId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode char(2) NOT NULL,
	PropertyFundCode VARCHAR(8) NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	IsDeleted BIT NOT NULL,
	ActivityTypeId INT NULL
)

CREATE TABLE #PropertyFund( -- GDM 2.0 change
	ImportKey INT NOT NULL,
	PropertyFundId INT NOT NULL,
	RelatedFundId INT NULL,
	EntityTypeId INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	BudgetOwnerStaffId INT NOT NULL,
	RegionalOwnerStaffId INT NOT NULL,
	DefaultGLTranslationSubTypeId INT NULL,
	[Name] VARCHAR(100) NOT NULL,
	IsReportingEntity BIT NOT NULL,
	IsPropertyFund BIT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #ReportingEntityCorporateDepartment( -- GDM 2.0 addition
	ImportKey INT NOT NULL,
	ReportingEntityCorporateDepartmentId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	CorporateDepartmentCode CHAR(6) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsDeleted BIT NOT NULL,
)

CREATE TABLE #ReportingEntityPropertyEntity( -- GDM 2.0 addition
	ImportKey INT NOT NULL,
	ReportingEntityPropertyEntityId INT NOT NULL,
	PropertyFundId INT NOT NULL,
	SourceCode CHAR(2) NOT NULL,
	PropertyEntityCode CHAR(6) NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsDeleted BIT NOT NULL
)


CREATE TABLE #AllocationSubRegion(
	ImportKey INT NOT NULL,
	AllocationSubRegionGlobalRegionId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	ProjectCodePortion VARCHAR(2) NOT NULL,
	AllocationRegionGlobalRegionId INT NULL,
	DefaultCurrencyCode CHAR(3) NOT NULL,
	CountryId INT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #JobCodeFunctionalDepartment(
	FunctionalDepartmentKey INT NOT NULL,
	ReferenceCode VARCHAR(20) NOT NULL,
	FunctionalDepartmentCode VARCHAR(20) NOT NULL,
	FunctionalDepartmentName VARCHAR(50) NOT NULL,
	SubFunctionalDepartmentCode VARCHAR(20) NOT NULL,
	SubFunctionalDepartmentName VARCHAR(100) NOT NULL,
	StartDate DATETIME NOT NULL,
	EndDate DATETIME NOT NULL
)

CREATE TABLE #ParentFunctionalDepartment(
	FunctionalDepartmentKey INT NOT NULL,
	ReferenceCode VARCHAR(20) NOT NULL,
	FunctionalDepartmentCode VARCHAR(20) NOT NULL,
	FunctionalDepartmentName VARCHAR(50) NOT NULL,
	SubFunctionalDepartmentCode VARCHAR(20) NOT NULL,
	SubFunctionalDepartmentName VARCHAR(100) NOT NULL,
	StartDate DATETIME NOT NULL,
	EndDate DATETIME NOT NULL
)

-- #FunctionalDepartment

INSERT INTO #FunctionalDepartment(
	ImportKey,
	FunctionalDepartmentId,
	[Name],
	Code,
	IsActive,
	InsertedDate,
	UpdatedDate,
	GlobalCode
)
SELECT
	Fd.ImportKey,
	Fd.FunctionalDepartmentId,
	Fd.Name,
	Fd.Code,
	Fd.IsActive,
	Fd.InsertedDate,
	Fd.UpdatedDate,
	Fd.GlobalCode
FROM
	HR.FunctionalDepartment Fd
	INNER JOIN HR.FunctionalDepartmentActive(@DataPriorToDate) FdA ON
		FdA.ImportKey = Fd.ImportKey

-- #Department

INSERT INTO #Department(
	ImportKey,
	Department,
	[Description],
	LastDate,
	MRIUserID,
	[Source],
	IsActive,
	FunctionalDepartmentId,
	UpdatedDate
)
SELECT
	Dpt.ImportKey,
	Dpt.Department,
	Dpt.[Description],
	Dpt.LastDate,
	Dpt.MRIUserID,
	Dpt.[Source],
	Dpt.IsActive,
	Dpt.FunctionalDepartmentId,
	Dpt.UpdatedDate
FROM GACS.Department Dpt
	INNER JOIN GACS.DepartmentActive(@DataPriorToDate) DptA ON
		DptA.ImportKey = Dpt.ImportKey
WHERE
	Dpt.FunctionalDepartmentId IS NOT NULL

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #Department (Department, [Source])

-- #JobCode

INSERT INTO #JobCode(
	ImportKey,
	JobCode,
	[Source],
	JobType,
	BuildingRef,
	LastDate,
	IsActive,
	Reference,
	MRIUserID,
	[Description],
	StartDate,
	EndDate,
	AccountingComment,
	PMComment,
	LeaseRef,
	Area,
	AreaType,
	RMPropertyRef,
	IsAssumption,
	FunctionalDepartmentId
)
SELECT
	Jc.ImportKey,
	Jc.JobCode,
	Jc.[Source],
	Jc.JobType,
	Jc.BuildingRef,
	Jc.LastDate,
	Jc.IsActive,
	Jc.Reference,
	Jc.MRIUserID,
	Jc.[Description],
	Jc.StartDate,
	Jc.EndDate,
	Jc.AccountingComment,
	Jc.PMComment,
	Jc.LeaseRef,
	Jc.Area,
	Jc.AreaType,
	Jc.RMPropertyRef,
	Jc.IsAssumption,
	Jc.FunctionalDepartmentId
FROM
	GACS.JobCode Jc
	INNER JOIN GACS.JobCodeActive(@DataPriorToDate) JcA ON
		JcA.ImportKey = Jc.ImportKey
WHERE
	Jc.FunctionalDepartmentId IS NOT NULL

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #JobCode (JobCode, [Source])

-- #ActivityType

INSERT INTO #ActivityType(
	ImportKey,
	ActivityTypeId,
	ActivityTypeCode,
	[Name],
	GLAccountSuffix,
	InsertedDate,
	UpdatedDate
)
SELECT
	At.ImportKey,
	At.ActivityTypeId,
	At.Code,
	At.Name,
	At.GLAccountSuffix,
	At.InsertedDate,
	At.UpdatedDate
FROM
	Gdm.ActivityType At
	INNER JOIN Gdm.ActivityTypeActive(@DataPriorToDate) Ata ON
		Ata.ImportKey = At.ImportKey

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #ActivityType (ActivityTypeId)

-- #GLGlobalAccount

INSERT INTO #GLGlobalAccount(
	ImportKey,
	GLGlobalAccountId,
	ActivityTypeId,
	GLStatutoryTypeId,
	Code,
	[Name],
	[Description],
	IsGR,
	IsGbs,
	IsRegionalOverheadCost,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	GLA.ImportKey,
	GLA.GLGlobalAccountId,
	GLA.ActivityTypeId,
	GLA.GLStatutoryTypeId,
	GLA.Code,
	GLA.[Name], 
	GLA.[Description],
	GLA.IsGR,
	GLA.IsGbs,
	GLA.IsRegionalOverheadCost,
	GLA.IsActive,
	GLA.InsertedDate,
	GLA.UpdatedDate,
	GLA.UpdatedByStaffId
FROM
	Gdm.GLGlobalAccount GLA
	INNER JOIN Gdm.GLGlobalAccountActive(@DataPriorToDate) GLAA ON
		GLAA.ImportKey = GLA.ImportKey
	
CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #GLGlobalAccount (GLGlobalAccountId, ActivityTypeId)

-- #GLGlobalAccountGLAccount

INSERT INTO #GLGlobalAccountGLAccount(
	ImportKey,
	GLGlobalAccountGLAccountId,
	GLGlobalAccountId,
	SourceCode,
	Code,
	[Name],
	[Description],
	PreGlobalAccountCode,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	GAGLA.ImportKey,
	GAGLA.GLGlobalAccountGLAccountId,
	GAGLA.GLGlobalAccountId,
	GAGLA.SourceCode,
	GAGLA.Code,
	GAGLA.[Name],
	GAGLA.[Description],
	GAGLA.PreGlobalAccountCode,
	GAGLA.IsActive,
	GAGLA.InsertedDate,
	GAGLA.UpdatedDate,
	GAGLA.UpdatedByStaffId
FROM
	Gdm.GLGlobalAccountGLAccount GAGLA
	INNER JOIN Gdm.GLGlobalAccountGLAccountActive(@DataPriorToDate) GlA ON
		GlA.ImportKey = GAGLA.ImportKey

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #GLGlobalAccountGLAccount (Code, SourceCode, GLGlobalAccountGLAccountId)

-- #PropertyFundMapping

INSERT INTO #PropertyFundMapping(
	ImportKey,
	PropertyFundMappingId,
	PropertyFundId,
	SourceCode,
	PropertyFundCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted,
	ActivityTypeId)
SELECT
	Pfm.ImportKey,
	Pfm.PropertyFundMappingId,
	Pfm.PropertyFundId,
	Pfm.SourceCode,
	Pfm.PropertyFundCode,
	Pfm.InsertedDate,
	Pfm.UpdatedDate,
	Pfm.IsDeleted,
	Pfm.ActivityTypeId
FROM
	Gdm.PropertyFundMapping Pfm 
	INNER JOIN Gdm.PropertyFundMappingActive(@DataPriorToDate) PfmA ON
		PfmA.ImportKey = Pfm.ImportKey

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #PropertyFundMapping (PropertyFundCode, SourceCode, IsDeleted, PropertyFundId, PropertyFundMappingId, ActivityTypeId)

-- #OriginatingRegionCorporateEntity

INSERT INTO #OriginatingRegionCorporateEntity(
	ImportKey,
	OriginatingRegionCorporateEntityId,
	GlobalRegionId,
	CorporateEntityCode,
	SourceCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted
)
SELECT
	ORCE.ImportKey,
	ORCE.OriginatingRegionCorporateEntityId,
	ORCE.GlobalRegionId,
	ORCE.CorporateEntityCode,
	ORCE.SourceCode,
	ORCE.InsertedDate,
	ORCE.UpdatedDate,
	ORCE.IsDeleted	
FROM
	Gdm.OriginatingRegionCorporateEntity ORCE
	INNER JOIN Gdm.OriginatingRegionCorporateEntityActive (@DataPriorToDate) ORCEA ON
		ORCEA.ImportKey = ORCE.ImportKey

-- #OriginatingRegionPropertyDepartment

INSERT INTO #OriginatingRegionPropertyDepartment(
	ImportKey,
	OriginatingRegionPropertyDepartmentId,
	GlobalRegionId,
	PropertyDepartmentCode,
	SourceCode,
	InsertedDate,
	UpdatedDate,
	IsDeleted
)
SELECT
	ORPD.ImportKey,
	ORPD.OriginatingRegionPropertyDepartmentId,
	ORPD.GlobalRegionId,
	ORPD.PropertyDepartmentCode,
	ORPD.SourceCode,
	ORPD.InsertedDate,
	ORPD.UpdatedDate,
	ORPD.IsDeleted
FROM
	Gdm.OriginatingRegionPropertyDepartment ORPD
	INNER JOIN Gdm.OriginatingRegionPropertyDepartmentActive(@DataPriorToDate) ORPDA ON
		ORPDA.ImportKey = ORPD.ImportKey

-- #PropertyFund

INSERT INTO #PropertyFund(
	ImportKey,
	PropertyFundId,
	RelatedFundId,
	EntityTypeId,
	AllocationSubRegionGlobalRegionId,
	BudgetOwnerStaffId,
	RegionalOwnerStaffId,
	DefaultGLTranslationSubTypeId,
	[Name],
	IsReportingEntity,
	IsPropertyFund,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	PF.ImportKey,
	PF.PropertyFundId,
	PF.RelatedFundId,
	PF.EntityTypeId,
	PF.AllocationSubRegionGlobalRegionId,
	PF.BudgetOwnerStaffId,
	PF.RegionalOwnerStaffId,
	PF.DefaultGLTranslationSubTypeId,
	PF.[Name],
	PF.IsReportingEntity,
	PF.IsPropertyFund,
	PF.IsActive,
	PF.InsertedDate,
	PF.UpdatedDate,
	PF.UpdatedByStaffId
FROM
	Gdm.PropertyFund PF 
	INNER JOIN Gdm.PropertyFundActive(@DataPriorToDate) PFA ON
		PFA.ImportKey = PF.ImportKey

CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #PropertyFund (PropertyFundId)

-- #ReportingEntityCorporateDepartment

INSERT INTO	#ReportingEntityCorporateDepartment(
	ImportKey,
	ReportingEntityCorporateDepartmentId,
	PropertyFundId,
	SourceCode,
	CorporateDepartmentCode,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsDeleted
)
SELECT
	RECD.ImportKey,
	RECD.ReportingEntityCorporateDepartmentId,
	RECD.PropertyFundId,
	RECD.SourceCode,
	RECD.CorporateDepartmentCode,
	RECD.InsertedDate,
	RECD.UpdatedDate,
	RECD.UpdatedByStaffId,
	RECD.IsDeleted
FROM
	Gdm.ReportingEntityCorporateDepartment RECD
	INNER JOIN Gdm.ReportingEntityCorporateDepartmentActive(@DataPriorToDate) RECDA ON
		RECDA.ImportKey = RECD.ImportKey

-- #ReportingEntityPropertyEntity

INSERT INTO #ReportingEntityPropertyEntity(
	ImportKey,
	ReportingEntityPropertyEntityId,
	PropertyFundId,
	SourceCode,
	PropertyEntityCode,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsDeleted
)
SELECT
	REPE.ImportKey,
	REPE.ReportingEntityPropertyEntityId,
	REPE.PropertyFundId,
	REPE.SourceCode,
	REPE.PropertyEntityCode,
	REPE.InsertedDate,
	REPE.UpdatedDate,
	REPE.UpdatedByStaffId,
	REPE.IsDeleted
FROM
	Gdm.ReportingEntityPropertyEntity REPE
	INNER JOIN Gdm.ReportingEntityPropertyEntityActive(@DataPriorToDate) REPEA ON
		REPEA.ImportKey = REPE.ImportKey

-- #AllocationSubRegion

INSERT INTO #AllocationSubRegion(
	ImportKey,
	AllocationSubRegionGlobalRegionId,
	Code,
	[Name],
	ProjectCodePortion,
	AllocationRegionGlobalRegionId,
	DefaultCurrencyCode,
	CountryId,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	ASR.ImportKey,
	ASR.AllocationSubRegionGlobalRegionId,
	ASR.Code,
	ASR.[Name],
	ASR.ProjectCodePortion,
	ASR.AllocationRegionGlobalRegionId,
	ASR.DefaultCurrencyCode,
	ASR.CountryId,
	ASR.IsActive,
	ASR.InsertedDate,
	ASR.UpdatedDate,
	ASR.UpdatedByStaffId
FROM
	Gdm.AllocationSubRegion ASR
	INNER JOIN	Gdm.AllocationSubRegionActive(@DataPriorToDate) ASRA ON ASRA.ImportKey = ASR.ImportKey

-- #JobCodeFunctionalDepartment
INSERT INTO #JobCodeFunctionalDepartment(
	FunctionalDepartmentKey,
	ReferenceCode,
	FunctionalDepartmentCode,
	FunctionalDepartmentName,
	SubFunctionalDepartmentCode,
	SubFunctionalDepartmentName,
	StartDate,
	EndDate
)
SELECT
	FunctionalDepartmentKey,
	ReferenceCode,
	FunctionalDepartmentCode,
	FunctionalDepartmentName,
	SubFunctionalDepartmentCode,
	SubFunctionalDepartmentName,
	StartDate,
	EndDate
FROM
	GrReporting.dbo.FunctionalDepartment
WHERE
	FunctionalDepartmentCode <> SubFunctionalDepartmentCode

-- Parent Level
INSERT INTO #ParentFunctionalDepartment(
	FunctionalDepartmentKey,
	ReferenceCode,
	FunctionalDepartmentCode,
	FunctionalDepartmentName,
	SubFunctionalDepartmentCode,
	SubFunctionalDepartmentName,
	StartDate,
	EndDate
)
SELECT
	FunctionalDepartmentKey,
	ReferenceCode,
	FunctionalDepartmentCode,
	FunctionalDepartmentName,
	SubFunctionalDepartmentCode,
	SubFunctionalDepartmentName,
	StartDate,
	EndDate
FROM
	GrReporting.dbo.FunctionalDepartment
WHERE (
		FunctionalDepartmentCode = SubFunctionalDepartmentCode
		OR 
		ReferenceCode = FunctionalDepartmentCode+'':UNKNOWN''
	  )

-----------------------------------------------------------------------------------------------------------

CREATE TABLE #GLTranslationType(
	ImportKey INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	[Description] VARCHAR(255) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLTranslationSubType(
	ImportKey INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	Code VARCHAR(10) NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL,
	IsGRDefault BIT NOT NULL
)

CREATE TABLE #GLGlobalAccountTranslationType(
	ImportKey INT NOT NULL,
	GLGlobalAccountTranslationTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationTypeId INT NOT NULL,
	GLAccountTypeId INT NOT NULL,
	GLAccountSubTypeId INT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLGlobalAccountTranslationSubType(
	ImportKey INT NOT NULL,
	GLGlobalAccountTranslationSubTypeId INT NOT NULL,
	GLGlobalAccountId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLMajorCategory(
	ImportKey INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	GLTranslationSubTypeId INT NOT NULL,
	[Name] VARCHAR(50) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

CREATE TABLE #GLMinorCategory(
	ImportKey INT NOT NULL,
	GLMinorCategoryId INT NOT NULL,
	GLMajorCategoryId INT NOT NULL,
	[Name] VARCHAR(100) NOT NULL,
	IsActive BIT NOT NULL,
	InsertedDate DATETIME NOT NULL,
	UpdatedDate DATETIME NOT NULL,
	UpdatedByStaffId INT NOT NULL
)

-- #GLGlobalAccountTranslationType

INSERT INTO #GLGlobalAccountTranslationType(
	ImportKey,
	GLGlobalAccountTranslationTypeId,
	GLGlobalAccountId,
	GLTranslationTypeId,
	GLAccountTypeId,
	GLAccountSubTypeId,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	GATT.ImportKey,
	GATT.GLGlobalAccountTranslationTypeId,
	GATT.GLGlobalAccountId,
	GATT.GLTranslationTypeId,
	GATT.GLAccountTypeId,
	CASE WHEN GA.ACtivityTypeId = 99 THEN 
											--GC :: CC1 >>
											--Unallocated overhead expenses will be grouped under the “Overhead” expense 
											--type and not “Non-Payroll”. This will be based on the activity of the 
											--transaction; all transactions that have a corporate overhead activity 
											--will have an expense type of “Overhead”.
											
											(
											Select GST.GLAccountSubTypeId 
											From Gdm.GLAccountSubType GST 
												INNER JOIN Gdm.GLTranslationType GTT ON GTT.GLTranslationTypeId = GST.GLTranslationTypeId
											Where GTT.Code = ''GL''
											AND GST.Code = ''GRPOHD''	
											) 
										ELSE GATT.GLAccountSubTypeId END,
	GATT.IsActive,
	GATT.InsertedDate,
	GATT.UpdatedDate,
	GATT.UpdatedByStaffId
FROM
	Gdm.GLGlobalAccountTranslationType GATT
	INNER JOIN Gdm.GLGlobalAccountTranslationTypeActive(@DataPriorToDate) GATTA ON
		GATTA.ImportKey = GATT.ImportKey
		
	LEFT OUTER JOIN 
					(Select GA.*
					From	Gdm.GLGlobalAccount GA
							INNER JOIN Gdm.GLGlobalAccountActive(@DataPriorToDate) GAA ON
								GAA.ImportKey = GA.ImportKey
					) GA ON GA.GLGlobalAccountId = GATT.GLGlobalAccountId

-- #GLGlobalAccountTranslationSubType

INSERT INTO #GLGlobalAccountTranslationSubType(
	ImportKey,
	GLGlobalAccountTranslationSubTypeId,
	GLGlobalAccountId,
	GLTranslationSubTypeId,
	GLMinorCategoryId,
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	GATST.ImportKey,
	GATST.GLGlobalAccountTranslationSubTypeId,
	GATST.GLGlobalAccountId,
	GATST.GLTranslationSubTypeId,
	GATST.GLMinorCategoryId,
	GATST.IsActive,
	GATST.InsertedDate,
	GATST.UpdatedDate,
	GATST.UpdatedByStaffId
FROM
	Gdm.GLGlobalAccountTranslationSubType GATST
	INNER JOIN Gdm.GLGlobalAccountTranslationSubTypeActive(@DataPriorToDate) GATSTA ON
		GATSTA.ImportKey = GATST.ImportKey

-- #GLTranslationType

INSERT INTO #GLTranslationType(
	ImportKey,
	GLTranslationTypeId,
	Code,
	[Name],
	[Description],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	TT.ImportKey,
	TT.GLTranslationTypeId,
	TT.Code,
	TT.[Name],
	TT.[Description],
	TT.IsActive,
	TT.InsertedDate,
	TT.UpdatedDate,
	TT.UpdatedByStaffId
FROM
	Gdm.GLTranslationType TT
	INNER JOIN Gdm.GLTranslationTypeActive(@DataPriorToDate) TTA ON
		TTA.ImportKey = TT.ImportKey

-- #GLTranslationSubType

INSERT INTO #GLTranslationSubType(
	ImportKey,
	GLTranslationSubTypeId,
	GLTranslationTypeId,
	Code,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId,
	IsGRDefault
)
SELECT
	TST.ImportKey,
	TST.GLTranslationSubTypeId,
	TST.GLTranslationTypeId,
	TST.Code,
	TST.[Name],
	TST.IsActive,
	TST.InsertedDate,
	TST.UpdatedDate,
	TST.UpdatedByStaffId,
	TST.IsGRDefault
FROM
	Gdm.GLTranslationSubType TST
	INNER JOIN Gdm.GLTranslationSubTypeActive(@DataPriorToDate) TSTA ON
		TSTA.ImportKey = TST.ImportKey

-- #GLMajorCategory

INSERT INTO #GLMajorCategory(
	ImportKey,
	GLMajorCategoryId,
	GLTranslationSubTypeId,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	MajC.ImportKey,
	MajC.GLMajorCategoryId,
	MajC.GLTranslationSubTypeId,
	MajC.[Name],
	MajC.IsActive,
	MajC.InsertedDate,
	MajC.UpdatedDate,
	MajC.UpdatedByStaffId
FROM
	Gdm.GLMajorCategory MajC
	INNER JOIN Gdm.GLMajorCategoryActive(@DataPriorToDate) MajCA ON
		MajC.ImportKey = MajCA.ImportKey

-- #GLMinorCategory

INSERT INTO #GLMinorCategory(
	ImportKey,
	GLMinorCategoryId,
	GLMajorCategoryId,
	[Name],
	IsActive,
	InsertedDate,
	UpdatedDate,
	UpdatedByStaffId
)
SELECT
	Minc.ImportKey,
	Minc.GLMinorCategoryId,
	Minc.GLMajorCategoryId,
	Minc.[Name],
	Minc.IsActive,
	Minc.InsertedDate,
	Minc.UpdatedDate,
	Minc.UpdatedByStaffId
FROM
	Gdm.GLMinorCategory MinC
	INNER JOIN Gdm.GLMinorCategoryActive(@DataPriorToDate) MinCA ON
		MinCA.ImportKey = MinC.ImportKey

-- drop table #ProfitabilityActual

PRINT ''Completed inserting Active records INTo temp table''
PRINT CONVERT(VARCHAR(27), getdate(), 121)
-- drop table #ProfitabilityActual

CREATE TABLE #ProfitabilityActual(
	CalendarKey INT NOT NULL,
	GlAccountKey INT NOT NULL,
	SourceKey INT NOT NULL,
	FunctionalDepartmentKey INT NOT NULL,
	ReimbursableKey INT NOT NULL,
	ActivityTypeKey INT NOT NULL,
	OriginatingRegionKey INT NOT NULL,
	AllocationRegionKey INT NOT NULL,
	PropertyFundKey INT NOT NULL,
	OverheadKey INT NOT NULL,
	ReferenceCode VARCHAR(100) NOT NULL,
	LocalCurrencyKey INT NOT NULL,
	LocalActual MONEY NOT NULL,
	ProfitabilityActualSourceTableId INT NOT NULL,
	
	EUCorporateGlAccountCategoryKey INT NULL,
	EUPropertyGlAccountCategoryKey INT NULL,
	EUFundGlAccountCategoryKey INT NULL,

	USPropertyGlAccountCategoryKey INT NULL,
	USCorporateGlAccountCategoryKey INT NULL,
	USFundGlAccountCategoryKey INT NULL,

	GlobalGlAccountCategoryKey INT NULL,
	DevelopmentGlAccountCategoryKey INT NULL,
	
	EntryDate DATETIME NULL,
	[User] NVARCHAR(20) NULL,
	[Description] NCHAR(60) NULL,
	AdditionalDescription NVARCHAR(4000) NULL,
	OriginatingRegionCode char(6) NULL,
	PropertyFundCode char(12) NULL,
	FunctionalDepartmentCode char(15) NULL 
) 



INSERT INTO #ProfitabilityActual(
	CalendarKey,
	GlAccountKey,
	SourceKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	OriginatingRegionKey,
	AllocationRegionKey,
	PropertyFundKey,
	OverheadKey,
	ReferenceCode,
	LocalCurrencyKey,
	LocalActual,
	ProfitabilityActualSourceTableId,
	EntryDate,
	[User],
	[Description],
	AdditionalDescription,
	
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode 
)

SELECT 

	DATEDIFF(dd, ''1900-01-01'', LEFT(Gl.PERIOD, 4)+''-''+RIGHT(Gl.PERIOD, 2)+''-01'') CalendarKey,
	CASE WHEN GrGa.GlAccountKey IS NULL THEN @GlAccountKeyUnknown ELSE GrGa.GlAccountKey END GlAccountKey,
	CASE WHEN GrSc.SourceKey IS NULL THEN @SourceKeyUnknown ELSE GrSc.SourceKey END SourceKey,
	CASE WHEN ISNULL(GrFdm1.FunctionalDepartmentKey, GrFdm2.FunctionalDepartmentKey) IS NULL THEN @FunctionalDepartmentKeyUnknown ELSE ISNULL(GrFdm1.FunctionalDepartmentKey, GrFdm2.FunctionalDepartmentKey) END FunctionalDepartmentKey,
	CASE WHEN GrRi.ReimbursableCode IS NULL THEN @ReimbursableKeyUnknown ELSE GrRi.ReimbursableKey END ReimbursableKey,
	CASE WHEN GrAt.ActivityTypeKey IS NULL THEN @ActivityTypeKeyUnknown ELSE GrAt.ActivityTypeKey END ActivityTypeKey,
	CASE WHEN OrR.OriginatingRegionKey IS NULL THEN @OriginatingRegionKeyUnknown ELSE OrR.OriginatingRegionKey END OriginatingRegionKey,
	CASE WHEN GrAr.AllocationRegionKey IS NULL THEN @AllocationRegionKeyUnknown ELSE GrAr.AllocationRegionKey END AllocationRegionKey,
	CASE WHEN GrPf.PropertyFundKey IS NULL THEN @PropertyFundKeyUnknown ELSE GrPf.PropertyFundKey END PropertyFundKey,
	CASE WHEN GrOh.OverheadKey IS NULL THEN @OverheadKeyUnknown ELSE GrOh.OverheadKey END OverheadKey,
	Gl.SourcePrimaryKey,
	Cu.CurrencyKey,
	Gl.LocalActual,
	Gl.SourceTableId,
	Gl.EnterDate,
	Gl.[User],
	Gl.[Description],
	Gl.AdditionalDescription,
	
	Gl.OriginatingRegionCode,
	Gl.PropertyFundCode,
	Gl.FunctionalDepartmentCode

FROM
	#ProfitabilityGeneralLedger Gl
		
	LEFT OUTER JOIN GrReporting.dbo.[Source] GrSc ON
		GrSc.SourceCode = Gl.SourceCode

	LEFT OUTER JOIN GrReporting.dbo.Currency Cu ON
		Cu.CurrencyCode = Gl.LocalCurrency

	LEFT OUTER JOIN #JobCode Jc ON --The JobCodes is FunctionalDepartment in Corp
		Jc.JobCode = Gl.JobCode AND
		Jc.Source = Gl.SourceCode AND
		GrSc.IsCorporate = ''YES''
	
	LEFT OUTER JOIN #Department Dp ON --The Department (Region+FunctionalDept) is FunctionalDepartment in Prop
		Dp.Department = LTRIM(RTRIM(Gl.OriginatingRegionCode)) + LTRIM(RTRIM(Gl.FunctionalDepartmentCode)) AND
		Dp.Source = Gl.SourceCode AND
		GrSc.IsProperty = ''YES''

	LEFT OUTER JOIN #FunctionalDepartment Fd ON
		/*
	      Functional Department Investigation, When running Import and clearing wherehouse data for period 201012
	      some of the history is lost and functional departments cannot be linked again and does not exist in gacs anymore
	      so for period 201012 we want to report on the historic functional department we add a little hack
	      
	      Legal Risk and Records Hack:
          you will find the functional department id hack below, when they split legal risk and records into 3 departments
          the reused the code LGL, so for 2010 data we have to hack it.
          
          Revised:
          Add the property to it too, property is joined in GL FunctionalDepartmentCode rather than the GL JobCode.
	    */		
        Fd.FunctionalDepartmentId = 
			CASE 
				WHEN (GL.Period <= 201012) THEN
					CASE GrSc.IsCorporate	
						WHEN ''YES'' THEN
							  CASE 
									WHEN (GL.JobCode IN (''LGL'',''RSK'', ''RIM'')) THEN
										  14
									ELSE 
										  ISNULL(Jc.FunctionalDepartmentId, Dp.FunctionalDepartmentId)
							  END
						ELSE
							CASE
								  WHEN (GL.FunctionalDepartmentCode IN (''LGL'',''RSK'',''RIM'')) THEN
										14
								  ELSE	
									ISNULL(Jc.FunctionalDepartmentId, Dp.FunctionalDepartmentId)
							END
					END								 
				ELSE
					  ISNULL(Jc.FunctionalDepartmentId, Dp.FunctionalDepartmentId)
			END
													

	LEFT OUTER JOIN #JobCodeFunctionalDepartment GrFdm1 ON --Detail/Sub Level : JobCode
		ISNULL(Gl.LastDate, EnterDate)  BETWEEN GrFdm1.StartDate AND GrFdm1.EndDate AND
		GrFdm1.ReferenceCode = CASE WHEN Gl.JobCode IS NOT NULL THEN Fd.GlobalCode + '':''+ LTRIM(RTRIM(Gl.JobCode))
									ELSE Fd.GlobalCode + '':UNKNOWN'' END

	--Parent Level: Determine the default FunctionalDepartment (FunctionalDepartment:XX, JobCode:UNKNOWN)
	--that will be used, should the JobCode not match, but the FunctionalDepartment does match
	LEFT OUTER JOIN #ParentFunctionalDepartment GrFdm2 ON
		ISNULL(Gl.LastDate, EnterDate)  BETWEEN GrFdm2.StartDate AND GrFdm2.EndDate AND
		GrFdm2.ReferenceCode = Fd.GlobalCode +'':'' 
		
	LEFT OUTER JOIN #GLGlobalAccountGLAccount GAGLA ON --#GlAccountMapping Gam
		GAGLA.Code = Gl.GlAccountCode AND
		GAGLA.SourceCode = Gl.SourceCode AND
		GAGLA.IsActive = 1
		
	LEFT OUTER JOIN GrReporting.dbo.GlAccount GrGa ON
		GrGa.GLGlobalAccountId = GAGLA.GLGlobalAccountId AND --Gam.GlobalGlAccountId AND
		ISNULL(Gl.LastDate, EnterDate) BETWEEN GrGa.StartDate AND GrGa.EndDate AND
		GrGa.SnapshotId = 0

	LEFT OUTER JOIN #GLGlobalAccount GA ON --#GlobalGlAccount Glo
		GA.GLGlobalAccountId = GAGLA.GLGlobalAccountId
		--ON Glo.GlobalGlAccountId = Gam.GlobalGlAccountId

	LEFT OUTER JOIN #ActivityType At ON
		At.ActivityTypeId = GA.ActivityTypeId

	LEFT OUTER JOIN GrReporting.dbo.ActivityType GrAt ON
		GrAt.ActivityTypeId = At.ActivityTypeId AND
		ISNULL(Gl.LastDate, EnterDate) BETWEEN GrAt.StartDate AND GrAt.EndDate AND
		GrAt.SnapshotId = 0

	--GC Change Control 1
	LEFT OUTER JOIN GrReporting.dbo.Overhead GrOh ON
		GrOh.OverheadCode = CASE WHEN GrAt.ActivityTypeCode = ''CORPOH'' THEN ''UNALLOC'' ELSE ''UNKNOWN'' END
		
	LEFT OUTER JOIN #PropertyFundMapping Pfm ON
		Pfm.PropertyFundCode = LTRIM(RTRIM(Gl.PropertyFundCode)) AND
		Pfm.SourceCode = Gl.SourceCode AND
		Pfm.IsDeleted = 0 AND
		(
			(GrSc.IsProperty = ''YES'' AND Pfm.ActivityTypeId IS NULL) 
			OR
			(
				(GrSc.IsCorporate = ''YES'' AND Pfm.ActivityTypeId = GA.ActivityTypeId)
				OR
				(GrSc.IsCorporate = ''YES'' AND Pfm.ActivityTypeId IS NULL AND GA.ActivityTypeId IS NULL)
			)
		) AND
		(Gl.Period < ''201007'')

	LEFT OUTER JOIN	#ReportingEntityCorporateDepartment RECD ON
		GrSc.IsCorporate = ''YES'' AND -- only corporate MRIs resolved through this
		RECD.CorporateDepartmentCode = LTRIM(RTRIM(Gl.PropertyFundCode)) AND
		RECD.SourceCode = Gl.SourceCode AND
		Gl.Period >= ''201007'' AND			   
		RECD.IsDeleted = 0
		   
	LEFT OUTER JOIN #ReportingEntityPropertyEntity REPE ON
		GrSc.IsProperty = ''YES'' AND -- only property MRIs resolved through this
		REPE.PropertyEntityCode = LTRIM(RTRIM(Gl.PropertyFundCode)) AND
		REPE.SourceCode = Gl.SourceCode AND
		Gl.Period >= ''201007'' AND
		REPE.IsDeleted = 0			   
	
	LEFT OUTER JOIN #OriginatingRegionCorporateEntity ORCE ON
		ORCE.CorporateEntityCode = Gl.OriginatingRegionCode AND
		ORCE.SourceCode = Gl.SourceCode AND
		ORCE.IsDeleted = 0
		   
	LEFT OUTER JOIN #OriginatingRegionPropertyDepartment ORPD ON
		ORPD.PropertyDepartmentCode = LTRIM(RTRIM(Gl.OriginatingRegionCode)) + LTRIM(RTRIM(Gl.FunctionalDepartmentCode)) AND
		ORPD.SourceCode = Gl.SourceCode AND
		ORPD.IsDeleted = 0

	LEFT OUTER JOIN GrReporting.dbo.OriginatingRegion OrR ON
		OrR.GlobalRegionId = ISNULL(ORCE.GlobalRegionId, ORPD.GlobalRegionId) AND
		--OrR.GlobalRegionId = ORPD.GlobalRegionId AND
		ISNULL(Gl.LastDate, EnterDate) BETWEEN OrR.StartDate AND OrR.EndDate AND
		OrR.SnapshotId = 0
	
	LEFT OUTER JOIN #PropertyFund PF ON
		PF.PropertyFundId =
			CASE
				WHEN Gl.Period < ''201007'' THEN Pfm.PropertyFundId
				ELSE
					CASE
						WHEN GrSc.IsCorporate = ''YES'' THEN RECD.PropertyFundId
						ELSE REPE.PropertyFundId
					END
			END
			
	LEFT OUTER JOIN GrReporting.dbo.PropertyFund GrPf ON
		GrPf.PropertyFundId = PF.PropertyFundId AND 
		ISNULL(Gl.LastDate, EnterDate) BETWEEN GrPf.StartDate AND GrPf.EndDate AND
		GrPf.SnapshotId = 0

	LEFT OUTER JOIN #AllocationSubRegion ASR ON
		PF.AllocationSubRegionGlobalRegionId = ASR.AllocationSubRegionGlobalRegionId
		
	LEFT OUTER JOIN GrReporting.dbo.AllocationRegion GrAr ON
		GrAr.GlobalRegionId = ASR.AllocationSubRegionGlobalRegionId AND
		--ON GrAr.GlobalRegionId = Arm.GlobalRegionId AND
		ISNULL(Gl.LastDate, EnterDate) BETWEEN GrAr.StartDate AND GrAr.EndDate AND 
		GrAr.SnapshotId = 0

	LEFT OUTER JOIN GrReporting.dbo.Reimbursable GrRi ON
		GrRi.ReimbursableCode = CASE WHEN Gl.NetTSCost = ''Y'' THEN ''NO'' ELSE ''YES'' END

			
--This is NOT needed for the temp table selects at the top already filter the inserts!
--/*Where ISNULL(Gl.LastDate, GL.EnterDate) BETWEEN @ImportStartDate AND @ImportEndDate*/

PRINT ''Completed converting all transactional data to star schema keys''
PRINT CONVERT(VARCHAR(27), getdate(), 121)

-----------------------------------------------------------------------------------------------------------
--GlobalGlAccountCategoryKey
UPDATE
	#ProfitabilityActual
SET
	GlobalGlAccountCategoryKey = CASE WHEN GLAC.GlAccountCategoryKey IS NULL THEN @GlobalGlAccountCategoryKeyUnknown ELSE GLAC.GlAccountCategoryKey END
FROM #ProfitabilityActual Gl

	INNER JOIN GrReporting.dbo.GlAccount Gla ON
		Gla.GlAccountKey = Gl.GlAccountKey AND
		Gla.SnapshotId = 0

	LEFT OUTER JOIN #GLGlobalAccountTranslationType GATT ON
		GATT.GLGlobalAccountId = Gla.GLGlobalAccountId AND
		GATT.IsActive = 1
	
	LEFT OUTER JOIN #GLGlobalAccountTranslationSubType GATST ON
		GATST.GLGlobalAccountId = Gla.GLGlobalAccountId AND
		GATST.IsActive = 1
		
	LEFT OUTER JOIN #GLTranslationSubType TST ON
		TST.GLTranslationTypeId = GATT.GLTranslationTypeId AND
		TST.GLTranslationSubTypeId = GATST.GLTranslationSubTypeId AND
		TST.Code = ''GL'' AND -- filter on Code because it is indexed and guaranteed to be unique
		TST.IsActive = 1

	LEFT OUTER JOIN #GLMinorCategory MinC ON
		MinC.GLMinorCategoryId = GATST.GLMinorCategoryId AND
		MinC.IsActive = 1
		
	LEFT OUTER JOIN #GLMajorCategory MajC ON
		MajC.GLMajorCategoryId = MinC.GLMajorCategoryId AND
		MajC.GLTranslationSubTypeId = TST.GLTranslationSubTypeId AND -- this join isn''t necessary but including it for completeness
		MajC.IsActive = 1
	
	LEFT OUTER JOIN GrReporting.dbo.GlAccountCategory GLAC ON
		Gl.CalendarKey BETWEEN GLAC.StartDate AND GLAC.EndDate AND
		GLAC.GlobalGlAccountCategoryCode = CONVERT(VARCHAR(32),
											CONVERT(VARCHAR(8), TST.GLTranslationTypeId) + '':'' + 
											CONVERT(VARCHAR(8), TST.GLTranslationSubTypeId) + '':'' +
											CONVERT(VARCHAR(8), MinC.GLMajorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GATST.GLMinorCategoryId) + '':'' +
											CONVERT(VARCHAR(8), GATT.GLAccountTypeId) + '':'' +
											CONVERT(VARCHAR(8), GATT.GLAccountSubTypeId)) AND
		GLAC.SnapshotId = 0
	

PRINT ''Completed converting all GlobalGlAccountCategoryKey keys:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)


CREATE UNIQUE CLUSTERED INDEX IX_Clustered ON #ProfitabilityActual (SourceKey, ReferenceCode)
PRINT ''Completed building clustered index on #ProfitabilityActual''
PRINT CONVERT(VARCHAR(27), getdate(), 121)

--Transfer the updated rows
UPDATE
	GrReporting.dbo.ProfitabilityActual
SET	
	CalendarKey						 = Pro.CalendarKey,
	GlAccountKey					 = Pro.GlAccountKey,
	FunctionalDepartmentKey			 = Pro.FunctionalDepartmentKey,
	ReimbursableKey					 = Pro.ReimbursableKey,
	ActivityTypeKey					 = Pro.ActivityTypeKey,
	OriginatingRegionKey			 = Pro.OriginatingRegionKey,
	AllocationRegionKey				 = Pro.AllocationRegionKey,
	PropertyFundKey					 = Pro.PropertyFundKey,
	OverheadKey						 = Pro.OverheadKey,
	LocalCurrencyKey				 = Pro.LocalCurrencyKey,
	LocalActual						 = Pro.LocalActual,
	ProfitabilityActualSourceTableId = Pro.ProfitabilityActualSourceTableId,
	
	EUCorporateGlAccountCategoryKey	 = @EUCorporateGlAccountCategoryKeyUnknown, --Pro.EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey	 = @EUPropertyGlAccountCategoryKeyUnknown, --Pro.EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey		 = @EUFundGlAccountCategoryKeyUnknown, --Pro.EUFundGlAccountCategoryKey,

	USPropertyGlAccountCategoryKey	 = @USPropertyGlAccountCategoryKeyUnknown, --Pro.USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey	 = @USCorporateGlAccountCategoryKeyUnknown, --Pro.USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey		 = @USFundGlAccountCategoryKeyUnknown, --Pro.USFundGlAccountCategoryKey,

	GlobalGlAccountCategoryKey		 = Pro.GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey	 = @DevelopmentGlAccountCategoryKeyUnknown, --Pro.DevelopmentGlAccountCategoryKey

	
	EntryDate						 = Pro.EntryDate,
	[User]							 = Pro.[User],
	[Description]					 = Pro.[Description],
	AdditionalDescription			 = Pro.AdditionalDescription,
	
	OriginatingRegionCode			 = Pro.OriginatingRegionCode,
	PropertyFundCode				 = Pro.PropertyFundCode,
	FunctionalDepartmentCode		 = Pro.FunctionalDepartmentCode
	
FROM
	#ProfitabilityActual Pro
WHERE
	ProfitabilityActual.SourceKey = Pro.SourceKey AND
	ProfitabilityActual.ReferenceCode = Pro.ReferenceCode

PRINT ''Rows Updated in Profitability:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)
	
--Transfer the new rows
INSERT INTO GrReporting.dbo.ProfitabilityActual (
	CalendarKey,
	GlAccountKey,
	FunctionalDepartmentKey,
	ReimbursableKey,
	ActivityTypeKey,
	SourceKey,
	OriginatingRegionKey,
	AllocationRegionKey,
	PropertyFundKey,
	OverHeadKey,
	ReferenceCode,
	LocalCurrencyKey,
	LocalActual,
	ProfitabilityActualSourceTableId,
	EUCorporateGlAccountCategoryKey,
	EUPropertyGlAccountCategoryKey,
	EUFundGlAccountCategoryKey,
	USPropertyGlAccountCategoryKey,
	USCorporateGlAccountCategoryKey,
	USFundGlAccountCategoryKey,
	GlobalGlAccountCategoryKey,
	DevelopmentGlAccountCategoryKey,
	EntryDate,
	[User],
	[Description],
	AdditionalDescription,
	OriginatingRegionCode,
	PropertyFundCode,
	FunctionalDepartmentCode
)
	
SELECT
	Pro.CalendarKey,
	Pro.GlAccountKey,
	Pro.FunctionalDepartmentKey,
	Pro.ReimbursableKey,
	Pro.ActivityTypeKey,
	Pro.SourceKey,
	Pro.OriginatingRegionKey,
	Pro.AllocationRegionKey,
	Pro.PropertyFundKey,
	Pro.OverHeadKey,
	Pro.ReferenceCode,
	Pro.LocalCurrencyKey,
	Pro.LocalActual,
	Pro.ProfitabilityActualSourceTableId,
	
	@EUCorporateGlAccountCategoryKeyUnknown, --Pro.EUCorporateGlAccountCategoryKey,
	@EUPropertyGlAccountCategoryKeyUnknown, --Pro.EUPropertyGlAccountCategoryKey,
	@EUFundGlAccountCategoryKeyUnknown, --Pro.EUFundGlAccountCategoryKey,

	@USPropertyGlAccountCategoryKeyUnknown, --Pro.USPropertyGlAccountCategoryKey,
	@USCorporateGlAccountCategoryKeyUnknown, ----Pro.USCorporateGlAccountCategoryKey,
	@USFundGlAccountCategoryKeyUnknown, --Pro.USFundGlAccountCategoryKey,

	Pro.GlobalGlAccountCategoryKey,
	@DevelopmentGlAccountCategoryKeyUnknown, --Pro.DevelopmentGlAccountCategoryKey
	
	Pro.EntryDate,
	Pro.[User],
	Pro.[Description],
	Pro.AdditionalDescription,
	Pro.OriginatingRegionCode, 
	Pro.PropertyFundCode, 
	Pro.FunctionalDepartmentCode

FROM
	#ProfitabilityActual Pro
	
	LEFT OUTER JOIN GrReporting.dbo.ProfitabilityActual ProExists
		ON ProExists.SourceKey = Pro.SourceKey AND
		   ProExists.ReferenceCode = Pro.ReferenceCode
		   
WHERE
	ProExists.SourceKey IS NULL

PRINT ''Rows Inserted in Profitability:''+CONVERT(char(10),@@rowcount)
PRINT CONVERT(VARCHAR(27), getdate(), 121)

--MRI should never delete rows from the GeneralLedger....
--hence we should never have to delete records
--PRINT ''Orphan Rows Delete in Profitability:''+CONVERT(char(10),@@rowcount)
--PRINT CONVERT(VARCHAR(27), getdate(), 121)

-- remove orphan rows from the warehouse that have been removed in the source data systems
EXEC stp_IU_ArchiveProfitabilityMRIActual @ImportStartDate=@ImportStartDate, @ImportEndDate=@ImportEndDate, @DataPriorToDate=@DataPriorToDate

DROP TABLE #ManageType
DROP TABLE #ManageCorporateDepartment
DROP TABLE #ManageCorporateEntity
DROP TABLE #ManagePropertyDepartment
DROP TABLE #ManagePropertyEntity

DROP TABLE #ProfitabilityGeneralLedger
DROP TABLE #FunctionalDepartment
DROP TABLE #Department
DROP TABLE #JobCode
DROP TABLE #ActivityType
DROP TABLE #GLGlobalAccount
DROP TABLE #GLGlobalAccountGLAccount
DROP TABLE #OriginatingRegionCorporateEntity
DROP TABLE #OriginatingRegionPropertyDepartment
DROP TABLE #PropertyFundMapping
DROP TABLE #PropertyFund
DROP TABLE #ReportingEntityCorporateDepartment
DROP TABLE #ReportingEntityPropertyEntity
DROP TABLE #AllocationSubRegion
DROP TABLE #JobCodeFunctionalDepartment
DROP TABLE #ParentFunctionalDepartment
DROP TABLE #GLTranslationType
DROP TABLE #GLTranslationSubType
DROP TABLE #GLGlobalAccountTranslationType
DROP TABLE #GLGlobalAccountTranslationSubType
DROP TABLE #GLMajorCategory
DROP TABLE #GLMinorCategory
DROP TABLE #ProfitabilityActual






' 
END
GO
